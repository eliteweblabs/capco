"use strict";exports.id=7145,exports.ids=[7145],exports.modules={47145:(a,b,c)=>{c.d(b,{Gf:()=>t,U1:()=>s,ZT:()=>w,cf:()=>u,gA:()=>r,xx:()=>v});var d=c(35552),e=c(15995),f=c(20942),g=c(68570),h=c(70673),i=c(79512),j=c(55511),k=c.n(j),l=c(70401),m=c(49079),n=c(33873),o=c.n(n),p=c(79748),q=c.n(p);async function r(a,b,c,g){if(!(0,h.pz)(a))throw Error("Invalid project ID. Must start with a letter or number, and contain only lowercase letters, numbers, hyphens, and underscores.");let j=(0,d.getSettings)();if((0,d.getProject)(a))throw Error(`Project '${a}' already exists`);let k=(0,d.getNextPortRange)(),n={api:k+l.VM.api,apiHttps:k+l.VM.apiHttps,db:k+l.VM.db,studio:k+l.VM.studio,inbucket:k+l.VM.inbucket,smtp:k+l.VM.smtp,pop3:k+l.VM.pop3,pooler:k+l.VM.pooler,analytics:k+l.VM.analytics},p=await (0,i.RV)(n),r=k;if(!p.available){let a=await (0,i.TS)(k,l.VM,20,j.general.portIncrement);if(!a)throw Error(`Cannot create project - no available port range found.

`+(0,i.Jt)(p.portsInUse));n={api:(r=a.basePort)+l.VM.api,apiHttps:r+l.VM.apiHttps,db:r+l.VM.db,studio:r+l.VM.studio,inbucket:r+l.VM.inbucket,smtp:r+l.VM.smtp,pop3:r+l.VM.pop3,pooler:r+l.VM.pooler,analytics:r+l.VM.analytics},console.log(`Port range ${k} was in use, using ${r} instead`)}let s=o().join(j.general.projectsBaseDir,a);try{await q().mkdir(s,{recursive:!0})}catch(a){throw Error(`Failed to create project directory: ${a.message}`)}let t=await (0,f.NK)(`git clone --depth 1 https://github.com/supabase/supabase "${s}/supabase"`,{timeout:3e5});if(0!==t.exitCode)throw await q().rm(s,{recursive:!0,force:!0}),Error(`Failed to clone Supabase repository: ${t.stderr}`);try{await (0,m.zK)(s,a)}catch(a){throw await q().rm(s,{recursive:!0,force:!0}),Error(`Failed to configure project name: ${a.message}`)}try{await (0,m.fp)(s,n)}catch(a){throw await q().rm(s,{recursive:!0,force:!0}),Error(`Failed to configure ports: ${a.message}`)}let u=(0,e.bk)(40),v=(0,e.bk)(40),w=(0,e.bk)(40),z=(0,e.cq)(),A=y(v,"anon"),B=y(v,"service_role"),C={postgresPassword:(0,e.w)(u),jwtSecret:(0,e.w)(v),anonKey:(0,e.w)(A),serviceRoleKey:(0,e.w)(B),dashboardUsername:"supabase",dashboardPassword:(0,e.w)(w),vaultEncKey:(0,e.w)(z)},D=o().join(s,"supabase","docker"),E=o().join(D,".env.example"),F=o().join(D,".env");try{let a=await q().readFile(E,"utf-8");a=x(a,"POSTGRES_PASSWORD",u),a=x(a,"JWT_SECRET",v),a=x(a,"ANON_KEY",A),a=x(a,"SERVICE_ROLE_KEY",B),a=x(a,"DASHBOARD_USERNAME","supabase"),a=x(a,"DASHBOARD_PASSWORD",w),a=x(a,"VAULT_ENC_KEY",z),a=x(a,"KONG_HTTP_PORT",n.api.toString()),a=x(a,"KONG_HTTPS_PORT",n.apiHttps.toString()),a=x(a,"POSTGRES_PORT",n.db.toString()),a=x(a,"POOLER_PROXY_PORT_TRANSACTION",n.pooler.toString()),await q().writeFile(F,a)}catch(a){throw await q().rm(s,{recursive:!0,force:!0}),Error(`Failed to configure .env file: ${a.message}`)}let G=new Date().toISOString(),H={id:a,name:b,description:c,directory:s,ports:n,credentials:C,authProviders:[],backupSettings:{defaultDestination:"local",encryptBackups:!0},enabledServices:{vector:!0,db:!0,analytics:!0,kong:!0,auth:!0,rest:!0,meta:!0,studio:!0,realtime:!0,storage:!0,imgproxy:!0,functions:!0,supavisor:!0},autoStart:!0,status:"stopped",lastStatusCheck:G,createdAt:G,updatedAt:G};return(0,d.createProjectInDb)(H),(0,d.updateLastPort)(r),g&&(0,d.logActivity)("project","project.created",g,{projectId:a,name:b},a),H}function s(a){return(0,d.getProject)(a)}function t(a){let b=(0,d.getProject)(a);if(!b)return null;let c={postgresPassword:(0,e.Yc)(b.credentials.postgresPassword),jwtSecret:(0,e.Yc)(b.credentials.jwtSecret),anonKey:(0,e.Yc)(b.credentials.anonKey),serviceRoleKey:(0,e.Yc)(b.credentials.serviceRoleKey),dashboardUsername:b.credentials.dashboardUsername,dashboardPassword:(0,e.Yc)(b.credentials.dashboardPassword),vaultEncKey:(0,e.Yc)(b.credentials.vaultEncKey)};return{...b,decryptedCredentials:c}}function u(){return(0,d.getAllProjects)()}async function v(a,b=!1,c){let e=(0,d.getProject)(a);if(!e)throw Error(`Project '${a}' not found`);if(await (0,g.oE)(e.directory,a,b),b)try{await q().rm(e.directory,{recursive:!0,force:!0})}catch(a){if("EACCES"===a.code){console.log("Using sudo to remove Docker-owned files...");try{await (0,f.NK)(`sudo rm -rf "${e.directory}"`,{timeout:6e4})}catch(a){console.error(`Failed to remove project files with sudo: ${a.message}`)}}else console.error(`Failed to remove project files: ${a.message}`)}(0,d.deleteProjectFromDb)(a),c&&(0,d.logActivity)("project","project.deleted",c,{removeFiles:b},a)}async function w(a){let b=(0,d.getProject)(a);if(!b)return null;let c=await (0,g.Sf)(b.directory,a);return(0,d.updateProject)(a,{status:c,lastStatusCheck:new Date().toISOString()}),(0,d.getProject)(a)}function x(a,b,c){let d=RegExp(`^${b}=.*$`,"m");return d.test(a)?a.replace(d,`${b}=${c}`):a+`
${b}=${c}`}function y(a,b){let c=Buffer.from(JSON.stringify({alg:"HS256",typ:"JWT"})).toString("base64url"),d=Math.floor(Date.now()/1e3),e=Buffer.from(JSON.stringify({aud:"authenticated",exp:d+31536e4,iat:d,iss:"supabase",ref:"localhost",role:b,sub:"1234567890"})).toString("base64url"),f=k().createHmac("sha256",a).update(`${c}.${e}`).digest("base64url");return`${c}.${e}.${f}`}},49079:(a,b,c)=>{c.d(b,{CD:()=>l,fp:()=>m,hL:()=>k,zK:()=>j});var d=c(79748),e=c.n(d),f=c(33873),g=c.n(f),h=c(20942);async function i(){try{let a=await (0,h.NK)("cat /proc/sys/net/ipv6/conf/all/disable_ipv6 2>/dev/null");if(0===a.exitCode&&"1"===a.stdout.trim())return!1;let b=await (0,h.NK)("python3 -c \"import socket; s=socket.socket(socket.AF_INET6, socket.SOCK_STREAM); s.bind(('::1', 0)); s.close(); print('ok')\" 2>/dev/null || python -c \"import socket; s=socket.socket(socket.AF_INET6, socket.SOCK_STREAM); s.bind(('::1', 0)); s.close(); print('ok')\" 2>/dev/null || node -e \"require('net').createServer().listen(0, '::1', function() { console.log('ok'); this.close(); })\" 2>/dev/null");if(0===b.exitCode&&b.stdout.includes("ok"))return!0;let c=await (0,h.NK)("cat /proc/net/if_inet6 2>/dev/null | head -1");if(0===c.exitCode&&c.stdout.trim())return!0;return!1}catch{return!1}}async function j(a,b){let c=g().join(a,"supabase","docker"),d=g().join(c,"docker-compose.yml");try{let a=await e().readFile(d,"utf-8");a=(a=(a=a.replace(/^name:\s*supabase\s*$/m,`name: ${b}`)).replace(/^\s*container_name:\s*.+$/gm,"")).replace(/\n\n\n+/g,"\n\n"),await e().writeFile(d,a,"utf-8")}catch(a){throw Error(`Failed to configure project name: ${a.message}`)}}async function k(a,b){let c=g().join(a,"supabase","docker"),d=g().join(c,"docker-compose.override.yml"),f=["kong","auth","rest","meta","studio","realtime","storage","imgproxy","functions","supavisor"].filter(a=>!b.includes(a));if(0===f.length){try{await e().unlink(d)}catch{}return}let h=`# Supascale Web - Service Configuration Override
# This file is auto-generated. Do not edit manually.
# Disabled services: ${f.join(", ")}

services:
`;for(let a of f)h+=`  ${a}:
    profiles:
      - disabled
`;await e().writeFile(d,h,"utf-8")}async function l(a){let b=await i(),c=g().join(a,"supabase","docker"),d=g().join(c,"docker-compose.yml");try{let a=await e().readFile(d,"utf-8");if(/^\s+HOSTNAME[:=]/m.test(a))return b||(a=a.replace(/^(\s+)HOSTNAME[:=]\s*.+$/m,"$1HOSTNAME: 0.0.0.0"),await e().writeFile(d,a,"utf-8")),{ipv6Available:b};if(b)return{ipv6Available:!0};let c=a.match(/^(\s+)(STUDIO_DEFAULT_ORGANIZATION:.*)$/m);if(c){let b=c[1],f=c[0];return a=a.replace(f,`${b}HOSTNAME: 0.0.0.0
${f}`),await e().writeFile(d,a,"utf-8"),{ipv6Available:!1}}let f=a.match(/^(\s+)(SUPABASE_URL:.*)$/m);if(f){let b=f[1],c=f[0];return a=a.replace(c,`${b}HOSTNAME: 0.0.0.0
${c}`),await e().writeFile(d,a,"utf-8"),{ipv6Available:!1}}let g=a.split("\n"),h=!1,i=!1,j=0,k=0,l=-1;for(let a=0;a<g.length;a++){let b=g[a],c=b.trimStart(),d=b.length-c.length;if(c.startsWith("studio:")){h=!0,j=d;continue}if(h){if(c&&d<=j&&!c.startsWith("#")){h=!1,i=!1;continue}if(c.startsWith("environment:")){i=!0,k=d;continue}if(i&&c&&!c.startsWith("#")){if(d<=k){i=!1;continue}l=a;break}}}if(l>-1){let b=g[l],c=b.match(/^(\s*)/)?.[1]||"      ";g.splice(l,0,`${c}HOSTNAME: 0.0.0.0`),a=g.join("\n"),await e().writeFile(d,a,"utf-8")}return{ipv6Available:!1}}catch(a){return console.error(`Warning: Failed to configure IPv6 compatibility: ${a.message}`),{ipv6Available:!1}}}async function m(a,b){let c=g().join(a,"supabase","docker"),d=g().join(c,"docker-compose.yml");try{let a=await e().readFile(d,"utf-8");a=(a=a.replace(/- 4000:4000/g,`- ${b.analytics}:4000`)).replace(/- 3000:3000/g,`- ${b.studio}:3000`),await e().writeFile(d,a,"utf-8")}catch(a){throw Error(`Failed to configure ports: ${a.message}`)}}},79512:(a,b,c)=>{c.d(b,{Jt:()=>j,RV:()=>h,TS:()=>i});var d=c(91645),e=c.n(d);function f(a){return new Promise(b=>{let c=e().createServer();c.once("error",a=>{a.code,b(!1)}),c.once("listening",()=>{c.close(),b(!0)}),c.listen(a,"0.0.0.0")})}async function g(a){let b=(await Promise.all(a.map(async a=>({port:a,available:await f(a)})))).filter(a=>!a.available).map(a=>a.port);return{available:0===b.length,portsInUse:b}}async function h(a){let b=[{name:"API (Kong HTTP)",port:a.api},{name:"API (Kong HTTPS)",port:a.apiHttps},{name:"Database (Postgres)",port:a.db},{name:"Studio",port:a.studio},{name:"Inbucket Web",port:a.inbucket},{name:"SMTP",port:a.smtp},{name:"POP3",port:a.pop3},{name:"Pooler (Supavisor)",port:a.pooler},{name:"Analytics",port:a.analytics}],c=(await Promise.all(b.map(async a=>({...a,available:await f(a.port)})))).filter(a=>!a.available);return{available:0===c.length,portsInUse:c.map(a=>({name:a.name,port:a.port}))}}async function i(a,b,c=10,d=100){for(let e=0;e<c;e++){let c=a+e*d,f={};for(let[a,d]of Object.entries(b))f[a]=c+d;let h=Object.values(f),{available:i}=await g(h);if(i)return{basePort:c,ports:f}}return null}function j(a){if(0===a.length)return"No port conflicts detected.";let b=a.map(a=>`  - ${a.name}: port ${a.port}`).join("\n");return`The following ports are already in use:
${b}

Please stop any services using these ports or choose a different port range.`}}};