"use strict";exports.id=8786,exports.ids=[8786],exports.modules={36405:(a,b,c)=>{c.d(b,{Zd:()=>h,do:()=>m,RG:()=>g});var d=c(35552),e=c(20942),f=c(28770);function g(a){try{return f.CronExpressionParser.parse(a),{valid:!0}}catch(a){return{valid:!1,error:a instanceof Error?a.message:"Invalid cron expression"}}}function h(a,b="UTC"){try{return f.CronExpressionParser.parse(a,{currentDate:new Date,tz:b}).next().toDate()}catch(a){return console.error("Failed to parse cron expression:",a),null}}var i=c(63002),j=c(68570),k=c(60112),l=c(10576);async function m(a){let b,c=(0,d.getTask)(a);if(!c)return{success:!1,duration:0,error:"Task not found"};if(!(0,d.getProject)(c.projectId))return{success:!1,duration:0,error:"Project not found"};(0,d.updateTaskRun)(a,"running");let e=Date.now();try{switch(c.type){case"health-check":b=await n(c.projectId,c.healthCheckConfig);break;case"container-update":b=await o(c.projectId,c.containerUpdateConfig);break;case"custom":b=await p(c.projectId,c.customConfig);break;case"backup":b=await q(c.projectId,c.backupConfig,a);break;case"security-scan":b=await r(c.projectId,c.securityScanConfig,a);break;default:b={success:!1,duration:0,error:`Unknown task type: ${c.type}`}}}catch(a){b={success:!1,duration:Date.now()-e,error:a instanceof Error?a.message:"Task execution failed"}}let f=h(c.cronExpression,c.timezone);return(0,d.updateTaskRun)(a,b.success?"success":"failure",b.duration,b.error,f?.toISOString()),b}async function n(a,b){let c=Date.now(),f=(0,d.getProject)(a);if(!f)return{success:!1,duration:0,error:"Project not found"};try{let d=await (0,j.eo)(),g=d?"podman-compose":"docker compose",h=[];if(d){let{stdout:c,exitCode:d}=await (0,e.NK)(`podman ps --filter "label=io.podman.compose.project=${a}" --format "{{.Names}}|{{.State}}"`,{timeout:b.timeoutSeconds?1e3*b.timeoutSeconds:3e4});if(0!==d){let{stdout:b,exitCode:c}=await (0,e.NK)('podman ps -a --format "{{.Names}}|{{.State}}"',{timeout:3e4});if(0!==c)throw Error("Failed to check container status");let d=a.toLowerCase();h=b.trim().split("\n").filter(Boolean).filter(a=>a.toLowerCase().includes(d)).map(a=>{let[b,c]=a.split("|");return{Name:b,State:c?.toLowerCase()}})}else h=c.trim().split("\n").filter(Boolean).map(a=>{let[b,c]=a.split("|");return{Name:b,State:c?.toLowerCase()}})}else{let{stdout:a,exitCode:c}=await (0,e.NK)(`docker compose -f "${f.directory}/docker-compose.yml" ps --format json`,{timeout:b.timeoutSeconds?1e3*b.timeoutSeconds:3e4});if(0!==c)throw Error("Failed to check container status");h=a.trim().split("\n").filter(Boolean).map(a=>{try{return JSON.parse(a)}catch{return null}}).filter(Boolean)}let i=h.filter(a=>"running"!==a.State||a.Health&&"healthy"!==a.Health);if(i.length>0){let a=i.map(a=>a.Name||a.Service).join(", ");if(b.autoRestart)return await (0,e.NK)(`${g} -f "${f.directory}/docker-compose.yml" restart`,{timeout:12e4}),{success:!0,duration:Date.now()-c,output:`Restarted unhealthy containers: ${a}`};return{success:!1,duration:Date.now()-c,error:`Unhealthy containers: ${a}`}}if(b.checkEndpoint){let a=`http://localhost:${f.ports.api}${b.checkEndpoint}`,{exitCode:d}=await (0,e.NK)(`curl -sf -o /dev/null -w "%{http_code}" "${a}"`,{timeout:1e4});if(0!==d){if(b.autoRestart)return await (0,e.NK)(`${g} -f "${f.directory}/docker-compose.yml" restart`,{timeout:12e4}),{success:!0,duration:Date.now()-c,output:"Restarted project after failed health endpoint check"};return{success:!1,duration:Date.now()-c,error:`Health endpoint ${b.checkEndpoint} not responding`}}}return{success:!0,duration:Date.now()-c,output:"All containers healthy"}}catch(a){return{success:!1,duration:Date.now()-c,error:a instanceof Error?a.message:"Health check failed"}}}async function o(a,b){let c=Date.now(),f=(0,d.getProject)(a);if(!f)return{success:!1,duration:0,error:"Project not found"};try{let a=await (0,j.eo)()?"podman-compose":"docker compose",d=`${f.directory}/docker-compose.yml`,g=`${a} -f "${d}" pull`;b.services&&b.services.length>0&&(g+=` ${b.services.join(" ")}`);let{exitCode:h,stderr:i}=await (0,e.NK)(g,{timeout:3e5});if(0!==h)throw Error(`Failed to pull images: ${i}`);if(b.pullOnly)return{success:!0,duration:Date.now()-c,output:"Images pulled successfully (not restarted)"};let k=`${a} -f "${d}" up -d`;b.services&&b.services.length>0&&(k+=` ${b.services.join(" ")}`);let{exitCode:l,stderr:m}=await (0,e.NK)(k,{timeout:12e4});if(0!==l)throw Error(`Failed to recreate containers: ${m}`);return{success:!0,duration:Date.now()-c,output:"Containers updated successfully"}}catch(a){return{success:!1,duration:Date.now()-c,error:a instanceof Error?a.message:"Container update failed"}}}async function p(a,b){let c=Date.now(),f=(0,d.getProject)(a);if(!f)return{success:!1,duration:0,error:"Project not found"};try{let a=await (0,j.eo)(),d=`${a?"podman-compose":"docker compose"} -f "${f.directory}/docker-compose.yml" exec -T`;b.workDir&&(d+=` -w "${b.workDir}"`),d+=` ${b.container} ${b.command}`;let g=b.timeoutSeconds?1e3*b.timeoutSeconds:6e4,{stdout:h,stderr:i,exitCode:k}=await (0,e.NK)(d,{timeout:g});if(0!==k)return{success:!1,duration:Date.now()-c,error:i||`Command exited with code ${k}`,output:b.captureOutput?h:void 0};return{success:!0,duration:Date.now()-c,output:b.captureOutput?h:"Command completed successfully"}}catch(a){return{success:!1,duration:Date.now()-c,error:a instanceof Error?a.message:"Command execution failed"}}}async function q(a,b,c){let e=Date.now();if(!(0,d.getProject)(a))return{success:!1,duration:0,error:"Project not found"};try{let d=await (0,i.GB)(a,b.backupType,b.destination,{encrypt:b.encrypt,taskId:c});if(d.success&&b.retentionCount)try{let c=await (0,i.L6)(a,b.retentionCount);if(c>0)return{success:!0,duration:d.duration,output:`Backup created: ${d.path} (${s(d.size||0)}). Cleaned up ${c} old backup(s).`}}catch(a){console.error("Failed to clean up old backups:",a)}if(d.success)return{success:!0,duration:d.duration,output:`Backup created: ${d.path} (${s(d.size||0)})`};return{success:!1,duration:d.duration,error:d.error||"Backup failed"}}catch(a){return{success:!1,duration:Date.now()-e,error:a instanceof Error?a.message:"Backup task failed"}}}async function r(a,b,c){let e=Date.now(),f=(0,d.getProject)(a);if(!f)return{success:!1,duration:0,error:"Project not found"};if("running"!==f.status)return{success:!1,duration:0,error:"Project must be running to perform security scans"};let g=b.scanTypes||["audit"],h=[],i=[],j=null;for(let b of g){let e=(0,d.createSecurityScan)({projectId:a,type:b,status:"running",taskId:c,startedAt:new Date().toISOString()}),g=Date.now();try{let c;switch(b){case"audit":j=c=await (0,k.qC)(a),h.push(`Audit: ${c.summary.total} issues found`),(0,d.updateSecurityScan)(e.id,{status:"completed",results:{audit:c},duration:Date.now()-g,completedAt:new Date().toISOString()});break;case"coverage":c=await (0,k.Be)(a),h.push(`Coverage: ${c.summary.coveragePercent}% (${c.summary.tablesWithRLS}/${c.summary.totalTables} tables)`),(0,d.updateSecurityScan)(e.id,{status:"completed",results:{coverage:c},duration:Date.now()-g,completedAt:new Date().toISOString()});break;case"storage":f.enabledServices?.storage?(c=await (0,k.k8)(a),h.push(`Storage: ${c.summary.totalBuckets} buckets, ${c.summary.publicBuckets} public`),(0,d.updateSecurityScan)(e.id,{status:"completed",results:{storage:c},duration:Date.now()-g,completedAt:new Date().toISOString()})):(h.push("Storage: Skipped (service not enabled)"),(0,d.updateSecurityScan)(e.id,{status:"completed",duration:Date.now()-g,completedAt:new Date().toISOString()}));break;default:h.push(`${b}: Skipped (unknown type)`)}}catch(c){let a=c instanceof Error?c.message:"Unknown error";i.push(`${b}: ${a}`),(0,d.updateSecurityScan)(e.id,{status:"failed",errorMessage:a,duration:Date.now()-g,completedAt:new Date().toISOString()})}}let m=Date.now()-e,n=i.length>0,o=[...h,...i.map(a=>`ERROR: ${a}`)].join("; ");if(b.notifyOnIssues&&j&&j.summary.total>0&&(!b.minSeverityToNotify||"low"===b.minSeverityToNotify&&j.summary.total>0||"medium"===b.minSeverityToNotify&&j.summary.medium+j.summary.high+j.summary.critical>0||"high"===b.minSeverityToNotify&&j.summary.high+j.summary.critical>0||"critical"===b.minSeverityToNotify&&j.summary.critical>0))try{await (0,l.m)(f.name,a,j)}catch(a){console.error("Failed to send security notification:",a)}return{success:!n,duration:m,output:o,error:n?i.join("; "):void 0}}function s(a){if(0===a)return"0 B";let b=Math.floor(Math.log(a)/Math.log(1024));return parseFloat((a/Math.pow(1024,b)).toFixed(2))+" "+["B","KB","MB","GB","TB"][b]}}};