exports.id=4202,exports.ids=[4202],exports.modules={3421:(a,b,c)=>{"use strict";Object.defineProperty(b,"I",{enumerable:!0,get:function(){return g}});let d=c(71237),e=c(55088),f=c(17679);async function g(a,b,c,g){if((0,d.isNodeNextResponse)(b)){var h;b.statusCode=c.status,b.statusMessage=c.statusText;let d=["set-cookie","www-authenticate","proxy-authenticate","vary"];null==(h=c.headers)||h.forEach((a,c)=>{if("x-middleware-set-cookie"!==c.toLowerCase())if("set-cookie"===c.toLowerCase())for(let d of(0,f.splitCookiesString)(a))b.appendHeader(c,d);else{let e=void 0!==b.getHeader(c);(d.includes(c.toLowerCase())||!e)&&b.appendHeader(c,a)}});let{originalResponse:i}=b;c.body&&"HEAD"!==a.method?await (0,e.pipeToNodeResponse)(c.body,i,g):i.end()}}},20942:(a,b,c)=>{"use strict";c.d(b,{NK:()=>i,Ys:()=>j,hx:()=>k,io:()=>h});var d=c(79646);let e=(0,c(28354).promisify)(d.exec),f=["docker","docker-compose","podman","podman-compose","git","certbot","openssl","pg_dump","pg_restore","psql","tar","gzip","gunzip","which","npx"];function g(a){let b=a.trim().split(/\s+/)[0];return f.some(a=>b===a||b.endsWith(`/${a}`))}function h(a){return`'${a.replace(/'/g,"'\\''")}'`}async function i(a,b={}){if(!g(a))throw Error(`Command not allowed: ${a.split(/\s+/)[0]}`);try{let{stdout:c,stderr:d}=await e(a,{cwd:b.cwd,timeout:b.timeout||12e4,env:{...process.env,...b.env},maxBuffer:0xa00000});return{stdout:c,stderr:d,exitCode:0}}catch(a){return{stdout:a.stdout||"",stderr:a.stderr||a.message,exitCode:a.code||1}}}async function j(a){try{let{exitCode:b}=await i(`which ${a}`);return 0===b}catch{return!1}}async function k(a,b={}){if(!g(a))throw Error(`Command not allowed: ${a.split(/\s+/)[0]}`);return new Promise(c=>{let e=(0,d.spawn)(a,[],{cwd:b.cwd,env:{...process.env,...b.env},shell:!0}),f="",g="",h="",i="",j=a=>{let b=[],c=a.split("\n"),d=c.pop()||"";for(let a of c){let c=a.split("\r"),d=c[c.length-1].trim();d&&b.push(d)}return{lines:b,remainder:d}};e.stdout?.on("data",a=>{let c=a.toString();f+=c;let{lines:d,remainder:e}=j(h+=c);for(let a of(h=e,d))b.onStdout&&b.onStdout(a)}),e.stderr?.on("data",a=>{let c=a.toString();g+=c;let{lines:d,remainder:e}=j(i+=c);for(let a of(i=e,d))b.onStderr&&b.onStderr(a)});let k=b.timeout?setTimeout(()=>{e.kill("SIGTERM")},b.timeout):null;e.on("close",a=>{k&&clearTimeout(k),h.trim()&&b.onStdout&&b.onStdout(h),i.trim()&&b.onStderr&&b.onStderr(i),c({stdout:f,stderr:g,exitCode:a||0})}),e.on("error",a=>{k&&clearTimeout(k),c({stdout:f,stderr:a.message,exitCode:1})})})}},39979:(a,b,c)=>{"use strict";c.d(b,{Nm:()=>q,UD:()=>t,XE:()=>m,az:()=>i,ed:()=>p,oU:()=>s,pS:()=>r,ps:()=>n});var d=c(20942),e=c(15995),f=c(79748),g=c(33873);let h={cloudflare:"certbot-dns-cloudflare",route53:"certbot-dns-route53",digitalocean:"certbot-dns-digitalocean",godaddy:"certbot-dns-godaddy",google:"certbot-dns-google"};async function i(){return(0,d.Ys)("certbot")}function j(a){return g.join("/etc/supascale/certificates",a)}async function k(a){let b=j(a);return await f.mkdir(b,{recursive:!0,mode:448}),b}async function l(a,b,c){let d=await k(a),e=g.join(d,"dns-credentials.ini"),h="";switch(b){case"cloudflare":h=`dns_cloudflare_api_token = ${c.cloudflareApiToken||""}
`;break;case"route53":h=`[default]
aws_access_key_id = ${c.awsAccessKeyId||""}
aws_secret_access_key = ${c.awsSecretAccessKey||""}
`;break;case"digitalocean":h=`dns_digitalocean_token = ${c.digitaloceanToken||""}
`;break;case"godaddy":h=`dns_godaddy_secret = ${c.godaddyApiKey||""}:${c.godaddyApiSecret||""}
`;break;case"google":if(c.googleServiceAccountJson){let a=g.join(d,"google-credentials.json");return await f.writeFile(a,c.googleServiceAccountJson,{mode:384}),a}}return await f.writeFile(e,h,{mode:384}),e}async function m(a,b){let c;if(!await i())return{success:!1,error:"Certbot is not installed. Please install certbot first."};let m=await k(a);"dns-01"===b.challengeType&&b.dnsProvider&&b.dnsCredentials&&(c=await l(a,b.dnsProvider,b.dnsCredentials));let n=function(a,b){let c=["certonly","--non-interactive","--agree-tos"];for(let b of(c.push("--email",a.email),a.domains))c.push("-d",b);if("http-01"===a.challengeType)a.webroot?c.push("--webroot","-w",a.webroot):c.push("--standalone");else if("dns-01"===a.challengeType&&a.dnsProvider){let b=h[a.dnsProvider];c.push(`--${b.replace("certbot-","")}`)}"ecdsa"===a.keyType?(c.push("--key-type","ecdsa"),c.push("--elliptic-curve",384===a.keySize?"secp384r1":"secp256r1")):(c.push("--key-type","rsa"),c.push("--rsa-key-size",String(a.keySize||2048))),a.staging&&c.push("--staging"),a.forceRenewal&&c.push("--force-renewal"),a.dryRun&&c.push("--dry-run");let d=j(b);return c.push("--config-dir",d),c.push("--work-dir",g.join(d,"work")),c.push("--logs-dir",g.join(d,"logs")),c}(b,a);c&&b.dnsProvider&&("google"===b.dnsProvider?n.push("--dns-google-credentials",c):n.push(`--dns-${b.dnsProvider}-credentials`,c));let o=`certbot ${n.map(d.io).join(" ")}`;try{let a=await (0,d.NK)(o,{timeout:3e5});if(0!==a.exitCode)return{success:!1,error:a.stderr||"Certbot command failed",output:a.stdout+"\n"+a.stderr};let c=b.domains[0],h=g.join(m,"live",c),i=g.join(m,"cert.pem"),j=g.join(m,"privkey.pem.enc"),k=g.join(m,"chain.pem"),l=g.join(m,"fullchain.pem"),n=await f.readFile(g.join(h,"cert.pem"),"utf-8"),p=await f.readFile(g.join(h,"privkey.pem"),"utf-8"),q=await f.readFile(g.join(h,"chain.pem"),"utf-8"),s=await f.readFile(g.join(h,"fullchain.pem"),"utf-8");await f.writeFile(i,n,{mode:420}),await f.writeFile(j,(0,e.w)(p),{mode:384}),await f.writeFile(k,q,{mode:420}),await f.writeFile(l,s,{mode:420});let t=await r(i);return{success:!0,certPath:i,keyPath:j,chainPath:k,fullchainPath:l,expiryDate:t,output:a.stdout}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}async function n(a,b){let c=j(a),h=["renew","--non-interactive"];h.push("--config-dir",c),h.push("--work-dir",g.join(c,"work")),h.push("--logs-dir",g.join(c,"logs")),b?.force&&h.push("--force-renewal"),b?.dryRun&&h.push("--dry-run");let i=`certbot ${h.map(d.io).join(" ")}`;try{let a=await (0,d.NK)(i,{timeout:3e5});if(0!==a.exitCode)return{success:!1,error:a.stderr||"Renewal failed",output:a.stdout+"\n"+a.stderr};let b=g.join(c,"privkey.pem.enc"),h=await o(c);if(h){let a=await f.readFile(h,"utf-8");await f.writeFile(b,(0,e.w)(a),{mode:384})}return{success:!0,output:a.stdout}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}async function o(a){let b=g.join(a,"live");try{let a=await f.readdir(b);if(a.length>0)return g.join(b,a[0],"privkey.pem")}catch{}return null}async function p(a,b){let c=j(a),e=["revoke","--non-interactive","--cert-path",g.join(c,"cert.pem")];e.push("--config-dir",c),b&&e.push("--reason",b);let f=`certbot ${e.map(d.io).join(" ")}`;try{let a=await (0,d.NK)(f,{timeout:6e4});if(0!==a.exitCode)return{success:!1,error:a.stderr||"Revocation failed"};return{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Unknown error occurred"}}}async function q(a){let b=j(a);try{return await f.rm(b,{recursive:!0,force:!0}),{success:!0}}catch(a){return{success:!1,error:a instanceof Error?a.message:"Failed to delete certificate files"}}}async function r(a){try{let b=await (0,d.NK)(`openssl x509 -enddate -noout -in ${(0,d.io)(a)}`);if(0===b.exitCode){let a=b.stdout.match(/notAfter=(.+)/);if(a)return new Date(a[1]).toISOString()}}catch{}}async function s(a){try{let b,c,e=await (0,d.NK)(`openssl x509 -in ${(0,d.io)(a)} -noout -subject -issuer -dates -serial -fingerprint -text`);if(0!==e.exitCode)return null;let f=e.stdout,g=[],h=f.match(/Subject:.*CN\s*=\s*([^\n,]+)/);h&&g.push(h[1].trim());let i=f.match(/DNS:([^\n]+)/g);if(i)for(let a of i){let b=a.split(",").map(a=>a.replace("DNS:","").trim());g.push(...b.filter(a=>!g.includes(a)))}let j=f.match(/Issuer:.*O\s*=\s*([^\n,]+)/),k=j?j[1].trim():void 0,l=f.match(/Not Before:\s*(.+)/),m=f.match(/Not After\s*:\s*(.+)/),n=l?new Date(l[1]).toISOString():void 0,o=m?new Date(m[1]).toISOString():void 0,p=f.match(/Serial Number:\s*\n?\s*([^\n]+)/),q=p?p[1].trim():void 0,r=f.match(/SHA256 Fingerprint=([^\n]+)/),s=r?r[1].trim():void 0;if(f.includes("RSA")){b="rsa";let a=f.match(/RSA Public-Key: \((\d+) bit\)/);c=a?parseInt(a[1]):void 0}else if(f.includes("EC")||f.includes("ECDSA")){b="ecdsa";let a=f.match(/NIST CURVE: P-(\d+)/);c=a?parseInt(a[1]):void 0}return{domains:g,issuer:k,validFrom:n,validTo:o,serialNumber:q,fingerprint:s,keyType:b,keySize:c}}catch{return null}}async function t(a,b=30){let c=await r(a);if(!c)return!0;let d=new Date(c),e=new Date;return(d.getTime()-e.getTime())/864e5<=b}},78335:()=>{},95736:(a,b,c)=>{"use strict";a.exports=c(44870)},96487:()=>{}};