---
// Define requireAuthRedirect
const requireAuthRedirect = "/auth/login";
// Make sure to check above value before redirecting
import { checkAuth } from "../../lib/auth";
// Handle OAuth callback if code is present
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalClasses } from "../api/global/global-classes.ts";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();
import { globalCompanyData } from "../../pages/api/global/global-company-data.ts";
const { globalCompanyName } = await globalCompanyData();

const currentRole = currentUser?.profile?.role;
const { id } = Astro.params;

// Handle special routes that shouldn't be treated as project IDs
// Check BEFORE any other processing to avoid invalid project ID errors
if (!id || id === "dashboard") {
  return Astro.redirect("/project/dashboard");
}
// Note: "new" route is handled by /project/new.astro

// Debug logging (can be enabled for troubleshooting)
// console.log("üèóÔ∏è [PROJECT] Project ID:", id);
import App from "../../components/ui/App.astro";
import HeroProject from "../../components/common/HeroProject.astro";
import SlidingTabs from "../../components/common/SlidingTabs.astro";
import TabFiles from "../../components/project/TabFiles.astro";
import TabDiscussions from "../../components/project/TabDiscussions.astro";
import TabProjectForm from "../../components/project/TabProjectForm.astro";
import TabProposal from "../../components/project/TabProposal.astro";
import TabContract from "../../components/project/TabContract.astro";
import TabDeposit from "../../components/project/TabDeposit.astro";
import TabFinalInvoice from "../../components/project/TabFinalInvoice.astro";
import TabActivityLog from "../../components/project/TabActivityLog.astro";
import TabGeneratePdf from "../../components/project/TabGeneratePdf.astro";
import TabMarketing from "../../components/project/TabMarketing.astro";
// refresh-manager loaded in App.astro for Staff/Admin

const validTabs = [
  "project-form",
  "discussion",
  "Files",
  "proposal",
  "contract",
  "deposit",
  "activity-log",
  "generate-pdf",
  "marketing",
  "deliverables",
  "final-invoice",
];

const statusParam = Astro.url.searchParams.get("status");
const defaultTab = validTabs.includes(statusParam || "")
  ? statusParam || "project-form"
  : "project-form";
const activeTabIndex = validTabs.indexOf(defaultTab);

// Track which tab should load content server-side

// Fetch project data and project author profile - RLS will handle authorization
let project: any = null;
// let invoiceData = null;

// Status-related variables (will be defined after data fetching)

// Debug authentication and ID (can be removed once working)
// console.log("üîç [PROJECT] Debug info:", {
//   id,
//   hasCurrentUser: !!currentUser,
//   currentUserId: currentUser?.id,
//   currentRole: currentUser?.profile?.role,
//   url: Astro.url.href,
//   cookies: Astro.request.headers.get("Cookie") ? "Present" : "Missing",
// });

// Fetch single project using the API endpoint

if (id) {
  // Validate that id is a valid number
  const numericId = parseInt(id);
  if (isNaN(numericId) || numericId <= 0) {
    console.error("‚ùå [PROJECT] Invalid project ID:", id, "parsed as:", numericId);
    console.error(
      "‚ùå [PROJECT] This usually means the URL is malformed or contains invalid characters"
    );
    console.error("‚ùå [PROJECT] Please navigate to a valid project URL like: /project/10");
    return Astro.redirect("/dashboard");
  }

  try {
    const baseUrl = Astro.url.origin;
    const apiUrl = `${baseUrl}/api/projects/get?id=${numericId}`;

    // Fetch project data directly via internal API with timeout
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

    const response = await fetch(apiUrl, {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
      signal: controller.signal,
    });

    clearTimeout(timeoutId);

    if (response.ok) {
      const data = await response.json();
      if (data.data) {
        project = data.data;
      } else {
        console.error("üèóÔ∏è [PROJECT] API returned error:", data.error);
        return Astro.redirect("/dashboard");
      }
    } else {
      console.error("üèóÔ∏è [PROJECT] Error fetching project:", response.status, response.statusText);
      return Astro.redirect("/dashboard");
    }
  } catch (error: any) {
    if (error.name === "AbortError") {
      console.error("üèóÔ∏è [PROJECT] Request timeout while fetching project");
    } else {
      console.error("üèóÔ∏è [PROJECT] Error fetching project:", error?.message || error);
    }
    return Astro.redirect("/dashboard");
  }
} else {
  console.error("üèóÔ∏è [PROJECT] No project ID provided");
  return Astro.redirect("/dashboard");
}

const currentStatusInt = project?.status;
let currentStatusName;

// Status-related variables
let currentStatusTab: string | null = null;
let currentStatusColor = "gray";
let currentStatusProjectAction: string | null = null;

// Fetch all project statuses using the unified API (same pattern as dashboard.astro)
// This gets ALL statuses data - we'll extract the current one and pass the full statusData to components
// Pass the project ID so placeholders can be replaced with actual project data
const statusApiUrl = new URL("/api/status/get", Astro.url.origin);
statusApiUrl.searchParams.set("projectId", project.id.toString());
const statusResponse = await fetch(statusApiUrl.toString(), {
  method: "GET",
  headers: {
    Cookie: Astro.request.headers.get("Cookie") || "",
  },
});

let statusData: Record<number, any> = {};
let statusOptions: Array<{ value: string; label: string }> = [];

if (statusResponse.ok) {
  const statusResponseData = await statusResponse.json();

  // API returns: { success: true, statuses: Record<number, {...}>, selectOptions: [...] }
  // statuses is a Record where keys are status codes (numbers) and values contain admin/client/current objects
  statusData = statusResponseData.statuses || {};
  statusOptions = statusResponseData.selectOptions || [];

  // Log for debugging if statuses are empty
  if (Object.keys(statusData).length === 0) {
    console.error("‚ùå [PROJECT-PAGE] Status API returned empty statuses!");
    console.error(
      "‚ùå [PROJECT-PAGE] Full API response:",
      JSON.stringify(statusResponseData, null, 2)
    );
    console.error(
      "‚ùå [PROJECT-PAGE] This likely means the database has no statuses or the query failed"
    );
  }
} else {
  const errorText = await statusResponse.text();
  console.error(
    "‚ùå [PROJECT-PAGE] Status API failed:",
    statusResponse.status,
    statusResponse.statusText,
    "Response:",
    errorText
  );
  // Continue with empty status data - page can still load
}

// Extract current status info from statusData for use in this page
// The full statusData object is kept intact to pass to child components
if (currentStatusInt && statusData[currentStatusInt]) {
  const currentStatusObj = statusData[currentStatusInt];
  // API already handles role-based filtering, so use the 'current' property directly
  currentStatusName = currentStatusObj.current?.statusName;
  currentStatusTab = currentStatusObj.current?.statusTab;
  currentStatusProjectAction = currentStatusObj.current?.statusAction;
  currentStatusColor = currentStatusObj.current?.statusColor || "gray";

  // Handle status param in URL - if it matches currentStatusProjectAction, clear it
  if (statusParam && currentStatusProjectAction?.includes("status=" + statusParam)) {
    currentStatusProjectAction = null;
  }
}
---

<App
  {currentUser}
  {project}
  title={project?.title || "Untitled Project"}
  description={project?.authorProfile?.companyName || "Unknown Author"}
  {session}
  {supabase}
  supabaseUrl={import.meta.env.PUBLIC_SUPABASE_URL}
  isBackend={true}
  {id}
  {globalCompanyName}
  {globalInputClasses}
  {primaryTextClasses}
  {secondaryTextClasses}
  mask="top-left"
>
  <HeroProject
    title={project?.address || project?.title || "Untitled Project"}
    description={currentUser?.profile?.role === "Client"
      ? project?.createdAt
        ? "<b>Created:</b> " + new Date(project.createdAt).toLocaleDateString()
        : "Unknown Date"
      : project?.authorProfile?.companyName + " ‚Üí " + project?.authorProfile?.email ||
        "Unknown Author"}
    statusColor={currentStatusColor}
    {currentUser}
    currentStatusInt={currentStatusInt.toString()}
    currentStatusName={currentStatusName || undefined}
    {project}
    statusesOptions={statusOptions}
    currentStatusTab={currentStatusTab || undefined}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {globalCompanyName}
  />

  <!-- Tab Navigation -->
  <SlidingTabs
    navId="project-tab-nav"
    navClass="my-4 dark:border-gray-700"
    activeItem={activeTabIndex}
    showTooltips={false}
    {currentUser}
    items={[
      {
        id: "status-project-form",
        showLabel: true,
        label: "Project Form",
        icon: "edit",
        variant: "tab",
        onclick: "window.switchTab('project-form')",
      },
      {
        id: "status-discussion",
        showLabel: true,
        label: "Discussion",
        icon: "message-rounded-dots",
        variant: "tab",
        dataAttributes: { "data-count": "0" },
        onclick: "window.switchTab('discussion')",
      },
      {
        id: "status-files",
        showLabel: true,
        label: "Files",
        icon: "file",
        variant: "tab",
        onclick: "window.switchTab('files')",
      },
      {
        id: "status-proposal",
        showLabel: true,
        label: "Proposal",
        icon: "grid",
        variant: "tab",
        onclick: "window.switchTab('proposal')",
      },
      {
        id: "status-contract",
        showLabel: true,
        label: "Contract",
        icon: "pencil",
        variant: "tab",
        onclick: "window.switchTab('contract')",
      },
      {
        id: "status-deposit",
        showLabel: true,
        label: "Deposit",
        icon: "credit-card",
        variant: "tab",
        onclick: "window.switchTab('deposit')",
      },
      {
        id: "status-activity-log",
        showLabel: true,
        label: "Activity Log",
        icon: "history",
        variant: "tab",
        onclick: "window.switchTab('activity-log')",
        clientHide: true,
      },
      {
        id: "status-generate-pdf",
        showLabel: true,
        label: "Generate PDF",
        icon: "adobe",
        variant: "tab",
        onclick: "window.switchTab('generate-pdf')",
        clientHide: true,
      },
      {
        id: "status-marketing",
        showLabel: true,
        label: "Marketing",
        icon: "palette",
        variant: "tab",
        onclick: "window.switchTab('marketing')",
        clientHide: true,
      },
    ]}
  />
  <!-- Tab Content -->
  <!-- <div class="grid grid-cols-1 gap-6 lg:grid-cols-1"> -->
  <!-- Project Form Tab -->

  <!-- <div class="transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1) px-4 transition-all duration-200"> -->
  <TabProjectForm
    {project}
    {currentUser}
    projectStatus={currentStatusInt}
    projectStatusLabel={currentStatusName || undefined}
    {globalInputClasses}
    {secondaryTextClasses}
    {primaryTextClasses}
  />

  <!-- Discussion Tab -->

  <TabDiscussions
    {project}
    {currentUser}
    {globalInputClasses}
    {secondaryTextClasses}
    {primaryTextClasses}
  />

  <!-- Documents Tab -->
  <TabFiles
    {project}
    {currentUser}
    projectStatus={currentStatusInt}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {statusData}
  />

  <!-- Proposal Tab -->
  <TabProposal
    {project}
    projectStatus={currentStatusInt}
    {currentUser}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {statusData}
  />

  <!-- Contract Tab -->
  <TabContract
    {project}
    {currentUser}
    projectStatus={currentStatusInt}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {statusData}
  />

  <!-- Deposit Tab -->
  <TabDeposit
    {project}
    {currentUser}
    projectStatus={currentStatusInt}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {statusData}
  />

  <!-- Final Invoice Tab -->
  <TabFinalInvoice
    {project}
    projectStatus={currentStatusInt}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {statusData}
  />

  <TabActivityLog
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {currentUser}
    {project}
    {statusData}
  />

  <TabGeneratePdf
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
    {project}
    {currentUser}
    {statusData}
    {globalCompanyName}
  />

  <TabMarketing
    {project}
    {currentUser}
    {secondaryTextClasses}
    {primaryTextClasses}
    {globalInputClasses}
  />
  <!-- </div> -->
</App>

<script
  type="module"
  define:vars={{
    project,
    currentUser,
    currentStatusProjectAction,
    baseUrl: Astro.url.origin,
    statusData,
  }}
  is:inline
>
  const currentStatus = project?.status || 0;
  const projectId = project?.id;
  const currentRole = currentUser?.profile?.role;
  // Tab switching functionality

  // Initialize tabs on page load
  document.addEventListener("DOMContentLoaded", function () {
    // Check for project action modal first
    checkProjectActionModal();
  });

  // Check for project action modal on page load
  function checkProjectActionModal() {
    console.log("üîç [PROJECT] Checking for project action:", currentStatusProjectAction);

    if (currentStatusProjectAction && currentStatusProjectAction.trim() !== "") {
      console.log("üöÄ [PROJECT] Found project action, showing modal:", currentStatusProjectAction);

      // Show modal with project action content
      if (typeof window.showNotice === "function") {
        window.showNotice(
          "info",
          "Project Action Required",
          currentStatusProjectAction,
          3000,
          true
        );
      } else {
        // Fallback alert if modal function not available
        alert(`Project Status Update:\n\n${currentStatusProjectAction}`);
      }
    } else {
      console.log("üîç [PROJECT] No project action to display");
    }
  }

  // Initialize tabs on page load
  document.addEventListener("DOMContentLoaded", function () {
    // Check for project action modal first
    checkProjectActionModal();

    // Load discussion count for status-discussion tab
    if (projectId) {
      try {
        // Inline discussion count loading
        fetch(`/api/discussions/get?projectId=${projectId}`)
          .then((response) => response.json())
          .then((result) => {
            if (result.success && result.incompleteCount !== undefined) {
              // Update the count bubble
              const countElement = document.querySelector("#status-discussion .count-bubble");
              if (countElement) {
                countElement.textContent = result.incompleteCount;
                countElement.style.display = result.incompleteCount > 0 ? "inline-flex" : "none";
              }
              console.log("üí¨ Discussion count updated:", result.incompleteCount);
            }
          })
          .catch((error) => {
            console.error("Error loading discussion count:", error);
          });
      } catch (error) {
        console.error("Error loading discussion count:", error);
      }
    }

    // Get status from URL parameter or use default
    const urlParams = new URLSearchParams(window.location.search);
    const statusFromUrl = urlParams.get("status");
    const validTabs = [
      "project-form",
      "discussion",
      "files",
      "proposal",
      "contract",
      "deposit",
      "final-invoice",
      "activity-log",
      "generate-pdf",
      "deliverables",
    ];

    // Parse status name and parameters
    let initialTab = "project-form";
    if (statusFromUrl && validTabs.includes(statusFromUrl)) {
      initialTab = statusFromUrl;
      console.log("üîî [PROJECT-PAGE] Setting initial tab:", initialTab);
    }

    // Switch to the initial tab - wait for switchTab to be defined
    const trySwitchTab = () => {
      if (window.switchTab) {
        window.switchTab(initialTab);
      } else {
        setTimeout(trySwitchTab, 50);
      }
    };
    trySwitchTab();
  });
</script>

<script>
  // Global tab switching function - source of truth for all tab navigation
  window.switchTab = async function (tabName) {
    console.log(`üîÑ [SWITCH-TAB] Switching to: ${tabName}`);

    // Parse tab name and parameters
    const [baseTabName] = tabName.split("&");

    // Hide all tab contents
    const tabContents = document.querySelectorAll(".tab-content");
    tabContents.forEach((content) => {
      content.classList.add("hidden");
    });

    // Show selected tab content
    const selectedContent = document.getElementById(`content-${baseTabName}`);
    if (selectedContent) {
      selectedContent.classList.remove("hidden");

      // Try to call the initialization function if it exists (e.g., initializeDiscussion)
      const initFunc =
        window[`initialize${baseTabName.charAt(0).toUpperCase() + baseTabName.slice(1)}`];
      if (typeof initFunc === "function") {
        console.log(`üîÑ [SWITCH-TAB] Found initialization function for ${baseTabName}`);
        try {
          await initFunc();
        } catch (error) {
          console.error(`‚ùå [SWITCH-TAB] Error initializing ${baseTabName}:`, error);
        }
      }
    }

    // Update URL with status parameter (without page reload)
    const currentUrl = new URL(window.location.href);
    if (baseTabName === "project-form") {
      // Remove status parameter for default tab
      currentUrl.searchParams.delete("status");
    } else {
      // Add or update status parameter with only the base tab name
      currentUrl.searchParams.set("status", baseTabName);
    }

    // Update browser history without reloading the page
    window.history.replaceState({}, "", currentUrl.toString());

    console.log(`‚úÖ [SWITCH-TAB] Switched to: ${baseTabName}`);
  };

  // Initialize Discussion tab function
  (window as any).initializeDiscussion = async function () {
    console.log("üé¨ [INIT-DISCUSSION] Initializing discussion tab...");

    // Find the discussions container
    const discussionsContainer = document.getElementById("content-discussion");
    if (!discussionsContainer) {
      console.error("‚ùå [INIT-DISCUSSION] Discussions container not found");
      return;
    }

    // Call the initialization function if it exists
    if (typeof (window as any).initializeDiscussions === "function") {
      console.log("üé¨ [INIT-DISCUSSION] Calling initializeDiscussions");
      try {
        await (window as any).initializeDiscussions();
        console.log("‚úÖ [INIT-DISCUSSION] Discussion system initialized");
      } catch (error) {
        console.error("‚ùå [INIT-DISCUSSION] Error initializing discussions:", error);
      }
    } else {
      console.error("‚ùå [INIT-DISCUSSION] initializeDiscussions function not found");
    }
  };
</script>
