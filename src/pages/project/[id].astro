---
import App from "../../components/App.astro";
import SectionContainer from "../../components/SectionContainer.astro";
import ProjectForm from "../../components/form/ProjectForm.astro";

// Get the project ID from the URL parameter
const { id } = Astro.params;

console.log("üåê [PROJECT] Project ID:", id);
import { supabase } from "../../lib/supabase";

// Authentication is handled by middleware for /project/** routes
// User info is available in Astro.locals (set by middleware)
const user = Astro.locals.user;
const role = Astro.locals.role;

console.log("üåê [PROJECT] User:", user?.id, "Role:", role);

// Fetch project data - RLS will handle authorization
let project = null;
if (supabase && user) {
  const { data, error } = await supabase
    .from("projects")
    .select("*")
    .eq("id", id)
    .single();

  if (error) {
    console.error("Error fetching project:", error);
    // Project not found or no access - handled by RLS
  } else {
    project = data;
    console.log("üåê [PROJECT] Project loaded:", project.title);
  }
}
---

<App>
  <SectionContainer class="flex flex-col gap-y-6 mx-6">
    <div class="flex items-center justify-between">
      <a
        href="/"
        class="inline-flex items-center px-3 py-2 bg-gray-500 text-white text-sm font-medium rounded-lg hover:bg-gray-600 transition-colors"
      >
        <i class="bx bx-arrow-back mr-2"></i>
        Back to Projects
      </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
      <!-- Form Container -->
      <div
        class="p-6 bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <ProjectForm
          project={project}
          projectId={id ?? ""}
          isNewProject={false}
          userRole={role}
        />
      </div>
    </div>
  </SectionContainer>
</App>

<script>
  // Form handling functions
  function deleteProject(projectId: string) {
    if (confirm("Are you sure you want to delete this project?")) {
      // Add delete logic here
      console.log("Deleting project:", projectId);
    }
  }

  function buildEstimate(projectId: string) {
    // Add build estimate logic here
    console.log("Building estimate for project:", projectId);
  }

  function editEstimate(projectId: string) {
    // Add edit estimate logic here
    console.log("Editing estimate for project:", projectId);
  }
</script>
