---
/**
 * Project Settings Page
 * Manage default punchlist and discussion templates for new projects
 * Only accessible to Admin users
 */
import { checkAuth } from "../../lib/auth";
import App from "../../components/ui/App.astro";
import Button from "../../components/common/Button.astro";
import SlidingTabs from "../../components/common/SlidingTabs.astro";
import UnitSlider from "../../components/form/UnitSlider.astro";
import { globalCompanyData } from "../api/global/global-company-data";
import { globalClasses } from "../api/global/global-classes";
import { supabaseAdmin } from "../../lib/supabase-admin";

const { currentUser, session } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

const companyData = await globalCompanyData();
const { globalInputClasses } = globalClasses();

// Tab state from URL for server-side active index
const settingsTabParam = Astro.url.searchParams.get("tab") || "defaults";
const validSettingsTabs = ["defaults", "punchlist", "discussion"];
const settingsActiveTab =
  validSettingsTabs.includes(settingsTabParam) ? settingsTabParam : "defaults";
const settingsActiveTabIndex = validSettingsTabs.indexOf(settingsActiveTab);

// Fetch initial default due date hours from globalSettings (server-side)
let initialDefaultDueDateHours = 72;
if (supabaseAdmin) {
  try {
    const { data } = await supabaseAdmin
      .from("globalSettings")
      .select("value")
      .eq("key", "projectDefaultDueDateHours")
      .maybeSingle();
    if (data?.value) {
      const parsed = parseInt(data.value, 10);
      if (!isNaN(parsed)) {
        initialDefaultDueDateHours = Math.min(240, Math.max(1, parsed));
      }
    }
  } catch {
    // use fallback 72
  }
}
---

<App
  title="Project Settings"
  description="Manage default project templates"
  {currentUser}
  {session}
  globalCompanyName={companyData.globalCompanyName}
  globalCompanySlogan={companyData.globalCompanySlogan}
  globalCompanyLogo={companyData.globalCompanyLogo}
>
  <div class="mx-auto max-w-6xl px-4 py-8">
    <div class="mb-6">
      <h1 class="mb-2 text-3xl font-bold">Project Settings</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Manage default punchlist and discussion templates that are created when new projects are
        deployed. These templates support placeholders like {`{{PROJECT_TITLE}}`}, {
          `{{CLIENT_NAME}}`
        }, etc.
        <br />To manually apply templates to a project, run the following command:
        <code> node scripts/apply-templates-to-project.js [projectId] </code>
      </p>
    </div>

    <!-- Tab Navigation -->
    <div class="mb-6">
      <SlidingTabs
        navId="settings-tab-nav"
        navClass="border-b border-gray-200 dark:border-gray-700"
        activeItem={settingsActiveTabIndex}
        urlParam="tab"
        switchHandler="switchSettingsTab"
        items={[
          { id: "tab-defaults", label: "Defaults", variant: "tab", showLabel: true, onclick: "window.switchSettingsTab('defaults')" },
          { id: "tab-punchlist", label: "Punchlist Templates", variant: "tab", showLabel: true, onclick: "window.switchSettingsTab('punchlist')" },
          { id: "tab-discussion", label: "Discussion Templates", variant: "tab", showLabel: true, onclick: "window.switchSettingsTab('discussion')" },
        ]}
      />
    </div>

    <!-- Defaults Section -->
    <div
      id="section-defaults"
      class={`template-section ${settingsActiveTab !== "defaults" ? "hidden" : ""}`}
    >
      <div class="mb-4">
        <h2 class="text-xl font-semibold">Default Settings</h2>
      </div>

      <div class="rounded-lg bg-white p-6 shadow dark:bg-gray-900">
        <div class="space-y-6">
          <div>
            <UnitSlider
              projectId="defaults"
              name="defaultDueDateHours"
              label="Due date"
              value={initialDefaultDueDateHours}
              min={1}
              max={240}
              step={1}
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Default hours until due when creating new projects (1â€“240 hours)
            </p>
          </div>
          <div>
            <Button id="save-defaults-btn" type="button" variant="primary">
              <i class="bx bx-save mr-2"></i>
              Save Defaults
            </Button>
          </div>
        </div>
      </div>
    </div>

    <!-- Punchlist Templates Section -->
    <div
      id="section-punchlist"
      class={`template-section ${settingsActiveTab !== "punchlist" ? "hidden" : ""}`}
    >
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold">Punchlist Templates</h2>
        <Button id="add-punchlist-btn" type="button" variant="primary">
          <i class="bx bx-plus mr-2"></i>
          Add Punchlist Item
        </Button>
      </div>

      <div class="rounded-lg bg-white shadow dark:bg-gray-900">
        <div
          id="punchlist-templates-container"
          class="divide-y divide-gray-200 dark:divide-gray-700"
        >
          <!-- Templates will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Discussion Templates Section -->
    <div
      id="section-discussion"
      class={`template-section ${settingsActiveTab !== "discussion" ? "hidden" : ""}`}
    >
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-xl font-semibold">Discussion Templates</h2>
        <Button id="add-discussion-btn" type="button" variant="primary">
          <i class="bx bx-plus mr-2"></i>
          Add Discussion Item
        </Button>
      </div>

      <div class="rounded-lg bg-white shadow dark:bg-gray-900">
        <div
          id="discussion-templates-container"
          class="divide-y divide-gray-200 dark:divide-gray-700"
        >
          <!-- Templates will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div
    id="edit-modal"
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50"
  >
    <div
      class="mx-4 max-h-[90vh] w-full max-w-3xl overflow-y-auto rounded-lg bg-white shadow-xl dark:bg-gray-900"
    >
      <div class="p-6">
        <div class="mb-4 flex items-center justify-between">
          <h3 id="modal-title" class="text-xl font-semibold">Edit Template</h3>
          <button
            id="close-modal"
            class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
          >
            <i class="bx bx-x text-2xl"></i>
          </button>
        </div>

        <form id="template-form">
          <input type="hidden" id="template-id" name="id" />
          <input type="hidden" id="template-type" name="type" />

          <div class="space-y-4">
            <div>
              <label for="template-title" class="mb-1 block text-sm font-medium">Title</label>
              <input
                type="text"
                id="template-title"
                name="title"
                required
                class={globalInputClasses}
                placeholder="Enter a descriptive title"
              />
            </div>

            <div>
              <label for="template-message" class="mb-1 block text-sm font-medium">Message</label>
              <textarea
                id="template-message"
                name="message"
                required
                rows="6"
                class={globalInputClasses}
                placeholder="Enter the template message. You can use placeholders like PROJECT_TITLE, CLIENT_NAME, PROJECT_ADDRESS (wrapped in double curly braces)."
              ></textarea>
              <p class="mt-1 text-xs text-gray-500">
                Supports HTML and placeholders: {`{{PROJECT_TITLE}}`}, {`{{CLIENT_NAME}}`}, {
                  `{{PROJECT_ADDRESS}}`
                }, {`{{RAILWAY_PUBLIC_DOMAIN}}`}, {`{{PROJECT_ID}}`}
              </p>
            </div>

            <div>
              <label for="template-order" class="mb-1 block text-sm font-medium">Order</label>
              <input
                type="number"
                id="template-order"
                name="orderIndex"
                required
                min="0"
                class={globalInputClasses}
                placeholder="0"
              />
            </div>

            <div class="flex items-center space-x-6">
              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="template-internal"
                  name="internal"
                  class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <span class="ml-2 text-sm">Internal Only (for discussions)</span>
              </label>

              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="template-completed"
                  name="markCompleted"
                  class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <span class="ml-2 text-sm">Mark as Completed</span>
              </label>

              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="template-enabled"
                  name="enabled"
                  checked
                  class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <span class="ml-2 text-sm">Enabled</span>
              </label>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button
              type="button"
              id="cancel-btn"
              class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
            >
              Cancel
            </button>
            <button
              type="submit"
              class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700"
            >
              Save Template
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    // State
    const validSettingsTabs = ["defaults", "punchlist", "discussion"];
    let currentTab = "defaults";
    let templates: any = { punchlist: [], discussion: [] };

    // DOM Elements
    const modal = document.getElementById("edit-modal") as HTMLElement;
    const templateForm = document.getElementById("template-form") as HTMLFormElement;

    // Initialize
    document.addEventListener("DOMContentLoaded", () => {
      loadDefaults();
      loadTemplates();
      setupEventListeners();
    });

    function setupEventListeners() {
      // Tab switching via SlidingTabs onclick; expose switchSettingsTab for URL init
      (window as any).switchSettingsTab = switchTab;

      // Defaults save (UnitSlider updates its own display)
      document
        .getElementById("save-defaults-btn")
        ?.addEventListener("click", saveDefaults);

      // Add buttons
      document
        .getElementById("add-punchlist-btn")
        ?.addEventListener("click", () => openModal("punchlist"));
      document
        .getElementById("add-discussion-btn")
        ?.addEventListener("click", () => openModal("discussion"));

      // Modal controls
      document.getElementById("close-modal")?.addEventListener("click", closeModal);
      document.getElementById("cancel-btn")?.addEventListener("click", closeModal);
      templateForm?.addEventListener("submit", handleFormSubmit);

      // Close modal on backdrop click
      modal?.addEventListener("click", (e) => {
        if (e.target === modal) closeModal();
      });
    }

    function switchTab(tab: string) {
      currentTab = tab;

      // Update URL
      const url = new URL(window.location.href);
      url.searchParams.set("tab", tab);
      window.history.replaceState({}, "", url.toString());

      // Update sections
      document.querySelectorAll(".template-section").forEach((section) => {
        const sectionId = section.id.replace("section-", "");
        if (sectionId === tab) {
          section.classList.remove("hidden");
        } else {
          section.classList.add("hidden");
        }
      });
    }

    async function loadDefaults() {
      try {
        const response = await fetch("/api/project-defaults/get");
        if (!response.ok) return;
        const data = await response.json();
        const hours = Math.min(240, Math.max(1, data.defaultDueDateHours || 72));
        const slider = document.getElementById("defaultDueDateHours-slider-defaults");
        const valueDisplay = document.getElementById("defaultDueDateHours-value-defaults");
        if (slider) (slider as HTMLInputElement).value = String(hours);
        if (valueDisplay) valueDisplay.textContent = String(hours);
      } catch (error) {
        console.error("Error loading defaults:", error);
      }
    }

    async function saveDefaults() {
      const slider = document.getElementById("defaultDueDateHours-slider-defaults");
      const hours = slider ? parseInt((slider as HTMLInputElement).value, 10) : 72;
      try {
        const response = await fetch("/api/settings/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            settings: { projectDefaultDueDateHours: String(hours) },
          }),
        });

        if (!response.ok) {
          const err = await response.json().catch(() => ({}));
          throw new Error(err.error || "Failed to save defaults");
        }

        if (window.showSuccess) {
          window.showSuccess("Defaults Saved", "Project defaults updated successfully", 4000);
        }
      } catch (error) {
        console.error("Error saving defaults:", error);
        if (window.showError) {
          window.showError(
            "Save Failed",
            error instanceof Error ? error.message : "Failed to save defaults",
            0
          );
        }
      }
    }

    async function loadTemplates() {
      try {
        const response = await fetch("/api/project-templates/get?includeDisabled=true");
        if (!response.ok) throw new Error("Failed to load templates");

        const data = await response.json();
        templates.punchlist = data.templates.filter((t: any) => t.type === "punchlist");
        templates.discussion = data.templates.filter((t: any) => t.type === "discussion");

        renderTemplates();
      } catch (error) {
        console.error("Error loading templates:", error);
        if (window.showError) {
          window.showError(
            "Failed to Load Templates",
            "Unable to load templates. Please try again.",
            0
          );
        }
      }
    }

    function renderTemplates() {
      renderTemplateList("punchlist", templates.punchlist);
      renderTemplateList("discussion", templates.discussion);
    }

    function renderTemplateList(type: string, items: any[]) {
      const container = document.getElementById(`${type}-templates-container`);
      if (!container) return;

      if (items.length === 0) {
        container.innerHTML = `
          <div class="p-8 text-center text-gray-500">
            <i class="bx bx-info-circle text-4xl mb-2"></i>
            <p>No ${type} templates yet. Click "Add ${type === "punchlist" ? "Punchlist" : "Discussion"} Item" to create one.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = items
        .sort((a, b) => a.orderIndex - b.orderIndex)
        .map(
          (item) => `
          <div class="p-4 ${!item.enabled ? "opacity-50" : ""}">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h4 class="font-medium">${item.title}</h4>
                  ${!item.enabled ? '<span class="text-xs bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">Disabled</span>' : ""}
                  ${item.internal ? '<span class="text-xs bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 px-2 py-1 rounded">Internal</span>' : ""}
                  ${item.markCompleted ? '<span class="text-xs bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 px-2 py-1 rounded">Auto-complete</span>' : ""}
                </div>
                <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${item.message}</p>
                <p class="text-xs text-gray-400 mt-1">Order: ${item.orderIndex}</p>
              </div>
              <div class="flex items-center gap-2 ml-4">
                <button
                  onclick="window.editTemplate(${item.id})"
                  class="p-2 text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded"
                  title="Edit"
                >
                  <i class="bx bx-edit"></i>
                </button>
                <button
                  onclick="window.deleteTemplate(${item.id}, '${type}')"
                  class="p-2 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 rounded"
                  title="Delete"
                >
                  <i class="bx bx-trash"></i>
                </button>
              </div>
            </div>
          </div>
        `
        )
        .join("");
    }

    function openModal(type: string, template?: any) {
      const modalTitle = document.getElementById("modal-title");
      const form = templateForm;

      if (!form || !modalTitle) return;

      // Set title
      modalTitle.textContent = template
        ? "Edit Template"
        : `Add ${type === "punchlist" ? "Punchlist" : "Discussion"} Item`;

      // Reset form
      form.reset();
      (document.getElementById("template-type") as HTMLInputElement).value = type;

      // Populate form if editing
      if (template) {
        (document.getElementById("template-id") as HTMLInputElement).value = template.id;
        (document.getElementById("template-title") as HTMLInputElement).value = template.title;
        (document.getElementById("template-message") as HTMLTextAreaElement).value =
          template.message;
        (document.getElementById("template-order") as HTMLInputElement).value = template.orderIndex;
        (document.getElementById("template-internal") as HTMLInputElement).checked =
          template.internal;
        (document.getElementById("template-completed") as HTMLInputElement).checked =
          template.markCompleted;
        (document.getElementById("template-enabled") as HTMLInputElement).checked =
          template.enabled;
      }

      // Show modal
      modal.classList.remove("hidden");
      modal.classList.add("flex");
    }

    function closeModal() {
      modal.classList.add("hidden");
      modal.classList.remove("flex");
    }

    async function handleFormSubmit(e: Event) {
      e.preventDefault();

      const formData = new FormData(templateForm);

      // Get and validate required fields
      const idValue = formData.get("id");
      const type = formData.get("type") as string;
      const title = formData.get("title") as string;
      const message = formData.get("message") as string;

      // Validate required fields
      if (!type || !title || !message) {
        if (window.showError) {
          window.showError(
            "Validation Error",
            "Please fill in all required fields (type, title, message)",
            0
          );
        }
        return;
      }

      // Parse ID - convert to number if present, otherwise null
      const id = idValue && idValue.toString().trim() ? parseInt(idValue.toString()) || null : null;

      const data: any = {
        type: type.trim(),
        title: title.trim(),
        message: message.trim(),
        orderIndex: parseInt(formData.get("orderIndex") as string) || 0,
        internal: formData.get("internal") === "on",
        markCompleted: formData.get("markCompleted") === "on",
        enabled: formData.get("enabled") === "on",
      };

      // Only include id if it's a valid number (for updates)
      if (id !== null && !isNaN(id)) {
        data.id = id;
      }

      try {
        const response = await fetch("/api/project-templates/upsert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          const errorData = await response
            .json()
            .catch(() => ({ error: "Failed to save template" }));
          const errorMessage = errorData.error || `Failed to save template (${response.status})`;
          const errorDetails = errorData.details ? `: ${errorData.details}` : "";
          throw new Error(`${errorMessage}${errorDetails}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || "Failed to save template");
        }

        if (window.showSuccess) {
          window.showSuccess(
            data.id ? "Template Updated" : "Template Created",
            data.id ? "Template updated successfully" : "Template created successfully",
            4000
          );
        }
        closeModal();
        await loadTemplates();
      } catch (error) {
        console.error("Error saving template:", error);
        const errorMessage = error instanceof Error ? error.message : "Failed to save template";
        if (window.showError) {
          window.showError("Save Failed", errorMessage, 0);
        }
      }
    }

    async function deleteTemplate(id: number, type: string) {
      if (!confirm("Are you sure you want to delete this template?")) return;

      try {
        const response = await fetch("/api/project-templates/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id }),
        });

        if (!response.ok) throw new Error("Failed to delete template");

        if (window.showSuccess) {
          window.showSuccess("Template Deleted", "Template deleted successfully", 4000);
        }
        await loadTemplates();
      } catch (error) {
        console.error("Error deleting template:", error);
        if (window.showError) {
          window.showError("Delete Failed", "Failed to delete template", 0);
        }
      }
    }

    function editTemplate(id: number) {
      const allTemplates = [...templates.punchlist, ...templates.discussion];
      const template = allTemplates.find((t) => t.id === id);
      if (template) {
        openModal(template.type, template);
      }
    }

    // Expose functions to window for onclick handlers
    (window as any).editTemplate = editTemplate;
    (window as any).deleteTemplate = deleteTemplate;
  </script>

  <style>
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</App>
