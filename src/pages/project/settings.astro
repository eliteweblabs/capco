---
/**
 * Project Settings Page
 * Manage default punchlist and discussion templates for new projects
 * Only accessible to Admin users
 */
import { checkAuth } from "../../lib/auth";
import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import Button from "../../components/common/Button.astro";
import SlidingTabs from "../../components/common/SlidingTabs.astro";
import UnitSlider from "../../components/form/UnitSlider.astro";
import AccordionDataTable from "../../components/common/AccordionDataTable.astro";
import TanStackDataTable from "../../components/common/TanStackDataTable.astro";
import TemplateRowActions from "../../components/project/TemplateRowActions.astro";
import CloseButton from "../../components/ui/CloseButton.astro";
import { globalCompanyData } from "../api/global/global-company-data";
import { globalClasses } from "../api/global/global-classes";
import { supabaseAdmin } from "../../lib/supabase-admin";

const { currentUser, session } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

const companyData = await globalCompanyData();
const { globalFormClasses, globalInputClasses } = globalClasses();

// Tab state from URL for server-side active index
const settingsTabParam = Astro.url.searchParams.get("tab") || "defaults";
const validSettingsTabs = ["defaults", "punchlist", "discussion"];
const settingsActiveTab = validSettingsTabs.includes(settingsTabParam)
  ? settingsTabParam
  : "defaults";
const settingsActiveTabIndex = validSettingsTabs.indexOf(settingsActiveTab);

// Fetch initial default due date hours from globalSettings (server-side)
let initialDefaultDueDateHours = 72;
if (supabaseAdmin) {
  try {
    const { data } = await supabaseAdmin
      .from("globalSettings")
      .select("value")
      .eq("key", "projectDefaultDueDateHours")
      .maybeSingle();
    if (data?.value) {
      const parsed = parseInt(data.value, 10);
      if (!isNaN(parsed)) {
        initialDefaultDueDateHours = Math.min(240, Math.max(1, parsed));
      }
    }
  } catch {
    // use fallback 72
  }
}

// Fetch templates server-side
let punchlistTemplates: any[] = [];
let discussionTemplates: any[] = [];
if (supabaseAdmin) {
  try {
    const { data } = await supabaseAdmin
      .from("projectItemTemplates")
      .select("*")
      .order("orderIndex", { ascending: true });
    const all = data || [];
    punchlistTemplates = all.filter((t: any) => t.type === "punchlist");
    discussionTemplates = all.filter((t: any) => t.type === "discussion");
  } catch {
    // use empty arrays
  }
}
---

<LayoutDefault
  title="Project Settings"
  description="Manage default punchlist and discussion templates for new projects"
>
  <div class="max-w-6xl px-4 py-8">
    <div class="mb-6">
      <h1 class="mb-2 text-3xl font-bold">Project Settings</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Manage default punchlist and discussion templates that are created when new projects are
        deployed. These templates support placeholders like {`{{PROJECT_TITLE}}`}, {
          `{{CLIENT_NAME}}`
        }, etc.
        <br />To manually apply templates to a project, run the following command:
        <code> node scripts/apply-templates-to-project.js [projectId] </code>
      </p>
    </div>

    <!-- Tab Navigation -->
    <SlidingTabs
      navId="settings-tab-nav"
      activeItem={settingsActiveTabIndex}
      urlParam="tab"
      switchHandler="switchSettingsTab"
      items={[
        {
          id: "tab-defaults",
          label: "Defaults",
          variant: "tab",
          showLabel: true,
          onclick: "window.switchSettingsTab('defaults')",
        },
        {
          id: "tab-punchlist",
          label: "Punchlist Templates",
          variant: "tab",
          showLabel: true,
          onclick: "window.switchSettingsTab('punchlist')",
        },
        {
          id: "tab-discussion",
          label: "Discussion Templates",
          variant: "tab",
          showLabel: true,
          onclick: "window.switchSettingsTab('discussion')",
        },
      ]}
    />

    <!-- Defaults Section -->
    <div
      id="section-defaults"
      class={`template-section ${settingsActiveTab !== "defaults" ? "hidden" : ""}`}
    >
      <div class="mb-4">
        <h2 class="text-xl font-semibold">Default Settings</h2>
      </div>

      <div class="rounded-lg">
        <div class="space-y-6">
          <div>
            <UnitSlider
              projectId="defaults"
              name="defaultDueDateHours"
              label="Due date"
              value={initialDefaultDueDateHours}
              min={1}
              max={240}
              step={1}
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Default hours until due when creating new projects (1–240 hours)
            </p>
          </div>
          <div>
            <Button id="save-defaults-btn" type="button" variant="primary">
              <i class="bx bx-save mr-2"></i>
              Save Defaults
            </Button>
          </div>
        </div>
      </div>
    </div>

    <!-- Punchlist Templates Section -->
    <div
      id="section-punchlist"
      class={`template-section ${settingsActiveTab !== "punchlist" ? "hidden" : ""}`}
    >
      <div class="mb-6 overflow-x-auto">
        <TanStackDataTable
          id="punchlist-templates-tanstack"
          title="Punchlist Templates (TanStack)"
          description="Sortable view. Use table below for edit."
          data={punchlistTemplates.map((t: any) => ({
            id: t.id,
            title: t.title || "—",
            messagePreview: t.message ? String(t.message).slice(0, 60) + "…" : "—",
            meta: [t.enabled === false && "Disabled", t.internal && "Internal", t.markCompleted && "Auto-complete"].filter(Boolean).join(", ") || "—",
            order: String(t.orderIndex ?? 0),
          }))}
          columns={[
            { id: "title", accessorKey: "title", header: "Title", meta: { width: 25 } },
            { id: "messagePreview", accessorKey: "messagePreview", header: "Message", meta: { width: 45 } },
            { id: "meta", accessorKey: "meta", header: "Meta", meta: { width: 15 } },
            { id: "order", accessorKey: "order", header: "Order", meta: { width: 10 } },
          ]}
          getRowIdKey="id"
          emptyMessage="No punchlist templates."
          expandable={true}
          showDragHandle={true}
        />
      </div>
      <div class="overflow-x-auto rounded-lg bg-white shadow dark:bg-gray-900">
        <AccordionDataTable
          id="punchlist-templates"
          data={punchlistTemplates}
          getItemId={(t) => String(t.id)}
          slotIdPrefix="punchlist-slot"
          showCreateRow={true}
          createRowLabel="+ Add Punchlist Item"
          getCreateSlotId={() => "create"}
          triggerClass="template-accordion-trigger"
          detailClass="template-accordion-detail"
          slotClass="template-slot"
          chevronClass="template-chevron"
          detailRowIdPrefix="punchlist"
          emptyMessage='Use "Add Punchlist Item" above to create your first template.'
          getTriggerDataAttrs={(t) => ({ templateSlot: String(t.id), templateType: "punchlist" })}
          getDetailRowDataAttrs={(t) => ({ templateSlot: String(t.id), templateType: "punchlist" })}
          createRowDataAttrs={{ templateSlot: "create", templateType: "punchlist" }}
          createButtonId="add-punchlist-btn"
          columns={[
            { key: "title", label: "Title", getValue: (t) => t.title || "—", width: 25 },
            {
              key: "message",
              label: "Message",
              getValue: (t) => (t.message ? String(t.message).slice(0, 60) + "…" : "—"),
              cellClass: "max-w-64 truncate text-gray-500 dark:text-gray-400",
              width: 45,
            },
            {
              key: "meta",
              label: "Meta",
              getValue: (t) => {
                const badges = [];
                if (!t.enabled) badges.push("Disabled");
                if (t.internal) badges.push("Internal");
                if (t.markCompleted) badges.push("Auto-complete");
                return badges.length ? badges.join(", ") : "—";
              },
              cellClass: "whitespace-nowrap text-xs text-gray-500 dark:text-gray-400",
              width: 15,
            },
            { key: "order", label: "Order", getValue: (t) => String(t.orderIndex ?? 0), width: 10 },
          ]}
          actionsComponent={TemplateRowActions}
          actionsGetProps={(t) => ({ template: t })}
        />
      </div>
    </div>

    <!-- Discussion Templates Section -->
    <div
      id="section-discussion"
      class={`template-section ${settingsActiveTab !== "discussion" ? "hidden" : ""}`}
    >
      <div class="mb-6 overflow-x-auto">
        <TanStackDataTable
          id="discussion-templates-tanstack"
          title="Discussion Templates (TanStack)"
          description="Sortable view. Use table below for edit."
          data={discussionTemplates.map((t: any) => ({
            id: t.id,
            title: t.title || "—",
            messagePreview: t.message ? String(t.message).slice(0, 60) + "…" : "—",
            meta: [t.enabled === false && "Disabled", t.internal && "Internal", t.markCompleted && "Auto-complete"].filter(Boolean).join(", ") || "—",
            order: String(t.orderIndex ?? 0),
          }))}
          columns={[
            { id: "title", accessorKey: "title", header: "Title", meta: { width: 25 } },
            { id: "messagePreview", accessorKey: "messagePreview", header: "Message", meta: { width: 45 } },
            { id: "meta", accessorKey: "meta", header: "Meta", meta: { width: 15 } },
            { id: "order", accessorKey: "order", header: "Order", meta: { width: 10 } },
          ]}
          getRowIdKey="id"
          emptyMessage="No discussion templates."
          expandable={true}
          showDragHandle={true}
        />
      </div>
      <div class="overflow-x-auto rounded-lg bg-white shadow dark:bg-gray-900">
        <AccordionDataTable
          id="discussion-templates"
          data={discussionTemplates}
          getItemId={(t) => String(t.id)}
          slotIdPrefix="discussion-slot"
          showCreateRow={true}
          createRowLabel="+ Add Discussion Item"
          getCreateSlotId={() => "create"}
          triggerClass="template-accordion-trigger"
          detailClass="template-accordion-detail"
          slotClass="template-slot"
          chevronClass="template-chevron"
          detailRowIdPrefix="discussion"
          emptyMessage='Use "Add Discussion Item" above to create your first template.'
          getTriggerDataAttrs={(t) => ({ templateSlot: String(t.id), templateType: "discussion" })}
          getDetailRowDataAttrs={(t) => ({ templateSlot: String(t.id), templateType: "discussion" })}
          createRowDataAttrs={{ templateSlot: "create", templateType: "discussion" }}
          createButtonId="add-discussion-btn"
          columns={[
            { key: "title", label: "Title", getValue: (t) => t.title || "—", width: 25 },
            {
              key: "message",
              label: "Message",
              getValue: (t) => (t.message ? String(t.message).slice(0, 60) + "…" : "—"),
              cellClass: "max-w-64 truncate text-gray-500 dark:text-gray-400",
              width: 45,
            },
            {
              key: "meta",
              label: "Meta",
              getValue: (t) => {
                const badges = [];
                if (!t.enabled) badges.push("Disabled");
                if (t.internal) badges.push("Internal");
                if (t.markCompleted) badges.push("Auto-complete");
                return badges.length ? badges.join(", ") : "—";
              },
              cellClass: "whitespace-nowrap text-xs text-gray-500 dark:text-gray-400",
              width: 15,
            },
            { key: "order", label: "Order", getValue: (t) => String(t.orderIndex ?? 0), width: 10 },
          ]}
          actionsComponent={TemplateRowActions}
          actionsGetProps={(t) => ({ template: t })}
        />
      </div>
    </div>
  </div>

  <!-- Template editor form pool (moved into accordion slot by script) -->
  <div id="template-editor-form-pool" class="hidden">
    <div id="template-editor-form-container">
      <div class="p-5">
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="template-editor-title">
            Edit Template
          </h3>
          <CloseButton id="close-template-editor-btn" tooltipText="Close editor" position="top" />
        </div>
        <form id="template-form" class={globalFormClasses}>
          <input type="hidden" id="template-id" name="id" />
          <input type="hidden" id="template-type" name="type" />

          <div class="space-y-4">
            <div>
              <label for="template-title" class="mb-1 block text-sm font-medium">Title</label>
              <input
                type="text"
                id="template-title"
                name="title"
                required
                class={globalInputClasses}
                placeholder="Enter a descriptive title"
              />
            </div>

            <div>
              <label for="template-message" class="mb-1 block text-sm font-medium">Message</label>
              <textarea
                id="template-message"
                name="message"
                required
                rows="6"
                class={globalInputClasses}
                placeholder="Enter the template message. You can use placeholders like PROJECT_TITLE, CLIENT_NAME, PROJECT_ADDRESS (wrapped in double curly braces)."
              ></textarea>
              <p class="mt-1 text-xs text-gray-500">
                Supports HTML and placeholders: {`{{PROJECT_TITLE}}`}, {`{{CLIENT_NAME}}`}, {
                  `{{PROJECT_ADDRESS}}`
                }, {`{{RAILWAY_PUBLIC_DOMAIN}}`}, {`{{PROJECT_ID}}`}
              </p>
            </div>

            <div>
              <label for="template-order" class="mb-1 block text-sm font-medium">Order</label>
              <input
                type="number"
                id="template-order"
                name="orderIndex"
                required
                min="0"
                class={globalInputClasses}
                placeholder="0"
              />
            </div>

            <div class="flex items-center space-x-6">
              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="template-internal"
                  name="internal"
                  class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <span class="ml-2 text-sm">Internal Only (for discussions)</span>
              </label>

              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="template-completed"
                  name="markCompleted"
                  class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <span class="ml-2 text-sm">Mark as Completed</span>
              </label>

              <label class="flex items-center">
                <input
                  type="checkbox"
                  id="template-enabled"
                  name="enabled"
                  checked
                  class="rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <span class="ml-2 text-sm">Enabled</span>
              </label>
            </div>
          </div>

          <div class="mt-6 flex justify-end space-x-3">
            <button
              type="submit"
              class="rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700"
            >
              Save Template
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script define:vars={{ punchlistTemplates, discussionTemplates }}>
    const punchlist = punchlistTemplates || [];
    const discussion = discussionTemplates || [];
    const allTemplates = [...punchlist, ...discussion];

    const templateForm = document.getElementById("template-form");
    const formContainer = document.getElementById("template-editor-form-container");
    const formPool = document.getElementById("template-editor-form-pool");
    const editorTitle = document.getElementById("template-editor-title");
    const closeBtn = document.getElementById("close-template-editor-btn");

    let openSlotKey = null; // "punchlist-123" or "discussion-456" or "punchlist-create" etc.

    function getDetailRow(slotId, type) {
      const prefix = type === "punchlist" ? "punchlist" : "discussion";
      return document.getElementById(`${prefix}-detail-${slotId}`);
    }

    function getTriggerRow(slotId, type) {
      return document.querySelector(
        `tr.template-accordion-trigger[data-template-slot="${slotId}"][data-template-type="${type}"]`
      );
    }

    function closeEditor() {
      if (!openSlotKey) return;
      const [type, slotId] = openSlotKey.split("-", 2);
      const actualSlotId = openSlotKey.replace(/^punchlist-|^discussion-/, "");
      const detailRow = getDetailRow(actualSlotId, type);
      const triggerRow = getTriggerRow(actualSlotId, type);
      if (detailRow) {
        detailRow.classList.add("hidden");
        detailRow.setAttribute("aria-hidden", "true");
      }
      if (triggerRow) {
        triggerRow.setAttribute("aria-expanded", "false");
        const chevron = triggerRow.querySelector(".template-chevron");
        if (chevron) chevron.classList.remove("rotate-180");
      }
      if (formContainer && formPool) formPool.appendChild(formContainer);
      openSlotKey = null;
    }

    function openEditor(type, slotId, template) {
      const slotEl = document.getElementById(`${type}-slot-${slotId}`);
      if (!slotEl) return;
      closeEditor();
      if (formContainer) slotEl.appendChild(formContainer);
      openSlotKey = `${type}-${slotId}`;

      const form = templateForm;
      const typeInput = document.getElementById("template-type");
      if (typeInput) typeInput.value = type;

      if (template) {
        const idInp = document.getElementById("template-id");
        const titleInp = document.getElementById("template-title");
        const messageInp = document.getElementById("template-message");
        const orderInp = document.getElementById("template-order");
        const internalInp = document.getElementById("template-internal");
        const completedInp = document.getElementById("template-completed");
        const enabledInp = document.getElementById("template-enabled");
        if (idInp) idInp.value = String(template.id);
        if (titleInp) titleInp.value = template.title || "";
        if (messageInp && messageInp instanceof HTMLTextAreaElement) messageInp.value = template.message || "";
        if (orderInp) orderInp.value = String(template.orderIndex ?? 0);
        if (internalInp) internalInp.checked = !!template.internal;
        if (completedInp) completedInp.checked = !!template.markCompleted;
        if (enabledInp) enabledInp.checked = template.enabled !== false;
        if (editorTitle) editorTitle.textContent = "Edit Template";
      } else {
        form.reset();
        const typeInputEl = document.getElementById("template-type");
        if (typeInputEl) typeInputEl.value = type;
        const idInp = document.getElementById("template-id");
        if (idInp) idInp.value = "";
        if (editorTitle)
          editorTitle.textContent = `Add ${type === "punchlist" ? "Punchlist" : "Discussion"} Item`;
      }

      const detailRow = getDetailRow(slotId, type);
      const triggerRow = getTriggerRow(slotId, type);
      if (detailRow) {
        detailRow.classList.remove("hidden");
        detailRow.setAttribute("aria-hidden", "false");
      }
      if (triggerRow) {
        triggerRow.setAttribute("aria-expanded", "true");
        const chevron = triggerRow.querySelector(".template-chevron");
        if (chevron) chevron.classList.add("rotate-180");
      }
      detailRow?.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }

    document.addEventListener("DOMContentLoaded", () => {
      window.switchSettingsTab = (tab) => {
        const url = new URL(window.location.href);
        url.searchParams.set("tab", tab);
        window.history.replaceState({}, "", url.toString());
        document.querySelectorAll(".template-section").forEach((section) => {
          const sectionId = section.id.replace("section-", "");
          section.classList.toggle("hidden", sectionId !== tab);
        });
      };

      document.getElementById("save-defaults-btn")?.addEventListener("click", async () => {
        const slider = document.getElementById("defaultDueDateHours-slider-defaults");
        const hours = slider ? parseInt(slider.value, 10) : 72;
        try {
          const res = await fetch("/api/settings/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              settings: { projectDefaultDueDateHours: String(hours) },
            }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || "Failed to save defaults");
          }
          if (window.showSuccess) window.showSuccess("Defaults Saved", "Project defaults updated successfully", 4000);
        } catch (err) {
          console.error("Error saving defaults:", err);
          if (window.showError) window.showError("Save Failed", err instanceof Error ? err.message : "Failed to save defaults", 0);
        }
      });

      loadDefaults();

      closeBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        closeEditor();
      });

      document.getElementById("add-punchlist-btn")?.addEventListener("click", (e) => {
        e.preventDefault();
        openEditor("punchlist", "create", null);
      });
      document.getElementById("add-discussion-btn")?.addEventListener("click", (e) => {
        e.preventDefault();
        openEditor("discussion", "create", null);
      });

      templateForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const fd = new FormData(templateForm);
        const type = fd.get("type");
        const title = fd.get("title");
        const message = fd.get("message");
        if (!type || !title || !message) {
          if (window.showError) window.showError("Validation Error", "Please fill in title and message", 0);
          return;
        }
        const idVal = fd.get("id");
        const id = idVal && String(idVal).trim() ? parseInt(String(idVal)) || null : null;
        const data = {
          type: String(type).trim(),
          title: String(title).trim(),
          message: String(message).trim(),
          orderIndex: parseInt(String(fd.get("orderIndex"))) || 0,
          internal: fd.get("internal") === "on",
          markCompleted: fd.get("markCompleted") === "on",
          enabled: fd.get("enabled") === "on",
        };
        if (id != null && !isNaN(id)) data.id = id;

        try {
          const res = await fetch("/api/project-templates/upsert", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });
          const result = await res.json().catch(() => ({}));
          if (!res.ok) throw new Error(result.error || "Failed to save template");
          if (!result.success) throw new Error(result.error || "Failed to save template");
          if (window.showSuccess)
            window.showSuccess(
              data.id ? "Template Updated" : "Template Created",
              data.id ? "Template updated successfully" : "Template created successfully",
              4000
            );
          closeEditor();
          location.reload();
        } catch (err) {
          console.error("Error saving template:", err);
          if (window.showError) window.showError("Save Failed", err instanceof Error ? err.message : "Failed to save template", 0);
        }
      });

      document.querySelectorAll(".edit-template-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const id = btn.getAttribute("data-id");
          const type = btn.getAttribute("data-type");
          if (!id || !type) return;
          const t = allTemplates.find((x) => String(x.id) === id);
          if (t) openEditor(type, id, t);
        });
      });

      document.querySelectorAll("tr.template-accordion-trigger").forEach((triggerRow) => {
        triggerRow.addEventListener("click", (e) => {
          const tgt = e.target instanceof Element ? e.target : null;
          if (tgt?.closest(".edit-template-btn, .delete-confirm-btn, .delete-confirm-wrapper, .accordion-drag-handle")) return;
          const slotId = triggerRow.getAttribute("data-template-slot");
          const type = triggerRow.getAttribute("data-template-type");
          if (!slotId || !type) return;
          if (openSlotKey === `${type}-${slotId}`) {
            closeEditor();
            return;
          }
          if (slotId === "create") {
            openEditor(type, "create", null);
            return;
          }
          const t = allTemplates.find((x) => String(x.id) === slotId);
          openEditor(type, slotId, t || null);
        });
      });

      window.handleTemplateDeleted = async () => {
        if (window.showSuccess) window.showSuccess("Template Deleted", "Template deleted successfully", 4000);
        location.reload();
      };
    });

    async function loadDefaults() {
      try {
        const res = await fetch("/api/project-defaults/get");
        if (!res.ok) return;
        const data = await res.json();
        const hours = Math.min(240, Math.max(1, data.defaultDueDateHours || 72));
        const slider = document.getElementById("defaultDueDateHours-slider-defaults");
        const valueDisplay = document.getElementById("defaultDueDateHours-value-defaults");
        if (slider) slider.value = String(hours);
        if (valueDisplay) valueDisplay.textContent = String(hours);
      } catch (err) {
        console.error("Error loading defaults:", err);
      }
    }
  </script>

</LayoutDefault>
