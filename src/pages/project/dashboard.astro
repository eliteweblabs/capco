---
const requireAuthRedirect = "/auth/login";
import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);
const currentRole = currentUser?.profile?.role || "Client";

// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalCompanyData } from "../api/global/global-company-data.ts";
import { globalClasses } from "../api/global/global-classes.ts";
import App from "../../components/ui/App.astro";
import DashboardContent from "../../components/project/Dashboard.astro";
import "../../lib/refresh-manager.ts";
import type { Project } from "../../lib/api/_projects.ts";

// âš¡ OPTIMIZATION: Run all data fetches in PARALLEL
console.time("ğŸ—ï¸ [DASHBOARD] Total data fetch");

const [companyData, statusData, projectsData] = await Promise.all([
  // Fetch 1: Company data
  globalCompanyData().catch(err => {
    console.error("ğŸ—ï¸ [DASHBOARD] âŒ Company data fetch failed:", err);
    return { globalCompanyName: '', globalCompanySlogan: '', globalCompanyAddress: '', globalCompanyPhone: '', globalCompanyEmail: '', globalCompanyWebsite: '', globalCompanyLogo: '' };
  }),
  
  // Fetch 2: Status data
  fetch(new URL("/api/status/get", Astro.url.origin).toString(), {
    method: "GET",
    headers: { Cookie: Astro.request.headers.get("Cookie") || "" },
  })
    .then(r => {
      console.log(`ğŸ—ï¸ [DASHBOARD] Status API response: ${r.status}`);
      return r.json();
    })
    .then(d => {
      console.log(`ğŸ—ï¸ [DASHBOARD] Status data:`, d);
      return d.statuses || [];
    })
    .catch(err => {
      console.error("ğŸ—ï¸ [DASHBOARD] âŒ Status fetch failed:", err);
      return [];
    }),
  
  // Fetch 3: Projects (with timeout)
  (async () => {
    if (!currentUser?.id) {
      console.log("ğŸ—ï¸ [DASHBOARD] No user ID, skipping project fetch");
      return [];
    }
    
    try {
      const apiUrl = new URL("/api/projects/get", Astro.url.origin);
      if (currentRole === "Client") {
        apiUrl.searchParams.set("authorId", currentUser.id);
      }
      apiUrl.searchParams.set("limit", "50");
      
      console.log(`ğŸ—ï¸ [DASHBOARD] ğŸ“¡ Fetching projects from: ${apiUrl.toString()}`);
      
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s timeout
      
      const startTime = Date.now();
      const response = await fetch(apiUrl.toString(), {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
          Cookie: Astro.request.headers.get("Cookie") || "",
        },
        signal: controller.signal,
      });
      
      clearTimeout(timeoutId);
      const elapsed = Date.now() - startTime;
      
      console.log(`ğŸ—ï¸ [DASHBOARD] ğŸ“¦ Response status: ${response.status}, took ${elapsed}ms`);
      
      if (response.ok) {
        const data = await response.json();
        const projectCount = data.projects?.length || 0;
        console.log(`ğŸ—ï¸ [DASHBOARD] âœ… Successfully loaded ${projectCount} projects`);
        console.log(`ğŸ—ï¸ [DASHBOARD] ğŸ“‹ Response structure:`, Object.keys(data));
        console.log(`ğŸ—ï¸ [DASHBOARD] ğŸ“‹ Projects array type:`, Array.isArray(data.projects), 'length:', data.projects?.length);
        return data.projects || [];
      }
      
      console.error(`ğŸ—ï¸ [DASHBOARD] âŒ API returned error status: ${response.status}`);
      const errorText = await response.text();
      console.error(`ğŸ—ï¸ [DASHBOARD] âŒ Error response:`, errorText);
      return [];
    } catch (error) {
      if (error.name === 'AbortError') {
        console.error("ğŸ—ï¸ [DASHBOARD] â±ï¸  Request timeout after 5s - returning empty array");
      } else {
        console.error("ğŸ—ï¸ [DASHBOARD] âŒ Fetch error:", error);
      }
      return [];
    }
  })()
]);

console.timeEnd("ğŸ—ï¸ [DASHBOARD] Total data fetch");
console.log(`ğŸ—ï¸ [DASHBOARD] ğŸ¯ Final projectsData:`, Array.isArray(projectsData), 'length:', projectsData?.length);

const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
} = companyData;

const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();
const projects = projectsData;
---

<App
  title="Global Dashboard"
  description="View all projects."
  {currentUser}
  {session}
  {supabase}
  {projects}
  {globalCompanyName}
  {globalCompanySlogan}
  {primaryTextClasses}
  {secondaryTextClasses}
  {globalInputClasses}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
  {statusData}
  mainClasses="overflow-x-scroll"
>
  <DashboardContent
    projects={projects}
    statusData={statusData}
    currentUser={currentUser}
    globalInputClasses={globalInputClasses}
    secondaryTextClasses={secondaryTextClasses}
    primaryTextClasses={primaryTextClasses}
  />
</App>

<script>
  // Start the refresh manager with safe settings
  import { refreshManager } from "../../lib/refresh-manager";
  
  console.log("ğŸ”„ [DASHBOARD] Starting refresh manager with safe polling (30s interval)...");
  
  // Wait for DOM to be fully loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      console.log("ğŸ”„ [DASHBOARD] DOM loaded, initializing refresh manager");
      refreshManager.startAutoRefreshWithInterval(30); // Poll every 30 seconds
      console.log("ğŸ”„ [DASHBOARD] Refresh manager started:", refreshManager.getRefreshStats());
    });
  } else {
    console.log("ğŸ”„ [DASHBOARD] DOM already loaded, initializing refresh manager");
    refreshManager.startAutoRefreshWithInterval(30); // Poll every 30 seconds
    console.log("ğŸ”„ [DASHBOARD] Refresh manager started:", refreshManager.getRefreshStats());
  }
</script>
