---
const requireAuthRedirect = "/login";
import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);
const currentRole = currentUser?.profile?.role || "Client";

// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalCompanyData } from "../../pages/api/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  globalCompanyLogoDark,
  globalCompanyLogoLight,
} = globalCompanyData();

import { globalClasses } from "../../pages/api/global-classes";
const { globalInputClasses, globalPrimaryTextClasses, globalSecondaryTextClasses } =
  globalClasses();

import App from "../../components/common/App.astro";
import Button from "../../components/common/Button.astro";
import HeroDashboard from "../../components/common/HeroDashboard.astro";
import ProjectList from "../../components/project/ProjectList.astro";
import "../../lib/refresh-manager.ts";
// Get auth data directly since App component handles auth requirements

// console.log("üöÄ [DASHBOARD] Current user:", currentUser);
// Initialize data arrays
let projects: any[] = [];

// Fetch projects using the API endpoint that includes discussion counts
if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    let apiUrl = `${baseUrl}/api/get-project`;
    // Add assigned_to_id parameter for Staff role
    if (currentRole === "Client") {
      apiUrl += `?author_id=${currentUser.id}`;
    }

    const response = await fetch(apiUrl);

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
    } else {
      console.error(
        "üèóÔ∏è [DASHBOARD] Error fetching projects:",
        response.status,
        response.statusText
      );
    }
  } catch (error) {
    console.error("üèóÔ∏è [DASHBOARD] Error fetching projects:", error);
  }
}

// Fetch project statuses using the unified API
const statusApiUrl = new URL("/api/project-statuses", Astro.url.origin);
const statusResponse = await fetch(statusApiUrl.toString(), {
  method: "GET",
  headers: {
    Cookie: Astro.request.headers.get("Cookie") || "",
  },
});

const statusResponseData = await statusResponse.json();
const statusData = statusResponseData.statuses || [];
---

<App
  title="Global Dashboard - CAPCo Fire Protection"
  description="View all projects."
  currentUser={currentUser}
  session={session}
  supabase={supabase}
  projects={projects}
  globalCompanyName={globalCompanyName}
  globalCompanySlogan={globalCompanySlogan}
  globalPrimaryTextClasses={globalPrimaryTextClasses}
  globalSecondaryTextClasses={globalSecondaryTextClasses}
  globalInputClasses={globalInputClasses}
  globalCompanyAddress={globalCompanyAddress}
  globalCompanyPhone={globalCompanyPhone}
  globalCompanyEmail={globalCompanyEmail}
  globalCompanyWebsite={globalCompanyWebsite}
  globalCompanyLogo={globalCompanyLogo}
  globalCompanyLogoDark={globalCompanyLogoDark}
  globalCompanyLogoLight={globalCompanyLogoLight}
  statusData={statusData}
>
  <!-- Dashboard Container -->

  <HeroDashboard
    title="Project Dashboard"
    description={currentUser?.profile?.role === "Client"
      ? "Manage and track your fire protection projects"
      : "Manage and track all fire protection projects"}
    projectLength={projects.length}
  />

  <div class="relative col-span-full grow">
    <div class="pointer-events-none hidden cursor-not-allowed px-4">
      <div
        class="Q4KJqTa5GBaAJ29_u66A iHPddplqYvrN6qWgvntn pjVv_HvtzX_QkbymyvoG r2J0fZNC8R3xWtaYryk2 WoD2LAJAK2GcVVCqX8Re grid w-full items-center"
      >
        <div class="relative">
          <div
            class="pointer-events-none absolute left-3 top-1/2 flex -translate-y-1/2 items-center"
          >
            <svg
              class="_o2IXcpM0qnG3JPReKus E9GV5sZJIbfO_GEQ_moc PeR2JZ9BZHYIH8Ea3F36 XIIs8ZOri3wm8Wnj9N_y"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-width="2"
                d="m21 21-3.5-3.5M17 10a7 7 0 1 1-14 0 7 7 0 0 1 14 0Z"></path>
            </svg>
          </div>
          <input
            type="text"
            name="email"
            id="topbar-search"
            class="_Vb9igHms0hI1PQcvp_S pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk FJRldeiG2gFGZfuKgp88 nbfkCvNleKWN7Pz3_DQF c8dCx6gnV43hTOLV6ks5 LceKfSImrGKQrtDGkpBV GdTcGtoKP5_bET3syLDl B6xjPKbspU6m_EWVKPv2 q6szSHqGtBufkToFe_s5 KpCMWe32PQyrSFbZVput w-full rounded-lg bg-gray-50 text-gray-900 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
            placeholder="Search for projects"
          />
        </div>
        <select
          class="_Vb9igHms0hI1PQcvp_S pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk St_AVDyTHE88JaawJoRQ c8dCx6gnV43hTOLV6ks5 LceKfSImrGKQrtDGkpBV GdTcGtoKP5_bET3syLDl B6xjPKbspU6m_EWVKPv2 q6szSHqGtBufkToFe_s5 KpCMWe32PQyrSFbZVput w-full rounded-lg bg-gray-50 py-2 text-gray-900 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
        >
          <option selected="">Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <select
          class="_Vb9igHms0hI1PQcvp_S pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk St_AVDyTHE88JaawJoRQ c8dCx6gnV43hTOLV6ks5 LceKfSImrGKQrtDGkpBV GdTcGtoKP5_bET3syLDl B6xjPKbspU6m_EWVKPv2 q6szSHqGtBufkToFe_s5 KpCMWe32PQyrSFbZVput w-full rounded-lg bg-gray-50 py-2 text-gray-900 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
        >
          <option selected="">Number of users</option>
          <option value="1">1</option>
          <option value="5">1-5</option>
          <option value="10">5-10</option>
          <option value="20">10-20</option>
        </select>
        <select
          class="_Vb9igHms0hI1PQcvp_S pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk St_AVDyTHE88JaawJoRQ c8dCx6gnV43hTOLV6ks5 LceKfSImrGKQrtDGkpBV GdTcGtoKP5_bET3syLDl B6xjPKbspU6m_EWVKPv2 q6szSHqGtBufkToFe_s5 KpCMWe32PQyrSFbZVput w-full rounded-lg bg-gray-50 py-2 text-gray-900 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
        >
          <option selected="">Progress</option>
          <option value="done">Done</option>
          <option value="almost-done">Almost done</option>
          <option value="half-done">Half done</option>
          <option value="just-started">Just started</option>
        </select>
        <select
          class="_Vb9igHms0hI1PQcvp_S pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk St_AVDyTHE88JaawJoRQ c8dCx6gnV43hTOLV6ks5 LceKfSImrGKQrtDGkpBV GdTcGtoKP5_bET3syLDl B6xjPKbspU6m_EWVKPv2 q6szSHqGtBufkToFe_s5 KpCMWe32PQyrSFbZVput qUv3T3lLZRia_k_hbmQj w-full rounded-lg bg-gray-50 py-2 text-gray-900 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
        >
          <option selected="">Preview link</option>
          <option value="yes">Yes</option>
          <option value="no">No</option>
        </select>
        <select
          class="_Vb9igHms0hI1PQcvp_S pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk St_AVDyTHE88JaawJoRQ c8dCx6gnV43hTOLV6ks5 LceKfSImrGKQrtDGkpBV GdTcGtoKP5_bET3syLDl B6xjPKbspU6m_EWVKPv2 q6szSHqGtBufkToFe_s5 KpCMWe32PQyrSFbZVput qUv3T3lLZRia_k_hbmQj w-full rounded-lg bg-gray-50 py-2 text-gray-900 dark:border-gray-600 dark:bg-gray-800 dark:text-white"
        >
          <option selected="">Due date</option>
          <option value="day">This day</option>
          <option value="week">This week</option>
          <option value="month">This month</option>
        </select>
      </div>
      <div
        class="_Vb9igHms0hI1PQcvp_S w-full items-center justify-between border-t py-3 dark:border-gray-800 md:flex"
      >
        <div class="hP1M5IgfjJiY8_B1VUN1 iHPddplqYvrN6qWgvntn flex">
          <div
            class="c8dCx6gnV43hTOLV6ks5 flex items-center font-medium text-gray-900 dark:text-white"
          >
            Show:
          </div>
          <div class="flex items-center">
            <input
              id="all-users"
              type="radio"
              value=""
              name="show-only"
              checked=""
              class="h-4 w-4 w-full border-gray-300 bg-gray-100 focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-700"
            />
            <label
              for="all-users"
              class="t1I6QaLqvCmfaYJcpWU_ c8dCx6gnV43hTOLV6ks5 EJIoL6514Ry8r7nh011L font-medium text-gray-900"
              >All</label
            >
          </div>
          <div class="flex items-center">
            <input
              id="sort-role"
              type="radio"
              value=""
              name="show-only"
              class="h-4 w-4 w-full border-gray-300 bg-gray-100 focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-700"
            />
            <label
              for="sort-role"
              class="t1I6QaLqvCmfaYJcpWU_ c8dCx6gnV43hTOLV6ks5 EJIoL6514Ry8r7nh011L font-medium text-gray-900"
              >Completed</label
            >
          </div>
          <div class="flex items-center">
            <input
              id="sort-type"
              type="radio"
              value=""
              name="show-only"
              class="h-4 w-4 w-full border-gray-300 bg-gray-100 focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-700"
            />
            <label
              for="sort-type"
              class="t1I6QaLqvCmfaYJcpWU_ c8dCx6gnV43hTOLV6ks5 EJIoL6514Ry8r7nh011L font-medium text-gray-900"
              >In progress</label
            >
          </div>
          <div class="flex items-center">
            <input
              id="sort-status"
              type="radio"
              value=""
              name="show-only"
              class="h-4 w-4 w-full border-gray-300 bg-gray-100 focus:ring-2 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-700"
            />
            <label
              for="sort-status"
              class="t1I6QaLqvCmfaYJcpWU_ c8dCx6gnV43hTOLV6ks5 EJIoL6514Ry8r7nh011L font-medium text-gray-900"
              >In review</label
            >
          </div>
        </div>
        <div class="GgdULYVy8kzBUcQdiu8d items-center">
          <button
            id="actionsDropdownButton"
            data-dropdown-toggle="actionsDropdown"
            class="pXhVRBC8yaUNllmIWxln _Cj_M6jt2eLjDgkBBNgI c8dCx6gnV43hTOLV6ks5 YXx9oZ15oLXSCG32YPBT xKUZEM163cLLvNnDh2ZN BkIbg_JwkgiyRW804Hhu _dylIDxYTN3qgvD4U597 XGQIxPVjm_m7D0aLHB7Y XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW icxWjIgUd9_dzYucx1nx flex w-full items-center justify-center rounded-lg border-gray-200 bg-gray-100 py-2 font-medium text-gray-900 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800 dark:focus:ring-gray-700"
            type="button"
          >
            Actions
            <svg
              class="cZGr4DL6HOaMXQmjciUj gtlIjUq8I0xb1BZjyfWO _o2IXcpM0qnG3JPReKus E9GV5sZJIbfO_GEQ_moc"
              aria-hidden="true"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
            >
              <path
                stroke="currentColor"
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="m19 9-7 7-7-7"></path>
            </svg>
          </button>
          <div
            id="actionsDropdown"
            class="QhmQ_v3mmDFIP9VaVOfb fScvmu_bLBCkoXb3Xml3 hidden divide-y divide-gray-100 rounded-lg bg-gray-100 shadow-sm dark:divide-gray-600 dark:bg-gray-700"
            data-popper-placement="bottom"
            style="position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(1058.5px, 273px, 0px);"
          >
            <ul
              class="FJRldeiG2gFGZfuKgp88 c8dCx6gnV43hTOLV6ks5 PeR2JZ9BZHYIH8Ea3F36 XIIs8ZOri3wm8Wnj9N_y font-medium"
              aria-labelledby="actionsDropdownButton"
            >
              <li>
                <a
                  href="#"
                  class="_k0lTW0vvzboctTxDi2R W5n_NSFnC6y2nqoHw_5x _Cj_M6jt2eLjDgkBBNgI ZnBoTVi7VOJdCLSSU62n RzANcaqunVvlLrO6_tal dMTOiA3mf3FTjlHu6DqW w-full items-center py-2 hover:bg-gray-100"
                  >Suspend all</a
                >
              </li>
              <li>
                <!-- <button
                    type="button"
                    id="deleteAllProjectsModalButton"
                    data-modal-target="deleteAllProjectsModal"
                    data-modal-toggle="deleteAllProjectsModal"
                    class="_k0lTW0vvzboctTxDi2R w-full items-center W5n_NSFnC6y2nqoHw_5x _Cj_M6jt2eLjDgkBBNgI py-2 m_WzesDEb91pTPmX64rt hover:bg-gray-100 Sz97zU8r72z_pjE9zQnR RzANcaqunVvlLrO6_tal"
                  >
                    Delete all
                  </button> -->
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="_IebywwKB6L2zG0BTy63 relative">
      {
        projects && projects.length > 0 ? (
          <ProjectList projects={projects} statusData={statusData} currentUser={currentUser} />
        ) : (
          // <!-- No projects - show only form -->

          <div class="mx-auto flex h-[60dvh] max-w-2xl items-center justify-center px-4 pb-6 pt-4">
            <div class="inset-0 mx-auto flex max-w-2xl items-center justify-center pb-6">
              <Button
                href="/project/new"
                variant="primary"
                size="lg"
                icon="plus"
                iconPosition="left"
                class="w-full"
              >
                New Project
              </Button>
            </div>
          </div>
        )
      }
    </div>
    <div class="w-full">
      <!-- Table Footer -->
      <div class="pointer-events-none relative hidden cursor-not-allowed overflow-hidden">
        <nav
          class="e8VqoQNK0mbkRFDL3LMV _7_AEkSp_Gi6KH9ZW6st tI6ZVpHcCWxY_MKHSQWC tuEYdQFQ7IyWJ8f7A6Ss eVEHKvmQTgrcFfcnBoRJ flex justify-between p-4 md:items-center"
          aria-label="Table navigation"
        >
          <span
            class="c8dCx6gnV43hTOLV6ks5 _43MO1gcdi2Y0RJW1uHL PeR2JZ9BZHYIH8Ea3F36 XIIs8ZOri3wm8Wnj9N_y"
            >Showing <span class="yM_AorRf2jSON3pDsdrz text-gray-900 dark:text-white">1-15</span> of
            <span class="yM_AorRf2jSON3pDsdrz text-gray-900 dark:text-white">146</span></span
          >
          <ul class="_k0lTW0vvzboctTxDi2R RL7uPEoqj_KRubJO6Kau EVsptO6LmMeSj8z3lntE">
            <li>
              <a
                href="#"
                class="CoXBDf_LlsdMbiNfGE67 h-100 Zbcg0Bjzm_C_64FAwnE3 pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk _Cj_M6jt2eLjDgkBBNgI Qkdk47eO_FsOcXfaC9zb PeR2JZ9BZHYIH8Ea3F36 n2xFO60c4M2k5KjGtElq XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW flex items-center justify-center bg-gray-100 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
              >
                <span class="sr-only">Previous</span>
                <svg
                  class="rxe6apEJoEk8r75xaVNG ADSeKHR1DvUUA48Chci_"
                  aria-hidden="true"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                    clip-rule="evenodd"></path>
                </svg>
              </a>
            </li>
            <li>
              <a
                href="#"
                class="pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk _Cj_M6jt2eLjDgkBBNgI c8dCx6gnV43hTOLV6ks5 OXyBmUnmaFHYN14c7Giu PeR2JZ9BZHYIH8Ea3F36 n2xFO60c4M2k5KjGtElq XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW flex items-center justify-center bg-gray-100 py-2 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
              >
                1
              </a>
            </li>
            <li>
              <a
                href="#"
                class="pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk _Cj_M6jt2eLjDgkBBNgI c8dCx6gnV43hTOLV6ks5 OXyBmUnmaFHYN14c7Giu PeR2JZ9BZHYIH8Ea3F36 n2xFO60c4M2k5KjGtElq XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW flex items-center justify-center bg-gray-100 py-2 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
              >
                2
              </a>
            </li>
            <li>
              <a
                href="#"
                aria-current="page"
                class="QhmQ_v3mmDFIP9VaVOfb pXhVRBC8yaUNllmIWxln XQGFRdlxLbhbEMzeaRuO OHD_pMp_ehzJj42EmDyF _Cj_M6jt2eLjDgkBBNgI c8dCx6gnV43hTOLV6ks5 OXyBmUnmaFHYN14c7Giu _6MyV8SXoSWq_PQ6KWI6 M7HoUYpjoEdw_y87xeWn YXx9oZ15oLXSCG32YPBT flex items-center justify-center py-2 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              >
                3
              </a>
            </li>
            <li>
              <a
                href="#"
                class="pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk _Cj_M6jt2eLjDgkBBNgI c8dCx6gnV43hTOLV6ks5 OXyBmUnmaFHYN14c7Giu PeR2JZ9BZHYIH8Ea3F36 n2xFO60c4M2k5KjGtElq XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW flex items-center justify-center bg-gray-100 py-2 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
              >
                ...
              </a>
            </li>
            <li>
              <a
                href="#"
                class="pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk _Cj_M6jt2eLjDgkBBNgI c8dCx6gnV43hTOLV6ks5 OXyBmUnmaFHYN14c7Giu PeR2JZ9BZHYIH8Ea3F36 n2xFO60c4M2k5KjGtElq XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW flex items-center justify-center bg-gray-100 py-2 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
              >
                10
              </a>
            </li>
            <li>
              <a
                href="#"
                class="h-100 _McrmMbFrEkc_sTK9IC8 pXhVRBC8yaUNllmIWxln vpDN1VEJLu5FmLkr5WCk _Cj_M6jt2eLjDgkBBNgI Qkdk47eO_FsOcXfaC9zb OXyBmUnmaFHYN14c7Giu PeR2JZ9BZHYIH8Ea3F36 n2xFO60c4M2k5KjGtElq XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX dMTOiA3mf3FTjlHu6DqW flex items-center justify-center bg-gray-100 hover:bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
              >
                <span class="sr-only">Next</span>
                <svg
                  class="rxe6apEJoEk8r75xaVNG ADSeKHR1DvUUA48Chci_"
                  aria-hidden="true"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                    clip-rule="evenodd"></path>
                </svg>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </div>
  </div>
</App>

<!-- </SectionContainer> -->
