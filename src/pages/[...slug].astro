---
/**
 * Catch-all page router – Block pages first, then template CMS (cmsPages/MarkdownPage).
 * 1. If a block page exists for the slug → render BlockPageView.
 * 2. Else if template page exists (getPageContent) → render MarkdownPage.
 * 3. Else → 404.
 * OAuth callback and path exclusions preserved.
 */

// OAuth callback: if provider redirected to / with ?code=, redirect to API before any rendering
const oauthCode = Astro.url.searchParams.get("code");
if (oauthCode) {
  const query = Astro.url.search || `?code=${encodeURIComponent(oauthCode)}`;
  return Astro.redirect(`/api/auth/callback${query}`);
}

import { checkAuth } from "../lib/auth";
import { getBlockPageContent } from "../lib/content-blocks";
import { getPageContent } from "../lib/content";
import BlockPageView from "../components/cms/BlockPageView.astro";
import MarkdownPage from "../components/common/MarkdownPage.astro";

const { currentUser, session, supabase } = await checkAuth(Astro.cookies);

const { slug } = Astro.params;
const pageSlug = slug || "home";

const excludedPaths = ["scripts/", "api/", "_astro/", "assets/", "public/", ".js", ".ts", ".css", ".map"];
const staticExtensions = [".svg", ".ico", ".png", ".jpg", ".jpeg", ".gif", ".webp", ".woff", ".woff2", ".ttf", ".eot"];

if (staticExtensions.some((ext) => pageSlug.toLowerCase().endsWith(ext))) {
  return new Response(null, { status: 404 });
}
if (pageSlug === "_astro" || pageSlug.startsWith("_astro/")) {
  return new Response(null, { status: 404 });
}
if (excludedPaths.some((path) => pageSlug.includes(path))) {
  return new Response(null, { status: 404 });
}

const blockPageContent = await getBlockPageContent(pageSlug);
const templatePageContent = blockPageContent ? null : await getPageContent(pageSlug);

if (!blockPageContent && !templatePageContent) {
  return Astro.redirect("/404");
}
---

{blockPageContent ? (
  <BlockPageView
    pageContent={blockPageContent}
    currentUser={currentUser}
    session={session}
    supabase={supabase}
  />
) : templatePageContent ? (
  <MarkdownPage
    slug={pageSlug}
    pageContent={templatePageContent}
    currentUser={currentUser}
    session={session}
    supabase={supabase}
  />
) : null}
