---
import LayoutDefault from "../components/layouts/LayoutDefault.astro";
import MultiStepForm from "../components/form/MultiStepForm.astro";
import { mepFormConfig } from "../lib/forms/mep-form-config";
import { supabase } from "../lib/supabase";
import App from "../components/ui/App.astro";

const title = "MEP Project Submission";
const description = "Submit your MEP (Mechanical, Electrical, Plumbing) project information";

// Check authentication from cookies since middleware doesn't run on this route
let user = Astro.locals.user; // Try middleware first
let isAuthenticated = !!user;

// If no user from middleware, check cookies directly
if (!user) {
  const accessToken = Astro.cookies.get("sb-access-token");
  const refreshToken = Astro.cookies.get("sb-refresh-token");

  if (accessToken && refreshToken && supabase) {
    const { data, error } = await supabase.auth.setSession({
      access_token: accessToken.value,
      refresh_token: refreshToken.value,
    });

    if (!error && data.user) {
      user = data.user;
      isAuthenticated = true;
      console.log("[MEP-FORM] User authenticated via cookies:", user.email);
    }
  }
}

// Pre-fill user data if authenticated
const initialData =
  isAuthenticated && user
    ? {
        email: user.email,
        firstName:
          user.user_metadata?.firstName || user.user_metadata?.full_name?.split(" ")[0] || "",
        lastName:
          user.user_metadata?.lastName || user.user_metadata?.full_name?.split(" ")[1] || "",
        phone: user.user_metadata?.phone || user.phone || "",
        isAuthenticated: true,
      }
    : {
        isAuthenticated: false,
      };
---

<App centerContent={true} mask="center" {title} {description}>
  <MultiStepForm
    config={mepFormConfig}
    {initialData}
    containerClass="w-full max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg xl:max-w-xl 2xl:max-w-2xl 3xl:max-w-3xl 4xl:max-w-4xl 5xl:max-w-5xl 6xl:max-w-6xl 7xl:max-w-7xl mx-auto"
  />
</App>
