---
import LayoutDefault from "../components/layouts/LayoutDefault.astro";
import MultiStepForm from "../components/form/MultiStepForm.astro";
import { mepFormConfig } from "../lib/forms/mep-form-config";
import { supabase } from "../lib/supabase";

const title = "MEP Project Submission";
const description = "Submit your MEP (Mechanical, Electrical, Plumbing) project information";

// Check authentication from cookies since middleware doesn't run on this route
let user = Astro.locals.user; // Try middleware first
let isAuthenticated = !!user;

// If no user from middleware, check cookies directly
if (!user) {
  const accessToken = Astro.cookies.get("sb-access-token");
  const refreshToken = Astro.cookies.get("sb-refresh-token");

  if (accessToken && refreshToken && supabase) {
    const { data, error } = await supabase.auth.setSession({
      access_token: accessToken.value,
      refresh_token: refreshToken.value,
    });

    if (!error && data.user) {
      user = data.user;
      isAuthenticated = true;
      console.log("[MEP-FORM] User authenticated via cookies:", user.email);
    }
  }
}

// Pre-fill user data if authenticated
const initialData =
  isAuthenticated && user
    ? {
        email: user.email,
        firstName:
          user.user_metadata?.firstName || user.user_metadata?.full_name?.split(" ")[0] || "",
        lastName:
          user.user_metadata?.lastName || user.user_metadata?.full_name?.split(" ")[1] || "",
        phone: user.user_metadata?.phone || user.phone || "",
        isAuthenticated: true,
      }
    : {
        isAuthenticated: false,
      };
---

<LayoutDefault {title} {description}>
  <main class="container mx-auto px-4 py-16">
    <div class="mx-auto max-w-2xl">
      <div class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-gray-900 dark:text-white mb-2">MEP Project</h1>
        <p class="text-lg text-gray-600 dark:text-gray-400">
          {description}
        </p>
        {
          isAuthenticated && (
            <p class="mt-2 text-sm text-primary-600 dark:text-primary-400">
              Logged in as {user.email}
            </p>
          )
        }
      </div>

      <MultiStepForm config={mepFormConfig} {initialData} />
    </div>
  </main>
</LayoutDefault>
