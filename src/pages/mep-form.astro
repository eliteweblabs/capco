---
import LayoutDefault from "../components/layouts/LayoutDefault.astro";
import MultiStepForm from "../components/form/MultiStepForm.astro";
import { getMepFormConfig } from "../lib/forms/mep-form-config";
import App from "../components/ui/App.astro";

const title = "MEP Project Submission";
const description = "Submit your MEP (Mechanical, Electrical, Plumbing) project information";

// Session and company data are set in middleware for this route (sessionOptionalRoutes) to avoid top-level await
const user = Astro.locals.user;
const isAuthenticated = !!user;
const globalCompanyName = (Astro.locals as any).globalCompanyName ?? "Company";
const virtualAssistantName = (Astro.locals as any).virtualAssistantName;
const mepFormConfig = getMepFormConfig(globalCompanyName, virtualAssistantName);

// Pre-fill user data if authenticated
const initialData =
  isAuthenticated && user
    ? {
        email: user.email,
        firstName:
          user.user_metadata?.firstName || user.user_metadata?.full_name?.split(" ")[0] || "",
        lastName:
          user.user_metadata?.lastName || user.user_metadata?.full_name?.split(" ")[1] || "",
        phone: user.user_metadata?.phone || user.phone || "",
        isAuthenticated: true,
      }
    : {
        isAuthenticated: false,
      };
---

<App layout="centered" mask="center" {title} {description}>
  <div class="px-8 md:px-12 lg:px-16 xl:px-20">
    <MultiStepForm config={mepFormConfig} {initialData} />
  </div>
</App>
