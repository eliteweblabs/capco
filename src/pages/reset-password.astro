---
import Base from "../layout/Base.astro";
import SectionContainer from "../components/common/SectionContainer.astro";
import BoxIcon from "../components/common/BoxIcon.astro";

// Check if user is already authenticated
import { checkAuth } from "../lib/auth";
const { isAuth } = await checkAuth(Astro.cookies);

if (isAuth) {
  return Astro.redirect("/dashboard");
}
---

<Base
  title="Reset Password - CAPCo Fire Protection"
  description="Reset your password to access your fire protection project management dashboard."
>
  <SectionContainer class="px-6 py-16">
    <div class="mx-auto max-w-md">
      <div class="text-center mb-8">
        <div class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-900/30">
          <BoxIcon name="lock" class="h-6 w-6 text-blue-600 dark:text-blue-400" />
        </div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Reset Your Password</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-300">
          Enter your new password below
        </p>
      </div>

      <div class="rounded-lg bg-white p-6 shadow-sm dark:bg-gray-800">
        <form id="reset-password-form" class="space-y-4">
          <div>
            <label for="new-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              New Password
            </label>
            <input
              type="password"
              id="new-password"
              name="password"
              required
              minlength="6"
              class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-60 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400"
              placeholder="Enter your new password"
            />
          </div>

          <div>
            <label for="confirm-password" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">
              Confirm New Password
            </label>
            <input
              type="password"
              id="confirm-password"
              name="confirmPassword"
              required
              minlength="6"
              class="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-60 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400"
              placeholder="Confirm your new password"
            />
          </div>

          <button
            type="submit"
            id="reset-password-btn"
            class="w-full rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50"
          >
            Reset Password
          </button>
        </form>

        <div class="mt-4 text-center">
          <a
            href="/login"
            class="text-sm text-blue-600 hover:text-blue-700 underline dark:text-blue-400 dark:hover:text-blue-300"
          >
            Back to Login
          </a>
        </div>
      </div>
    </div>
  </SectionContainer>
</Base>

<script>
  import { globalServices } from "../lib/global-services";

  document.addEventListener("DOMContentLoaded", () => {
    const resetPasswordForm = document.getElementById("reset-password-form") as HTMLFormElement;
    const newPasswordInput = document.getElementById("new-password") as HTMLInputElement;
    const confirmPasswordInput = document.getElementById("confirm-password") as HTMLInputElement;
    const resetPasswordBtn = document.getElementById("reset-password-btn") as HTMLButtonElement;

    resetPasswordForm?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const newPassword = newPasswordInput?.value;
      const confirmPassword = confirmPasswordInput?.value;

      // Validation
      if (!newPassword || !confirmPassword) {
        globalServices.showNotification({
          type: "error",
          title: "Validation Error",
          message: "Please fill in all fields.",
          duration: 5000,
        });
        return;
      }

      if (newPassword.length < 6) {
        globalServices.showNotification({
          type: "error",
          title: "Validation Error",
          message: "Password must be at least 6 characters long.",
          duration: 5000,
        });
        return;
      }

      if (newPassword !== confirmPassword) {
        globalServices.showNotification({
          type: "error",
          title: "Validation Error",
          message: "Passwords do not match.",
          duration: 5000,
        });
        return;
      }

      // Disable button and show loading state
      resetPasswordBtn.disabled = true;
      resetPasswordBtn.textContent = "Resetting...";

      try {
        // Get the access token from URL hash (Supabase magic link format)
        const hash = window.location.hash;
        const params = new URLSearchParams(hash.substring(1));
        const accessToken = params.get("access_token");
        const refreshToken = params.get("refresh_token");

        if (!accessToken) {
          throw new Error("No access token found in URL");
        }

        // Update password using Supabase
        const response = await fetch("/api/auth/reset-password", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            password: newPassword,
            accessToken,
            refreshToken,
          }),
        });

        const result = await response.json();

        if (response.ok) {
          globalServices.showNotification({
            type: "success",
            title: "Password Reset Successfully",
            message: "Your password has been updated. You will be redirected to the dashboard.",
            duration: 5000,
          });

          // Redirect to dashboard after a short delay
          setTimeout(() => {
            window.location.href = "/dashboard";
          }, 2000);
        } else {
          globalServices.showNotification({
            type: "error",
            title: "Reset Failed",
            message: result.error || "Failed to reset password. Please try again.",
            duration: 5000,
          });
        }
      } catch (error) {
        console.error("Reset password error:", error);
        globalServices.showNotification({
          type: "error",
          title: "Error",
          message: "Failed to reset password. Please check your link and try again.",
          duration: 5000,
        });
      } finally {
        // Re-enable button
        resetPasswordBtn.disabled = false;
        resetPasswordBtn.textContent = "Reset Password";
      }
    });
  });
</script>
