---
const requireAuthRedirect = "/auth/login";
import { checkAuth } from "../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);

// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalCompanyData } from "./api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
} = await globalCompanyData();

import { globalClasses } from "./api/global/global-classes";
import Tooltip from "../components/common/TooltipFloating.astro";
import Hero from "../components/common/Hero.astro";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import App from "../components/ui/App.astro";
import { getCarrierKeyFromGateway } from "../lib/sms-utils";
import SimpleIcon from "../components/common/SimpleIcon.astro";
import Footer from "../components/ui/Footer.astro";
import PhoneAndSMS from "../components/form/PhoneAndSMS.astro";
import SocialMediaRepeater from "../components/form/SocialMediaRepeater.astro";
import ProfileTeamSection from "../components/profile/ProfileTeamSection.astro";
import Button from "../components/common/Button.astro";
import { supabaseAdmin } from "../lib/supabase-admin";

const userProfile = currentUser?.profile || null;

// Fetch team members (profiles with teamMember = true)
let teamMembers: Array<{ id: string; name: string; role?: string; avatarUrl?: string | null }> = [];
if (supabaseAdmin) {
  const { data } = await supabaseAdmin
    .from("profiles")
    .select("id, firstName, lastName, role, avatarUrl")
    .eq("teamMember", true)
    .order("firstName", { ascending: true });
  teamMembers = (data || []).map((p) => ({
    id: p.id,
    name: [p.firstName, p.lastName].filter(Boolean).join(" ") || "Unknown",
    role: p.role || undefined,
    avatarUrl: p.avatarUrl || null,
  }));
}

// Get the carrier key from the stored gateway domain
const storedCarrierKey = userProfile?.mobileCarrier
  ? getCarrierKeyFromGateway(userProfile.mobileCarrier)
  : null;
---

<App
  title="User Profile"
  description="Manage your account information and preferences"
  {currentUser}
  session={session || undefined}
  project={undefined}
  {supabase}
  {globalCompanyName}
  {globalCompanySlogan}
  {primaryTextClasses}
  {secondaryTextClasses}
  {globalInputClasses}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
>
  <Hero
    title={`${userProfile?.companyName || userProfile?.firstName || "User"}'s Profile`}
    description="Manage your account information and preferences"
    primaryTextClasses="text-3xl font-bold text-gray-900 dark:text-white"
    secondaryTextClasses="text-gray-600 dark:text-gray-300"
    globalInputClasses="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"
  />
  <div class="XXbg-gray-100 XXshadow-sm XXmd:p-6 p-4">
    <div class="mx-auto max-w-2xl">
      <!-- Header -->

      <!-- Profile Form -->
      <form id="profile-form" class="space-y-6">
        <!-- Profile Picture Section -->
        <div class="text-center">
          <div
            class="mx-auto mb-4 flex h-20 w-20 items-center justify-center overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-700"
          >
            <img
              id="profile-avatar"
              src={userProfile?.avatarUrl || ""}
              alt="Profile picture"
              class="h-20 w-20 rounded-lg object-cover"
              onerror="this.style.display='none'; const n=this.nextElementSibling; if(n) n.style.display='flex';"
            />
            <SimpleIcon
              id="profile-avatar-fallback"
              name="user"
              style={userProfile?.avatarUrl ? "display:none;" : ""}
              class="h-10 w-10 text-gray-400"
            />
          </div>
          <div class="flex items-center justify-center gap-2">
            <Button
              type="button"
              id="upload-avatar-btn"
              variant="link"
              size="sm"
              class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300"
            >
              Upload Photo
            </Button>
            <Button
              type="button"
              id="remove-avatar-btn"
              variant="link"
              size="sm"
              class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
              style={userProfile?.avatarUrl ? "" : "display: none;"}
            >
              Remove
            </Button>
          </div>
          <input type="file" id="avatar-input" accept="image/*" class="hidden" />
        </div>

        <!-- Company Name Field -->
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-1">
          <div class="relative">
            <label
              for="company-name"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Company Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="company-name"
              name="company-name"
              required
              value={userProfile?.companyName || ""}
              class=`${globalInputClasses}`
              placeholder="Enter your company name"
            />
          </div>
        </div>

        <!-- First Name and Last Name Fields -->
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
          <div class="relative">
            <label
              for="first-name"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              First Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="first-name"
              name="firstName"
              value={userProfile?.firstName || ""}
              required
              class=`${globalInputClasses}`
              placeholder="Enter your first name"
            />
          </div>
          <div class="relative">
            <label
              for="last-name"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Last Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="last-name"
              name="lastName"
              value={userProfile?.lastName || ""}
              required
              class=`${globalInputClasses}`
              placeholder="Enter your last name"
            />
          </div>
        </div>

        <!-- Email Field (Read-only) -->
        <div class="grid grid-cols-1 gap-4 lg:grid-cols-1">
          <div class="relative">
            <label
              for="email"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Email Address <span class="text-red-500">*</span>
            </label>
            <div class="relative">
              <input
                type="email"
                id="email"
                name="email"
                required
                value={currentUser?.email || ""}
                readonly
                class=`${globalInputClasses}`
                placeholder="Enter email address"
              />
              <div class="absolute right-3 top-1/2 -translate-y-1/2">
                <Tooltip text={`Call ${globalCompanyPhone} to change email`} position="top">
                  <SimpleIcon id="email-lock-icon" name="lock" />
                </Tooltip>
              </div>
            </div>
          </div>
        </div>

        <!-- Social Media -->
        <div class="relative">
          <label class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">
            Social Media
          </label>
          <SocialMediaRepeater
            id="profile-socials"
            name="socialNetworks"
            value={userProfile?.socialNetworks || []}
            inputClasses={globalInputClasses}
            addButtonLabel="Add Social Link"
            emptyMessage="No social links yet. Add your LinkedIn, Twitter, or other profiles."
          />
        </div>

        <!-- Phone and SMS -->
        <PhoneAndSMS
          id="phone"
          name="phone"
          value={userProfile?.phone || ""}
          placeholder="Enter your phone number"
          showSMS={true}
          smsChecked={userProfile?.smsAlerts || false}
          selectedCarrier={storedCarrierKey || ""}
          {globalInputClasses}
        />

        <!-- Action Buttons -->
        <div class="flex gap-3 pt-4">
          <Button
            type="button"
            variant="outline"
            size="sm"
            class="w-auto md:w-full md:flex-1"
            id="back-button"
            icon="chevron-left"
            iconPosition="left"
          >
            <span class="hidden sm:inline"> Back </span>
          </Button>
          <Button
            type="submit"
            id="save-profile-btn"
            variant="secondary"
            size="sm"
            class="flex-1 md:w-full md:flex-grow"
            icon="save"
            iconPosition="left"
          >
            Save Changes
          </Button>
        </div>
      </form>

      <!-- Team Section -->
      <ProfileTeamSection
        class="mt-8"
        title="Team"
        description="People in your organization"
        members={teamMembers}
        emptyMessage="No team members yet. Mark profiles as team members to display them here."
      />
    </div>
  </div>
</App>

<script type="module" lang="ts">
  function initProfile() {
    if (window.location.pathname !== "/profile") return;
    const profileForm = document.getElementById("profile-form");
    if (profileForm?.hasAttribute("data-profile-inited")) return;
    if (profileForm) profileForm.setAttribute("data-profile-inited", "true");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const saveProfileBtnText = saveProfileBtn?.textContent;
    const uploadAvatarBtn = document.getElementById("upload-avatar-btn");
    const avatarInput = document.getElementById("avatar-input");
    const removeAvatarBtn = document.getElementById("remove-avatar-btn");
    const profileAvatarImg = document.getElementById("profile-avatar");
    const profileAvatarFallback = document.getElementById("profile-avatar-fallback");

    const resetEmailInput = document.getElementById("reset-email");
    const sendResetLinkBtn = document.getElementById("send-reset-link");

    // Get form elements

    // Handle profile form submission
    profileForm?.addEventListener("submit", async (e) => {
      // Check form validity before preventing default
      if (!profileForm.checkValidity()) {
        // Let the browser show validation messages
        profileForm.reportValidity();
        return;
      }

      e.preventDefault();

      const formData = new FormData(profileForm);
      const companyName = formData.get("company-name");
      const firstName = formData.get("firstName");
      const lastName = formData.get("lastName");
      const phone = formData.get("phone");
      const smsAlertsCheckbox = document.getElementById("sms-alerts-phone");
      const smsAlerts = smsAlertsCheckbox?.checked || false;
      const mobileCarrier = formData.get("mobileCarrier");
      const socialNetworksRaw = formData.get("socialNetworks");
      let socialNetworks = [];
      if (socialNetworksRaw && typeof socialNetworksRaw === "string") {
        try {
          const parsed = JSON.parse(socialNetworksRaw);
          socialNetworks = Array.isArray(parsed) ? parsed : [];
        } catch {
          socialNetworks = [];
        }
      }

      // Validate required fields manually as well
      if (!firstName?.trim() || !lastName?.trim()) {
        if (window.showNotice) {
          window.showNotice(
            "error",
            "Validation Error",
            "First name and last name are required fields.",
            5000
          );
        } else {
          alert("First name and last name are required fields.");
        }
        return;
      }

      // Disable button and show loading state
      if (saveProfileBtn) {
        saveProfileBtn.disabled = true;
        saveProfileBtn.textContent = "Saving...";
      }

      try {
        const response = await fetch("/api/users/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            companyName,
            firstName,
            lastName,
            phone,
            smsAlerts,
            mobileCarrier: smsAlerts ? mobileCarrier : null,
            socialNetworks,
          }),
        });

        // Check if response is actually JSON before parsing
        const contentType = response.headers.get("content-type");
        let result;

        if (contentType && contentType.includes("application/json")) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error("Non-JSON response received:", text.substring(0, 100));
          throw new Error(`Expected JSON response but received: ${contentType || "unknown"}`);
        }

        if (response.ok) {
          if (window.showNotice) {
            window.showNotice(
              "success",
              "Profile Updated",
              "Your profile has been updated successfully.",
              2500
            );
          } else {
            console.log("ðŸ”” [Profile Updated] Your profile has been updated successfully.");
          }
        } else {
          if (window.showNotice) {
            window.showNotice(
              "error",
              "Update Failed",
              result.error || "Failed to update profile. Please try again.",
              5000
            );
          } else {
            console.error(
              "ðŸ”” [Update Failed]",
              result.error || "Failed to update profile. Please try again."
            );
          }
        }
      } catch (error) {
        console.error("Profile update error:", error);
        if (window.showNotice) {
          window.showNotice(
            "error",
            "Network Error",
            "Failed to update profile. Please check your connection and try again.",
            5000
          );
        } else {
          console.error(
            "ðŸ”” [Network Error] Failed to update profile. Please check your connection and try again."
          );
        }
      } finally {
        // Re-enable button
        if (saveProfileBtn) {
          saveProfileBtn.disabled = false;
          saveProfileBtn.textContent = saveProfileBtnText || "Save Changes";
        }
      }
    });

    // Handle avatar upload (media POST = upsert, then set profile.avatarUrl via users/update)
    uploadAvatarBtn?.addEventListener("click", () => {
      avatarInput?.click();
    });

    avatarInput?.addEventListener("change", async (e) => {
      const inputEl = e.target;
      const file = inputEl?.files?.[0];
      if (!file) return;

      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        if (window.showNotice) {
          window.showNotice("error", "File too large", "Please choose an image under 5MB.", 5000);
        }
        if (inputEl) inputEl.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = async () => {
        const dataUrl = reader.result;
        const base64 = typeof dataUrl === "string" ? dataUrl : "";
        const fileName = file.name.replace(/[^a-zA-Z0-9.-]/g, "_") || "avatar";
        const fileType = file.type || "image/jpeg";

        try {
          const mediaRes = await fetch("/api/media", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              mediaData: base64,
              fileName,
              fileType,
              targetLocation: "profiles",
            }),
          });
          const mediaJson = await mediaRes.json();
          if (!mediaRes.ok || !mediaJson?.file?.publicUrl) {
            throw new Error(mediaJson?.error || "Upload failed");
          }

          const updateRes = await fetch("/api/users/update", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ avatarUrl: mediaJson.file.publicUrl }),
          });
          const updateJson = await updateRes.json();
          if (!updateRes.ok) {
            throw new Error(updateJson?.error || "Failed to update profile");
          }

          if (profileAvatarImg) {
            profileAvatarImg.src = mediaJson.file.publicUrl;
            profileAvatarImg.style.display = "";
            if (profileAvatarFallback) profileAvatarFallback.style.display = "none";
          }
          if (removeAvatarBtn) removeAvatarBtn.style.display = "";
          if (window.showNotice) {
            window.showNotice(
              "success",
              "Photo updated",
              "Your profile photo has been updated.",
              2500
            );
          }
        } catch (err) {
          console.error("Avatar upload error:", err);
          if (window.showNotice) {
            window.showNotice(
              "error",
              "Upload failed",
              err instanceof Error ? err.message : "Failed to upload photo. Please try again.",
              5000
            );
          }
        } finally {
          if (inputEl) inputEl.value = "";
        }
      };
      reader.readAsDataURL(file);
    });

    // Handle avatar remove (clear profile.avatarUrl via users/update)
    removeAvatarBtn?.addEventListener("click", async () => {
      try {
        const res = await fetch("/api/users/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ avatarUrl: null }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Failed to remove photo");
        if (profileAvatarImg) {
          profileAvatarImg.src = "";
          profileAvatarImg.style.display = "none";
        }
        if (profileAvatarFallback) profileAvatarFallback.style.display = "";
        if (removeAvatarBtn) removeAvatarBtn.style.display = "none";
        if (window.showNotice) {
          window.showNotice(
            "success",
            "Photo removed",
            "Your profile photo has been removed.",
            2500
          );
        }
      } catch (err) {
        console.error("Avatar remove error:", err);
        if (window.showNotice) {
          window.showNotice(
            "error",
            "Remove failed",
            err instanceof Error ? err.message : "Failed to remove photo.",
            5000
          );
        }
      }
    });

    // Handle back button
    const backButton = document.getElementById("back-button");
    backButton?.addEventListener("click", () => {
      // Check if there's a referrer and it's from the same site
      if (document.referrer && document.referrer.includes(window.location.origin)) {
        window.history.back();
      } else {
        // Fallback to dashboard if no referrer
        window.location.href = "/dashboard";
      }
    });
  }
  window["__initProfile"] = initProfile;
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initProfile);
  } else {
    initProfile();
  }
  // SPA disabled: document.addEventListener("astro:page-load", initProfile);
</script>
