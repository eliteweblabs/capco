---
const requireAuthRedirect = "/auth/login";
import { checkAuth } from "../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);

// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalCompanyData } from "./api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
} = await globalCompanyData();

import { globalClasses } from "./api/global/global-classes";
import Hero from "../components/common/Hero.astro";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import App from "../components/ui/App.astro";
import ProfileTabForm from "../components/profile/ProfileTabForm.astro";
const userProfile = currentUser?.profile || null;

// Tab state from URL
const defaultTabParam = Astro.url.searchParams.get("tab") || "general";
const validTabs = ["settings", "general", "social", "team"];
const activeTab = validTabs.includes(defaultTabParam) ? defaultTabParam : "general";
---

<App
  title="User Profile"
  description="Manage your account information and preferences"
  {currentUser}
  session={session || undefined}
  project={undefined}
  {supabase}
  {globalCompanyName}
  {globalCompanySlogan}
  {primaryTextClasses}
  {secondaryTextClasses}
  {globalInputClasses}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
>
  <Hero
    title={`${userProfile?.companyName || userProfile?.firstName || "User"}'s Profile`}
    titleRefreshField="companyName"
    titleRefreshValue={userProfile?.companyName ?? null}
    titleRefreshUserId={currentUser?.id}
    titleRefreshSuffix="'s Profile"
    description="Manage your account information and preferences"
    primaryTextClasses="text-3xl font-bold text-gray-900 dark:text-white"
    secondaryTextClasses="text-gray-600 dark:text-gray-300"
    globalInputClasses="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent dark:bg-gray-700 dark:border-gray-600 dark:text-white"
  />
  <script src="../lib/refresh-manager.ts"></script>
  <script define:vars={{ hasUserRefresh: !!currentUser?.id }} is:inline>
    if (hasUserRefresh) {
      function startProfileRefresh() {
        const rm = window.refreshManager;
        if (rm && !rm.isAutoRefreshActive?.()) {
          rm.startAutoRefreshWithInterval?.(5);
        } else if (!rm) {
          setTimeout(startProfileRefresh, 100);
        }
      }
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () => setTimeout(startProfileRefresh, 50));
      } else {
        setTimeout(startProfileRefresh, 50);
      }
    }
  </script>
  <div class="XXbg-gray-100 XXshadow-sm XXmd:p-6 p-4">
    <div class="mx-auto max-w-2xl">
      <ProfileTabForm
        userProfile={userProfile}
        currentUser={currentUser}
        globalInputClasses={globalInputClasses}
        globalCompanyPhone={globalCompanyPhone}
        activeTab={activeTab}
        showSettingsTab={true}
        showSignOut={true}
      />
    </div>
  </div>
</App>

<script type="module" define:vars={{ currentUserId: currentUser?.id }}>
  function loadCropperjs() {
    if (window.Cropper?.default) return Promise.resolve(window.Cropper.default);
    const loadCss = () => {
      if (document.querySelector('link[href*="cropper.min.css"]')) return Promise.resolve();
      return new Promise((resolve) => {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = "https://cdn.jsdelivr.net/npm/cropperjs@2.1.0/dist/cropper.min.css";
        link.onload = () => resolve();
        link.onerror = () => resolve();
        document.head.appendChild(link);
      });
    };
    return loadCss().then(
      () =>
        new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/cropperjs@2.1.0/dist/cropper.min.js";
          script.async = true;
          script.onload = () => resolve(window.Cropper?.default || window.Cropper);
          script.onerror = () => reject(new Error("Failed to load Cropper.js"));
          document.head.appendChild(script);
        })
    );
  }

  window.switchProfileTab = function (tab) {
    ["settings", "general", "social", "team"].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("hidden", id !== tab);
    });
    const url = new URL(window.location.href);
    url.searchParams.set("tab", tab);
    window.history.replaceState({}, "", url.toString());
  };

  function initProfile() {
    if (window.location.pathname !== "/profile") return;
    if (typeof window.initPageSizeToggle === "function")
      window.initPageSizeToggle({
        buttonId: "profile-page-size-toggle",
        labelId: "profile-page-size-toggle-label",
        iconInId: "profile-page-size-icon-in",
        iconOutId: "profile-page-size-icon-out",
      });
    const profileTabNav = document.getElementById("profile-tab-nav");
    if (profileTabNav) {
      profileTabNav.addEventListener("click", (e) => {
        const target = e.target instanceof HTMLElement ? e.target.closest("button[id]") : null;
        if (!target || !target.id?.startsWith("tab-")) return;
        const tab = target.id.replace(/^tab-/, "");
        if (["settings", "general", "social", "team"].includes(tab)) window.switchProfileTab?.(tab);
      });
    }
    const profileForm = document.getElementById("profile-form");
    if (profileForm?.hasAttribute("data-profile-inited")) return;
    if (profileForm) profileForm.setAttribute("data-profile-inited", "true");
    const saveProfileBtns = document.querySelectorAll(".save-profile-btn");
    const saveProfileBtnText = "Save Changes";
    const uploadAvatarBtn = document.getElementById("upload-avatar-btn");
    const avatarInput = document.getElementById("avatar-input");
    const removeAvatarBtn = document.getElementById("remove-avatar-btn");
    const profileAvatarImg = document.getElementById("profile-avatar");
    const profileAvatarFallback = document.getElementById("profile-avatar-fallback");

    const resetEmailInput = document.getElementById("reset-email");
    const sendResetLinkBtn = document.getElementById("send-reset-link");

    // Get form elements

    // Handle profile form submission
    profileForm?.addEventListener("submit", async (e) => {
      // Check form validity before preventing default
      if (!profileForm.checkValidity()) {
        // Let the browser show validation messages
        profileForm.reportValidity();
        return;
      }

      e.preventDefault();

      const formData = new FormData(profileForm);
      const companyName = formData.get("companyName");
      const firstName = formData.get("firstName");
      const lastName = formData.get("lastName");
      const title = formData.get("title");
      const phone = formData.get("phone");
      const bio = formData.get("bio");
      const smsAlertsCheckbox = document.getElementById("sms-alerts-phone");
      const smsAlerts = smsAlertsCheckbox?.checked || false;
      const mobileCarrier = formData.get("mobileCarrier");
      const socialNetworksRaw = formData.get("socialNetworks");
      let socialNetworks = [];
      if (socialNetworksRaw && typeof socialNetworksRaw === "string") {
        try {
          const parsed = JSON.parse(socialNetworksRaw);
          socialNetworks = Array.isArray(parsed) ? parsed : [];
        } catch {
          socialNetworks = [];
        }
      }

      // Validate required fields manually as well
      if (!firstName?.trim() || !lastName?.trim()) {
        if (window.showNotice) {
          window.showNotice(
            "error",
            "Validation Error",
            "First name and last name are required fields.",
            5000
          );
        } else {
          alert("First name and last name are required fields.");
        }
        return;
      }

      // Disable buttons and show loading state
      saveProfileBtns.forEach((btn) => {
        btn.disabled = true;
        btn.textContent = "Saving...";
      });

      try {
        const response = await fetch("/api/users/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            companyName,
            firstName,
            lastName,
            title: title?.toString().trim() || null,
            phone,
            bio: bio?.toString().trim() || null,
            smsAlerts,
            mobileCarrier: smsAlerts ? mobileCarrier : null,
            socialNetworks,
          }),
        });

        // Check if response is actually JSON before parsing
        const contentType = response.headers.get("content-type");
        let result;

        if (contentType && contentType.includes("application/json")) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error("Non-JSON response received:", text.substring(0, 100));
          throw new Error(`Expected JSON response but received: ${contentType || "unknown"}`);
        }

        if (response.ok) {
          if (window.showNotice) {
            window.showNotice(
              "success",
              "Profile Updated",
              "Your profile has been updated successfully.",
              2500
            );
          } else {
            console.log("ðŸ”” [Profile Updated] Your profile has been updated successfully.");
          }
        } else {
          if (window.showNotice) {
            window.showNotice(
              "error",
              "Update Failed",
              result.error || "Failed to update profile. Please try again.",
              5000
            );
          } else {
            console.error(
              "ðŸ”” [Update Failed]",
              result.error || "Failed to update profile. Please try again."
            );
          }
        }
      } catch (error) {
        console.error("Profile update error:", error);
        if (window.showNotice) {
          window.showNotice(
            "error",
            "Network Error",
            "Failed to update profile. Please check your connection and try again.",
            5000
          );
        } else {
          console.error(
            "ðŸ”” [Network Error] Failed to update profile. Please check your connection and try again."
          );
        }
      } finally {
        // Re-enable buttons
        saveProfileBtns.forEach((btn) => {
          btn.disabled = false;
          btn.textContent = saveProfileBtnText;
        });
      }
    });

    // Handle avatar upload (media POST = upsert, then set profile.avatarUrl via users/update)
    uploadAvatarBtn?.addEventListener("click", () => {
      avatarInput?.click();
    });

    let avatarCropperInstance = null;
    let avatarCropperPendingFile = null;
    const cropperBlock = document.getElementById("profile-avatar-cropper");
    const cropperImg = document.getElementById("avatar-cropper-image");
    const cropperContainer = document.getElementById("avatar-cropper-container");

    const closeAvatarCropper = () => {
      if (avatarCropperInstance) {
        avatarCropperInstance.destroy();
        avatarCropperInstance = null;
      }
      avatarCropperPendingFile = null;
      cropperBlock?.classList.add("hidden");
      avatarInput && (avatarInput.value = "");
    };

    const initAvatarCropper = () => {
      document.querySelectorAll("[data-avatar-cropper-close]").forEach((btn) => {
        btn.addEventListener("click", closeAvatarCropper);
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && cropperBlock && !cropperBlock?.classList.contains("hidden")) {
          closeAvatarCropper();
        }
      });

      document.getElementById("avatar-cropper-apply")?.addEventListener("click", async () => {
        if (!avatarCropperInstance || !avatarCropperPendingFile) return;
        const cropperSelection = avatarCropperInstance.getCropperSelection();
        if (!cropperSelection) return;
        try {
          const outputCanvas = await cropperSelection.$toCanvas({ width: 400, height: 400 });
          outputCanvas.toBlob(
            async (blob) => {
              if (!blob) return;
              const base64 = await new Promise((resolve, reject) => {
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.onerror = reject;
                r.readAsDataURL(blob);
              });
              const fileName =
                avatarCropperPendingFile.name.replace(/[^a-zA-Z0-9.-]/g, "_") || "avatar";
              const mediaRes = await fetch("/api/media", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  mediaData: base64,
                  fileName,
                  fileType: blob.type || "image/jpeg",
                  targetLocation: "profiles",
                }),
              });
              const mediaJson = await mediaRes.json();
              if (!mediaRes.ok || !mediaJson?.file?.publicUrl) {
                throw new Error(mediaJson?.error || "Upload failed");
              }
              const updateRes = await fetch("/api/users/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ avatarUrl: mediaJson.file.publicUrl }),
              });
              const updateJson = await updateRes.json();
              if (!updateRes.ok) throw new Error(updateJson?.error || "Failed to update profile");
              if (profileAvatarImg) {
                profileAvatarImg.src = mediaJson.file.publicUrl;
                profileAvatarImg.style.display = "";
                if (profileAvatarFallback) profileAvatarFallback.style.display = "none";
              }
              if (removeAvatarBtn) removeAvatarBtn.style.display = "";
              window.refreshAvatar?.(mediaJson.file.publicUrl, currentUserId);
              if (window.showNotice) {
                window.showNotice(
                  "success",
                  "Photo updated",
                  "Your profile photo has been updated.",
                  2500
                );
              }
              closeAvatarCropper();
            },
            "image/jpeg",
            0.9
          );
        } catch (err) {
          console.error("Avatar crop/upload error:", err);
          if (window.showNotice) {
            window.showNotice(
              "error",
              "Upload failed",
              err instanceof Error ? err.message : "Failed to upload photo. Please try again.",
              5000
            );
          }
        }
      });
    };
    if (cropperBlock) initAvatarCropper();

    avatarInput?.addEventListener("change", async (e) => {
      const inputEl = e.target;
      const file = inputEl?.files?.[0];
      if (!file) return;

      const maxSize = 5 * 1024 * 1024; // 5MB
      if (file.size > maxSize) {
        if (window.showNotice) {
          window.showNotice("error", "File too large", "Please choose an image under 5MB.", 5000);
        }
        if (inputEl) inputEl.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = async () => {
        const dataUrl = reader.result;
        if (typeof dataUrl !== "string" || !cropperBlock || !cropperImg || !cropperContainer)
          return;

        avatarCropperPendingFile = file;
        cropperImg.src = dataUrl;
        cropperImg.style.display = "block";
        cropperBlock.classList.remove("hidden");

        const Cropper = await loadCropperjs();
        avatarCropperInstance = new Cropper(cropperImg, {
          container: cropperContainer,
        });
        const sel = avatarCropperInstance.getCropperSelection();
        if (sel) {
          sel.aspectRatio = 1;
          sel.initialAspectRatio = 1;
          sel.initialCoverage = 0.8;
          sel.movable = true;
          sel.resizable = true;
        }
      };
      reader.readAsDataURL(file);
    });

    // Handle avatar remove (clear profile.avatarUrl via users/update)
    removeAvatarBtn?.addEventListener("click", async () => {
      try {
        const res = await fetch("/api/users/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ avatarUrl: null }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Failed to remove photo");
        if (profileAvatarImg) {
          profileAvatarImg.src = "";
          profileAvatarImg.style.display = "none";
        }
        if (profileAvatarFallback) profileAvatarFallback.style.display = "";
        if (removeAvatarBtn) removeAvatarBtn.style.display = "none";
        window.refreshAvatar?.("", currentUserId);
        if (window.showNotice) {
          window.showNotice(
            "success",
            "Photo removed",
            "Your profile photo has been removed.",
            2500
          );
        }
      } catch (err) {
        console.error("Avatar remove error:", err);
        if (window.showNotice) {
          window.showNotice(
            "error",
            "Remove failed",
            err instanceof Error ? err.message : "Failed to remove photo.",
            5000
          );
        }
      }
    });

    // Handle profile logout button
    const profileLogoutBtn = document.getElementById("profile-logout-btn");
    profileLogoutBtn?.addEventListener("click", async () => {
      try {
        const response = await fetch("/api/auth/signout", { method: "POST" });
        if (response.ok) {
          const url = new URL(window.location.origin);
          url.searchParams.set("message", "logout_success");
          window.location.href = url.toString();
        } else if (typeof window.showNotice === "function") {
          window.showNotice(
            "error",
            "Logout Failed",
            "There was an error logging out. Please try again.",
            0
          );
        } else {
          alert("There was an error logging out. Please try again.");
        }
      } catch (error) {
        console.error("Profile logout error:", error);
      }
    });

    // Handle back button
    const backButton = document.getElementById("back-button");
    backButton?.addEventListener("click", () => {
      // Check if there's a referrer and it's from the same site
      if (document.referrer && document.referrer.includes(window.location.origin)) {
        window.history.back();
      } else {
        // Fallback to dashboard if no referrer
        window.location.href = "/dashboard";
      }
    });
  }
  window["__initProfile"] = initProfile;
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initProfile);
  } else {
    initProfile();
  }
  // SPA disabled: document.addEventListener("astro:page-load", initProfile);
</script>
