---
const requireAuthRedirect = "/auth/login";
import { checkAuth } from "../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);

// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalCompanyData } from "./api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  globalCompanyLogoDark,
  globalCompanyLogoLight,
} = globalCompanyData();

import { globalClasses } from "./api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import App from "../components/common/App.astro";
import { getCarrierKeyFromGateway } from "../lib/sms-utils";
import SimpleIcon from "../components/common/SimpleIcon.astro";
import Footer from "../components/common/Footer.astro";
import PhoneAndSMS from "../components/form/PhoneAndSMS.astro";
import Button from "../components/common/Button.astro";
import ForgotPasswordModal from "../components/form/ForgetPasswordModal.astro";
const userProfile = currentUser?.profile || null;

// Get the carrier key from the stored gateway domain
const storedCarrierKey = currentUser?.user_metadata?.mobileCarrier
  ? getCarrierKeyFromGateway(currentUser.user_metadata.mobileCarrier)
  : null;
---

<App
  title=""
  description=""
  {currentUser}
  session={session || undefined}
  project={undefined}
  {supabase}
  {globalCompanyName}
  {globalCompanySlogan}
  {primaryTextClasses}
  {secondaryTextClasses}
  {globalInputClasses}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
  {globalCompanyLogoDark}
  {globalCompanyLogoLight}
>
  <div class="px-4 pt-4">
    <div class="rounded-md bg-gray-100 p-4 shadow-sm color-background md:p-6">
      <div class="mx-auto max-w-2xl">
        <!-- Header -->
        <div class="mb-8 text-center">
          <!-- <div
          class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-lg bg-blue-100 dark:bg-blue-900/30"
        >
          <SimpleIcon name="user" class="h-8 w-8 text-blue-600 dark:text-blue-400" />
        </div> -->
          <h1 class="text-3xl font-bold text-gray-900 dark:text-white">My Profile</h1>
          <p class="mt-2 text-gray-600 dark:text-gray-300">
            Manage your account information and preferences
          </p>
        </div>

        <!-- Profile Form -->
        <form id="profile-form" class="space-y-6">
          <!-- Profile Picture Section -->
          <!-- <div class="text-center">
            <div
              class="mx-auto mb-4 flex h-20 w-20 items-center justify-center rounded-lg bg-gray-100 dark:bg-gray-700"
            >
              <img
                id="profile-avatar"
                src=""
                alt="Profile picture"
                class="h-20 w-20 rounded-lg object-cover"
                onerror="this.style.display='none'; if (this.nextElementSibling) this.nextElementSibling.style.display='flex';"
              />
              <SimpleIcon name="user" style="display:none;" class="h-10 w-10 text-gray-400" />
            </div>
            <Button
              type="button"
              id="upload-avatar-btn"
              variant="link"
              size="sm"
              class="text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300"
            >
              Upload Photo
            </Button>
            <input type="file" id="avatar-input" accept="image/*" class="hidden" />
          </div> -->

          <!-- Company Name Field -->
          <div class="grid grid-cols-1 gap-4 lg:grid-cols-1">
            <div class="relative">
              <label
                for="companyName"
                class="block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Company Name
              </label>
              <input
                type="text"
                id="company-name"
                name="companyName"
                value={userProfile?.companyName || ""}
                class=`${globalInputClasses}`
                placeholder="Enter your company name"
              />
            </div>
          </div>

          <!-- First Name and Last Name Fields -->
          <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
            <div class="relative">
              <label
                for="first-name"
                class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                First Name
              </label>
              <input
                type="text"
                id="first-name"
                name="firstName"
                value={userProfile?.firstName || ""}
                required
                class=`${globalInputClasses}`
                placeholder="Enter your first name"
              />
            </div>
            <div class="relative">
              <label
                for="last-name"
                class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Last Name
              </label>
              <input
                type="text"
                id="last-name"
                name="lastName"
                value={userProfile?.lastName || ""}
                required
                class=`${globalInputClasses}`
                placeholder="Enter your last name"
              />
            </div>
          </div>

          <!-- Email Field (Read-only) -->
          <div class="grid grid-cols-1 gap-4 lg:grid-cols-1">
            <div class="relative">
              <label
                for="email"
                class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >
                Email Address
              </label>
              <div class="relative">
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  value={currentUser?.email || ""}
                  readonly
                  class=`${globalInputClasses}`
                  placeholder="Enter email address"
                />
                <SimpleIcon
                  id="email-lock-icon"
                  name="lock"
                  class="absolute right-3 top-1/2 -translate-y-1/2"
                />
              </div>
            </div>
          </div>

          <!-- Phone and SMS -->
          <PhoneAndSMS
            id="phone"
            name="phone"
            value={currentUser?.user_metadata?.phone || ""}
            placeholder="Enter your phone number"
            showSMS={true}
            smsChecked={currentUser?.user_metadata?.smsAlerts || false}
            selectedCarrier={storedCarrierKey || ""}
            {globalInputClasses}
          />

          <!-- Action Buttons -->
          <div class="gap-3 pt-4 md:flex">
            <Button
              type="button"
              variant="ghost"
              size="sm"
              class="w-full"
              href="/dashboard"
              icon="chevron-left"
              iconPosition="left"
            >
              Cancel / Dashboard
            </Button>
            <Button
              type="submit"
              id="save-profile-btn"
              variant="primary"
              size="sm"
              class="w-full"
              icon="save"
              iconPosition="left"
            >
              Save Changes
            </Button>
          </div>
        </form>
      </div>
    </div>
  </div>
</App>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const profileForm = document.getElementById("profile-form");
    const saveProfileBtn = document.getElementById("save-profile-btn");
    const saveProfileBtnText = saveProfileBtn?.textContent;
    const uploadAvatarBtn = document.getElementById("upload-avatar-btn");
    const avatarInput = document.getElementById("avatar-input");
    const deleteAccountBtn = document.getElementById("delete-account-btn");

    const resetEmailInput = document.getElementById("reset-email");
    const sendResetLinkBtn = document.getElementById("send-reset-link");

    // Get form elements

    // Handle profile form submission
    profileForm?.addEventListener("submit", async (e) => {
      // Check form validity before preventing default
      if (!(profileForm as HTMLFormElement).checkValidity()) {
        // Let the browser show validation messages
        (profileForm as HTMLFormElement).reportValidity();
        return;
      }

      e.preventDefault();

      const formData = new FormData(profileForm as HTMLFormElement);
      const companyName = formData.get("companyName");
      const firstName = formData.get("firstName") as string;
      const lastName = formData.get("lastName") as string;
      const phone = formData.get("phone");
      const smsAlertsCheckbox = document.getElementById("sms-alerts-phone") as HTMLInputElement;
      const smsAlerts = smsAlertsCheckbox?.checked || false;
      const mobileCarrier = formData.get("mobileCarrier");

      // Validate required fields manually as well
      if (!firstName?.trim() || !lastName?.trim()) {
        if (window.showModal) {
          window.showModal(
            "error",
            "Validation Error",
            "First name and last name are required fields.",
            5000
          );
        } else {
          alert("First name and last name are required fields.");
        }
        return;
      }

      // Disable button and show loading state
      if (saveProfileBtn) {
        (saveProfileBtn as HTMLButtonElement).disabled = true;
        saveProfileBtn.textContent = "Saving...";
      }

      try {
        const response = await fetch("/api/users/update", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            companyName,
            firstName,
            lastName,
            phone,
            smsAlerts,
            mobileCarrier: smsAlerts ? mobileCarrier : null,
          }),
        });

        // Check if response is actually JSON before parsing
        const contentType = response.headers.get("content-type");
        let result;

        if (contentType && contentType.includes("application/json")) {
          result = await response.json();
        } else {
          const text = await response.text();
          console.error("Non-JSON response received:", text.substring(0, 100));
          throw new Error(`Expected JSON response but received: ${contentType || "unknown"}`);
        }

        if (response.ok) {
          if (window.showModal) {
            window.showModal(
              "success",
              "Profile Updated",
              "Your profile has been updated successfully.",
              2500
            );
          } else {
            console.log("ðŸ”” [Profile Updated] Your profile has been updated successfully.");
          }
        } else {
          if (window.showModal) {
            window.showModal(
              "error",
              "Update Failed",
              result.error || "Failed to update profile. Please try again.",
              5000
            );
          } else {
            console.error(
              "ðŸ”” [Update Failed]",
              result.error || "Failed to update profile. Please try again."
            );
          }
        }
      } catch (error) {
        console.error("Profile update error:", error);
        if (window.showModal) {
          window.showModal(
            "error",
            "Network Error",
            "Failed to update profile. Please check your connection and try again.",
            5000
          );
        } else {
          console.error(
            "ðŸ”” [Network Error] Failed to update profile. Please check your connection and try again."
          );
        }
      } finally {
        // Re-enable button
        if (saveProfileBtn) {
          (saveProfileBtn as HTMLButtonElement).disabled = false;
          saveProfileBtn.textContent = saveProfileBtnText || "Save Changes";
        }
      }
    });

    // Handle avatar upload
    uploadAvatarBtn?.addEventListener("click", () => {
      avatarInput?.click();
    });

    avatarInput?.addEventListener("change", async (e) => {
      const file = (e.target as HTMLInputElement)?.files?.[0];
      if (!file) return;

      // TODO: Implement avatar upload functionality
      if (window.showModal) {
        window.showModal("info", "Avatar Upload", "Avatar upload functionality coming soon!", 3000);
      } else {
        console.log("ðŸ”” [Avatar Upload] Avatar upload functionality coming soon!");
      }
    });
  });
</script>
