---
/**
 * Admin Setup Page
 * Allows creating the first admin user if no admins exist
 */
import { checkAuth } from "../lib/auth";
import { supabaseAdmin } from "../lib/supabase-admin";
import App from "../components/ui/App.astro";
import Button from "../components/common/Button.astro";

const { currentUser, session } = await checkAuth(Astro.cookies);

// Check if any admin users exist
let adminCount = 0;
let hasAdmins = false;

try {
  const { count, error } = await supabaseAdmin
    .from("profiles")
    .select("*", { count: "exact", head: true })
    .eq("role", "Admin");

  console.log("[SETUP] Admin check result:", { count, error: error?.message });

  if (!error && count !== null) {
    adminCount = count;
    hasAdmins = count > 0;
  } else if (error) {
    console.error("[SETUP] Error checking admin count:", error);
    // If query fails, assume no admins to allow setup
    hasAdmins = false;
  }
} catch (error) {
  console.error("[SETUP] Exception checking admin count:", error);
  // If query fails, assume no admins to allow setup
  hasAdmins = false;
}

console.log("[SETUP] Final state:", {
  hasAdmins,
  adminCount,
  currentUser: currentUser?.email,
  role: currentUser?.profile?.role,
});

// Only redirect if user is already an admin
if (currentUser && currentUser.profile?.role === "Admin") {
  console.log("[SETUP] User is already admin, redirecting to /admin");
  return Astro.redirect("/admin");
}

import { globalCompanyData } from "./api/global/global-company-data";
const { globalCompanyName, globalCompanySlogan, globalCompanyLogo } = await globalCompanyData();

import { globalClasses } from "./api/global/global-classes";
const { globalFormClasses, globalInputClasses } = globalClasses();
---

<App
  title="Admin Setup"
  description="Set up your first admin user"
  {currentUser}
  {session}
  {globalCompanyName}
  {globalCompanySlogan}
  {globalCompanyLogo}
  layout="centered"
>
  <div class="mx-auto w-full max-w-md px-4 py-8">
    <div class="rounded-lg bg-white p-8 shadow-lg dark:bg-gray-900">
      <h1 class="mb-4 text-center text-2xl font-bold">Admin Setup</h1>

      {
        hasAdmins ? (
          <div class="mb-4 rounded-lg border border-yellow-200 bg-yellow-50 p-4 dark:border-yellow-800 dark:bg-yellow-900/20">
            <p class="text-sm text-yellow-800 dark:text-yellow-200">
              ⚠️ Admin users already exist ({adminCount}). You can still create additional admin
              accounts below.
            </p>
          </div>
        ) : (
          <p class="mb-6 text-center text-gray-600 dark:text-gray-400">
            No admin users found. Create your first admin account below.
          </p>
        )
      }

      <form id="admin-setup-form" class={globalFormClasses}>
        <div>
          <label for="email" class="mb-2 block text-sm font-medium"> Email Address </label>
          <input
            type="email"
            id="email"
            name="email"
            required
            class={globalInputClasses}
            placeholder="admin@example.com"
          />
        </div>

        <div>
          <label for="password" class="mb-2 block text-sm font-medium"> Password </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            minlength="6"
            class={globalInputClasses}
            placeholder="Enter a secure password"
          />
        </div>

        <div>
          <label for="firstName" class="mb-2 block text-sm font-medium"> First Name </label>
          <input
            type="text"
            id="firstName"
            name="firstName"
            required
            class={globalInputClasses}
            placeholder="John"
          />
        </div>

        <div>
          <label for="lastName" class="mb-2 block text-sm font-medium"> Last Name </label>
          <input
            type="text"
            id="lastName"
            name="lastName"
            required
            class={globalInputClasses}
            placeholder="Doe"
          />
        </div>

        <div>
          <label for="companyName" class="mb-2 block text-sm font-medium"> Company Name </label>
          <input
            type="text"
            id="companyName"
            name="companyName"
            class={globalInputClasses}
            placeholder="Your Company"
          />
        </div>

        <div id="error-message" class="mb-4 hidden text-sm text-red-600 dark:text-red-400"></div>
        <div id="success-message" class="mb-4 hidden text-sm text-green-600 dark:text-green-400">
        </div>

        <Button type="submit" variant="primary" fullWidth> Create Admin Account </Button>
      </form>

      <p class="mt-6 text-center text-xs text-gray-500 dark:text-gray-400">
        Already have an account? <a href="/auth/login" class="text-primary hover:underline"
          >Log in</a
        >
      </p>
    </div>

    <div class="mt-6 text-center text-sm text-gray-500 dark:text-gray-400">
      <p class="mb-2">Alternative: Update existing user to Admin via SQL:</p>
      <code
        class="mt-2 block overflow-x-auto rounded bg-gray-100 p-2 text-left text-xs dark:bg-gray-900"
      >
        UPDATE profiles SET role = 'Admin' WHERE id = (SELECT id FROM auth.users WHERE email =
        'your-email@example.com');
      </code>
    </div>
  </div>

  <script>
    document.getElementById("admin-setup-form")?.addEventListener("submit", async (e) => {
      e.preventDefault();

      const form = e.target as HTMLFormElement;
      const formData = new FormData(form);
      const errorDiv = document.getElementById("error-message");
      const successDiv = document.getElementById("success-message");

      // Hide previous messages
      errorDiv?.classList.add("hidden");
      successDiv?.classList.add("hidden");

      const data = {
        email: formData.get("email"),
        password: formData.get("password"),
        firstName: formData.get("firstName"),
        lastName: formData.get("lastName"),
        companyName: formData.get("companyName") || "",
        role: "Admin",
      };

      try {
        const response = await fetch("/api/users/upsert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || "Failed to create admin user");
        }

        // Show success message
        if (successDiv) {
          successDiv.textContent = "Admin account created successfully! Redirecting to login...";
          successDiv.classList.remove("hidden");
        }

        // Redirect to login after 2 seconds
        setTimeout(() => {
          window.location.href = "/auth/login";
        }, 2000);
      } catch (error: any) {
        if (errorDiv) {
          errorDiv.textContent = error.message || "An error occurred. Please try again.";
          errorDiv.classList.remove("hidden");
        }
      }
    });
  </script>
</App>
