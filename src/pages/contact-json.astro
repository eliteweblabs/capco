---
// Test page for JSON-based multi-step contact form
import LayoutDefault from "../components/layouts/LayoutDefault.astro";
import MultiStepForm from "../components/form/MultiStepForm.astro";
import { contactFormConfig } from "../lib/forms/contact-form-config";
import App from "../components/ui/App.astro";
import { supabase } from "../lib/supabase";

// Check authentication from cookies since middleware doesn't run on this route
let user = Astro.locals.user; // Try middleware first
let isAuthenticated = !!user;

// If no user from middleware, check cookies directly
if (!user) {
  const accessToken = Astro.cookies.get("sb-access-token");
  const refreshToken = Astro.cookies.get("sb-refresh-token");

  if (accessToken && refreshToken && supabase) {
    const { data, error } = await supabase.auth.setSession({
      access_token: accessToken.value,
      refresh_token: refreshToken.value,
    });

    if (!error && data.user) {
      user = data.user;
      isAuthenticated = true;
      console.log("[CONTACT-FORM] User authenticated via cookies:", user.email);
    }
  }
}

// Fetch profile data if authenticated
let profile = null;
if (isAuthenticated && user) {
  const { data: profileData } = await supabase
    .from("profiles")
    .select("name, phone, company")
    .eq("id", user.id)
    .single();

  if (profileData) {
    profile = profileData;
    console.log("[CONTACT-FORM] Profile loaded:", profile);
  }
}

// Pre-fill user data if authenticated
const initialData =
  isAuthenticated && user
    ? {
        email: user.email,
        firstName:
          user.user_metadata?.firstName ||
          profile?.name?.split(" ")[0] ||
          user.user_metadata?.full_name?.split(" ")[0] ||
          "",
        lastName:
          user.user_metadata?.lastName ||
          profile?.name?.split(" ")[1] ||
          user.user_metadata?.full_name?.split(" ")[1] ||
          "",
        phone: profile?.phone || user.user_metadata?.phone || user.phone || "",
        company: profile?.company || user.user_metadata?.company || "",
        isAuthenticated: true,
      }
    : {
        isAuthenticated: false,
      };
---

<App
  centerContent={true}
  mask="center"
  title="Contact Us (JSON Config)"
  description="Contact form using JSON configuration"
>
  <MultiStepForm
    config={contactFormConfig}
    {initialData}
    containerClass="w-full max-w-2xl mx-auto"
  />
</App>
