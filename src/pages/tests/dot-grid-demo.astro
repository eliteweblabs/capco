---
/**
 * Dot Grid â€“ Demo
 * Canvas-based 1px dot grid for backgrounds. API: window.dotGrid (ripple, setBaseOpacity, setDot, etc.)
 */
import App from "../../components/ui/App.astro";
import Button from "../../components/common/Button.astro";
import DotGrid from "../../components/ui/DotGrid.astro";
import { checkAuth } from "../../lib/auth";
import { globalCompanyData } from "../api/global/global-company-data";
import { globalClasses } from "../api/global/global-classes";

const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
const {
  globalCompanyName,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
} = await globalCompanyData();
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();
---

<App
  title="Dot Grid Demo"
  description="Dot grid background component: ripples, opacity, design"
  {currentUser}
  {session}
  {supabase}
  {globalInputClasses}
  {primaryTextClasses}
  {secondaryTextClasses}
  {globalCompanyName}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
>
  <div class="relative min-h-screen">
    <DotGrid
      id="dotGrid"
      class="absolute inset-0 -z-10"
      spacing={32}
      baseOpacity={0.2}
      dotColor="primary-500"
    />
    <div class="container relative mx-auto max-w-2xl px-4 py-8">
      <h1 class="mb-2 text-3xl font-bold">Dot Grid</h1>
      <p class="mb-8 text-gray-600 dark:text-gray-400">
        Background is a 1px dot grid (32px spacing). Control via
        <code class="rounded bg-gray-200 px-1 dark:bg-gray-700">window.dotGrid</code>. Click the
        page to add a ripple.
      </p>

      <section class="mb-8">
        <h2 class="mb-4 text-xl font-semibold">Base opacity</h2>
        <input
          type="range"
          id="base-opacity"
          min="0"
          max="100"
          value="20"
          class="w-full max-w-xs accent-primary-500"
        />
        <span id="base-opacity-value" class="ml-2 text-sm text-gray-600 dark:text-gray-400"
          >0.2</span
        >
      </section>

      <section class="mb-8">
        <h2 class="mb-4 text-xl font-semibold">Ripple decay (animate)</h2>
        <p class="mb-2 text-sm text-gray-600 dark:text-gray-400">
          After clicking to add ripples, run decay to fade them back to base opacity.
        </p>
        <div class="flex flex-wrap gap-2">
          <Button id="decay-once" variant="outline" size="sm">Decay once</Button>
          <Button id="decay-loop" variant="primary" size="sm">Decay loop (5s)</Button>
        </div>
      </section>

      <section
        class="rounded-lg border border-gray-200 bg-gray-50/80 p-4 dark:border-gray-700 dark:bg-gray-800/50"
      >
        <h2 class="mb-2 text-lg font-semibold">API</h2>
        <pre
          class="overflow-x-auto text-xs text-gray-700 dark:text-gray-300"><code>window.dotGrid.setDot(col, row, 0..1)
window.dotGrid.setBaseOpacity(0..1)
window.dotGrid.setAllOpacity(0..1)
window.dotGrid.ripple(cx, cy, radius, intensity)
window.dotGrid.decayRipples(amount)
window.dotGrid.draw()</code></pre>
      </section>
    </div>

    <script>
      (function () {
        const api = window.dotGrid;
        if (!api) return;

        const opacityInput = document.getElementById("base-opacity");
        const opacityValue = document.getElementById("base-opacity-value");
        if (opacityInput && opacityValue) {
          opacityInput.addEventListener("input", () => {
            const v = Number(opacityInput.value) / 100;
            opacityValue.textContent = v.toFixed(2);
            api.setBaseOpacity(v);
          });
        }

        document.getElementById("decay-once")?.addEventListener("click", () => {
          api.decayRipples(0.05);
        });

        let decayInterval = null;
        document.getElementById("decay-loop")?.addEventListener("click", () => {
          if (decayInterval) {
            clearInterval(decayInterval);
            decayInterval = null;
            return;
          }
          decayInterval = setInterval(() => api.decayRipples(0.02), 50);
          setTimeout(() => {
            if (decayInterval) clearInterval(decayInterval);
            decayInterval = null;
          }, 5000);
        });

        document.querySelector(".relative.min-h-screen")?.addEventListener("click", (e) => {
          const el = e.currentTarget;
          if (!el || e.target.closest("button") || e.target.closest("input")) return;
          const rect = el.getBoundingClientRect();
          const cx = e.clientX - rect.left;
          const cy = e.clientY - rect.top;
          api.ripple(cx, cy, 120, 0.4);
        });
      })();
    </script>
  </div>
</App>
