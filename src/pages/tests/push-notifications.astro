---
// Test page for push notifications
---

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Push Notification Test - Campfire</title>
    <style>
      body {
        margin: 50px auto;
        background: #f5f5f5;
        padding: 20px;
        max-width: 800px;
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
      }
      .card {
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        background: white;
        padding: 30px;
      }
      .status {
        margin: 10px 0;
        border-radius: 4px;
        padding: 10px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
      }
      .status.warning {
        background: #fff3cd;
        color: #856404;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
      }
      button {
        cursor: pointer;
        margin: 10px 5px;
        border: none;
        border-radius: 4px;
        background: #007bff;
        padding: 12px 24px;
        color: white;
        font-size: 16px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        cursor: not-allowed;
        background: #ccc;
      }
      .code {
        margin: 10px 0;
        border-radius: 4px;
        background: #f4f4f4;
        padding: 15px;
        overflow-x: auto;
        font-size: 14px;
        font-family: monospace;
      }
      h1 {
        color: #333;
      }
      h2 {
        margin-top: 30px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <h1>üîî Push Notification Test - Campfire</h1>

    <div class="card">
      <h2>1. Browser Support Check</h2>
      <div id="support-status"></div>
    </div>

    <div class="card">
      <h2>2. Permission Status</h2>
      <div id="permission-status"></div>
      <button id="request-permission-btn" onclick="requestPermission()"
        >Request Notification Permission</button
      >
    </div>

    <div class="card">
      <h2>3. Service Worker Check</h2>
      <div id="sw-status"></div>
      <button id="register-sw-btn" onclick="registerServiceWorker()">Register Service Worker</button
      >
    </div>

    <div class="card">
      <h2>4. Test Notification</h2>
      <p>Click the button below to send a test notification (if permission is granted):</p>
      <button id="test-notification-btn" onclick="sendTestNotification()"
        >Send Test Notification</button
      >
    </div>

    <div class="card">
      <h2>5. Campfire Integration</h2>
      <p>To test Campfire push notifications:</p>
      <ol>
        <li>Open the Campfire chat (click the üí¨ Open Chat button)</li>
        <li>Grant notification permission when prompted</li>
        <li>Send a test message from another account or have someone message you</li>
        <li>You should receive a browser notification!</li>
      </ol>
    </div>

    <div class="card">
      <h2>Debug Info</h2>
      <div id="debug-info" class="code"></div>
    </div>

    <script>
      let debugInfo = [];

      function log(message, type = "info") {
        console.log(`[PUSH-TEST] ${message}`);
        debugInfo.push(`[${new Date().toLocaleTimeString()}] ${message}`);
        updateDebugInfo();
      }

      function updateDebugInfo() {
        document.getElementById("debug-info").textContent = debugInfo.join("\n");
      }

      // Detect mobile browser
      function detectMobileBrowser() {
        const ua = navigator.userAgent.toLowerCase();
        const isIOS = /iphone|ipad|ipod/.test(ua);
        const isAndroid = /android/.test(ua);
        const isMobile = isIOS || isAndroid;

        let browser = "Unknown";
        if (/safari/.test(ua) && !/chrome|crios|fxios/.test(ua)) {
          browser = "Safari";
        } else if (/chrome|crios/.test(ua)) {
          browser = "Chrome";
        } else if (/firefox|fxios/.test(ua)) {
          browser = "Firefox";
        } else if (/edg/.test(ua)) {
          browser = "Edge";
        }

        // Check if running as PWA
        const isStandalone =
          window.matchMedia("(display-mode: standalone)").matches ||
          (window.navigator as any).standalone === true;

        return { isMobile, isIOS, isAndroid, browser, isStandalone };
      }

      // 1. Check browser support
      function checkBrowserSupport() {
        const statusDiv = document.getElementById("support-status");
        const mobileInfo = detectMobileBrowser();

        // On iOS Safari, Notifications API might not be available in regular browsing
        // but is available when installed as PWA
        const hasNotificationAPI = "Notification" in window;
        const hasServiceWorker = "serviceWorker" in navigator;
        const hasPushManager = hasServiceWorker && "PushManager" in window;
        const hasHTTPS = location.protocol === "https:" || location.hostname === "localhost";

        const features = {
          "Notifications API": hasNotificationAPI,
          "Service Workers": hasServiceWorker,
          "Push Manager": hasPushManager,
          HTTPS: hasHTTPS,
        };

        let allSupported = Object.values(features).every((v) => v);

        let html = "";

        // Mobile-specific guidance
        if (mobileInfo.isMobile) {
          html += '<div class="status info">';
          html += `<strong>üì± Mobile Device Detected</strong><br>`;
          html += `Browser: ${mobileInfo.browser}<br>`;
          html += `Platform: ${mobileInfo.isIOS ? "iOS" : "Android"}<br>`;
          html += `PWA Mode: ${mobileInfo.isStandalone ? "‚úÖ Installed" : "‚ùå Not Installed"}<br>`;
          html += "</div><br>";

          if (mobileInfo.isIOS && mobileInfo.browser === "Safari") {
            if (!mobileInfo.isStandalone) {
              html += '<div class="status warning">';
              html += "<strong>‚ö†Ô∏è iOS Safari Push Notification Requirements:</strong><br>";
              html +=
                "On iOS Safari, push notifications only work when the site is <strong>added to Home Screen</strong> as a PWA.<br>";
              html += "<strong>To enable:</strong><br>";
              html += "1. Tap the Share button (square with arrow)<br>";
              html += '2. Scroll and tap "Add to Home Screen"<br>';
              html += "3. Open the app from your Home Screen<br>";
              html += "4. Grant notification permission<br>";
              html += "</div>";
            } else {
              html += '<div class="status success">';
              html += "‚úÖ App is installed as PWA! Push notifications should work.";
              html += "</div>";
            }
          } else if (
            mobileInfo.isAndroid ||
            (mobileInfo.isIOS && mobileInfo.browser !== "Safari")
          ) {
            html += '<div class="status success">';
            html += `‚úÖ ${mobileInfo.browser} on ${mobileInfo.isIOS ? "iOS" : "Android"} has good push notification support!`;
            html += "</div>";
          }
        }

        html +=
          '<div class="status ' +
          (allSupported ? "success" : mobileInfo.isMobile ? "warning" : "error") +
          '">';
        html +=
          "<strong>" +
          (allSupported
            ? "‚úÖ All features supported"
            : mobileInfo.isMobile
              ? "‚ö†Ô∏è Mobile limitations detected"
              : "‚ùå Some features missing") +
          "</strong><br>";

        for (const [name, supported] of Object.entries(features)) {
          html += `<br>${supported ? "‚úÖ" : "‚ùå"} ${name}: ${supported ? "Supported" : "Not Supported"}`;
        }
        html += "</div>";

        if (statusDiv) (statusDiv as HTMLElement).innerHTML = html;

        log(
          `Browser: ${mobileInfo.browser} on ${mobileInfo.isIOS ? "iOS" : mobileInfo.isAndroid ? "Android" : "Desktop"}`,
          "info"
        );
        log(
          `PWA Mode: ${mobileInfo.isStandalone ? "YES" : "NO"}`,
          mobileInfo.isStandalone ? "success" : "warning"
        );
        log(
          `Browser support check: ${allSupported ? "PASS" : "FAIL"}`,
          allSupported ? "success" : "error"
        );
        for (const [name, supported] of Object.entries(features)) {
          log(`${name}: ${supported}`, supported ? "success" : "error");
        }
      }

      // 2. Check permission status
      function checkPermission() {
        const statusDiv = document.getElementById("permission-status");
        const btn = document.getElementById("request-permission-btn");
        const mobileInfo = detectMobileBrowser();

        if (!("Notification" in window)) {
          let message = '<div class="status error">‚ùå Notifications API not supported</div>';

          // Mobile Safari specific guidance
          if (mobileInfo.isIOS && mobileInfo.browser === "Safari" && !mobileInfo.isStandalone) {
            message = '<div class="status warning">';
            message += "<strong>‚ö†Ô∏è Notifications API not available in mobile Safari</strong><br>";
            message += "This is normal! iOS Safari only supports push notifications when:<br>";
            message += "1. The site is added to Home Screen (PWA)<br>";
            message += "2. AND opened from the Home Screen icon<br><br>";
            message +=
              "<strong>Solution:</strong> Add this site to your Home Screen, then open it from there.";
            message += "</div>";
          }

          if (statusDiv) (statusDiv as HTMLElement).innerHTML = message;
          if (btn) (btn as HTMLButtonElement).disabled = true;
          return;
        }

        const permission = Notification.permission;
        let statusClass, statusText, icon;

        switch (permission) {
          case "granted":
            statusClass = "success";
            statusText = "‚úÖ Permission granted! You can receive notifications.";
            icon = "‚úÖ";
            if (btn) {
              (btn as HTMLButtonElement).disabled = true;
              btn.textContent = "Permission Already Granted";
            }
            break;
          case "denied":
            statusClass = "error";
            statusText =
              "‚ùå Permission denied. You need to enable notifications in browser settings.";
            icon = "‚ùå";
            if (btn) {
              (btn as HTMLButtonElement).disabled = true;
              btn.textContent = "Permission Denied (Check Browser Settings)";
            }
            break;
          case "default":
            statusClass = "warning";
            statusText = "‚ö†Ô∏è Permission not yet requested. Click the button below to request it.";
            icon = "‚ö†Ô∏è";
            if (btn) (btn as HTMLButtonElement).disabled = false;
            break;
        }

        if (statusDiv)
          (statusDiv as HTMLElement).innerHTML =
            `<div class="status ${statusClass}">${statusText}</div>`;
        log(
          `Notification permission: ${permission}`,
          permission === "granted" ? "success" : permission === "denied" ? "error" : "warning"
        );
      }

      // Request permission
      async function requestPermission() {
        if (!("Notification" in window)) {
          alert("Notifications are not supported in this browser.");
          return;
        }

        try {
          const permission = await Notification.requestPermission();
          log(
            `Permission request result: ${permission}`,
            permission === "granted" ? "success" : "error"
          );
          checkPermission();

          if (permission === "granted") {
            // Send a test notification immediately
            sendTestNotification();
          }
        } catch (error) {
          log(`Error requesting permission: ${error.message}`, "error");
          alert("Error requesting permission: " + error.message);
        }
      }

      // 3. Check Service Worker
      async function checkServiceWorker() {
        const statusDiv = document.getElementById("sw-status") as HTMLElement;
        const btn = document.getElementById("register-sw-btn") as HTMLButtonElement;

        if (!("serviceWorker" in navigator)) {
          if (statusDiv)
            statusDiv.innerHTML =
              '<div class="status error">‚ùå Service Workers not supported</div>';
          if (btn) btn.disabled = true;
          return;
        }

        try {
          const registration = await navigator.serviceWorker.getRegistration();
          if (registration) {
            if (statusDiv)
              statusDiv.innerHTML =
                '<div class="status success">‚úÖ Service Worker registered</div>';
            if (btn) {
              btn.disabled = true;
              btn.textContent = "Service Worker Already Registered";
            }
            log("Service Worker: Already registered", "success");
          } else {
            if (statusDiv)
              statusDiv.innerHTML =
                '<div class="status warning">‚ö†Ô∏è No Service Worker registered. Click to register.</div>';
            if (btn) btn.disabled = false;
            log("Service Worker: Not registered", "warning");
          }
        } catch (error: any) {
          if (statusDiv)
            statusDiv.innerHTML =
              '<div class="status error">‚ùå Error checking Service Worker</div>';
          log(`Error checking Service Worker: ${error.message}`, "error");
        }
      }

      async function registerServiceWorker() {
        if (!("serviceWorker" in navigator)) {
          alert("Service Workers are not supported in this browser.");
          return;
        }

        try {
          // Campfire handles its own service worker, but we can check if it exists
          log("Attempting to register service worker...", "info");

          // For Campfire, the service worker is typically registered by Campfire itself
          // This is just for testing purposes
          const registration = await navigator.serviceWorker.register("/sw.js").catch(() => null);

          if (registration) {
            log("Service Worker registered successfully", "success");
            checkServiceWorker();
          } else {
            log(
              "Note: Campfire handles its own service worker registration. This is normal.",
              "info"
            );
            const statusDiv = document.getElementById("sw-status") as HTMLElement;
            if (statusDiv)
              statusDiv.innerHTML =
                '<div class="status info">‚ÑπÔ∏è Campfire manages its own service worker for push notifications.</div>';
          }
        } catch (error: any) {
          log(`Error registering service worker: ${error.message}`, "error");
          log(
            "Note: Campfire will register its own service worker when you open the chat.",
            "info"
          );
        }
      }

      // 4. Send test notification
      async function sendTestNotification() {
        if (!("Notification" in window)) {
          alert("Notifications are not supported in this browser.");
          return;
        }

        if (Notification.permission !== "granted") {
          alert("Please grant notification permission first.");
          requestPermission();
          return;
        }

        try {
          const notification = new Notification("üß™ Test Notification", {
            body: "This is a test notification! If you see this, push notifications are working.",
            icon: "/favicon.ico",
            badge: "/favicon.ico",
            tag: "test-notification",
            requireInteraction: false,
          });

          log("Test notification sent successfully", "success");

          notification.onclick = () => {
            log("Notification clicked", "info");
            window.focus();
            notification.close();
          };

          // Auto-close after 5 seconds
          setTimeout(() => {
            notification.close();
          }, 5000);
        } catch (error) {
          log(`Error sending notification: ${error.message}`, "error");
          alert("Error sending notification: " + error.message);
        }
      }

      // Initialize on page load
      window.addEventListener("load", () => {
        log("Page loaded - initializing tests...", "info");
        checkBrowserSupport();
        checkPermission();
        checkServiceWorker();
      });

      // Update permission status if it changes
      if ("Notification" in window) {
        // Listen for permission changes (some browsers support this)
        setInterval(checkPermission, 2000);
      }
    </script>
  </body>
</html>
