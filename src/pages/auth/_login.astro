---
// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
console.log("üîê [LOGIN] Auth check result:", {
  isAuth: authResult.isAuth,
  hasUser: !!authResult.currentUser,
  hasSession: !!authResult.session,
  hasAccessToken: !!authResult.accessToken,
  currentRole: authResult.currentRole,
  rawUser: authResult.currentUser,
  rawSession: authResult.session,
});

const { isAuth, currentUser } = authResult;

// Redirect authenticated users to dashboard
if (isAuth) {
  console.log("üîê [LOGIN] User is authenticated, redirecting to dashboard");
  return Astro.redirect("/project/dashboard");
}

console.log("üîê [LOGIN] User is not authenticated, showing login page");
console.log("üîê [LOGIN] currentUser:", currentUser);

import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses } = globalClasses();

// Check for tab query parameter
const urlParams = new URLSearchParams(Astro.url.search);
const activeTab = urlParams.get("tab") || "login";

import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import AuthForm from "../../features/forms/components/AuthForm.astro";
import Button from "../../components/common/Button.astro";
import RegisterForm from "../../features/forms/components/RegisterForm.astro";
import SimpleIcon from "../../components/common/SimpleIcon.astro";
import SlidingTabs from "../../components/common/SlidingTabs.astro";

// Get auth data for conditional rendering
---

<LayoutDefault title="Login / Register" description="Login or register to access your dashboard">
  <div class="mx-auto grid max-w-7xl grid-cols-1 px-4 py-8 md:grid-cols-12 md:py-16 lg:gap-20">
    <div class="col-span-6 w-full">
      <div class="mx-auto max-w-2xl p-4 md:p-6">
        <div class="mb-8">
          <SlidingTabs
            navId="auth-tabs"
            navClass="rounded-full border-2 border-primary text-black dark:text-white"
            activeItem={activeTab === "register" ? 1 : 0}
            urlParam="tab"
            switchHandler="switchAuthTab"
            compact={true}
            items={[
              {
                id: "tab-login",
                label: "Sign In",
                variant: "tab",
                showLabel: true,
                onclick: "window.switchAuthTab('login')",
              },
              {
                id: "tab-register",
                label: "Create Account",
                variant: "tab",
                showLabel: true,
                onclick: "window.switchAuthTab('register')",
              },
            ]}
          />
        </div>

        <!-- Login Form -->
        <div
          id="login-form"
          class={activeTab === "login" ? "auth-form-content" : "auth-form-content hidden"}
        >
          <AuthForm {globalInputClasses} />
        </div>

        <!-- Register Form -->
        <div
          id="register-form"
          class={activeTab === "register" ? "auth-form-content" : "auth-form-content hidden"}
        >
          <RegisterForm {globalInputClasses} />

          <!-- Link to Multi-Step Registration -->
          <div class="mt-6 text-center">
            <p class="text-sm text-gray-600 dark:text-gray-400">
              Prefer a guided experience?
              <a
                href="/auth/register-multi-step"
                class="font-medium text-primary-600 underline hover:text-primary-500 dark:text-primary-400"
              >
                Try our step-by-step registration
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="col-span-6 hidden md:block lg:block">
      <div class="mx-auto max-w-4xl text-center text-black dark:text-white">
        <h2 class="mb-8 text-2xl font-bold">Access Your Dashboard</h2>

        <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
          <div class="color-background rounded-lg p-6 shadow-sm">
            <div
              class="dark:bg-primary-900/30 mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-primary-100"
            >
              <SimpleIcon name="cloud-upload" />
            </div>
            <h3 class="mb-2 font-semibold">Upload Documents</h3>
            <p class="text-sm">Securely submit PDFs &amp; project documentation</p>
          </div>

          <div class="color-background rounded-lg p-6 shadow-sm">
            <div
              class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-green-100 dark:bg-green-900/30"
            >
              <SimpleIcon name="check-circle" />
            </div>
            <h3 class="mb-2 font-semibold">Track Progress</h3>
            <p class="text-sm">Monitor project statuses &amp; approval workflows</p>
          </div>

          <div class="color-background rounded-lg p-6 shadow-sm">
            <div
              class="mx-auto mb-4 flex h-12 w-12 items-center justify-center rounded-full bg-purple-100 dark:bg-purple-900/30"
            >
              <SimpleIcon name="download" />
            </div>
            <h3 class="mb-2 font-semibold">Download Files</h3>
            <p class="text-sm">Quickly access stamped project deliverables &amp; archives</p>
          </div>
        </div>

        <!-- Contact Support -->
        <div class="mt-8 space-y-4 text-center">
          <div class="text-text-secondary dark:text-text-secondary-dark text-sm">
            <p>
              Need help? <Button variant="anchor" size="sm" onclick="triggerSMSForm()"
                >Contact our support team</Button
              >
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</LayoutDefault>

<script>
  // Global function for tab switching (SlidingTabs handles indicator; this handles form visibility + URL)
  window.switchAuthTab = function (tab) {
    const loginForm = document.getElementById("login-form");
    const registerForm = document.getElementById("register-form");
    if (!loginForm || !registerForm) return;

    if (tab === "login") {
      loginForm.classList.remove("hidden");
      registerForm.classList.add("hidden");
    } else {
      loginForm.classList.add("hidden");
      registerForm.classList.remove("hidden");
    }

    const url = new URL(window.location.href);
    url.searchParams.set("tab", tab);
    window.history.replaceState({}, "", url.toString());
  };

  // Handle authentication tokens from URL hash (magic links, OAuth callbacks)
  function handleAuthTokens() {
    const hash = window.location.hash;
    if (!hash) return;

    console.log("üîê [LOGIN] Checking for auth tokens in URL hash");

    // Parse hash parameters
    const hashParams = new URLSearchParams(hash.substring(1));
    const accessToken = hashParams.get("access_token");
    const refreshToken = hashParams.get("refresh_token");
    const tokenType = hashParams.get("token_type");
    const expiresIn = hashParams.get("expires_in");
    const expiresAt = hashParams.get("expires_at");
    const type = hashParams.get("type");

    if (accessToken && refreshToken) {
      console.log("üîê [LOGIN] Found auth tokens in URL hash:", {
        hasAccessToken: !!accessToken,
        hasRefreshToken: !!refreshToken,
        tokenType,
        expiresIn,
        type,
      });

      // Send tokens to server to set session cookies
      fetch("/api/auth/callback", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          access_token: accessToken,
          refresh_token: refreshToken,
          expires_in: expiresIn,
          token_type: tokenType,
        }),
      })
        .then((response) => {
          if (response.ok) {
            console.log("‚úÖ [LOGIN] Auth tokens processed successfully");
            // Clear the hash and redirect to dashboard
            window.location.hash = "";
            window.location.href = "/dashboard";
          } else {
            console.error("‚ùå [LOGIN] Failed to process auth tokens:", response.status);
            // Show error message
            if (typeof window.showNotice === "function") {
              window.showNotice(
                "error",
                "Authentication Failed",
                "Failed to process authentication tokens. Please try again.",
                5000
              );
            }
          }
        })
        .catch((error) => {
          console.error("‚ùå [LOGIN] Error processing auth tokens:", error);
          if (typeof window.showNotice === "function") {
            window.showNotice(
              "error",
              "Authentication Error",
              "An error occurred while processing authentication. Please try again.",
              5000
            );
          }
        });
    }
  }

  document.addEventListener("DOMContentLoaded", function () {
    handleAuthTokens();
    const urlParams = new URLSearchParams(window.location.search);
    const tab = urlParams.get("tab") || "login";
    if (tab === "register") {
      window.switchAuthTab("register");
    }
  });
</script>
