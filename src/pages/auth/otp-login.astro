---
// OTP Login page

// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
const { isAuth, currentUser } = authResult;

// Redirect authenticated users to dashboard
if (isAuth) {
  console.log("üîê [OTP-LOGIN] User is authenticated, redirecting to dashboard");
  return Astro.redirect("/project/dashboard");
}

console.log("üîê [OTP-LOGIN] User is not authenticated, showing OTP login page");

import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses } = globalClasses();

import LayoutCentered from "../../components/layouts/LayoutCentered.astro";
import OTPForm from "../../components/form/OTPForm.astro";
---

<LayoutCentered
  title="OTP Login"
  description="Sign in with a one-time password sent to your email"
>
  <OTPForm {globalInputClasses} />
</LayoutCentered>
