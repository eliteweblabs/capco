---
// Multi-step registration page - Full screen

// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
console.log("üîê [REGISTER] Auth check result:", {
  isAuth: authResult.isAuth,
  hasUser: !!authResult.currentUser,
});

const { isAuth, currentUser } = authResult;

// Redirect authenticated users to dashboard
if (isAuth) {
  console.log("üîê [REGISTER] User is authenticated, redirecting to dashboard");
  return Astro.redirect("/project/dashboard");
}

console.log("üîê [REGISTER] User is not authenticated, showing registration page");

import Button from "../../components/common/Button.astro";
import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  globalCompanyLogoDark,
  globalCompanyLogoLight,
} = globalCompanyData();

import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import App from "../../components/common/App.astro";
import MultiStepRegisterForm from "../../components/form/MultiStepRegisterForm.astro";
---

<App
  title="Create Account"
  {currentUser}
  description="Create your account with our step-by-step registration"
  {globalCompanyName}
  {globalCompanySlogan}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
  {globalCompanyLogoDark}
  {globalCompanyLogoLight}
  {globalInputClasses}
  {primaryTextClasses}
  {secondaryTextClasses}
>
  <!-- Full Screen Registration -->
  <div class="fixed inset-0 flex items-center justify-center overflow-hidden">
    <div
      class="relative w-full h-full flex items-center justify-center px-4 py-8 overflow-y-auto max-w-lg"
    >
      <div class="w-full max-w-3xl">
        <form action="/api/auth/signin" method="post" class="inline-flex justify-center">
          <Button
            type="submit"
            variant="ghost"
            fullWidth
            size="md"
            name="provider"
            value="google"
            class=""
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              preserveAspectRatio="xMidYMid"
              viewBox="0 0 256 262"
              class="mr-2 inline-flex h-5 w-auto"
            >
              <path
                fill="#4285F4"
                d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"
              ></path>
              <path
                fill="#34A853"
                d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"
              ></path>
              <path
                fill="#FBBC05"
                d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"
              ></path>
              <path
                fill="#EB4335"
                d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"
              ></path>
            </svg><span class=""> Sign Up with Google </span>
          </Button>
        </form>
        <!-- Multi-step Form -->
        <MultiStepRegisterForm {globalInputClasses} />
      </div>
      <!-- Skip to Login Link - Fixed Position -->
      <div
        id="skip-to-login"
        class="absolute bottom-8 left-0 right-0 text-center z-50 pointer-events-none"
      >
        <p
          class="text-sm text-gray-600 dark:text-gray-400 bg-white/80 dark:bg-gray-900/80 backdrop-blur-sm inline-block px-6 py-3 rounded-full shadow-lg pointer-events-auto"
        >
          Already have an account?
          <a
            href="/auth/login"
            class="font-medium text-primary-600 underline hover:text-primary-500 ml-1"
          >
            Log in
          </a>
        </p>
      </div>
    </div>
  </div>
</App>

<script>
  import AOS from "aos";
  import "aos/dist/aos.css";

  // Initialize AOS
  AOS.init({
    duration: 800,
    once: false,
    offset: 0,
    easing: "ease-out",
  });
</script>

<style>
  @import "aos/dist/aos.css";
</style>
