---
// Multi-step registration page - Full screen

// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
console.log("üîê [REGISTER] Auth check result:", {
  isAuth: authResult.isAuth,
  hasUser: !!authResult.currentUser,
});

const { isAuth, currentUser } = authResult;

// Redirect authenticated users to dashboard
if (isAuth) {
  console.log("üîê [REGISTER] User is authenticated, redirecting to dashboard");
  return Astro.redirect("/project/dashboard");
}

console.log("üîê [REGISTER] User is not authenticated, showing registration page");

import Button from "../../components/common/Button.astro";
import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
} = await globalCompanyData();

import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import App from "../../components/ui/App.astro";
import { registerFormConfig } from "../../lib/forms/register-form-config";
import MultiStepForm from "../../components/form/MultiStepForm.astro";
import LayoutTwoColumn from "../../components/layouts/LayoutTwoColumn.astro";
---

<App
  title="Register A New Account"
  description="Create your account with our step-by-step registration"
  {currentUser}
  {globalCompanyName}
  {globalCompanySlogan}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
  {globalInputClasses}
  {primaryTextClasses}
  {secondaryTextClasses}
>
  <LayoutTwoColumn title="Two Column" description="Two-column layout with centered content">
    <div slot="left" class="hidden max-w-md md:block">
      <!-- <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Left panel</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Content here is centered horizontally and vertically within this panel.
      </p> -->
    </div>
    <div slot="right" class="max-w-md">
      <MultiStepForm config={registerFormConfig} initialData={{ redirect: "/project/dashboard" }} />
    </div>
  </LayoutTwoColumn>
</App>

<script>
  import { getSupabaseClient } from "../../lib/supabase-client";

  async function triggerGoogleOAuth(e?: Event) {
    if (e) e.preventDefault();
    const redirectDestination =
      (document.querySelector('input[name="redirect"]') as HTMLInputElement)?.value ||
      "/project/dashboard";
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || "";
    if (supabaseUrl) {
      const supabaseProjectRef = supabaseUrl.split("//")[1].split(".")[0];
      Object.keys(localStorage)
        .filter((k) => k.includes(`sb-${supabaseProjectRef}`) && !k.includes("code-verifier"))
        .forEach((k) => localStorage.removeItem(k));
    }
    const supabase = getSupabaseClient();
    if (!supabase) {
      if ((window as any).showNotice) {
        (window as any).showNotice("error", "Configuration Error", "Supabase is not configured.");
      }
      return;
    }
    await new Promise((r) => setTimeout(r, 200));
    const callbackUrl = `${window.location.origin}/auth/callback?redirect=${encodeURIComponent(redirectDestination)}`;
    try {
      const { error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: callbackUrl,
          queryParams: { access_type: "offline", prompt: "consent" },
        },
      });
      if (error && (window as any).showNotice) {
        (window as any).showNotice("error", "Sign In Error", error.message);
      }
    } catch (err) {
      console.error("[GOOGLE-SIGNIN]", err);
      if ((window as any).showNotice) {
        (window as any).showNotice("error", "Sign In Error", "An unexpected error occurred");
      }
    }
  }

  (window as any).handleGoogleSignup = triggerGoogleOAuth;
  document.addEventListener("auth-google-request", () => triggerGoogleOAuth());

  document.addEventListener(
    "click",
    (e) => {
      const btn = (e.target as HTMLElement).closest?.('.provider-btn[data-provider="google"]');
      if (btn && !(btn as HTMLButtonElement).disabled) {
        e.stopImmediatePropagation();
        triggerGoogleOAuth(e as Event);
      }
    },
    true
  );
</script>
