---
// Multi-step registration page - Full screen

// Handle OAuth callback if code is present (MUST be first). Preserve full query (state, redirect).
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  const query = Astro.url.search ? Astro.url.search : `?code=${encodeURIComponent(authCode)}`;
  return Astro.redirect(`/api/auth/callback${query}`);
}

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
console.log("üîê [REGISTER] Auth check result:", {
  isAuth: authResult.isAuth,
  hasUser: !!authResult.currentUser,
});

const { isAuth } = authResult;

// Redirect authenticated users to dashboard
if (isAuth) {
  console.log("üîê [REGISTER] User is authenticated, redirecting to dashboard");
  return Astro.redirect("/project/dashboard");
}

console.log("üîê [REGISTER] User is not authenticated, showing registration page");

import { getRegisterFormConfig } from "../../lib/forms/form-config-from-site";
import ConfigForm from "../../features/forms/components/ConfigForm.astro";
const registerFormConfig = await getRegisterFormConfig();
import LayoutFullForm from "../../components/layouts/LayoutFullForm.astro";
---

<LayoutFullForm
  title="Register A New Account"
  description="Create your account with our step-by-step registration"
>
  <ConfigForm config={registerFormConfig} />
</LayoutFullForm>

<script>
  document.querySelector('div[role="main"]')?.classList.remove("p-4", "md:p-8");
</script>
