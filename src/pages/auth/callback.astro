---
// Client-side OAuth callback handler for PKCE flow
// This page runs in the browser where the code verifier is stored in localStorage
import LoadingSpinner from "../../components/common/LoadingSpinner.astro";
---

<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Signing you in...</title>
    <style>
      body {
        font-family:
          system-ui,
          -apple-system,
          sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        margin: 0;
        background: #f5f5f5;
      }
      .container {
        text-align: center;
        padding: 2rem;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .error {
        color: #dc3545;
        padding: 1rem;
        background: #f8d7da;
        border-radius: 4px;
        margin-top: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <LoadingSpinner size="lg" color="primary" loadingText="Signing you in..." />
      <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
      // Use singleton Supabase client to avoid multiple instances
      import { getSupabaseClient } from "../../lib/supabase-client";

      async function handleCallback() {
        // Client-side logging (no prefix needed for browser console)
        console.log("[AUTH-CALLBACK] Environment check:", {
          hasPublicUrl: !!import.meta.env.PUBLIC_SUPABASE_URL,
          hasPublishableKey: !!import.meta.env.PUBLIC_SUPABASE_PUBLISHABLE,
        });

        // Get singleton Supabase client (prevents multiple GoTrueClient instances)
        const supabase = getSupabaseClient();

        if (!supabase) {
          showError("Supabase configuration missing");
          return;
        }

        // Give Supabase client a moment to initialize and ensure storage is ready
        // This is critical for PKCE flow where code verifier must be accessible
        await new Promise((resolve) => setTimeout(resolve, 100));

        // Verify storage is available
        if (!supabase.auth.storage) {
          console.warn("[AUTH-CALLBACK] Storage not available, waiting longer...");
          await new Promise((resolve) => setTimeout(resolve, 200));
        }

        try {
          console.log("[AUTH-CALLBACK] Starting PKCE flow...");
          console.log(
            "[AUTH-CALLBACK] Supabase client initialized with storage:",
            supabase.auth.storage ? "available" : "missing"
          );

          // Get the code from URL parameters
          const urlParams = new URLSearchParams(window.location.search);
          const code = urlParams.get("code");
          const error = urlParams.get("error");
          const errorDescription = urlParams.get("error_description");

          if (error) {
            console.error("[AUTH-CALLBACK] OAuth error:", error, errorDescription);
            showError(`Authentication failed: ${errorDescription || error}`);
            setTimeout(() => {
              window.location.href = "/auth/login?error=oauth_failed";
            }, 3000);
            return;
          }

          if (!code) {
            console.error("[AUTH-CALLBACK] No authorization code in URL");
            showError("No authorization code received");
            setTimeout(() => {
              window.location.href = "/auth/login?error=no_code";
            }, 3000);
            return;
          }

          console.log("[AUTH-CALLBACK] Exchanging code for session (client-side)...");
          console.log("[AUTH-CALLBACK] Current URL:", window.location.href);
          console.log("[AUTH-CALLBACK] Code from URL:", code);

          // Check if code verifier exists in localStorage (PKCE requirement)
          const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || "";
          if (!supabaseUrl) {
            console.error("[AUTH-CALLBACK] PUBLIC_SUPABASE_URL not configured");
            showError("Configuration error: Supabase URL not found");
            setTimeout(() => {
              window.location.href = "/auth/login?error=config_missing";
            }, 3000);
            return;
          }
          const supabaseProjectRef = supabaseUrl.split("//")[1].split(".")[0];
          const codeVerifierKey = `sb-${supabaseProjectRef}-auth-token-code-verifier`;

          // Wait for code verifier to be available (with retry logic)
          // This handles race conditions where localStorage might not be ready yet
          let codeVerifier = localStorage.getItem(codeVerifierKey);
          const maxRetries = 10;
          const retryDelay = 100; // Start with 100ms

          for (let attempt = 0; attempt < maxRetries && !codeVerifier; attempt++) {
            console.log(
              `[AUTH-CALLBACK] Waiting for code verifier (attempt ${attempt + 1}/${maxRetries})...`
            );
            await new Promise((resolve) => setTimeout(resolve, retryDelay * (attempt + 1)));
            codeVerifier = localStorage.getItem(codeVerifierKey);
          }

          console.log("[AUTH-CALLBACK] Code verifier key:", codeVerifierKey);
          console.log(
            "[AUTH-CALLBACK] Code verifier in localStorage:",
            codeVerifier ? "found" : "missing"
          );
          console.log("[AUTH-CALLBACK] Code verifier length:", codeVerifier?.length || 0);
          console.log(
            "[AUTH-CALLBACK] All localStorage keys:",
            Object.keys(localStorage).filter((k) => k.includes("supabase") || k.includes("sb-"))
          );

          // If code verifier is still missing, wait a bit more and try one more time
          // Sometimes the Supabase client needs more time to initialize its storage
          if (!codeVerifier) {
            console.warn(
              "[AUTH-CALLBACK] Code verifier still missing, waiting additional time for Supabase storage initialization..."
            );
            await new Promise((resolve) => setTimeout(resolve, 500));
            codeVerifier = localStorage.getItem(codeVerifierKey);
          }

          // Try automatic session detection first (with detectSessionInUrl: true, Supabase should handle this)
          // If that doesn't work, fall back to manual exchange
          let data, exchangeError;

          // Wait a moment for automatic detection to work
          await new Promise((resolve) => setTimeout(resolve, 100));

          // Try getting session (automatic detection)
          const { data: autoData, error: autoError } = await supabase.auth.getSession();

          if (autoData?.session && !autoError) {
            console.log("[AUTH-CALLBACK] Session detected automatically");
            data = autoData;
          } else {
            console.log("[AUTH-CALLBACK] Automatic detection failed, trying manual exchange...");
            console.log("[AUTH-CALLBACK] Auto error:", autoError?.message);

            // Manual exchange - Try with explicit code verifier if available
            // The code verifier key format is: sb-{project-ref}-auth-token-code-verifier
            if (codeVerifier) {
              console.log("[AUTH-CALLBACK] Using code verifier from localStorage");
              // Note: Supabase's exchangeCodeForSession should automatically find the verifier,
              // but if it doesn't, we might need to pass it explicitly (though the API doesn't support this)
              // So we rely on Supabase's internal retrieval
            }

            // If code verifier is missing, provide a helpful error
            if (!codeVerifier) {
              console.error("[AUTH-CALLBACK] Code verifier missing after retries");
              console.error("[AUTH-CALLBACK] This usually means:");
              console.error(
                "[AUTH-CALLBACK] 1. The OAuth flow was initiated from a different browser/tab"
              );
              console.error(
                "[AUTH-CALLBACK] 2. localStorage was cleared between OAuth initiation and callback"
              );
              console.error(
                "[AUTH-CALLBACK] 3. The Supabase client storage hasn't initialized yet"
              );

              // Try one more time after a longer wait
              console.log("[AUTH-CALLBACK] Attempting final retry after extended wait...");
              await new Promise((resolve) => setTimeout(resolve, 1000));
              codeVerifier = localStorage.getItem(codeVerifierKey);

              if (!codeVerifier) {
                exchangeError = {
                  message: "Code verifier not found. Please try signing in again.",
                  status: 400,
                } as any;
              }
            }

            if (!exchangeError) {
              const exchangeResult = await supabase.auth.exchangeCodeForSession(code);
              data = exchangeResult.data;
              exchangeError = exchangeResult.error;

              // If exchange fails with code verifier present, log detailed info
              if (exchangeError && codeVerifier) {
                console.error("[AUTH-CALLBACK] Exchange failed even with code verifier present");
                console.error("[AUTH-CALLBACK] Code length:", code.length);
                console.error("[AUTH-CALLBACK] Code verifier length:", codeVerifier.length);
                console.error("[AUTH-CALLBACK] Error:", exchangeError);
              }
            }
          }

          if (exchangeError) {
            console.error("[AUTH-CALLBACK] Session exchange error:", exchangeError);
            console.error("[AUTH-CALLBACK] Error details:", {
              message: exchangeError.message,
              status: exchangeError.status,
              code: exchangeError.code,
            });
            showError(`Session exchange failed: ${exchangeError.message}`);
            setTimeout(() => {
              window.location.href = "/auth/login?error=session_exchange_failed";
            }, 3000);
            return;
          }

          if (!data?.session) {
            console.error("[AUTH-CALLBACK] No session created");
            showError("No session created");
            setTimeout(() => {
              window.location.href = "/auth/login?error=no_session";
            }, 3000);
            return;
          }

          console.log("[AUTH-CALLBACK] Session created successfully:", {
            userId: data.user?.id,
            email: data.user?.email,
          });

          // Send session tokens to server to set cookies
          console.log("[AUTH-CALLBACK] Sending tokens to server...");
          const response = await fetch("/api/auth/callback", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            credentials: "include", // Ensure cookies are sent and received
            body: JSON.stringify({
              access_token: data.session.access_token,
              refresh_token: data.session.refresh_token,
              expires_in: data.session.expires_in,
              token_type: data.session.token_type || "bearer",
            }),
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error("[AUTH-CALLBACK] Server callback error:", response.status, errorText);
            showError("Failed to set authentication cookies");
            setTimeout(() => {
              window.location.href = "/auth/login?error=cookie_set_failed";
            }, 3000);
            return;
          }

          console.log("[AUTH-CALLBACK] Authentication successful, redirecting to dashboard...");
          console.log("[AUTH-CALLBACK] Response status:", response.status);
          console.log(
            "[AUTH-CALLBACK] Response headers:",
            Object.fromEntries(response.headers.entries())
          );

          // Small delay to ensure cookies are set before redirect
          // This is especially important for localhost development
          // Increased delay to ensure browser has time to process Set-Cookie headers
          await new Promise((resolve) => setTimeout(resolve, 300));

          // Use replace instead of href to ensure proper navigation with cookies
          // This ensures the browser includes cookies in the redirect
          window.location.replace("/project/dashboard");
        } catch (err) {
          console.error("[AUTH-CALLBACK] Unexpected error:", err);
          showError(`Unexpected error: ${err instanceof Error ? err.message : "Unknown error"}`);
          setTimeout(() => {
            window.location.href = "/auth/login?error=unexpected_error";
          }, 3000);
        }
      }

      function showError(message: string) {
        const errorDiv = document.getElementById("error");
        if (errorDiv) {
          errorDiv.textContent = message;
          errorDiv.style.display = "block";
        }
      }

      // Handle callback when page loads
      handleCallback();
    </script>
  </body>
</html>
