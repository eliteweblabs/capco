---
// Password reset page (set new password after clicking email link)
// Layout and structure similar to auth/login

import { checkAuth } from "../../lib/auth";
const authResult = await checkAuth(Astro.cookies);
const { isAuth, currentUser } = authResult;

// Allow page to render so user can set new password from recovery link
// (recovery session is set when they land with hash, then we sync to cookies client-side)

import LayoutCentered from "../../components/layouts/LayoutCentered.astro";
import MultiStepForm from "../../components/form/MultiStepForm.astro";
import { resetFormConfig } from "../../lib/forms/reset-form-config";
---

<LayoutCentered title="Reset Password" description="Set a new password for your account">
  <MultiStepForm config={resetFormConfig} />

  <script>
    import { getSupabaseClient } from "../../lib/supabase-client";

    document.addEventListener("DOMContentLoaded", async () => {
      const form = document.getElementById("multi-step-reset-form");
      if (!form) return;

      const hash = window.location.hash;
      const hasRecoveryParams =
        hash && (hash.includes("access_token=") || hash.includes("type=recovery"));

      // If user landed with recovery link, sync session to cookies so form POST has session
      if (hasRecoveryParams) {
        const supabase = getSupabaseClient();
        if (supabase) {
          await new Promise((r) => setTimeout(r, 500));
          const {
            data: { session },
          } = await supabase.auth.getSession();
          if (session) {
            const res = await fetch("/api/auth/callback", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              credentials: "include",
              body: JSON.stringify({
                access_token: session.access_token,
                refresh_token: session.refresh_token,
                expires_in: session.expires_in,
                token_type: session.token_type || "bearer",
              }),
            });
            if (res.ok) {
              console.log("[AUTH-RESET] Session synced to cookies");
            }
          }
        }
      }

      // Client-side confirm password match before submit (API also validates)
      form.addEventListener(
        "submit",
        (e) => {
          const password = (form.querySelector('input[name="password"]'))
            ?.value;
          const passwordConfirm = (
            form.querySelector('input[name="passwordConfirm"]')
          )?.value;
          if (password && passwordConfirm && password !== passwordConfirm) {
            e.preventDefault();
            e.stopPropagation();
            if (window.showNotice) {
              window.showNotice(
                "error",
                "Passwords don't match",
                "Please make sure both password fields match.",
                5000
              );
            }
          }
        },
        true
      );
    });

    // Handle error/message from URL
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const error = urlParams.get("error");
      const message = urlParams.get("message");
      if (error && window.showNotice) {
        window.showNotice("error", "Error", message || error, 6000);
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    });
  </script>
</LayoutCentered>
