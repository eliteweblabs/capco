---
// CRITICAL: Run redirects BEFORE any layout renders to avoid ResponseSentError.
// App.astro (via LayoutTwoColumn) starts sending the response; LoginForm runs in a
// slot after that, so redirects there come too late.
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

let redirectUrl = Astro.url.searchParams.get("redirect") || "/project/dashboard";
const authPages = ["/auth/login", "/auth/callback", "/auth/register", "/auth/reset"];
if (authPages.some((p) => redirectUrl.startsWith(p))) {
  redirectUrl = "/project/dashboard";
}

import { checkAuth } from "../../lib/auth";
const { isAuth } = await checkAuth(Astro.cookies);
if (isAuth) {
  return Astro.redirect(redirectUrl);
}

import LoginForm from "../../features/forms/components/LoginForm.astro";
import LayoutFullForm from "../../components/layouts/LayoutFullForm.astro";
---

<LayoutFullForm title="Login / Register" description="Login or register to access your dashboard">
  <LoginForm redirectUrl={redirectUrl} />
</LayoutFullForm>
{/* Inline fallback: if module never loads, send to same page with provider=google so a refresh may run the module. Avoids server-side google-start which has no code_verifier in browser and breaks callback. */}
<script is:inline define:vars={{ redirectUrl }}>
  (function () {
    function fallbackGoogleSignup() {
      var dest = (document.querySelector('input[name="redirect"]') && document.querySelector('input[name="redirect"]').value) || redirectUrl || '/project/dashboard';
      window.location.href = '/auth/login?provider=google&redirect=' + encodeURIComponent(dest);
    }
    window.handleGoogleSignup = fallbackGoogleSignup;
    document.addEventListener('click', function (e) {
      var btn = e.target && e.target.closest && e.target.closest('.provider-btn[data-provider="google"]');
      if (btn && !btn.disabled) {
        e.stopImmediatePropagation();
        fallbackGoogleSignup();
      }
    }, true);
  })();
</script>
<!-- Load login script by src so it gets its own chunk (avoids Astro 5 empty page-script chunk). Replaces handleGoogleSignup with full client-side OAuth (window.location.origin). -->
<script src="../../features/forms/components/login-form-client.ts"></script>
