---
// CRITICAL: Run redirects BEFORE any layout renders to avoid ResponseSentError.
// App.astro (via LayoutTwoColumn) starts sending the response; LoginForm runs in a
// slot after that, so redirects there come too late.
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

let redirectUrl = Astro.url.searchParams.get("redirect") || "/project/dashboard";
const authPages = ["/auth/login", "/auth/callback", "/auth/register", "/auth/reset"];
if (authPages.some((p) => redirectUrl.startsWith(p))) {
  redirectUrl = "/project/dashboard";
}

import { checkAuth } from "../../lib/auth";
const { isAuth } = await checkAuth(Astro.cookies);
if (isAuth) {
  return Astro.redirect(redirectUrl);
}

import LayoutTwoColumn from "../../components/layouts/LayoutTwoColumn.astro";
import DotGrid from "../../components/ui/DotGrid.astro";
import LoginForm from "../../features/forms/components/LoginForm.astro";
---

<LayoutTwoColumn
  title="Login / Register"
  description="Login or register to access your dashboard"
  ratio="2/3"
  hideFooter={true}
>
  <div slot="left" class="hidden md:block">
    <DotGrid
      id="dotGrid"
      class="absolute inset-0 -z-10 min-h-full w-full"
      spacing="1rem"
      baseOpacity={0.35}
      dotColor="primary-500"
    />
  </div>
  <div slot="right" class="">
    <LoginForm redirectUrl={redirectUrl} />
  </div>
</LayoutTwoColumn>
