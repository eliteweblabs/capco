---
// CRITICAL: Run redirects BEFORE any layout renders to avoid ResponseSentError.
// App.astro (via LayoutTwoColumn) starts sending the response; LoginForm runs in a
// slot after that, so redirects there come too late.
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  // Preserve full URL (state, redirect, etc.) so PKCE and post-login redirect work
  const query = Astro.url.search ? Astro.url.search : `?code=${encodeURIComponent(authCode)}`;
  return Astro.redirect(`/api/auth/callback${query}`);
}

let redirectUrl = Astro.url.searchParams.get("redirect") || "/project/dashboard";
const authPages = ["/auth/login", "/auth/callback", "/auth/register", "/auth/reset"];
if (authPages.some((p) => redirectUrl.startsWith(p))) {
  redirectUrl = "/project/dashboard";
}

import { checkAuth } from "../../lib/auth";
const { isAuth } = await checkAuth(Astro.cookies);
if (isAuth) {
  return Astro.redirect(redirectUrl);
}

import LoginForm from "../../features/forms/components/LoginForm.astro";
import LayoutFullForm from "../../components/layouts/LayoutFullForm.astro";
import SimpleIcon from "../../components/common/SimpleIcon.astro";

const id = "login-form";
---

<LayoutFullForm title="Login / Register" description="Login or register to access your dashboard">
  <div id={id} class="relative flex min-h-[300px] flex-col pb-24">
    <div class="mb-8 flex-1">
      <LoginForm redirectUrl={redirectUrl} />
    </div>
    {/* Fallback: ensure sign-in at least validates when main form script has not inited */}
    <script is:inline>
      (function () {
        function initLoginFallback() {
          var form = document.querySelector("main form[data-form-config]");
          if (!form || form.getAttribute("data-standard-form-inited") === "1") return;
          if (form.getAttribute("data-login-fallback-inited") === "1") return;
          form.setAttribute("data-login-fallback-inited", "1");
          var formId = form.id || "login-form";
          var alertId = formId + "-response-alert";
          form.addEventListener(
            "submit",
            function (e) {
              if (form.getAttribute("data-standard-form-inited") === "1") return;
              form.querySelectorAll("input[required]").forEach(function (input) {
                input.classList.add("touched");
              });
              if (!form.checkValidity()) {
                e.preventDefault();
                e.stopPropagation();
                form.reportValidity();
                var firstInvalid = form.querySelector("input:invalid, textarea:invalid");
                var alertEl = document.getElementById(alertId);
                if (alertEl && firstInvalid) {
                  var msg = firstInvalid.getAttribute("data-error") || firstInvalid.validationMessage || "Please fill in this field correctly";
                  alertEl.className = "w-full p-2 mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800";
                  alertEl.innerHTML =
                    '<div class="flex items-start">' +
                    '<svg class="mr-2 mt-0.5 h-5 w-5 shrink-0 text-red-800 dark:text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>' +
                    '<div class="mr-8 flex-1 text-base text-red-800 dark:text-red-400">' +
                    msg.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;") +
                    "</div></div>";
                  alertEl.classList.remove("hidden");
                }
              }
            },
            true
          );
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initLoginFallback);
        } else {
          initLoginFallback();
        }
        setTimeout(initLoginFallback, 200);
      })();
    </script>
    <div class="bottom-0 left-0 right-0 flex border-t border-gray-200 pt-3 dark:border-gray-700">
      <a
        href="/auth/forgot-password"
        class="flex w-1/2 flex-col items-center justify-center gap-2 rounded-lg py-3 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
        title="Forgot password?"
      >
        <SimpleIcon name="key" size="lg" class="text-gray-500 dark:text-gray-400" />
        <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Forgot password?</span>
      </a>
      <a
        href="/auth/register"
        class="flex w-1/2 flex-col items-center justify-center gap-2 rounded-lg py-3 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
        title="Need an account? Register"
      >
        <SimpleIcon name="user-plus" size="lg" class="text-gray-500 dark:text-gray-400" />
        <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Register</span>
      </a>
    </div>
  </div>
</LayoutFullForm>
