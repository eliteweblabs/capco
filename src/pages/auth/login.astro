---
// Multi-step registration page - Full screen

// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Get redirect parameter to send user back after login
const redirectUrl = Astro.url.searchParams.get("redirect") || "/project/dashboard";

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
console.log("üîê [LOGIN] Auth check result:", {
  isAuth: authResult.isAuth,
  hasUser: !!authResult.currentUser,
  redirectUrl,
});

const { isAuth, currentUser } = authResult;

// Redirect authenticated users to specified URL or dashboard
if (isAuth) {
  console.log("üîê [LOGIN] User is authenticated, redirecting to:", redirectUrl);
  return Astro.redirect(redirectUrl);
}

console.log("üîê [LOGIN] User is not authenticated, showing login page");

import LayoutTwoColumn from "../../components/layouts/LayoutTwoColumn.astro";
import MultiStepForm from "../../components/form/MultiStepForm.astro";
import Button from "../../components/common/Button.astro";
import { loginFormConfig } from "../../lib/forms/login-form-config";
import DotGrid from "../../components/ui/DotGrid.astro";
---

<LayoutTwoColumn
  title="Login / Register"
  description="Login or register to access your dashboard"
  ratio="2/3"
  hideFooter={true}
>
  <div slot="left" class="hidden max-w-md md:block">
    <DotGrid
      id="dotGrid"
      class="absolute inset-0 -z-10 min-h-full w-full"
      spacing="1rem"
      baseOpacity={0.35}
      dotColor="primary-500"
    />
  </div>
  <div slot="right" class="color-background max-w-md" data-redirect-url={redirectUrl}>
    <!-- Fallback: if user somehow lands here already logged in (e.g. session in another tab) -->
    <div id="login-already-authenticated" class="hidden">
      <div class="flex flex-col items-center gap-4 rounded-lg border border-primary-200 bg-primary-50/50 p-6 dark:border-primary-700 dark:bg-primary-900/20">
        <p class="text-center text-sm text-primary-700 dark:text-primary-300">You're already logged in.</p>
        <Button href={redirectUrl} variant="secondary" size="md" icon="arrow-right" iconPosition="right">
          Go to Dashboard
        </Button>
      </div>
    </div>
    <div id="login-form-wrapper">
      <MultiStepForm
        config={loginFormConfig}
        initialData={{ redirect: redirectUrl }}
        containerClass="max-w-md"
        testNoCascade={true}
      />
    </div>
  </div>
</LayoutTwoColumn>

<!-- <LayoutCentered
    title="Login / Register"
    description="Login or register to access your dashboard"
    {currentUser}
  >
    <MultiStepForm config={loginFormConfig} initialData={{ redirect: redirectUrl }} />
  </LayoutCentered> -->

<!-- Multi-step Form -->

<script>
  // Use singleton Supabase client to avoid multiple instances
  import { getSupabaseClient } from "../../lib/supabase-client";

  // Fallback: if user is already logged in (e.g. session synced from another tab), hide form and show redirect
  document.addEventListener("DOMContentLoaded", async () => {
    const supabase = getSupabaseClient();
    if (supabase) {
      const {
        data: { session },
      } = await supabase.auth.getSession();
      if (session) {
        const formWrapper = document.getElementById("login-form-wrapper");
        const alreadyAuth = document.getElementById("login-already-authenticated");
        const redirectUrl =
          document.querySelector('[data-redirect-url]')?.getAttribute("data-redirect-url") ||
          "/project/dashboard";
        if (formWrapper && alreadyAuth) {
          formWrapper.classList.add("hidden");
          alreadyAuth.classList.remove("hidden");
          const btn = alreadyAuth.querySelector('a[href]');
          if (btn) btn.setAttribute("href", redirectUrl);
        } else {
          window.location.href = redirectUrl;
        }
        return;
      }
    }

    const urlParams = new URLSearchParams(window.location.search);
    const provider = urlParams.get("provider");
    if (provider === "google") {
      window.history.replaceState({}, document.title, "/auth/login");
      triggerGoogleOAuth();
      return;
    }

    // Check for error in URL params and show notification
    const error = urlParams.get("error");
    const message = urlParams.get("message");

    if (error && (window as any).showNotice) {
      let errorTitle = "Authentication Error";
      let errorMessage = message || "An error occurred during authentication";

      // Custom messages for known error types
      switch (error) {
        case "oauth_failed":
          errorMessage = "OAuth authentication failed. Please try again.";
          break;
        case "access_denied":
          errorMessage = "Access was denied. You may have cancelled the authentication process.";
          break;
        case "no_code":
          errorMessage = "No authorization code received from provider.";
          break;
        case "session_exchange_failed":
          errorMessage = "Failed to complete authentication. Please try again.";
          break;
        case "session_expired":
          errorMessage = message || "Your session has expired. Please sign in again.";
          break;
        case "cookie_set_failed":
          errorMessage =
            "Failed to set authentication cookies. Please check your browser settings.";
          break;
        case "unexpected_error":
          errorMessage = "An unexpected error occurred. Please try again.";
          break;
      }

      (window as any).showNotice({
        type: "error",
        title: errorTitle,
        message: errorMessage,
        persist: true,
      });

      // Clean up URL
      window.history.replaceState({}, document.title, window.location.pathname);
    }
  });

  // Extract OAuth initiation logic into a reusable function
  async function triggerGoogleOAuth(e?: Event) {
    if (e) {
      e.preventDefault();
    }

    console.log("[GOOGLE-SIGNIN] Initiating client-side OAuth...");

    // Get the redirect destination from hidden input in the MultiStepForm
    const redirectDestination =
      (document.querySelector('input[name="redirect"]') as HTMLInputElement)?.value ||
      "/project/dashboard";
    console.log("[GOOGLE-SIGNIN] Post-auth redirect destination:", redirectDestination);

    // CRITICAL: Clear any stale auth state before starting new OAuth flow
    const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL || "";
    if (supabaseUrl) {
      const supabaseProjectRef = supabaseUrl.split("//")[1].split(".")[0];
      const staleKeys = Object.keys(localStorage).filter(
        (k) => k.includes(`sb-${supabaseProjectRef}`) && !k.includes("code-verifier")
      );
      if (staleKeys.length > 0) {
        console.log("[GOOGLE-SIGNIN] Clearing stale auth state before OAuth:", staleKeys);
        staleKeys.forEach((k) => localStorage.removeItem(k));
      }
    }

    // Get singleton Supabase client
    const supabase = getSupabaseClient();

    if (!supabase) {
      console.error("[GOOGLE-SIGNIN] Supabase configuration missing");
      if (window.showNotice) {
        window.showNotice(
          "error",
          "Configuration Error",
          "Supabase is not configured. Please contact support."
        );
      }
      return;
    }

    // Ensure Supabase client is fully initialized
    await new Promise((resolve) => setTimeout(resolve, 200));

    const callbackUrl = `${window.location.origin}/auth/callback?redirect=${encodeURIComponent(redirectDestination)}`;
    console.log("[GOOGLE-SIGNIN] Callback URL:", callbackUrl);

    try {
      const { data, error } = await supabase.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: callbackUrl,
          queryParams: {
            access_type: "offline",
            prompt: "consent",
          },
        },
      });

      if (error) {
        console.error("[GOOGLE-SIGNIN] OAuth error:", error);
        if (window.showNotice) {
          window.showNotice("error", "Sign In Error", error.message);
        }
      } else {
        console.log("[GOOGLE-SIGNIN] OAuth initiated successfully");
      }
    } catch (err) {
      console.error("[GOOGLE-SIGNIN] Unexpected error:", err);
      if (window.showNotice) {
        window.showNotice("error", "Sign In Error", "An unexpected error occurred");
      }
    }
  }

  // Make OAuth trigger available globally for AuthProviders (in case this script runs first)
  (window as any).handleGoogleSignup = triggerGoogleOAuth;

  // Fallback: listen for custom event so Google sign-in works even if script order is wrong
  document.addEventListener("auth-google-request", () => triggerGoogleOAuth());

  // Direct delegation: clicking the Google provider button always triggers OAuth from this page
  document.addEventListener(
    "click",
    (e) => {
      const btn = (e.target as HTMLElement).closest?.('.provider-btn[data-provider="google"]');
      if (btn && !(btn as HTMLButtonElement).disabled) {
        e.stopImmediatePropagation();
        triggerGoogleOAuth(e as Event);
      }
    },
    true
  );
</script>
