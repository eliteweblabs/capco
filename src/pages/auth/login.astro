---
// Multi-step registration page - Full screen

// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Get auth data directly
import { checkAuth } from "../../lib/auth";

const authResult = await checkAuth(Astro.cookies);
console.log("üîê [REGISTER] Auth check result:", {
  isAuth: authResult.isAuth,
  hasUser: !!authResult.currentUser,
});

const { isAuth, currentUser } = authResult;

// Redirect authenticated users to dashboard
if (isAuth) {
  console.log("üîê [REGISTER] User is authenticated, redirecting to dashboard");
  return Astro.redirect("/project/dashboard");
}

console.log("üîê [REGISTER] User is not authenticated, showing registration page");

import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  globalCompanyLogoDark,
  globalCompanyLogoLight,
} = globalCompanyData();

import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import App from "../../components/common/App.astro";
import AuthForm from "../../components/form/AuthForm.astro";
---

<App
  title="Create Account"
  {currentUser}
  description="Create your account with our step-by-step registration"
  {globalCompanyName}
  {globalCompanySlogan}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
  {globalCompanyLogoDark}
  {globalCompanyLogoLight}
  {globalInputClasses}
  {primaryTextClasses}
  {secondaryTextClasses}
>
  <!-- Full Screen Registration -->
  <div class="fixed inset-0 flex items-center justify-center">
    <div class="relative w-full flex items-center justify-center px-4 py-8 max-w-lg">
      <div class="w-full max-w-3xl">
        <!-- Multi-step Form -->
        <AuthForm {globalInputClasses} />
      </div>
      <!-- Skip to Login Link - Fixed Position -->
    </div>
  </div>
</App>

<script>
  import AOS from "aos";
  import "aos/dist/aos.css";

  // Initialize AOS
  AOS.init({
    duration: 800,
    once: false,
    offset: 0,
    easing: "ease-out",
  });
</script>

<style>
  @import "aos/dist/aos.css";
</style>
