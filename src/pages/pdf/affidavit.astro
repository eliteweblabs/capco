---
import BoxIcon from "../../components/common/BoxIcon.astro";
// import DigitalSignature from "../../components/DigitalSignature.astro";

export const prerender = false;

// Get project data from URL params or query
const projectId = Astro.url.searchParams.get("projectId");
const mode = Astro.url.searchParams.get("mode");
const title = Astro.url.searchParams.get("title");
const address = Astro.url.searchParams.get("address");
const owner = Astro.url.searchParams.get("owner");
const new_construction = Astro.url.searchParams.get("new_construction");
const architect = Astro.url.searchParams.get("architect");
const description = Astro.url.searchParams.get("description");
const sq_ft = Astro.url.searchParams.get("sq_ft");
const status = Astro.url.searchParams.get("status");

// This page can be used for PDF generation or preview
const isPdfMode = mode === "pdf";
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
      Affidavit - {title || address || `Project ${projectId}`}
    </title>

    <!-- PDF-optimized styles -->
    <style>
      @page {
        margin: 0.5in;
        size: letter;
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: "Times New Roman", serif;
        line-height: 1.6;
        color: #000;
        background: white;
        margin: 0;
        padding: 20px;
        font-size: 12pt;
      }

      .header {
        text-align: center;
        border-bottom: 2px solid #000;
        padding-bottom: 20px;
        margin-bottom: 30px;
      }

      .header h1 {
        margin: 0;
        font-size: 24pt;
        font-weight: bold;
      }

      .header h2 {
        margin: 10px 0 0 0;
        font-size: 16pt;
        color: #666;
      }

      .section {
        margin-bottom: 30px;
        page-break-inside: avoid;
      }

      .section-title {
        font-size: 16pt;
        font-weight: bold;
        border-bottom: 1px solid #ccc;
        padding-bottom: 5px;
        margin-bottom: 15px;
      }

      .field-group {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 15px;
      }

      .field {
        flex: 1;
        min-width: 200px;
      }

      .field label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }

      .field-value {
        border-bottom: 1px solid #000;
        min-height: 25px;
        padding: 5px 0;
      }

      .terms {
        font-size: 11pt;
        line-height: 1.5;
        margin: 20px 0;
      }

      .signature-section {
        margin-top: 50px;
        page-break-inside: avoid;
      }

      .signature-row {
        display: flex;
        justify-content: space-between;
        margin: 40px 0;
        gap: 40px;
      }

      .signature-block {
        flex: 1;
        text-align: center;
      }

      .signature-line {
        border-bottom: 1px solid #000;
        margin: 20px 0 10px 0;
        height: 80px;
        position: relative;
      }

      .signature-label {
        font-weight: bold;
        margin-top: 10px;
      }

      .date-line {
        border-bottom: 1px solid #000;
        width: 150px;
        margin: 20px auto 10px auto;
        height: 25px;
      }

      /* .footer {
        position: fixed;
        bottom: 0.5in;
        left: 0.5in;
        right: 0.5in;
        text-align: center;
        font-size: 10pt;
        color: #666;
        border-top: 1px solid #ccc;
        padding-top: 10px;
      } */

      /* Print-specific styles */
      @media print {
        body {
          padding: 0;
        }

        .no-print {
          display: none !important;
        }

        .signature-section {
          page-break-before: auto;
        }
      }

      /* Hide signature controls in PDF mode */
      .pdf-mode .digital-signature-container button {
        display: none;
      }

      .pdf-mode .signature-status {
        display: none;
      }
    </style>
  </head>

  <body class={isPdfMode ? "pdf-mode" : ""}>
    <!-- Document Header -->
    <div class="header mx-auto flex max-w-xl flex-col items-center">
      <img
        src="../src/assets/mass-logo-for-affidavit.png"
        alt="Massachusetts Logo"
        class="logo w-20"
      />
      <h1>Initial Construction Control Document</h1>
      <h2>
        To be submitted with the building permit application by a Registered Design Professional for
        work per the 10<sup>th</sup> edition of the Massachusetts State Building Code, 780 CMR, Section
        107.6.2
      </h2>
    </div>
  </body>

  <!-- Project Information -->
  <div class="section">
    <div class="field-group">
      <div class="field">
        <label>Project Title:</label>
        <div class="field-value">{address || "TBD"}</div>
      </div>
      <div class="field">
        <label>Date:</label>
        <div class="field-value">{title || "TBD"}</div>
      </div>
    </div>

    <div class="field-group">
      <div class="field">
        <label>Project Address:</label>
        <div class="field-value">{address || "TBD"}</div>
      </div>
      <div class="field">
        <label>New Construction:</label>
        <div class="field-value">{new_construction || "TBD"}</div>
      </div>
    </div>

    <div class="field-group">
      <div class="field">
        <label>Owner:</label>
        <div class="field-value">{owner || "TBD"}</div>
      </div>
      <div class="field">
        <label>Architect:</label>
        <div class="field-value">{architect || "TBD"}</div>
      </div>
    </div>
  </div>

  <!-- Terms and Conditions -->
  <div class="section">
    <!-- <h3 class="section-title">Terms and Conditions</h3> -->
    <div class="terms">
      <p>
        for the above-named project and that such plans, computations, and specifications meet the
        applicable provisions of the Massachusetts State Building Code, (780 CMR), and accepted
        engineering practices for the proposed project. I understand and agree that I ( or my
        designee) shall perform the necessary professional services and be present on the
        construction site on a regular and periodic basis to:
        <ol class="my-4 ml-4 list-inside list-decimal">
          <li>
            Review, for conformance to this code and the design concept, shop drawings, samples, and
            other submittals by the contractor in accordance with the requirements of the
            construction documents.
          </li>
          <li>
            Perform the duties of registered design professionals in 780 CMR Chapter 17, as
            applicable.
          </li>
          <li>
            Be present at intervals appropriate to the stage of construction to become generally
            familiar with the progress and quality of the work and to determine if the work is being
            performed in a manner consistent with the approved construction documents and this code.
          </li>
        </ol>

        When required by the building official, I shall submit field/progress reports (see item 3.)
        together with pertinent comments, in a form acceptable to the building official. Upon
        completion of the work, I shall submit to the building official a 'Final Construction
        Control Document'.
      </p>
    </div>
  </div>

  <!-- Project Information -->
  <div class="section">
    <div class="field-group">
      <div class="field">
        <label>Phone:</label>
        <div class="field-value">{address || "TBD"}</div>
      </div>
      <div class="field">
        <label>Email:</label>
        <div class="field-value">{title || "TBD"}</div>
      </div>
    </div>
  </div>

  <!-- Document Footer -->
  <div class="footer">
    <p>
      This document was generated on {new Date().toLocaleDateString()} | Project ID: {
        projectId || "TBD"
      }
    </p>
  </div>

  <!-- Form submission (only in non-PDF mode) -->
  {
    !isPdfMode && (
      <div
        class="no-print"
        style="margin-top: 50px; padding: 20px; background: #f5f5f5; border-radius: 8px;"
      >
        <button
          id="generate-pdf-btn"
          type="button"
          class="rounded-lg bg-blue-600 px-6 py-3 font-medium text-white transition-colors hover:bg-blue-700"
        >
          <BoxIcon name="download" class="mr-2" />
          Generate PDF Document
        </button>
      </div>
    )
  }

  <script type="module">
    // PDF generation functionality
    document.addEventListener("DOMContentLoaded", () => {
      const generatePdfBtn = document.getElementById("generate-pdf-btn");
      const saveDraftBtn = document.getElementById("save-draft-btn");

      generatePdfBtn?.addEventListener("click", async () => {
        // Validate signatures
        const clientSigEmpty = window.digitalSignatureManager?.isSignatureEmpty("client-signature");
        const consultantSigEmpty =
          window.digitalSignatureManager?.isSignatureEmpty("consultant-signature");

                  if (clientSigEmpty || consultantSigEmpty) {
            if (window.showError) {
              window.showError("Missing Signatures", "Please complete both client and consultant signatures before generating PDF.", 0);
            } else {
              console.error("ðŸ”” [Missing Signatures] Please complete both client and consultant signatures before generating PDF.");
            }
            return;
          }

        // Get signature data
        const signatures = window.digitalSignatureManager?.getAllSignatures() || {};

        // Generate PDF
        try {
          generatePdfBtn.disabled = true;
          generatePdfBtn.innerHTML =
            '<i class="bx bx-loader-alt bx-spin mr-2"></i>Generating PDF...';

          const response = await fetch("/api/generate-pdf", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              templateUrl:
                window.location.href +
                (window.location.href.includes("?") ? "&" : "?") +
                "mode=pdf",
              signatures: signatures,
              projectData: {
                projectId: new URLSearchParams(window.location.search).get("projectId"),
                title: new URLSearchParams(window.location.search).get("title"),
                address: new URLSearchParams(window.location.search).get("address"),
              },
            }),
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `project-agreement-${new URLSearchParams(window.location.search).get("projectId") || "draft"}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);

            if (window.showSuccess) {
              window.showSuccess("PDF Generated", "Project agreement PDF has been generated and downloaded.", 5000);
            } else {
              console.log("ðŸ”” [PDF Generated] Project agreement PDF has been generated and downloaded.");
            }
          } else {
            throw new Error("Failed to generate PDF");
          }
        } catch (error) {
          console.error("PDF generation error:", error);
          if (window.showError) {
            window.showError("PDF Generation Failed", "There was an error generating the PDF. Please try again.", 0);
          } else {
            console.error("ðŸ”” [PDF Generation Failed] There was an error generating the PDF. Please try again.");
          }
        } finally {
          generatePdfBtn.disabled = false;
          generatePdfBtn.innerHTML = '<i class="bx bx-download mr-2"></i>Generate PDF Document';
        }
      });

      saveDraftBtn?.addEventListener("click", () => {
        // Save draft functionality
        const signatures = window.digitalSignatureManager?.getAllSignatures() || {};
        localStorage.setItem("pdf-draft-signatures", JSON.stringify(signatures));

        if (window.showSuccess) {
          window.showSuccess("Draft Saved", "Document draft has been saved locally.", 3000);
        } else {
          console.log("ðŸ”” [Draft Saved] Document draft has been saved locally.");
        }
      });

      // Load draft if available
      const savedSignatures = localStorage.getItem("pdf-draft-signatures");
      if (savedSignatures) {
        try {
          const signatures = JSON.parse(savedSignatures);
          // Note: Would need additional logic to restore signatures to canvas
          console.log("Draft signatures available:", signatures);
        } catch (error) {
          console.error("Error loading draft:", error);
        }
      }
    });
  </script>
</html>
