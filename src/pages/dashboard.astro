---
import App from "../components/common/App.astro";
import DashboardComponent from "../components/common/Dashboard.astro";
import SectionContainer from "../components/common/SectionContainer.astro";
import ProjectNav from "../components/project/ProjectNav.astro";
import HeroDashboard from "../components/common/HeroDashboard.astro";
import "../lib/refresh-manager.ts";
// Get auth data directly since App component handles auth requirements
import { checkAuth } from "../lib/auth";
import { supabase } from "../lib/supabase";
import { supabaseAdmin } from "../lib/supabase-admin";

const { isAuth = false, currentUser, currentRole, session } = await checkAuth(Astro.cookies);

// Initialize data arrays
let projects: any[] = [];
let project_statuses: any[] = [];
let project_statuses_object: any = {};

// Import all functions at the top level
import { fetchProjects, getProjectsByAuthor, getProjectsByAssignedToId } from "../lib/api/projects";

// Fetch projects based on user role
if (supabaseAdmin && currentUser?.id) {
  try {
    if (currentRole === "Client") {
      projects = await getProjectsByAuthor(supabaseAdmin, currentUser.id);
    } else if (currentRole === "Staff") {
      projects = await getProjectsByAssignedToId(supabaseAdmin, currentUser.id);
    } else if (currentRole === "Admin") {
      projects = await fetchProjects(supabaseAdmin);
    }
  } catch (error) {
    console.error("üèóÔ∏è [DASHBOARD] Error fetching projects:", error);
  }
}

import type { ProjectStatus } from "../lib/types/project-status";
import { fetchProjectStatuses } from "../lib/api/project-statuses";
import { processProjectStatuses } from "../lib/api/project-statuses";

// Fetch project statuses
if (supabaseAdmin) {
  try {
    const { statuses, statusesMap } = await fetchProjectStatuses(supabaseAdmin);
    project_statuses = statuses as ProjectStatus[];
    project_statuses_object = processProjectStatuses(statuses, currentRole || "Client");
  } catch (error) {
    console.error("üèóÔ∏è [DASHBOARD] Error fetching statuses:", error);
  }
}
---

<App
  title="Global Dashboard - CAPCo Fire Protection"
  description="View all projects."
  requireAuth={true}
  requireRole={currentRole || "Client"}
  isAuth={isAuth}
  currentUser={currentUser}
  currentRole={currentRole || "Client"}
  session={session}
>
  <HeroDashboard
    title="Project Dashboard"
    description={currentRole === "Client"
      ? "Manage and track your fire protection projects"
      : "Manage and track all fire protection projects"}
  />

  <ProjectNav
    currentRole={currentRole || "Client"}
    projects={projects}
    statuses={project_statuses}
  />

  <DashboardComponent
    projects={projects}
    project_statuses={project_statuses}
    project_statuses_object={project_statuses_object}
    currentUser={currentUser}
    currentRole={currentRole}
  />
</App>

<script>
  // Data is now loaded in front matter, no need for client-side API calls
  console.log("üèóÔ∏è [DASHBOARD] Dashboard loaded with data from front matter");
</script>
