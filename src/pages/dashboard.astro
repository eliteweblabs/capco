---
const requireAuthRedirect = "/login";
import { checkAuth } from "../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);
const currentRole = currentUser?.profile?.role;

// Handle auth redirect first

//// && (!session || !currentUser || currentRole !== "Admin")
if (requireAuthRedirect) {
  return Astro.redirect(requireAuthRedirect);
}

import App from "../components/common/App.astro";
import DemoCharts from "../components/common/DemoCharts.astro";
import "../lib/refresh-manager.ts";
// Get auth data directly since App component handles auth requirements

// console.log("üöÄ [DASHBOARD] Current user:", currentUser);
// Initialize data arrays
let projects: any[] = [];

// Fetch projects using the API endpoint that includes discussion counts
if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    let apiUrl = `${baseUrl}/api/get-project`;

    // Add assignedToId parameter for Staff role
    // if (currentUser?.profile?.role === "Staff") {
    //   apiUrl += `?assignedToId=${currentUser.id}`;
    // }

    // Add assignedToId parameter for Staff role
    if (currentUser?.profile?.role === "Client") {
      apiUrl += `?authorId=${currentUser.id}`;
    }
    // For Admin and Client, no additional parameters needed (API handles role-based filtering)

    // console.log("üèóÔ∏è [DASHBOARD] Fetching projects from API:", apiUrl);
    const response = await fetch(apiUrl);

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
      // console.log("üèóÔ∏è [DASHBOARD] Projects fetched with discussion counts:", projects.length);
      // console.log("üèóÔ∏è [DASHBOARD] Sample project data:", {
      //   id: projects[0]?.id,
      //   title: projects[0]?.title,
      //   commentCount: projects[0]?.commentCount,
      //   incompleteDiscussions: projects[0]?.i,
      // });
    } else {
      console.error(
        "üèóÔ∏è [DASHBOARD] Error fetching projects:",
        response.status,
        response.statusText
      );
    }
  } catch (error) {
    console.error("üèóÔ∏è [DASHBOARD] Error fetching projects:", error);
  }
}

// Fetch project statuses using the unified API
const statusApiUrl = new URL("/api/project-statuses", Astro.url.origin);
const statusResponse = await fetch(statusApiUrl.toString(), {
  method: "GET",
  headers: {
    Cookie: Astro.request.headers.get("Cookie") || "",
  },
});
---

<App title="Global Dashboard - CAPCo Fire Protection" description="View all projects.">
  <!-- </SectionContainer> -->

  <DemoCharts />
</App>

<style>
  @import "aos/dist/aos.css";

  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.5;
    }
  }
</style>

<script>
  // Request push notification permission
  (window as any).requestPushNotificationPermission = function () {
    // Check if we're on mobile Safari
    const isMobileSafari =
      /iPad|iPhone|iPod/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent);
    console.log("üîî [APP] Mobile Safari detected:", isMobileSafari);

    if (isMobileSafari) {
      console.log(
        "üîî [APP] Mobile Safari detected - push notifications work when installed as PWA"
      );
      console.log("üîî [APP] Install as PWA (Add to Home Screen) for full notification support");

      // Check if running as PWA
      const isStandalone =
        (window as any).matchMedia("(display-mode: standalone)").matches ||
        (window.navigator as any).standalone === true;
      console.log("üîî [APP] Running as PWA:", isStandalone);

      if (!isStandalone) {
        console.log("üí° [APP] Install as PWA for better notification support");
        return;
      }
    }

    // Only request if user hasn't been prompted yet
    if ("Notification" in window && Notification.permission === "default") {
      console.log("üîî [APP] Requesting notification permission...");
      // Request permission immediately in user interaction context
      Notification.requestPermission().then((permission) => {
        console.log("üîî [APP] Permission result:", permission);
        if (permission === "granted") {
          console.log("üîî Push notifications enabled for authenticated user!");
          // Show a subtle notification
          if ((window as any).showModal) {
            (window as any).showModal(
              "info",
              "Notifications Enabled",
              "You'll receive push notifications for project updates!",
              3000
            );
          }
        } else {
          console.log("üîî Push notifications declined by user");
        }
      });
    } else {
      console.log("üîî [APP] Not requesting permission - already handled or not available");
    }
  };

  // Reset notification permissions for debugging
  (window as any).resetNotifications = function () {
    console.log("üîÑ [APP] Resetting notification permissions...");

    // Check if we're on mobile Safari
    const isMobileSafari =
      /iPad|iPhone|iPod/.test(navigator.userAgent) && /Safari/.test(navigator.userAgent);

    if (isMobileSafari) {
      console.log(
        "üì± [APP] Mobile Safari detected - push notifications work when installed as PWA"
      );
      console.log("üí° [APP] Install as PWA (Add to Home Screen) for full notification support");

      // Check if running as PWA
      const isStandalone =
        window.matchMedia("(display-mode: standalone)").matches ||
        (window.navigator as any).standalone === true;
      console.log("üîî [APP] Running as PWA:", isStandalone);

      if (!isStandalone) {
        console.log("üí° [APP] Install as PWA for better notification support");
        return;
      }
    }

    console.log(
      "üîÑ [APP] Current permission:",
      "Notification" in window ? Notification.permission : "Not available"
    );

    // Clear any stored permission state
    localStorage.removeItem("notification-permission-requested");
    sessionStorage.removeItem("notification-permission-requested");

    // Force a new permission request
    if ("Notification" in window) {
      Notification.requestPermission().then((permission) => {
        console.log("üîÑ [APP] Reset permission result:", permission);
        if (permission === "granted") {
          console.log("‚úÖ Notifications re-enabled!");
        } else {
          console.log("‚ùå Notifications still denied");
        }
      });
    }
  };

  // Request notification permission on first user interaction
  let permissionRequested = false;
  const requestPermissionOnInteraction = () => {
    if (!permissionRequested) {
      permissionRequested = true;
      (window as any).requestPushNotificationPermission();
      // Remove listeners after first interaction
      document.removeEventListener("click", requestPermissionOnInteraction);
      document.removeEventListener("touchstart", requestPermissionOnInteraction);
    }
  };

  // Listen for first user interaction
  document.addEventListener("click", requestPermissionOnInteraction);
  document.addEventListener("touchstart", requestPermissionOnInteraction);
</script>
