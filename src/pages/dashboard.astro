---
console.log("📊 [DASHBOARD] Page loading started...");

import App from "../components/common/App.astro";
import DashboardComponent from "../components/common/Dashboard.astro";
import SectionContainer from "../components/common/SectionContainer.astro";
import ProjectNav from "../components/project/ProjectNav.astro";
import Hero from "../components/common/Hero.astro";
import "../lib/refresh-manager.ts";

// Get auth data directly since App component handles auth requirements
import { checkAuth } from "../lib/auth";
const { isAuth, currentUser, currentRole } = await checkAuth(Astro.cookies);

// Debug information
console.log("🔍 [DASHBOARD] Auth check results:", {
  isAuth,
  currentRole,
});

// Test database access if authenticated

// // Additional debugging - check cookies directly
// const accessToken = Astro.cookies.get("sb-access-token");
// const refreshToken = Astro.cookies.get("sb-refresh-token");

// console.log("🍪 [DASHBOARD] Cookie status:", {
//   hasAccessToken: !!accessToken,
//   hasRefreshToken: !!refreshToken,
//   accessTokenLength: accessToken?.value?.length || 0,
//   refreshTokenLength: refreshToken?.value?.length || 0,
// });

// Fetch projects and statuses from API
let projects: any[] = [];
let project_statuses: any[] = [];
let project_statuses_object: any = {};

try {
  // Fetch projects
  const projectsResponse = await (fetch as any)(`${Astro.url.origin}/api/get-project`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  });

  if (projectsResponse.ok) {
    const projectsResult = await projectsResponse.json();
    if (projectsResult.success) {
      const allProjects = projectsResult.projects || [];
      // console.log("🏗️ [DASHBOARD] Projects fetched:", allProjects.length);

      // Filter projects based on user currentRole
      if (currentRole === "Admin") {
        // Admin sees all projects
        projects = allProjects;
        // console.log("🏗️ [DASHBOARD] Admin - showing all projects:", projects.length);
      } else if (currentRole === "Staff") {
        // Staff only sees projects where they are assigned
        projects = allProjects.filter((project: any) => project.assigned_to_id === currentUser?.id);
        // console.log("🏗️ [DASHBOARD] Staff - showing assigned projects:", projects.length);
      } else {
        // Clients only see projects they authored
        projects = allProjects.filter((project: any) => project.author_id === currentUser?.id);
        // console.log("🏗️ [DASHBOARD] Client - showing authored projects:", projects.length);
      }
    } else {
      console.error("Projects API returned error:", projectsResult.error);
    }
  } else {
    console.error("Failed to fetch projects:", projectsResponse.status);
  }

  // Fetch status labels directly in this page
  let statusLabels: Record<number, { status_name: string; [key: string]: any }> = {};
  if (isAuth) {
    try {
      const statusesResponse = await fetch(
        `${Astro.url.origin}/api/get-project-statuses?refresh=true`,
        {
          method: "GET",
          headers: {
            "Content-Type": "application/json",
            "X-User-Role": currentRole || "Client",
            Cookie: `sb-access-token=${Astro.cookies.get("sb-access-token")?.value}; sb-refresh-token=${Astro.cookies.get("sb-refresh-token")?.value}`,
          },
        }
      );

      if (statusesResponse.ok) {
        const statusesResult = await statusesResponse.json();
        if (statusesResult.success) {
          statusLabels = statusesResult.statuses || {};
        }
      }
    } catch (error) {
      console.error("Error fetching status labels:", error);
    }
  }

  // Convert to array format for existing components - preserve all properties
  project_statuses = Object.values(statusLabels || {});
  // Keep object format for project actions (make it global for script)
  project_statuses_object = statusLabels || {};

  // Debug: Log the converted array to see if client_status_name is preserved
  console.log("🔍 [DASHBOARD] Converted project_statuses array:", project_statuses.slice(0, 3));
  console.log(
    "🔍 [DASHBOARD] First status with client_status_name:",
    project_statuses.find((s) => s.client_status_name)
  );
} catch (error) {
  console.error("Error fetching data:", error);
}
---

<App requireAuth={true}>
  <Hero
    title={currentUser?.company_name || "Dashboard"}
    authorProfile={currentUser}
    description={""}
    currentRole={currentRole || "Client"}
    statuses={project_statuses}
  />

  <!-- <DebugComponent/> -->

  <!-- Navigation -->
  <SectionContainer class="mx-6 flex flex-col gap-y-6">
    <ProjectNav
      currentRole={currentRole || "Client"}
      projects={projects}
      statuses={project_statuses}
    />
  </SectionContainer>

  <!-- Main Dashboard -->
  <SectionContainer id="dashboard" class="mx-6 mb-0 mt-0 flex">
    <DashboardComponent
      currentRole={currentRole || "Client"}
      currentUser={currentUser}
      projects={projects}
      statuses={project_statuses}
    />
  </SectionContainer>
</App>

<script
  define:vars={{ projects, project_statuses, project_statuses_object, currentRole, currentUser }}
>
  // Project Action Notification System - Only for Clients
  document.addEventListener("DOMContentLoaded", async function () {
    console.log("🔔 [PROJECT-ACTIONS] Initializing project action notifications...");
    console.log("🔔 [PROJECT-ACTIONS] Current user currentRole:", currentRole);
    console.log("🔔 [PROJECT-ACTIONS] Projects data:", projects);

    // Only run for clients
    if (currentRole !== "Client") {
      console.log("🔔 [PROJECT-ACTIONS] Skipping - user is not a client");
      return;
    }

    if (!projects || !Array.isArray(projects) || projects.length === 0) {
      console.log("🔔 [PROJECT-ACTIONS] No projects found for client");
      return;
    }

    // Use project statuses data that's already available from server-side
    console.log("🔔 [PROJECT-ACTIONS] Using project statuses data from server-side variables");
    console.log("🔔 [PROJECT-ACTIONS] Project statuses data:", project_statuses_object);

    if (!project_statuses_object || typeof project_statuses_object !== "object") {
      console.log("🔔 [PROJECT-ACTIONS] No project statuses found");
      return;
    }

    console.log("🔔 [PROJECT-ACTIONS] Processing projects:", projects.length);
    console.log("🔔 [PROJECT-ACTIONS] Available statuses:", Object.keys(project_statuses_object));

    // Check each project for action notifications
    for (let index = 0; index < projects.length; index++) {
      const project = projects[index];
      const projectStatus = project.status;
      const statusConfig = project_statuses_object[projectStatus];

      console.log(`🔔 [PROJECT-ACTIONS] Checking project ${index + 1}:`, {
        id: project.id,
        title: project.title,
        status: projectStatus,
        hasStatusConfig: !!statusConfig,
        statusConfig: statusConfig,
      });

      if (statusConfig && statusConfig.project_action) {
        console.log(
          `🔔 [PROJECT-ACTIONS] Found project action for project "${project.title}":`,
          statusConfig.project_action
        );

        // Replace placeholders in the project action message using centralized API
        const actionMessage = await replacePlaceholders(
          statusConfig.project_action,
          project,
          statusConfig
        );

        console.log(`🔔 [PROJECT-ACTIONS] Showing for project "${project.title}":`, actionMessage);

        // Show dismissible modal notification with proper initialization check
        const showNotificationWithRetry = (retryCount = 0) => {
          if (window.showModal && window.unifiedNotificationManager) {
            console.log("🔔 [PROJECT-ACTIONS] Notification system available, showing modal...");
            window.showModal("info", "Project Action Required", actionMessage, 8000); // 8 seconds with progress bar
          } else if (retryCount < 5) {
            console.log(
              `🔔 [PROJECT-ACTIONS] Notification system not ready, retrying in ${(retryCount + 1) * 500}ms... (attempt ${retryCount + 1}/5)`
            );
            setTimeout(
              () => {
                showNotificationWithRetry(retryCount + 1);
              },
              (retryCount + 1) * 500
            );
          } else {
            console.error(
              "🔔 [PROJECT-ACTIONS] Notification system failed to initialize after 5 attempts"
            );
            console.error(
              "🔔 [PROJECT-ACTIONS] Available window methods:",
              Object.keys(window).filter((key) => key.includes("show"))
            );

            // Fallback to alert if notification system fails
            alert(`Project Action Required: ${actionMessage}`);
          }
        };

        showNotificationWithRetry();
      } else {
        console.log(`🔔 [PROJECT-ACTIONS] No project action for project "${project.title}"`);
      }
    }
  });

  // Function to replace placeholders in project action messages using centralized API
  async function replacePlaceholders(message, project, statusConfig) {
    if (!message) return "";

    console.log("🔄 [PLACEHOLDER] Original message:", message);

    // Get client name from currentUser data - use company_name consistently
    const clientName = currentUser?.company_name || "Client";

    // Prepare data for centralized placeholder API
    const mergedData = {
      statusConfig: {
        project_action: message,
      },
    };

    const placeholderData = {
      projectAddress: project.address || "N/A",
      clientName: clientName,
      clientEmail: currentUser?.email || "",
      statusName: statusConfig?.status_name || "Status Update",
      estTime: statusConfig?.est_time || "2-3 business days",
      projectId: project.id,
      siteUrl: window.location.origin,
    };

    try {
      // Call centralized placeholder API
      const response = await fetch("/api/replace-placeholders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          mergedData,
          placeholderData,
        }),
      });

      if (response.ok) {
        const result = await response.json();
        const processedMessage = result.processedMessages?.project_action || message;

        console.log("🔄 [PLACEHOLDER] Final processed message:", processedMessage);
        return processedMessage;
      } else {
        console.error("🔄 [PLACEHOLDER] API call failed, falling back to local processing");
        throw new Error("API call failed");
      }
    } catch (error) {
      console.error("🔄 [PLACEHOLDER] Error calling centralized API:", error);
    }
  }
</script>
