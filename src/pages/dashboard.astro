---
const requireAuthRedirect = "/auth/login";
import { checkAuth } from "../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);
const currentRole = currentUser?.profile?.role;

// Handle auth redirect first

//// && (!session || !currentUser || currentRole !== "Admin")
if (requireAuthRedirect) {
  return Astro.redirect(requireAuthRedirect);
}

import App from "../components/ui/App.astro";
import DemoCharts from "../components/common/DemoCharts.astro";
// refresh-manager loaded in App.astro for Staff/Admin

// console.log("üöÄ [DASHBOARD] Current user:", currentUser);
// Initialize projects with lazy loading
let projects: any[] = [];
let projectsLoading = false;
let projectsHasMore = true;
let projectsOffset = 0;
const PROJECTS_LIMIT = 20;

// Fetch initial projects using the new standardized API
if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    let apiUrl = `${baseUrl}/api/projects/get?limit=${PROJECTS_LIMIT}&offset=0`;

    // Add role-based filtering
    if (currentUser?.profile?.role === "Client") {
      apiUrl += `&authorId=${currentUser.id}`;
    } else if (currentUser?.profile?.role === "Staff") {
      apiUrl += `&assignedToId=${currentUser.id}`;
    }

    console.log("üèóÔ∏è [DASHBOARD] Fetching initial projects from API:", apiUrl);
    const response = await fetch(apiUrl, {
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
      projectsHasMore = data.pagination?.hasMore || false;
      projectsOffset = PROJECTS_LIMIT;
      console.log(
        "üèóÔ∏è [DASHBOARD] Initial projects loaded:",
        projects.length,
        "Has more:",
        projectsHasMore
      );
    } else {
      console.error(
        "üèóÔ∏è [DASHBOARD] Error fetching projects:",
        response.status,
        response.statusText
      );
    }
  } catch (error) {
    console.error("üèóÔ∏è [DASHBOARD] Error fetching projects:", error);
  }
}

// Fetch project statuses using the unified API
const statusApiUrl = new URL("/api/status/get", Astro.url.origin);
const statusResponse = await fetch(statusApiUrl.toString(), {
  method: "GET",
  headers: {
    Cookie: Astro.request.headers.get("Cookie") || "",
  },
});
---

<App title={`Global Dashboard`} description="View all projects." horizontalScroll={true}>
  <DemoCharts />
</App>
