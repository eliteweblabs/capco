---
console.log("ğŸ“Š [DASHBOARD] Page loading started...");

import App from "../components/common/App.astro";
import DashboardComponent from "../components/common/Dashboard.astro";
import SectionContainer from "../components/common/SectionContainer.astro";
import ProjectNav from "../components/project/ProjectNav.astro";
import Hero from "../components/common/Hero.astro";
import "../lib/refresh-manager.ts";

// Get auth data directly since App component handles auth requirements
import { checkAuth } from "../lib/auth";
const { isAuth, currentUser, currentRole } = await checkAuth(Astro.cookies);

// Debug information
// console.log("ğŸ” [DASHBOARD] Auth check results:", {
//   isAuth,
//   hasUser: !!user,
//   userId: user?.id,
//   userEmail: user?.email,
//   currentRole,
//   hasSession: !!session,
// });

// Test database access if authenticated

// // Additional debugging - check cookies directly
// const accessToken = Astro.cookies.get("sb-access-token");
// const refreshToken = Astro.cookies.get("sb-refresh-token");

// console.log("ğŸª [DASHBOARD] Cookie status:", {
//   hasAccessToken: !!accessToken,
//   hasRefreshToken: !!refreshToken,
//   accessTokenLength: accessToken?.value?.length || 0,
//   refreshTokenLength: refreshToken?.value?.length || 0,
// });

// Fetch projects and statuses from API
let projects: any[] = [];
let project_statuses: any[] = [];
let project_statuses_object: any = {};

try {
  // Fetch projects
  const projectsResponse = await (fetch as any)(`${Astro.url.origin}/api/get-project`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  });

  if (projectsResponse.ok) {
    const projectsResult = await projectsResponse.json();
    if (projectsResult.success) {
      const allProjects = projectsResult.projects || [];
      // console.log("ğŸ—ï¸ [DASHBOARD] Projects fetched:", allProjects.length);

      // Filter projects based on user currentRole
      if (currentRole === "Admin") {
        // Admin sees all projects
        projects = allProjects;
        // console.log("ğŸ—ï¸ [DASHBOARD] Admin - showing all projects:", projects.length);
      } else if (currentRole === "Staff") {
        // Staff only sees projects where they are assigned
        projects = allProjects.filter((project: any) => project.assigned_to_id === currentUser?.id);
        // console.log("ğŸ—ï¸ [DASHBOARD] Staff - showing assigned projects:", projects.length);
      } else {
        // Clients only see projects they authored
        projects = allProjects.filter((project: any) => project.author_id === currentUser?.id);
        // console.log("ğŸ—ï¸ [DASHBOARD] Client - showing authored projects:", projects.length);
      }
    } else {
      console.error("Projects API returned error:", projectsResult.error);
    }
  } else {
    console.error("Failed to fetch projects:", projectsResponse.status);
  }

  // Fetch statuses (with cache-busting to get fresh data with project_action field)
  const statusesResponse = await (fetch as any)(
    `${Astro.url.origin}/api/get-project-statuses?refresh=true`,
    {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        currentRole: currentRole || "Client",
      },
    }
  );

  if (statusesResponse.ok) {
    const statusesResult = await statusesResponse.json();
    // console.log("ğŸ—ï¸ [DASHBOARD] Statuses API response:", statusesResult);
    if (statusesResult.success) {
      // console.log(
      //   "ğŸ—ï¸ [DASHBOARD] Statuses fetched:",
      //   Object.keys(statusesResult.statuses || {}).length
      // );
      // Convert to array format for existing components
      project_statuses = Object.values(statusesResult.statuses || {});
      // Keep object format for project actions (make it global for script)
      project_statuses_object = statusesResult.statuses || {};
      // console.log("ğŸ—ï¸ [DASHBOARD] project_statuses_object:", project_statuses_object);
      // console.log("ğŸ—ï¸ [DASHBOARD] Status 40 config:", project_statuses_object[40]);

      // console.log("ğŸ—ï¸ [DASHBOARD] project_statuses array length:", project_statuses.length);
      // console.log(
      //   "ğŸ—ï¸ [DASHBOARD] project_statuses_object keys:",
      //   Object.keys(project_statuses_object)
      // );
      // console.log("ğŸ—ï¸ [DASHBOARD] Status 10 config:", project_statuses_object[10]);
    } else {
      console.error("Statuses API returned error:", statusesResult.error);
      console.error(
        "ğŸ—ï¸ [DASHBOARD] project_statuses_object will remain empty:",
        project_statuses_object
      );
    }
  } else {
    console.error("Failed to fetch statuses:", statusesResponse.status);
    console.error(
      "ğŸ—ï¸ [DASHBOARD] project_statuses_object will remain empty:",
      project_statuses_object
    );
  }
} catch (error) {
  console.error("Error fetching data:", error);
}
---

<App requireAuth={true}>
  <Hero
    title={currentUser?.company_name || "Dashboard"}
    authorProfile={currentUser}
    description={""}
  />

  <!-- <DebugComponent/> -->

  <!-- Navigation -->
  <SectionContainer class="mx-6 flex flex-col gap-y-6">
    <ProjectNav
      currentRole={currentRole || "Client"}
      projects={projects}
      statuses={project_statuses}
      stat
    />
  </SectionContainer>

  <!-- Main Dashboard -->
  <SectionContainer id="dashboard" class="mx-6 mb-0 mt-0 flex">
    <DashboardComponent
      currentRole={currentRole || "Client"}
      currentUser={currentUser}
      projects={projects}
      statuses={project_statuses}
    />
  </SectionContainer>
</App>

<script
  define:vars={{ projects, project_statuses, project_statuses_object, currentRole, currentUser }}
>
  // Project Action Notification System - Only for Clients
  document.addEventListener("DOMContentLoaded", async function () {
    console.log("ğŸ”” [PROJECT-ACTIONS] Initializing project action notifications...");
    console.log("ğŸ”” [PROJECT-ACTIONS] Current user currentRole:", currentRole);
    console.log("ğŸ”” [PROJECT-ACTIONS] Projects data:", projects);

    // Only run for clients
    if (currentRole !== "Client") {
      console.log("ğŸ”” [PROJECT-ACTIONS] Skipping - user is not a client");
      return;
    }

    if (!projects || !Array.isArray(projects) || projects.length === 0) {
      console.log("ğŸ”” [PROJECT-ACTIONS] No projects found for client");
      return;
    }

    // Use project statuses data that's already available from server-side
    console.log("ğŸ”” [PROJECT-ACTIONS] Using project statuses data from server-side variables");
    console.log("ğŸ”” [PROJECT-ACTIONS] Project statuses data:", project_statuses_object);

    if (!project_statuses_object || typeof project_statuses_object !== "object") {
      console.log("ğŸ”” [PROJECT-ACTIONS] No project statuses found");
      return;
    }

    console.log("ğŸ”” [PROJECT-ACTIONS] Processing projects:", projects.length);
    console.log("ğŸ”” [PROJECT-ACTIONS] Available statuses:", Object.keys(project_statuses_object));

    // Check each project for action notifications
    for (let index = 0; index < projects.length; index++) {
      const project = projects[index];
      const projectStatus = project.status;
      const statusConfig = project_statuses_object[projectStatus];

      console.log(`ğŸ”” [PROJECT-ACTIONS] Checking project ${index + 1}:`, {
        id: project.id,
        title: project.title,
        status: projectStatus,
        hasStatusConfig: !!statusConfig,
        statusConfig: statusConfig,
      });

      if (statusConfig && statusConfig.project_action) {
        console.log(
          `ğŸ”” [PROJECT-ACTIONS] Found project action for project "${project.title}":`,
          statusConfig.project_action
        );

        // Replace placeholders in the project action message using centralized API
        const actionMessage = await replacePlaceholders(
          statusConfig.project_action,
          project,
          statusConfig
        );

        console.log(
          `ğŸ”” [PROJECT-ACTIONS] Showing toast for project "${project.title}":`,
          actionMessage
        );

        // Show dismissible modal notification
        if (window.showModal) {
          console.log("ğŸ”” [PROJECT-ACTIONS] Notification system available, showing modal...");
          window.showModal("info", "Project Action Required", actionMessage, 8000); // 8 seconds with progress bar
        } else {
          console.error("ğŸ”” [PROJECT-ACTIONS] Notification system not available");
          console.error(
            "ğŸ”” [PROJECT-ACTIONS] Available window methods:",
            Object.keys(window).filter((key) => key.includes("show"))
          );
        }
      } else {
        console.log(`ğŸ”” [PROJECT-ACTIONS] No project action for project "${project.title}"`);
      }
    }
  });

  // Function to replace placeholders in project action messages using centralized API
  async function replacePlaceholders(message, project, statusConfig) {
    if (!message) return "";

    console.log("ğŸ”„ [PLACEHOLDER] Original message:", message);

    // Get client name from currentUser data - use company_name consistently
    const clientName = currentUser?.company_name || "Client";

    // Prepare data for centralized placeholder API
    const mergedData = {
      statusConfig: {
        project_action: message,
      },
    };

    const placeholderData = {
      projectAddress: project.address || "N/A",
      clientName: clientName,
      clientEmail: currentUser?.email || "",
      statusName: statusConfig?.status_name || "Status Update",
      estTime: statusConfig?.est_time || "2-3 business days",
      projectId: project.id,
      siteUrl: window.location.origin,
    };

    try {
      // Call centralized placeholder API
      const response = await fetch("/api/replace-placeholders", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          mergedData,
          placeholderData,
        }),
      });

      if (response.ok) {
        const result = await response.json();
        const processedMessage = result.processedMessages?.project_action || message;

        console.log("ğŸ”„ [PLACEHOLDER] Final processed message:", processedMessage);
        return processedMessage;
      } else {
        console.error("ğŸ”„ [PLACEHOLDER] API call failed, falling back to local processing");
        throw new Error("API call failed");
      }
    } catch (error) {
      console.error("ğŸ”„ [PLACEHOLDER] Error calling centralized API:", error);

      // Fallback to local processing if API fails
      // const baseProjectLink = `${window.location.origin}/project/${project.id}`;
      // let processedMessage = message.replace(
      //   /{{PROJECT_LINK(\?[^}]*)?}}/g,
      //   (match, queryParams) => {
      //     const fullUrl = baseProjectLink + (queryParams || "");
      //     let displayText = "View Project";
      //     if (queryParams) {
      //       const tabMatch = queryParams.match(/[?&]tab=([^&]*)/);
      //       if (tabMatch && tabMatch[1]) {
      //         const tabName = tabMatch[1]
      //           .replace(/([a-z])([A-Z])/g, "$1 $2")
      //           .replace(/[-_]/g, " ")
      //           .split(" ")
      //           .map((word) => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
      //           .join(" ");
      //         displayText = `Go to ${tabName}`;
      //       }
      //     }
      //     return `<a href="${fullUrl}" style="color: #3b82f6; text-decoration: underline; font-weight: 500;">${displayText}</a>`;
      //   }
      // );

      // const finalMessage = processedMessage
      //   .replace(/{{PROJECT_TITLE}}/g, project.title || "Project")
      //   .replace(/{{PROJECT_ADDRESS}}/g, project.address || "N/A")
      //   .replace(/{{ADDRESS}}/g, project.address || "N/A")
      //   .replace(/{{CLIENT_NAME}}/g, clientName)
      //   .replace(/{{CLIENT_EMAIL}}/g, currentUser?.email || "")
      //   .replace(/{{EST_TIME}}/g, statusConfig?.est_time || "2-3 business days")
      //   .replace(/{{STATUS_NAME}}/g, statusConfig?.status_name || "Status Update")
      //   .replace(/\{\{[^}]+\}\}/g, "");

      // console.log("ğŸ”„ [PLACEHOLDER] Fallback processed message:", finalMessage);
      // return finalMessage;
    }
  }
</script>
