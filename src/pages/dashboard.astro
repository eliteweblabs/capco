---
console.log("ğŸ“Š [DASHBOARD] Page loading started...");

import App from "../components/common/App.astro";
import DashboardComponent from "../components/common/Dashboard.astro";
import SectionContainer from "../components/common/SectionContainer.astro";

import ProjectNav from "../components/project/ProjectNav.astro";
import { supabase } from "../lib/supabase";

import Hero from "../components/common/Hero.astro";

// Check authentication
import { checkAuth } from "../lib/auth";
const { isAuth, session, user, role } = await checkAuth(Astro.cookies);

// Redirect if not authenticated
if (!isAuth) {
  return Astro.redirect("/login");
}

// Debug information
console.log("ğŸ” [DASHBOARD] Auth check results:", {
  isAuth,
  hasUser: !!user,
  userId: user?.id,
  userEmail: user?.email,
  role,
  hasSession: !!session,
});

// Test database access if authenticated
let projectCount = 0;
let profileData: any = null;
let dbError: any = null;

// Environment check for debugging
const envStatus = {
  hasSupabaseUrl: !!import.meta.env.PUBLIC_SUPABASE_URL,
  hasSupabaseAnonKey: !!import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  hasSupabaseServiceKey: !!import.meta.env.SUPABASE_SERVICE_ROLE_KEY,
  supabaseClientCreated: !!supabase,
};

console.log("ğŸ”§ [DASHBOARD] Environment status:", envStatus);

// Additional debugging - check cookies directly
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");

console.log("ğŸª [DASHBOARD] Cookie status:", {
  hasAccessToken: !!accessToken,
  hasRefreshToken: !!refreshToken,
  accessTokenLength: accessToken?.value?.length || 0,
  refreshTokenLength: refreshToken?.value?.length || 0,
});

// Fetch projects and statuses from API
let projects: any[] = [];
let project_statuses: any[] = [];

try {
  // Fetch projects
  const projectsResponse = await (fetch as any)(`${Astro.url.origin}/api/get-project`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
    },
  });

  if (projectsResponse.ok) {
    const projectsResult = await projectsResponse.json();
    if (projectsResult.success) {
      const allProjects = projectsResult.projects || [];
      console.log("ğŸ—ï¸ [DASHBOARD] Projects fetched:", allProjects.length);

      // Filter projects based on user role
      if (role === "Admin") {
        // Admin sees all projects
        projects = allProjects;
        console.log("ğŸ—ï¸ [DASHBOARD] Admin - showing all projects:", projects.length);
      } else if (role === "Staff") {
        // Staff only sees projects where they are assigned
        projects = allProjects.filter((project: any) => project.assigned_to_id === user.id);
        console.log("ğŸ—ï¸ [DASHBOARD] Staff - showing assigned projects:", projects.length);
      } else {
        // Clients only see projects they authored
        projects = allProjects.filter((project: any) => project.author_id === user.id);
        console.log("ğŸ—ï¸ [DASHBOARD] Client - showing authored projects:", projects.length);
      }
    } else {
      console.error("Projects API returned error:", projectsResult.error);
    }
  } else {
    console.error("Failed to fetch projects:", projectsResponse.status);
  }

  // Fetch statuses
  const statusesResponse = await (fetch as any)(`${Astro.url.origin}/api/get-project-statuses`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      role: role || "Client",
    },
  });

  if (statusesResponse.ok) {
    const statusesResult = await statusesResponse.json();
    if (statusesResult.success) {
      console.log(
        "ğŸ—ï¸ [DASHBOARD] Statuses fetched:",
        Object.keys(statusesResult.statuses || {}).length
      );
      project_statuses = Object.values(statusesResult.statuses || {});
    } else {
      console.error("Statuses API returned error:", statusesResult.error);
    }
  } else {
    console.error("Failed to fetch statuses:", statusesResponse.status);
  }
} catch (error) {
  console.error("Error fetching data:", error);
}
---

<App>
  <!-- <SectionContainer id="hero" class="mx-6 my-6"> -->
  <Hero
    title={profileData?.company_name || "Dashboard"}
    description={profileData?.email || "User"}
  />
  <!-- </SectionContainer> -->
  <!-- Debug Panel (can be hidden in production) -->
  <SectionContainer class="mx-6 mb-6">
    <details
      class="rounded-lg border border-gray-300 bg-gray-100 dark:border-gray-600 dark:bg-gray-800"
    >
      <summary
        class="cursor-pointer rounded-lg p-4 font-medium text-gray-700 hover:bg-gray-50 dark:text-gray-300 dark:hover:bg-gray-700"
      >
        ğŸ” Debug Information (Click to expand)
      </summary>

      <div class="p-4 pt-0">
        <!-- Authentication Status -->
        <div class="mb-4 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
          <div class="rounded bg-white p-3 dark:bg-gray-700">
            <h3 class="mb-2 text-sm font-semibold">ğŸ” Authentication</h3>
            <div class="space-y-1 text-xs">
              <div>
                Authenticated: <span class={isAuth ? "text-green-600" : "text-red-600"}
                  >{isAuth ? "âœ… Yes" : "âŒ No"}</span
                >
              </div>
              <div>
                User ID: <span class="font-mono">{user?.id || "None"}</span>
              </div>
              <div>
                Email: <span class="font-mono">{user?.email || "None"}</span>
              </div>
              <div>
                Role: <span class={role ? "text-blue-600" : "text-gray-500"}>{role || "None"}</span>
              </div>
            </div>
          </div>

          <div class="rounded bg-white p-3 dark:bg-gray-700">
            <h3 class="mb-2 text-sm font-semibold">ğŸª Cookies</h3>
            <div class="space-y-1 text-xs">
              <div>
                Access Token: <span class={accessToken ? "text-green-600" : "text-red-600"}
                  >{
                    accessToken ? `âœ… ${accessToken.value.substring(0, 20)}...` : "âŒ Missing"
                  }</span
                >
              </div>
              <div>
                Refresh Token: <span class={refreshToken ? "text-green-600" : "text-red-600"}
                  >{
                    refreshToken ? `âœ… ${refreshToken.value.substring(0, 20)}...` : "âŒ Missing"
                  }</span
                >
              </div>
            </div>
          </div>

          <div class="rounded bg-white p-3 dark:bg-gray-700">
            <h3 class="mb-2 text-sm font-semibold">ğŸ”§ Environment</h3>
            <div class="space-y-1 text-xs">
              <div>
                Supabase URL: <span
                  class={envStatus.hasSupabaseUrl ? "text-green-600" : "text-red-600"}
                  >{envStatus.hasSupabaseUrl ? "âœ… Set" : "âŒ Missing"}</span
                >
              </div>
              <div>
                Anon Key: <span
                  class={envStatus.hasSupabaseAnonKey ? "text-green-600" : "text-red-600"}
                  >{envStatus.hasSupabaseAnonKey ? "âœ… Set" : "âŒ Missing"}</span
                >
              </div>
              <div>
                Client: <span
                  class={envStatus.supabaseClientCreated ? "text-green-600" : "text-red-600"}
                  >{envStatus.supabaseClientCreated ? "âœ… Created" : "âŒ Failed"}</span
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Database Status -->
        <div class="mb-4 rounded bg-white p-3 dark:bg-gray-700">
          <h3 class="mb-2 text-sm font-semibold">ğŸ“Š Database Access</h3>
          <div class="space-y-1 text-xs">
            <div>
              Profile Data:{" "}
              <span class={profileData ? "text-green-600" : "text-red-600"}>
                {profileData ? `âœ… Found (Role: ${profileData.role})` : "âŒ Not Found"}
              </span>
            </div>
            <div>
              Projects Found:{" "}
              <span class={projectCount > 0 ? "text-green-600" : "text-yellow-600"}>
                {projectCount} projects
              </span>
            </div>
            {dbError && <div class="text-red-600">âŒ DB Error: {dbError}</div>}
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="flex gap-2 text-xs">
          <a href="/api/reset-auth" class="rounded bg-red-500 px-2 py-1 text-white hover:bg-red-600"
            >ğŸ”„ Reset Auth</a
          >
          <a
            href="/api/check-env"
            class="rounded bg-blue-500 px-2 py-1 text-white hover:bg-blue-600"
            target="_blank">ğŸ”§ Check Env</a
          >
        </div>
      </div>
    </details>
  </SectionContainer>

  <!-- Navigation -->
  <SectionContainer class="mx-6 flex flex-col gap-y-6">
    <ProjectNav projects={projects} statuses={project_statuses} stat />
  </SectionContainer>

  <!-- Main Dashboard -->
  <SectionContainer id="dashboard" class="mx-6 mb-0 mt-0 flex">
    <DashboardComponent role={role} projects={projects} />
  </SectionContainer>

  <!-- Toast Alerts -->
</App>
