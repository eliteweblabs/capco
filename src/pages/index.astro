---
// Handle OAuth callback if code is present (MUST be first)
const authCode = Astro.url.searchParams.get("code");
if (authCode) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

// Define requireAuthRedirect
const requireAuthRedirect = undefined;
// Make sure to check above value before redirecting
import Button from "../components/common/Button.astro";
import MapboxWidget from "../components/common/MapboxWidget.astro";
import { checkAuth } from "../lib/auth";
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
// Handle auth redirect first
if (requireAuthRedirect && (!session || !currentUser)) {
  return Astro.redirect(requireAuthRedirect);
}

import { globalCompanyData } from "../pages/api/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  globalCompanyLogoDark,
  globalCompanyLogoLight,
} = globalCompanyData();

import { globalClasses } from "../pages/api/global-classes";
const { globalInputClasses, globalPrimaryTextClasses, globalSecondaryTextClasses } =
  globalClasses();

import App from "../components/common/App.astro";

import ContactFormWithUpload from "../components/common/ContactFormWithUpload.astro";
import Features from "../components/common/Features.astro";
import FlowbiteStatsGrid from "../components/common/FlowbiteStatsGrid.astro";
import Hero from "../components/common/Hero.astro";
import Testimonials from "../components/common/Testimonials.astro";

// Get auth data for conditional rendering

const stats = [
  {
    title: "Total Projects",
    value: "1,024",
    change: { value: "12%", type: "increase" as const },
    icon: "ðŸ“Š",
    color: "blue" as const,
  },
  {
    title: "Active Users",
    value: "357",
    change: { value: "8%", type: "increase" as const },
    icon: "ðŸ‘¥",
    color: "green" as const,
  },
  // {
  //   title: "Revenue",
  //   value: "$45,678",
  //   change: { value: "15%", type: "increase" as const },
  //   icon: "ðŸ’°",
  //   color: "purple" as const,
  // },
  {
    title: "Approval Rate",
    value: "97.5%",
    change: { value: "3%", type: "increase" as const },
    icon: "ðŸ“ˆ",
    color: "yellow" as const,
  },
];
---

<App
  title={`${globalCompanyName} - ${globalCompanySlogan}`}
  description={globalCompanySlogan}
  currentUser={currentUser}
  session={session || undefined}
  project={undefined}
  supabase={supabase}
  globalCompanyName={globalCompanyName}
  globalCompanyName={globalCompanyName}
  globalCompanySlogan={globalCompanySlogan}
  globalPrimaryTextClasses={globalPrimaryTextClasses}
  globalSecondaryTextClasses={globalSecondaryTextClasses}
  globalInputClasses={globalInputClasses}
>
  <div class="RZmKBZs1E1eXw8vkE6jY p_2EXc_a2sDA_h41l8QU">
    <div
      class="mveJTCIb2WII7J4sY22F _Ybd3WwuTVljUT4vEaM3 _wYiJGbRZyFZeCc8y7Sf mngKhi_Rv06PF57lblDI _1jTZ8KXRZul60S6czNi LSIxp7RSuOKhsg28v_u3"
    >
      <!-- Hero Section -->

      <Hero
        title={globalCompanyName || ""}
        description={globalCompanySlogan || ""}
        globalPrimaryTextClasses={globalPrimaryTextClasses}
        globalSecondaryTextClasses={globalSecondaryTextClasses}
        globalInputClasses={globalInputClasses}
      />

      <div
        class="RZmKBZs1E1eXw8vkE6jY p_2EXc_a2sDA_h41l8QU mx-auto flex max-w-2xl items-center justify-center pb-6"
      >
        <div class="inset-0 mx-auto flex max-w-2xl items-center justify-center pb-6">
          <Button
            href="/login?tab=register"
            variant="primary"
            size="lg"
            icon="user-plus"
            iconPosition="left"
            class="w-full"
          >
            Create Account
          </Button>
        </div>
      </div>
    </div>
  </div>

  <div class="RZmKBZs1E1eXw8vkE6jY p_2EXc_a2sDA_h41l8QU">
    <div
      class="mveJTCIb2WII7J4sY22F _Ybd3WwuTVljUT4vEaM3 _wYiJGbRZyFZeCc8y7Sf mngKhi_Rv06PF57lblDI _1jTZ8KXRZul60S6czNi LSIxp7RSuOKhsg28v_u3"
    >
      <FlowbiteStatsGrid
        stats={stats}
        columns={3}
        globalPrimaryTextClasses={globalPrimaryTextClasses}
        globalSecondaryTextClasses={globalSecondaryTextClasses}
        globalInputClasses={globalInputClasses}
      />
    </div>
  </div>

  <div class="RZmKBZs1E1eXw8vkE6jY p_2EXc_a2sDA_h41l8QU">
    <div
      class="mveJTCIb2WII7J4sY22F _Ybd3WwuTVljUT4vEaM3 _wYiJGbRZyFZeCc8y7Sf mngKhi_Rv06PF57lblDI _1jTZ8KXRZul60S6czNi LSIxp7RSuOKhsg28v_u3"
    >
      <!-- Features Section -->
      <Features
        globalPrimaryTextClasses={globalPrimaryTextClasses}
        globalSecondaryTextClasses={globalSecondaryTextClasses}
        globalInputClasses={globalInputClasses}
      />
    </div>
  </div>

  <MapboxWidget />

  <div class="RZmKBZs1E1eXw8vkE6jY p_2EXc_a2sDA_h41l8QU">
    <div
      class="mveJTCIb2WII7J4sY22F _Ybd3WwuTVljUT4vEaM3 _wYiJGbRZyFZeCc8y7Sf mngKhi_Rv06PF57lblDI _1jTZ8KXRZul60S6czNi LSIxp7RSuOKhsg28v_u3"
    >
      <!-- Testimonials Section -->
      <Testimonials
        globalCompanyName={globalCompanyName || ""}
        globalPrimaryTextClasses={globalPrimaryTextClasses}
        globalSecondaryTextClasses={globalSecondaryTextClasses}
        globalInputClasses={globalInputClasses}
      />
    </div>
  </div>

  {
    !currentUser && (
      <div class="RZmKBZs1E1eXw8vkE6jY p_2EXc_a2sDA_h41l8QU">
        <div class="mveJTCIb2WII7J4sY22F _Ybd3WwuTVljUT4vEaM3 _wYiJGbRZyFZeCc8y7Sf mngKhi_Rv06PF57lblDI _1jTZ8KXRZul60S6czNi LSIxp7RSuOKhsg28v_u3">
          <ContactFormWithUpload globalInputClasses={globalInputClasses} />
        </div>
      </div>
    )
  }
</App>
