---
/**
 * VAPI.ai Voice Assistant
 *
 * This replaces the browser-based voice assistant with VAPI.ai's professional
 * voice AI solution, which includes:
 * - Voice authentication (only responds to your voice)
 * - Better transcription accuracy
 * - Natural conversation handling
 * - No accidental triggers
 */

import App from "../components/ui/App.astro";
import { checkAuth } from "../lib/auth";

const { currentUser } = await checkAuth(Astro.cookies);
const currentUserRole = currentUser?.profile?.role || "Client";
const isClient = currentUserRole === "Client";

// VAPI Configuration
const assistantId =
  import.meta.env.PUBLIC_PUBLIC_VAPI_ASSISTANT_ID || "3ae002d5-fe9c-4870-8034-4c66a9b43b51";
const publicKey = import.meta.env.PUBLIC_VAPI_KEY || "";
---

<App title="Voice Assistant (VAPI)" {currentUser}>
  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-6 dark:text-white">Voice Assistant (VAPI)</h1>

    <div
      class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6"
    >
      <h2 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">‚ú® Why VAPI.ai?</h2>
      <ul class="list-disc list-inside text-sm text-yellow-700 dark:text-yellow-300 space-y-1">
        <li>
          <strong>Voice Authentication:</strong> Only responds to YOUR voice - no accidental triggers!
        </li>
        <li>
          <strong>Better Accuracy:</strong> Cloud-based transcription is more accurate than browser APIs
        </li>
        <li>
          <strong>Natural Conversation:</strong> Handles interruptions and natural speech flow
        </li>
        <li><strong>Professional Quality:</strong> Enterprise-grade voice AI infrastructure</li>
      </ul>
    </div>

    <!-- VAPI Voice Assistant Interface -->
    <div id="vapi-voice-assistant" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
      <!-- Status Display -->
      <div class="mb-6">
        <div id="vapi-status" class="flex items-center gap-3 mb-4">
          <div id="vapi-status-indicator" class="w-4 h-4 rounded-full bg-gray-400"></div>
          <span id="vapi-status-text" class="text-gray-700 dark:text-gray-300"
            >Ready - Click to start</span
          >
        </div>

        <!-- Conversation Display -->
        <div
          id="vapi-conversation"
          class="h-96 overflow-y-auto border border-gray-200 dark:border-gray-700 rounded-lg p-4 mb-4 bg-gray-50 dark:bg-gray-900"
        >
          <div class="text-sm text-gray-500 dark:text-gray-400 text-center py-8">
            Conversation will appear here...
          </div>
        </div>
      </div>

      <!-- File Upload Section -->
      <div
        class="mb-6 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg border border-gray-200 dark:border-gray-700"
      >
        <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">
          Upload Documents or Images
        </h3>
        <div class="flex items-center gap-4">
          <label
            for="vapi-file-input"
            class="flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          >
            <svg
              class="h-5 w-5 text-gray-600 dark:text-gray-400"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
              ></path>
            </svg>
            <span class="text-sm text-gray-700 dark:text-gray-300">Choose File</span>
          </label>
          <input
            type="file"
            id="vapi-file-input"
            accept=".pdf,.png,.jpg,.jpeg,.gif,.webp"
            class="hidden"
          />
          <span id="vapi-file-name" class="text-sm text-gray-500 dark:text-gray-400 flex-1">
            No file selected
          </span>
          <button
            id="vapi-upload-btn"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed text-sm font-medium"
            disabled
          >
            Process File
          </button>
        </div>
        <div id="vapi-file-preview" class="mt-4 hidden"></div>
        <div id="vapi-file-status" class="mt-2 text-sm"></div>
      </div>

      <!-- Controls -->
      <div class="flex items-center justify-center gap-4">
        <button
          id="vapi-start-btn"
          class="flex items-center gap-3 rounded-full bg-primary-600 px-8 py-4 text-white font-semibold shadow-lg transition-all hover:bg-primary-700 hover:shadow-xl active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <svg
            id="vapi-mic-icon"
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
            ></path>
          </svg>
          <span id="vapi-btn-text">Start Voice Assistant</span>
        </button>

        <button
          id="vapi-stop-btn"
          class="hidden items-center gap-3 rounded-full bg-red-600 px-6 py-4 text-white font-semibold shadow-lg transition-all hover:bg-red-700 hover:shadow-xl active:scale-95"
        >
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
          </svg>
          <span>Stop</span>
        </button>
      </div>

      <!-- Instructions -->
      <div class="mt-8 p-4 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
        <h3 class="font-semibold text-primary-900 dark:text-primary-200 mb-2">How to Use</h3>
        <ul class="text-sm text-primary-800 dark:text-primary-300 space-y-1 list-disc list-inside">
          <li>Click "Start Voice Assistant" to begin</li>
          <li>Say "Bee new project" to create a new project</li>
          <li>The assistant will guide you through all the details</li>
          <li>
            Upload PDFs or images to extract text content (OCR for images, text extraction for PDFs)
          </li>
          <li>Only YOUR voice will trigger the assistant (voice authentication enabled)</li>
          <li>Click "Stop" when you're done</li>
        </ul>
      </div>

      <!-- Voice Authentication Status -->
      <div
        id="vapi-auth-status"
        class="mt-4 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg"
      >
        <div class="flex items-center gap-2">
          <svg
            class="h-5 w-5 text-green-600 dark:text-green-400"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
            ></path>
          </svg>
          <span class="text-sm text-green-700 dark:text-green-300">
            Voice authentication enabled - Only your voice will activate the assistant
          </span>
        </div>
      </div>
    </div>

    <!-- Configuration Warning -->
    {
      !publicKey && (
        <div class="mt-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
          <p class="text-red-800 dark:text-red-200">
            ‚ö†Ô∏è <strong>Configuration Required:</strong> Please set <code>PUBLIC_VAPI_KEY</code> in
            your environment variables.
          </p>
        </div>
      )
    }
  </div>
</App>

<script src="https://cdn.jsdelivr.net/npm/@vapi-ai/web@latest/dist/vapi.js" is:inline></script>

<script define:vars={{ assistantId, publicKey, currentUserRole, isClient }}>
  // VAPI Voice Assistant
  let vapi = null;
  let isCallActive = false;
  let conversationHistory = [];

  // DOM Elements
  const startBtn = document.getElementById("vapi-start-btn");
  const stopBtn = document.getElementById("vapi-stop-btn");
  const btnText = document.getElementById("vapi-btn-text");
  const statusIndicator = document.getElementById("vapi-status-indicator");
  const statusText = document.getElementById("vapi-status-text");
  const conversation = document.getElementById("vapi-conversation");
  const micIcon = document.getElementById("vapi-mic-icon");
  const fileInput = document.getElementById("vapi-file-input");
  const fileNameDisplay = document.getElementById("vapi-file-name");
  const uploadBtn = document.getElementById("vapi-upload-btn");
  const filePreview = document.getElementById("vapi-file-preview");
  const fileStatus = document.getElementById("vapi-file-status");

  let selectedFile = null;

  // Initialize VAPI
  document.addEventListener("DOMContentLoaded", async () => {
    if (!publicKey) {
      console.error("[VAPI-VOICE] Missing PUBLIC_VAPI_KEY");
      startBtn.disabled = true;
      btnText.textContent = "VAPI Key Missing";
      updateStatus("Configuration Error", "bg-red-400");
      return;
    }

    try {
      vapi = new window.Vapi(publicKey);
      console.log("[VAPI-VOICE] VAPI initialized");
      setupVapiListeners();
      setupUIListeners();
    } catch (error) {
      console.error("[VAPI-VOICE] Failed to initialize:", error);
      startBtn.disabled = true;
      btnText.textContent = "Initialization Error";
      updateStatus("Error", "bg-red-400");
    }
  });

  // Setup VAPI event listeners
  function setupVapiListeners() {
    vapi.on("call-start", () => {
      console.log("[VAPI-VOICE] Call started");
      isCallActive = true;
      startBtn.classList.add("hidden");
      stopBtn.classList.remove("hidden");
      updateStatus("Connected - Listening...", "bg-green-400");
      addMessage(
        "system",
        "Voice assistant connected. Say 'Bee new project' to create a project.",
        []
      );
    });

    vapi.on("call-end", () => {
      console.log("[VAPI-VOICE] Call ended");
      isCallActive = false;
      startBtn.classList.remove("hidden");
      stopBtn.classList.add("hidden");
      updateStatus("Ready - Click to start", "bg-gray-400");
      addMessage("system", "Voice assistant disconnected.", []);
    });

    vapi.on("speech-start", () => {
      console.log("[VAPI-VOICE] Assistant speaking");
      updateStatus("Assistant speaking...", "bg-purple-400");
    });

    vapi.on("speech-end", () => {
      console.log("[VAPI-VOICE] Assistant stopped speaking");
      updateStatus("Listening...", "bg-green-400");
    });

    vapi.on("message", (message) => {
      console.log("[VAPI-VOICE] Message:", message);

      if (message.type === "transcript" && message.transcript) {
        const role = message.transcript.role;
        const text = message.transcript.message;

        if (role === "user") {
          addMessage("user", text, []);
        } else if (role === "assistant") {
          addMessage("assistant", text, []);
        }
      }
    });

    vapi.on("error", (error) => {
      console.error("[VAPI-VOICE] Error:", error);
      updateStatus("Error occurred", "bg-red-400");
      addMessage("system", `Error: ${error.message || "Unknown error"}`, []);
    });
  }

  // Setup UI listeners
  function setupUIListeners() {
    startBtn.addEventListener("click", async () => {
      if (!vapi) return;

      try {
        updateStatus("Connecting...", "bg-yellow-400");
        await vapi.start(assistantId);
      } catch (error) {
        console.error("[VAPI-VOICE] Failed to start:", error);
        updateStatus("Failed to connect", "bg-red-400");
      }
    });

    stopBtn.addEventListener("click", () => {
      if (vapi && isCallActive) {
        vapi.stop();
      }
    });

    // File upload handlers
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) {
        selectedFile = file;
        fileNameDisplay.textContent = file.name;
        uploadBtn.disabled = false;

        // Show preview for images
        if (file.type.startsWith("image/")) {
          const reader = new FileReader();
          reader.onload = (e) => {
            filePreview.innerHTML = `
              <img src="${e.target.result}" alt="Preview" class="max-w-full max-h-48 rounded-lg border border-gray-300 dark:border-gray-600">
            `;
            filePreview.classList.remove("hidden");
          };
          reader.readAsDataURL(file);
        } else {
          filePreview.classList.add("hidden");
        }

        fileStatus.textContent = "";
        fileStatus.className = "mt-2 text-sm";
      }
    });

    uploadBtn.addEventListener("click", async () => {
      if (!selectedFile) return;

      await processFile(selectedFile);
    });
  }

  // Process uploaded file
  async function processFile(file) {
    if (!file) return;

    uploadBtn.disabled = true;
    fileStatus.textContent = "Processing file...";
    fileStatus.className = "mt-2 text-sm text-primary-600 dark:text-primary-400";

    try {
      const formData = new FormData();
      formData.append("file", file);

      const response = await fetch("/api/voice-assistant/process-file", {
        method: "POST",
        credentials: "include",
        body: formData,
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Failed to process file");
      }

      // Display extracted content
      if (result.data?.content) {
        fileStatus.textContent = "File processed successfully!";
        fileStatus.className = "mt-2 text-sm text-green-600 dark:text-green-400";

        // Add extracted content to conversation
        addMessage(
          "system",
          `üìÑ File "${file.name}" processed successfully. Extracted content:`,
          []
        );

        // Show extracted text (strip HTML for display)
        const textContent = result.data.content.replace(/<[^>]*>/g, "").substring(0, 500);
        addMessage("assistant", textContent + (result.data.content.length > 500 ? "..." : ""), []);

        // If VAPI is active, send the extracted content to the assistant
        if (vapi && isCallActive) {
          const summary = `I just uploaded a file "${file.name}". Here's what it contains: ${textContent.substring(0, 200)}...`;
          await vapi.send({
            type: "add-message",
            message: {
              role: "user",
              content: summary,
            },
          });
        }

        // Optionally save to knowledge base
        if (result.data.fields && result.data.fields.length > 0) {
          console.log("[VAPI-FILE] Detected fields:", result.data.fields);
        }
      } else {
        throw new Error("No content extracted from file");
      }
    } catch (error) {
      console.error("[VAPI-FILE] Error processing file:", error);
      fileStatus.textContent = `Error: ${error.message}`;
      fileStatus.className = "mt-2 text-sm text-red-600 dark:text-red-400";
      addMessage("system", `‚ùå Failed to process file: ${error.message}`, []);
    } finally {
      uploadBtn.disabled = false;
    }
  }

  // Update status
  function updateStatus(text, colorClass) {
    statusText.textContent = text;
    statusIndicator.className = `w-4 h-4 rounded-full ${colorClass}`;
  }

  // Add message to conversation
  function addMessage(role, text, tags = []) {
    const messageDiv = document.createElement("div");
    messageDiv.className = `mb-4 flex ${role === "user" ? "justify-end" : "justify-start"}`;

    const bubble = document.createElement("div");
    bubble.className = `max-w-[80%] rounded-lg px-4 py-2 ${
      role === "user"
        ? "bg-primary-600 text-white"
        : role === "assistant"
          ? "bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white"
          : "bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200"
    }`;

    bubble.textContent = text;
    messageDiv.appendChild(bubble);
    conversation.appendChild(messageDiv);
    conversation.scrollTop = conversation.scrollHeight;

    // Store in history
    conversationHistory.push({ role, content: text, timestamp: new Date() });
  }
</script>

<style>
  #vapi-conversation {
    scrollbar-width: thin;
    scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
  }

  #vapi-conversation::-webkit-scrollbar {
    width: 6px;
  }

  #vapi-conversation::-webkit-scrollbar-track {
    background: transparent;
  }

  #vapi-conversation::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 3px;
  }
</style>
