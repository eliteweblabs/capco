---
// AI Agent Knowledge Management Page
// Form to add/edit knowledge entries for the AI agent

import App from "../../components/ui/App.astro";
import { checkAuth } from "../../lib/auth";

const { currentUser } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/login");
}

// Get user's role to check if admin
let isAdmin = false;
try {
  const { supabaseAdmin } = await import("../../lib/supabase-admin");
  if (supabaseAdmin) {
    const { data: profile } = await supabaseAdmin
      .from("profiles")
      .select("role")
      .eq("id", currentUser.id)
      .single();
    isAdmin = profile?.role === "Admin";
  }
} catch (error) {
  console.error("Error checking admin status:", error);
}

// Suggested categories
const suggestedCategories = [
  "purpose_context",
  "current_state",
  "learnings",
  "approach",
  "tools",
  "company_policy",
  "nfpa_standards",
  "procedures",
];
---

<App title="AI Agent Knowledge Management" {currentUser}>
  <div class="mx-auto max-w-6xl px-4 py-8 sm:px-6 lg:px-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
        AI Agent Knowledge Management
      </h1>
      <p class="mt-2 text-gray-600 dark:text-gray-400">
        Add and manage knowledge entries that the AI agent uses in conversations
      </p>
    </div>

    <div class="grid grid-cols-1 gap-8 lg:grid-cols-2">
      <!-- Add Knowledge Form -->
      <div
        class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">
          Add New Knowledge Entry
        </h2>

        <form id="knowledge-form" class="space-y-4">
          <!-- Title -->
          <div>
            <label
              for="title"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Title <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              id="title"
              name="title"
              required
              class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              placeholder="e.g., Company Policy, NFPA 13 Requirements"
            />
          </div>

          <!-- Content -->
          <div>
            <label
              for="content"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Content <span class="text-red-500">*</span>
            </label>
            <textarea
              id="content"
              name="content"
              required
              rows="6"
              class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              placeholder="Enter the knowledge content that the agent should know..."></textarea>
          </div>

          <!-- Category -->
          <div>
            <label
              for="category"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Category
            </label>
            <input
              type="text"
              id="category"
              name="category"
              list="categories"
              class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              placeholder="e.g., company_policy, nfpa_standards"
            />
            <datalist id="categories">
              {suggestedCategories.map((cat) => <option value={cat} />)}
            </datalist>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Suggested: {suggestedCategories.join(", ")}
            </p>
          </div>

          <!-- Tags -->
          <div>
            <label
              for="tags"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Tags (comma-separated)
            </label>
            <input
              type="text"
              id="tags"
              name="tags"
              class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              placeholder="e.g., policy, safety, nfpa13"
            />
          </div>

          <!-- Priority -->
          <div>
            <label
              for="priority"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Priority
            </label>
            <input
              type="number"
              id="priority"
              name="priority"
              value="0"
              min="-10"
              max="10"
              class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Higher priority entries appear first (range: -10 to 10, default: 0)
            </p>
          </div>

          <!-- Project ID (optional) -->
          <div>
            <label
              for="projectId"
              class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Project ID (optional)
            </label>
            <input
              type="number"
              id="projectId"
              name="projectId"
              class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
              placeholder="Leave empty for global knowledge"
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Leave empty for global knowledge available to all conversations
            </p>
          </div>

          <!-- Submit Button -->
          <div class="pt-4">
            <button
              type="submit"
              class="w-full rounded-md bg-primary-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2"
            >
              Add Knowledge Entry
            </button>
          </div>
        </form>

        <!-- Success/Error Messages -->
        <div id="form-message" class="mt-4 hidden rounded-md p-3 text-sm"></div>
      </div>

      <!-- Existing Entries List -->
      <div
        class="rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
      >
        <div class="mb-4 flex items-center justify-between">
          <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Existing Entries</h2>
          <button
            id="refresh-entries"
            class="rounded-md bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
          >
            Refresh
          </button>
        </div>

        <div id="entries-list" class="space-y-3">
          <p class="text-sm text-gray-500 dark:text-gray-400">Loading entries...</p>
        </div>
      </div>
    </div>
  </div>
</App>

<script>
  const form = document.getElementById("knowledge-form") as HTMLFormElement;
  const formMessage = document.getElementById("form-message");
  const entriesList = document.getElementById("entries-list");
  const refreshBtn = document.getElementById("refresh-entries");

  // Load entries on page load
  loadEntries();

  // Handle form submission
  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData = new FormData(form);
    const tags =
      formData
        .get("tags")
        ?.toString()
        .split(",")
        .map((t) => t.trim())
        .filter((t) => t) || [];
    const projectId = formData.get("projectId")?.toString().trim();

    const entry = {
      title: formData.get("title"),
      content: formData.get("content"),
      category: formData.get("category")?.toString().trim() || null,
      tags: tags,
      priority: parseInt(formData.get("priority")?.toString() || "0"),
      projectId: projectId ? parseInt(projectId) : null,
    };

    try {
      const response = await fetch("/api/agent/knowledge", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(entry),
      });

      const result = await response.json();

      if (result.success) {
        showMessage("Knowledge entry added successfully!", "success");
        form.reset();
        loadEntries();
      } else {
        showMessage(`Error: ${result.error || result.message}`, "error");
      }
    } catch (error: any) {
      showMessage(`Error: ${error.message}`, "error");
    }
  });

  // Load entries
  async function loadEntries() {
    try {
      const response = await fetch("/api/agent/knowledge?limit=50", {
        credentials: "include",
      });
      const result = await response.json();

      if (result.success && result.entries) {
        displayEntries(result.entries);
      } else {
        entriesList.innerHTML = `<p class="text-sm text-red-500">Error loading entries</p>`;
      }
    } catch (error: any) {
      entriesList.innerHTML = `<p class="text-sm text-red-500">Error: ${error.message}</p>`;
    }
  }

  // Display entries
  function displayEntries(entries: any[]) {
    if (entries.length === 0) {
      entriesList.innerHTML = `<p class="text-sm text-gray-500 dark:text-gray-400">No entries yet. Add one using the form on the left.</p>`;
      return;
    }

    entriesList.innerHTML = entries
      .map(
        (entry) => `
      <div class="rounded-md border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-900">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h3 class="font-medium text-gray-900 dark:text-white">${escapeHtml(entry.title)}</h3>
            ${entry.category ? `<span class="mt-1 inline-block rounded bg-primary-100 px-2 py-0.5 text-xs text-primary-800 dark:bg-primary-900 dark:text-primary-200">${escapeHtml(entry.category)}</span>` : ""}
            <p class="mt-2 text-sm text-gray-600 dark:text-gray-400 line-clamp-2">${escapeHtml(entry.content)}</p>
            <div class="mt-2 flex flex-wrap gap-2 text-xs text-gray-500 dark:text-gray-400">
              ${entry.tags && entry.tags.length > 0 ? entry.tags.map((tag: string) => `<span>#${escapeHtml(tag)}</span>`).join("") : ""}
              <span>Priority: ${entry.priority || 0}</span>
              ${entry.projectId ? `<span>Project: ${entry.projectId}</span>` : "<span>Global</span>"}
            </div>
          </div>
          <button
            onclick="deleteEntry('${entry.id}')"
            class="ml-2 rounded p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20"
            title="Delete entry"
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          </button>
        </div>
      </div>
    `
      )
      .join("");
  }

  // Delete entry
  async function deleteEntry(id: string) {
    if (!confirm("Are you sure you want to delete this knowledge entry?")) {
      return;
    }

    try {
      const response = await fetch(`/api/agent/knowledge?id=${id}`, {
        method: "DELETE",
        credentials: "include",
      });

      const result = await response.json();

      if (result.success) {
        showMessage("Entry deleted successfully!", "success");
        loadEntries();
      } else {
        showMessage(`Error: ${result.error || result.message}`, "error");
      }
    } catch (error: any) {
      showMessage(`Error: ${error.message}`, "error");
    }
  }

  // Show message
  function showMessage(message: string, type: "success" | "error") {
    formMessage.textContent = message;
    formMessage.className = `mt-4 rounded-md p-3 text-sm ${
      type === "success"
        ? "bg-green-50 text-green-800 dark:bg-green-900/20 dark:text-green-400"
        : "bg-red-50 text-red-800 dark:bg-red-900/20 dark:text-red-400"
    }`;
    formMessage.classList.remove("hidden");

    setTimeout(() => {
      formMessage.classList.add("hidden");
    }, 5000);
  }

  // Escape HTML
  function escapeHtml(text: string) {
    const div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
  }

  // Make deleteEntry available globally
  window.deleteEntry = deleteEntry;

  // Refresh button
  refreshBtn?.addEventListener("click", loadEntries);
</script>
