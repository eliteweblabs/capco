---
import App from "../../components/common/App.astro";
import { checkAuth } from "../../lib/auth";

const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role || "Client";

// Require Admin or Staff role
if (!currentUser) {
  return Astro.redirect("/auth/login");
}

if (currentRole !== "Admin" && currentRole !== "Staff") {
  return Astro.redirect("/dashboard");
}
---

<App title="Certify PDF">
  <div class="max-w-4xl mx-auto p-6">
    <h1 class="text-3xl font-bold mb-6">Certify PDF with IdenTrust Certificate</h1>

    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
      <h2 class="text-lg font-semibold text-blue-900 mb-2">About PDF Certification</h2>
      <p class="text-blue-800 text-sm">
        This tool signs PDFs with your IdenTrust certificate, providing digital authentication and
        proving document integrity. The certificate proves the document was certified by you and
        hasn't been tampered with.
      </p>
      <p class="text-blue-800 text-sm mt-2">
        <strong>Note:</strong> This provides authentication (signing), not encryption. For
        encryption, use the password-based encryption features in the PDF system.
      </p>
    </div>

    <form id="certify-pdf-form" class="space-y-6">
      <!-- File Upload -->
      <div>
        <label for="pdf-file" class="block text-sm font-medium text-gray-700 mb-2">
          Select PDF File
        </label>
        <input
          type="file"
          id="pdf-file"
          name="file"
          accept=".pdf"
          required
          class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
        />
        <p class="mt-1 text-sm text-gray-500">Maximum file size: 50MB</p>
      </div>

      <!-- Signing Options -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="reason" class="block text-sm font-medium text-gray-700 mb-2">
            Reason for Signing
          </label>
          <input
            type="text"
            id="reason"
            name="reason"
            value="Document certification"
            placeholder="e.g., Document certification"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label for="location" class="block text-sm font-medium text-gray-700 mb-2">
            Location
          </label>
          <input
            type="text"
            id="location"
            name="location"
            value="Certified by CAPCo Design Group"
            placeholder="e.g., Certified by CAPCo Design Group"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>
      </div>

      <div>
        <label for="contact-info" class="block text-sm font-medium text-gray-700 mb-2">
          Contact Information (Optional)
        </label>
        <input
          type="text"
          id="contact-info"
          name="contactInfo"
          placeholder="Email or phone number"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>

      <!-- Visible Signature Option -->
      <div class="flex items-center">
        <input
          type="checkbox"
          id="visible-signature"
          name="visible"
          value="true"
          class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
        />
        <label for="visible-signature" class="ml-2 block text-sm text-gray-700">
          Add visible signature annotation (experimental)
        </label>
      </div>

      <div id="page-number-container" class="hidden">
        <label for="page-number" class="block text-sm font-medium text-gray-700 mb-2">
          Page Number for Signature
        </label>
        <input
          type="number"
          id="page-number"
          name="pageNumber"
          min="1"
          value="1"
          class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
        />
      </div>

      <!-- Submit Button -->
      <div class="flex gap-4">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Certify PDF
        </button>
        <button
          type="button"
          id="cancel-btn"
          class="px-6 py-3 border border-gray-300 rounded-lg font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
        >
          Cancel
        </button>
      </div>
    </form>

    <!-- Results Section -->
    <div id="results-section" class="hidden mt-6">
      <div class="bg-green-50 border border-green-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-green-900 mb-2">PDF Certified Successfully!</h3>
        <div id="results-content" class="text-sm text-green-800"></div>
        <div class="mt-4">
          <a
            id="download-link"
            href="#"
            download
            class="inline-block bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700"
          >
            Download Certified PDF
          </a>
        </div>
      </div>
    </div>

    <!-- Error Section -->
    <div id="error-section" class="hidden mt-6">
      <div class="bg-red-50 border border-red-200 rounded-lg p-4">
        <h3 class="text-lg font-semibold text-red-900 mb-2">Error</h3>
        <p id="error-message" class="text-sm text-red-800"></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("certify-pdf-form") as HTMLFormElement;
      const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
      const cancelBtn = document.getElementById("cancel-btn") as HTMLButtonElement;
      const resultsSection = document.getElementById("results-section") as HTMLDivElement;
      const errorSection = document.getElementById("error-section") as HTMLDivElement;
      const errorMessage = document.getElementById("error-message") as HTMLParagraphElement;
      const resultsContent = document.getElementById("results-content") as HTMLDivElement;
      const downloadLink = document.getElementById("download-link") as HTMLAnchorElement;
      const visibleSignatureCheckbox = document.getElementById(
        "visible-signature"
      ) as HTMLInputElement;
      const pageNumberContainer = document.getElementById(
        "page-number-container"
      ) as HTMLDivElement;

      // Toggle page number input based on visible signature checkbox
      visibleSignatureCheckbox.addEventListener("change", () => {
        if (visibleSignatureCheckbox.checked) {
          pageNumberContainer.classList.remove("hidden");
        } else {
          pageNumberContainer.classList.add("hidden");
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Reset UI
        resultsSection.classList.add("hidden");
        errorSection.classList.add("hidden");
        submitBtn.disabled = true;
        submitBtn.textContent = "Certifying...";

        try {
          const formData = new FormData(form);

          const response = await fetch("/api/pdf/sign", {
            method: "POST",
            body: formData,
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to certify PDF");
          }

          // Show success
          if (data.success && data.data) {
            const metadata = data.data.metadata || {};
            resultsContent.innerHTML = `
              <p><strong>File:</strong> ${data.data.fileName}</p>
              <p><strong>Signed by:</strong> ${metadata.signer || "Unknown"}</p>
              <p><strong>Signed at:</strong> ${new Date(metadata.signedAt || Date.now()).toLocaleString()}</p>
              <p><strong>Reason:</strong> ${metadata.reason || "N/A"}</p>
              <p><strong>Location:</strong> ${metadata.location || "N/A"}</p>
            `;

            if (data.data.downloadUrl) {
              downloadLink.href = data.data.downloadUrl;
            } else {
              downloadLink.href = "#";
              downloadLink.onclick = (e) => {
                e.preventDefault();
                alert("Download URL not available. Please contact support.");
              };
            }

            resultsSection.classList.remove("hidden");
            form.reset();
          } else {
            throw new Error("Unexpected response format");
          }
        } catch (error) {
          console.error("Error certifying PDF:", error);
          errorMessage.textContent =
            error instanceof Error ? error.message : "Unknown error occurred";
          errorSection.classList.remove("hidden");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "Certify PDF";
        }
      });

      cancelBtn.addEventListener("click", () => {
        form.reset();
        resultsSection.classList.add("hidden");
        errorSection.classList.add("hidden");
      });
    });
  </script>
</App>

