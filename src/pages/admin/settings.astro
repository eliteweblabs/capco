---
/**
 * Global Settings Page
 * Edit and manage global company branding settings (colors, logos, icons, company info)
 * Settings are stored in database, with fallback to environment variables
 */
import { checkAuth } from "../../lib/auth";
import App from "../../components/ui/App.astro";
import Button from "../../components/common/Button.astro";
import DeleteConfirmButton from "../../components/common/DeleteConfirmButton.astro";
import { globalCompanyData } from "../api/global/global-company-data";
import { globalClasses } from "../api/global/global-classes";

const { currentUser, session } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

const companyData = await globalCompanyData();
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

// Check which settings exist in database
import { supabaseAdmin } from "../../lib/supabase-admin";
let dbSettings: Record<string, boolean> = {};
if (supabaseAdmin) {
  try {
    const { data } = await supabaseAdmin.from("globalSettings").select("key");

    if (data) {
      dbSettings = data.reduce(
        (acc, item) => {
          acc[item.key] = true;
          return acc;
        },
        {} as Record<string, boolean>
      );
    }
  } catch (error) {
    console.warn("[settings] Failed to check database settings:", error);
  }
}

// Helper to check if setting is from database
const isFromDatabase = (key: string) => dbSettings[key] || false;

// Get current values (from database or env vars)
const settings = {
  // Company Info
  companyName: companyData.globalCompanyName || "",
  slogan: companyData.globalCompanySlogan || "",
  address: companyData.globalCompanyAddress || "",
  phone: companyData.globalCompanyPhone || "",
  email: companyData.globalCompanyEmail || "",
  website: companyData.globalCompanyWebsite || "",

  // Colors
  primaryColor: companyData.primaryColor || "#825BDD",
  secondaryColor: companyData.secondaryColor || "#0ea5e9",

  // Typography
  fontFamily: companyData.fontFamily || "Outfit Variable",
  secondaryFontFamily: companyData.secondaryFontFamily || "sans-serif",

  // Logos & Icons (single SVG with CSS for theme support)
  logo: companyData.globalCompanyLogo || "",
  icon: companyData.globalCompanyIcon || "",

  // OG Image (for social sharing)
  ogImage: companyData.ogImage || "",

  // Analytics
  plausibleTrackingScript: companyData?.plausibleTrackingScript || "",

  // Social Networks (array of {url: string, label?: string})
  socialNetworks: companyData.socialNetworks || [],

  // Custom CSS (advanced customization)
  customCss: companyData.customCss || "",
};
---

<App
  title="Global Settings"
  description="Manage company branding and global settings"
  {currentUser}
  {session}
  globalCompanyName={companyData.globalCompanyName}
  globalCompanySlogan={companyData.globalCompanySlogan}
  globalCompanyLogo={companyData.globalCompanyLogo}
>
  <div class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold mb-2">Global Settings</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Manage company branding, colors, logos, and other global settings. Changes are saved to the
        database and take effect immediately.
      </p>
    </div>

    <!-- Success/Error Messages -->
    <div
      id="success-message"
      class="hidden mb-4 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg"
    >
      <p class="text-sm text-green-800 dark:text-green-200"></p>
    </div>
    <div
      id="error-message"
      class="hidden mb-4 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg"
    >
      <p class="text-sm text-red-800 dark:text-red-200"></p>
    </div>

    <!-- Info Box -->
    <div class="hidden mb-6 space-y-3">
      <div
        class="p-4 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg"
      >
        <p class="hidden text-sm text-primary-800 dark:text-primary-200 mb-2">
          <strong>‚úÖ Database Storage:</strong> Settings are now stored in the database and can be edited
          here. Environment variables are used as fallback if database values are not set.
        </p>
        <p class="hidden text-xs text-primary-700 dark:text-primary-300 mb-2">
          <strong>üí° Tip:</strong> Changes take effect immediately. Colors will regenerate the full palette
          on next page load.
        </p>
        <div class="hidden flex items-start gap-2 text-xs text-primary-700 dark:text-primary-300">
          <span>üíæ</span>
          <span>Indicates settings stored in database (vs environment variables)</span>
        </div>
      </div>
    </div>

    <form id="settings-form" class="space-y-6">
      <!-- Company Information -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Company Information</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="companyName" class="block text-sm font-medium mb-2">
              Company Name
              {
                isFromDatabase("companyName") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <input
              type="text"
              id="companyName"
              name="companyName"
              value={settings.companyName}
              class={globalInputClasses}
              placeholder="Your Company Name"
            />
          </div>

          <div>
            <label for="slogan" class="block text-sm font-medium mb-2">
              Slogan
              {
                isFromDatabase("slogan") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <input
              type="text"
              id="slogan"
              name="slogan"
              value={settings.slogan}
              class={globalInputClasses}
              placeholder="Your company slogan"
            />
          </div>

          <div>
            <label for="address" class="block text-sm font-medium mb-2">
              Address
              {
                isFromDatabase("address") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <input
              type="text"
              id="address"
              name="address"
              value={settings.address}
              class={globalInputClasses}
              placeholder="123 Main St, City, ST 12345"
            />
          </div>

          <div>
            <label for="phone" class="block text-sm font-medium mb-2">
              Phone
              {
                isFromDatabase("phone") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              value={settings.phone}
              class={globalInputClasses}
              placeholder="+1234567890"
            />
          </div>

          <div>
            <label for="email" class="block text-sm font-medium mb-2">
              Email
              {
                isFromDatabase("email") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <input
              type="email"
              id="email"
              name="email"
              value={settings.email}
              class={globalInputClasses}
              placeholder="contact@company.com"
            />
          </div>

          <div>
            <label for="website" class="block text-sm font-medium mb-2">
              Website
              {
                isFromDatabase("website") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <input
              type="url"
              id="website"
              name="website"
              value={settings.website}
              class={globalInputClasses}
              placeholder="https://yourcompany.com"
            />
          </div>
        </div>
      </div>

      <!-- Social Networks -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-2">Social Networks</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Add your social media profiles. Icons are automatically detected based on the URL.
        </p>

        <div id="social-networks-container" class="space-y-3">
          {
            settings.socialNetworks.length > 0 ? (
              settings.socialNetworks.map((social, index) => (
                <div class="social-network-item flex items-center gap-3" data-index={index}>
                  <div class="flex-1">
                    <input
                      type="url"
                      name={`social_url_${index}`}
                      value={social.url}
                      class={`${globalInputClasses} social-url-input`}
                      placeholder="https://facebook.com/yourpage"
                    />
                  </div>
                  <div class="w-32">
                    <input
                      type="text"
                      name={`social_label_${index}`}
                      value={social.label || ""}
                      class={`${globalInputClasses} social-label-input`}
                      placeholder="Label (optional)"
                    />
                  </div>
                  <div class="w-10 h-10 flex items-center justify-center text-xl social-icon-preview text-gray-400">
                    <i class="fa-solid fa-link" />
                  </div>
                  <DeleteConfirmButton
                    id={`remove-social-${index}`}
                    class="remove-social-btn"
                    size="sm"
                    variant="icon"
                  />
                </div>
              ))
            ) : (
              <p
                class="text-sm text-gray-500 dark:text-gray-400 py-4 text-center"
                id="no-socials-message"
              >
                No social networks added yet. Click the button below to add one.
              </p>
            )
          }
        </div>

        <button
          type="button"
          id="add-social-btn"
          class="mt-4 inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary-600 dark:text-primary-400 bg-primary-50 dark:bg-primary-900/20 hover:bg-primary-100 dark:hover:bg-primary-900/40 rounded-lg transition-colors"
        >
          <i class="fa-solid fa-plus"></i>
          Add Social Network
        </button>

        <!-- Hidden input to store the JSON value -->
        <input
          type="hidden"
          id="social_networks"
          name="social_networks"
          value={JSON.stringify(settings.socialNetworks)}
        />
      </div>

      <!-- Analytics Settings -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Analytics Settings</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Configure Plausible Analytics integration. Leave empty to disable analytics tracking.
        </p>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label for="plausible_tracking_script" class="block text-sm font-medium mb-2">
              Plausible Tracking Script
              {
                isFromDatabase("plausible_tracking_script") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <textarea
              id="plausible_tracking_script"
              name="plausible_tracking_script"
              rows="4"
              class={globalInputClasses}
              placeholder='<script defer data-domain="yourdomain.com" src="https://plausible.example.com/js/script.js"></script>'
              >{settings.plausibleTrackingScript}</textarea
            >
            <p class="text-xs text-gray-500 mt-1">
              Paste your complete Plausible tracking script here. Get this from your Plausible
              dashboard.
            </p>
          </div>
        </div>
      </div>

      <!-- Custom CSS -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-2">Custom CSS</h2>
        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
          Add custom CSS to override styles or add unique styling to your site. This CSS will be
          injected into every page.
        </p>
        <div
          class="mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 rounded border border-yellow-200 dark:border-yellow-800"
        >
          <p class="text-xs text-yellow-800 dark:text-yellow-200">
            <strong>‚ö†Ô∏è Advanced:</strong> Only use this if you're familiar with CSS. Invalid CSS may
            break the site's appearance. CSS is applied globally and will affect all pages.
          </p>
        </div>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <label for="custom_css" class="block text-sm font-medium mb-2">
              Custom CSS
              {
                isFromDatabase("custom_css") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <textarea
              id="custom_css"
              name="custom_css"
              rows="12"
              class={globalInputClasses + " font-mono text-xs"}
              placeholder={`/* Example: Override button styles */
.btn-primary {
  background-color: #ff6b6b;
  border-radius: 12px;
}

/* Example: Custom utility class */
.custom-highlight {
  background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}`}>{settings.customCss}</textarea
            >
            <p class="text-xs text-gray-500 mt-1">
              Enter custom CSS rules. Changes take effect immediately after saving. Use CSS
              variables like <code>var(--color-primary-500)</code> for consistent theming.
            </p>
          </div>
        </div>
      </div>

      <!-- Typography -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Typography</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="font_family" class="block text-sm font-medium mb-2">
              Primary Font Family
              {
                isFromDatabase("font_family") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <select id="font_family" name="font_family" class={globalInputClasses}>
              <option value="Outfit Variable" selected={settings.fontFamily === "Outfit Variable"}
                >Outfit Variable</option
              >
              <option value="Roboto" selected={settings.fontFamily === "Roboto"}>Roboto</option>
              <option value="Open Sans" selected={settings.fontFamily === "Open Sans"}
                >Open Sans</option
              >
              <option value="Lato" selected={settings.fontFamily === "Lato"}>Lato</option>
              <option value="Montserrat" selected={settings.fontFamily === "Montserrat"}
                >Montserrat</option
              >
              <option value="Poppins" selected={settings.fontFamily === "Poppins"}>Poppins</option>
              <option value="Inter" selected={settings.fontFamily === "Inter"}>Inter</option>
              <option value="Raleway" selected={settings.fontFamily === "Raleway"}>Raleway</option>
              <option value="Source Sans Pro" selected={settings.fontFamily === "Source Sans Pro"}
                >Source Sans Pro</option
              >
              <option value="Nunito" selected={settings.fontFamily === "Nunito"}>Nunito</option>
              <option value="Playfair Display" selected={settings.fontFamily === "Playfair Display"}
                >Playfair Display</option
              >
              <option value="Merriweather" selected={settings.fontFamily === "Merriweather"}
                >Merriweather</option
              >
              <option value="Oswald" selected={settings.fontFamily === "Oswald"}>Oswald</option>
              <option value="Lora" selected={settings.fontFamily === "Lora"}>Lora</option>
              <option value="PT Sans" selected={settings.fontFamily === "PT Sans"}>PT Sans</option>
              <option value="Ubuntu" selected={settings.fontFamily === "Ubuntu"}>Ubuntu</option>
              <option value="Noto Sans" selected={settings.fontFamily === "Noto Sans"}
                >Noto Sans</option
              >
              <option value="Work Sans" selected={settings.fontFamily === "Work Sans"}
                >Work Sans</option
              >
              <option value="Crimson Text" selected={settings.fontFamily === "Crimson Text"}
                >Crimson Text</option
              >
              <option value="Fira Sans" selected={settings.fontFamily === "Fira Sans"}
                >Fira Sans</option
              >
              <option value="Dancing Script" selected={settings.fontFamily === "Dancing Script"}
                >Dancing Script</option
              >
              <option value="Bebas Neue" selected={settings.fontFamily === "Bebas Neue"}
                >Bebas Neue</option
              >
              <option value="Comfortaa" selected={settings.fontFamily === "Comfortaa"}
                >Comfortaa</option
              >
              <option value="Quicksand" selected={settings.fontFamily === "Quicksand"}
                >Quicksand</option
              >
              <option value="Rubik" selected={settings.fontFamily === "Rubik"}>Rubik</option>
              <option value="Josefin Sans" selected={settings.fontFamily === "Josefin Sans"}
                >Josefin Sans</option
              >
              <option
                value="Libre Baskerville"
                selected={settings.fontFamily === "Libre Baskerville"}>Libre Baskerville</option
              >
              <option value="Cabin" selected={settings.fontFamily === "Cabin"}>Cabin</option>
              <option value="Dosis" selected={settings.fontFamily === "Dosis"}>Dosis</option>
              <option value="Arvo" selected={settings.fontFamily === "Arvo"}>Arvo</option>
              <option value="Titillium Web" selected={settings.fontFamily === "Titillium Web"}
                >Titillium Web</option
              >
              <option value="Mukta" selected={settings.fontFamily === "Mukta"}>Mukta</option>
              <option value="Karla" selected={settings.fontFamily === "Karla"}>Karla</option>
              <option value="Barlow" selected={settings.fontFamily === "Barlow"}>Barlow</option>
              <option value="DM Sans" selected={settings.fontFamily === "DM Sans"}>DM Sans</option>
              <option value="Manrope" selected={settings.fontFamily === "Manrope"}>Manrope</option>
              <option value="Space Grotesk" selected={settings.fontFamily === "Space Grotesk"}
                >Space Grotesk</option
              >
              <option
                value="Plus Jakarta Sans"
                selected={settings.fontFamily === "Plus Jakarta Sans"}>Plus Jakarta Sans</option
              >
            </select>
            <p class="text-xs text-gray-500 mt-1">
              Primary font used throughout the site (headings, body text, UI elements).
            </p>
          </div>
          <div>
            <label for="secondary_font_family" class="block text-sm font-medium mb-2">
              Secondary Font Family
              {
                isFromDatabase("secondary_font_family") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <select
              id="secondary_font_family"
              name="secondary_font_family"
              class={globalInputClasses}
            >
              <option value="sans-serif" selected={settings.secondaryFontFamily === "sans-serif"}
                >sans-serif (System Default)</option
              >
              <option value="serif" selected={settings.secondaryFontFamily === "serif"}
                >serif (System Default)</option
              >
              <option value="monospace" selected={settings.secondaryFontFamily === "monospace"}
                >monospace (System Default)</option
              >
              <option
                value="Outfit Variable"
                selected={settings.secondaryFontFamily === "Outfit Variable"}
                >Outfit Variable</option
              >
              <option value="Roboto" selected={settings.secondaryFontFamily === "Roboto"}
                >Roboto</option
              >
              <option value="Open Sans" selected={settings.secondaryFontFamily === "Open Sans"}
                >Open Sans</option
              >
              <option value="Lato" selected={settings.secondaryFontFamily === "Lato"}>Lato</option>
              <option value="Montserrat" selected={settings.secondaryFontFamily === "Montserrat"}
                >Montserrat</option
              >
              <option value="Poppins" selected={settings.secondaryFontFamily === "Poppins"}
                >Poppins</option
              >
              <option value="Inter" selected={settings.secondaryFontFamily === "Inter"}
                >Inter</option
              >
              <option value="Raleway" selected={settings.secondaryFontFamily === "Raleway"}
                >Raleway</option
              >
              <option
                value="Source Sans Pro"
                selected={settings.secondaryFontFamily === "Source Sans Pro"}
                >Source Sans Pro</option
              >
              <option value="Nunito" selected={settings.secondaryFontFamily === "Nunito"}
                >Nunito</option
              >
              <option
                value="Playfair Display"
                selected={settings.secondaryFontFamily === "Playfair Display"}
                >Playfair Display</option
              >
              <option
                value="Merriweather"
                selected={settings.secondaryFontFamily === "Merriweather"}>Merriweather</option
              >
              <option value="Oswald" selected={settings.secondaryFontFamily === "Oswald"}
                >Oswald</option
              >
              <option value="Lora" selected={settings.secondaryFontFamily === "Lora"}>Lora</option>
              <option value="PT Sans" selected={settings.secondaryFontFamily === "PT Sans"}
                >PT Sans</option
              >
              <option value="Ubuntu" selected={settings.secondaryFontFamily === "Ubuntu"}
                >Ubuntu</option
              >
              <option value="Noto Sans" selected={settings.secondaryFontFamily === "Noto Sans"}
                >Noto Sans</option
              >
              <option value="Work Sans" selected={settings.secondaryFontFamily === "Work Sans"}
                >Work Sans</option
              >
              <option
                value="Crimson Text"
                selected={settings.secondaryFontFamily === "Crimson Text"}>Crimson Text</option
              >
              <option value="Fira Sans" selected={settings.secondaryFontFamily === "Fira Sans"}
                >Fira Sans</option
              >
              <option
                value="Dancing Script"
                selected={settings.secondaryFontFamily === "Dancing Script"}>Dancing Script</option
              >
              <option value="Bebas Neue" selected={settings.secondaryFontFamily === "Bebas Neue"}
                >Bebas Neue</option
              >
              <option value="Comfortaa" selected={settings.secondaryFontFamily === "Comfortaa"}
                >Comfortaa</option
              >
              <option value="Quicksand" selected={settings.secondaryFontFamily === "Quicksand"}
                >Quicksand</option
              >
              <option value="Rubik" selected={settings.secondaryFontFamily === "Rubik"}
                >Rubik</option
              >
              <option
                value="Josefin Sans"
                selected={settings.secondaryFontFamily === "Josefin Sans"}>Josefin Sans</option
              >
              <option
                value="Libre Baskerville"
                selected={settings.secondaryFontFamily === "Libre Baskerville"}
                >Libre Baskerville</option
              >
              <option value="Cabin" selected={settings.secondaryFontFamily === "Cabin"}
                >Cabin</option
              >
              <option value="Dosis" selected={settings.secondaryFontFamily === "Dosis"}
                >Dosis</option
              >
              <option value="Arvo" selected={settings.secondaryFontFamily === "Arvo"}>Arvo</option>
              <option
                value="Titillium Web"
                selected={settings.secondaryFontFamily === "Titillium Web"}>Titillium Web</option
              >
              <option value="Mukta" selected={settings.secondaryFontFamily === "Mukta"}
                >Mukta</option
              >
              <option value="Karla" selected={settings.secondaryFontFamily === "Karla"}
                >Karla</option
              >
              <option value="Barlow" selected={settings.secondaryFontFamily === "Barlow"}
                >Barlow</option
              >
              <option value="DM Sans" selected={settings.secondaryFontFamily === "DM Sans"}
                >DM Sans</option
              >
              <option value="Manrope" selected={settings.secondaryFontFamily === "Manrope"}
                >Manrope</option
              >
              <option
                value="Space Grotesk"
                selected={settings.secondaryFontFamily === "Space Grotesk"}>Space Grotesk</option
              >
              <option
                value="Plus Jakarta Sans"
                selected={settings.secondaryFontFamily === "Plus Jakarta Sans"}
                >Plus Jakarta Sans</option
              >
            </select>
            <p class="text-xs text-gray-500 mt-1">
              Secondary font used as fallback or for specific elements (optional).
            </p>
          </div>
        </div>
      </div>

      <!-- Brand Colors -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Brand Colors</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label for="primary_color" class="block text-sm font-medium mb-2">
              Primary Color
              {
                isFromDatabase("primary_color") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <div class="flex items-center gap-3">
              <input
                type="color"
                id="primary_color_picker"
                value={settings.primaryColor}
                class="w-16 h-16 rounded border-2 border-gray-300 dark:border-gray-600 cursor-pointer"
              />
              <div class="flex-1">
                <input
                  type="text"
                  id="primary_color"
                  name="primary_color"
                  value={settings.primaryColor}
                  class={globalInputClasses + " font-mono"}
                  placeholder="#825BDD"
                  pattern="^#[0-9A-Fa-f]{6}$"
                />
                <p class="text-xs text-gray-500 mt-1">Hex color code (e.g., #825BDD)</p>
              </div>
            </div>
          </div>

          <div>
            <label for="secondary_color" class="block text-sm font-medium mb-2">
              Secondary Color
              {
                isFromDatabase("secondary_color") && (
                  <span
                    class="ml-2 text-xs text-green-600 dark:text-green-400"
                    title="Stored in database"
                  >
                    üíæ
                  </span>
                )
              }
            </label>
            <div class="flex items-center gap-3">
              <input
                type="color"
                id="secondary_color_picker"
                value={settings.secondaryColor}
                class="w-16 h-16 rounded border-2 border-gray-300 dark:border-gray-600 cursor-pointer"
              />
              <div class="flex-1">
                <input
                  type="text"
                  id="secondary_color"
                  name="secondary_color"
                  value={settings.secondaryColor}
                  class={globalInputClasses + " font-mono"}
                  placeholder="#0ea5e9"
                  pattern="^#[0-9A-Fa-f]{6}$"
                />
                <p class="text-xs text-gray-500 mt-1">Hex color code (e.g., #0ea5e9)</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Logos -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Company Logo (SVG)</h2>
        <div
          class="mb-4 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700"
        >
          <p class="text-xs text-gray-600 dark:text-gray-400">
            <strong>üí° Tip:</strong> Use a single SVG with CSS styles in <code>&lt;defs&gt;</code> or
            <code>&lt;style&gt;</code> to handle both light and dark modes. Use <code
              >currentColor</code
            > or media queries like <code>@media (prefers-color-scheme: dark)</code> for automatic theme
            switching.
          </p>
        </div>
        <div>
          <label for="logo" class="block text-sm font-medium mb-2">
            Logo SVG
            {
              isFromDatabase("logo") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <textarea
                id="logo"
                name="logo"
                rows={8}
                class={globalInputClasses + " font-mono text-xs"}
                placeholder={`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 60">
  <defs>
    <style>
      .logo-fill { fill: currentColor; }
      @media (prefers-color-scheme: dark) {
        .logo-fill { fill: #ffffff; }
      }
    </style>
  </defs>
  <path class="logo-fill" d="..."/>
</svg>`}>{settings.logo}</textarea
              >
              <p class="text-xs text-gray-500 mt-1">
                Complete SVG markup with CSS for theme support. Use <code>currentColor</code> or CSS
                media queries for automatic light/dark mode.
              </p>
            </div>
            <div class="space-y-3">
              <div
                id="logo-preview-light"
                class="relative flex items-center justify-center p-4 bg-white rounded border border-gray-200"
              >
                <p class="text-xs text-gray-500 mb-2 absolute top-1 left-2">Light Mode</p>
                {
                  settings.logo ? (
                    <div class="max-w-full max-h-32 mt-4 [&>*]:w-full" set:html={settings.logo} />
                  ) : (
                    <p class="text-xs text-gray-400 text-center">Preview will appear here</p>
                  )
                }
              </div>
              <div
                id="logo-preview-dark"
                class="dark relative flex items-center justify-center p-4 bg-gray-900 rounded border border-gray-700"
              >
                <p class="text-xs text-gray-400 mb-2 absolute top-1 left-2">Dark Mode</p>
                {
                  settings.logo ? (
                    <div class="max-w-full max-h-32 mt-4 [&>*]:w-full" set:html={settings.logo} />
                  ) : (
                    <p class="text-xs text-gray-400 text-center">Preview will appear here</p>
                  )
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Icons -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Company Icon (SVG)</h2>
        <div
          class="mb-4 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700"
        >
          <p class="text-xs text-gray-600 dark:text-gray-400">
            <strong>üí° Tip:</strong> Use a single SVG with CSS for theme support. The icon is used for
            favicons and app icons.
          </p>
        </div>
        <div>
          <label for="icon" class="block text-sm font-medium mb-2">
            Icon SVG
            {
              isFromDatabase("icon") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <textarea
                id="icon"
                name="icon"
                rows={8}
                class={globalInputClasses + " font-mono text-xs"}
                placeholder={`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <defs>
    <style>
      .icon-fill { fill: currentColor; }
      @media (prefers-color-scheme: dark) {
        .icon-fill { fill: #ffffff; }
      }
    </style>
  </defs>
  <path class="icon-fill" d="..."/>
</svg>`}>{settings.icon}</textarea
              >
              <p class="text-xs text-gray-500 mt-1">
                Square SVG icon (used for favicon). Use CSS for automatic theme support.
              </p>
            </div>
            <div class="space-y-3">
              <div
                id="icon-preview-light"
                class="flex items-center justify-center p-4 bg-white rounded border border-gray-200 relative"
              >
                <p class="text-xs text-gray-500 mb-2 absolute top-1 left-2">Light Mode</p>
                {
                  settings.icon ? (
                    <div class="w-16 h-16 mt-4" set:html={settings.icon} />
                  ) : (
                    <p class="text-xs text-gray-400 text-center">Preview will appear here</p>
                  )
                }
              </div>
              <div
                id="icon-preview-dark"
                class="flex items-center justify-center p-4 bg-gray-900 rounded border border-gray-700 relative"
              >
                <p class="text-xs text-gray-400 mb-2 absolute top-1 left-2">Dark Mode</p>
                {
                  settings.icon ? (
                    <div class="w-16 h-16 mt-4" set:html={settings.icon} />
                  ) : (
                    <p class="text-xs text-gray-400 text-center">Preview will appear here</p>
                  )
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- OG Image -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">OG Image (Social Sharing)</h2>
        <div
          class="mb-4 p-3 bg-gray-50 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700"
        >
          <p class="text-xs text-gray-600 dark:text-gray-400">
            <strong>üí° Tip:</strong> This image appears when your site is shared on social media (Facebook,
            Twitter, LinkedIn, etc.). Recommended size: 1200x630 pixels. Supported formats: PNG, JPG,
            GIF, WebP.
          </p>
        </div>
        <div>
          <label for="og_image" class="block text-sm font-medium mb-2">
            OG Image URL
            {
              isFromDatabase("og_image") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <input
                type="text"
                id="og_image"
                name="og_image"
                value={settings.ogImage}
                class={globalInputClasses}
                placeholder="/images/og-image.png or https://example.com/og-image.png"
              />
              <p class="text-xs text-gray-500 mt-1">
                Enter a URL path (e.g., <code>/images/og-image.png</code>) or full URL. Image will
                be used for social media previews.
              </p>
            </div>
            <div>
              <div
                id="og-image-preview"
                class="flex items-center justify-center p-4 bg-gray-100 dark:bg-gray-900 rounded border border-gray-200 dark:border-gray-700 min-h-[120px]"
              >
                {
                  settings.ogImage ? (
                    <img
                      src={settings.ogImage}
                      alt="OG Image Preview"
                      class="max-w-full max-h-32 object-contain rounded"
                    />
                  ) : (
                    <p class="text-xs text-gray-400 text-center">Preview will appear here</p>
                  )
                }
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex justify-between items-center">
        <a
          href="/admin/cms"
          class="text-sm text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-gray-100"
        >
          ‚Üê Back to CMS
        </a>
        <div class="flex gap-3">
          <Button type="button" variant="primary" id="reset-form-btn"> Reset </Button>
          <Button type="submit" variant="secondary" id="save-settings-btn"> Save Settings </Button>
        </div>
      </div>
    </form>
  </div>
</App>

<script>
  const form = document.getElementById("settings-form") as HTMLFormElement;
  const saveBtn = document.getElementById("save-settings-btn") as HTMLButtonElement;

  // Sync color pickers with text inputs
  const primaryColorPicker = document.getElementById("primary_color_picker") as HTMLInputElement;
  const primaryColorInput = document.getElementById("primary_color") as HTMLInputElement;
  const secondaryColorPicker = document.getElementById(
    "secondary_color_picker"
  ) as HTMLInputElement;
  const secondaryColorInput = document.getElementById("secondary_color") as HTMLInputElement;

  primaryColorPicker?.addEventListener("input", (e) => {
    primaryColorInput.value = (e.target as HTMLInputElement).value;
  });

  primaryColorInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      primaryColorPicker.value = value;
    }
  });

  secondaryColorPicker?.addEventListener("input", (e) => {
    secondaryColorInput.value = (e.target as HTMLInputElement).value;
  });

  secondaryColorInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      secondaryColorPicker.value = value;
    }
  });

  // Live preview for logos and icons
  function updatePreview(textareaId: string, previewSelector: string) {
    const textarea = document.getElementById(textareaId) as HTMLTextAreaElement;
    const preview = document.querySelector(previewSelector) as HTMLElement;

    if (textarea && preview) {
      textarea.addEventListener("input", (e) => {
        const svgContent = (e.target as HTMLTextAreaElement).value.trim();
        if (svgContent && svgContent.startsWith("<svg")) {
          preview.innerHTML = svgContent;
          preview.querySelector("p")?.remove();
        } else {
          preview.innerHTML =
            '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
        }
      });
    }
  }

  // Set up live previews for both light and dark mode
  function updatePreviewBoth(
    textareaId: string,
    lightSelector: string,
    darkSelector: string,
    isIcon: boolean = false
  ) {
    const textarea = document.getElementById(textareaId) as HTMLTextAreaElement;
    const lightPreview = document.querySelector(lightSelector) as HTMLElement;
    const darkPreview = document.querySelector(darkSelector) as HTMLElement;

    if (textarea && lightPreview && darkPreview) {
      textarea.addEventListener("input", (e) => {
        const svgContent = (e.target as HTMLTextAreaElement).value.trim();
        if (svgContent && svgContent.startsWith("<svg")) {
          // Determine size class based on whether it's an icon or logo
          const sizeClass = isIcon ? "w-16 h-16" : "max-w-full max-h-32";

          // Update light preview
          const lightContent = lightPreview.querySelector("div");
          if (lightContent) {
            lightContent.innerHTML = svgContent;
            lightPreview.querySelector("p.text-xs")?.remove();
          } else {
            // Remove placeholder text and add SVG
            const placeholder = lightPreview.querySelector("p");
            if (placeholder) placeholder.remove();
            lightPreview.innerHTML = `<p class="text-xs text-gray-500 mb-2 absolute top-1 left-2">Light Mode</p><div class="${sizeClass} mt-4">${svgContent}</div>`;
          }

          // Update dark preview
          const darkContent = darkPreview.querySelector("div");
          if (darkContent) {
            darkContent.innerHTML = svgContent;
            darkPreview.querySelector("p.text-xs")?.remove();
          } else {
            // Remove placeholder text and add SVG
            const placeholder = darkPreview.querySelector("p");
            if (placeholder) placeholder.remove();
            darkPreview.innerHTML = `<p class="text-xs text-gray-400 mb-2 absolute top-1 left-2">Dark Mode</p><div class="${sizeClass} mt-4">${svgContent}</div>`;
          }
        } else {
          // Reset to placeholder
          const lightLabel = lightPreview.querySelector("p.text-xs.text-gray-500");
          const darkLabel = darkPreview.querySelector("p.text-xs.text-gray-400");
          lightPreview.innerHTML = lightLabel
            ? `${lightLabel.outerHTML}<p class="text-xs text-gray-400 text-center">Preview will appear here</p>`
            : '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
          darkPreview.innerHTML = darkLabel
            ? `${darkLabel.outerHTML}<p class="text-xs text-gray-400 text-center">Preview will appear here</p>`
            : '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
        }
      });
    }
  }

  updatePreviewBoth("logo", "#logo-preview-light", "#logo-preview-dark", false);
  updatePreviewBoth("icon", "#icon-preview-light", "#icon-preview-dark", true);

  // =====================
  // Social Networks Repeater
  // =====================

  const socialContainer = document.getElementById("social-networks-container");
  const addSocialBtn = document.getElementById("add-social-btn");
  const socialNetworksInput = document.getElementById("social_networks") as HTMLInputElement;
  const noSocialsMessage = document.getElementById("no-socials-message");
  let socialIndex = document.querySelectorAll(".social-network-item").length;

  /**
   * Detect social network icon based on URL
   */
  function detectSocialIcon(url: string): string {
    const urlLower = url.toLowerCase();

    if (urlLower.includes("facebook.com") || urlLower.includes("fb.com"))
      return "fa-brands fa-facebook-f";
    if (urlLower.includes("twitter.com") || urlLower.includes("x.com"))
      return "fa-brands fa-x-twitter";
    if (urlLower.includes("instagram.com")) return "fa-brands fa-instagram";
    if (urlLower.includes("linkedin.com")) return "fa-brands fa-linkedin-in";
    if (urlLower.includes("youtube.com") || urlLower.includes("youtu.be"))
      return "fa-brands fa-youtube";
    if (urlLower.includes("tiktok.com")) return "fa-brands fa-tiktok";
    if (urlLower.includes("pinterest.com")) return "fa-brands fa-pinterest-p";
    if (urlLower.includes("snapchat.com")) return "fa-brands fa-snapchat";
    if (urlLower.includes("github.com")) return "fa-brands fa-github";
    if (urlLower.includes("discord.com") || urlLower.includes("discord.gg"))
      return "fa-brands fa-discord";
    if (urlLower.includes("whatsapp.com") || urlLower.includes("wa.me"))
      return "fa-brands fa-whatsapp";
    if (urlLower.includes("telegram.org") || urlLower.includes("t.me"))
      return "fa-brands fa-telegram";
    if (urlLower.includes("reddit.com")) return "fa-brands fa-reddit-alien";
    if (urlLower.includes("threads.net")) return "fa-brands fa-threads";
    if (urlLower.includes("twitch.tv")) return "fa-brands fa-twitch";
    if (urlLower.includes("spotify.com")) return "fa-brands fa-spotify";
    if (urlLower.includes("yelp.com")) return "fa-brands fa-yelp";
    if (urlLower.includes("google.com/maps") || urlLower.includes("business.google"))
      return "fa-brands fa-google";
    if (urlLower.startsWith("mailto:")) return "fa-solid fa-envelope";
    if (urlLower.startsWith("tel:")) return "fa-solid fa-phone";

    return "fa-solid fa-link";
  }

  /**
   * Update the hidden input with current social networks data
   */
  function updateSocialNetworksValue() {
    const items = document.querySelectorAll(".social-network-item");
    const socials: Array<{ url: string; label?: string }> = [];

    items.forEach((item) => {
      const urlInput = item.querySelector(".social-url-input") as HTMLInputElement;
      const labelInput = item.querySelector(".social-label-input") as HTMLInputElement;

      if (urlInput?.value?.trim()) {
        const social: { url: string; label?: string } = { url: urlInput.value.trim() };
        if (labelInput?.value?.trim()) {
          social.label = labelInput.value.trim();
        }
        socials.push(social);
      }
    });

    socialNetworksInput.value = JSON.stringify(socials);

    // Show/hide no socials message
    if (noSocialsMessage) {
      noSocialsMessage.style.display = items.length === 0 ? "block" : "none";
    }
  }

  /**
   * Update icon preview for a social network item
   */
  function updateIconPreview(item: Element) {
    const urlInput = item.querySelector(".social-url-input") as HTMLInputElement;
    const iconPreview = item.querySelector(".social-icon-preview");

    if (urlInput && iconPreview) {
      const icon = detectSocialIcon(urlInput.value || "");
      iconPreview.innerHTML = `<i class="${icon}"></i>`;

      // Update color based on detection
      if (urlInput.value && !urlInput.value.includes("link")) {
        iconPreview.classList.remove("text-gray-400");
        iconPreview.classList.add("text-primary-600", "dark:text-primary-400");
      } else {
        iconPreview.classList.add("text-gray-400");
        iconPreview.classList.remove("text-primary-600", "dark:text-primary-400");
      }
    }
  }

  /**
   * Create a new social network item
   */
  function createSocialItem(index: number, url: string = "", label: string = ""): HTMLElement {
    const div = document.createElement("div");
    div.className = "social-network-item flex items-center gap-3";
    div.dataset.index = String(index);

    div.innerHTML = `
      <div class="flex-1">
        <input
          type="url"
          name="social_url_${index}"
          value="${url}"
          class="${(document.querySelector('[class*="globalInputClasses"]') as HTMLInputElement)?.className || "block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"} social-url-input"
          placeholder="https://facebook.com/yourpage"
        />
      </div>
      <div class="w-32">
        <input
          type="text"
          name="social_label_${index}"
          value="${label}"
          class="${(document.querySelector('[class*="globalInputClasses"]') as HTMLInputElement)?.className || "block w-full rounded-lg border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white sm:text-sm"} social-label-input"
          placeholder="Label (optional)"
        />
      </div>
      <div class="w-10 h-10 flex items-center justify-center text-xl social-icon-preview text-gray-400">
        <i class="fa-solid fa-link"></i>
      </div>
      <button
        id="remove-social-${index}"
        type="button"
        class="delete-confirm-btn remove-social-btn inline-flex items-center justify-center rounded-full bg-red-500 text-white hover:bg-red-600 transition-colors text-sm px-3 py-3"
        title="Delete"
        data-state="trash"
        data-timeout="3000"
      >
        <svg class="delete-confirm-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
        </svg>
      </button>
    `;

    return div;
  }

  /**
   * Attach event listeners to a social network item
   */
  function attachSocialItemListeners(item: Element) {
    // URL input change - update icon and value
    const urlInput = item.querySelector(".social-url-input");
    urlInput?.addEventListener("input", () => {
      updateIconPreview(item);
      updateSocialNetworksValue();
    });

    // Label input change - update value
    const labelInput = item.querySelector(".social-label-input");
    labelInput?.addEventListener("input", updateSocialNetworksValue);

    // Remove button - listen for deleteConfirmed event
    const removeBtn = item.querySelector(".remove-social-btn");
    removeBtn?.addEventListener("deleteConfirmed", () => {
      item.remove();
      updateSocialNetworksValue();
    });

    // Initial icon preview
    updateIconPreview(item);
  }

  // Initialize existing items
  document.querySelectorAll(".social-network-item").forEach(attachSocialItemListeners);

  // Add new social network
  addSocialBtn?.addEventListener("click", () => {
    // Hide no socials message
    if (noSocialsMessage) {
      noSocialsMessage.style.display = "none";
    }

    const newItem = createSocialItem(socialIndex++);
    socialContainer?.appendChild(newItem);
    attachSocialItemListeners(newItem);

    // Focus the new URL input
    const urlInput = newItem.querySelector(".social-url-input") as HTMLInputElement;
    urlInput?.focus();
  });

  // Live preview for OG image
  const ogImageInput = document.getElementById("og_image") as HTMLInputElement;
  const ogImagePreview = document.getElementById("og-image-preview") as HTMLElement;

  ogImageInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value.trim();
    if (value) {
      ogImagePreview.innerHTML = `<img src="${value}" alt="OG Image Preview" class="max-w-full max-h-32 object-contain rounded" onerror="this.parentElement.innerHTML='<p class=\\'text-xs text-red-400 text-center\\'>Failed to load image</p>'" />`;
    } else {
      ogImagePreview.innerHTML =
        '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
    }
  });

  // Reset button
  const resetBtn = document.getElementById("reset-form-btn");
  resetBtn?.addEventListener("click", () => {
    if (
      confirm("Reset all fields to current saved values? This will discard any unsaved changes.")
    ) {
      window.location.reload();
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Clear any previous notifications

    // Disable submit button
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";
    }

    // Collect form data
    const formData = new FormData(form);
    const settings: Record<string, string> = {};

    // Map form field names to database keys
    const fieldMapping: Record<string, string> = {
      companyName: "companyName",
      slogan: "slogan",
      address: "address",
      phone: "phone",
      email: "email",
      website: "website",
      primary_color: "primary_color",
      secondary_color: "secondary_color",
      font_family: "font_family",
      secondary_font_family: "secondary_font_family",
      logo: "logo",
      icon: "icon",
      og_image: "og_image",
      plausible_tracking_script: "plausible_tracking_script",
      social_networks: "social_networks",
      custom_css: "custom_css",
    };

    // Validation errors
    const validationErrors: string[] = [];

    for (const [formKey, dbKey] of Object.entries(fieldMapping)) {
      const value = formData.get(formKey);
      if (value !== null && value !== undefined) {
        const trimmedValue = value.toString().trim();

        // Validate colors
        if (dbKey.includes("color") && trimmedValue) {
          if (!/^#[0-9A-Fa-f]{6}$/.test(trimmedValue)) {
            validationErrors.push(
              `${formKey.replace("_", " ")} must be a valid hex color (e.g., #825BDD)`
            );
            continue;
          }
        }

        // Validate email
        if (dbKey === "email" && trimmedValue) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(trimmedValue)) {
            validationErrors.push("Email must be a valid email address");
            continue;
          }
        }

        // Validate URL
        if (dbKey === "website" && trimmedValue) {
          try {
            new URL(trimmedValue.startsWith("http") ? trimmedValue : `https://${trimmedValue}`);
          } catch {
            validationErrors.push(`${formKey.replace("_", " ")} must be a valid URL`);
            continue;
          }
        }

        // Validate SVG (basic check)
        if ((dbKey.includes("logo") || dbKey.includes("icon")) && trimmedValue) {
          if (!trimmedValue.trim().startsWith("<svg")) {
            validationErrors.push(
              `${formKey.replace("_", " ")} must be valid SVG markup starting with <svg>`
            );
            continue;
          }
        }

        settings[dbKey] = trimmedValue;
      }
    }

    // Show validation errors
    if (validationErrors.length > 0) {
      const errorText = "Validation errors:\n" + validationErrors.join("\n");
      if (window.showError) {
        window.showError("Validation Error", errorText, 0);
      }

      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Settings";
      }
      return;
    }

    try {
      const response = await fetch("/api/settings/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ settings }),
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        // Show detailed error information
        const errorMsg = result.errorDetails
          ? `${result.message || "Failed to save settings"}\n\nDetails:\n${result.errorDetails}`
          : result.error || result.message || "Failed to save settings";
        throw new Error(errorMsg);
      }

      // Show success message
      if (window.showSuccess) {
        window.showSuccess(
          "Settings Saved",
          "Settings saved successfully! Regenerating colors...",
          4000
        );
      }

      // Inject dynamic colors and fonts if they were updated
      if (
        settings.primary_color ||
        settings.secondary_color ||
        settings.font_family ||
        settings.secondary_font_family
      ) {
        try {
          // Import and inject dynamic colors
          const { injectDynamicColors } = await import("../../lib/dynamic-colors");

          // Get the new color values from the settings object we just saved
          const newPrimaryColor = settings.primary_color || primaryColorInput?.value;
          const newSecondaryColor = settings.secondary_color || secondaryColorInput?.value;
          const fontFamilySelect = document.getElementById("font_family") as HTMLSelectElement;
          const secondaryFontFamilySelect = document.getElementById(
            "secondary_font_family"
          ) as HTMLSelectElement;
          const newFontFamily = settings.font_family || fontFamilySelect?.value;
          const newSecondaryFontFamily =
            settings.secondary_font_family || secondaryFontFamilySelect?.value;

          if (newPrimaryColor || newSecondaryColor) {
            console.log("[settings] Injecting dynamic colors:", {
              newPrimaryColor,
              newSecondaryColor,
            });
            injectDynamicColors(newPrimaryColor || "#825BDD", newSecondaryColor || "#0ea5e9");
          }

          // Inject font families if they were updated
          if (newFontFamily) {
            document.documentElement.style.setProperty("--font-family", newFontFamily);
            console.log("[settings] Primary font family updated:", newFontFamily);
          }
          if (newSecondaryFontFamily) {
            document.documentElement.style.setProperty(
              "--font-family-secondary",
              newSecondaryFontFamily
            );
            console.log("[settings] Secondary font family updated:", newSecondaryFontFamily);
          }

          const updates = [];
          if (settings.primary_color || settings.secondary_color) updates.push("colors");
          if (settings.font_family || settings.secondary_font_family) updates.push("fonts");
          if (updates.length > 0 && window.showSuccess) {
            window.showSuccess(
              "Settings Updated",
              `Settings saved successfully! ${updates.join(" and ")} updated. Reloading page...`,
              4000
            );
          }
        } catch (error) {
          console.error("[settings] Failed to inject dynamic colors/fonts:", error);
        }
      }

      // Reload page after 1.5 seconds to show updated values and ensure all changes are applied
      setTimeout(() => {
        window.location.reload();
      }, 1500);
    } catch (error: any) {
      // Show error message
      const errorMsg = error.message || "An error occurred while saving settings.";
      if (window.showError) {
        window.showError("Save Failed", errorMsg, 0);
      }

      // Re-enable submit button
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Settings";
      }
    }
  });
</script>
