---
/**
 * Global Settings Page
 * Edit and manage global company branding settings (colors, logos, icons, company info)
 * Settings are stored in database, with fallback to environment variables
 */
import { checkAuth } from "../../lib/auth";
import { isAdminOrSuperAdmin } from "../../lib/user-utils";
import LayoutFullWidth from "../../components/layouts/LayoutFullWidth.astro";
import Button from "../../components/common/Button.astro";
import DeleteConfirmButton from "../../components/ui/DeleteConfirmButton.astro";
import SocialMediaRepeater from "../../components/form/SocialMediaRepeater.astro";
import { globalCompanyData } from "../api/global/global-company-data";
import { globalClasses } from "../api/global/global-classes";

const { currentUser, session } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

if (!isAdminOrSuperAdmin(currentRole)) {
  return Astro.redirect("/dashboard");
}

const companyData = await globalCompanyData();
const { globalFormClasses, globalInputClasses, primaryTextClasses, secondaryTextClasses } =
  globalClasses();

// Check which settings exist in database
import { supabaseAdmin } from "../../lib/supabase-admin";
let dbSettings: Record<string, boolean> = {};
if (supabaseAdmin) {
  try {
    const { data } = await supabaseAdmin.from("globalSettings").select("key");

    if (data) {
      dbSettings = data.reduce(
        (acc, item) => {
          acc[item.key] = true;
          return acc;
        },
        {} as Record<string, boolean>
      );
    }
  } catch (error) {
    console.warn("[settings] Failed to check database settings:", error);
  }
}

// Helper to check if setting is from database
const isFromDatabase = (key: string) => dbSettings[key] || false;

// Get current values (from database or env vars)
const settings = {
  // Company Info
  companyName: companyData.globalCompanyName || "",
  slogan: companyData.globalCompanySlogan || "",
  tightSlogan: companyData.globalCompanyTightSlogan || "",
  address: companyData.globalCompanyAddress || "",
  phone: companyData.globalCompanyPhone || "",
  email: companyData.globalCompanyEmail || "",
  website: companyData.globalCompanyWebsite || "",
  virtualAssistantName: companyData.virtualAssistantName || "",

  // Colors
  primaryColor: companyData.primaryColor || "#825BDD",
  secondaryColor: companyData.secondaryColor || "#0ea5e9",
  backgroundColor: companyData.backgroundColor || "#ffffff",
  backgroundColorDark: companyData.backgroundColorDark || "#0a0a0a",

  // Typography
  fontFamily: companyData.fontFamily || "Outfit Variable",
  secondaryFontFamily: companyData.secondaryFontFamily || "sans-serif",

  // Logos & Icons (single SVG with CSS for theme support)
  logo: companyData.globalCompanyLogo || "",
  icon: companyData.globalCompanyIcon || "",

  // OG Image (for social sharing)
  ogImage: companyData.ogImage || "",

  // Analytics
  plausibleTrackingScript: companyData?.plausibleTrackingScript || "",

  // Social Networks (array of {url: string, label?: string})
  socialNetworks: companyData.socialNetworks || [],

  // Custom CSS (advanced customization)
  customCss: companyData.customCss || "",

  // Custom Footer HTML (injected into footer)
  customFooterHtml: companyData.customFooterHtml || "",

  // Logo Classes (for styling the logo)
  logoClasses: companyData.logoClasses || "",
};

// Rendered icon files that exist in public/ (so list persists after refresh)
import fs from "fs";
import path from "path";
const publicDir = path.join(process.cwd(), "public");
const iconFileCandidates: { file: string; path: string; size: string; type: string }[] = [
  { file: "favicon.svg", path: "/favicon.svg", size: "any", type: "image/svg+xml" },
  { file: "favicon.png", path: "/favicon.png", size: "512x512", type: "image/png" },
  {
    file: "apple-touch-icon.png",
    path: "/apple-touch-icon.png",
    size: "180x180",
    type: "image/png",
  },
];
const renderedIconFiles = iconFileCandidates.filter((c) =>
  fs.existsSync(path.join(publicDir, c.file))
);
---

<LayoutFullWidth
  title="Global Settings"
  description="Manage company branding, colors, logos, and global settings. Changes are saved to the database."
  classList="p-4"
>
  <div class="px-4 py-8">
    <div class="mb-6">
      <h1 class="mb-2 text-3xl font-bold">Global Settings</h1>
      <p class="text-gray-600 dark:text-gray-400">
        Manage company branding, colors, logos, and other global settings. Changes are saved to the
        database and take effect immediately.
      </p>
    </div>

    <!-- Success/Error Messages -->
    <div
      id="success-message"
      class="mb-4 hidden rounded-lg border border-green-200 bg-green-50 p-4 dark:border-green-800 dark:bg-green-900/20"
    >
      <p class="text-sm text-green-800 dark:text-green-200"></p>
    </div>
    <div
      id="error-message"
      class="mb-4 hidden rounded-lg border border-red-200 bg-red-50 p-4 dark:border-red-800 dark:bg-red-900/20"
    >
      <p class="text-sm text-red-800 dark:text-red-200"></p>
    </div>

    <form id="settings-form" class={globalFormClasses}>
      <!-- Company Information -->
      <h2 class="mb-4 text-xl font-semibold">Company Information</h2>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label for="companyName" class="mb-2 block text-sm font-medium">
            Company Name
            {
              isFromDatabase("companyName") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="text"
            id="companyName"
            name="companyName"
            value={settings.companyName}
            class={globalInputClasses}
            placeholder="Your Company Name"
          />
        </div>

        <div>
          <label for="slogan" class="mb-2 block text-sm font-medium">
            Slogan
            {
              isFromDatabase("slogan") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="text"
            id="slogan"
            name="slogan"
            value={settings.slogan}
            class={globalInputClasses}
            placeholder="Your company slogan"
          />
        </div>

        <div>
          <label for="tightSlogan" class="mb-2 block text-sm font-medium">
            Tight Slogan (short for &lt;md screens)
            {
              isFromDatabase("tightSlogan") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="text"
            id="tightSlogan"
            name="tightSlogan"
            value={settings.tightSlogan}
            class={globalInputClasses}
            placeholder="Short slogan for mobile"
          />
        </div>

        <div>
          <label for="address" class="mb-2 block text-sm font-medium">
            Address
            {
              isFromDatabase("address") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="text"
            id="address"
            name="address"
            value={settings.address}
            class={globalInputClasses}
            placeholder="123 Main St, City, ST 12345"
          />
        </div>

        <div>
          <label for="phone" class="mb-2 block text-sm font-medium">
            Phone
            {
              isFromDatabase("phone") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="tel"
            id="phone"
            name="phone"
            value={settings.phone}
            class={globalInputClasses}
            placeholder="+1234567890"
          />
        </div>

        <div>
          <label for="email" class="mb-2 block text-sm font-medium">
            Email
            {
              isFromDatabase("email") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="email"
            id="email"
            name="email"
            value={settings.email}
            class={globalInputClasses}
            placeholder="contact@company.com"
          />
        </div>

        <div>
          <label for="website" class="mb-2 block text-sm font-medium">
            Website
            {
              isFromDatabase("website") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="url"
            id="website"
            name="website"
            value={settings.website}
            class={globalInputClasses}
            placeholder="https://yourcompany.com"
          />
        </div>

        <div>
          <label for="virtual_assistant_name" class="mb-2 block text-sm font-medium">
            Virtual Assistant Name
            {
              isFromDatabase("virtualAssistantName") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <input
            type="text"
            id="virtual_assistant_name"
            name="virtual_assistant_name"
            value={settings.virtualAssistantName}
            class={globalInputClasses}
            placeholder="e.g. Leah"
          />
          <p class="mt-1 text-xs text-gray-500">
            Name shown in the contact form and as the project assistant (e.g. &quot;Hi, I&apos;m
            Leah...&quot;).
          </p>
        </div>
      </div>

      <!-- Social Networks -->
      <div class="rounded-lg">
        <h2 class="mb-2 text-xl font-semibold">Social Networks</h2>
        <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
          Add your social media profiles. Icons are automatically detected based on the URL.
        </p>

        <SocialMediaRepeater
          id="settings-socials"
          name="social_networks"
          value={settings.socialNetworks}
          inputClasses={globalInputClasses}
          addButtonLabel="Add Social Network"
          emptyMessage="No social networks added yet. Click the button below to add one."
        />
      </div>

      <!-- Analytics Settings -->
      <h2 class="mb-4 text-xl font-semibold">Analytics Settings</h2>
      <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        Configure Plausible Analytics integration. Leave empty to disable analytics tracking.
      </p>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label for="plausible_tracking_script" class="mb-2 block text-sm font-medium">
            Plausible Tracking Script
            {
              isFromDatabase("plausibleTrackingScript") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <textarea
            id="plausible_tracking_script"
            name="plausible_tracking_script"
            rows="4"
            class={globalInputClasses}
            placeholder='<script defer data-domain="yourdomain.com" src="https://plausible.example.com/js/script.js"></script>'
            >{settings.plausibleTrackingScript}</textarea
          >
          <p class="mt-1 text-xs text-gray-500">
            Paste your complete Plausible tracking script here. Get this from your Plausible
            dashboard.
          </p>
        </div>
      </div>

      <!-- Custom CSS -->
      <h2 class="mb-4 text-xl font-semibold">Custom CSS</h2>
      <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        Add custom CSS to override styles or add unique styling to your site. This CSS will be
        injected into every page.
      </p>
      <div
        class="mb-4 rounded border border-yellow-200 bg-yellow-50 p-3 dark:border-yellow-800 dark:bg-yellow-900/20"
      >
        <p class="text-xs text-yellow-800 dark:text-yellow-200">
          <strong>‚ö†Ô∏è Advanced:</strong> Only use this if you're familiar with CSS. Invalid CSS may break
          the site's appearance. CSS is applied globally and will affect all pages.
        </p>
      </div>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label for="custom_css" class="mb-2 block text-sm font-medium">
            CSS code
            {
              isFromDatabase("customCss") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <textarea
            id="custom_css"
            name="custom_css"
            rows="12"
            class={globalInputClasses + " font-mono text-xs"}
            placeholder={`/* Example: Override button styles */
.btn-primary {
  background-color: #ff6b6b;
  border-radius: 12px;
}

/* Example: Custom utility class */
.custom-highlight {
  background: linear-gradient(120deg, #f093fb 0%, #f5576c 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}`}>{settings.customCss}</textarea
          >
          <p class="mt-1 text-xs text-gray-500">
            Enter custom CSS rules. Changes take effect immediately after saving. Use CSS variables
            like <code>var(--color-primary-500)</code> for consistent theming.
          </p>
        </div>
      </div>

      <!-- Custom Footer HTML -->
      <h2 class="mb-4 text-xl font-semibold">Custom Footer HTML</h2>
      <p class="mb-4 text-sm text-gray-600 dark:text-gray-400">
        Inject custom HTML into the footer. Use for scripts, tracking pixels, or extra links.
      </p>
      <div
        class="mb-4 rounded border border-yellow-200 bg-yellow-50 p-3 dark:border-yellow-800 dark:bg-yellow-900/20"
      >
        <p class="text-xs text-yellow-800 dark:text-yellow-200">
          <strong>‚ö†Ô∏è Advanced:</strong> Only use trusted HTML. Malicious script injection can compromise
          your site. HTML is rendered as-is.
        </p>
      </div>
      <div class="grid grid-cols-1 gap-4">
        <div>
          <label for="custom_footer_html" class="mb-2 block text-sm font-medium">
            HTML code
            {
              isFromDatabase("customFooterHtml") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <textarea
            id="custom_footer_html"
            name="custom_footer_html"
            rows="6"
            class={globalInputClasses + " font-mono text-xs"}
            placeholder={`<!-- Example: Extra links -->
<div class="text-center text-xs text-gray-500">
  <a href="/privacy">Privacy</a> ‚Ä¢ <a href="/terms">Terms</a>
</div>`}>{settings.customFooterHtml}</textarea
          >
          <p class="mt-1 text-xs text-gray-500">
            HTML is injected inside the footer. Changes take effect immediately after saving.
          </p>
        </div>
      </div>

      <!-- Typography -->
      <h2 class="mb-4 text-xl font-semibold">Typography</h2>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label for="font_family" class="mb-2 block text-sm font-medium">
            Primary Font Family
            {
              isFromDatabase("fontFamily") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <select id="font_family" name="font_family" class={globalInputClasses}>
            <option value="Outfit Variable" selected={settings.fontFamily === "Outfit Variable"}
              >Outfit Variable</option
            >
            <option value="Roboto" selected={settings.fontFamily === "Roboto"}>Roboto</option>
            <option value="Open Sans" selected={settings.fontFamily === "Open Sans"}
              >Open Sans</option
            >
            <option value="Lato" selected={settings.fontFamily === "Lato"}>Lato</option>
            <option value="Montserrat" selected={settings.fontFamily === "Montserrat"}
              >Montserrat</option
            >
            <option value="Poppins" selected={settings.fontFamily === "Poppins"}>Poppins</option>
            <option value="Inter" selected={settings.fontFamily === "Inter"}>Inter</option>
            <option value="Raleway" selected={settings.fontFamily === "Raleway"}>Raleway</option>
            <option value="Source Sans Pro" selected={settings.fontFamily === "Source Sans Pro"}
              >Source Sans Pro</option
            >
            <option value="Nunito" selected={settings.fontFamily === "Nunito"}>Nunito</option>
            <option value="Playfair Display" selected={settings.fontFamily === "Playfair Display"}
              >Playfair Display</option
            >
            <option value="Merriweather" selected={settings.fontFamily === "Merriweather"}
              >Merriweather</option
            >
            <option value="Oswald" selected={settings.fontFamily === "Oswald"}>Oswald</option>
            <option value="Lora" selected={settings.fontFamily === "Lora"}>Lora</option>
            <option value="PT Sans" selected={settings.fontFamily === "PT Sans"}>PT Sans</option>
            <option value="Ubuntu" selected={settings.fontFamily === "Ubuntu"}>Ubuntu</option>
            <option value="Noto Sans" selected={settings.fontFamily === "Noto Sans"}
              >Noto Sans</option
            >
            <option value="Work Sans" selected={settings.fontFamily === "Work Sans"}
              >Work Sans</option
            >
            <option value="Crimson Text" selected={settings.fontFamily === "Crimson Text"}
              >Crimson Text</option
            >
            <option value="Fira Sans" selected={settings.fontFamily === "Fira Sans"}
              >Fira Sans</option
            >
            <option value="Dancing Script" selected={settings.fontFamily === "Dancing Script"}
              >Dancing Script</option
            >
            <option value="Bebas Neue" selected={settings.fontFamily === "Bebas Neue"}
              >Bebas Neue</option
            >
            <option value="Comfortaa" selected={settings.fontFamily === "Comfortaa"}
              >Comfortaa</option
            >
            <option value="Quicksand" selected={settings.fontFamily === "Quicksand"}
              >Quicksand</option
            >
            <option value="Rubik" selected={settings.fontFamily === "Rubik"}>Rubik</option>
            <option value="Josefin Sans" selected={settings.fontFamily === "Josefin Sans"}
              >Josefin Sans</option
            >
            <option value="Libre Baskerville" selected={settings.fontFamily === "Libre Baskerville"}
              >Libre Baskerville</option
            >
            <option value="Cabin" selected={settings.fontFamily === "Cabin"}>Cabin</option>
            <option value="Dosis" selected={settings.fontFamily === "Dosis"}>Dosis</option>
            <option value="Arvo" selected={settings.fontFamily === "Arvo"}>Arvo</option>
            <option value="Titillium Web" selected={settings.fontFamily === "Titillium Web"}
              >Titillium Web</option
            >
            <option value="Mukta" selected={settings.fontFamily === "Mukta"}>Mukta</option>
            <option value="Karla" selected={settings.fontFamily === "Karla"}>Karla</option>
            <option value="Barlow" selected={settings.fontFamily === "Barlow"}>Barlow</option>
            <option value="DM Sans" selected={settings.fontFamily === "DM Sans"}>DM Sans</option>
            <option value="Manrope" selected={settings.fontFamily === "Manrope"}>Manrope</option>
            <option value="Space Grotesk" selected={settings.fontFamily === "Space Grotesk"}
              >Space Grotesk</option
            >
            <option value="Plus Jakarta Sans" selected={settings.fontFamily === "Plus Jakarta Sans"}
              >Plus Jakarta Sans</option
            >
          </select>
          <p class="mt-1 text-xs text-gray-500">
            Primary font used throughout the site (headings, body text, UI elements).
          </p>
        </div>
        <div>
          <label for="secondary_font_family" class="mb-2 block text-sm font-medium">
            Secondary Font Family
            {
              isFromDatabase("secondaryFontFamily") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <select
            id="secondary_font_family"
            name="secondary_font_family"
            class={globalInputClasses}
          >
            <option value="sans-serif" selected={settings.secondaryFontFamily === "sans-serif"}
              >sans-serif (System Default)</option
            >
            <option value="serif" selected={settings.secondaryFontFamily === "serif"}
              >serif (System Default)</option
            >
            <option value="monospace" selected={settings.secondaryFontFamily === "monospace"}
              >monospace (System Default)</option
            >
            <option
              value="Outfit Variable"
              selected={settings.secondaryFontFamily === "Outfit Variable"}>Outfit Variable</option
            >
            <option value="Roboto" selected={settings.secondaryFontFamily === "Roboto"}
              >Roboto</option
            >
            <option value="Open Sans" selected={settings.secondaryFontFamily === "Open Sans"}
              >Open Sans</option
            >
            <option value="Lato" selected={settings.secondaryFontFamily === "Lato"}>Lato</option>
            <option value="Montserrat" selected={settings.secondaryFontFamily === "Montserrat"}
              >Montserrat</option
            >
            <option value="Poppins" selected={settings.secondaryFontFamily === "Poppins"}
              >Poppins</option
            >
            <option value="Inter" selected={settings.secondaryFontFamily === "Inter"}>Inter</option>
            <option value="Raleway" selected={settings.secondaryFontFamily === "Raleway"}
              >Raleway</option
            >
            <option
              value="Source Sans Pro"
              selected={settings.secondaryFontFamily === "Source Sans Pro"}>Source Sans Pro</option
            >
            <option value="Nunito" selected={settings.secondaryFontFamily === "Nunito"}
              >Nunito</option
            >
            <option
              value="Playfair Display"
              selected={settings.secondaryFontFamily === "Playfair Display"}
              >Playfair Display</option
            >
            <option value="Merriweather" selected={settings.secondaryFontFamily === "Merriweather"}
              >Merriweather</option
            >
            <option value="Oswald" selected={settings.secondaryFontFamily === "Oswald"}
              >Oswald</option
            >
            <option value="Lora" selected={settings.secondaryFontFamily === "Lora"}>Lora</option>
            <option value="PT Sans" selected={settings.secondaryFontFamily === "PT Sans"}
              >PT Sans</option
            >
            <option value="Ubuntu" selected={settings.secondaryFontFamily === "Ubuntu"}
              >Ubuntu</option
            >
            <option value="Noto Sans" selected={settings.secondaryFontFamily === "Noto Sans"}
              >Noto Sans</option
            >
            <option value="Work Sans" selected={settings.secondaryFontFamily === "Work Sans"}
              >Work Sans</option
            >
            <option value="Crimson Text" selected={settings.secondaryFontFamily === "Crimson Text"}
              >Crimson Text</option
            >
            <option value="Fira Sans" selected={settings.secondaryFontFamily === "Fira Sans"}
              >Fira Sans</option
            >
            <option
              value="Dancing Script"
              selected={settings.secondaryFontFamily === "Dancing Script"}>Dancing Script</option
            >
            <option value="Bebas Neue" selected={settings.secondaryFontFamily === "Bebas Neue"}
              >Bebas Neue</option
            >
            <option value="Comfortaa" selected={settings.secondaryFontFamily === "Comfortaa"}
              >Comfortaa</option
            >
            <option value="Quicksand" selected={settings.secondaryFontFamily === "Quicksand"}
              >Quicksand</option
            >
            <option value="Rubik" selected={settings.secondaryFontFamily === "Rubik"}>Rubik</option>
            <option value="Josefin Sans" selected={settings.secondaryFontFamily === "Josefin Sans"}
              >Josefin Sans</option
            >
            <option
              value="Libre Baskerville"
              selected={settings.secondaryFontFamily === "Libre Baskerville"}
              >Libre Baskerville</option
            >
            <option value="Cabin" selected={settings.secondaryFontFamily === "Cabin"}>Cabin</option>
            <option value="Dosis" selected={settings.secondaryFontFamily === "Dosis"}>Dosis</option>
            <option value="Arvo" selected={settings.secondaryFontFamily === "Arvo"}>Arvo</option>
            <option
              value="Titillium Web"
              selected={settings.secondaryFontFamily === "Titillium Web"}>Titillium Web</option
            >
            <option value="Mukta" selected={settings.secondaryFontFamily === "Mukta"}>Mukta</option>
            <option value="Karla" selected={settings.secondaryFontFamily === "Karla"}>Karla</option>
            <option value="Barlow" selected={settings.secondaryFontFamily === "Barlow"}
              >Barlow</option
            >
            <option value="DM Sans" selected={settings.secondaryFontFamily === "DM Sans"}
              >DM Sans</option
            >
            <option value="Manrope" selected={settings.secondaryFontFamily === "Manrope"}
              >Manrope</option
            >
            <option
              value="Space Grotesk"
              selected={settings.secondaryFontFamily === "Space Grotesk"}>Space Grotesk</option
            >
            <option
              value="Plus Jakarta Sans"
              selected={settings.secondaryFontFamily === "Plus Jakarta Sans"}
              >Plus Jakarta Sans</option
            >
          </select>
          <p class="mt-1 text-xs text-gray-500">
            Secondary font used as fallback or for specific elements (optional).
          </p>
        </div>
      </div>

      <!-- Brand Colors -->
      <h2 class="mb-4 text-xl font-semibold">Brand Colors</h2>
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label for="primary_color" class="mb-2 block text-sm font-medium">
            Primary Color
            {
              isFromDatabase("primaryColor") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="flex items-center gap-3">
            <input
              type="color"
              id="primary_color_picker"
              value={settings.primaryColor}
              class="h-16 w-16 cursor-pointer rounded border-2 border-gray-300 dark:border-gray-600"
            />
            <div class="flex-1">
              <input
                type="text"
                id="primary_color"
                name="primary_color"
                value={settings.primaryColor}
                class={globalInputClasses + " font-mono"}
                placeholder="#825BDD"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
              <p class="mt-1 text-xs text-gray-500">Hex color code (e.g., #825BDD)</p>
            </div>
          </div>
        </div>

        <div>
          <label for="secondary_color" class="mb-2 block text-sm font-medium">
            Secondary Color
            {
              isFromDatabase("secondaryColor") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="flex items-center gap-3">
            <input
              type="color"
              id="secondary_color_picker"
              value={settings.secondaryColor}
              class="h-16 w-16 cursor-pointer rounded border-2 border-gray-300 dark:border-gray-600"
            />
            <div class="flex-1">
              <input
                type="text"
                id="secondary_color"
                name="secondary_color"
                value={settings.secondaryColor}
                class={globalInputClasses + " font-mono"}
                placeholder="#0ea5e9"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
              <p class="mt-1 text-xs text-gray-500">Hex color code (e.g., #0ea5e9)</p>
            </div>
          </div>
        </div>

        <div>
          <label for="background_color" class="mb-2 block text-sm font-medium">
            Background Color (Light)
            {
              isFromDatabase("backgroundColor") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="flex items-center gap-3">
            <input
              type="color"
              id="background_color_picker"
              value={settings.backgroundColor}
              class="h-16 w-16 cursor-pointer rounded border-2 border-gray-300 dark:border-gray-600"
            />
            <div class="flex-1">
              <input
                type="text"
                id="background_color"
                name="background_color"
                value={settings.backgroundColor}
                class={globalInputClasses + " font-mono"}
                placeholder="#ffffff"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
              <p class="mt-1 text-xs text-gray-500">Page background for light mode</p>
            </div>
          </div>
        </div>

        <div>
          <label for="background_color_dark" class="mb-2 block text-sm font-medium">
            Background Color (Dark)
            {
              isFromDatabase("backgroundColorDark") && (
                <span
                  class="ml-2 text-xs text-green-600 dark:text-green-400"
                  title="Stored in database"
                >
                  üíæ
                </span>
              )
            }
          </label>
          <div class="flex items-center gap-3">
            <input
              type="color"
              id="background_color_dark_picker"
              value={settings.backgroundColorDark}
              class="h-16 w-16 cursor-pointer rounded border-2 border-gray-300 dark:border-gray-600"
            />
            <div class="flex-1">
              <input
                type="text"
                id="background_color_dark"
                name="background_color_dark"
                value={settings.backgroundColorDark}
                class={globalInputClasses + " font-mono"}
                placeholder="#0a0a0a"
                pattern="^#[0-9A-Fa-f]{6}$"
              />
              <p class="mt-1 text-xs text-gray-500">Page background for dark mode</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Logos -->
      <h2 class="mb-4 text-xl font-semibold">Company Logo (SVG)</h2>
      <div
        class="mb-4 rounded border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-900"
      >
        <p class="text-xs text-gray-600 dark:text-gray-400">
          <strong>üí° Tip:</strong> Use a single SVG with CSS styles in <code>&lt;defs&gt;</code> or
          <code>&lt;style&gt;</code> to handle both light and dark modes. Use <code
            >currentColor</code
          > or media queries like <code>@media (prefers-color-scheme: dark)</code> for automatic theme
          switching.
        </p>
      </div>
      <div class="mb-4">
        <label for="logoClasses" class="mb-2 block text-sm font-medium">
          Logo CSS Classes
          {
            isFromDatabase("logoClasses") && (
              <span
                class="ml-2 text-xs text-green-600 dark:text-green-400"
                title="Stored in database"
              >
                üíæ
              </span>
            )
          }
        </label>
        <input
          type="text"
          id="logoClasses"
          name="logoClasses"
          value={settings.logoClasses}
          class={globalInputClasses}
          placeholder="h-8 w-auto text-primary-600 dark:text-white"
        />
        <p class="mt-1 text-xs text-gray-500">
          Tailwind CSS classes to style the logo wrapper (e.g., size, color, spacing).
        </p>
      </div>
      <div>
        <label for="logo" class="mb-2 block text-sm font-medium">
          Logo SVG
          {
            isFromDatabase("logo") && (
              <span
                class="ml-2 text-xs text-green-600 dark:text-green-400"
                title="Stored in database"
              >
                üíæ
              </span>
            )
          }
        </label>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <textarea
              id="logo"
              name="logo"
              rows={8}
              class={globalInputClasses + " font-mono text-xs"}
              placeholder={`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 60">
  <defs>
    <style>
      .logo-fill { fill: currentColor; }
      @media (prefers-color-scheme: dark) {
        .logo-fill { fill: #ffffff; }
      }
    </style>
  </defs>
  <path class="logo-fill" d="..."/>
</svg>`}>{settings.logo}</textarea
            >
            <p class="mt-1 text-xs text-gray-500">
              Complete SVG markup with CSS for theme support. Use <code>currentColor</code> or CSS media
              queries for automatic light/dark mode.
            </p>
          </div>
          <div class="space-y-3">
            <div
              id="logo-preview-light"
              class="relative flex items-center justify-center rounded border border-gray-200 bg-white p-4 text-gray-900"
              style="color: #111827 !important;"
            >
              <p class="absolute left-2 top-1 mb-2 text-xs text-gray-500">Light Mode</p>
              {
                settings.logo ? (
                  <div class="mt-4 max-h-32 max-w-full [&>*]:w-full" set:html={settings.logo} />
                ) : (
                  <p class="text-center text-xs text-gray-400">Preview will appear here</p>
                )
              }
            </div>
            <div
              id="logo-preview-dark"
              class="relative flex items-center justify-center rounded border border-gray-700 bg-gray-900 p-4 text-white"
              style="color: #ffffff !important;"
            >
              <p class="absolute left-2 top-1 mb-2 text-xs text-gray-400">Dark Mode</p>
              {
                settings.logo ? (
                  <div class="mt-4 max-h-32 max-w-full [&>*]:w-full" set:html={settings.logo} />
                ) : (
                  <p class="text-center text-xs text-gray-400">Preview will appear here</p>
                )
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Icons -->
      <h2 class="mb-4 text-xl font-semibold">Company Icon (SVG)</h2>
      <div
        class="mb-4 rounded border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-900"
      >
        <p class="text-xs text-gray-600 dark:text-gray-400">
          <strong>üí° Tip:</strong> Use a single SVG with CSS for theme support. The icon is used for favicons
          and app icons.
        </p>
      </div>
      <div>
        <label for="icon" class="mb-2 block text-sm font-medium">
          Icon SVG
          {
            isFromDatabase("icon") && (
              <span
                class="ml-2 text-xs text-green-600 dark:text-green-400"
                title="Stored in database"
              >
                üíæ
              </span>
            )
          }
        </label>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <textarea
              id="icon"
              name="icon"
              rows={8}
              class={globalInputClasses + " font-mono text-xs"}
              placeholder={`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  <defs>
    <style>
      .icon-fill { fill: currentColor; }
      @media (prefers-color-scheme: dark) {
        .icon-fill { fill: #ffffff; }
      }
    </style>
  </defs>
  <path class="icon-fill" d="..."/>
</svg>`}>{settings.icon}</textarea
            >
            <p class="mt-1 text-xs text-gray-500">
              Square SVG icon (used for favicon). Use CSS for automatic theme support.
            </p>
          </div>
          <div class="space-y-3">
            <div
              id="icon-preview-light"
              class="relative flex items-center justify-center rounded border border-gray-200 bg-white p-4 text-gray-900"
              style="color: #111827 !important;"
            >
              <p class="absolute left-2 top-1 mb-2 text-xs text-gray-500">Light Mode</p>
              {
                settings.icon ? (
                  <div class="mt-4 h-16 w-16" set:html={settings.icon} />
                ) : (
                  <p class="text-center text-xs text-gray-400">Preview will appear here</p>
                )
              }
            </div>
            <div
              id="icon-preview-dark"
              class="relative flex items-center justify-center rounded border border-gray-700 bg-gray-900 p-4 text-white"
              style="color: #ffffff !important;"
            >
              <p class="absolute left-2 top-1 mb-2 text-xs text-gray-400">Dark Mode</p>
              {
                settings.icon ? (
                  <div class="mt-4 h-16 w-16" set:html={settings.icon} />
                ) : (
                  <p class="text-center text-xs text-gray-400">Preview will appear here</p>
                )
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Rendered Icons (favicon.svg / favicon.png / apple-touch-icon.png created on save) -->
      <div
        class="mt-6 rounded border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-900"
      >
        <h3 class="mb-2 text-sm font-semibold">Rendered Icons</h3>
        <p class="mb-3 text-xs text-gray-600 dark:text-gray-400">
          On save, the icon above is transformed (primary color + padding) and written as favicon
          and apple-touch-icon files. Current files (persist after refresh):
        </p>
        <div
          id="rendered-icons-container"
          class="min-h-[80px] rounded border border-dashed border-gray-300 bg-white p-3 dark:border-gray-600 dark:bg-gray-800"
          aria-live="polite"
        >
          <p
            id="rendered-icons-placeholder"
            class={`text-xs text-gray-500 dark:text-gray-400 ${renderedIconFiles.length > 0 ? "hidden" : ""}`}
          >
            Save settings to generate favicon.svg, favicon.png (512√ó512), and apple-touch-icon.png
            (180√ó180).
          </p>
          <div
            id="rendered-icons-list"
            class={`mt-2 space-y-2 ${renderedIconFiles.length === 0 ? "hidden" : ""}`}
          >
            {
              renderedIconFiles.map((f) => (
                <div class="flex flex-wrap items-center gap-3 rounded border border-gray-200 bg-gray-50 p-2 dark:border-gray-600 dark:bg-gray-800">
                  <img
                    src={f.path}
                    alt=""
                    class="h-10 w-10 shrink-0 object-contain"
                    loading="lazy"
                  />
                  <div class="min-w-0 text-xs">
                    <div class="font-mono text-gray-700 dark:text-gray-300">{f.path}</div>
                    <div class="text-gray-500 dark:text-gray-400">
                      {f.size} ¬∑ {f.type}
                    </div>
                  </div>
                </div>
              ))
            }
          </div>
        </div>
      </div>

      <!-- OG Image -->
      <h2 class="mb-4 text-xl font-semibold">OG Image (Social Sharing)</h2>
      <div
        class="mb-4 rounded border border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-900"
      >
        <p class="text-xs text-gray-600 dark:text-gray-400">
          <strong>üí° Tip:</strong> This image appears when your site is shared on social media (Facebook,
          Twitter, LinkedIn, etc.). Recommended size: 1200x630 pixels. Supported formats: PNG, JPG, GIF,
          WebP.
        </p>
      </div>
      <div>
        <label for="og_image" class="mb-2 block text-sm font-medium">
          OG Image URL
          {
            isFromDatabase("ogImage") && (
              <span
                class="ml-2 text-xs text-green-600 dark:text-green-400"
                title="Stored in database"
              >
                üíæ
              </span>
            )
          }
        </label>
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <input
              type="text"
              id="og_image"
              name="og_image"
              value={settings.ogImage}
              class={globalInputClasses}
              placeholder="/images/og-image.png or https://example.com/og-image.png"
            />
            <p class="mt-1 text-xs text-gray-500">
              Enter a URL path (e.g., <code>/images/og-image.png</code>) or full URL. Image will be
              used for social media previews.
            </p>
          </div>
          <div>
            <div
              id="og-image-preview"
              class="flex min-h-[120px] items-center justify-center rounded border border-gray-200 bg-gray-100 p-4 dark:border-gray-700 dark:bg-gray-900"
            >
              {
                settings.ogImage ? (
                  <img
                    src={settings.ogImage}
                    alt="OG Image Preview"
                    class="max-h-32 max-w-full rounded object-contain"
                  />
                ) : (
                  <p class="text-center text-xs text-gray-400">Preview will appear here</p>
                )
              }
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex items-center justify-between">
        <a
          href="/admin/cms"
          class="text-sm text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-100"
        >
          ‚Üê Back to CMS
        </a>
        <div class="flex gap-3">
          <Button type="button" variant="primary" id="reset-form-btn"> Reset </Button>
          <Button type="submit" variant="secondary" id="save-settings-btn"> Save Settings </Button>
        </div>
      </div>
    </form>
  </div>
</LayoutFullWidth>

<script>
  function escapeHtml(s: string) {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  const form = document.getElementById("settings-form") as HTMLFormElement;
  const saveBtn = document.getElementById("save-settings-btn") as HTMLButtonElement;

  // Sync color pickers with text inputs
  const primaryColorPicker = document.getElementById("primary_color_picker") as HTMLInputElement;
  const primaryColorInput = document.getElementById("primary_color") as HTMLInputElement;
  const secondaryColorPicker = document.getElementById(
    "secondary_color_picker"
  ) as HTMLInputElement;
  const secondaryColorInput = document.getElementById("secondary_color") as HTMLInputElement;

  primaryColorPicker?.addEventListener("input", (e) => {
    primaryColorInput.value = (e.target as HTMLInputElement).value;
  });

  primaryColorInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      primaryColorPicker.value = value;
    }
  });

  secondaryColorPicker?.addEventListener("input", (e) => {
    secondaryColorInput.value = (e.target as HTMLInputElement).value;
  });

  secondaryColorInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      secondaryColorPicker.value = value;
    }
  });

  const backgroundColorPicker = document.getElementById(
    "background_color_picker"
  ) as HTMLInputElement;
  const backgroundColorInput = document.getElementById("background_color") as HTMLInputElement;
  const backgroundColorDarkPicker = document.getElementById(
    "background_color_dark_picker"
  ) as HTMLInputElement;
  const backgroundColorDarkInput = document.getElementById(
    "background_color_dark"
  ) as HTMLInputElement;

  backgroundColorPicker?.addEventListener("input", (e) => {
    backgroundColorInput.value = (e.target as HTMLInputElement).value;
  });

  backgroundColorInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      backgroundColorPicker.value = value;
    }
  });

  backgroundColorDarkPicker?.addEventListener("input", (e) => {
    backgroundColorDarkInput.value = (e.target as HTMLInputElement).value;
  });

  backgroundColorDarkInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value;
    if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
      backgroundColorDarkPicker.value = value;
    }
  });

  // Live preview for logos and icons
  function updatePreview(textareaId: string, previewSelector: string) {
    const textarea = document.getElementById(textareaId) as HTMLTextAreaElement;
    const preview = document.querySelector(previewSelector) as HTMLElement;

    if (textarea && preview) {
      textarea.addEventListener("input", (e) => {
        const svgContent = (e.target as HTMLTextAreaElement).value.trim();
        if (svgContent && svgContent.startsWith("<svg")) {
          preview.innerHTML = svgContent;
          preview.querySelector("p")?.remove();
        } else {
          preview.innerHTML =
            '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
        }
      });
    }
  }

  // Set up live previews for both light and dark mode
  function updatePreviewBoth(
    textareaId: string,
    lightSelector: string,
    darkSelector: string,
    isIcon: boolean = false
  ) {
    const textarea = document.getElementById(textareaId) as HTMLTextAreaElement;
    const lightPreview = document.querySelector(lightSelector) as HTMLElement;
    const darkPreview = document.querySelector(darkSelector) as HTMLElement;

    if (textarea && lightPreview && darkPreview) {
      textarea.addEventListener("input", (e) => {
        const svgContent = (e.target as HTMLTextAreaElement).value.trim();
        if (svgContent && svgContent.startsWith("<svg")) {
          // Determine size class based on whether it's an icon or logo
          const sizeClass = isIcon ? "w-16 h-16" : "max-w-full max-h-32";

          // Update light preview
          const lightContent = lightPreview.querySelector("div");
          if (lightContent) {
            lightContent.innerHTML = svgContent;
            lightPreview.querySelector("p.text-xs")?.remove();
          } else {
            // Remove placeholder text and add SVG
            const placeholder = lightPreview.querySelector("p");
            if (placeholder) placeholder.remove();
            lightPreview.innerHTML = `<p class="text-xs text-gray-500 mb-2 absolute top-1 left-2">Light Mode</p><div class="${sizeClass} mt-4">${svgContent}</div>`;
          }

          // Update dark preview
          const darkContent = darkPreview.querySelector("div");
          if (darkContent) {
            darkContent.innerHTML = svgContent;
            darkPreview.querySelector("p.text-xs")?.remove();
          } else {
            // Remove placeholder text and add SVG
            const placeholder = darkPreview.querySelector("p");
            if (placeholder) placeholder.remove();
            darkPreview.innerHTML = `<p class="text-xs text-gray-400 mb-2 absolute top-1 left-2">Dark Mode</p><div class="${sizeClass} mt-4">${svgContent}</div>`;
          }
        } else {
          // Reset to placeholder
          const lightLabel = lightPreview.querySelector("p.text-xs.text-gray-500");
          const darkLabel = darkPreview.querySelector("p.text-xs.text-gray-400");
          lightPreview.innerHTML = lightLabel
            ? `${lightLabel.outerHTML}<p class="text-xs text-gray-400 text-center">Preview will appear here</p>`
            : '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
          darkPreview.innerHTML = darkLabel
            ? `${darkLabel.outerHTML}<p class="text-xs text-gray-400 text-center">Preview will appear here</p>`
            : '<p class="text-xs text-gray-400 text-center">Preview will appear here</p>';
        }
      });
    }
  }

  updatePreviewBoth("logo", "#logo-preview-light", "#logo-preview-dark", false);
  updatePreviewBoth("icon", "#icon-preview-light", "#icon-preview-dark", true);

  // Live preview for OG image
  const ogImageInput = document.getElementById("og_image") as HTMLInputElement;
  const ogImagePreview = document.getElementById("og-image-preview") as HTMLElement;

  ogImageInput?.addEventListener("input", (e) => {
    const value = (e.target as HTMLInputElement).value.trim();
    ogImagePreview.textContent = "";
    if (value) {
      const allowed =
        value.startsWith("/") || value.startsWith("https://") || value.startsWith("http://");
      if (allowed) {
        const img = document.createElement("img");
        img.src = value;
        img.alt = "OG Image Preview";
        img.className = "max-w-full max-h-32 object-contain rounded";
        img.onerror = () => {
          const p = document.createElement("p");
          p.className = "text-xs text-red-400 text-center";
          p.textContent = "Failed to load image";
          ogImagePreview.replaceChildren(p);
        };
        ogImagePreview.appendChild(img);
      } else {
        const p = document.createElement("p");
        p.className = "text-xs text-gray-400 text-center";
        p.textContent = "Enter a URL (e.g. /images/og.png or https://...)";
        ogImagePreview.appendChild(p);
      }
    } else {
      const p = document.createElement("p");
      p.className = "text-xs text-gray-400 text-center";
      p.textContent = "Preview will appear here";
      ogImagePreview.appendChild(p);
    }
  });

  // Reset button
  const resetBtn = document.getElementById("reset-form-btn");
  resetBtn?.addEventListener("click", () => {
    if (
      confirm("Reset all fields to current saved values? This will discard any unsaved changes.")
    ) {
      window.location.reload();
    }
  });

  form?.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (window.showNotice) {
      window.showNotice("info", "Saving", "", 5000);
    }

    // Disable submit button
    if (saveBtn) {
      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";
    }

    // Collect form data
    const formData = new FormData(form);
    const settings: Record<string, string> = {};

    // Map form field names to database keys (all camelCase)
    const fieldMapping: Record<string, string> = {
      companyName: "companyName",
      slogan: "slogan",
      tightSlogan: "tightSlogan",
      address: "address",
      phone: "phone",
      email: "email",
      website: "website",
      virtual_assistant_name: "virtualAssistantName",
      primary_color: "primaryColor",
      secondary_color: "secondaryColor",
      background_color: "backgroundColor",
      background_color_dark: "backgroundColorDark",
      font_family: "fontFamily",
      secondary_font_family: "secondaryFontFamily",
      logo: "logo",
      logoClasses: "logoClasses",
      icon: "icon",
      og_image: "ogImage",
      plausible_tracking_script: "plausibleTrackingScript",
      social_networks: "socialNetworks",
      custom_css: "customCss",
      custom_footer_html: "customFooterHtml",
    };

    // Validation errors
    const validationErrors: string[] = [];

    for (const [formKey, dbKey] of Object.entries(fieldMapping)) {
      const value = formData.get(formKey);
      if (value !== null && value !== undefined) {
        const trimmedValue = value.toString().trim();

        // Validate colors
        if (dbKey.includes("color") && trimmedValue) {
          if (!/^#[0-9A-Fa-f]{6}$/.test(trimmedValue)) {
            validationErrors.push(
              `${formKey.replace("_", " ")} must be a valid hex color (e.g., #825BDD)`
            );
            continue;
          }
        }

        // Validate email
        if (dbKey === "email" && trimmedValue) {
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(trimmedValue)) {
            validationErrors.push("Email must be a valid email address");
            continue;
          }
        }

        // Validate URL
        if (dbKey === "website" && trimmedValue) {
          try {
            new URL(trimmedValue.startsWith("http") ? trimmedValue : `https://${trimmedValue}`);
          } catch {
            validationErrors.push(`${formKey.replace("_", " ")} must be a valid URL`);
            continue;
          }
        }

        // Validate SVG (basic check) - exclude logoClasses which is for CSS classes
        if (
          (dbKey.includes("logo") || dbKey.includes("icon")) &&
          trimmedValue &&
          dbKey !== "logoClasses"
        ) {
          if (!trimmedValue.trim().startsWith("<svg")) {
            validationErrors.push(
              `${formKey.replace("_", " ")} must be valid SVG markup starting with <svg>`
            );
            continue;
          }
        }

        settings[dbKey] = trimmedValue;
      }
    }

    // Show validation errors
    if (validationErrors.length > 0) {
      const errorText = "Validation errors:\n" + validationErrors.join("\n");
      if (window.showError) {
        window.showError("Validation Error", errorText, 0);
      }

      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Settings";
      }
      return;
    }

    try {
      const response = await fetch("/api/settings/update", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ settings }),
      });

      const result = await response.json();

      if (!response.ok || !result.success) {
        // Show detailed error information
        const errorMsg = result.errorDetails
          ? `${result.message || "Failed to save settings"}\n\nDetails:\n${result.errorDetails}`
          : result.error || result.message || "Failed to save settings";
        throw new Error(errorMsg);
      }

      // Show success message
      if (window.showSuccess) {
        window.showSuccess(
          "Settings Saved",
          "Settings saved successfully! Regenerating colors...",
          4000
        );
      }

      // Inject dynamic colors and fonts if they were updated
      if (
        settings.primaryColor ||
        settings.secondaryColor ||
        settings.backgroundColor ||
        settings.backgroundColorDark ||
        settings.fontFamily ||
        settings.secondaryFontFamily
      ) {
        try {
          // Import and inject dynamic colors
          const { injectDynamicColors } = await import("../../lib/dynamic-colors");

          // Get the new color values from the settings object we just saved
          const newPrimaryColor = settings.primaryColor || primaryColorInput?.value;
          const newSecondaryColor = settings.secondaryColor || secondaryColorInput?.value;
          const fontFamilySelect = document.getElementById("font_family") as HTMLSelectElement;
          const secondaryFontFamilySelect = document.getElementById(
            "secondary_font_family"
          ) as HTMLSelectElement;
          const newFontFamily = settings.fontFamily || fontFamilySelect?.value;
          const newSecondaryFontFamily =
            settings.secondaryFontFamily || secondaryFontFamilySelect?.value;

          if (newPrimaryColor || newSecondaryColor) {
            console.log("[settings] Injecting dynamic colors:", {
              newPrimaryColor,
              newSecondaryColor,
            });
            injectDynamicColors(newPrimaryColor || "#825BDD", newSecondaryColor || "#0ea5e9");
          }

          // Inject background colors for .color-background (uses r,g,b format)
          const rgbFromHex = (hex: string) => (window.hexToRgb ? window.hexToRgb(hex) : null);
          const newBackgroundColor =
            settings.backgroundColor || backgroundColorInput?.value || "#ffffff";
          const newBackgroundColorDark =
            settings.backgroundColorDark || backgroundColorDarkInput?.value || "#0a0a0a";
          const rgbLight = rgbFromHex(newBackgroundColor);
          const rgbDark = rgbFromHex(newBackgroundColorDark);
          if (rgbLight) document.documentElement.style.setProperty("--color-background", rgbLight);
          if (rgbDark)
            document.documentElement.style.setProperty("--color-background-dark", rgbDark);

          // Inject font families if they were updated
          if (newFontFamily) {
            document.documentElement.style.setProperty("--font-family", newFontFamily);
            console.log("[settings] Primary font family updated:", newFontFamily);
          }
          if (newSecondaryFontFamily) {
            document.documentElement.style.setProperty(
              "--font-family-secondary",
              newSecondaryFontFamily
            );
            console.log("[settings] Secondary font family updated:", newSecondaryFontFamily);
          }

          const updates = [];
          if (
            settings.primaryColor ||
            settings.secondaryColor ||
            settings.backgroundColor ||
            settings.backgroundColorDark
          )
            updates.push("colors");
          if (settings.fontFamily || settings.secondaryFontFamily) updates.push("fonts");
          if (updates.length > 0 && window.showSuccess) {
            window.showSuccess(
              "Settings Updated",
              `Settings saved successfully! ${updates.join(" and ")} updated. Reloading page...`,
              4000
            );
          }
        } catch (error) {
          console.error("[settings] Failed to inject dynamic colors/fonts:", error);
        }
      }

      // Render favicon files and display in Rendered Icons section (icon was possibly saved)
      try {
        const renderRes = await fetch("/api/admin/render-icons", { method: "POST" });
        const renderData = await renderRes.json();
        const placeholder = document.getElementById("rendered-icons-placeholder");
        const listEl = document.getElementById("rendered-icons-list");
        if (placeholder && listEl) {
          placeholder.classList.add("hidden");
          listEl.classList.remove("hidden");
          listEl.innerHTML = "";
          if (renderData.success && renderData.files?.length) {
            for (const f of renderData.files) {
              const row = document.createElement("div");
              row.className =
                "flex flex-wrap items-center gap-3 rounded border border-gray-200 bg-gray-50 p-2 dark:border-gray-600 dark:bg-gray-800";
              const preview =
                f.type === "image/svg+xml"
                  ? `<img src="${f.url}?t=${Date.now()}" alt="" class="h-10 w-10 shrink-0 object-contain" />`
                  : `<img src="${f.url}?t=${Date.now()}" alt="" class="h-10 w-10 shrink-0 object-contain" />`;
              row.innerHTML = `
                <span class="shrink-0">${preview}</span>
                <div class="min-w-0 text-xs">
                  <div class="font-mono text-gray-700 dark:text-gray-300">${escapeHtml(f.path)}</div>
                  <div class="text-gray-500 dark:text-gray-400">${escapeHtml(f.size)} ¬∑ ${escapeHtml(f.type)}</div>
                </div>
              `;
              listEl.appendChild(row);
            }
          } else {
            listEl.innerHTML = `<p class="text-xs text-amber-600 dark:text-amber-400">${escapeHtml(renderData.error || "No files generated.")}</p>`;
          }
        }
      } catch (err) {
        console.warn("[settings] Render icons request failed:", err);
      }

      // Reload page after 2.5 seconds so user can see rendered icons list
      setTimeout(() => {
        window.location.reload();
      }, 2500);
    } catch (error: any) {
      // Show error message
      const errorMsg = error.message || "An error occurred while saving settings.";
      if (window.showError) {
        window.showError("Save Failed", errorMsg, 0);
      }

      // Re-enable submit button
      if (saveBtn) {
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Settings";
      }
    }
  });

  // Cmd+S / Ctrl+S to save
  document.addEventListener("keydown", (e) => {
    if ((e.metaKey || e.ctrlKey) && e.key === "s") {
      if (form) {
        e.preventDefault();
        form.requestSubmit();
      }
    }
  });
</script>
