---
/**
 * Admin page: Global JS Functions Reference
 * Lists all window.* functions with descriptions, params, and returns.
 * Auto-updates when you run `npm run generate-global-functions` (runs before dev).
 */
import { checkAuth } from "../../lib/auth";
import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import Button from "../../components/common/Button.astro";

const { currentUser, session } = await checkAuth(Astro.cookies);
if (!currentUser || !session || currentUser?.profile?.role !== "Admin") {
  return Astro.redirect("/auth/login");
}

// Generated by: npm run generate-global-functions (runs before dev/build)
import generatedData from "../../data/global-functions.generated.json";

const data = generatedData as {
  generatedAt: string;
  functions: Array<{
    name: string;
    file: string;
    line: number;
    description?: string;
    params?: string[];
    returns?: string;
  }>;
};

const isInternal = (n: string) =>
  n.startsWith("__") || n === "COUNT_BUBBLE_PRESETS" || n === "STRIPE_PUBLISHABLE_KEY";
const apiFunctions = data.functions.filter((f) => !isInternal(f.name));
const internalFunctions = data.functions.filter((f) => isInternal(f.name));
---

<LayoutDefault title="Global Functions" description="Window functions available across the app">
  <div class="max-w-5xl px-4 py-8">
    <div class="mb-8 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Global JS Functions</h1>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
          Window functions available across the app. Run
          <code class="rounded bg-gray-100 px-1.5 py-0.5 dark:bg-gray-800"
            >npm run generate-global-functions</code
          >
          to refresh (also runs before <code
            class="rounded bg-gray-100 px-1.5 py-0.5 dark:bg-gray-800">npm run dev</code
          >).
        </p>
        {
          data.generatedAt && (
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              Last generated: {new Date(data.generatedAt).toLocaleString()}
            </p>
          )
        }
      </div>
      <Button href="/admin" variant="ghost" size="sm">Back to Admin</Button>
    </div>

    {
      data.functions.length === 0 ? (
        <div class="rounded-lg border border-amber-200 bg-amber-50 p-6 dark:border-amber-800 dark:bg-amber-950/30">
          <p class="font-medium text-amber-800 dark:text-amber-200">No data yet</p>
          <p class="mt-2 text-sm text-amber-700 dark:text-amber-300">
            Run{" "}
            <code class="rounded bg-amber-100 px-1 dark:bg-amber-900">
              npm run generate-global-functions
            </code>{" "}
            to scan the codebase.
          </p>
        </div>
      ) : (
        <div class="space-y-6">
          <section>
            <h2 class="mb-4 text-lg font-semibold text-gray-900 dark:text-white">
              API Functions ({apiFunctions.length})
            </h2>
            <div class="overflow-hidden rounded-lg border border-gray-200 dark:border-gray-700">
              <div class="divide-y divide-gray-200 dark:divide-gray-700">
                {apiFunctions.map((fn) => (
                  <div
                    class="group flex flex-col gap-2 p-4 sm:flex-row sm:items-start sm:gap-4"
                    id={`fn-${fn.name}`}
                  >
                    <div class="min-w-0 flex-1">
                      <code class="font-mono text-sm font-semibold text-primary-600 dark:text-primary-400">
                        {fn.name}
                      </code>
                      {fn.description && (
                        <p class="mt-1.5 text-sm text-gray-600 dark:text-gray-400">
                          {fn.description}
                        </p>
                      )}
                      <div class="mt-2 flex flex-wrap gap-3 text-xs text-gray-500 dark:text-gray-500">
                        {fn.params && fn.params.length > 0 && (
                          <span>
                            <span class="font-medium">Params:</span> {fn.params.join(", ")}
                          </span>
                        )}
                        {fn.returns && (
                          <span>
                            <span class="font-medium">Returns:</span> {fn.returns}
                          </span>
                        )}
                      </div>
                    </div>
                    <code
                      class="shrink-0 rounded border border-gray-200 bg-gray-50 px-2 py-1 text-xs text-gray-600 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400"
                      title="File and line"
                    >
                      {fn.file}:{fn.line}
                    </code>
                  </div>
                ))}
              </div>
            </div>
          </section>

          <details class="rounded-lg border border-gray-200 dark:border-gray-700">
            <summary class="cursor-pointer p-4 font-medium text-gray-700 dark:text-gray-300">
              Internal / Underscore-prefixed ({internalFunctions.length})
            </summary>
            <div class="divide-y divide-gray-200 p-4 pt-0 dark:divide-gray-700">
              {internalFunctions.map((fn) => (
                <div class="flex items-center justify-between py-2 text-sm">
                  <code class="text-gray-600 dark:text-gray-400">{fn.name}</code>
                  <code class="text-xs text-gray-500">
                    {fn.file}:{fn.line}
                  </code>
                </div>
              ))}
            </div>
          </details>
        </div>
      )
    }
  </div>
</LayoutDefault>
