---
/**
 * Admin Live Team Locations
 * Shows last known location of team members (Admin/Staff) who have checked in and are sending location pings.
 */
import { checkAuth } from "../../lib/auth";
import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import SimpleIcon from "../../components/common/SimpleIcon.astro";

const { currentUser, currentRole } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/auth/login");
}

if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}
---

<LayoutDefault
  title="Team Locations"
  description="Live locations of team members who are checked in. Data refreshes every 30 seconds."
>
  <div class="mx-auto max-w-4xl px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Team Locations</h1>
      <p class="mt-1 text-gray-600 dark:text-gray-400">
        Team members (Admin/Staff) who have checked in appear here. Locations update every minute while
        they are checked in.
      </p>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-500">
        <span id="last-updated" aria-live="polite">Loading…</span>
      </p>
    </div>

    <div
      id="team-locations-list"
      class="rounded-lg border border-gray-200 bg-white shadow dark:border-gray-700 dark:bg-gray-900"
      role="region"
      aria-label="Team member locations"
    >
      <div class="p-8 text-center text-gray-500 dark:text-gray-400" id="team-locations-placeholder">
        Loading locations…
      </div>
    </div>
  </div>
</LayoutDefault>

<script>
  const listEl = document.getElementById("team-locations-list");
  const placeholderEl = document.getElementById("team-locations-placeholder");
  const lastUpdatedEl = document.getElementById("last-updated");

  function formatTime(iso: string): string {
    try {
      const d = new Date(iso);
      return d.toLocaleString(undefined, {
        dateStyle: "short",
        timeStyle: "medium",
      });
    } catch {
      return iso;
    }
  }

  function render(users: Array<{
    userId: string;
    name: string;
    role: string | null;
    lat: number;
    lng: number;
    accuracy: number | null;
    projectId: number | null;
    lastPingAt: string;
  }>) {
    if (!listEl || !placeholderEl) return;

    listEl.querySelectorAll("[data-team-location-row]").forEach((el) => el.remove());

    if (users.length === 0) {
      placeholderEl.textContent = "No team members checked in with recent location data.";
      placeholderEl.classList.remove("hidden");
      return;
    }

    placeholderEl.classList.add("hidden");

    users.forEach((u) => {
      const row = document.createElement("div");
      row.setAttribute("data-team-location-row", u.userId);
      const mapsUrl = `https://www.google.com/maps?q=${u.lat},${u.lng}`;
      row.className =
        "flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 px-4 py-3 last:border-b-0 dark:border-gray-700";
      row.innerHTML = `
        <div class="min-w-0 flex-1">
          <p class="font-medium text-gray-900 dark:text-white">${escapeHtml(u.name)}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            ${escapeHtml(u.role ?? "—")} · Last ping: ${formatTime(u.lastPingAt)}
            ${u.projectId != null ? ` · Project #${u.projectId}` : ""}
          </p>
        </div>
        <a
          href="${escapeHtml(mapsUrl)}"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          View on Map
        </a>
      `;
      listEl.appendChild(row);
    });
  }

  function escapeHtml(s: string): string {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  async function fetchLocations() {
    try {
      const res = await fetch("/api/location/live?minutes=15");
      const data = await res.json();
      if (res.ok && Array.isArray(data.users)) {
        render(data.users);
        if (lastUpdatedEl) {
          lastUpdatedEl.textContent = `Last updated: ${formatTime(new Date().toISOString())}`;
        }
      } else {
        if (placeholderEl) {
          placeholderEl.textContent = "Failed to load locations. Try again later.";
        }
      }
    } catch {
      if (placeholderEl) {
        placeholderEl.textContent = "Failed to load locations. Try again later.";
      }
    }
  }

  fetchLocations();
  const interval = setInterval(fetchLocations, 30 * 1000);

  document.addEventListener("astro:before-swap", () => clearInterval(interval));
</script>
