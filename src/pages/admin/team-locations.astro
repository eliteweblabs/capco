---
/**
 * Admin Live Team Locations
 * Shows last known location of team members (Admin/Staff) who have checked in and are sending location pings.
 * Live Mapbox map + list; data refreshes every 30 seconds.
 */
import { checkAuth } from "../../lib/auth";
import LayoutFullWidth from "../../components/layouts/LayoutFullWidth.astro";
import { globalClasses } from "../api/global/global-classes";

const { globalCardStyle } = globalClasses();

const { currentUser, currentRole } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/auth/login");
}

if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

const mapboxToken =
  import.meta.env.PUBLIC_MAPBOX_ACCESS_TOKEN || import.meta.env.MAPBOX_PUBLIC_KEY || "";
---

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<LayoutFullWidth
  title="Team Locations"
  description="Live locations of team members who are checked in. Data refreshes every 30 seconds."
  classList="p-4"
>
  <div class="mx-auto max-w-6xl px-4 py-8">
    <div class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Team Locations</h1>
      <p class="mt-1 text-gray-600 dark:text-gray-400">
        Team members (Admin/Staff) who have checked in appear on the map and list. Locations update
        every minute while they are checked in.
      </p>
      <p class="mt-2 text-sm text-gray-500 dark:text-gray-500">
        <span id="last-updated" aria-live="polite">Loading‚Ä¶</span>
      </p>
    </div>

    <div
      id="team-locations-map-wrap"
      class={`mb-6 overflow-hidden ${globalCardStyle}`}
      data-mapbox-token={mapboxToken}
      style="min-height: 400px;"
    >
      <div id="team-locations-map" class="h-full min-h-[400px] w-full" aria-label="Live team map">
      </div>
      <div
        id="team-locations-map-placeholder"
        class="flex min-h-[400px] items-center justify-center text-gray-500 dark:text-gray-400"
      >
        Loading map‚Ä¶
      </div>
    </div>

    <div
      id="team-locations-list"
      class={`${globalCardStyle} shadow`}
      role="region"
      aria-label="Team member locations list"
    >
      <div class="p-8 text-center text-gray-500 dark:text-gray-400" id="team-locations-placeholder">
        Loading locations‚Ä¶
      </div>
    </div>
  </div>
</LayoutFullWidth>

<style>
  #team-locations-map-wrap:has(.mapboxgl-map) #team-locations-map-placeholder {
    display: none;
  }
</style>

<script>
  const listEl = document.getElementById("team-locations-list");
  const placeholderEl = document.getElementById("team-locations-placeholder");
  const lastUpdatedEl = document.getElementById("last-updated");
  const mapWrap = document.getElementById("team-locations-map-wrap");
  const mapContainer = document.getElementById("team-locations-map");

  let map: any = null;
  let markers: any[] = [];

  function formatTime(iso: string): string {
    try {
      const d = new Date(iso);
      return d.toLocaleString(undefined, {
        dateStyle: "short",
        timeStyle: "medium",
      });
    } catch {
      return iso;
    }
  }

  function escapeHtml(s: string): string {
    const div = document.createElement("div");
    div.textContent = s;
    return div.innerHTML;
  }

  type UserLocation = {
    userId: string;
    name: string;
    role: string | null;
    lat: number;
    lng: number;
    accuracy: number | null;
    projectId: number | null;
    projectTitle: string | null;
    projectAddress: string | null;
    lastPingAt: string;
    address: string | null;
    startedAt: string | null;
    durationMinutes: number | null;
    onSite: boolean;
  };

  function initMap() {
    const mapboxgl = (window as any).mapboxgl;
    if (!mapboxgl || !mapContainer || !mapWrap) return;
    const token = mapWrap.getAttribute("data-mapbox-token") || "";
    if (!token) {
      const ph = document.getElementById("team-locations-map-placeholder");
      if (ph) ph.textContent = "Mapbox token not set (PUBLIC_MAPBOX_ACCESS_TOKEN).";
      return;
    }
    mapboxgl.accessToken = token;
    map = new mapboxgl.Map({
      container: "team-locations-map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [-98, 39],
      zoom: 3,
    });
    map.addControl(new mapboxgl.NavigationControl(), "top-right");
  }

  function formatDuration(mins: number): string {
    if (mins < 60) return mins + "m";
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return m ? h + "h " + m + "m" : h + "h";
  }

  function getLiveDuration(startedAt: string | null): string {
    if (!startedAt) return "‚Äî";
    const ms = Date.now() - new Date(startedAt).getTime();
    return formatDuration(Math.floor(ms / 60000));
  }

  function updateMapMarkers(users: UserLocation[]) {
    const mapboxgl = (window as any).mapboxgl;
    if (!map || !mapboxgl || !users.length) {
      markers.forEach((m) => m.remove());
      markers = [];
      return;
    }
    markers.forEach((m) => m.remove());
    markers = [];
    const bounds = new mapboxgl.LngLatBounds();
    for (const u of users) {
      const duration = u.startedAt ? getLiveDuration(u.startedAt) : "‚Äî";
      const projectLine = u.projectTitle ? `<p style="margin: 2px 0 0; font-size: 11px;">${escapeHtml(u.projectTitle)}</p>` : "";
      const addressLine = u.address ? `<p style="margin: 4px 0 0; font-size: 11px; max-width: 220px;">üìç ${escapeHtml(u.address)}</p>` : "";
      const onSiteBadge = u.onSite ? '<span style="display: inline-block; margin-top: 4px; padding: 2px 6px; font-size: 10px; background: #22c55e; color: white; border-radius: 4px;">On site</span>' : "";
      const popupHtml = `
        <div style="padding: 8px; min-width: 200px;" class="text-gray-900">
          <p style="font-weight: 600; margin: 0 0 4px;">${escapeHtml(u.name)}</p>
          <p style="margin: 0; font-size: 12px;">${escapeHtml(u.role ?? "‚Äî")}</p>
          <p style="margin: 4px 0 0; font-size: 11px;"><strong>${duration}</strong> checked in</p>
          ${projectLine}
          ${addressLine}
          ${onSiteBadge}
          <p style="margin: 4px 0 0; font-size: 10px; color: #6b7280;">Last ping: ${formatTime(u.lastPingAt)}</p>
        </div>`;
      const marker = new mapboxgl.Marker({ color: u.onSite ? "#22c55e" : "#2563eb" })
        .setLngLat([u.lng, u.lat])
        .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(popupHtml))
        .addTo(map);
      markers.push(marker);
      bounds.extend([u.lng, u.lat]);
    }
    if (users.length === 1) {
      map.setCenter([users[0].lng, users[0].lat]);
      map.setZoom(14);
    } else if (users.length > 1) {
      map.fitBounds(bounds, { padding: 50, maxZoom: 14 });
    }
  }

  let liveDurationInterval: ReturnType<typeof setInterval> | null = null;

  function renderList(users: UserLocation[]) {
    if (!listEl || !placeholderEl) return;

    listEl.querySelectorAll("[data-team-location-row]").forEach((el) => el.remove());

    if (liveDurationInterval) {
      clearInterval(liveDurationInterval);
      liveDurationInterval = null;
    }

    if (users.length === 0) {
      placeholderEl.textContent = "No team members checked in with recent location data.";
      placeholderEl.classList.remove("hidden");
      return;
    }

    placeholderEl.classList.add("hidden");

    users.forEach((u) => {
      const row = document.createElement("div");
      row.setAttribute("data-team-location-row", u.userId);
      row.setAttribute("data-started-at", u.startedAt || "");
      const mapsUrl = `https://www.google.com/maps?q=${u.lat},${u.lng}`;
      const durationEl = u.startedAt ? getLiveDuration(u.startedAt) : "‚Äî";
      const onSiteBadge = u.onSite ? '<span class="ml-2 inline-flex items-center rounded-full bg-green-100 px-2 py-0.5 text-xs font-medium text-green-800 dark:bg-green-900/30 dark:text-green-400">On site</span>' : "";
      row.className =
        "flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 px-4 py-3 last:border-b-0 dark:border-gray-700";
      row.innerHTML = `
        <div class="min-w-0 flex-1">
          <p class="font-medium text-gray-900 dark:text-white">${escapeHtml(u.name)}${onSiteBadge}</p>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            <span class="font-mono font-medium">${durationEl}</span> checked in
            ${u.projectTitle ? ` ¬∑ ${escapeHtml(u.projectTitle)}` : ""}
          </p>
          ${u.address ? `<p class="mt-1 text-xs text-gray-600 dark:text-gray-400 truncate max-w-md" title="${escapeHtml(u.address)}">üìç ${escapeHtml(u.address)}</p>` : ""}
          <p class="mt-0.5 text-xs text-gray-400 dark:text-gray-500">Last ping: ${formatTime(u.lastPingAt)}</p>
        </div>
        <a
          href="${escapeHtml(mapsUrl)}"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700"
        >
          View on Map
        </a>
      `;
      listEl.appendChild(row);
    });

    const hasStartedAt = users.some((u) => u.startedAt);
    if (hasStartedAt) {
      liveDurationInterval = setInterval(() => {
        listEl.querySelectorAll("[data-team-location-row][data-started-at]").forEach((el) => {
          const startedAt = el.getAttribute("data-started-at");
          if (!startedAt) return;
          const durationSpan = el.querySelector(".font-mono.font-medium");
          if (durationSpan) durationSpan.textContent = getLiveDuration(startedAt);
        });
      }, 1000);
    }
  }

  async function fetchLocations() {
    try {
      const res = await fetch("/api/location/live?minutes=15");
      const data = await res.json();
      if (res.ok && Array.isArray(data.users)) {
        renderList(data.users);
        updateMapMarkers(data.users);
        if (lastUpdatedEl) {
          lastUpdatedEl.textContent = `Last updated: ${formatTime(new Date().toISOString())}`;
        }
      } else {
        if (placeholderEl) placeholderEl.textContent = "Failed to load locations. Try again later.";
        updateMapMarkers([]);
      }
    } catch {
      if (placeholderEl) placeholderEl.textContent = "Failed to load locations. Try again later.";
      updateMapMarkers([]);
    }
  }

  function run() {
    if ((window as any).mapboxgl) {
      initMap();
      fetchLocations();
    } else {
      setTimeout(run, 100);
    }
  }
  run();

  const interval = setInterval(fetchLocations, 30 * 1000);
  document.addEventListener("astro:before-swap", () => {
    clearInterval(interval);
    if (liveDurationInterval) clearInterval(liveDurationInterval);
  });
</script>
