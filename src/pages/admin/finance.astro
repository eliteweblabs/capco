---
import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

import { globalClasses } from "../api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import Hero from "../../components/common/Hero.astro";
import FinanceDashboard from "../../components/admin/FinanceDashboard.astro";

// Fetch projects for overview stats
let projects: any[] = [];
if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    const apiUrl = `${baseUrl}/api/get-project`;
    const response = await fetch(apiUrl, {
      headers: {
        Cookie: Astro.request.headers.get("cookie") || "",
      },
    });

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
    }
  } catch (error) {
    console.error("Error fetching projects:", error);
  }
}
---

<LayoutDefault
  title="Finance Dashboard"
  description="Monitor all financial data and transactions across the platform"
>
  <!-- Dashboard Container -->
  <Hero
    title="Finance Dashboard"
    description="Monitor all financial data and transactions across the platform."
    {primaryTextClasses}
    {secondaryTextClasses}
    {globalInputClasses}
  />

  <!-- Finance Dashboard -->
  <FinanceDashboard
    {currentUser}
    {globalInputClasses}
    {primaryTextClasses}
    {secondaryTextClasses}
  />
</LayoutDefault>
