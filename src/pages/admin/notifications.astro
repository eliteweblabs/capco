---
import { checkAuth } from "../../lib/auth";
import { supabaseAdmin } from "../../lib/supabase-admin";
import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import Hero from "../../components/common/Hero.astro";
import SlidingTabs from "../../components/common/SlidingTabs.astro";
import SimpleIcon from "../../components/common/SimpleIcon.astro";
import Tooltip from "../../components/ui/TooltipFloating.astro";

import { globalClasses } from "../api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

// Check authentication
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
const { data: profile } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", currentUser.id)
  .single();

if (profile?.role !== "Admin") {
  return Astro.redirect("/dashboard");
}

// Get all users for the dropdown
let allUsers: any[] = [];
if (supabaseAdmin) {
  const { data: users, error: usersError } = await supabaseAdmin
    .from("profiles")
    .select("id, firstName, lastName, email, role")
    .order("firstName");

  if (usersError) {
    console.error("Error fetching users:", usersError);
  } else {
    allUsers = (users || []).map((user) => ({
      ...user,
      name: `${user.firstName || ""} ${user.lastName || ""}`.trim() || user.email,
    }));
  }
}

// Add group options at the top
const groupOptions = [
  { id: "all-admins", name: "All Admins", role: "Admin", isGroup: true },
  { id: "all-staff", name: "All Staff", role: "Staff", isGroup: true },
  { id: "all-clients", name: "All Clients", role: "Client", isGroup: true },
];

// Combine group options with individual users
allUsers = [...groupOptions, ...allUsers];

// Get recent notifications for display (deduplicated by title+message - one per unique notification)
let recentNotifications: any[] = [];
if (supabaseAdmin) {
  const { data: notifications } = await supabaseAdmin
    .from("notifications")
    .select("*")
    .order("createdAt", { ascending: false })
    .limit(50);
  const seen = new Set<string>();
  recentNotifications = (notifications || []).filter((n: any) => {
    const key = `${n.title ?? ""}|${n.message ?? ""}`;
    if (seen.has(key)) return false;
    seen.add(key);
    return true;
  });
}

// Tab state from URL
const defaultTabParam = Astro.url.searchParams.get("tab") || "create";
const validTabs = ["create", "archive"];
const activeTab = validTabs.includes(defaultTabParam) ? defaultTabParam : "create";
const activeTabIndex = validTabs.indexOf(activeTab);
---

<LayoutDefault title="Send Notifications" description="Send custom notifications to users">
  <Hero
    title="Send Notifications"
    description="Send custom notifications to users"
    {primaryTextClasses}
    {secondaryTextClasses}
    {globalInputClasses}
  />

  <SlidingTabs
    navId="notifications-tab-nav"
    navClass="border-b border-gray-200 dark:border-gray-700 mb-0"
    activeItem={activeTabIndex}
    urlParam="tab"
    switchHandler="switchNotificationsTab"
    items={[
      { id: "tab-create", label: "Create", variant: "tab", showLabel: true },
      { id: "tab-archive", label: "Archive", variant: "tab", showLabel: true },
    ]}
  />

  <!-- Tab content wrapper -->
  <div id="notifications-tab-content">
    <!-- Create tab -->
    <div
      class={`color-background rounded-lg bg-gray-100 shadow-md dark:shadow-gray-700 ${activeTab !== "create" ? "hidden" : ""}`}
      id="create"
      role="tabpanel"
      aria-labelledby="tab-create"
    >
      <div class="border-b border-gray-200 px-6 py-4">
        <h2 class={`text-lg font-medium ${primaryTextClasses}`}>Create Notification</h2>
      </div>
      <form id="notification-form" class="space-y-6 p-6">
        <!-- Recipients -->
        <div>
          <label for="recipients" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
            Recipients
          </label>
          <select id="recipients" name="recipients" multiple class={globalInputClasses} required>
            <option value="all">All Users</option>
            {
              allUsers.map((user) => (
                <option value={user.id} data-email={user.email}>
                  {user.name} ({user.email}) - {user.role}
                </option>
              ))
            }
          </select>
          <p class={`mt-1 text-sm ${secondaryTextClasses} opacity-70`}>
            Hold Ctrl/Cmd to select multiple users
          </p>
        </div>

        <!-- Notification Type -->
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label for="type" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
              Type
            </label>
            <select id="type" name="type" class={globalInputClasses}>
              <option value="info">Info</option>
              <option value="success">Success</option>
              <option value="warning">Warning</option>
              <option value="error">Error</option>
            </select>
          </div>

          <div>
            <label for="priority" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
              Priority
            </label>
            <select id="priority" name="priority" class={globalInputClasses}>
              <option value="low">Low</option>
              <option value="normal" selected>Normal</option>
              <option value="high">High</option>
              <option value="urgent">Urgent</option>
            </select>
          </div>
        </div>

        <!-- Title -->
        <div>
          <label for="title" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
            Title *
          </label>
          <input
            type="text"
            id="title"
            name="title"
            required
            class={globalInputClasses}
            placeholder="Notification title"
          />
        </div>

        <!-- Message -->
        <div>
          <label for="message" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
            Message *
          </label>
          <textarea
            id="message"
            name="message"
            rows="4"
            required
            class={globalInputClasses}
            placeholder="Notification message"></textarea>
        </div>

        <!-- Action URL (Optional) -->
        <div>
          <label for="actionUrl" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
            Action URL (Optional)
          </label>
          <input
            type="url"
            id="actionUrl"
            name="actionUrl"
            class={globalInputClasses}
            placeholder="https://example.com/action"
          />
        </div>

        <!-- Action Text (Optional) -->
        <div>
          <label for="actionText" class={`mb-2 block text-sm font-medium ${secondaryTextClasses}`}>
            Action Button Text (Optional)
          </label>
          <input
            type="text"
            id="actionText"
            name="actionText"
            class={globalInputClasses}
            placeholder="View Details"
          />
        </div>

        <!-- Submit Button -->
        <div class="flex justify-end">
          <button
            type="submit"
            id="submit-btn"
            class="rounded-md bg-primary-600 px-6 py-2 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
          >
            Send Notifications
          </button>
        </div>
      </form>
    </div>

    <!-- Archive tab -->
    <div
      class={`color-background mt-0 rounded-lg bg-gray-100 shadow-md dark:shadow-gray-700 ${activeTab !== "archive" ? "hidden" : ""}`}
      id="archive"
      role="tabpanel"
      aria-labelledby="tab-archive"
    >
      <div class="border-b border-gray-200 px-6 py-4">
        <h2 class={`text-lg font-medium ${primaryTextClasses}`}>Archive</h2>
      </div>
      <div id="recent-notifications" class="p-6">
        {
          recentNotifications.length > 0 ? (
            <div class="space-y-4">
              {recentNotifications.map((notification) => (
                <div class="dark:bg-primary-900/20 border-l-4 border-primary-500 bg-primary-50 p-4">
                  <div class="flex items-start justify-between gap-3">
                    <div class="min-w-0 flex-1">
                      <h3 class={`font-medium ${primaryTextClasses}`}>{notification.title}</h3>
                      <p class={secondaryTextClasses}>{notification.message}</p>
                    </div>
                    <div class="flex shrink-0 items-center gap-2">
                      <span class={`text-sm ${secondaryTextClasses} opacity-70`}>
                        {new Date(notification.createdAt).toLocaleDateString()}
                      </span>
                      <Tooltip text="Copy to create form" position="top" mobileClickable={true}>
                        <button
                          type="button"
                          class="copy-notification-btn rounded p-1.5 text-gray-500 hover:bg-gray-200 hover:text-gray-700 dark:text-gray-400 dark:hover:bg-gray-600 dark:hover:text-gray-200"
                          data-title={notification.title}
                          data-message={notification.message}
                          data-type={notification.type ?? "info"}
                          data-priority={notification.priority ?? "normal"}
                          data-action-url={notification.actionUrl ?? ""}
                          data-action-text={notification.actionText ?? ""}
                          aria-label="Copy to create form"
                        >
                          <SimpleIcon name="copy" size="sm" />
                        </button>
                      </Tooltip>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p class={`${secondaryTextClasses} opacity-70`}>No notifications sent yet</p>
          )
        }
      </div>
    </div>
  </div>
</LayoutDefault>

<script>
  import { SimpleProjectLogger } from "../../lib/simple-logging";

  // Type declarations for global window functions
  declare global {
    interface Window {
      showError: (title: string, message: string, duration: number) => void;
      showSuccess: (title: string, message: string, duration: number) => void;
      switchNotificationsTab?: (tab: string) => void;
    }
  }

  window.switchNotificationsTab = function (tab: string) {
    ["create", "archive"].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.classList.toggle("hidden", id !== tab);
    });
    const url = new URL(window.location.href);
    url.searchParams.set("tab", tab);
    window.history.replaceState({}, "", url.toString());
  };

  class NotificationManager {
    constructor() {
      this.init();
    }

    init() {
      this.bindEvents();
    }

    bindEvents() {
      const form = document.getElementById("notification-form");
      if (form) {
        form.addEventListener("submit", (e) => this.handleSubmit(e));
      }
      document.querySelectorAll(".copy-notification-btn").forEach((btn) => {
        btn.addEventListener("click", (e) => this.handleCopyToForm(e));
      });
    }

    handleCopyToForm(e: Event) {
      const btn = e.target.closest(".copy-notification-btn");
      if (!btn) return;
      const title = btn.getAttribute("data-title") ?? "";
      const message = btn.getAttribute("data-message") ?? "";
      const type = btn.getAttribute("data-type") ?? "info";
      const priority = btn.getAttribute("data-priority") ?? "normal";
      const actionUrl = btn.getAttribute("data-action-url") ?? "";
      const actionText = btn.getAttribute("data-action-text") ?? "";
      document.getElementById("title").value = title;
      document.getElementById("message").value = message;
      document.getElementById("type").value = type;
      document.getElementById("priority").value = priority;
      document.getElementById("actionUrl").value = actionUrl;
      document.getElementById("actionText").value = actionText;
      window.switchNotificationsTab?.("create");
    }

    async handleSubmit(e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submit-btn");
      const originalText = submitBtn?.textContent;

      try {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Sending...";
        }

        const form = e.target;
        const formData = new FormData(form);
        const recipientsSelect = document.getElementById("recipients");
        const recipients = Array.from(recipientsSelect?.selectedOptions || []);

        if (recipients.length === 0) {
          if (window.showError) {
            window.showError("Validation Error", "Please select at least one recipient", 0);
          }
          return;
        }

        // Check for group selections
        const groupSelections = recipients.filter((option) => option.value.startsWith("all-"));
        const individualSelections = recipients.filter(
          (option) => !option.value.startsWith("all-")
        );

        let notifications = [];

        if (groupSelections.length > 0) {
          // Send to groups
          const groupPromises = groupSelections.map((option) => {
            const groupType = option.value.replace("all-", "");
            return fetch("/api/notifications/upsert", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                groupType: groupType,
                title: formData.get("title"),
                message: formData.get("message"),
                type: formData.get("type"),
                priority: formData.get("priority"),
                actionUrl: formData.get("actionUrl") || undefined,
                actionText: formData.get("actionText") || undefined,
              }),
            });
          });

          const groupResults = await Promise.allSettled(groupPromises);
          notifications = [...notifications, ...groupResults];
        }

        if (individualSelections.length > 0) {
          // Send to specific users
          // Filter out any invalid values like "all" that might have slipped through
          const validIndividualSelections = individualSelections.filter((option) => {
            const value = option.value;
            // Must be a valid UUID format (not "all" or other invalid values)
            return (
              value &&
              value !== "all" &&
              value.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)
            );
          });

          const individualNotifications = validIndividualSelections.map((option) => ({
            userId: option.value,
            title: formData.get("title"),
            message: formData.get("message"),
            type: formData.get("type"),
            priority: formData.get("priority"),
            actionUrl: formData.get("actionUrl") || undefined,
            actionText: formData.get("actionText") || undefined,
          }));

          // Send individual notifications
          const individualResults = await Promise.allSettled(
            individualNotifications.map((notification) =>
              fetch("/api/notifications/upsert", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(notification),
              })
            )
          );
          notifications = [...notifications, ...individualResults];
        }

        const successful = notifications.filter(
          (r: any) => r.status === "fulfilled" && r.value?.ok
        ).length;
        const failed = notifications.length - successful;

        if (successful > 0) {
          if (window.showSuccess) {
            window.showSuccess(
              "Notifications Sent",
              `Successfully sent ${successful} notification(s)${failed > 0 ? `, ${failed} failed` : ""}`,
              4000
            );
          }

          // Log to system project (0) for notification sending
          await SimpleProjectLogger.addLogEntry(
            0, // System project for notification logs
            "allNotificationsSent",
            `Notifications sent successfully to ${successful} users${failed > 0 ? `, ${failed} failed` : ""}`,
            {
              successful,
              failed,
              total: notifications.length,
            }
          );

          if (e.target) {
            e.target.reset();
          }
          this.loadRecentNotifications();
        } else {
          if (window.showError) {
            window.showError("Send Failed", "Failed to send notifications", 0);
          }
        }
      } catch (error) {
        console.error("Error sending notifications:", error);
        if (window.showError) {
          window.showError("Error", "Error sending notifications", 0);
        }
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText || "Send Notifications";
        }
      }
    }

    async loadRecentNotifications() {
      // Reload and switch to Archive tab to show the new notifications
      const url = new URL(window.location.href);
      url.searchParams.set("tab", "archive");
      window.location.href = url.toString();
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    new NotificationManager();

    // Wire tab clicks to switch handler
    const nav = document.getElementById("notifications-tab-nav");
    if (nav) {
      nav.addEventListener("click", (e) => {
        const target = e.target instanceof HTMLElement ? e.target.closest("button[id]") : null;
        if (!target || !target.id?.startsWith("tab-")) return;
        const tab = target.id.replace(/^tab-/, "");
        if (["create", "archive"].includes(tab)) window.switchNotificationsTab?.(tab);
      });
    }
  });
</script>
