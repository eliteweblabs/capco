---
import LayoutFullWidth from "../../components/layouts/LayoutFullWidth.astro";
import Dropzone from "../../components/common/Dropzone.astro";
import { checkAuth } from "../../lib/auth";
import { globalClasses } from "../api/global/global-classes";

const { globalFormClasses, globalInputClasses } = globalClasses();

const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role || "Client";

// Require Admin or Staff role
if (!currentUser) {
  return Astro.redirect("/auth/login");
}

if (currentRole !== "Admin" && currentRole !== "Staff") {
  return Astro.redirect("/dashboard");
}
---

<LayoutFullWidth title="Certify PDF" description="Sign and encrypt PDFs with IdenTrust certificate" classList="p-4">
  <div class="p-6">
    <h1 class="mb-6 text-3xl font-bold">Certify PDF with IdenTrust Certificate</h1>

    <div class="mb-6 rounded-lg border border-primary-200 bg-primary-50 p-4">
      <h2 class="mb-2 text-lg font-semibold text-primary-900">
        About PDF Certification & Encryption
      </h2>
      <p class="text-sm text-primary-800">
        This tool can <strong>sign</strong> PDFs with your IdenTrust certificate (proves authenticity)
        and/or
        <strong>encrypt</strong> them with passwords (restricts access). You can use both together for
        maximum security.
      </p>
      <ul class="mt-2 list-inside list-disc space-y-1 text-sm text-primary-800">
        <li>
          <strong>Signing:</strong> Proves the document was certified by you and hasn't been tampered
          with
        </li>
        <li>
          <strong>Encryption:</strong> Requires a password to open/view the PDF and restricts what recipients
          can do
        </li>
      </ul>
    </div>

    <form id="certify-pdf-form" class={globalFormClasses}>
      <!-- File Upload -->
      <div>
        <label for="pdf-dropzone" class="mb-2 block text-sm font-medium text-gray-700">
          Select PDF File
        </label>
        <Dropzone
          id="pdf-dropzone"
          accept=".pdf"
          maxSize={50}
          label="Drop PDF file here or click to browse"
          description="PDF files only"
          required={true}
        />
        <input type="file" id="pdf-file" name="file" accept=".pdf" required class="hidden" />
      </div>

      <!-- Signing Options -->
      <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label for="reason" class="mb-2 block text-sm font-medium text-gray-700">
            Reason for Signing
          </label>
          <input
            type="text"
            id="reason"
            name="reason"
            value="Document certification"
            placeholder="e.g., Document certification"
            class={globalInputClasses}
          />
        </div>

        <div>
          <label for="location" class="mb-2 block text-sm font-medium text-gray-700">
            Location
          </label>
          <input
            type="text"
            id="location"
            name="location"
            value="Certified by CAPCO Design Group"
            placeholder="e.g., Certified by CAPCO Design Group"
            class={globalInputClasses}
          />
        </div>
      </div>

      <div>
        <label for="contact-info" class="mb-2 block text-sm font-medium text-gray-700">
          Contact Information (Optional)
        </label>
        <input
          type="text"
          id="contact-info"
          name="contactInfo"
          placeholder="Email or phone number"
          class={globalInputClasses}
        />
      </div>

      <!-- Visible Signature Option -->
      <div class="flex items-center">
        <input
          type="checkbox"
          id="visible-signature"
          name="visible"
          value="true"
          class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
        />
        <label for="visible-signature" class="ml-2 block text-sm text-gray-700">
          Add visible signature annotation (experimental)
        </label>
      </div>

      <div id="page-number-container" class="hidden">
        <label for="page-number" class="mb-2 block text-sm font-medium text-gray-700">
          Page Number for Signature
        </label>
        <input
          type="number"
          id="page-number"
          name="pageNumber"
          min="1"
          value="1"
          class={globalInputClasses}
        />
      </div>

      <!-- Encryption Section -->
      <div class="mt-6 border-t pt-6">
        <h2 class="mb-4 text-xl font-semibold text-gray-900">Encryption Options (Optional)</h2>

        <div class="mb-4 flex items-center">
          <input
            type="checkbox"
            id="encryption-enabled"
            name="encryption-enabled"
            value="true"
            class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
          />
          <label for="encryption-enabled" class="ml-2 block text-sm font-medium text-gray-700">
            Enable password encryption
          </label>
        </div>

        <div id="encryption-options" class="hidden space-y-4">
          <!-- Encryption Preset -->
          <div>
            <label for="encryption-preset" class="mb-2 block text-sm font-medium text-gray-700">
              Security Preset
            </label>
            <select
              id="encryption-preset"
              name="encryption-preset"
              class={globalInputClasses}
            >
              <option value="default">Default Security</option>
              <option value="high">High Security (Maximum Restrictions)</option>
              <option value="low">Low Security (Permissive)</option>
            </select>
          </div>

          <!-- Passwords -->
          <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
            <div>
              <label for="user-password" class="mb-2 block text-sm font-medium text-gray-700">
                User Password (Required to Open)
              </label>
              <input
                type="password"
                id="user-password"
                name="user-password"
                placeholder="Password to open PDF"
                class={globalInputClasses}
              />
            </div>

            <div>
              <label for="owner-password" class="mb-2 block text-sm font-medium text-gray-700">
                Owner Password (Optional)
              </label>
              <input
                type="password"
                id="owner-password"
                name="owner-password"
                placeholder="Password for permissions (optional)"
                class={globalInputClasses}
              />
            </div>
          </div>

          <div>
            <button
              type="button"
              id="generate-passwords-btn"
              class="text-sm text-primary-600 underline hover:text-primary-800"
            >
              Generate Secure Passwords
            </button>
          </div>

          <!-- Permissions -->
          <div>
            <label class="mb-2 block text-sm font-medium text-gray-700">Permissions</label>
            <div class="grid grid-cols-2 gap-3 md:grid-cols-3">
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="allow-printing"
                  name="allow-printing"
                  value="true"
                  class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <label for="allow-printing" class="ml-2 block text-sm text-gray-700"
                  >Allow Printing</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="allow-copying"
                  name="allow-copying"
                  value="true"
                  class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <label for="allow-copying" class="ml-2 block text-sm text-gray-700"
                  >Allow Copying</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="allow-modifying"
                  name="allow-modifying"
                  value="true"
                  class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <label for="allow-modifying" class="ml-2 block text-sm text-gray-700"
                  >Allow Modifying</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="allow-annotating"
                  name="allow-annotating"
                  value="true"
                  checked
                  class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <label for="allow-annotating" class="ml-2 block text-sm text-gray-700"
                  >Allow Annotating</label
                >
              </div>
              <div class="flex items-center">
                <input
                  type="checkbox"
                  id="allow-filling-forms"
                  name="allow-filling-forms"
                  value="true"
                  checked
                  class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"
                />
                <label for="allow-filling-forms" class="ml-2 block text-sm text-gray-700"
                  >Allow Filling Forms</label
                >
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="flex gap-4">
        <button
          type="submit"
          id="submit-btn"
          class="flex-1 rounded-lg bg-primary-600 px-6 py-3 font-semibold text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
        >
          <span id="submit-btn-text">Certify PDF</span>
        </button>
        <button
          type="button"
          id="cancel-btn"
          class="rounded-lg border border-gray-300 px-6 py-3 font-semibold text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2"
        >
          Cancel
        </button>
      </div>
    </form>

    <!-- Results Section -->
    <div id="results-section" class="mt-6 hidden">
      <div class="rounded-lg border border-green-200 bg-green-50 p-4">
        <h3 class="mb-2 text-lg font-semibold text-green-900">PDF Certified Successfully!</h3>
        <div id="results-content" class="text-sm text-green-800"></div>
        <div class="mt-4">
          <a
            id="download-link"
            href="#"
            download
            class="inline-block rounded-lg bg-green-600 px-4 py-2 text-white hover:bg-green-700"
            target="_blank"
          >
            Download Certified PDF
          </a>
        </div>
      </div>
    </div>

    <!-- Error Section -->
    <div id="error-section" class="mt-6 hidden">
      <div class="rounded-lg border border-red-200 bg-red-50 p-4">
        <h3 class="mb-2 text-lg font-semibold text-red-900">Error</h3>
        <p id="error-message" class="text-sm text-red-800"></p>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("certify-pdf-form") as HTMLFormElement;
      const submitBtn = document.getElementById("submit-btn") as HTMLButtonElement;
      const cancelBtn = document.getElementById("cancel-btn") as HTMLButtonElement;
      const resultsSection = document.getElementById("results-section") as HTMLDivElement;
      const errorSection = document.getElementById("error-section") as HTMLDivElement;
      const errorMessage = document.getElementById("error-message") as HTMLParagraphElement;
      const resultsContent = document.getElementById("results-content") as HTMLDivElement;
      const downloadLink = document.getElementById("download-link") as HTMLAnchorElement;
      const visibleSignatureCheckbox = document.getElementById(
        "visible-signature"
      ) as HTMLInputElement;
      const pageNumberContainer = document.getElementById(
        "page-number-container"
      ) as HTMLDivElement;
      const pdfFileInput = document.getElementById("pdf-file") as HTMLInputElement;
      const pdfDropzone = document.getElementById("pdf-dropzone");

      // Sync dropzone file selection with hidden input
      if (pdfDropzone && pdfFileInput) {
        pdfDropzone.addEventListener("dropzone-files-selected", (e: any) => {
          const { files } = e.detail;
          if (files && files.length > 0) {
            console.log("üìé [PDF-CERTIFY] File selected:", files[0].name, files[0].size, "bytes");

            // Create a new DataTransfer object to set files on the input
            const dataTransfer = new DataTransfer();
            for (let i = 0; i < files.length; i++) {
              dataTransfer.items.add(files[i]);
            }
            pdfFileInput.files = dataTransfer.files;

            // Show visual feedback
            const dropzoneContent = pdfDropzone.querySelector(".dropzone-content");
            if (dropzoneContent) {
              const fileName = files[0].name;
              const fileSize = (files[0].size / 1024 / 1024).toFixed(2);
              const existingFeedback = pdfDropzone.querySelector(".file-selected-feedback");
              if (existingFeedback) {
                existingFeedback.remove();
              }
              const feedback = document.createElement("div");
              feedback.className =
                "file-selected-feedback mt-2 p-2 bg-primary-50 dark:bg-primary-900/20 rounded text-sm";
              feedback.innerHTML = `<strong>Selected:</strong> ${fileName} (${fileSize} MB)`;
              dropzoneContent.appendChild(feedback);
            }

            // Trigger change event for form validation
            pdfFileInput.dispatchEvent(new Event("change", { bubbles: true }));
          }
        });

        pdfDropzone.addEventListener("dropzone-error", (e: any) => {
          const { error } = e.detail;
          errorMessage.textContent = error;
          errorSection.classList.remove("hidden");
        });
      }

      // Toggle page number input based on visible signature checkbox
      visibleSignatureCheckbox.addEventListener("change", () => {
        if (visibleSignatureCheckbox.checked) {
          pageNumberContainer.classList.remove("hidden");
        } else {
          pageNumberContainer.classList.add("hidden");
        }
      });

      // Toggle encryption options visibility
      const encryptionEnabled = document.getElementById("encryption-enabled") as HTMLInputElement;
      const encryptionOptions = document.getElementById("encryption-options") as HTMLDivElement;
      const generatePasswordsBtn = document.getElementById(
        "generate-passwords-btn"
      ) as HTMLButtonElement;

      encryptionEnabled.addEventListener("change", () => {
        if (encryptionEnabled.checked) {
          encryptionOptions.classList.remove("hidden");
        } else {
          encryptionOptions.classList.add("hidden");
        }
      });

      // Generate secure passwords
      generatePasswordsBtn.addEventListener("click", () => {
        const userPassword = generateSecurePassword(12);
        const ownerPassword = generateSecurePassword(16);
        (document.getElementById("user-password") as HTMLInputElement).value = userPassword;
        (document.getElementById("owner-password") as HTMLInputElement).value = ownerPassword;
      });

      function generateSecurePassword(length: number = 12): string {
        const charset = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
        let password = "";
        for (let i = 0; i < length; i++) {
          password += charset.charAt(Math.floor(Math.random() * charset.length));
        }
        return password;
      }

      // Update permissions based on preset
      const presetSelect = document.getElementById("encryption-preset") as HTMLSelectElement;
      presetSelect.addEventListener("change", () => {
        updatePermissionsFromPreset(presetSelect.value);
      });

      function updatePermissionsFromPreset(preset: string) {
        const allowPrinting = document.getElementById("allow-printing") as HTMLInputElement;
        const allowCopying = document.getElementById("allow-copying") as HTMLInputElement;
        const allowModifying = document.getElementById("allow-modifying") as HTMLInputElement;
        const allowAnnotating = document.getElementById("allow-annotating") as HTMLInputElement;
        const allowFillingForms = document.getElementById(
          "allow-filling-forms"
        ) as HTMLInputElement;

        switch (preset) {
          case "high":
            allowPrinting.checked = false;
            allowCopying.checked = false;
            allowModifying.checked = false;
            allowAnnotating.checked = false;
            allowFillingForms.checked = false;
            break;
          case "low":
            allowPrinting.checked = true;
            allowCopying.checked = true;
            allowModifying.checked = true;
            allowAnnotating.checked = true;
            allowFillingForms.checked = true;
            break;
          case "default":
          default:
            allowPrinting.checked = true;
            allowCopying.checked = false;
            allowModifying.checked = false;
            allowAnnotating.checked = true;
            allowFillingForms.checked = true;
            break;
        }
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Check if file is selected
        if (!pdfFileInput.files || pdfFileInput.files.length === 0) {
          errorMessage.textContent = "Please select a PDF file to upload";
          errorSection.classList.remove("hidden");
          return;
        }

        // Reset UI
        resultsSection.classList.add("hidden");
        errorSection.classList.add("hidden");
        submitBtn.disabled = true;
        const submitBtnText = document.getElementById("submit-btn-text") as HTMLSpanElement;
        submitBtnText.textContent = "Processing...";

        try {
          const formData = new FormData(form);

          // Ensure file is included in FormData
          if (pdfFileInput.files && pdfFileInput.files.length > 0) {
            formData.set("file", pdfFileInput.files[0]);
          }

          console.log("üì§ [PDF-CERTIFY] Submitting form:", {
            hasFile: formData.has("file"),
            fileName: pdfFileInput.files?.[0]?.name,
            fileSize: pdfFileInput.files?.[0]?.size,
            encryptionEnabled: formData.get("encryption-enabled"),
          });

          // Determine which endpoint to use based on encryption setting
          const encryptionEnabled = formData.get("encryption-enabled") === "true";
          const endpoint = encryptionEnabled ? "/api/pdf/sign-encrypt" : "/api/pdf/sign";

          console.log("üì§ [PDF-CERTIFY] Calling endpoint:", endpoint);

          const response = await fetch(endpoint, {
            method: "POST",
            body: formData,
          });

          console.log("üì• [PDF-CERTIFY] Response status:", response.status);

          const data = await response.json();
          console.log("üì• [PDF-CERTIFY] Response data:", data);

          if (!response.ok) {
            console.error("‚ùå [PDF-CERTIFY] Response not OK:", data);
            throw new Error(data.error || data.message || "Failed to process PDF");
          }

          // Show success
          if (data.success && data.data) {
            console.log("‚úÖ [PDF-CERTIFY] Success! Showing results...");
            const metadata = data.data.metadata || {};
            const isEncrypted = metadata.encrypted || false;
            const isSigned = metadata.signed || false;
            const warning = data.data.warning;

            let metadataHtml = `
              <p><strong>File:</strong> ${data.data.fileName}</p>
            `;

            // Show warning if encryption failed but signing succeeded
            if (warning) {
              metadataHtml += `
                <div class="mt-2 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded">
                  <p class="text-yellow-800 dark:text-yellow-200 font-semibold">‚ö†Ô∏è Warning</p>
                  <p class="text-yellow-700 dark:text-yellow-300 text-sm">${warning}</p>
                </div>
              `;
            }

            if (isSigned) {
              metadataHtml += `
                <div class="mt-3 p-3 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded">
                  <p class="text-green-800 dark:text-green-200 font-semibold mb-2">‚úÖ PDF Cryptographically Signed</p>
                  <p class="text-sm text-green-700 dark:text-green-300 mb-2">
                    This PDF has been digitally signed with a PKCS#7 cryptographic signature. 
                    The signature will be visible in Adobe Reader and is suitable for Massachusetts state submissions.
                  </p>
                  <p class="mt-2"><strong>Signed by:</strong> ${metadata.signer || "Unknown"}</p>
                  <p><strong>Signed at:</strong> ${new Date(metadata.signedAt || Date.now()).toLocaleString()}</p>
                  <p><strong>Reason:</strong> ${metadata.reason || "N/A"}</p>
                  <p><strong>Location:</strong> ${metadata.location || "N/A"}</p>
                </div>
              `;
            }

            if (isEncrypted) {
              metadataHtml += `
                <p class="mt-2"><strong>Encryption:</strong> Enabled</p>
                <p><strong>User Password:</strong> ${metadata.hasUserPassword ? "Required" : "Not set"}</p>
                <p><strong>Owner Password:</strong> ${metadata.hasOwnerPassword ? "Set" : "Not set"}</p>
              `;
            }

            resultsContent.innerHTML = metadataHtml;

            if (data.data.downloadUrl) {
              downloadLink.href = data.data.downloadUrl;
            } else {
              downloadLink.href = "#";
              downloadLink.onclick = (e) => {
                e.preventDefault();
                alert("Download URL not available. Please contact support.");
              };
            }

            resultsSection.classList.remove("hidden");
            console.log("‚úÖ [PDF-CERTIFY] Results section shown");

            // Scroll to results section
            resultsSection.scrollIntoView({ behavior: "smooth", block: "start" });

            form.reset();
          } else {
            console.error("‚ùå [PDF-CERTIFY] Unexpected response format:", data);
            throw new Error(data.message || data.error || "Unexpected response format");
          }
        } catch (error) {
          console.error("Error processing PDF:", error);
          errorMessage.textContent =
            error instanceof Error ? error.message : "Unknown error occurred";
          errorSection.classList.remove("hidden");
        } finally {
          submitBtn.disabled = false;
          const submitBtnText = document.getElementById("submit-btn-text") as HTMLSpanElement;
          submitBtnText.textContent = "Certify PDF";
        }
      });

      cancelBtn.addEventListener("click", () => {
        form.reset();
        resultsSection.classList.add("hidden");
        errorSection.classList.add("hidden");
      });
    });
  </script>
</LayoutFullWidth>
