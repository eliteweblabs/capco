---
/**
 * CMS Admin Page
 * Template pages (cmsPages) – markdown/content + layout (default, fullwidth, fullform, etc.).
 */
import { checkAuth } from "../../lib/auth";
import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import Button from "../../components/common/Button.astro";
import CloseButton from "../../components/ui/CloseButton.astro";
import DeleteConfirmButton from "../../components/ui/DeleteConfirmButton.astro";
import StickyActions from "../../components/project/StickyActions.astro";
import { globalClasses } from "../api/global/global-classes";
import SimpleIcon from "../../components/common/SimpleIcon.astro";
import AccordionDataTable from "../../components/common/AccordionDataTable.astro";
import CmsTemplatePageRowActions from "../../components/admin/CmsTemplatePageRowActions.astro";

const { currentUser, session, supabase } = await checkAuth(Astro.cookies);

const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

const { globalFormClasses, globalInputClasses } = globalClasses();

const navRolesOptions = ["any", "Admin", "Staff", "Client"];
const navButtonStyleOptions = ["", "primary", "secondary", "ghost", "outline"];

// Fetch template pages (cmsPages)
let templatePages: any[] = [];
try {
  const baseUrl = Astro.url.origin;
  const res = await fetch(`${baseUrl}/api/cms/pages`);
  if (res.ok) {
    const data = await res.json();
    templatePages = (data.pages || []).sort((a: any, b: any) =>
      (a.slug || "").localeCompare(b.slug || "")
    );
  }
} catch (error) {
  console.error("Error fetching template pages:", error);
}
---

<LayoutDefault
  title="CMS Management"
  description="Template pages (content + layout)."
>
  <div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">CMS</h1>
    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
      Pages use markdown/content and a layout (default, fullwidth, fullform, etc.).
    </p>
  </div>

  <section class="mb-10">
    <h2 class="mb-4 text-xl font-semibold text-gray-900 dark:text-white">Pages</h2>
    <AccordionDataTable
      id="cms-template-pages"
      data={templatePages}
      getItemId={(p) => p.slug}
      getReorderId={(p) => String(p.id)}
      slotIdPrefix="template-editor-slot"
      draggable={false}
      showCreateRow={true}
      createRowLabel="+ Create new page"
      getCreateSlotId={() => "template-create"}
      triggerClass="cms-template-trigger"
      detailClass="cms-template-detail"
      slotClass="template-editor-slot"
      chevronClass="cms-template-chevron"
      detailRowIdPrefix="cms-template"
      emptyMessage='No pages yet. Use "Create new page" above to add one.'
      getTriggerDataAttrs={(p) => ({
        editorSlot: p.slug,
        pageId: String(p.id),
      })}
      getDetailRowDataAttrs={(p) => ({ editorSlot: p.slug })}
      createRowDataAttrs={{ editorSlot: "template-create" }}
      createButtonId="create-template-page-btn"
      columns={[
        {
          key: "slug",
          label: "Slug",
          getValue: (p) => p.slug,
          cellClass: "whitespace-nowrap font-medium",
          width: 24,
        },
        {
          key: "title",
          label: "Title",
          getValue: (p) => p.title || "—",
          allowHtml: true,
          cellClass: "max-w-64 truncate whitespace-nowrap text-gray-500 dark:text-gray-400",
          width: 56,
        },
        {
          key: "template",
          label: "Template",
          getValue: (p) => p.template || "default",
          cellClass: "whitespace-nowrap text-gray-500 dark:text-gray-400",
          width: 20,
        },
      ]}
      actionsComponent={CmsTemplatePageRowActions}
      actionsGetProps={(p) => ({ page: p })}
    />
  </section>
</LayoutDefault>

<!-- Template page editor (slug, title, description, content, template) -->
<div id="template-editor-form-pool" class="hidden">
  <div id="template-editor-form-container">
    <div class="p-5">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="template-editor-title">
          Create New Page
        </h3>
        <CloseButton id="close-template-editor-btn" tooltipText="Close editor" position="top" />
      </div>
      <form id="template-page-form" class={globalFormClasses}>
        <div>
          <label for="template-page-slug" class="mb-2 block text-sm font-medium"> Slug (URL path) </label>
          <input
            type="text"
            id="template-page-slug"
            name="slug"
            required
            class={globalInputClasses}
            placeholder="about (or / for home)"
          />
        </div>
        <div>
          <label for="template-page-title" class="mb-2 block text-sm font-medium"> Title </label>
          <input
            type="text"
            id="template-page-title"
            name="title"
            class={globalInputClasses}
            placeholder="About Us"
          />
        </div>
        <div>
          <label for="template-page-description" class="mb-2 block text-sm font-medium"> Description </label>
          <input
            type="text"
            id="template-page-description"
            name="description"
            class={globalInputClasses}
            placeholder="Meta description"
          />
        </div>
        <div>
          <label for="template-page-template" class="mb-2 block text-sm font-medium"> Template </label>
          <select id="template-page-template" name="template" class={globalInputClasses}>
            <option value="default">Default</option>
            <option value="fullwidth">Full width</option>
            <option value="fullform">Full form</option>
            <option value="minimal">Minimal</option>
            <option value="centered">Centered</option>
            <option value="fullscreen">Fullscreen</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <input
            type="checkbox"
            id="template-page-include-in-nav"
            name="includeInNavigation"
            class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700"
          />
          <label for="template-page-include-in-nav" class="text-sm font-medium text-gray-700 dark:text-gray-300"> Include in navigation </label>
        </div>
        <div>
          <label class="mb-2 block text-sm font-medium"> Visible to (nav roles) </label>
          <div class="flex flex-wrap gap-3">
            {navRolesOptions.map((role) => (
              <label class="inline-flex items-center gap-2">
                <input
                  type="checkbox"
                  name="nav_roles"
                  value={role}
                  class="template-page-nav-role h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700"
                />
                <span class="text-sm text-gray-700 dark:text-gray-300">{role}</span>
              </label>
            ))}
          </div>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Roles that can see this page in the nav (any = all)</p>
        </div>
        <div>
          <label for="template-page-nav-button-style" class="mb-2 block text-sm font-medium"> Button type (nav style) </label>
          <select id="template-page-nav-button-style" name="nav_button_style" class={globalInputClasses}>
            {navButtonStyleOptions.map((opt) => (
              <option value={opt}>{opt || "— default —"}</option>
            ))}
          </select>
        </div>
        <div>
          <label for="template-page-content" class="mb-2 block text-sm font-medium"> Content (markdown or shortcodes) </label>
          <textarea
            id="template-page-content"
            name="content"
            rows={14}
            class={globalInputClasses}
            placeholder="# Heading\n\nMarkdown or <ContactForm /> etc."
          ></textarea>
        </div>
        <div id="template-form-error" class="hidden text-sm text-red-600 dark:text-red-400"></div>
        <div id="template-form-success" class="hidden text-sm text-green-600 dark:text-green-400"></div>
        <div class="flex justify-end gap-3">
          <Button type="button" id="cancel-template-btn" variant="primary"> Cancel </Button>
          <Button type="submit" variant="secondary"> Save Page </Button>
        </div>
      </form>
    </div>
  </div>
</div>

<script define:vars={{ templatePages }} lang="js">
  // ---- Template pages (cmsPages) editor ----
  window.handleTemplatePageDeleted = async function (slug) {
    if (window.showSuccess) window.showSuccess("Page Deleted", "Page deleted successfully", 2000);
    const tbody = document.querySelector("#cms-template-pages-tbody");
    if (tbody) {
      const triggerRow = tbody.querySelector(`tr.cms-template-trigger[data-editor-slot="${slug}"]`);
      const detailRow = tbody.querySelector(`tr.cms-template-detail[data-editor-slot="${slug}"]`);
      if (triggerRow) triggerRow.remove();
      if (detailRow) detailRow.remove();
    }
  };

  function initTemplateCMS() {
    const formContainer = document.getElementById("template-editor-form-container");
    const formPool = document.getElementById("template-editor-form-pool");
    const form = document.getElementById("template-page-form");
    const createBtn = document.getElementById("create-template-page-btn");
    const cancelBtn = document.getElementById("cancel-template-btn");
    const closeBtn = document.getElementById("close-template-editor-btn");
    const titleEl = document.getElementById("template-editor-title");
    let openTemplateSlotId = null;
    const templateFormCache = {};

    function getTemplateDetailRow(slotId) {
      return document.getElementById(`cms-template-detail-${slotId}`) || document.querySelector(`tr.cms-template-detail[data-editor-slot="${slotId}"]`);
    }
    function getTemplateTriggerRow(slotId) {
      return document.querySelector(`tr.cms-template-trigger[data-editor-slot="${slotId}"]`);
    }
    function getTemplateNavRoles() {
      const checkboxes = document.querySelectorAll(".template-page-nav-role:checked");
      return Array.from(checkboxes).map((el) => el.value);
    }
    function setTemplateNavRoles(roles) {
      const arr = Array.isArray(roles) ? roles : roles && roles.length ? [roles] : ["any"];
      document.querySelectorAll(".template-page-nav-role").forEach((cb) => {
        cb.checked = arr.includes(cb.value);
      });
    }
    function closeTemplateEditor() {
      if (!openTemplateSlotId) return;
      const slugEl = document.getElementById("template-page-slug");
      const titleEl2 = document.getElementById("template-page-title");
      const descEl = document.getElementById("template-page-description");
      const templateEl = document.getElementById("template-page-template");
      const contentEl = document.getElementById("template-page-content");
      const includeNavEl = document.getElementById("template-page-include-in-nav");
      const navStyleEl = document.getElementById("template-page-nav-button-style");
      if (slugEl && "value" in slugEl && titleEl2 && "value" in titleEl2 && descEl && "value" in descEl && templateEl && "value" in templateEl && contentEl && "value" in contentEl) {
        const navRoles = getTemplateNavRoles();
        templateFormCache[openTemplateSlotId] = {
          slug: slugEl.value,
          title: titleEl2.value,
          description: descEl.value,
          template: templateEl.value,
          content: contentEl.value,
          includeInNavigation: includeNavEl?.checked ?? false,
          nav_roles: navRoles.length ? navRoles : ["any"],
          nav_button_style: navStyleEl && "value" in navStyleEl ? navStyleEl.value : "",
        };
      }
      const detailRow = getTemplateDetailRow(openTemplateSlotId);
      const triggerRow = getTemplateTriggerRow(openTemplateSlotId);
      if (detailRow) { detailRow.classList.add("hidden"); detailRow.setAttribute("aria-hidden", "true"); }
      if (triggerRow) { triggerRow.setAttribute("aria-expanded", "false"); const ch = triggerRow.querySelector(".cms-template-chevron"); if (ch) ch.classList.remove("rotate-180"); }
      if (formContainer && formPool) formPool.appendChild(formContainer);
      openTemplateSlotId = null;
    }
    function openTemplateEditor(slotId) {
      const slotEl = document.getElementById(`template-editor-slot-${slotId}`);
      if (!slotEl) return;
      closeTemplateEditor();
      if (formContainer) slotEl.appendChild(formContainer);
      const detailRow = getTemplateDetailRow(slotId);
      const triggerRow = getTemplateTriggerRow(slotId);
      if (detailRow) { detailRow.classList.remove("hidden"); detailRow.setAttribute("aria-hidden", "false"); }
      if (triggerRow) { triggerRow.setAttribute("aria-expanded", "true"); const ch = triggerRow.querySelector(".cms-template-chevron"); if (ch) ch.classList.add("rotate-180"); }
      openTemplateSlotId = slotId;
      detailRow?.scrollIntoView({ behavior: "smooth", block: "nearest" });
    }
    function applyTemplatePageToForm(page) {
      const slugEl = document.getElementById("template-page-slug");
      const titleEl2 = document.getElementById("template-page-title");
      const descEl = document.getElementById("template-page-description");
      const templateEl = document.getElementById("template-page-template");
      const contentEl = document.getElementById("template-page-content");
      const includeNavEl = document.getElementById("template-page-include-in-nav");
      const navStyleEl = document.getElementById("template-page-nav-button-style");
      if (slugEl && "value" in slugEl) slugEl.value = page.slug || "";
      if (titleEl2 && "value" in titleEl2) titleEl2.value = page.title || "";
      if (descEl && "value" in descEl) descEl.value = page.description || "";
      if (templateEl && "value" in templateEl) templateEl.value = page.template || "default";
      if (contentEl && "value" in contentEl) contentEl.value = page.content || "";
      if (includeNavEl && "checked" in includeNavEl) includeNavEl.checked = !!page.includeInNavigation;
      setTemplateNavRoles(page.navRoles || page.nav_roles || ["any"]);
      if (navStyleEl && "value" in navStyleEl) navStyleEl.value = page.navButtonStyle || page.nav_button_style || "";
    }

    if (createBtn) {
      createBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        if (titleEl) titleEl.textContent = "Create New Page";
        form?.reset();
        openTemplateEditor("template-create");
      });
    }
    document.querySelectorAll(".edit-template-page-btn").forEach((btn) => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        const slug = btn.getAttribute("data-slug");
        if (!slug) return;
        if (titleEl) titleEl.textContent = `Edit Page: ${slug}`;
        const cached = templateFormCache[slug];
        if (cached) {
          const slugEl = document.getElementById("template-page-slug");
          const titleEl2 = document.getElementById("template-page-title");
          const descEl = document.getElementById("template-page-description");
          const templateEl = document.getElementById("template-page-template");
          const contentEl = document.getElementById("template-page-content");
          const includeNavEl = document.getElementById("template-page-include-in-nav");
          const navStyleEl = document.getElementById("template-page-nav-button-style");
          if (slugEl && "value" in slugEl) slugEl.value = cached.slug;
          if (titleEl2 && "value" in titleEl2) titleEl2.value = cached.title;
          if (descEl && "value" in descEl) descEl.value = cached.description;
          if (templateEl && "value" in templateEl) templateEl.value = cached.template;
          if (contentEl && "value" in contentEl) contentEl.value = cached.content;
          if (includeNavEl && "checked" in includeNavEl) includeNavEl.checked = !!cached.includeInNavigation;
          setTemplateNavRoles(cached.nav_roles || ["any"]);
          if (navStyleEl && "value" in navStyleEl) navStyleEl.value = cached.nav_button_style || "";
          openTemplateEditor(slug);
          return;
        }
        try {
          const response = await fetch(`/api/cms/pages?slug=${encodeURIComponent(slug)}`);
          const data = await response.json();
          if (data.page) applyTemplatePageToForm(data.page);
          openTemplateEditor(slug);
        } catch (err) {
          console.error("Error loading template page:", err);
          if (window.showError) window.showError("Load Failed", "Failed to load page data", 0);
        }
      });
    });
    document.querySelectorAll("tr.cms-template-trigger").forEach((triggerRow) => {
      triggerRow.addEventListener("click", (e) => {
        const tgt = e.target;
        if (tgt && typeof tgt.closest === "function" && tgt.closest(".edit-template-page-btn, .delete-confirm-btn, .delete-confirm-wrapper")) return;
        const slotId = triggerRow.getAttribute("data-editor-slot");
        if (!slotId) return;
        if (openTemplateSlotId === slotId) { closeTemplateEditor(); return; }
        if (titleEl) titleEl.textContent = slotId === "template-create" ? "Create New Page" : `Edit Page: ${slotId}`;
        if (slotId === "template-create") { form?.reset(); openTemplateEditor("template-create"); return; }
        const cached = templateFormCache[slotId];
        if (cached) {
          const slugEl = document.getElementById("template-page-slug");
          const titleEl2 = document.getElementById("template-page-title");
          const descEl = document.getElementById("template-page-description");
          const templateEl = document.getElementById("template-page-template");
          const contentEl = document.getElementById("template-page-content");
          const includeNavEl = document.getElementById("template-page-include-in-nav");
          const navStyleEl = document.getElementById("template-page-nav-button-style");
          if (slugEl && "value" in slugEl) slugEl.value = cached.slug;
          if (titleEl2 && "value" in titleEl2) titleEl2.value = cached.title;
          if (descEl && "value" in descEl) descEl.value = cached.description;
          if (templateEl && "value" in templateEl) templateEl.value = cached.template;
          if (contentEl && "value" in contentEl) contentEl.value = cached.content;
          if (includeNavEl && "checked" in includeNavEl) includeNavEl.checked = !!cached.includeInNavigation;
          setTemplateNavRoles(cached.nav_roles || ["any"]);
          if (navStyleEl && "value" in navStyleEl) navStyleEl.value = cached.nav_button_style || "";
          openTemplateEditor(slotId);
          return;
        }
        fetch(`/api/cms/pages?slug=${encodeURIComponent(slotId)}`)
          .then((r) => r.json())
          .then((data) => { if (data.page) applyTemplatePageToForm(data.page); openTemplateEditor(slotId); })
          .catch((err) => { console.error(err); if (window.showError) window.showError("Load Failed", "Failed to load page data", 0); });
      });
    });
    if (form) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const slugEl = document.getElementById("template-page-slug");
        const titleEl = document.getElementById("template-page-title");
        const descEl = document.getElementById("template-page-description");
        const templateSel = document.getElementById("template-page-template");
        const contentEl = document.getElementById("template-page-content");
        const slugRaw = (slugEl && "value" in slugEl ? slugEl.value : "").trim() || "";
        const slug = slugRaw === "/" ? "/" : slugRaw.replace(/^\/+|\/+$/g, "");
        const title = (titleEl && "value" in titleEl ? titleEl.value : "").trim() || null;
        const description = (descEl && "value" in descEl ? descEl.value : "").trim() || null;
        const template = (templateSel && "value" in templateSel ? templateSel.value : "default") || "default";
        const content = (contentEl && "value" in contentEl ? contentEl.value : "") ?? "";
        const includeNavEl = document.getElementById("template-page-include-in-nav");
        const navStyleEl = document.getElementById("template-page-nav-button-style");
        const includeInNavigation = includeNavEl && "checked" in includeNavEl ? includeNavEl.checked : false;
        const nav_rolesRaw = getTemplateNavRoles();
        const nav_roles = nav_rolesRaw.length > 0 ? nav_rolesRaw : ["any"];
        const nav_button_style = (navStyleEl && "value" in navStyleEl ? navStyleEl.value : "") || null;
        if (!slug) { if (window.showError) window.showError("Validation Error", "Slug is required", 0); return; }
        try {
          const response = await fetch("/api/cms/pages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ slug, title, description, template, content, includeInNavigation, nav_roles, nav_button_style }),
          });
          const result = await response.json();
          if (!response.ok) throw new Error(result.error || "Failed to save page");
          if (window.showSuccess) window.showSuccess("Page Saved", "Page saved successfully.", 4000);
          if (openTemplateSlotId && openTemplateSlotId !== "template-create") delete templateFormCache[openTemplateSlotId];
          window.location.reload();
        } catch (error) {
          if (window.showError) window.showError("Save Failed", error instanceof Error ? error.message : "Failed to save", 0);
        }
      });
    }
    if (cancelBtn) cancelBtn.addEventListener("click", closeTemplateEditor);
    if (closeBtn) closeBtn.addEventListener("click", closeTemplateEditor);
  }

  function initCMS(retry = false) {
    // Only run on the CMS page (avoids errors when script runs in unexpected contexts)
    if (typeof window !== "undefined" && !window.location.pathname.startsWith("/admin/cms")) {
      return;
    }
    initTemplateCMS();
    // Cmd+S / Ctrl+S to save when template editor is visible
    document.addEventListener("keydown", (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key === "s") {
        const formEl = document.getElementById("template-page-form");
        const formContainerEl = document.getElementById("template-editor-form-container");
        if (formEl && formContainerEl && formContainerEl.offsetParent !== null) {
          e.preventDefault();
          formEl.requestSubmit();
        }
      }
    });
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCMS);
  } else {
    initCMS();
  }

  // Copy shortcode to clipboard functionality
</script>
