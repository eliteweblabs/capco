---
/**
 * CMS Admin Page
 * Manage page content stored in Supabase database
 */
import { checkAuth } from "../../lib/auth";
import App from "../../components/ui/App.astro";
import Button from "../../components/common/Button.astro";
import { globalCompanyData } from "../api/global/global-company-data";
import { globalClasses } from "../api/global/global-classes";
import { readFileSync, existsSync } from "fs";
import { join } from "path";
import matter from "gray-matter";
import { getPageContent } from "../../lib/content";

const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
if (currentRole !== "Admin") {
  return Astro.redirect("/dashboard");
}

const { globalCompanyName, globalCompanySlogan, globalCompanyLogo } = await globalCompanyData();

const { globalInputClasses } = globalClasses();

// Discover available components for the accordion
function discoverComponents() {
  // Use import.meta.glob to discover components (similar to MarkdownPage.astro)
  const commonComponents = import.meta.glob("../../components/common/*.astro", { eager: false });
  const blockComponents = import.meta.glob("../../components/blocks/*.astro", { eager: false });
  const featureComponents = import.meta.glob("../../features/**/*.astro", { eager: false });

  const components: Array<{ name: string; category: string; path: string }> = [];

  // Process common components
  Object.keys(commonComponents).forEach((path) => {
    const fileName = path.split("/").pop()?.replace(".astro", "");
    if (fileName && fileName[0] === fileName[0].toUpperCase()) {
      // Only include PascalCase components (exclude utilities, layouts, etc.)
      const excluded = [
        "App",
        "Layout",
        "MarkdownPage",
        "Aside",
        "Navbar",
        "Footer",
        "Header",
        "Preloader",
      ];
      if (!excluded.includes(fileName)) {
        components.push({
          name: fileName,
          category: "Common Components",
          path: path.replace("../../", ""),
        });
      }
    }
  });

  // Process block components
  Object.keys(blockComponents).forEach((path) => {
    const fileName = path.split("/").pop()?.replace(".astro", "");
    if (fileName && fileName[0] === fileName[0].toUpperCase()) {
      // Exclude utility components
      const excluded = ["BlockRenderer"];
      if (!excluded.includes(fileName)) {
        components.push({
          name: fileName,
          category: "Block Components",
          path: path.replace("../../", ""),
        });
      }
    }
  });

  // Process feature components
  Object.keys(featureComponents).forEach((path) => {
    const fileName = path.split("/").pop()?.replace(".astro", "");
    if (fileName && fileName[0] === fileName[0].toUpperCase()) {
      // Extract feature name from path (handles nested paths like features/calendar/components/CalComBooking.astro)
      const pathParts = path.split("/");
      const featureIndex = pathParts.findIndex((p) => p === "features");
      if (featureIndex !== -1 && pathParts[featureIndex + 1]) {
        let featureName: string | undefined;

        // Check if next part is "components" (nested structure)
        if (pathParts[featureIndex + 2] === "components") {
          // Path: features/calendar/components/CalComBooking.astro
          featureName = pathParts[featureIndex + 1];
        } else {
          // Path: features/ai-chat-agent/AIChatAgent.astro
          featureName = pathParts[featureIndex + 1];
        }

        if (featureName && featureName !== "components") {
          // Format feature name (e.g., "ai-chat-agent" -> "AI Chat Agent")
          const formattedFeatureName = featureName
            .split("-")
            .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
            .join(" ");

          components.push({
            name: fileName,
            category: `${formattedFeatureName} Features`,
            path: path.replace("../../", ""),
          });
        }
      }
    }
  });

  // Group by category
  const grouped = components.reduce(
    (acc, comp) => {
      if (!acc[comp.category]) {
        acc[comp.category] = [];
      }
      acc[comp.category].push(comp);
      return acc;
    },
    {} as Record<string, Array<{ name: string; category: string; path: string }>>
  );

  // Sort categories and components
  const sortedCategories = Object.keys(grouped).sort();
  const sortedGrouped: Record<string, Array<{ name: string; category: string; path: string }>> = {};

  sortedCategories.forEach((category) => {
    sortedGrouped[category] = grouped[category].sort((a, b) => a.name.localeCompare(b.name));
  });

  return sortedGrouped;
}

const componentGroups = discoverComponents();

// Separate Common Components, Block Components, and Features
const commonComponents = componentGroups["Common Components"] || [];
const blockComponents = componentGroups["Block Components"] || [];
const featureGroups = Object.fromEntries(
  Object.entries(componentGroups).filter(([category]) => category !== "Common Components" && category !== "Block Components")
);

// Component shortcode templates with default demo values
const componentShortcodes: Record<string, string> = {
  // Common Components
  Hero: `<Hero
  title="Welcome to Our Platform"
  description="Build amazing solutions with our comprehensive tools and dedicated support."
  leftButtonText="Get Started"
  leftButtonHref="/contact"
  rightButtonText="Learn More"
  rightButtonHref="/about"
/>`,
  Button: `<Button variant="primary" href="/contact">Click Me</Button>`,
  ContactForm: `<ContactForm />`,
  ContactFormWithUpload: `<ContactFormWithUpload />`,
  PricingCard: `<PricingCard
  title="Professional"
  description="Perfect for growing businesses"
  price="$99/mo"
  features={["10 active projects", "Priority support", "Advanced analytics", "Team collaboration"]}
  buttonText="Get Started"
  buttonHref="/signup"
/>`,
  LoadingSpinner: `<LoadingSpinner size="md" color="primary" loadingText="Loading..." />`,
  Tooltip: `<Tooltip text="Helpful tooltip text" position="top">Hover me</Tooltip>`,
  SlideToggle: `<SlideToggle id="toggle-1" name="setting" label="Enable feature" checked={true} color="primary" />`,
  Breadcrumb: `<Breadcrumb items={[{ label: "Home", href: "/" }, { label: "Current Page", current: true }]} />`,
  SimpleIcon: `<SimpleIcon name="check" class="h-5 w-5 text-green-500" />`,
  Features: `<Features />`,
  Dropzone: `<Dropzone />`,
  
  // Block Components
  AlertBlock: `<AlertBlock
  variant="info"
  title="Information"
  message="This is an example alert message. Customize it with your own content."
  dismissible="true"
  buttonText="Learn More"
  buttonHref="/help"
/>`,
  CTABlock: `<CTABlock
  title="Ready to Get Started?"
  description="Join thousands of professionals using our platform to streamline their workflow."
  buttonText="Start Free Trial"
  buttonHref="/signup"
  secondaryButtonText="Schedule Demo"
  secondaryButtonHref="/contact"
  variant="centered"
/>`,
  FAQBlock: `<FAQBlock
  title="Frequently Asked Questions"
  description="Find answers to common questions about our services"
  faq1Question="What services do you offer?"
  faq1Answer="We provide comprehensive services including design, installation, inspection, and maintenance."
  faq2Question="How long does the process take?"
  faq2Answer="Project timelines vary based on scope. Small projects take 1-2 weeks, larger ones 4-8 weeks."
  faq3Question="Do you offer emergency services?"
  faq3Answer="Yes, we offer 24/7 emergency response for all clients with active maintenance contracts."
  variant="accordion"
/>`,
  StatsBlock: `<StatsBlock
  title="By The Numbers"
  description="Our track record speaks for itself"
  stat1Value="500+"
  stat1Label="Projects Completed"
  stat1Icon="folder"
  stat2Value="99%"
  stat2Label="Client Satisfaction"
  stat2Icon="heart"
  stat3Value="24/7"
  stat3Label="Support Available"
  stat3Icon="phone"
  stat4Value="15+"
  stat4Label="Years Experience"
  stat4Icon="award"
  variant="simple"
/>`,
  TimelineBlock: `<TimelineBlock
  title="Our Process"
  description="How we deliver solutions"
  step1Title="Initial Consultation"
  step1Description="We assess your needs and review requirements"
  step1Icon="phone"
  step1Status="completed"
  step2Title="Design & Planning"
  step2Description="Our team creates a custom solution"
  step2Icon="file"
  step2Status="completed"
  step3Title="Implementation"
  step3Description="Professional execution by certified experts"
  step3Icon="tool"
  step3Status="current"
  step4Title="Review & Delivery"
  step4Description="Final testing and project handoff"
  step4Icon="check-circle"
  step4Status="upcoming"
  variant="vertical"
/>`,
  LogoCloudBlock: `<LogoCloudBlock
  title="Trusted By Industry Leaders"
  description="We partner with the best in the business"
  logo1Src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/customers/spotify-grayscale.svg"
  logo1Alt="Spotify"
  logo2Src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/customers/microsoft-grayscale.svg"
  logo2Alt="Microsoft"
  logo3Src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/customers/google-grayscale.svg"
  logo3Alt="Google"
  logo4Src="https://flowbite.s3.amazonaws.com/blocks/marketing-ui/customers/amazon-grayscale.svg"
  logo4Alt="Amazon"
  variant="simple"
  grayscale="true"
/>`,
  PricingBlock: `<PricingBlock />`,
  TestimonialBlock: `<TestimonialBlock />`,
  GalleryBlock: `<GalleryBlock />`,
  NewsletterBlock: `<NewsletterBlock />`,
  TeamBlock: `<TeamBlock />`,
  FeatureGridBlock: `<FeatureGridBlock />`,
  
  // UI Components
  ImageSlider: `<ImageSlider
  title="Our Projects"
  description="Quality work across the region"
  image1="https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=800&auto=format"
  image2="https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=800&auto=format"
  image3="https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800&auto=format"
  image4="https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&auto=format"
  alt1="Construction site"
  alt2="Industrial work"
  alt3="Equipment"
  alt4="Commercial building"
  height="500px"
  overlay="true"
  overlayOpacity="0.5"
  leftButtonText="Get a Quote"
  leftButtonHref="/contact"
  rightButtonText="Learn More"
  rightButtonHref="/services"
/>`,

  // Features
  Testimonials: `<Testimonials companyName="Our Company" />`,
  CalComBooking: `<CalComBooking />`,
  GoogleMap: `<GoogleMap lat="40.7128" lng="-74.0060" zoom="12" />`,
  FeedbackWidget: `<FeedbackWidget />`,
  VapiChatWidget: `<VapiChatWidget />`,
  AIChatAgent: `<AIChatAgent />`,
};

// Helper function to get shortcode for a component
function getComponentShortcode(name: string): string {
  return componentShortcodes[name] || `<${name} />`;
}

// Fetch existing CMS pages from database
let cmsPages: any[] = [];
try {
  const baseUrl = Astro.url.origin;
  const response = await fetch(`${baseUrl}/api/cms/pages`);
  if (response.ok) {
    const data = await response.json();
    // Sort pages - use display_order if available, otherwise sort by created_at
    cmsPages = (data.pages || []).sort((a: any, b: any) => {
      // If display_order exists and is not null, use it
      if (a.display_order != null && b.display_order != null) {
        return a.display_order - b.display_order;
      }
      // Fallback to created_at
      return new Date(a.created_at || 0).getTime() - new Date(b.created_at || 0).getTime();
    });
  }
} catch (error) {
  console.error("Error fetching CMS pages:", error);
}

// Fetch existing markdown files (recursively from content/pages/)
let markdownPages: Array<{ slug: string; title: string; source: string; path: string }> = [];
try {
  const contentDir = join(process.cwd(), "content", "pages");
  if (existsSync(contentDir)) {
    const fs = require("fs");

    // Recursive function to find all markdown files
    function findMarkdownFiles(
      dir: string,
      basePath: string = ""
    ): Array<{ file: string; path: string }> {
      const results: Array<{ file: string; path: string }> = [];
      const items = fs.readdirSync(dir, { withFileTypes: true });

      for (const item of items) {
        const fullPath = join(dir, item.name);
        const relativePath = basePath ? `${basePath}/${item.name}` : item.name;

        if (item.isDirectory()) {
          // Recursively search subdirectories
          results.push(...findMarkdownFiles(fullPath, relativePath));
        } else if (item.isFile() && item.name.endsWith(".md")) {
          results.push({ file: item.name, path: relativePath });
        }
      }

      return results;
    }

    const mdFiles = findMarkdownFiles(contentDir);

    markdownPages = mdFiles.map(({ file, path }) => {
      // Slug is the path without .md extension, using / as separator
      const slug = path.replace(/\.md$/, "").replace(/\//g, "/");
      const filePath = join(contentDir, path);
      try {
        const fileContent = readFileSync(filePath, "utf-8");
        const { data } = matter(fileContent);
        return {
          slug,
          title: data.title || slug,
          source: "markdown",
          path: path,
        };
      } catch (error) {
        return {
          slug,
          title: slug,
          source: "markdown",
          path: path,
        };
      }
    });
  }
} catch (error) {
  console.error("Error reading markdown files:", error);
}

// Mark which markdown pages are already in the database
const dbSlugs = new Set(cmsPages.map((p) => p.slug));
const markdownOnlyPages = markdownPages.filter((p) => !dbSlugs.has(p.slug));
---

<App
  title="CMS Management"
  description="Manage page content"
  {currentUser}
  {session}
  {supabase}
  isBackend={true}
  {globalCompanyName}
  {globalCompanySlogan}
  {globalCompanyLogo}
>
  <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="px-4 py-6 sm:px-0">
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">CMS Management</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
          Manage page content stored in the database. Database pages override markdown files.
          Changes take effect immediately.
        </p>
      </div>

      <!-- Info Box -->
      <div class="mb-6 space-y-3">
        <div
          class="hidden p-4 bg-primary-50 dark:bg-primary-900/20 border border-primary-200 dark:border-primary-800 rounded-lg"
        >
          <p class="text-sm text-primary-800 dark:text-primary-200">
            <strong>How it works:</strong> Content is loaded in this order: <strong>Database</strong
            > ‚Üí Markdown Files ‚Üí Defaults. Pages in the database will override markdown files with the
            same slug.
          </p>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="mb-6 flex gap-3 flex-wrap items-center">
        <Button id="create-page-btn" variant="primary" icon="plus"> Create New Page </Button>
        <a href="/admin/settings">
          <Button variant="secondary" icon="cog"> Global Settings </Button>
        </a>
        {
          markdownPages.length > 0 && (
            <>
              <Button id="import-all-markdown-btn" variant="success" icon="download">
                üì• Import All Markdown ({markdownPages.length})
              </Button>
              <div class="flex items-center text-sm text-gray-600 dark:text-gray-400 ml-2">
                <span class="mr-1">üí°</span>
                <span>
                  {markdownOnlyPages.length > 0
                    ? `${markdownOnlyPages.length} not imported yet`
                    : `All ${markdownPages.length} already imported (will update existing)`}
                </span>
              </div>
            </>
          )
        }
      </div>

      <!-- Markdown Files Section (if any exist) -->
      {
        markdownOnlyPages.length > 0 && (
          <div class="mb-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
            <h2 class="text-lg font-semibold mb-3 text-yellow-900 dark:text-yellow-200">
              üìÑ Markdown Files (Not in Database)
            </h2>
            <p class="text-sm text-yellow-800 dark:text-yellow-300 mb-3">
              These pages exist as markdown files but aren't in the database yet. Import them to
              enable database editing.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
              {markdownOnlyPages.map((page) => (
                <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-800 rounded border border-yellow-200 dark:border-yellow-700">
                  <div class="flex-1 min-w-0">
                    <div class="font-medium text-sm text-gray-900 dark:text-white truncate">
                      {page.title}
                    </div>
                    <div class="text-xs text-gray-500 dark:text-gray-400 truncate">
                      /{page.slug}
                    </div>
                    {page.path && page.path !== `${page.slug}.md` && (
                      <div
                        class="text-xs text-gray-400 dark:text-gray-500 truncate"
                        title={page.path}
                      >
                        üìÅ {page.path}
                      </div>
                    )}
                  </div>
                  <button
                    class="ml-2 text-xs px-2 py-1 bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 rounded hover:bg-yellow-200 dark:hover:bg-yellow-800 import-markdown-btn flex-shrink-0"
                    data-slug={page.slug}
                    data-path={page.path}
                  >
                    Import
                  </button>
                </div>
              ))}
            </div>
          </div>
        )
      }

      <!-- Pages List -->
      <div class="bg-white dark:bg-gray-800 shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-900">
            <tr>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider w-12"
              >
                {/* Drag handle column */}
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Slug
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Title
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Template
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Source
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Status
              </th>
              <th
                class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider"
              >
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
            {
              cmsPages.length === 0 ? (
                <tr>
                  <td
                    colspan="7"
                    class="px-6 py-4 text-center text-sm text-gray-500 dark:text-gray-400"
                  >
                    No pages in database.{" "}
                    {markdownOnlyPages.length > 0
                      ? "Import markdown files above or create a new page."
                      : "Create your first page above."}
                  </td>
                </tr>
              ) : (
                cmsPages.map((page, index) => (
                  <tr
                    class="cursor-move hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                    draggable="true"
                    data-page-id={page.id}
                    data-page-slug={page.slug}
                    data-display-order={page.display_order ?? index}
                  >
                    <td class="px-2 py-4 text-center text-gray-400 dark:text-gray-500 cursor-grab active:cursor-grabbing">
                      <svg
                        class="w-5 h-5 mx-auto"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                        xmlns="http://www.w3.org/2000/svg"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M4 8h16M4 16h16"
                        />
                      </svg>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                      {page.slug}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                      {page.title || "‚Äî"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">
                      {page.template || "default"}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-200">
                        Database
                      </span>
                      {markdownPages.some((mp) => mp.slug === page.slug) && (
                        <span
                          class="ml-2 px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400"
                          title="Also exists as markdown file"
                        >
                          üìÑ MD
                        </span>
                      )}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                      {page.isActive ? (
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                          Active
                        </span>
                      ) : (
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                          Inactive
                        </span>
                      )}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                      <button
                        class="text-primary hover:text-primary-dark mr-4 edit-page-btn"
                        data-slug={page.slug}
                      >
                        Edit
                      </button>
                      <button
                        class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 delete-page-btn"
                        data-slug={page.slug}
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                ))
              )
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Page Editor Modal -->
  <div
    id="page-editor-modal"
    class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
  >
    <div
      id="page-editor-modal-content"
      class="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white dark:bg-gray-800"
    >
      <div class="mt-3">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="modal-title">
            Create New Page
          </h3>
          <button
            id="close-modal-btn"
            type="button"
            class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded p-1"
            aria-label="Close modal"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <form id="page-form" class="space-y-4">
          <div>
            <label for="page-slug" class="block text-sm font-medium mb-2"> Slug (URL path) </label>
            <input
              type="text"
              id="page-slug"
              name="slug"
              required
              class={globalInputClasses}
              placeholder="about"
            />
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              The URL path for this page (e.g., "about" becomes "/about")
            </p>
          </div>

          <div>
            <label for="page-title" class="block text-sm font-medium mb-2"> Title </label>
            <input
              type="text"
              id="page-title"
              name="title"
              class={globalInputClasses}
              placeholder="About Us"
            />
          </div>

          <div>
            <label for="page-description" class="block text-sm font-medium mb-2">
              Description
            </label>
            <input
              type="text"
              id="page-description"
              name="description"
              class={globalInputClasses}
              placeholder="Page meta description"
            />
          </div>

          <div>
            <label for="page-template" class="block text-sm font-medium mb-2"> Template </label>
            <select id="page-template" name="template" class={globalInputClasses}>
              <option value="default">Default</option>
              <option value="fullwidth">Full Width</option>
              <option value="minimal">Minimal</option>
            </select>
          </div>

          <div class="flex items-center">
            <input
              type="checkbox"
              id="page-include-in-navigation"
              name="includeInNavigation"
              class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
            />
            <label
              for="page-include-in-navigation"
              class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300"
            >
              Include in primary navigation
            </label>
          </div>
          <p class="text-xs text-gray-500 dark:text-gray-400 -mt-2 mb-2">
            If checked, this page will appear in the main navigation menu
          </p>

          <!-- Navigation Properties (shown when includeInNavigation is checked) -->
          <div id="navigation-properties" class="hidden space-y-4 border-t pt-4 mt-4">
            <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">
              Navigation Settings
            </h4>

            <div>
              <label for="page-nav-roles" class="block text-sm font-medium mb-2">
                Visible to Roles
              </label>
              <div class="flex flex-wrap gap-2">
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="nav_roles"
                    value="any"
                    checked
                    class="w-4 h-4 text-primary-600 rounded"
                  />
                  <span class="ml-2 text-sm">Any</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="nav_roles"
                    value="Client"
                    class="w-4 h-4 text-primary-600 rounded"
                  />
                  <span class="ml-2 text-sm">Client</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="nav_roles"
                    value="Admin"
                    class="w-4 h-4 text-primary-600 rounded"
                  />
                  <span class="ml-2 text-sm">Admin</span>
                </label>
                <label class="flex items-center">
                  <input
                    type="checkbox"
                    name="nav_roles"
                    value="Staff"
                    class="w-4 h-4 text-primary-600 rounded"
                  />
                  <span class="ml-2 text-sm">Staff</span>
                </label>
              </div>
            </div>

            <div>
              <label for="page-nav-page-type" class="block text-sm font-medium mb-2">
                Page Type
              </label>
              <select id="page-nav-page-type" name="nav_page_type" class={globalInputClasses}>
                <option value="frontend">Frontend</option>
                <option value="backend">Backend</option>
              </select>
            </div>

            <div>
              <label for="page-nav-button-style" class="block text-sm font-medium mb-2">
                Button Style (Optional)
              </label>
              <select id="page-nav-button-style" name="nav_button_style" class={globalInputClasses}>
                <option value="">None (Regular Link)</option>
                <option value="primary">Primary</option>
                <option value="secondary">Secondary</option>
                <option value="ghost">Ghost</option>
                <option value="outline">Outline</option>
              </select>
            </div>

            <div class="flex items-center">
              <input
                type="checkbox"
                id="page-nav-desktop-only"
                name="nav_desktop_only"
                class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
              />
              <label
                for="page-nav-desktop-only"
                class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300"
              >
                Desktop Only
              </label>
            </div>

            <div class="flex items-center">
              <input
                type="checkbox"
                id="page-nav-hide-when-auth"
                name="nav_hide_when_auth"
                class="w-4 h-4 text-primary-600 bg-gray-100 border-gray-300 rounded focus:ring-primary-500 dark:focus:ring-primary-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600"
              />
              <label
                for="page-nav-hide-when-auth"
                class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300"
              >
                Hide When Authenticated
              </label>
            </div>
          </div>

          <div>
            <label for="page-content" class="block text-sm font-medium mb-2">
              Content (Markdown)
            </label>
            <!-- Component Shortcodes Section -->
            <div class="mb-2 space-y-2">
              <p class="text-xs text-gray-600 dark:text-gray-400 mb-2">
                üí° Embed components in markdown: <code
                  class="bg-white dark:bg-gray-800 px-1 rounded"
                  >&lt;ComponentName prop="value" /&gt;</code
                >
              </p>

              <!-- Common Components Accordion -->
              {
                commonComponents.length > 0 && (
                  <div
                    id="modal-common-components-accordion"
                    data-accordion="collapse"
                    class="mb-2"
                  >
                    <h2>
                      <button
                        type="button"
                        class="flex items-center justify-between w-full p-3 text-sm font-medium text-primary border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800"
                        data-accordion-target="#modal-common-components-body"
                        aria-expanded="false"
                        aria-controls="modal-common-components-body"
                      >
                        <span class="flex items-center gap-2">
                          <span>üì¶</span>
                          <span>Common Components ({commonComponents.length})</span>
                        </span>
                        <svg
                          data-accordion-icon
                          class="w-3 h-3 rotate-180 shrink-0"
                          aria-hidden="true"
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 10 6"
                        >
                          <path
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5 5 1 1 5"
                          />
                        </svg>
                      </button>
                    </h2>
                    <div
                      id="modal-common-components-body"
                      class="hidden"
                      aria-labelledby="modal-common-components-heading"
                    >
                      <div class="p-4 border border-t-0 border-gray-200 dark:border-gray-700 rounded-b-lg bg-primary-50 dark:bg-primary-900/20 max-h-96 overflow-y-auto">
                        <div class="space-y-3 font-mono text-xs">
                          {commonComponents.map((comp) => (
                            <div class="bg-white dark:bg-gray-800 rounded p-2 border border-gray-200 dark:border-gray-600">
                              <div class="flex items-center justify-between mb-1">
                                <span class="font-semibold text-primary-600 dark:text-primary-400">{comp.name}</span>
                                <button 
                                  type="button"
                                  class="copy-shortcode-btn text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-gray-600 dark:text-gray-300"
                                  data-shortcode={getComponentShortcode(comp.name)}
                                >
                                  Copy
                                </button>
                              </div>
                              <pre class="text-gray-600 dark:text-gray-400 whitespace-pre-wrap break-all text-[10px] leading-tight">{getComponentShortcode(comp.name)}</pre>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )
              }

              <!-- Block Components Accordion -->
              {
                blockComponents.length > 0 && (
                  <div
                    id="modal-block-components-accordion"
                    data-accordion="collapse"
                    class="mb-2"
                  >
                    <h2>
                      <button
                        type="button"
                        class="flex items-center justify-between w-full p-3 text-sm font-medium text-primary border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800"
                        data-accordion-target="#modal-block-components-body"
                        aria-expanded="false"
                        aria-controls="modal-block-components-body"
                      >
                        <span class="flex items-center gap-2">
                          <span>üß±</span>
                          <span>Block Components ({blockComponents.length})</span>
                        </span>
                        <svg
                          data-accordion-icon
                          class="w-3 h-3 rotate-180 shrink-0"
                          aria-hidden="true"
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 10 6"
                        >
                          <path
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5 5 1 1 5"
                          />
                        </svg>
                      </button>
                    </h2>
                    <div
                      id="modal-block-components-body"
                      class="hidden"
                      aria-labelledby="modal-block-components-heading"
                    >
                      <div class="p-4 border border-t-0 border-gray-200 dark:border-gray-700 rounded-b-lg bg-primary-50 dark:bg-primary-900/20 max-h-96 overflow-y-auto">
                        <div class="space-y-3 font-mono text-xs">
                          {blockComponents.map((comp) => (
                            <div class="bg-white dark:bg-gray-800 rounded p-2 border border-gray-200 dark:border-gray-600">
                              <div class="flex items-center justify-between mb-1">
                                <span class="font-semibold text-primary-600 dark:text-primary-400">{comp.name}</span>
                                <button 
                                  type="button"
                                  class="copy-shortcode-btn text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-gray-600 dark:text-gray-300"
                                  data-shortcode={getComponentShortcode(comp.name)}
                                >
                                  Copy
                                </button>
                              </div>
                              <pre class="text-gray-600 dark:text-gray-400 whitespace-pre-wrap break-all text-[10px] leading-tight">{getComponentShortcode(comp.name)}</pre>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  </div>
                )
              }

              <!-- Features Accordion -->
              {
                Object.keys(featureGroups).length > 0 && (
                  <div
                    id="modal-feature-components-accordion"
                    data-accordion="collapse"
                    class="mb-2"
                  >
                    <h2>
                      <button
                        type="button"
                        class="flex items-center justify-between w-full p-3 text-sm font-medium text-primary border border-gray-200 dark:border-gray-700 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 focus:ring-4 focus:ring-gray-200 dark:focus:ring-gray-800"
                        data-accordion-target="#modal-feature-components-body"
                        aria-expanded="false"
                        aria-controls="modal-feature-components-body"
                      >
                        <span class="flex items-center gap-2">
                          <span>‚ö°</span>
                          <span>
                            Feature Components ({Object.values(featureGroups).flat().length})
                          </span>
                        </span>
                        <svg
                          data-accordion-icon
                          class="w-3 h-3 rotate-180 shrink-0"
                          aria-hidden="true"
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 10 6"
                        >
                          <path
                            stroke="currentColor"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 5 5 1 1 5"
                          />
                        </svg>
                      </button>
                    </h2>
                    <div
                      id="modal-feature-components-body"
                      class="hidden"
                      aria-labelledby="modal-feature-components-heading"
                    >
                      <div class="p-4 border border-t-0 border-gray-200 dark:border-gray-700 rounded-b-lg bg-primary-50 dark:bg-primary-900/20">
                        {/* Nested Accordion for Feature Categories */}
                        <div
                          id="modal-feature-categories-accordion"
                          data-accordion="collapse"
                          class="space-y-2"
                        >
                          {Object.entries(featureGroups).map(
                            ([category, components], categoryIndex) => (
                              <div>
                                <h3>
                                  <button
                                    type="button"
                                    class="flex items-center justify-between w-full p-2 text-xs font-semibold text-gray-700 dark:text-gray-300 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700 focus:ring-2 focus:ring-gray-200 dark:focus:ring-gray-600"
                                    data-accordion-target={`#modal-feature-category-${categoryIndex}-body`}
                                    aria-expanded="false"
                                    aria-controls={`modal-feature-category-${categoryIndex}-body`}
                                  >
                                    <span>
                                      {category} ({components.length})
                                    </span>
                                    <svg
                                      data-accordion-icon
                                      class="w-3 h-3 rotate-180 shrink-0"
                                      aria-hidden="true"
                                      xmlns="http://www.w3.org/2000/svg"
                                      fill="none"
                                      viewBox="0 0 10 6"
                                    >
                                      <path
                                        stroke="currentColor"
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M9 5 5 1 1 5"
                                      />
                                    </svg>
                                  </button>
                                </h3>
                                <div
                                  id={`modal-feature-category-${categoryIndex}-body`}
                                  class="hidden"
                                  aria-labelledby={`modal-feature-category-${categoryIndex}-heading`}
                                >
                                  <div class="p-3 border border-t-0 border-gray-300 dark:border-gray-600 rounded-b bg-white dark:bg-gray-800 max-h-64 overflow-y-auto">
                                    <div class="space-y-2 font-mono text-xs">
                                      {components.map((comp) => (
                                        <div class="bg-gray-50 dark:bg-gray-700 rounded p-2 border border-gray-200 dark:border-gray-600">
                                          <div class="flex items-center justify-between mb-1">
                                            <span class="font-semibold text-primary-600 dark:text-primary-400">{comp.name}</span>
                                            <button 
                                              type="button"
                                              class="copy-shortcode-btn text-xs px-2 py-0.5 bg-gray-100 dark:bg-gray-600 hover:bg-gray-200 dark:hover:bg-gray-500 rounded text-gray-600 dark:text-gray-300"
                                              data-shortcode={getComponentShortcode(comp.name)}
                                            >
                                              Copy
                                            </button>
                                          </div>
                                          <pre class="text-gray-600 dark:text-gray-400 whitespace-pre-wrap break-all text-[10px] leading-tight">{getComponentShortcode(comp.name)}</pre>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )
              }

              <p class="text-xs text-gray-600 dark:text-gray-400 mt-2">
                Components discovered from <code class="bg-white dark:bg-gray-800 px-1 rounded"
                  >src/components/common/</code
                > and <code class="bg-white dark:bg-gray-800 px-1 rounded">src/features/*/</code>.
              </p>
            </div>
            <textarea
              id="page-content"
              name="content"
              required
              rows={15}
              class={globalInputClasses}
              placeholder={`# Page Title

Your markdown content here...

You can embed components:
<Hero title="Welcome" />
<ContactForm />`}></textarea>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Markdown content for this page. Supports standard Markdown syntax and component
              shortcodes.
            </p>
          </div>

          <div id="form-error" class="hidden text-red-600 dark:text-red-400 text-sm"></div>
          <div id="form-success" class="hidden text-green-600 dark:text-green-400 text-sm"></div>

          <div class="flex justify-end gap-3">
            <Button type="button" id="cancel-btn" variant="secondary"> Cancel </Button>
            <Button type="submit" variant="primary"> Save Page </Button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script define:vars={{ markdownOnlyPages, markdownPages }}>
    let editingSlug = null;
    const markdownPagesList = markdownPages || [];
    const markdownOnlyPagesList = markdownOnlyPages || [];

    function initCMS() {
      const modal = document.getElementById("page-editor-modal");
      const form = document.getElementById("page-form");
      const createBtn = document.getElementById("create-page-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const closeBtn = document.getElementById("close-modal-btn");
      // Error and success divs removed - using global toast system instead
      const modalTitle = document.getElementById("modal-title");
      const includeInNavCheckbox = document.getElementById("page-include-in-navigation");
      const navPropertiesSection = document.getElementById("navigation-properties");

      if (!modal || !form || !createBtn) {
        console.error("[CMS] Required elements not found:", { modal, form, createBtn });
        return;
      }

      // Toggle navigation properties section based on checkbox
      if (includeInNavCheckbox && navPropertiesSection) {
        const toggleNavProperties = () => {
          if (includeInNavCheckbox instanceof HTMLInputElement) {
            navPropertiesSection.classList.toggle("hidden", !includeInNavCheckbox.checked);
          }
        };
        includeInNavCheckbox.addEventListener("change", toggleNavProperties);
        toggleNavProperties(); // Initial state
      }

      // Open modal for creating new page
      createBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        console.log("[CMS] Create button clicked");
        editingSlug = null;
        form.reset();
        const includeInNavCheckbox = document.getElementById("page-include-in-navigation");
        if (includeInNavCheckbox && includeInNavCheckbox instanceof HTMLInputElement) {
          includeInNavCheckbox.checked = false;
        }
        if (modalTitle) modalTitle.textContent = "Create New Page";
        modal.classList.remove("hidden");
      });

      // Open modal for editing existing page
      document.querySelectorAll(".edit-page-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const slug = btn.getAttribute("data-slug");
          if (!slug) return;

          editingSlug = slug;
          if (modalTitle) modalTitle.textContent = `Edit Page: ${slug}`;

          try {
            const response = await fetch(`/api/cms/pages?slug=${slug}`);
            const data = await response.json();
            const page = data.page;

            if (page) {
              const slugInput = document.getElementById("page-slug");
              const titleInput = document.getElementById("page-title");
              const descInput = document.getElementById("page-description");
              const templateSelect = document.getElementById("page-template");
              const contentTextarea = document.getElementById("page-content");
              const includeInNavCheckbox = document.getElementById("page-include-in-navigation");
              const navPageTypeSelect = document.getElementById("page-nav-page-type");
              const navButtonStyleSelect = document.getElementById("page-nav-button-style");
              const navDesktopOnlyCheckbox = document.getElementById("page-nav-desktop-only");
              const navHideWhenAuthCheckbox = document.getElementById("page-nav-hide-when-auth");

              if (slugInput) slugInput.value = page.slug || "";
              if (titleInput) titleInput.value = page.title || "";
              if (descInput) descInput.value = page.description || "";
              if (templateSelect) templateSelect.value = page.template || "default";
              if (contentTextarea) contentTextarea.value = page.content || "";
              if (includeInNavCheckbox && includeInNavCheckbox instanceof HTMLInputElement) {
                includeInNavCheckbox.checked = page.includeInNavigation || false;
                // Trigger change event to show/hide navigation properties
                includeInNavCheckbox.dispatchEvent(new Event("change"));
              }

              // Set navigation properties
              if (navPageTypeSelect && navPageTypeSelect instanceof HTMLSelectElement) {
                navPageTypeSelect.value = page.nav_page_type || "frontend";
              }
              if (navButtonStyleSelect && navButtonStyleSelect instanceof HTMLSelectElement) {
                navButtonStyleSelect.value = page.nav_button_style || "";
              }
              if (navDesktopOnlyCheckbox && navDesktopOnlyCheckbox instanceof HTMLInputElement) {
                navDesktopOnlyCheckbox.checked = page.nav_desktop_only || false;
              }
              if (navHideWhenAuthCheckbox && navHideWhenAuthCheckbox instanceof HTMLInputElement) {
                navHideWhenAuthCheckbox.checked = page.nav_hide_when_auth || false;
              }

              // Set nav roles checkboxes
              const navRoles = page.nav_roles || ["any"];
              document.querySelectorAll('input[name="nav_roles"]').forEach((cb) => {
                if (cb instanceof HTMLInputElement) {
                  cb.checked = navRoles.includes(cb.value);
                }
              });
            }

            modal.classList.remove("hidden");
          } catch (error) {
            console.error("Error loading page:", error);
            if (window.showError) {
              window.showError("Load Failed", "Failed to load page data", 0);
            }
          }
        });
      });

      // Delete page
      document.querySelectorAll(".delete-page-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const slug = btn.getAttribute("data-slug");
          if (!slug) return;

          if (!confirm(`Are you sure you want to delete the page "${slug}"?`)) {
            return;
          }

          try {
            const response = await fetch(`/api/cms/pages?slug=${slug}`, {
              method: "DELETE",
            });

            if (response.ok) {
              if (window.showSuccess) {
                window.showSuccess("Page Deleted", "Page deleted successfully", 2000);
              }
              setTimeout(() => location.reload(), 500);
            } else {
              const data = await response.json();
              if (window.showError) {
                window.showError("Delete Failed", data.error || "Failed to delete page", 0);
              }
            }
          } catch (error) {
            console.error("Error deleting page:", error);
            if (window.showError) {
              window.showError("Delete Failed", "Failed to delete page", 0);
            }
          }
        });
      });

      // Close modal function
      const closeModal = () => {
        modal.classList.add("hidden");
      };

      // Close modal - via cancel button or close X button
      if (cancelBtn) {
        cancelBtn.addEventListener("click", closeModal);
      }

      if (closeBtn) {
        closeBtn.addEventListener("click", closeModal);
      }

      // Drag and drop functionality for reordering pages
      let draggedElement = null;
      let draggedIndex = -1;

      const tbody = document.querySelector("tbody");
      if (tbody) {
        // Make rows draggable
        const rows = Array.from(tbody.querySelectorAll("tr[draggable='true']"));

        rows.forEach((row, index) => {
          row.addEventListener("dragstart", (e) => {
            draggedElement = row;
            draggedIndex = index;
            row.classList.add("opacity-50");
            if (e.dataTransfer) {
              e.dataTransfer.effectAllowed = "move";
              e.dataTransfer.setData("text/html", row.innerHTML);
            }
          });

          row.addEventListener("dragend", () => {
            if (draggedElement) {
              draggedElement.classList.remove("opacity-50");
            }
            rows.forEach((r) => {
              r.classList.remove("border-t-2", "border-primary-500");
            });
          });

          row.addEventListener("dragover", (e) => {
            e.preventDefault();
            if (e.dataTransfer) {
              e.dataTransfer.dropEffect = "move";
            }
            if (draggedElement && row !== draggedElement) {
              row.classList.add("border-t-2", "border-primary-500");
            }
          });

          row.addEventListener("dragleave", () => {
            row.classList.remove("border-t-2", "border-primary-500");
          });

          row.addEventListener("drop", async (e) => {
            e.preventDefault();
            row.classList.remove("border-t-2", "border-primary-500");

            if (draggedElement && draggedElement !== row) {
              const dropIndex = rows.indexOf(row);

              // Reorder DOM
              if (draggedIndex < dropIndex) {
                tbody.insertBefore(draggedElement, row.nextSibling);
              } else {
                tbody.insertBefore(draggedElement, row);
              }

              // Update display_order in database
              const newRows = Array.from(tbody.querySelectorAll("tr[draggable='true']"));
              const orderUpdates = [];

              newRows.forEach((r, idx) => {
                const pageId = r.getAttribute("data-page-id");
                if (pageId) {
                  orderUpdates.push({
                    id: pageId,
                    display_order: idx,
                  });
                }
              });

              // Save new order to database
              try {
                const response = await fetch("/api/cms/pages", {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ orders: orderUpdates }),
                });

                if (!response.ok) {
                  const error = await response.json();
                  throw new Error(error.error || "Failed to update order");
                }

                // Update data attributes
                newRows.forEach((r, idx) => {
                  r.setAttribute("data-display-order", idx.toString());
                });
              } catch (error) {
                console.error("Error updating page order:", error);
                if (window.showError) {
                  window.showError("Save Failed", "Failed to save new order. Reloading page...", 3000);
                }
                setTimeout(() => location.reload(), 1000);
              }
            }
          });
        });
      }

      // Import markdown file
      async function importMarkdownFile(slug, filePath) {
        try {
          const url = filePath
            ? `/api/cms/import-markdown?slug=${slug}&path=${encodeURIComponent(filePath)}`
            : `/api/cms/import-markdown?slug=${slug}`;
          const response = await fetch(url);
          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || "Failed to import markdown file");
          }

          if (window.showSuccess) {
            window.showSuccess("Import Successful", `Successfully imported "${slug}" from markdown!`, 3000);
          }
          setTimeout(() => location.reload(), 500);
        } catch (error) {
          const errorMsg = error instanceof Error ? error.message : String(error);
          if (window.showError) {
            window.showError("Import Failed", `Error importing: ${errorMsg}`, 0);
          }
        }
      }

      // Import all markdown files (bulk import)
      const importAllBtn = document.getElementById("import-all-markdown-btn");
      if (importAllBtn) {
        importAllBtn.addEventListener("click", async () => {
          const alreadyImported = markdownPagesList.length - markdownOnlyPagesList.length;
          const message =
            alreadyImported > 0
              ? `Import all ${markdownPagesList.length} markdown files into the database?\n\n${alreadyImported} are already imported and will be updated. This will add them to the CMS so you can edit them through this interface.`
              : `Import all ${markdownPagesList.length} markdown files into the database?\n\nThis will add them to the CMS so you can edit them through this interface.`;

          if (!confirm(message)) {
            return;
          }

          try {
            importAllBtn.textContent = "Importing...";
            importAllBtn.disabled = true;

            const response = await fetch("/api/cms/import-all-markdown", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
            });

            const result = await response.json();

            if (!response.ok) {
              throw new Error(result.error || "Failed to import markdown files");
            }

            if (result.errors && result.errors.length > 0) {
              const errorList = result.errors.map((e) => `- ${e.slug}: ${e.error}`).join("\n");
              if (window.showWarning) {
                window.showWarning(
                  "Partial Import",
                  `Imported ${result.imported} files, but ${result.errors.length} failed:\n\n${errorList}`,
                  0
                );
              }
            } else {
              if (window.showSuccess) {
                window.showSuccess("Import Successful", `Successfully imported ${result.imported} markdown files!`, 4000);
              }
            }

            // Reload page to show imported pages
            setTimeout(() => location.reload(), 500);
          } catch (error) {
            const errorMsg = error instanceof Error ? error.message : String(error);
            if (window.showError) {
              window.showError("Import Failed", `Error importing files: ${errorMsg}`, 0);
            }
            importAllBtn.textContent = "Import All Markdown";
            importAllBtn.disabled = false;
          }
        });
      }

      // Import individual markdown file
      document.querySelectorAll(".import-markdown-btn").forEach((btn) => {
        btn.addEventListener("click", async () => {
          const slug = btn.getAttribute("data-slug");
          const filePath = btn.getAttribute("data-path");
          if (!slug) return;
          await importMarkdownFile(slug, filePath || undefined);
        });
      });

      // Handle form submission
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        // Clear any previous notifications

        // Get form values directly from inputs (more reliable than FormData)
        const slugInput = document.getElementById("page-slug");
        const titleInput = document.getElementById("page-title");
        const descInput = document.getElementById("page-description");
        const templateSelect = document.getElementById("page-template");
        const contentTextarea = document.getElementById("page-content");
        const includeInNavCheckbox = document.getElementById("page-include-in-navigation");

        const slug = slugInput?.value?.trim() || "";
        const title = titleInput?.value?.trim() || null;
        const description = descInput?.value?.trim() || null;
        const content = contentTextarea?.value?.trim() || "";
        const template = templateSelect?.value?.trim() || "default";
        const includeInNavigation =
          (includeInNavCheckbox &&
            includeInNavCheckbox instanceof HTMLInputElement &&
            includeInNavCheckbox.checked) ||
          false;

        // Get navigation properties
        const navRolesCheckboxes = document.querySelectorAll('input[name="nav_roles"]:checked');
        const navRoles = Array.from(navRolesCheckboxes)
          .map((cb) => {
            if (cb instanceof HTMLInputElement) return cb.value;
            return "";
          })
          .filter((v) => v);
        const navPageTypeSelect = document.getElementById("page-nav-page-type");
        const navButtonStyleSelect = document.getElementById("page-nav-button-style");
        const navDesktopOnlyCheckbox = document.getElementById("page-nav-desktop-only");
        const navHideWhenAuthCheckbox = document.getElementById("page-nav-hide-when-auth");

        const navPageType =
          navPageTypeSelect instanceof HTMLSelectElement ? navPageTypeSelect.value : "frontend";
        const navButtonStyle =
          navButtonStyleSelect instanceof HTMLSelectElement && navButtonStyleSelect.value
            ? navButtonStyleSelect.value
            : null;
        const navDesktopOnly =
          navDesktopOnlyCheckbox instanceof HTMLInputElement && navDesktopOnlyCheckbox.checked;
        const navHideWhenAuth =
          navHideWhenAuthCheckbox instanceof HTMLInputElement && navHideWhenAuthCheckbox.checked;

        // Validate required fields
        if (!slug) {
          if (window.showError) {
            window.showError("Validation Error", "Slug is required", 0);
          }
          return;
        }

        if (!content) {
          if (window.showError) {
            window.showError("Validation Error", "Content is required", 0);
          }
          return;
        }

        const data = {
          slug,
          title,
          description,
          content,
          template,
          includeInNavigation: includeInNavigation,
          nav_roles: navRoles.length > 0 ? navRoles : ["any"],
          nav_page_type: navPageType,
          nav_button_style: navButtonStyle,
          nav_desktop_only: navDesktopOnly,
          nav_hide_when_auth: navHideWhenAuth,
        };

        // Debug logging
        console.log("[CMS] Form data being sent:", data);
        console.log("[CMS] Input values:", {
          slug: slugInput?.value,
          title: titleInput?.value,
          description: descInput?.value,
          content: contentTextarea?.value?.substring(0, 50) + "...",
          template: templateSelect?.value,
          includeInNavigation: includeInNavCheckbox?.checked,
        });

        try {
          const response = await fetch("/api/cms/pages", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.error || result.message || "Failed to save page");
          }

          if (window.showSuccess) {
            window.showSuccess("Page Saved", "Page saved successfully! Reloading...", 4000);
          }

          setTimeout(() => {
            location.reload();
          }, 1000);
        } catch (error) {
          const errorMessage =
            error instanceof Error
              ? error.message
              : typeof error === "string"
                ? error
                : "An error occurred while saving the page";
          if (window.showError) {
            window.showError("Save Failed", errorMessage, 0);
          }
          console.error("CMS page save error:", error);
        }
      });
    }

    // Initialize on DOM ready
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initCMS);
    } else {
      initCMS();
    }

    // Copy shortcode to clipboard functionality
    document.addEventListener("click", async (e) => {
      const target = e.target;
      if (target && target.classList && target.classList.contains("copy-shortcode-btn")) {
        const shortcode = target.getAttribute("data-shortcode");
        if (shortcode) {
          try {
            await navigator.clipboard.writeText(shortcode);
            const originalText = target.textContent;
            target.textContent = "Copied!";
            target.classList.add("bg-green-100", "dark:bg-green-800", "text-green-700", "dark:text-green-200");
            setTimeout(() => {
              target.textContent = originalText;
              target.classList.remove("bg-green-100", "dark:bg-green-800", "text-green-700", "dark:text-green-200");
            }, 1500);
          } catch (err) {
            console.error("Failed to copy:", err);
            target.textContent = "Error";
            setTimeout(() => {
              target.textContent = "Copy";
            }, 1500);
          }
        }
      }
    });
  </script>
</App>
