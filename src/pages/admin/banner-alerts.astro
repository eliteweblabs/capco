---
import { checkAuth } from "../../lib/auth";
import { supabaseAdmin } from "../../lib/supabase-admin";
import App from "../../components/ui/App.astro";
import Alert from "../../components/partials/Alert.astro";
import Hero from "../../components/common/Hero.astro";
import DeleteConfirmButton from "../../components/common/DeleteConfirmButton.astro";
import SlidingTabs from "../../components/common/SlidingTabs.astro";

import { globalCompanyData } from "../api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
} = await globalCompanyData();

import { globalClasses } from "../api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses } = globalClasses();

// Check authentication
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
const { data: profile } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", currentUser.id)
  .single();

if (profile?.role !== "Admin") {
  return Astro.redirect("/dashboard");
}

// Get all banner alerts
let bannerAlerts: any[] = [];
if (supabaseAdmin) {
  const { data, error } = await supabaseAdmin
    .from("bannerAlerts")
    .select("*")
    .order("createdAt", { ascending: false });

  if (error) {
    console.error("Error fetching banner alerts:", error);
  } else {
    bannerAlerts = data || [];
  }
}

// Type options
const typeOptions = [
  { value: "info", label: "Info", color: "blue" },
  { value: "success", label: "Success", color: "green" },
  { value: "warning", label: "Warning", color: "orange" },
  { value: "error", label: "Error", color: "red" },
];

// Tab from URL for initial active state
const bannerTabParam = Astro.url.searchParams.get("tab") || "existing-banners";

// Position options
const positionOptions = [
  { value: "top", label: "Top" },
  { value: "bottom", label: "Bottom" },
];

// Expire options
const expireOptions = [
  { value: "", label: "Never" },
  { value: "3000", label: "3 seconds" },
  { value: "5000", label: "5 seconds" },
  { value: "10000", label: "10 seconds" },
  { value: "30000", label: "30 seconds" },
  { value: "60000", label: "1 minute" },
  { value: "300000", label: "5 minutes" },
];
---

<App
  title="Banner Alerts"
  description="Manage site-wide banner alerts"
  {currentUser}
  {session}
  {supabase}
  supabaseUrl={import.meta.env.PUBLIC_SUPABASE_URL}
  isBackend={true}
  {globalInputClasses}
  {primaryTextClasses}
  {secondaryTextClasses}
  {globalCompanyName}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
>
  <!-- Header -->
  <Hero
    title="Banner Alerts"
    description="Manage site-wide banner alerts that appear at the top or bottom of the page"
    {primaryTextClasses}
    {secondaryTextClasses}
  />

  <!-- Tabs: Existing Banner Alerts | New -->
  <div class="mb-6">
    <SlidingTabs
      navId="banner-alerts-tab-nav"
      navClass="border-b border-gray-200 dark:border-gray-700"
      activeItem={bannerTabParam === "new-banner" ? 1 : 0}
      urlParam="tab"
      switchHandler="switchBannerAlertsTab"
      items={[
        {
          id: "tab-existing-banners",
          label: "Existing Banner Alerts",
          variant: "tab",
          showLabel: true,
          onclick: "window.switchBannerAlertsTab('existing-banners')",
        },
        {
          id: "tab-new-banner",
          label: "New",
          variant: "tab",
          showLabel: true,
          onclick: "window.switchBannerAlertsTab('new-banner')",
        },
      ]}
    />
  </div>

  <div id="banner-alerts-tab-content">
    <!-- Tab: Existing Banner Alerts -->
    <div
      class={`rounded-lg bg-gray-100 shadow-md dark:bg-gray-800 dark:shadow-gray-700 ${bannerTabParam === "new-banner" ? "hidden" : ""}`}
      id="existing-banners"
      role="tabpanel"
      aria-labelledby="tab-existing-banners"
    >
      <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
        <h2 class="text-lg font-medium text-gray-900 dark:text-white">Existing Banner Alerts</h2>
      </div>
      <div id="banners-list" class="p-6">
        {
          bannerAlerts.length > 0 ? (
            <div class="space-y-4">
              {bannerAlerts.map((banner) => (
                <div
                  class={`rounded-lg border p-4 ${banner.isActive ? "border-green-300 bg-green-50 dark:border-green-700 dark:bg-green-900/20" : "border-gray-300 bg-gray-50 dark:border-gray-600 dark:bg-gray-700/50"}`}
                  data-banner-item={banner.id}
                >
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <span
                          class={`inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${
                            banner.type === "info"
                              ? "bg-blue-100 text-blue-800 dark:bg-blue-900/50 dark:text-blue-300"
                              : banner.type === "success"
                                ? "bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-300"
                                : banner.type === "warning"
                                  ? "bg-orange-100 text-orange-800 dark:bg-orange-900/50 dark:text-orange-300"
                                  : "bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300"
                          }`}
                        >
                          {banner.type}
                        </span>
                        <span
                          class={`inline-flex items-center rounded px-2 py-0.5 text-xs font-medium ${
                            banner.position === "top"
                              ? "bg-purple-100 text-purple-800 dark:bg-purple-900/50 dark:text-purple-300"
                              : "bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-300"
                          }`}
                        >
                          {banner.position}
                        </span>
                        {banner.expireMs && (
                          <span class="inline-flex items-center rounded bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            {banner.expireMs / 1000}s expire
                          </span>
                        )}
                        {!banner.isActive && (
                          <span class="inline-flex items-center rounded bg-gray-100 px-2 py-0.5 text-xs font-medium text-gray-800 dark:bg-gray-700 dark:text-gray-300">
                            Inactive
                          </span>
                        )}
                        {banner.targetPages && (
                          <span
                            class="inline-flex items-center rounded bg-sky-100 px-2 py-0.5 text-xs font-medium text-sky-800 dark:bg-sky-900/50 dark:text-sky-300"
                            title="Only shown on these pages"
                          >
                            Pages: {banner.targetPages}
                          </span>
                        )}
                      </div>
                      {banner.title && (
                        <h3 class="mt-2 text-xs font-medium text-gray-500 dark:text-gray-400">
                          Admin Reference: {banner.title}
                        </h3>
                      )}
                      <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">{banner.content}</p>
                      <p class="mt-2 text-xs text-gray-400 dark:text-gray-500">
                        Created: {new Date(banner.createdAt).toLocaleString()}
                      </p>
                    </div>
                    <div class="flex flex-shrink-0 gap-2">
                      <button
                        type="button"
                        class="edit-banner-btn flex items-center gap-1 rounded bg-gray-200 px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
                        data-id={banner.id}
                        data-title={banner.title || ""}
                        data-content={banner.content || ""}
                        data-type={banner.type || "info"}
                        data-position={banner.position || "top"}
                        data-expire-ms={banner.expireMs || ""}
                        data-dismissible={banner.dismissible !== false}
                        data-is-active={banner.isActive !== false}
                        data-start-date={banner.startDate || ""}
                        data-end-date={banner.endDate || ""}
                        data-target-pages={banner.targetPages || ""}
                      >
                        <i class="bx bx-edit" />
                        Edit
                      </button>
                      <button
                        type="button"
                        class="toggle-banner-btn flex items-center gap-1 rounded bg-gray-200 px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600"
                        data-id={banner.id}
                        data-active={banner.isActive}
                      >
                        <i class={`bx ${banner.isActive ? "bx-hide" : "bx-show"}`} />
                        {banner.isActive ? "Hide" : "Show"}
                      </button>
                      <DeleteConfirmButton
                        id={`delete-banner-${banner.id}`}
                        variant="icon"
                        size="sm"
                        label="Delete"
                        class="delete-banner-btn"
                      />
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <p class="text-gray-500 dark:text-gray-400">No banner alerts created yet</p>
          )
        }
      </div>
    </div>

    <!-- Tab: New -->
    <div
      class={`rounded-lg bg-gray-100 shadow-md dark:bg-gray-800 dark:shadow-gray-700 ${bannerTabParam !== "new-banner" ? "hidden" : ""}`}
      id="new-banner"
      role="tabpanel"
      aria-labelledby="tab-new-banner"
    >
      <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
        <h2 id="form-title" class="text-lg font-medium text-gray-900 dark:text-white">
          Create New Banner Alert
        </h2>
      </div>

      <form id="banner-form" class="space-y-6 p-6">
        <input type="hidden" id="banner-id" name="id" />

        <!-- Preview -->
        <div id="banner-preview" class="mb-6">
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >Preview (what users will see)</label
          >
          <div id="preview-container">
            <Alert type="info" title="" description="Banner content will appear here..." />
          </div>
        </div>

        <!-- Title -->
        <div>
          <label
            for="title"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Title (optional - for admin reference only)
          </label>
          <input
            type="text"
            id="title"
            name="title"
            class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            placeholder="Internal reference name (not shown to users)"
          />
        </div>

        <!-- Content -->
        <div>
          <label
            for="content"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Content *
          </label>
          <textarea
            id="content"
            name="content"
            rows="3"
            required
            class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            placeholder="Banner message content (shown to users)"></textarea>
        </div>

        <!-- Type, Position, Expire -->
        <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
          <div>
            <label
              for="type"
              class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300">Type</label
            >
            <select
              id="type"
              name="type"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            >
              {typeOptions.map((opt) => <option value={opt.value}>{opt.label}</option>)}
            </select>
          </div>

          <div>
            <label
              for="position"
              class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Position</label
            >
            <select
              id="position"
              name="position"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            >
              {positionOptions.map((opt) => <option value={opt.value}>{opt.label}</option>)}
            </select>
          </div>

          <div>
            <label
              for="expireMs"
              class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
              >Auto-Expire</label
            >
            <select
              id="expireMs"
              name="expireMs"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            >
              {expireOptions.map((opt) => <option value={opt.value}>{opt.label}</option>)}
            </select>
          </div>
        </div>

        <!-- Target pages (optional) -->
        <div>
          <label
            for="targetPages"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Target pages (optional)
          </label>
          <input
            type="text"
            id="targetPages"
            name="targetPages"
            class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            placeholder="Leave empty for all pages. Comma-separated slugs, e.g. cookie-preferences, privacy"
          />
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Show this alert only on these page slugs. Empty = show on every page.
          </p>
        </div>

        <!-- Dismissible and Active toggles -->
        <div class="flex flex-wrap gap-6">
          <label class="inline-flex cursor-pointer items-center">
            <input
              type="checkbox"
              id="dismissible"
              name="dismissible"
              checked
              class="peer sr-only"
            />
            <div
              class="peer relative h-6 w-11 rounded-full bg-gray-200 after:absolute after:start-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-primary-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:border-gray-600 dark:bg-gray-700 dark:peer-focus:ring-primary-800 rtl:peer-checked:after:-translate-x-full"
            >
            </div>
            <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300"
              >Dismissible</span
            >
          </label>

          <label class="inline-flex cursor-pointer items-center">
            <input type="checkbox" id="isActive" name="isActive" checked class="peer sr-only" />
            <div
              class="peer relative h-6 w-11 rounded-full bg-gray-200 after:absolute after:start-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-green-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 dark:border-gray-600 dark:bg-gray-700 dark:peer-focus:ring-green-800 rtl:peer-checked:after:-translate-x-full"
            >
            </div>
            <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">Active</span>
          </label>
        </div>

        <!-- Date Range (optional) -->
        <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
          <div>
            <label
              for="startDate"
              class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              Start Date (optional)
            </label>
            <input
              type="datetime-local"
              id="startDate"
              name="startDate"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>

          <div>
            <label
              for="endDate"
              class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >
              End Date (optional)
            </label>
            <input
              type="datetime-local"
              id="endDate"
              name="endDate"
              class="w-full rounded-md border border-gray-300 px-3 py-2 focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            />
          </div>
        </div>

        <!-- Shortcode Display -->
        <div id="shortcode-section" class="hidden">
          <label class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
            >Shortcode</label
          >
          <div class="flex items-center gap-2">
            <code
              id="shortcode-display"
              class="flex-1 rounded bg-gray-200 px-3 py-2 font-mono text-sm dark:bg-gray-700 dark:text-gray-300"
            ></code>
            <button
              type="button"
              id="copy-shortcode"
              class="rounded bg-gray-200 px-3 py-2 text-sm hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600"
            >
              <i class="bx bx-copy"></i>
            </button>
          </div>
          <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Use this shortcode in markdown content to display this banner
          </p>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-3">
          <button
            type="button"
            id="cancel-btn"
            class="hidden rounded-md border border-gray-300 px-6 py-2 text-gray-700 hover:bg-gray-50 dark:border-gray-600 dark:text-gray-300 dark:hover:bg-gray-700"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="submit-btn"
            class="rounded-md bg-primary-600 px-6 py-2 text-white hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
          >
            Create Banner
          </button>
        </div>
      </form>
    </div>
  </div>
</App>

<script is:inline>
  // Banner Alerts Admin Manager
  (function () {
    let editingId = null;

    function init() {
      console.log("ðŸ”§ [BANNER-ADMIN] Initializing...");
      bindFormEvents();
      bindListEvents();
      updatePreview();

      window.switchBannerAlertsTab = function (tab) {
        const existing = document.getElementById("existing-banners");
        const newPanel = document.getElementById("new-banner");
        if (!existing || !newPanel) return;
        if (tab === "new-banner") {
          existing.classList.add("hidden");
          newPanel.classList.remove("hidden");
        } else {
          existing.classList.remove("hidden");
          newPanel.classList.add("hidden");
        }
        const url = new URL(window.location.href);
        url.searchParams.set("tab", tab);
        window.history.replaceState({}, "", url.toString());
      };
    }

    function bindFormEvents() {
      const form = document.getElementById("banner-form");
      if (!form) return;

      form.addEventListener("submit", handleSubmit);

      // Live preview updates
      ["title", "content", "type"].forEach(function (id) {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener("input", updatePreview);
          el.addEventListener("change", updatePreview);
        }
      });

      // Cancel button
      const cancelBtn = document.getElementById("cancel-btn");
      if (cancelBtn) {
        cancelBtn.addEventListener("click", resetForm);
      }
    }

    function bindListEvents() {
      // Edit buttons - use event delegation on the container
      const bannersList = document.getElementById("banners-list");
      if (bannersList) {
        bannersList.addEventListener("click", function (e) {
          const editBtn = e.target.closest(".edit-banner-btn");
          const toggleBtn = e.target.closest(".toggle-banner-btn");
          const deleteBtn = e.target.closest(".delete-banner-btn");

          if (editBtn) {
            console.log("ðŸ”§ [BANNER-ADMIN] Edit button clicked");
            const banner = {
              id: parseInt(editBtn.dataset.id || "0"),
              title: editBtn.dataset.title || "",
              content: editBtn.dataset.content || "",
              type: editBtn.dataset.type || "info",
              position: editBtn.dataset.position || "top",
              expireMs: editBtn.dataset.expireMs ? parseInt(editBtn.dataset.expireMs) : null,
              dismissible: editBtn.dataset.dismissible === "true",
              isActive: editBtn.dataset.isActive === "true",
              startDate: editBtn.dataset.startDate || null,
              endDate: editBtn.dataset.endDate || null,
              targetPages: editBtn.dataset.targetPages || "",
            };
            console.log("ðŸ”§ [BANNER-ADMIN] Banner data:", banner);
            editBanner(banner);
          }

          if (toggleBtn) {
            const id = parseInt(toggleBtn.dataset.id || "0");
            const isActive = toggleBtn.dataset.active === "true";
            toggleBanner(id, !isActive);
          }
        });

        // Listen for delete confirmation events from DeleteConfirmButton component
        bannersList.addEventListener("deleteConfirmed", function (e) {
          const deleteBtn = e.target.closest(".delete-banner-btn");
          if (deleteBtn) {
            // Extract banner ID from button id (format: delete-banner-123)
            const buttonId = deleteBtn.id;
            const match = buttonId.match(/delete-banner-(\d+)/);
            if (match) {
              const id = parseInt(match[1], 10);
              console.log("ðŸ”§ [BANNER-ADMIN] Delete confirmed for banner:", id);
              deleteBanner(id);
            }
          }
        });
      }

      // Copy shortcode
      const copyBtn = document.getElementById("copy-shortcode");
      if (copyBtn) {
        copyBtn.addEventListener("click", function () {
          const shortcode = document.getElementById("shortcode-display");
          if (shortcode && shortcode.textContent) {
            navigator.clipboard.writeText(shortcode.textContent);
            if (window.showNotice) window.showNotice("success", "Shortcode copied!");
          }
        });
      }
    }

    function updatePreview() {
      const title = document.getElementById("title")?.value || "";
      const content = document.getElementById("content")?.value || "Banner content...";
      const type = document.getElementById("type")?.value || "info";

      const typeConfig = {
        info: {
          icon: "bx-info-circle",
          bg: "bg-primary-50 dark:bg-primary-900/20",
          border: "border-primary-200 dark:border-primary-800",
          text: "text-primary-800 dark:text-primary-400",
        },
        success: {
          icon: "bx-check-circle",
          bg: "bg-green-50 dark:bg-green-900/20",
          border: "border-green-200 dark:border-green-800",
          text: "text-green-800 dark:text-green-400",
        },
        warning: {
          icon: "bx-error",
          bg: "bg-orange-50 dark:bg-orange-900/20",
          border: "border-orange-200 dark:border-orange-800",
          text: "text-orange-800 dark:text-orange-400",
        },
        error: {
          icon: "bx-x-circle",
          bg: "bg-red-50 dark:bg-red-900/20",
          border: "border-red-200 dark:border-red-800",
          text: "text-red-800 dark:text-red-400",
        },
      };

      const config = typeConfig[type] || typeConfig.info;
      const container = document.getElementById("preview-container");

      if (container) {
        container.innerHTML =
          '<div class="rounded-lg border p-4 ' +
          config.bg +
          " " +
          config.border +
          '">' +
          '<div class="flex items-start">' +
          '<i class="bx ' +
          config.icon +
          " mr-2 mt-0.5 text-lg " +
          config.text +
          '"></i>' +
          '<div class="flex-1">' +
          '<div class="mt-1 text-sm ' +
          config.text +
          '">' +
          content +
          "</div>" +
          "</div>" +
          "</div>" +
          "</div>";
      }
    }

    function editBanner(banner) {
      console.log("ðŸ”§ [BANNER-ADMIN] editBanner called:", banner);
      editingId = banner.id;

      // Update form values
      document.getElementById("banner-id").value = banner.id;
      document.getElementById("title").value = banner.title || "";
      document.getElementById("content").value = banner.content || "";
      document.getElementById("type").value = banner.type || "info";
      document.getElementById("position").value = banner.position || "top";
      document.getElementById("expireMs").value = banner.expireMs ? banner.expireMs.toString() : "";
      document.getElementById("dismissible").checked = banner.dismissible !== false;
      document.getElementById("isActive").checked = banner.isActive !== false;
      document.getElementById("targetPages").value = banner.targetPages || "";

      // Handle dates
      if (banner.startDate) {
        document.getElementById("startDate").value = new Date(banner.startDate)
          .toISOString()
          .slice(0, 16);
      } else {
        document.getElementById("startDate").value = "";
      }
      if (banner.endDate) {
        document.getElementById("endDate").value = new Date(banner.endDate)
          .toISOString()
          .slice(0, 16);
      } else {
        document.getElementById("endDate").value = "";
      }

      // Update UI
      document.getElementById("form-title").textContent = "Edit Banner Alert";
      document.getElementById("submit-btn").textContent = "Update Banner";
      document.getElementById("cancel-btn").classList.remove("hidden");

      // Show shortcode
      const shortcodeSection = document.getElementById("shortcode-section");
      const shortcodeDisplay = document.getElementById("shortcode-display");
      if (shortcodeSection && shortcodeDisplay) {
        shortcodeSection.classList.remove("hidden");
        shortcodeDisplay.textContent = '<BannerAlert id="' + banner.id + '"/>';
      }

      updatePreview();

      // Switch to New tab so the form is visible
      if (typeof window.switchBannerAlertsTab === "function") {
        window.switchBannerAlertsTab("new-banner");
      }

      // Scroll to form
      document.getElementById("banner-form").scrollIntoView({ behavior: "smooth" });
    }

    function resetForm() {
      editingId = null;
      document.getElementById("banner-form").reset();
      document.getElementById("banner-id").value = "";
      document.getElementById("form-title").textContent = "Create New Banner Alert";
      document.getElementById("submit-btn").textContent = "Create Banner";
      document.getElementById("cancel-btn").classList.add("hidden");
      document.getElementById("shortcode-section").classList.add("hidden");
      document.getElementById("targetPages").value = "";
      updatePreview();
    }

    async function handleSubmit(e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submit-btn");
      const originalText = submitBtn?.textContent;

      try {
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = "Saving...";
        }

        const form = document.getElementById("banner-form");
        const formData = new FormData(form);
        const expireMsValue = formData.get("expireMs");

        const data = {
          id: editingId || undefined,
          title: formData.get("title") || null,
          content: formData.get("content"),
          type: formData.get("type"),
          position: formData.get("position"),
          expireMs: expireMsValue ? parseInt(expireMsValue) : null,
          dismissible: document.getElementById("dismissible").checked,
          isActive: document.getElementById("isActive").checked,
          startDate: formData.get("startDate") || null,
          endDate: formData.get("endDate") || null,
          targetPages: (function () {
            const v = formData.get("targetPages");
            return v != null ? String(v).trim() || null : null;
          })(),
        };

        const response = await fetch("/api/banner-alerts/upsert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(data),
        });

        const result = await response.json();

        if (result.success) {
          if (window.showNotice) window.showNotice("success", result.message);
          setTimeout(function () {
            window.location.reload();
          }, 1000);
        } else {
          if (window.showNotice)
            window.showNotice("error", result.error || "Failed to save banner");
        }
      } catch (error) {
        console.error("Error saving banner:", error);
        if (window.showNotice) window.showNotice("error", "Error saving banner");
      } finally {
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText || "Save";
        }
      }
    }

    async function toggleBanner(id, isActive) {
      try {
        const response = await fetch("/api/banner-alerts/upsert", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ id: id, isActive: isActive }),
        });

        const result = await response.json();

        if (result.success) {
          if (window.showNotice)
            window.showNotice("success", "Banner " + (isActive ? "activated" : "deactivated"));
          setTimeout(function () {
            window.location.reload();
          }, 1000);
        } else {
          if (window.showNotice)
            window.showNotice("error", result.error || "Failed to update banner");
        }
      } catch (error) {
        console.error("Error toggling banner:", error);
        if (window.showNotice) window.showNotice("error", "Error updating banner");
      }
    }

    async function deleteBanner(id) {
      try {
        const response = await fetch("/api/banner-alerts/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ id: id }),
        });

        const result = await response.json();

        if (result.success) {
          if (window.showNotice) window.showNotice("success", "Banner deleted");
          const item = document.querySelector('[data-banner-item="' + id + '"]');
          if (item) item.remove();
        } else {
          if (window.showNotice)
            window.showNotice("error", result.error || "Failed to delete banner");
        }
      } catch (error) {
        console.error("Error deleting banner:", error);
        if (window.showNotice) window.showNotice("error", "Error deleting banner");
      }
    }

    // Initialize
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>
