---
// Twilio Voice AI Setup Page
import { checkAuth } from "../../lib/auth";
import App from "../../components/common/App.astro";

const { currentUser, isAuth } = await checkAuth(Astro.cookies);

if (!currentUser || !isAuth || currentUser.profile.role !== "Admin") {
  return Astro.redirect("/auth/login");
}

// Check environment variables on server-side
const envVars = {
  TWILIO_ACCOUNT_SID: import.meta.env.TWILIO_ACCOUNT_SID ? "‚úÖ Set" : "‚ùå Not set",
  TWILIO_AUTH_TOKEN: import.meta.env.TWILIO_AUTH_TOKEN ? "‚úÖ Set" : "‚ùå Not set",
  TWILIO_PHONE_NUMBER: import.meta.env.TWILIO_PHONE_NUMBER ? "‚úÖ Set" : "‚ùå Not set",
  N8N_WEBHOOK_URL: import.meta.env.N8N_WEBHOOK_URL ? "‚úÖ Set" : "‚ùå Not set",
  N8N_WEBHOOK_TOKEN: import.meta.env.N8N_WEBHOOK_TOKEN ? "‚úÖ Set" : "‚ùå Not set",
  RAILWAY_PUBLIC_DOMAIN: import.meta.env.RAILWAY_PUBLIC_DOMAIN ? "‚úÖ Set" : "‚ùå Not set",
};
---

<App title="Twilio Voice AI Setup">
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="color-background shadow rounded-lg p-6">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white mb-6">
          üìû Twilio Voice AI Setup
        </h1>

        <div class="space-y-6">
          <!-- Environment Variables Check -->
          <div class="p-4 color-background rounded-lg">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
              üîß Environment Variables Check
            </h3>
            <div class="text-sm space-y-2">
              <div>
                <strong>TWILIO_ACCOUNT_SID:</strong>
                {envVars.TWILIO_ACCOUNT_SID}
              </div>
              <div>
                <strong>TWILIO_AUTH_TOKEN:</strong>
                {envVars.TWILIO_AUTH_TOKEN}
              </div>
              <div>
                <strong>TWILIO_PHONE_NUMBER:</strong>
                {envVars.TWILIO_PHONE_NUMBER}
              </div>
              <div>
                <strong>N8N_WEBHOOK_URL:</strong>
                {envVars.N8N_WEBHOOK_URL}
              </div>
              <div>
                <strong>N8N_WEBHOOK_TOKEN:</strong>
                {envVars.N8N_WEBHOOK_TOKEN}
              </div>
              <div>
                <strong>RAILWAY_PUBLIC_DOMAIN:</strong>
                {envVars.RAILWAY_PUBLIC_DOMAIN}
              </div>
            </div>
          </div>

          <!-- Setup Instructions -->
          <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
            <h3 class="text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-3">
              üìã Setup Instructions
            </h3>
            <ol class="list-decimal list-inside space-y-2 text-yellow-800 dark:text-yellow-200">
              <li>
                Go to <a
                  href="https://console.twilio.com/"
                  target="_blank"
                  class="text-yellow-600 dark:text-yellow-400 underline">Twilio Console</a
                >
              </li>
              <li>Navigate to <strong>Account ‚Üí API Keys & Tokens</strong></li>
              <li>Copy your <strong>Account SID</strong> and <strong>Auth Token</strong></li>
              <li>Go to <strong>Phone Numbers ‚Üí Manage ‚Üí Active Numbers</strong></li>
              <li>Buy a phone number or use your trial number</li>
              <li>
                Add these to Railway environment variables:
                <ul class="list-disc list-inside ml-4 mt-2">
                  <li><code>TWILIO_ACCOUNT_SID</code> = Your Account SID</li>
                  <li><code>TWILIO_AUTH_TOKEN</code> = Your Auth Token</li>
                  <li><code>TWILIO_PHONE_NUMBER</code> = Your Twilio phone number</li>
                </ul>
              </li>
              <li>
                Set up your n8n webhook URL and token:
                <ul class="list-disc list-inside ml-4 mt-2">
                  <li><code>N8N_WEBHOOK_URL</code> = Your n8n webhook URL</li>
                  <li><code>N8N_WEBHOOK_TOKEN</code> = Your n8n webhook token</li>
                </ul>
              </li>
            </ol>
          </div>

          <!-- Webhook Testing -->
          <div class="p-4 color-background rounded-lg">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-3">
              üß™ Test Webhook Endpoints
            </h3>
            <div class="space-y-3">
              <button
                id="test-incoming-webhook"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500"
              >
                üîç Test Incoming Call Webhook
              </button>
              <button
                id="test-recording-webhook"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 ml-3"
              >
                üéôÔ∏è Test Recording Webhook
              </button>
              <div id="webhook-test-results" class="mt-3"></div>
            </div>
          </div>

          <!-- Twilio Integration Info -->
          <div class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <h3 class="text-lg font-semibold text-blue-800 dark:text-blue-200 mb-3">
              üéØ Twilio Voice AI Pipeline
            </h3>
            <div class="text-sm text-blue-800 dark:text-blue-200 space-y-2">
              <p>
                <strong>Incoming Call Webhook:</strong>
                <code>{import.meta.env.RAILWAY_PUBLIC_DOMAIN}/api/webhook/twilio-incoming-call</code
                >
              </p>
              <p>
                <strong>Recording Webhook:</strong>
                <code>{import.meta.env.RAILWAY_PUBLIC_DOMAIN}/api/webhook/twilio-recording</code>
              </p>
              <p><strong>Integration:</strong> Twilio ‚Üí Webhook ‚Üí n8n ‚Üí Claude ‚Üí ElevenLabs</p>
            </div>
          </div>

          <!-- Twilio Console Setup -->
          <div class="p-4 bg-green-50 dark:bg-green-900/20 rounded-lg">
            <h3 class="text-lg font-semibold text-green-800 dark:text-green-200 mb-3">
              ‚öôÔ∏è Twilio Console Configuration
            </h3>
            <div class="text-sm text-green-800 dark:text-green-200 space-y-2">
              <p><strong>1. Configure your phone number webhook:</strong></p>
              <p>Go to Phone Numbers ‚Üí Manage ‚Üí Active Numbers ‚Üí [Your Number]</p>
              <p>
                Set <strong>Webhook URL</strong> to: <code
                  >{import.meta.env.RAILWAY_PUBLIC_DOMAIN}/api/webhook/twilio-incoming-call</code
                >
              </p>
              <p>Set <strong>HTTP Method</strong> to: <code>POST</code></p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</App>

<script>
  // Test incoming call webhook
  document.getElementById("test-incoming-webhook")?.addEventListener("click", async function () {
    const button = this as HTMLButtonElement;
    const resultDiv = document.getElementById("webhook-test-results");

    button.disabled = true;
    button.textContent = "üîÑ Testing...";

    try {
      const response = await fetch("/api/webhook/twilio-incoming-call", {
        method: "GET",
      });
      const data = await response.text();

      if (resultDiv) {
        resultDiv.innerHTML = `
          <div class="bg-green-100 dark:bg-green-900/20 border border-green-400 text-green-700 dark:text-green-300 px-4 py-3 rounded">
            <strong>‚úÖ Success:</strong> ${data}
          </div>
        `;
      }
    } catch (error) {
      if (resultDiv) {
        resultDiv.innerHTML = `
          <div class="bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded">
            <strong>‚ùå Error:</strong> ${error instanceof Error ? error.message : String(error)}
          </div>
        `;
      }
    } finally {
      button.disabled = false;
      button.textContent = "üîç Test Incoming Call Webhook";
    }
  });

  // Test recording webhook
  document.getElementById("test-recording-webhook")?.addEventListener("click", async function () {
    const button = this as HTMLButtonElement;
    const resultDiv = document.getElementById("webhook-test-results");

    button.disabled = true;
    button.textContent = "üîÑ Testing...";

    try {
      // Create form data like Twilio sends
      const formData = new FormData();
      formData.append("RecordingUrl", "https://example.com/test-recording.wav");
      formData.append("CallSid", "test-call-123");
      formData.append("RecordingDuration", "30");
      formData.append("RecordingSize", "1024");

      const response = await fetch("/api/webhook/twilio-recording", {
        method: "POST",
        body: formData,
      });
      const data = await response.json();

      if (resultDiv) {
        resultDiv.innerHTML = `
          <div class="bg-green-100 dark:bg-green-900/20 border border-green-400 text-green-700 dark:text-green-300 px-4 py-3 rounded">
            <strong>‚úÖ Success:</strong> ${JSON.stringify(data, null, 2)}
          </div>
        `;
      }
    } catch (error) {
      if (resultDiv) {
        resultDiv.innerHTML = `
          <div class="bg-red-100 dark:bg-red-900/20 border border-red-400 text-red-700 dark:text-red-300 px-4 py-3 rounded">
            <strong>‚ùå Error:</strong> ${error instanceof Error ? error.message : String(error)}
          </div>
        `;
      }
    } finally {
      button.disabled = false;
      button.textContent = "üéôÔ∏è Test Recording Webhook";
    }
  });
</script>
