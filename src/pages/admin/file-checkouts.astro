---
// Admin File Checkouts Dashboard
// Shows all file checkouts and assignments across all projects

import { checkAuth } from "@/lib/auth";
import { supabaseAdmin } from "@/lib/supabase-admin";
import App from "@/components/common/App.astro";

const { currentUser, session, supabase } = await checkAuth(Astro.props.currentUser);

// Redirect if not admin
if (currentUser?.profile?.role !== "Admin") {
  return Astro.redirect("/dashboard");
}

if (!supabaseAdmin) {
  return Astro.redirect("/dashboard");
}

// Get all file checkouts
const { data: checkouts, error } = await supabaseAdmin
  .from("files")
  .select(
    `
    *,
    project:project_id(id, title, address),
    checked_out_user:checked_out_by(id, email, raw_user_meta_data),
    assigned_user:assigned_to(id, email, raw_user_meta_data)
  `
  )
  .not("checked_out_by", "is", null)
  .order("checked_out_at", { ascending: false });

// Get all assignments
const { data: assignments, error: assignError } = await supabaseAdmin
  .from("files")
  .select(
    `
    *,
    project:project_id(id, title, address),
    assigned_user:assigned_to(id, email, raw_user_meta_data)
  `
  )
  .not("assigned_to", "is", null)
  .is("checked_out_by", null)
  .order("assigned_at", { ascending: false });

// Get checkout history
const { data: history, error: historyError } = await supabaseAdmin
  .from("file_checkout_history")
  .select(
    `
    *,
    file:file_id(id, file_path, project_id),
    user:user_id(id, email, raw_user_meta_data)
  `
  )
  .order("created_at", { ascending: false })
  .limit(50);
---

<App
  title="File Checkouts - Admin Dashboard"
  description="Manage file checkouts and assignments"
  currentUser={currentUser}
  session={session}
  supabase={supabase}
  noNavigation={false}
>
  <div class="min-h-screen bg-gray-50 dark:bg-gray-900">
    <div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">
          File Checkouts & Assignments
        </h1>
        <p class="mt-2 text-gray-600 dark:text-gray-400">
          Manage file checkouts and assignments across all projects
        </p>
      </div>

      <!-- Stats Cards -->
      <div class="mb-8 grid grid-cols-1 gap-6 md:grid-cols-3">
        <div class="rounded-lg bg-white p-6 shadow dark:bg-gray-800">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i class="bx bx-lock text-2xl text-red-500"></i>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Checked Out</h3>
              <p class="text-2xl font-bold text-red-600">
                {checkouts?.length || 0}
              </p>
            </div>
          </div>
        </div>

        <div class="rounded-lg bg-white p-6 shadow dark:bg-gray-800">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i class="bx bx-user-check text-2xl text-yellow-500"></i>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Assigned</h3>
              <p class="text-2xl font-bold text-yellow-600">
                {assignments?.length || 0}
              </p>
            </div>
          </div>
        </div>

        <div class="rounded-lg bg-white p-6 shadow dark:bg-gray-800">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <i class="bx bx-history text-2xl text-blue-500"></i>
            </div>
            <div class="ml-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">Recent Activity</h3>
              <p class="text-2xl font-bold text-blue-600">
                {history?.length || 0}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabs -->
      <div class="rounded-lg bg-white shadow dark:bg-gray-800">
        <div class="border-b border-gray-200 dark:border-gray-700">
          <nav class="-mb-px flex space-x-8 px-6" aria-label="Tabs">
            <button
              id="checkouts-tab"
              class="active whitespace-nowrap border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
            >
              Checked Out Files
            </button>
            <button
              id="assignments-tab"
              class="whitespace-nowrap border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
            >
              Assigned Files
            </button>
            <button
              id="history-tab"
              class="whitespace-nowrap border-b-2 border-transparent px-1 py-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
            >
              Activity History
            </button>
          </nav>
        </div>

        <!-- Tab Content -->
        <div class="p-6">
          <!-- Checked Out Files -->
          <div id="checkouts-content" class="tab-content">
            <h3 class="mb-4 text-lg font-medium text-gray-900 dark:text-white">
              Currently Checked Out Files
            </h3>

            {
              checkouts && checkouts.length > 0 ? (
                <div class="space-y-4">
                  {checkouts.map((file) => (
                    <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-700">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <h4 class="text-sm font-medium text-gray-900 dark:text-white">
                            {file.file_path || "Unknown file"}
                          </h4>
                          <p class="text-sm text-gray-600 dark:text-gray-400">
                            Project: {file.project?.title || file.project?.address || "Unknown"}
                          </p>
                          <p class="text-xs text-gray-500 dark:text-gray-500">
                            Checked out by:{" "}
                            {file.checked_out_user?.raw_user_meta_data?.company_name ||
                              file.checked_out_user?.email ||
                              "Unknown"}
                          </p>
                          <p class="text-xs text-gray-500 dark:text-gray-500">
                            Since: {new Date(file.checked_out_at).toLocaleString()}
                          </p>
                        </div>
                        <div class="flex items-center space-x-2">
                          <span class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-300">
                            Checked Out
                          </span>
                          {file.checkout_notes && (
                            <div class="rounded bg-gray-100 p-2 text-xs text-gray-600 dark:bg-gray-600 dark:text-gray-400">
                              <strong>Notes:</strong> {file.checkout_notes}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div class="py-8 text-center text-gray-500 dark:text-gray-400">
                  <i class="bx bx-check-circle mb-2 text-4xl" />
                  <p>No files are currently checked out</p>
                </div>
              )
            }
          </div>

          <!-- Assigned Files -->
          <div id="assignments-content" class="tab-content hidden">
            <h3 class="mb-4 text-lg font-medium text-gray-900 dark:text-white">Assigned Files</h3>

            {
              assignments && assignments.length > 0 ? (
                <div class="space-y-4">
                  {assignments.map((file) => (
                    <div class="rounded-lg bg-gray-50 p-4 dark:bg-gray-700">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <h4 class="text-sm font-medium text-gray-900 dark:text-white">
                            {file.file_path || "Unknown file"}
                          </h4>
                          <p class="text-sm text-gray-600 dark:text-gray-400">
                            Project: {file.project?.title || file.project?.address || "Unknown"}
                          </p>
                          <p class="text-xs text-gray-500 dark:text-gray-500">
                            Assigned to:{" "}
                            {file.assigned_user?.raw_user_meta_data?.company_name ||
                              file.assigned_user?.email ||
                              "Unknown"}
                          </p>
                          <p class="text-xs text-gray-500 dark:text-gray-500">
                            Since: {new Date(file.assigned_at).toLocaleString()}
                          </p>
                        </div>
                        <div class="flex items-center space-x-2">
                          <span class="inline-flex items-center rounded-full bg-yellow-100 px-2.5 py-0.5 text-xs font-medium text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">
                            Assigned
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div class="py-8 text-center text-gray-500 dark:text-gray-400">
                  <i class="bx bx-user-check mb-2 text-4xl" />
                  <p>No files are currently assigned</p>
                </div>
              )
            }
          </div>

          <!-- Activity History -->
          <div id="history-content" class="tab-content hidden">
            <h3 class="mb-4 text-lg font-medium text-gray-900 dark:text-white">Recent Activity</h3>

            {
              history && history.length > 0 ? (
                <div class="space-y-3">
                  {history.map((item) => (
                    <div class="rounded-lg bg-gray-50 p-3 dark:bg-gray-700">
                      <div class="flex items-center justify-between">
                        <div class="flex-1">
                          <p class="text-sm text-gray-900 dark:text-white">
                            <span class="font-medium">
                              {item.user?.raw_user_meta_data?.company_name ||
                                item.user?.email ||
                                "Unknown"}
                            </span>{" "}
                            <span class="text-gray-600 dark:text-gray-400">{item.action}</span>{" "}
                            <span class="font-medium">
                              {item.file?.file_path || "Unknown file"}
                            </span>
                          </p>
                          <p class="text-xs text-gray-500 dark:text-gray-500">
                            {new Date(item.created_at).toLocaleString()}
                          </p>
                          {item.notes && (
                            <p class="mt-1 text-xs text-gray-600 dark:text-gray-400">
                              <strong>Notes:</strong> {item.notes}
                            </p>
                          )}
                        </div>
                        <div class="flex items-center space-x-2">
                          <span
                            class={`inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${
                              item.action === "checkout"
                                ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"
                                : item.action === "checkin"
                                  ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300"
                                  : item.action === "assign"
                                    ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300"
                                    : "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300"
                            }`}
                          >
                            {item.action}
                          </span>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              ) : (
                <div class="py-8 text-center text-gray-500 dark:text-gray-400">
                  <i class="bx bx-history mb-2 text-4xl" />
                  <p>No activity history available</p>
                </div>
              )
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</App>

<script>
  // Tab switching functionality
  document.addEventListener("DOMContentLoaded", function () {
    const tabs = document.querySelectorAll('[id$="-tab"]');
    const contents = document.querySelectorAll(".tab-content");

    tabs.forEach((tab) => {
      tab.addEventListener("click", function (this: HTMLElement) {
        const tabId = this.id;
        const contentId = tabId.replace("-tab", "-content");

        // Remove active class from all tabs
        tabs.forEach((t) => t.classList.remove("active", "border-blue-500", "text-blue-600"));
        tabs.forEach((t) => t.classList.add("border-transparent", "text-gray-500"));

        // Hide all content
        contents.forEach((c) => c.classList.add("hidden"));

        // Show selected content
        const selectedContent = document.getElementById(contentId);
        if (selectedContent) {
          selectedContent.classList.remove("hidden");
        }

        // Add active class to selected tab
        this.classList.remove("border-transparent", "text-gray-500");
        this.classList.add("border-blue-500", "text-blue-600", "active");
      });
    });
  });
</script>
