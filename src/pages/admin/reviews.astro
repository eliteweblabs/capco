---
/**
 * Admin Review Submissions Page
 * List and manage reviews submitted via the public review form
 */
import { checkAuth } from "../../lib/auth";
import { supabaseAdmin } from "../../lib/supabase-admin";
import LayoutDefault from "../../components/layouts/LayoutDefault.astro";
import TanStackDataTable from "../../components/common/TanStackDataTable.astro";
import DeleteConfirmButton from "../../components/ui/DeleteConfirmButton.astro";
import Button from "../../components/common/Button.astro";
import SimpleIcon from "../../components/common/SimpleIcon.astro";
import { globalClasses } from "../api/global/global-classes";

const { globalCardStyle } = globalClasses();

const { currentUser } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/auth/login");
}

let reviews: any[] = [];
if (supabaseAdmin) {
  const { data, error } = await supabaseAdmin
    .from("reviewSubmissions")
    .select("*")
    .order("submittedAt", { ascending: false });
  if (!error) reviews = data || [];
}

// Preprocess for TanStack table
const tanstackReviews = reviews.map((r: any) => ({
  id: r.id,
  author: r.authorName || "—",
  rating: r.rating != null ? String(r.rating) : "—",
  reviewPreview: (r.reviewText ?? "").length > 50 ? `${String(r.reviewText).slice(0, 50)}…` : (r.reviewText || "—"),
  status: r.status || "pending",
  date: r.submittedAt ? new Date(r.submittedAt).toLocaleDateString() : "—",
}));
---

<LayoutDefault title="Review Submissions" description="Manage customer reviews from the public form">
  <div class="mx-auto max-w-6xl px-4 py-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Review Submissions</h1>
      <p class="mt-1 text-gray-600 dark:text-gray-400">
        Reviews submitted via the public form at /reviews. Approve to consider for display.
      </p>
      <a
        href="/reviews"
        target="_blank"
        rel="noopener noreferrer"
        class="mt-4 inline-flex items-center gap-2 text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400"
      >
        <SimpleIcon name="external-link" class="h-4 w-4" />
        View public review form
      </a>
    </div>

    {/* TanStack table at top — runs in tandem with table below */}
    <div class="mb-8 overflow-x-auto">
      <TanStackDataTable
        id="reviews-tanstack"
        title="Review Submissions (TanStack)"
        description="Sortable view. Use table below for approve/reject/delete."
        data={tanstackReviews}
        columns={[
          { id: "author", accessorKey: "author", header: "Author", meta: { width: 20 } },
          { id: "rating", accessorKey: "rating", header: "Rating", meta: { width: 10 } },
          { id: "reviewPreview", accessorKey: "reviewPreview", header: "Review", meta: { width: 35 } },
          { id: "status", accessorKey: "status", header: "Status", meta: { width: 12 } },
          { id: "date", accessorKey: "date", header: "Date", meta: { width: 12 } },
        ]}
        getRowIdKey="id"
        emptyMessage="No review submissions yet."
        expandable={true}
      />
    </div>

    <div class={`overflow-x-auto ${globalCardStyle} shadow`}>
      {reviews.length === 0 ? (
        <div class="p-12 text-center text-gray-500 dark:text-gray-400">
          No review submissions yet. Share the <a href="/reviews" class="text-primary-600 hover:underline">review form</a> with customers.
        </div>
      ) : (
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
          <thead class="bg-gray-50 dark:bg-gray-800">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Author
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Rating
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Review
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Status
              </th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Date
              </th>
              <th class="px-4 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
                Actions
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            {reviews.map((r) => (
              <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50">
                <td class="whitespace-nowrap px-4 py-3">
                  <div class="font-medium text-gray-900 dark:text-white">{r.authorName}</div>
                  <div class="text-sm text-gray-500 dark:text-gray-400">{r.email}</div>
                </td>
                <td class="px-4 py-3">
                  {r.rating ? (
                    <span class="inline-flex items-center gap-0.5 text-amber-500">
                      {Array.from({ length: r.rating }).map((_, i) => (
                        <SimpleIcon key={i} name="star" class="h-4 w-4 fill-current" />
                      ))}
                    </span>
                  ) : (
                    <span class="text-gray-400">—</span>
                  )}
                </td>
                <td class="max-w-xs px-4 py-3">
                  <p class="truncate text-gray-700 dark:text-gray-300" title={r.reviewText}>
                    {r.reviewText}
                  </p>
                </td>
                <td class="px-4 py-3">
                  <span
                    class:list={[
                      "inline-flex rounded-full px-2 py-0.5 text-xs font-medium",
                      r.status === "approved" && "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400",
                      r.status === "pending" && "bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400",
                      r.status === "rejected" && "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400",
                      !r.status && "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400",
                    ]}
                  >
                    {r.status || "pending"}
                  </span>
                </td>
                <td class="whitespace-nowrap px-4 py-3 text-sm text-gray-500 dark:text-gray-400">
                  {new Date(r.submittedAt).toLocaleDateString()}
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="flex items-center justify-end gap-1">
                    {r.status !== "approved" && (
                      <Button
                        variant="ghost"
                        size="sm"
                        label="Approve"
                        class="approve-review-btn"
                        dataAttributes={{ "data-id": r.id }}
                      />
                    )}
                    {r.status !== "rejected" && r.status !== "approved" && (
                      <Button
                        variant="ghost"
                        size="sm"
                        label="Reject"
                        class="reject-review-btn"
                        dataAttributes={{ "data-id": r.id }}
                      />
                    )}
                    <DeleteConfirmButton
                      id={`delete-review-${r.id}`}
                      itemType="review"
                      apiEndpoint="/api/reviews"
                      deleteMethod="DELETE"
                      deleteQueryParam="id"
                      onDeleteCallback="handleReviewDeleted"
                      tooltipText="Delete review"
                      size="sm"
                      variant="icon"
                      dataAttributes={{ id: r.id }}
                    />
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  </div>
</LayoutDefault>

<script define:vars={{ reviews }}>
  document.querySelectorAll(".approve-review-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      if (!id) return;
      try {
        const res = await fetch("/api/reviews", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: parseInt(id), status: "approved" }),
        });
        if (res.ok) window.location.reload();
      } catch (e) {
        console.error(e);
      }
    });
  });
  document.querySelectorAll(".reject-review-btn").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      if (!id) return;
      try {
        const res = await fetch("/api/reviews", {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id: parseInt(id), status: "rejected" }),
        });
        if (res.ok) window.location.reload();
      } catch (e) {
        console.error(e);
      }
    });
  });
  window.handleReviewDeleted = () => window.location.reload();
</script>
