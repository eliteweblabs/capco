---
import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);
const currentRole = currentUser?.profile?.role;

// Redirect to login if not authenticated
if (!currentUser || !session) {
  return Astro.redirect("/login");
}

// Allow all authenticated users (not just admins)
// if (currentRole !== "Admin") {
//   return Astro.redirect("/dashboard");
// }

import { globalCompanyData } from "../../pages/api/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  globalCompanyLogoDark,
  globalCompanyLogoLight,
} = globalCompanyData();

import { globalClasses } from "../../pages/api/global-classes";
const { globalInputClasses, globalPrimaryTextClasses, globalSecondaryTextClasses } =
  globalClasses();

import App from "../../components/common/App.astro";
import Hero from "../../components/common/Hero.astro";
import Discussions from "../../components/form/Discussions.astro";
import LucideIcon from "../../components/common/LucideIcon.astro";

// Fetch projects for overview stats
let projects: any[] = [];
if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    const apiUrl = `${baseUrl}/api/get-project`;
    const response = await fetch(apiUrl);

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
    }
  } catch (error) {
    console.error("Error fetching projects:", error);
  }
}
---

<App
  title="Global Discussions"
  description="Monitor all project discussions and conversations across the platform."
  {currentUser}
  project={undefined}
  {session}
  {supabase}
  {projects}
  isBackend={true}
  {globalCompanyName}
  {globalCompanySlogan}
  {globalCompanyAddress}
  {globalCompanyPhone}
  {globalCompanyEmail}
  {globalCompanyWebsite}
  {globalCompanyLogo}
  {globalCompanyLogoDark}
  {globalCompanyLogoLight}
  {globalPrimaryTextClasses}
  {globalSecondaryTextClasses}
  {globalInputClasses}
>
  <!-- Dashboard Container -->
  <Hero
    title="Global Discussions"
    description="Monitor all project discussions, client comments, and internal conversations across the platform."
    {globalPrimaryTextClasses}
    {globalSecondaryTextClasses}
    {globalInputClasses}
  />

  <!-- Overview Cards -->
  <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
    <!-- Total Projects -->
    <div class="rounded-lg bg-gray-100 p-6 shadow dark:bg-gray-800">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <LucideIcon name="building" class="h-8 w-8 text-blue-600 dark:text-blue-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Projects</p>
          <p id="total-projects" class="text-lg font-semibold text-gray-900 dark:text-white">
            {projects.length}
          </p>
        </div>
      </div>
    </div>

    <!-- Active Projects -->
    <div class="rounded-lg bg-gray-100 p-6 shadow dark:bg-gray-800">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <LucideIcon name="trending-up" class="h-8 w-8 text-green-600 dark:text-green-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Projects</p>
          <p id="active-projects" class="text-lg font-semibold text-gray-900 dark:text-white">
            {projects.filter((p) => p.status > 0 && p.status < 90).length}
          </p>
        </div>
      </div>
    </div>

    <!-- Total Discussions (24h) -->
    <div class="rounded-lg bg-gray-100 p-6 shadow dark:bg-gray-800">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <LucideIcon name="message-square" class="h-8 w-8 text-yellow-600 dark:text-yellow-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Discussions (24h)</p>
          <p
            id="recent-discussions-header"
            class="text-lg font-semibold text-gray-900 dark:text-white"
          >
            <span class="inline-block h-4 w-8 animate-pulse rounded bg-gray-200 dark:bg-gray-700"
            ></span>
          </p>
        </div>
      </div>
    </div>

    <!-- Active Users -->
    <div class="rounded-lg bg-gray-100 p-6 shadow dark:bg-gray-800">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <LucideIcon name="users" class="h-8 w-8 text-purple-600 dark:text-purple-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Users</p>
          <p id="active-users-header" class="text-lg font-semibold text-gray-900 dark:text-white">
            <span class="inline-block h-4 w-8 animate-pulse rounded bg-gray-200 dark:bg-gray-700"
            ></span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Discussions Component -->
  <div class="rounded-lg bg-gray-100 shadow-sm dark:bg-gray-800">
    <Discussions
      project={null}
      {currentUser}
      {globalInputClasses}
      {globalSecondaryTextClasses}
      {globalPrimaryTextClasses}
    />
  </div>
</App>

<script>
  // Update dynamic stats when the discussions load
  document.addEventListener("DOMContentLoaded", () => {
    // Load stats from the unified discussions API
    loadDiscussionStats();

    // Initialize the discussions system for global discussions
    if (typeof (window as any).initializeDiscussions === "function") {
      console.log("üé¨ [GLOBAL-DISCUSSIONS] Initializing global discussions system");
      (window as any).initializeDiscussions();
    } else {
      console.error("‚ùå [GLOBAL-DISCUSSIONS] initializeDiscussions function not found");
    }
  });

  async function loadDiscussionStats() {
    try {
      const response = await fetch("/api/discussions?limit=1", {
        credentials: "include",
      });

      const data = await response.json();

      if (data.success && data.stats) {
        updateStatsDisplay(data.stats);
      }
    } catch (error) {
      console.error("Error loading discussion stats:", error);
    }
  }

  function updateStatsDisplay(stats: any) {
    const headerRecentEl = document.getElementById("recent-discussions-header");
    const headerActiveUsersEl = document.getElementById("active-users-header");

    if (headerRecentEl) {
      headerRecentEl.textContent = stats.recent_24h || 0;
    }
    if (headerActiveUsersEl) {
      headerActiveUsersEl.textContent = stats.active_users_24h || 0;
    }
  }
</script>
