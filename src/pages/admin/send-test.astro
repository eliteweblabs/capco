---
import { checkAuth } from "../../lib/auth";
import { supabaseAdmin } from "../../lib/supabase-admin";
import LayoutFullWidth from "../../components/layouts/LayoutFullWidth.astro";
import Button from "../../components/common/Button.astro";
import InputLabelWrap from "../../components/common/__InputLabelWrap.astro";
import { globalClasses } from "../api/global/global-classes";

// Check authentication
const { currentUser, session, supabase } = await checkAuth(Astro.cookies);

if (!currentUser) {
  return Astro.redirect("/auth/login");
}

// Check if user is admin
const { data: profile } = await supabase
  .from("profiles")
  .select("role")
  .eq("id", currentUser.id)
  .single();

if (profile?.role !== "Admin") {
  return Astro.redirect("/dashboard");
}

// Get all users for testing
let allUsers: any[] = [];
if (supabaseAdmin) {
  const { data: users } = await supabaseAdmin
    .from("profiles")
    .select("id, firstName, lastName, email, role, smsAlerts, mobileCarrier, phone")
    .order("firstName");

  if (users) {
    allUsers = users.map((user) => {
      // Check if user has SMS setup (for display only, don't modify data)
      const hasSmsSetup = user.smsAlerts && user.mobileCarrier && user.phone;

      return {
        ...user,
        name: `${user.firstName || ""} ${user.lastName || ""}`.trim() || user.email,
        hasSmsSetup, // Add SMS indicator for display
      };
    });
  }
}
const { globalFormClasses, globalInputClasses } = globalClasses();
// Default magic-link button: use current site origin (no company-specific hardcoding)
const defaultButtonLink = `${Astro.url.origin}/dashboard`;
const defaultButtonText = "Access Your Dashboard";
const defaultEmailContent =
  "This is a test email from the Email Delivery Test system. This email is being sent to test the different delivery methods and notification types. If you received this email, the system is working correctly!";
---

<LayoutFullWidth
  title="Update Delivery Test"
  classList="p-4"
  description="Test different update delivery methods and notification types"
>
  <div class="mx-auto">
    <div class="color-background rounded-lg shadow">
      <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Update Delivery Test</h1>
        <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
          Test different update delivery methods and notification types
        </p>
      </div>

      <div class="p-6">
        <!-- Test Form -->
        <form id="email-test-form" class={globalFormClasses}>
          <!-- Method Selection (GridFilter-style toggle buttons: single-select via JS) -->
          <div>
            <InputLabelWrap id="method-input" label="Delivery Method" show={true}>
              <input type="hidden" name="method" id="method-input" value="email" />
              <div class="delivery-method-toggles mb-4 flex flex-wrap justify-start gap-2">
                <Button
                  type="button"
                  variant="selected"
                  class="delivery-method-btn toggle-button preserve font-large text-md selected"
                  dataAttributes={{ "data-method": "email" }}
                >
                  Email
                </Button>
                <Button
                  type="button"
                  variant="outline"
                  class="delivery-method-btn toggle-button preserve font-large text-md deselected"
                  dataAttributes={{ "data-method": "browser" }}
                >
                  Browser
                </Button>
                <Button
                  type="button"
                  variant="outline"
                  class="delivery-method-btn toggle-button preserve font-large text-md deselected"
                  dataAttributes={{ "data-method": "internal" }}
                >
                  Internal
                </Button>
                <Button
                  type="button"
                  variant="outline"
                  class="delivery-method-btn toggle-button preserve font-large text-md deselected"
                  dataAttributes={{ "data-method": "magicLink" }}
                >
                  Magic Link
                </Button>
                <Button
                  type="button"
                  variant="outline"
                  class="delivery-method-btn toggle-button preserve font-large text-md deselected"
                  dataAttributes={{ "data-method": "all" }}
                >
                  All
                </Button>
              </div>
            </InputLabelWrap>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              Note: SMS notifications are sent automatically to users with SMS alerts enabled
            </p>
          </div>

          <!-- Recipients -->
          <div>
            <InputLabelWrap id="recipients" label="Recipients" show={true}>
              <select
                id="recipients"
                name="recipients"
                multiple
                class={globalInputClasses}
                size="5"
              >
                {
                  allUsers.map((user) => (
                    <option value={user.email}>
                      {user.name} ({user.email}) {user.hasSmsSetup ? "üì±" : "üìß"}
                    </option>
                  ))
                }
              </select>
            </InputLabelWrap>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
              Hold Ctrl/Cmd to select multiple recipients
            </p>
          </div>

          <!-- Email Subject -->
          <div>
            <InputLabelWrap id="subject" label="Email Subject" required show={true}>
              <input
                type="text"
                id="subject"
                name="subject"
                value="Test Email - Email Delivery System"
                class={globalInputClasses}
                required
              />
            </InputLabelWrap>
          </div>

          <!-- Email Content -->
          <div>
            <InputLabelWrap id="content" label="Email Content" required show={true}>
              <textarea
                id="content"
                name="content"
                rows="4"
                class={`${globalInputClasses} resize-y`}
                required
                data-default={defaultEmailContent}></textarea>
            </InputLabelWrap>
          </div>

          <!-- Button Link (for magicLink method) -->
          <div id="button-link-section" class="hidden">
            <InputLabelWrap id="buttonLink" label="Button Link" show={true}>
              <input
                type="url"
                id="buttonLink"
                name="buttonLink"
                value={defaultButtonLink}
                class={globalInputClasses}
                placeholder={defaultButtonLink}
              />
            </InputLabelWrap>
          </div>

          <!-- Button Text (for magicLink method) -->
          <div id="button-text-section" class="hidden">
            <InputLabelWrap id="buttonText" label="Button Text" show={true}>
              <input
                type="text"
                id="buttonText"
                name="buttonText"
                value={defaultButtonText}
                class={globalInputClasses}
                placeholder={defaultButtonText}
              />
            </InputLabelWrap>
          </div>

          <!-- Submit Button -->
          <div class="flex justify-end">
            <Button type="submit" variant="primary" id="submit-btn"> Send Test Email </Button>
          </div>
        </form>

        <!-- Results Section -->
        <!-- <div id="results" class="mt-8 hidden">
          <h3 class="mb-4 text-lg font-medium text-gray-900 dark:text-white">Test Results</h3>
          <div id="results-content" class="color-background rounded-md p-4">
          </div>
        </div> -->
      </div>
    </div>
  </div>
</LayoutFullWidth>

<style>
  /* Ensure selected delivery-method button has white text (overrides outline variant) */
  .delivery-method-toggles .delivery-method-btn.selected {
    color: white !important;
  }
  .dark .delivery-method-toggles .delivery-method-btn.selected {
    color: white !important;
  }
</style>

<script define:vars={{ allUsers, defaultButtonLink, defaultButtonText }}>
  class EmailDeliveryTest {
    constructor() {
      this.init();
    }

    init() {
      const contentTa = document.getElementById("content");
      if (contentTa instanceof HTMLTextAreaElement && contentTa.dataset.default) {
        contentTa.value = contentTa.dataset.default;
      }
      this.bindEvents();
      this.setupMethodHandlers();
    }

    bindEvents() {
      const form = document.getElementById("email-test-form");
      if (form) {
        form.addEventListener("submit", (e) => this.handleSubmit(e));
      }

      // Delivery method toggles: GridFilter-style with "All" toggling the others
      const methodButtons = document.querySelectorAll(".delivery-method-btn");
      const methodInput = document.getElementById("method-input");

      function isAllFilter(val) {
        return val && String(val).toLowerCase() === "all";
      }

      function setButtonSelected(btn, selected) {
        if (selected) {
          btn.classList.remove("deselected");
          btn.classList.add("selected", "bg-primary", "dark:bg-primary-dark", "text-white");
        } else {
          btn.classList.remove("selected", "bg-primary", "dark:bg-primary-dark", "text-white");
          btn.classList.add("deselected");
        }
      }

      function syncAllButtonState() {
        const allBtn = Array.from(methodButtons).find((btn) =>
          isAllFilter(btn.getAttribute("data-method"))
        );
        if (!allBtn) return;
        const nonAllButtons = Array.from(methodButtons).filter(
          (btn) => !isAllFilter(btn.getAttribute("data-method"))
        );
        const allNonAllSelected =
          nonAllButtons.length > 0 &&
          nonAllButtons.every((btn) => btn.classList.contains("selected"));
        const allCurrentlySelected = allBtn.classList.contains("selected");
        if (allNonAllSelected && !allCurrentlySelected) {
          setButtonSelected(allBtn, true);
        } else if (!allNonAllSelected && allCurrentlySelected) {
          setButtonSelected(allBtn, false);
        }
      }

      methodButtons.forEach((button) => {
        button.addEventListener("click", () => {
          const method = button.getAttribute("data-method");
          if (!method) return;

          if (isAllFilter(method)) {
            // Toggling "All": turn all others on or off to match
            const wasSelected = button.classList.contains("selected");
            if (wasSelected) {
              // All was ON ‚Üí turn everything OFF (default to email)
              methodButtons.forEach((btn) => setButtonSelected(btn, false));
              setButtonSelected(methodButtons[0], true);
              if (methodInput && "value" in methodInput) methodInput.value = "email";
            } else {
              // All was OFF ‚Üí turn everything ON
              methodButtons.forEach((btn) => setButtonSelected(btn, true));
              if (methodInput && "value" in methodInput) methodInput.value = "all";
            }
          } else {
            // Toggling a specific method: single-select
            methodButtons.forEach((btn) => setButtonSelected(btn, false));
            setButtonSelected(button, true);
            if (methodInput && "value" in methodInput) methodInput.value = method;
            syncAllButtonState();
          }
          this.handleMethodChange();
        });
      });
    }

    setupMethodHandlers() {
      // Show/hide button link fields based on method
      this.handleMethodChange();
    }

    handleMethodChange() {
      const methodInput = document.getElementById("method-input");
      const selectedMethod = methodInput instanceof HTMLInputElement ? methodInput.value : null;
      const buttonLinkSection = document.getElementById("button-link-section");
      const buttonTextSection = document.getElementById("button-text-section");

      if (selectedMethod === "magicLink") {
        buttonLinkSection?.classList.remove("hidden");
        buttonTextSection?.classList.remove("hidden");
      } else {
        buttonLinkSection?.classList.add("hidden");
        buttonTextSection?.classList.add("hidden");
      }
    }

    async handleSubmit(e) {
      e.preventDefault();

      const submitBtn = document.getElementById("submit-btn");
      const resultsDiv = document.getElementById("results");
      const resultsContent = document.getElementById("results-content");

      if (!submitBtn || !resultsDiv || !resultsContent) return;

      try {
        // Disable button and show loading
        submitBtn.disabled = true;
        submitBtn.textContent = "Sending...";

        // Get form data
        const formData = new FormData(e.target);
        const recipients = Array.from(document.getElementById("recipients").selectedOptions);

        if (recipients.length === 0) {
          if (typeof window !== "undefined" && window.showError) {
            window.showError("Select recipients", "Please select at least one recipient.", 5000);
          }
          throw new Error("Please select at least one recipient");
        }

        const methodEl = document.getElementById("method-input");
        const selectedMethod =
          (methodEl && "value" in methodEl ? methodEl.value : null) || formData.get("method");

        // Get full user objects for selected recipients (needed for SMS logic)
        const selectedUserEmails = recipients.map((option) => option.value);
        const selectedUsers = allUsers.filter((user) => selectedUserEmails.includes(user.email));

        const requestData = {
          method: selectedMethod,
          usersToNotify: recipients.map((option) => option.value), // Keep for backward compatibility
          selectedUsers: selectedUsers, // Send full user objects for SMS logic
          emailSubject: formData.get("subject"),
          emailContent: formData.get("content"),
          buttonLink: formData.get("buttonLink") || defaultButtonLink,
          buttonText: formData.get("buttonText") || defaultButtonText,
          trackLinks: false, // Disable tracking for test emails
          project: { id: 0, title: "System", address: "Email Delivery Test" }, // System project for logging
        };

        console.log("üìß [EMAIL-TEST] Sending test email:", requestData);
        console.log("üìß [EMAIL-TEST] Project object being sent:", requestData.project);
        console.log("üìß [EMAIL-TEST] Selected users for SMS logic:", selectedUsers);
        console.log(
          "üìß [EMAIL-TEST] SMS setup check:",
          selectedUsers.map((user) => ({
            name: user.name,
            email: user.email,
            smsAlerts: user.smsAlerts,
            mobileCarrier: user.mobileCarrier,
            phone: user.phone,
            hasSmsSetup: user.smsAlerts && user.mobileCarrier && user.phone,
          }))
        );

        // Send test email
        const response = await fetch("/api/delivery/update-delivery", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(requestData),
        });

        const result = await response.json();

        // Show results
        resultsDiv.classList.remove("hidden");

        if (response.ok) {
          // API returns totalSent/totalFailed (and sentEmails/failedEmails); fallback to array lengths
          const sentCount = result.totalSent ?? result.sent ?? result.sentEmails?.length ?? 0;
          const failedCount =
            result.totalFailed ?? result.failed ?? result.failedEmails?.length ?? 0;
          if (typeof window !== "undefined" && window.showSuccess) {
            const summary =
              result.sentEmails?.length && result.sentEmails.length <= 3
                ? ` ‚Äî ${result.sentEmails.join(", ")}`
                : "";
            window.showSuccess(
              "Test email sent",
              `Sent: ${sentCount}, Failed: ${failedCount}${summary}`,
              5000
            );
          }
          const failedEmailList =
            result.failedEmails?.length &&
            result.failedEmails.map((f) => (typeof f === "string" ? f : f.email)).join(", ");
          resultsContent.innerHTML = `
            <div class="text-green-600 dark:text-green-400">
              <h4 class="font-medium">‚úÖ Test Email Sent Successfully!</h4>
              <div class="mt-2 text-sm">
                <p><strong>Method:</strong> ${requestData.method}</p>
                <p><strong>Recipients:</strong> ${recipients.length}</p>
                <p><strong>Sent:</strong> ${sentCount}</p>
                <p><strong>Failed:</strong> ${failedCount}</p>
                ${result.sentEmails?.length ? `<p><strong>Sent to:</strong> ${result.sentEmails.join(", ")}</p>` : ""}
                ${failedEmailList ? `<p><strong>Failed:</strong> ${failedEmailList}</p>` : ""}
              </div>
            </div>
          `;
        } else {
          const errMsg = result.error || "Unknown error";
          if (typeof window !== "undefined" && window.showError) {
            window.showError("Test email failed", errMsg, 6000);
          }
          resultsContent.innerHTML = `
            <div class="text-red-600 dark:text-red-400">
              <h4 class="font-medium">‚ùå Test Email Failed</h4>
              <div class="mt-2 text-sm">
                <p><strong>Error:</strong> ${errMsg}</p>
                <p><strong>Status:</strong> ${response.status}</p>
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error("üìß [EMAIL-TEST] Error:", error);
        const errMsg = error instanceof Error ? error.message : "Unknown error";
        if (typeof window !== "undefined" && window.showError) {
          window.showError("Test failed", errMsg, 6000);
        }
        resultsDiv?.classList.remove("hidden");
        resultsContent.innerHTML = `
          <div class="text-red-600 dark:text-red-400">
            <h4 class="font-medium">‚ùå Test Failed</h4>
            <div class="mt-2 text-sm">
              <p><strong>Error:</strong> ${errMsg}</p>
            </div>
          </div>
        `;
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = "Send Test Email";
      }
    }
  }

  // Initialize when DOM is loaded
  document.addEventListener("DOMContentLoaded", () => {
    new EmailDeliveryTest();
  });
</script>
