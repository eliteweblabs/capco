---
import SimpleIcon from "../common/SimpleIcon.astro";
import ProjectItem from "./ProjectItem.astro";
import Tooltip from "../common/TooltipFloating.astro";
import { getProjectListTableColumns, isColumnAllowed } from "../../lib/project-list-table-config";

interface Props {
  projects: any[];
  currentUser: any;
  statusData: any;
  globalInputClasses: string;
}

const { projects, statusData, currentUser, globalInputClasses } = Astro.props;
const currentRole = currentUser?.profile?.role;

const allColumns = await getProjectListTableColumns();
const visibleColumns = allColumns.filter((c) => isColumnAllowed(c, currentRole));

// console.log("ðŸ” [DEBUG] ProjectList statusData:", statusData);
// console.log("ðŸ” [DEBUG] ProjectList currentUser:", currentUser);
// console.log("ðŸ” [DEBUG] ProjectList currentRole:", currentRole);
// console.log("ðŸ” [DEBUG] ProjectList projects:", projects);

// Fetch staff data for staff selection
let staffOptions: any[] = [];
if (currentRole === "Admin" || currentRole === "Staff") {
  try {
    // Fetch Admin users
    const adminResponse = await fetch(`${Astro.url.origin}/api/users/get?role=Admin`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    // Fetch Staff users
    const staffResponse = await fetch(`${Astro.url.origin}/api/users/get?role=Staff`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    let allStaff: any[] = [];

    if (adminResponse.ok) {
      const adminData = await adminResponse.json();
      if (adminData.data) {
        allStaff = [...allStaff, ...adminData.data];
      }
    }

    if (staffResponse.ok) {
      const staffData = await staffResponse.json();
      if (staffData.data) {
        allStaff = [...allStaff, ...staffData.data];
      }
    }

    if (allStaff.length > 0) {
      staffOptions = [
        { value: "", label: "Unassigned" },
        ...allStaff.map((staff: any) => ({
          value: staff.id || "",
          label:
            staff.companyName ||
            `${staff.firstName || ""} ${staff.lastName || ""}`.trim() ||
            "Unknown Staff",
        })),
      ];
    } else {
      staffOptions = [{ value: "", label: "Unassigned" }];
    }
  } catch (error) {
    console.error("Failed to fetch staff data:", error);
    staffOptions = [{ value: "", label: "Unassigned" }];
  }
}

// Process each project's status in the frontmatter
const processedProjects = projects.map((project: any) => {
  const currentStatusInt = project.status || 0;
  const currentStatusObj = statusData[currentStatusInt] || {
    statusName: "Unknown Status",
    statusTab: null,
    statusSlug: null,
    statusCode: project.status,
  };
  return {
    ...project,
    currentStatusObj,
    currentStatusName: currentStatusObj?.current?.statusName,
    currentStatusTab: currentStatusObj?.current?.statusTab,
    currentStatusInt: currentStatusObj?.current?.statusCode,
    currentStatusColor: currentStatusObj?.current?.statusColor,
  };
});

// PERFORMANCE: Initial load - only render first 20 projects
const INITIAL_LOAD_COUNT = 20;
const initialProjects = processedProjects.slice(0, INITIAL_LOAD_COUNT);
const hasMoreProjects = processedProjects.length > INITIAL_LOAD_COUNT;

// Create array of 36 datetime options (9 days Ã— 4 times per day)
const createDueDateOptions = () => {
  const options = [];
  const now = new Date();
  const times = [8, 12, 16, 20]; // 8am, 12pm, 4pm, 8pm

  for (let day = 0; day < 9; day++) {
    for (const hour of times) {
      const date = new Date(now);
      date.setDate(date.getDate() + day);
      date.setHours(hour, 0, 0, 0); // Set to exact hour, 0 minutes/seconds

      const dateStr = date.toISOString();
      const displayDate = date.toLocaleDateString();
      const displayTime = date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

      let label;
      if (day === 0) {
        label = `Today at ${displayTime}`;
      } else if (day === 1) {
        label = `Tomorrow at ${displayTime}`;
      } else {
        label = `${displayDate} at ${displayTime}`;
      }

      options.push({
        value: dateStr,
        label: label,
      });
    }
  }

  return options;
};

const dueDateOptions = createDueDateOptions();
---

<!-- Project List: JSON-driven columns (config per client) -->
<table id="project-list" class="w-full min-w-max table-fixed text-sm dark:text-gray-400">
  <thead class="text-uppercase color-background bg-gray-200 text-xs">
    <tr>
      {
        visibleColumns.map((col) => (
          <th
            scope="col"
            data-col-id={col.id}
            class={`px-4 py-3 font-semibold ${col.type === "edit" || col.type === "delete" ? "" : "text-center"}`}
          >
            {col.tooltip ? (
              <Tooltip text={col.tooltip} open={false}>
                {col.icon === "checklist" ? (
                  <svg
                    class="h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400"
                    aria-hidden="true"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    fill="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      d="M3 6C3 4.89688 3.89688 4 5 4H13C14.1031 4 15 4.89688 15 6V10.2063C12.6906 10.8594 11 12.9812 11 15.5C11 17.3469 11.9094 18.9781 13.3031 19.9781C13.2031 19.9937 13.1031 20 13 20H5C3.89688 20 3 19.1031 3 18V6ZM5 8.5C5 8.775 5.225 9 5.5 9H12.5C12.775 9 13 8.775 13 8.5C13 8.225 12.775 8 12.5 8H5.5C5.225 8 5 8.225 5 8.5ZM5.5 11C5.225 11 5 11.225 5 11.5C5 11.775 5.225 12 5.5 12H10.5C10.775 12 11 11.775 11 11.5C11 11.225 10.775 11 10.5 11H5.5ZM5.5 14C5.225 14 5 14.225 5 14.5C5 14.775 5.225 15 5.5 15H8.5C8.775 15 9 14.775 9 14.5C9 14.225 8.775 14 8.5 14H5.5ZM12 15.5C12 14.3065 12.4741 13.1619 13.318 12.318C14.1619 11.4741 15.3065 11 16.5 11C17.6935 11 18.8381 11.4741 19.682 12.318C20.5259 13.1619 21 14.3065 21 15.5C21 16.6935 20.5259 17.8381 19.682 18.682C18.8381 19.5259 17.6935 20 16.5 20C15.3065 20 14.1619 19.5259 13.318 18.682C12.4741 17.8381 12 16.6935 12 15.5ZM17.8969 14.1469L16 16.0437L15.1031 15.1469C14.9094 14.9531 14.5906 14.9531 14.3969 15.1469C14.2031 15.3406 14.2031 15.6594 14.3969 15.8531L15.6469 17.1031C15.8406 17.2969 16.1594 17.2969 16.3531 17.1031L18.6031 14.8531C18.7969 14.6594 18.7969 14.3406 18.6031 14.1469C18.4094 13.9531 18.0906 13.9531 17.8969 14.1469Z"
                      fill="currentColor"
                    />
                  </svg>
                ) : (
                  <SimpleIcon
                    name={col.icon || "edit"}
                    size={col.type === "featured" || col.type === "assigned" ? "lg" : "xs"}
                    class={col.type === "delete" ? "text-red-500" : "text-gray-600"}
                  />
                )}
              </Tooltip>
            ) : col.icon ? (
              <SimpleIcon
                name={col.icon}
                size="xs"
                class={col.type === "delete" ? "text-red-500" : "text-gray-600"}
              />
            ) : (
              col.label
            )}
          </th>
        ))
      }
    </tr>
  </thead>
  <tbody id="project-list-tbody">
    {
      projects.length > 0 &&
        processedProjects.map((project: any, index: number) => {
          // Hide projects beyond initial load count
          const isHidden = index >= INITIAL_LOAD_COUNT;
          return (
            <ProjectItem
              columns={visibleColumns}
              currentUser={currentUser}
              project={project}
              statusData={statusData}
              currentStatusName={project.currentStatusName}
              currentStatusInt={project.currentStatusInt}
              currentStatusTab={project.currentStatusTab}
              currentStatusColor={project.currentStatusColor}
              staffOptions={staffOptions}
              dueDateOptions={dueDateOptions}
              globalInputClasses={globalInputClasses}
              isHidden={isHidden}
            />
          );
        })
    }
  </tbody>

  <tfoot>
    <!-- Start coding here -->
    <tr>
      <td colspan="100%">
        <div class="relative overflow-hidden rounded-b-lg bg-white shadow-md dark:bg-gray-800">
          <nav
            class="flex flex-col items-start justify-between space-y-3 p-4 md:flex-row md:items-center md:space-y-0"
            aria-label="Table navigation"
          >
            <span class="text-sm font-normal text-gray-500 dark:text-gray-400"
              >Showing <span class="font-semibold text-gray-900 dark:text-white">1-10</span> of <span
                class="font-semibold text-gray-900 dark:text-white">1000</span
              ></span
            >
            <ul class="inline-flex items-stretch -space-x-px">
              <li>
                <a
                  href="#"
                  class="ml-0 flex h-full items-center justify-center rounded-l-lg border border-gray-300 bg-white px-3 py-1.5 text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                >
                  <span class="sr-only">Previous</span>
                  <svg
                    class="h-5 w-5"
                    aria-hidden="true"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </a>
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center justify-center border border-gray-300 bg-white px-3 py-2 text-sm leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                  >1</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center justify-center border border-gray-300 bg-white px-3 py-2 text-sm leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                  >2</a
                >
              </li>
              <li>
                <a
                  href="#"
                  aria-current="page"
                  class="z-10 flex items-center justify-center border border-primary-300 bg-primary-50 px-3 py-2 text-sm leading-tight text-primary-600 hover:bg-primary-100 hover:text-primary-700 dark:border-gray-700 dark:bg-gray-700 dark:text-white"
                  >3</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center justify-center border border-gray-300 bg-white px-3 py-2 text-sm leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                  >...</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="flex items-center justify-center border border-gray-300 bg-white px-3 py-2 text-sm leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                  >100</a
                >
              </li>
              <li>
                <a
                  href="#"
                  class="flex h-full items-center justify-center rounded-r-lg border border-gray-300 bg-white px-3 py-1.5 leading-tight text-gray-500 hover:bg-gray-100 hover:text-gray-700 dark:border-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
                >
                  <span class="sr-only">Next</span>
                  <svg
                    class="h-5 w-5"
                    aria-hidden="true"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                      clip-rule="evenodd"></path>
                  </svg>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </td>
    </tr>
  </tfoot>

  {
    hasMoreProjects && (
      <div class="mt-4 text-center">
        <button
          id="load-more-projects"
          class="rounded-lg bg-primary-600 px-5 py-2.5 text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800"
          data-total={processedProjects.length}
          data-initial={INITIAL_LOAD_COUNT}
        >
          Load More Projects ({processedProjects.length - INITIAL_LOAD_COUNT} remaining)
        </button>
      </div>
    )
  }

  <script>
    import "../../scripts/project-list-resizable-columns";
  </script>
  <script>
    // Client-side progressive reveal of hidden rows
    const loadMoreButton = document.getElementById("load-more-projects");
    const tbody = document.getElementById("project-list-tbody");

    if (loadMoreButton && tbody) {
      const BATCH_SIZE = 20;
      let currentShown = parseInt(loadMoreButton.getAttribute("data-initial") || "20");
      const total = parseInt(loadMoreButton.getAttribute("data-total") || "0");

      loadMoreButton.addEventListener("click", () => {
        // Show next batch of hidden rows
        const allRows = tbody.querySelectorAll("tr[data-hidden='true']");
        const batch = Array.from(allRows).slice(0, BATCH_SIZE);

        batch.forEach((row) => {
          row.removeAttribute("data-hidden");
          row.style.display = "";
        });

        currentShown += batch.length;

        // Update button or remove if all shown
        if (currentShown >= total) {
          loadMoreButton.remove();
        } else {
          const remaining = total - currentShown;
          loadMoreButton.textContent = `Load More Projects (${remaining} remaining)`;
        }

        // Re-run global functions for newly visible rows
        if (window.renderFileIcons) {
          window.renderFileIcons();
        }
      });
    }
  </script>
</table>
