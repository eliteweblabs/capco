---
import BoxIcon from "../common/BoxIcon.astro";
import ProjectItem from "./ProjectItem.astro";

interface Props {
  projects: any[];
  currentUser: any;
  statusData: any;
}

// // const { currentLocale } = Astro;
// // const i18n = getI18N({ currentLocale });
const { projects, statusData, currentUser } = Astro.props;
const currentRole = currentUser?.profile?.role;

// console.log("üîç [DEBUG] ProjectList statusData:", statusData);
// console.log("üîç [DEBUG] ProjectList currentUser:", currentUser);
// console.log("üîç [DEBUG] ProjectList currentRole:", currentRole);
// console.log("üîç [DEBUG] ProjectList projects:", projects);

// Fetch staff data for staff selection
let staffOptions: any[] = [];
if (currentRole === "Admin" || currentRole === "Staff") {
  try {
    const staffResponse = await fetch(`${Astro.url.origin}/api/get-user-emails-by-role`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        roles: ["Admin", "Staff"],
      }),
    });
    if (staffResponse.ok) {
      const staffData = await staffResponse.json();
      if (staffData.success && staffData.staffUsers) {
        staffOptions = [
          { value: "", label: "Unassigned" },
          ...staffData.staffUsers.map((staff: any) => ({
            value: staff.id || "",
            label:
              staff.company_name ||
              `${staff.first_name || ""} ${staff.last_name || ""}`.trim() ||
              "Unknown Staff",
          })),
        ];
      }
    }
  } catch (error) {
    console.error("Failed to fetch staff data:", error);
    staffOptions = [{ value: "", label: "Unassigned" }];
  }
}

// Process each project's status in the frontmatter
const processedProjects = projects.map((project: any) => {
  const currentStatusInt = project.status || 0;
  const currentStatusObj = statusData[currentStatusInt] || {
    status_name: "Unknown Status",
    status_tab: null,
    status_slug: null,
    status_code: project.status,
  };
  return {
    ...project,
    currentStatusObj,
    currentStatusName: currentStatusObj?.current?.status_name,
    currentStatusSlug: currentStatusObj?.current?.status_slug,
    currentStatusTab: currentStatusObj?.current?.status_tab,
    currentStatusInt: currentStatusObj?.current?.status_code,
    currentStatusColor: currentStatusObj?.current?.status_color,
  };
});

// Create array of 36 datetime options (9 days √ó 4 times per day)
const createDueDateOptions = () => {
  const options = [];
  const now = new Date();
  const times = [8, 12, 16, 20]; // 8am, 12pm, 4pm, 8pm

  for (let day = 0; day < 9; day++) {
    for (const hour of times) {
      const date = new Date(now);
      date.setDate(date.getDate() + day);
      date.setHours(hour, 0, 0, 0); // Set to exact hour, 0 minutes/seconds

      const dateStr = date.toISOString();
      const displayDate = date.toLocaleDateString();
      const displayTime = date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

      let label;
      if (day === 0) {
        label = `Today at ${displayTime}`;
      } else if (day === 1) {
        label = `Tomorrow at ${displayTime}`;
      } else {
        label = `${displayDate} at ${displayTime}`;
      }

      options.push({
        value: dateStr,
        label: label,
      });
    }
  }

  return options;
};

const dueDateOptions = createDueDateOptions();
---

<div class="ahOqFrhzLjivRe8a1kX_ EWLTGduHCjFnjN6tLCXV">
  <!-- Project List-->
  <table
    id="project-list"
    class="t6gkcSf0Bt4MLItXvDJ_ upQp7iWehfaU8VTbfx_w c8dCx6gnV43hTOLV6ks5 PeR2JZ9BZHYIH8Ea3F36 XIIs8ZOri3wm8Wnj9N_y"
  >
    <thead
      class="jtAJHOc7mn7b4IKRO59D gMXmdpOPfqG_3CKkL0VD sdSaZcRa4_We5kKaX4pf PeR2JZ9BZHYIH8Ea3F36 _1jTZ8KXRZul60S6czNi XIIs8ZOri3wm8Wnj9N_y"
    >
      <tr>
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Name</th
        >

        {
          currentRole !== "Client" && (
            <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz">
              Company
            </th>
          )
        }

        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Status</th
        >
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Files</th
        >

        {
          currentRole !== "Client" && (
            <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz">
              Assigned To
            </th>
          )
        }

        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Progress</th
        >
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Checklist</th
        >
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          ><span class="button-text">Elapsed Time</span><BoxIcon name="time" size="xs" class="" />
        </th>
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Updated</th
        >
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz"
          >Due Date</th
        >
        <th scope="col" class="RZmKBZs1E1eXw8vkE6jY i8v96MUlFwGv9qJUkAx7 yM_AorRf2jSON3pDsdrz">
          <span class="_DVAfiyo21kM68EUVzEQ">Actions</span>
        </th>
      </tr>
    </thead>
    <tbody>
      {
        projects.length > 0 &&
          processedProjects.map((project: any) => {
            // console.log("üîç [DEBUG] ProjectList passing project to ProjectListItem:", {
            //   id: project.id,
            //   title: project.title,
            //   featured_image: project.featured_image,
            //   featured_image_data: project.featured_image_data,
            // });
            return (
              <ProjectItem
                currentUser={currentUser}
                project={project}
                statusData={statusData}
                currentStatusName={project.currentStatusName}
                currentStatusInt={project.currentStatusInt}
                currentStatusSlug={project.currentStatusSlug}
                currentStatusTab={project.currentStatusTab}
                currentStatusColor={project.currentStatusColor}
                staffOptions={staffOptions}
                dueDateOptions={dueDateOptions}
              />
            );
          })
      }
    </tbody>
  </table>
</div>
