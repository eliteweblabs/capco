---
import SearchInput from "../common/SearchInput.astro";

const { class: className, id = "project-search" } = Astro.props;
const inputClasses =
  "rounded-full border border-gray-300 bg-gray-100 py-2.5 pl-6 text-left text-sm text-gray-500 transition-colors hover:border-gray-400 hover:bg-gray-50 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-400 dark:hover:border-gray-500 dark:hover:bg-gray-600";
---

<SearchInput
  id={id}
  placeholder="Search active projects... OLD, Overdue, 30"
  globalInputClasses={inputClasses}
  wrapperClass={`hidden w-full max-w-xl ${className || ""}`.trim()}
>
  <div
    slot="suggestions"
    id={`${id}-suggestions`}
    class="color-background absolute left-0 right-0 top-full z-50 hidden max-h-60 overflow-y-auto rounded-lg border border-gray-300 bg-gray-100 shadow-lg dark:border-gray-600"
  >
    <!-- Suggestions will be populated by JavaScript -->
  </div>
</SearchInput>
<script is:inline define:vars={{ id }}>
  // Project search functionality
  function filterProjectsBySearch(searchTerm) {
    const projectList = document.getElementById("project-list");
    if (!projectList) {
      console.log("Project list not found");
      return;
    }

    const projects = projectList.querySelectorAll("[data-project-id]");
    console.log("ðŸ” Search: Found", projects.length, "projects for term:", searchTerm);
    let visibleCount = 0;

    projects.forEach((project) => {
      const searchableElements = project.querySelectorAll("[data-searchable]");
      const searchableText = Array.from(searchableElements)
        .map((el) => el.textContent || "")
        .join(" ")
        .toLowerCase();

      const matches = searchableText.includes(searchTerm.toLowerCase());

      if (matches) {
        project.classList.remove("hidden");
        project.style.display = "block";
        project.style.opacity = "1";
        visibleCount++;
      } else {
        project.classList.add("hidden");
        project.style.display = "none";
        project.style.opacity = "0";
      }
    });

    console.log(`Filtered projects: ${visibleCount} visible out of ${projects.length} total`);

    setTimeout(() => {
      if (searchTerm.length > 0) {
        if (window.updateCountBubblesForSearch) {
          console.log("ðŸ”¢ Updating search count bubbles...");
          window.updateCountBubblesForSearch();
        } else {
          console.log("âŒ updateCountBubblesForSearch function not available");
        }
      } else {
        if (window.restoreOriginalCountBubbles) {
          console.log("ðŸ”„ Restoring original count bubbles...");
          window.restoreOriginalCountBubbles();
        } else {
          console.log("âŒ restoreOriginalCountBubbles function not available");
        }
      }
    }, 10);
  }

  function clearProjectSearch() {
    const searchInput = document.getElementById(id);
    if (searchInput) {
      searchInput.value = "";
      filterProjectsBySearch("");
      hideSuggestions();

      if (window.restoreOriginalCountBubbles) {
        window.restoreOriginalCountBubbles();
      }
    }
  }

  let allSuggestions = [];

  function buildSuggestionsList() {
    const projectList = document.getElementById("project-list");
    if (!projectList) return;

    const projects = projectList.querySelectorAll("[data-project-id]");
    const suggestions = new Set();

    projects.forEach((project) => {
      const searchableElements = project.querySelectorAll("[data-searchable]");
      searchableElements.forEach((element) => {
        const text = element.textContent?.trim();
        if (text && text.length > 2) {
          suggestions.add(text);
        }
      });
    });

    allSuggestions = Array.from(suggestions).sort();
    console.log("ðŸ” Built suggestions list:", allSuggestions.length, "items");
  }

  function showSuggestions(searchTerm) {
    const suggestionsDiv = document.getElementById(`${id}-suggestions`);
    if (!suggestionsDiv || !searchTerm) {
      hideSuggestions();
      return;
    }

    const filteredSuggestions = allSuggestions
      .filter(
        (suggestion) =>
          suggestion.toLowerCase().includes(searchTerm.toLowerCase()) &&
          suggestion.toLowerCase() !== searchTerm.toLowerCase()
      )
      .slice(0, 8);

    if (filteredSuggestions.length === 0) {
      hideSuggestions();
      return;
    }

    suggestionsDiv.innerHTML = filteredSuggestions
      .map(
        (suggestion) => `
        <div class="cursor-pointer px-3 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-gray-200 suggestion-item" 
             data-suggestion="${suggestion.replace(/"/g, "&quot;")}">
          ${highlightMatch(suggestion, searchTerm)}
        </div>
      `
      )
      .join("");

    suggestionsDiv.classList.remove("hidden");

    suggestionsDiv.querySelectorAll(".suggestion-item").forEach((item) => {
      item.addEventListener("click", () => {
        const suggestion = item.getAttribute("data-suggestion");
        const searchInput = document.getElementById(id);
        if (searchInput) {
          searchInput.value = suggestion;
          filterProjectsBySearch(suggestion);
          hideSuggestions();
        }
      });
    });
  }

  function hideSuggestions() {
    const suggestionsDiv = document.getElementById(`${id}-suggestions`);
    if (suggestionsDiv) {
      suggestionsDiv.classList.add("hidden");
    }
  }

  function highlightMatch(text, searchTerm) {
    if (!searchTerm) return text;
    const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`, "gi");
    return text.replace(regex, '<strong class="font-semibold">$1</strong>');
  }

  function initProjectSearch() {
    const searchInput = document.getElementById(id);
    const clearBtn = document.getElementById(`${id}-clear-btn`);

    if (searchInput) {
      searchInput.addEventListener("input", function () {
        const searchTerm = this.value;
        filterProjectsBySearch(searchTerm);

        if (searchTerm.length > 0) {
          showSuggestions(searchTerm);
        } else {
          hideSuggestions();
        }
      });

      searchInput.addEventListener("blur", function () {
        setTimeout(() => hideSuggestions(), 150);
      });

      searchInput.addEventListener("keydown", function (e) {
        const suggestionsDiv = document.getElementById(`${id}-suggestions`);
        if (!suggestionsDiv || suggestionsDiv.classList.contains("hidden")) return;

        const suggestions = suggestionsDiv.querySelectorAll(".suggestion-item");
        const currentActive = suggestionsDiv.querySelector(".suggestion-item.bg-gray-100");
        let activeIndex = -1;

        if (currentActive) {
          activeIndex = Array.from(suggestions).indexOf(currentActive);
        }

        if (e.key === "ArrowDown") {
          e.preventDefault();
          activeIndex = Math.min(activeIndex + 1, suggestions.length - 1);
        } else if (e.key === "ArrowUp") {
          e.preventDefault();
          activeIndex = Math.max(activeIndex - 1, -1);
        } else if (e.key === "Enter" && activeIndex >= 0) {
          e.preventDefault();
          const activeSuggestion = suggestions[activeIndex];
          if (activeSuggestion) {
            const suggestion = activeSuggestion.getAttribute("data-suggestion");
            this.value = suggestion;
            filterProjectsBySearch(suggestion);
            hideSuggestions();
          }
          return;
        } else if (e.key === "Escape") {
          hideSuggestions();
          return;
        }

        suggestions.forEach((item, index) => {
          if (index === activeIndex) {
            item.classList.add("bg-gray-100", "dark:bg-gray-700");
          } else {
            item.classList.remove("bg-gray-100", "dark:bg-gray-700");
          }
        });
      });
    }

    if (clearBtn) {
      clearBtn.addEventListener("click", clearProjectSearch);
    }

    setTimeout(() => {
      const projectList = document.getElementById("project-list");
      console.log("ðŸ” Initial check: Found", projectList ? projectList.querySelectorAll("[data-project-id]").length : 0, "projects in list");

      buildSuggestionsList();

      if (projectList) {
        const observer = new MutationObserver(() => {
          setTimeout(() => buildSuggestionsList(), 100);
        });

        observer.observe(projectList, {
          childList: true,
          subtree: true,
          characterData: true,
        });
      }
    }, 500);
  }

  document.addEventListener("DOMContentLoaded", initProjectSearch);
  document.addEventListener("astro:page-load", initProjectSearch);

  window.filterProjectsBySearch = filterProjectsBySearch;
  window.clearProjectSearch = clearProjectSearch;
</script>
