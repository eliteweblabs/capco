---
import Alert from "../partials/Alert.astro";
import ProposalManager from "./ProposalManager.astro";
import EnhancedProposalManager from "./EnhancedProposalManager.astro";

interface Props {
  project: any;
  projectStatus?: number;
  currentUser?: any;
  globalInputClasses?: string;
  secondaryTextClasses?: string;
  primaryTextClasses?: string;
  statusData?: any;
  existingInvoice?: any;
  invoiceId?: any;
}

const {
  project,
  projectStatus = 0,
  currentUser,
  globalInputClasses,
  secondaryTextClasses,
  primaryTextClasses,
  statusData,
} = Astro.props;

const currentRole = currentUser?.profile?.role;
const projectId = project?.id;
const clientName = project?.authorProfile?.companyName;

// Upsert invoice from API (single source of truth) during SSR
let existingInvoice: any = null;
let invoiceId: any = null;

console.log("üîç [TAB-PROPOSAL SSR] Starting SSR for projectId:", projectId);
console.log("üîç [TAB-PROPOSAL SSR] projectStatus:", projectStatus);
console.log("üîç [TAB-PROPOSAL SSR] currentUser role:", currentUser?.profile?.role);

try {
  const baseUrl = Astro.url.origin;
  console.log("üîç [TAB-PROPOSAL SSR] Making upsert request to:", `${baseUrl}/api/proposal/upsert`);
  console.log("üîç [TAB-PROPOSAL SSR] Request body:", { projectId: projectId });
  
  const response = await fetch(`${baseUrl}/api/proposal/upsert`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Cookie: Astro.request.headers.get("cookie") || "",
    },
    body: JSON.stringify({
      projectId: projectId,
    }),
  });

  console.log("üîç [TAB-PROPOSAL SSR] Response status:", response.status);
  console.log("üîç [TAB-PROPOSAL SSR] Response ok:", response.ok);

  const data = await response.json();
  console.log("üîç [TAB-PROPOSAL SSR] Response data:", data);

  if (data.success && data.invoice) {
    existingInvoice = data.invoice;
    invoiceId = data.invoice.id;
    console.log("‚úÖ [TAB-PROPOSAL SSR] Successfully upserted invoice:", invoiceId);
    console.log("üîç [TAB-PROPOSAL SSR] Invoice data:", existingInvoice);
    console.log("üîç [TAB-PROPOSAL SSR] Invoice catalogLineItems:", existingInvoice?.catalogLineItems);
    console.log("üîç [TAB-PROPOSAL SSR] Invoice catalogLineItems length:", existingInvoice?.catalogLineItems?.length);
  } else {
    console.error("‚ùå [TAB-PROPOSAL SSR] Failed to upsert invoice:", data.error);
    console.error("‚ùå [TAB-PROPOSAL SSR] Full response data:", data);
  }
} catch (error) {
  console.error("‚ùå [TAB-PROPOSAL SSR] Error upserting invoice via API:", error);
}

console.log("üîç [TAB-PROPOSAL SSR] Final existingInvoice:", existingInvoice);
console.log("üîç [TAB-PROPOSAL SSR] Final invoiceId:", invoiceId);

function getStatusAlert() {
  // Client status messages
  if (currentRole === "Client") {
    if (Number(projectStatus) < 20) {
      return `Submit your project documents first <a href='/project/${projectId}?status=documents'>here</a>.`;
    }
    if (Number(projectStatus) >= 20 && Number(projectStatus) < 30) {
      return "Proposal is being generated. You will be notified when it is ready.";
    }
    if (Number(projectStatus) >= 30 && Number(projectStatus) < 50 && invoiceId) {
      return "Please review your proposal & submit a 50% deposit to approve this proposal and begin work.";
    }
    if (Number(projectStatus) >= 40 && Number(projectStatus) < 50 && invoiceId) {
      return "Please sign contact for work to begin.";
    }
    if (Number(projectStatus) >= 50 && Number(projectStatus) < 60) {
      return "Please pay your deposit.";
    }
  }

  // Admin status messages
  if (currentRole === "Admin" || currentRole === "Staff") {
    if (Number(projectStatus) < 20) {
      return `<b>${clientName}</b> has not submit any documents. Press the "Finished" button to unlock proposal or wait for the client to submit their documents.`;
    }
    if (Number(projectStatus) >= 20 && Number(projectStatus) < 30) {
      return `Please build proposal for <b>${clientName}</b> and review the contract.`;
    }
    if (Number(projectStatus) >= 30 && Number(projectStatus) < 40) {
      return `Proposal has been sent but <b>${clientName}</b> has not viewed it, you can make changes to it and resend.`;
    }
    if (Number(projectStatus) >= 40 && Number(projectStatus) < 50) {
      return `<b>${clientName}</b> has viewed the proposal, you can make changes to it and resend.`;
    }
    if (Number(projectStatus) >= 50 && Number(projectStatus) < 60) {
      return "Contract has been signed off, no changes can be made.";
    }
  }

  return null;
}
const statusAlert = getStatusAlert();
---

<div
  id="content-proposal"
  class="tab-content p-4 color-background relative min-h-[calc(100dvh-24rem)]"
>
  {statusAlert && <Alert type="info" title={statusAlert} />}

  {
    currentRole === "Client" ? (
      <ProposalManager
        projectId={projectId}
        project={project}
        projectStatus={projectStatus}
        currentUser={currentUser}
        globalInputClasses={globalInputClasses || ""}
        secondaryTextClasses={secondaryTextClasses || ""}
        primaryTextClasses={primaryTextClasses || ""}
        statusData={statusData}
        existingInvoice={existingInvoice}
        invoiceId={invoiceId}
      />
    ) : (
      <ProposalManager
        projectId={projectId}
        project={project}
        projectStatus={projectStatus}
        currentUser={currentUser}
        globalInputClasses={globalInputClasses || ""}
        secondaryTextClasses={secondaryTextClasses || ""}
        primaryTextClasses={primaryTextClasses || ""}
        statusData={statusData}
        existingInvoice={existingInvoice}
        invoiceId={invoiceId}
      />
    )
  }
</div>
