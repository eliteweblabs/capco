---
// File Manager Component with Checkout System - EXTENSIVE DEBUGGING
// A complete file management solution with checkout/assignment capabilities

interface Props {
  projectId: number;
  currentUser: any;
  currentRole: string;
  projectAuthorId?: string;
  projectStatus?: number;
  globalSecondaryTextClasses?: string;
  globalPrimaryTextClasses?: string;
  globalInputClasses?: string;
  statusData?: any;
}

const {
  projectId,
  currentUser,
  currentRole,
  projectAuthorId,
  projectStatus = 0,
  globalSecondaryTextClasses,
  globalPrimaryTextClasses,
  globalInputClasses,
  statusData,
} = Astro.props;

// Debug logging for props

import BoxIcon from "../common/BoxIcon.astro";
import Button from "../common/Button.astro";

// Only show for Admin/Staff
const showManagement = currentRole === "Admin" || currentRole === "Staff";

// Project status-based restrictions
const canCheckoutFiles =
  (projectStatus >= 20 && currentRole === "Admin") || currentRole === "Staff";
const canUploadFiles = projectStatus >= 10;
const canDeleteFiles = currentRole === "Admin"; // Only admins can delete regardless of status
---

<div id="file-manager" class="space-y-6">
  <!-- Header -->
  <div class="flex items-center justify-between">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Project Files</h3>
    <div class="text-sm text-gray-500 dark:text-gray-400">
      <span id="file-count">Loading...</span>
    </div>
  </div>

  <!-- Upload Section (Clients only, status <= 40) -->
  {
    (currentRole === "Client" && projectStatus < 41) ||
    currentRole === "Admin" ||
    currentRole === "Staff" ? (
      <div>
        <div
          id="upload-dropzone"
          class="cursor-pointer rounded-lg border-2 border-dashed border-gray-300 p-6 text-center transition-colors hover:border-blue-400 dark:border-gray-600 dark:hover:border-blue-500"
        >
          <div class="space-y-4">
            <div class="mx-auto h-12 w-12 text-gray-400">
              <svg class="h-full w-full" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                />
              </svg>
            </div>
            <div>
              <p class="font-medium text-gray-600 dark:text-gray-300">
                Drop files here or click to browse
              </p>
              <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
                Upload supports PDF, images, CAD files, and documents (max 10MB each)
              </p>
            </div>
            <Button id="browse-files-btn" icon="folder-open" iconPosition="left" variant="outline">
              Browse Files
            </Button>
            {projectStatus >= 20 && (
              <>
                <BoxIcon name="alert-circle" class="bx-lg mx-auto" />
                <h2 class={`${globalPrimaryTextClasses} mb-4`}>
                  Keep File Names the Same to Generate A New Version and Check In Your File
                </h2>
              </>
            )}
          </div>
        </div>
        <input
          type="file"
          id="file-input"
          multiple
          accept=".pdf,.png,.jpg,.jpeg,.gif,.webp,.dwg,.doc,.docx,.xls,.xlsx,.txt"
          class="hidden"
        />
      </div>
    ) : null
  }

  <!-- Upload Progress -->
  <div id="upload-progress" class="hidden">
    <div class="h-2 rounded-lg bg-gray-200 dark:bg-gray-700">
      <div
        id="progress-bar"
        class="h-2 rounded-lg bg-blue-600 transition-all duration-300"
        style="width: 0%"
      >
      </div>
    </div>
    <p id="upload-status" class="mt-2 text-sm text-gray-600 dark:text-gray-400">Uploading...</p>
  </div>

  <!-- File List -->
  <div id="files-container" class="space-y-3">
    <div class="py-8 text-center text-gray-500 dark:text-gray-400">Loading files...</div>
  </div>

  <!-- Management Panel (Admin/Staff only, Status 20+) -->
  {
    showManagement && canCheckoutFiles && (
      <div id="management-panel" class="mt-6 rounded-lg bg-gray-50 p-4 dark:bg-gray-800">
        <h4 class="mb-4 text-sm font-medium text-gray-700 dark:text-gray-300">File Management</h4>

        {/* <!-- Quick Actions --> */}
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
          {/* <!-- Checkout Status --> */}
          <div class="rounded-lg bg-white p-3 shadow-sm dark:bg-gray-700">
            <div class="flex items-center space-x-2">
              <div id="overall-status-indicator" class="h-3 w-3 rounded-full bg-gray-400" />
              <span id="overall-status-text" class="text-sm text-gray-600 dark:text-gray-300">
                Loading status...
              </span>
            </div>
          </div>

          {/* <!-- Quick Stats --> */}
          <div class="rounded-lg bg-white p-3 shadow-sm dark:bg-gray-700">
            <div class="text-sm text-gray-600 dark:text-gray-300">
              <span id="checked-out-count">0</span> checked out ‚Ä¢<span id="assigned-count">0</span>{" "}
              assigned
            </div>
          </div>
        </div>
      </div>
    )
  }
</div>

<script
  define:vars={{
    projectId,
    currentUser,
    currentRole,
    showManagement,
    projectAuthorId,
    projectStatus,
    canCheckoutFiles,
    canUploadFiles,
    canDeleteFiles,
    globalInputClasses,
    statusData,
  }}
>
  // File Manager Component with Checkout System - EXTENSIVE DEBUGGING
  // console.log("üîß [FILE-MANAGER] Script initialized with variables:", {
  //   projectId,
  //   currentUser: currentUser
  //     ? {
  //         id: currentUser.id,
  //         email: currentUser.email,
  //         profile: currentUser.profile,
  //       }
  //     : null,
  //   currentRole,
  //   projectAuthorId,
  //   projectStatus,
  //   showManagement,
  //   canCheckoutFiles,
  //   canUploadFiles,
  //   canDeleteFiles,
  //   statusData,
  // });

  let files = [];
  let staffUsers = [];
  let currentProjectId = projectId;
  let currentUserId = currentUser?.id;

  function initializeFileManager() {
    console.log("üöÄ [FILE-MANAGER] Initializing file manager");
    console.log("üîß [FILE-MANAGER] Current project ID:", currentProjectId);
    console.log("üîß [FILE-MANAGER] Current user ID:", currentUserId);
    console.log("üîß [FILE-MANAGER] Current role:", currentRole);
    console.log("üîß [FILE-MANAGER] Show management:", showManagement);

    // Check if required elements exist
    const uploadArea = document.getElementById("upload-dropzone");
    const fileInput = document.getElementById("file-input");
    const browseBtn = document.getElementById("browse-files-btn");
    const filesContainer = document.getElementById("files-container");

    loadProjectFiles();

    // No need to load staff users for simplified workflow

    if (showManagement) {
      console.log("üîß [FILE-MANAGER] Management panel enabled for role:", currentRole);
    } else {
      console.log("üîß [FILE-MANAGER] Management panel disabled for role:", currentRole);
    }
  }

  // Load files for the project
  async function loadProjectFiles() {
    console.log("üìÅ [FILE-MANAGER] Loading project files for project:", currentProjectId);
    console.log("üîß [FILE-MANAGER] Current user:", currentUser);
    console.log("üîß [FILE-MANAGER] Current role:", currentRole);

    try {
      const url = `/api/media?projectId=${currentProjectId}&targetLocation=documents&_t=${Date.now()}`;
      console.log("üîß [FILE-MANAGER] Fetching from URL:", url);

      const response = await fetch(url, {
        cache: "no-cache",
        headers: {
          "Cache-Control": "no-cache, no-store, must-revalidate",
          Pragma: "no-cache",
          Expires: "0",
        },
      });
      console.log("üîß [FILE-MANAGER] Response status:", response.status);
      console.log(
        "üîß [FILE-MANAGER] Response headers:",
        Object.fromEntries(response.headers.entries())
      );

      const data = await response.json();
      console.log("üîß [FILE-MANAGER] Response data:", data);

      if (data.success) {
        files = data.media || [];
        console.log("‚úÖ [FILE-MANAGER] Files loaded successfully:", files.length, "files");
        console.log("üîß [FILE-MANAGER] Files data:", files);

        if (files.length === 0) {
          console.log("‚ö†Ô∏è [FILE-MANAGER] No files returned from API");
          console.log("üîß [FILE-MANAGER] API response:", data);
        }

        // Debug: Check file checkout status
        files.forEach((file, index) => {
          console.log(`üîß [FILE-MANAGER] File ${index} checkout status:`, {
            id: file.id,
            fileName: file.fileName,
            checked_out_by: file.checked_out_by,
            checked_out_by_name: file.checked_out_by_name,
            assigned_to: file.assigned_to,
            assigned_to_name: file.assigned_to_name,
          });
        });

        // Debug: Check for any files with invalid URLs
        files.forEach((file, index) => {
          if ((file.publicUrl && file.publicUrl.includes("undefined")) || file.publicUrl === "") {
            console.warn(`‚ö†Ô∏è [FILE-MANAGER] File ${index} has invalid URL:`, file);
          }
        });

        updateFileCount();
        renderFiles();
        if (showManagement) {
          updateManagementPanel();
        }
      } else {
        console.error("‚ùå [FILE-MANAGER] Failed to load files:", data.error);
        console.log("üîß [FILE-MANAGER] Full API response:", data);
        showError("Failed to load project files: " + data.error);
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] Error loading files:", error);
      console.error("üîß [FILE-MANAGER] Error details:", {
        message: error.message,
        stack: error.stack,
        name: error.name,
      });
      showError("Error loading project files: " + error.message);
    }
  }

  // Load users for assignment dropdown (Admin and Staff can assign to all user types)
  async function loadStaffUsers() {
    console.log("üë• [FILE-MANAGER] Loading users for assignment");
    console.log("üîß [FILE-MANAGER] Project author ID:", projectAuthorId);

    try {
      // Admin and Staff can assign files to Admin, Staff, and Client users
      const rolesToLoad = ["Admin", "Staff", "Client"];

      console.log("üîß [FILE-MANAGER] Loading users for roles:", rolesToLoad);

      const response = await fetch("/api/get-user-emails-by-role", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ roles: rolesToLoad }),
      });

      console.log("üîß [FILE-MANAGER] Users response status:", response.status);
      const data = await response.json();
      console.log("üîß [FILE-MANAGER] Users response data:", data);

      if (data.success) {
        let allUsers = data.staffUsers || [];
        console.log("üîß [FILE-MANAGER] All users loaded:", allUsers.length, "users");

        // Filter users based on role and project author ID
        staffUsers = allUsers.filter((user) => {
          // Always include Admin and Staff users
          if (user.role === "Admin" || user.role === "Staff") {
            console.log(
              "‚úÖ [FILE-MANAGER] Including Admin/Staff user:",
              user.email,
              "Role:",
              user.role
            );
            return true;
          }

          // For Client users, only include the project author
          if (user.role === "Client") {
            const isProjectAuthor = user.id === projectAuthorId;

            if (isProjectAuthor) {
              console.log("‚úÖ [FILE-MANAGER] Including project author client:", user.email);
              return true;
            } else {
              console.log("‚ùå [FILE-MANAGER] Excluding non-author client:", user.email);
              return false;
            }
          }

          return false;
        });

        console.log("‚úÖ [FILE-MANAGER] Filtered users loaded:", staffUsers.length, "users");
        console.log("üîß [FILE-MANAGER] Final users data:", staffUsers);
      } else {
        console.error("‚ùå [FILE-MANAGER] Failed to load users:", data.error);
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] Error loading users:", error);
      console.error("üîß [FILE-MANAGER] Error details:", {
        message: error.message,
        stack: error.stack,
        name: error.name,
      });
    }
  }

  // Update file count display
  function updateFileCount() {
    console.log("üî¢ [FILE-MANAGER] Updating file count:", files.length);
    const fileCountElement = document.getElementById("file-count");
    if (fileCountElement) {
      fileCountElement.textContent = `${files.length} file${files.length !== 1 ? "s" : ""}`;
      console.log("‚úÖ [FILE-MANAGER] File count updated to:", fileCountElement.textContent);
    } else {
      console.error("‚ùå [FILE-MANAGER] File count element not found");
    }
  }

  // Render files with extensive debugging
  function renderFiles() {
    console.log("üé® [FILE-MANAGER] Rendering files");
    const container = document.getElementById("files-container");

    if (!container) {
      console.error("‚ùå [FILE-MANAGER] Files container not found");
      return;
    }

    console.log("üîß [FILE-MANAGER] Files container found, rendering", files.length, "files");

    if (files.length === 0) {
      console.log("üì≠ [FILE-MANAGER] No files to display, showing empty state");
      container.innerHTML = `
        <div class="py-8 text-center text-gray-500 dark:text-gray-400">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
          </svg>
          <p class="mt-2">No files uploaded yet</p>
        </div>
      `;
      return;
    }

    console.log("üîß [FILE-MANAGER] Creating file cards for", files.length, "files");
    const fileCards = files.map((file, index) => {
      console.log(`üîß [FILE-MANAGER] Creating card for file ${index + 1}:`, file);
      return createFileCard(file, currentRole);
    });

    container.innerHTML = fileCards.join("");
    console.log("‚úÖ [FILE-MANAGER] Files rendered successfully");

    // Initialize accordions after rendering (using Accordion partial structure)
    initAccordions();

    // Load button partials for each file
    loadButtonPartials();
  }

  // Load button partials for each file
  async function loadButtonPartials() {
    console.log("üîß [FILE-MANAGER] Loading button partials for", files.length, "files");

    for (const file of files) {
      try {
        const buttonHTML = await window.createButtonPartial({
          variant: "primary",
          size: "sm",
          children: "Save Changes",
          onclick: `saveFileDetails(${file.id})`,
          id: `save-button-${file.id}`,
        });

        if (buttonHTML) {
          const buttonContainer = document.getElementById(`save-button-${file.id}`);
          if (buttonContainer) {
            buttonContainer.innerHTML = buttonHTML;
            console.log(`‚úÖ [FILE-MANAGER] Button loaded for file ${file.id}`);
          }
        }
      } catch (error) {
        console.error(`‚ùå [FILE-MANAGER] Error loading button for file ${file.id}:`, error);
      }
    }
  }

  // Helper function to create accordion HTML using Accordion partial structure
  function createAccordionHTML(id, title, description, content, open = false) {
    return `
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
        <!-- Accordion Header -->
        <div class="flex items-center justify-between">
          <!-- Clickable header area -->
          <div 
            class="flex-1 cursor-pointer rounded-lg transition-colors hover:bg-gray-50 dark:hover:bg-gray-700"
            data-accordion-target="#accordion-${id}"
            aria-expanded="${open}"
            aria-controls="accordion-${id}"
            role="button"
            tabindex="0"
            onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();this.click();}"
          >
            <div class="p-4">
              <h3 class="text-lg font-medium text-gray-900 dark:text-white">
                ${title}
              </h3>
              ${description ? `<p class="mt-1 text-sm text-gray-500 dark:text-gray-400">${description}</p>` : ""}
            </div>
          </div>

          <!-- Accordion Toggle Button -->
          <button
            class="text-gray-400 transition-colors hover:text-gray-600 dark:hover:text-gray-300 p-4"
            data-accordion-target="#accordion-${id}"
            aria-expanded="${open}"
            aria-controls="accordion-${id}"
            type="button"
          >
            <svg
              class="w-3 h-3 transition-transform duration-200 ${open ? "rotate-180" : ""}"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
            </svg>
          </button>
        </div>

        <!-- Accordion Content -->
        <div
          id="accordion-${id}"
          class="${open ? "" : "hidden"}"
          aria-labelledby="accordion-${id}"
        >
          <div class="border-t border-gray-200 px-4 pb-4 dark:border-gray-700 bg-white dark:bg-gray-800">
            <div class="pt-4">
              ${content}
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Create file card with accordion structure using Accordion partial
  function createFileCard(file, role) {
    console.log("üé¥ [FILE-MANAGER] Creating file card for:", file.fileName);
    console.log("üîß [FILE-MANAGER] File data:", file);

    // Enable checkout system - SQL migration should be run
    const hasCheckoutColumns = true; // Enable checkout system
    const isCheckedOut = file.checked_out_by !== null;
    const isAssigned = file.assigned_to !== null;
    const isCheckedOutByMe = file.checked_out_by === currentUserId;

    let statusBadge = "";
    let statusColor = "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300";

    if (isCheckedOut) {
      if (isCheckedOutByMe) {
        statusBadge = "Checked out by you";
        statusColor = "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300";
      } else {
        statusBadge = `Checked out by ${file.checked_out_by_name || "Unknown"}`;
        statusColor = "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";
      }
    } else if (isAssigned) {
      statusBadge = `Assigned to ${file.assigned_to_name || "Unknown"}`;
      statusColor = "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300";
    } else {
      statusBadge = "Available";
      statusColor = "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";
    }

    // Create accordion content with slide toggle
    const accordionContent = `
      <div class="space-y-4">
        <!-- File Title -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title</label>
          <input 
            type="text" 
            id="file-title-${file.id}"
            class="${globalInputClasses}"
            value="${file.title || ""}"
            placeholder="Enter file title..."
          />
        </div>
        
        <!-- File Description -->
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
          <textarea 
            id="file-comments-${file.id}"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            rows="3"
            placeholder="Enter file description..."
          >${file.comments || ""}</textarea>
        </div>

        ${
          role === "Admin" || role === "Staff"
            ? `
        
        <!-- Private Toggle using SlideToggle partial structure -->
        <div class="flex items-center justify-between">
          <div>
            <label class="text-sm font-medium text-gray-700 dark:text-gray-300">Private</label>
            <p class="text-xs text-gray-500 dark:text-gray-400">Hide this file from clients</p>
          </div>
          <label class="toggle-wrapper flex cursor-pointer items-center gap-3">
            <div class="relative">
              <input
                type="checkbox"
                id="file-private-${file.id}"
                class="toggle-input peer sr-only"
                ${file.is_private ? "checked" : ""}
                data-file-id="${file.id}"
              />
              <div class="h-6 w-11 rounded-full bg-gray-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-primary-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-primary-300 dark:border-gray-600 dark:bg-gray-700 dark:peer-focus:ring-primary-800">
              </div>
            </div>
          </label>
        </div>
        `
            : ""
        } 
        
        <!-- Save Button -->
        <div class="flex justify-end">
          <div id="save-button-${file.id}"></div>
        </div>
      </div>
    `;

    // Create file title with icon and status
    const fileTitle = `
      <div class="flex items-center space-x-3">
        <div class="flex-shrink-0">
          ${getFileIcon(file.fileType)}
        </div>
        <div class="flex-1 min-w-0">
          <div class="flex items-center space-x-2">
            <span class="text-lg font-medium text-gray-900 dark:text-white truncate">
              ${getDisplayFileName(file)}
            </span>
            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">
              ${statusBadge}
            </span>
          </div>
          <p class="text-sm text-gray-500 dark:text-gray-400">
            ${formatFileSize(file.fileSize)} ‚Ä¢ Uploaded ${new Date(file.uploadedAt).toLocaleDateString()} at ${new Date(file.uploadedAt).toLocaleTimeString()}${file.uploaded_by_name ? ` ‚Ä¢ by ${file.uploaded_by_name}` : ""}
          </p>
        </div>
      </div>
    `;

    // Create action buttons
    const actionButtons = `
      <div class="flex items-center space-x-2" onclick="event.stopPropagation()">
        <!-- Download/Checkout button -->
        <div class="relative group">
          <button 
            class="${isCheckedOut ? "text-gray-300 cursor-not-allowed" : "text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"}"
            onclick="${isCheckedOut ? "" : `downloadFile('${file.publicUrl || ""}', '${file.fileName}', ${file.id})`}"
            title="${isCheckedOut ? "File checked out" : canCheckoutFiles ? "Download & Check Out File" : "Download File"}"
            ${isCheckedOut || !file.publicUrl ? "disabled" : ""}
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
          </button>

          <!-- Custom tooltip -->
          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
            ${isCheckedOut ? "File checked out" : canCheckoutFiles ? "Download & Check Out File" : "Download File"}
            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
          </div>
        </div>

        <!-- Preview button -->
        <div class="relative group">
          <button 
            class="text-blue-400 hover:text-blue-600 dark:hover:text-blue-300"
            onclick="previewFile('${file.publicUrl || ""}', '${file.fileName}', '${file.file_type || ""}', ${file.id})"
            title="Preview file"
            ${!file.publicUrl ? "disabled" : ""}
          >
            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
            </svg>
          </button>
          
          <!-- Custom tooltip -->
          <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
            Preview file
            <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
          </div>
        </div>

        ${
          canDeleteFiles
            ? `
          <div class="relative group">
            <button 
              class="text-red-400 hover:text-red-600 dark:hover:text-red-300"
              onclick="deleteFile(${file.id}, '${file.fileName}')"
              title="Delete file (Admin only)"
            >
              <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
            
            <!-- Custom tooltip -->
            <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-sm rounded-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 pointer-events-none whitespace-nowrap z-50">
              Delete file (Admin only)
              <div class="absolute top-full left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-4 border-r-4 border-t-4 border-transparent border-t-gray-900"></div>
            </div>
          </div>
        `
            : ""
        }
      </div>
    `;

    // Create accordion using the Accordion partial structure
    const fileCard = createAccordionHTML(
      `file-${file.id}`,
      fileTitle,
      null, // No description since it's in the title
      accordionContent,
      false
    );

    // Add action buttons to the accordion header
    const fileCardWithActions = fileCard.replace(
      "<!-- Accordion Toggle Button -->",
      `${actionButtons}
      <!-- Accordion Toggle Button -->`
    );

    console.log("‚úÖ [FILE-MANAGER] File card created for:", file.fileName);
    return fileCardWithActions;
  }

  // Upload functionality with extensive debugging
  function initializeUpload() {
    console.log("üì§ [FILE-MANAGER] Initializing upload functionality");
    console.log("üì§ [FILE-MANAGER] Can upload files:", canUploadFiles);
    console.log("üì§ [FILE-MANAGER] Project status:", projectStatus);

    // Only initialize upload if allowed
    if (!canUploadFiles) {
      console.log("üì§ [FILE-MANAGER] Upload disabled - project status too low");
      return;
    }

    const uploadArea = document.querySelector("#file-manager .rounded-lg.border-dashed");
    const fileInput = document.getElementById("file-input");
    const browseBtn = document.getElementById("browse-files-btn");
    const progressDiv = document.getElementById("upload-progress");
    const progressBar = document.getElementById("progress-bar");
    const statusText = document.getElementById("upload-status");

    // Click to browse
    browseBtn?.addEventListener("click", (e) => {
      console.log("üñ±Ô∏è [FILE-MANAGER] Browse button clicked");
      e.stopPropagation();
      fileInput?.click();
    });

    uploadArea?.addEventListener("click", () => {
      console.log("üñ±Ô∏è [FILE-MANAGER] Upload area clicked");
      fileInput?.click();
    });

    // Drag and drop
    uploadArea?.addEventListener("dragover", (e) => {
      console.log("üéØ [FILE-MANAGER] File dragged over upload area");
      e.preventDefault();
      uploadArea.classList.add("border-blue-400", "bg-blue-50");
    });

    uploadArea?.addEventListener("dragleave", (e) => {
      console.log("üéØ [FILE-MANAGER] File dragged away from upload area");
      e.preventDefault();
      uploadArea.classList.remove("border-blue-400", "bg-blue-50");
    });

    uploadArea?.addEventListener("drop", (e) => {
      console.log("üéØ [FILE-MANAGER] Files dropped on upload area");
      e.preventDefault();
      uploadArea.classList.remove("border-blue-400", "bg-blue-50");

      const files = Array.from(e.dataTransfer.files);
      console.log("üîß [FILE-MANAGER] Dropped files:", files.length, "files");
      files.forEach((file, index) => {
        console.log(`üîß [FILE-MANAGER] Dropped file ${index + 1}:`, {
          name: file.name,
          size: file.size,
          type: file.type,
        });
      });

      if (files.length > 0) {
        handleFileUpload(files);
      }
    });

    // File input change
    fileInput?.addEventListener("change", (e) => {
      console.log("üìÅ [FILE-MANAGER] File input changed");
      const files = Array.from(e.target.files);
      console.log("üîß [FILE-MANAGER] Selected files:", files.length, "files");
      files.forEach((file, index) => {
        console.log(`üîß [FILE-MANAGER] Selected file ${index + 1}:`, {
          name: file.name,
          size: file.size,
          type: file.type,
        });
      });

      if (files.length > 0) {
        handleFileUpload(files);
      }
    });

    async function handleFileUpload(files) {
      console.log("üì§ [FILE-MANAGER] Starting file upload process");
      console.log("üîß [FILE-MANAGER] Files to upload:", files.length);

      if (!files || files.length === 0) {
        console.log("‚ö†Ô∏è [FILE-MANAGER] No files to upload");
        return;
      }

      // Show progress
      progressDiv?.classList.remove("hidden");
      progressBar.style.width = "0%";
      statusText.textContent = "Preparing upload...";
      console.log("üîß [FILE-MANAGER] Progress UI shown");

      let uploadedCount = 0;
      const totalFiles = files.length;

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        console.log(`üì§ [FILE-MANAGER] Processing file ${i + 1}/${totalFiles}:`, file.name);

        try {
          statusText.textContent = `Uploading ${file.name}...`;
          console.log("üîß [FILE-MANAGER] Converting file to base64:", file.name);

          // Convert file to base64
          const reader = new FileReader();
          const fileData = await new Promise((resolve, reject) => {
            reader.onload = () => {
              console.log(
                "‚úÖ [FILE-MANAGER] File converted to base64, length:",
                reader.result?.length
              );
              resolve(reader.result);
            };
            reader.onerror = (error) => {
              console.error("‚ùå [FILE-MANAGER] FileReader error:", error);
              reject(error);
            };
            reader.readAsDataURL(file);
          });

          console.log("üîß [FILE-MANAGER] Uploading to media API:", file.name);

          // Upload using media system
          const response = await fetch("/api/media", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              mediaData: fileData,
              fileName: file.name,
              fileType: file.type,
              projectId: currentProjectId.toString(),
              targetLocation: "documents",
              title: file.name,
              description: ``,
            }),
          });

          console.log("üîß [FILE-MANAGER] Upload response status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("‚ùå [FILE-MANAGER] Upload failed:", errorData);
            throw new Error(errorData.error || "Upload failed");
          }

          const result = await response.json();
          console.log("‚úÖ [FILE-MANAGER] Upload successful:", result);

          uploadedCount++;
          const progress = (uploadedCount / totalFiles) * 100;
          progressBar.style.width = `${progress}%`;
          statusText.textContent = `Uploaded ${uploadedCount}/${totalFiles} files...`;
          console.log(
            `üîß [FILE-MANAGER] Progress: ${uploadedCount}/${totalFiles} files (${progress.toFixed(1)}%)`
          );
        } catch (error) {
          console.error(`‚ùå [FILE-MANAGER] Error uploading ${file.name}:`, error);
          console.error("üîß [FILE-MANAGER] Error details:", {
            message: error.message,
            stack: error.stack,
            name: error.name,
          });
          showError(`Failed to upload ${file.name}: ${error.message}`);
        }
      }

      // Hide progress and refresh files
      setTimeout(() => {
        console.log("üîß [FILE-MANAGER] Upload process completed, hiding progress");
        progressDiv?.classList.add("hidden");

        // Auto-check-in (unlock) any previously checked out files when new version is uploaded
        if (canCheckoutFiles && uploadedCount > 0) {
          console.log("üîß [FILE-MANAGER] Auto-checking in previous file versions");
          // Get the uploaded filenames to match against
          const uploadedFilenames = files.map((f) => f.name);
          autoCheckInPreviousVersions(uploadedFilenames);
        }

        loadProjectFiles();
        renderFiles();
        if (showManagement) {
          updateManagementPanel();
        }
        if (window.showModal) {
          window.showModal("success", `Successfully uploaded ${uploadedCount} file(s)`, "", 1500);
        } else {
          showSuccess(`Successfully uploaded ${uploadedCount} file(s)`);
        }
        console.log("‚úÖ [FILE-MANAGER] Upload process finished successfully");
      }, 1000);
    }
  }

  // Update management panel
  function updateManagementPanel() {
    console.log("üìä [FILE-MANAGER] Updating management panel");

    // Only update management panel if project status allows it
    if (projectStatus < 20) {
      console.log("üìä [FILE-MANAGER] Skipping management panel update - project status too low");
      return;
    }

    const checkedOutCount = files.filter((f) => f.checked_out_by).length;
    const assignedCount = files.filter((f) => f.assigned_to).length;

    const checkedOutElement = document.getElementById("checked-out-count");
    const assignedElement = document.getElementById("assigned-count");
    const statusTextElement = document.getElementById("overall-status-text");
    const statusIndicatorElement = document.getElementById("overall-status-indicator");

    if (checkedOutElement) {
      checkedOutElement.textContent = checkedOutCount;
      console.log("‚úÖ [FILE-MANAGER] Checked out count updated");
    } else {
      console.error("‚ùå [FILE-MANAGER] Checked out count element not found");
    }

    if (assignedElement) {
      assignedElement.textContent = assignedCount;
      console.log("‚úÖ [FILE-MANAGER] Assigned count updated");
    } else {
      console.error("‚ùå [FILE-MANAGER] Assigned count element not found");
    }

    // Update status text and indicator
    if (statusTextElement) {
      if (checkedOutCount > 0) {
        statusTextElement.textContent = `${checkedOutCount} file${checkedOutCount !== 1 ? "s" : ""} checked out`;
        if (statusIndicatorElement) {
          statusIndicatorElement.className = "h-3 w-3 rounded-full bg-yellow-400";
        }
      } else if (assignedCount > 0) {
        statusTextElement.textContent = `${assignedCount} file${assignedCount !== 1 ? "s" : ""} assigned`;
        if (statusIndicatorElement) {
          statusIndicatorElement.className = "h-3 w-3 rounded-full bg-blue-400";
        }
      } else {
        statusTextElement.textContent = "All files available";
        if (statusIndicatorElement) {
          statusIndicatorElement.className = "h-3 w-3 rounded-full bg-green-400";
        }
      }
      console.log("‚úÖ [FILE-MANAGER] Status text updated:", statusTextElement.textContent);
    } else {
      console.error("‚ùå [FILE-MANAGER] Status text element not found");
    }
  }

  // Utility functions
  function formatFileSize(bytes) {
    if (bytes === 0) return "0 Bytes";
    const k = 1024;
    const sizes = ["Bytes", "KB", "MB", "GB"];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
  }

  function getDisplayFileName(file) {
    // Version badge CSS classes
    const versionBadgeClass =
      "Y3FxyuXtj2gecrGXvLEI _9dH7mrOkzM4RTmidHTs St_AVDyTHE88JaawJoRQ Zs2BLzUMh0_yTpU6xCcU ezMFUVl744lvw6ht0lFe kAEXvwFGb849z6BUdJjG jqg6J89cvxmDiFpnV56r EJIoL6514Ry8r7nh011L";

    // If no version number or version 1, show original filename
    if (!file.version_number || file.version_number === 1) {
      return `<span class="${versionBadgeClass} bg-green-500">SRC</span> ${file.fileName}`;
    }
    if (file.version_number === 999) {
      return `<span class="${versionBadgeClass} bg-red-500">FNL</span> ${file.fileName}`;
    }
    // For version 2+, show "filename | v2", "filename | v3", etc.
    return `<span class="${versionBadgeClass} bg-blue-500">V${file.version_number}</span> ${file.fileName}`;
  }

  function getFileIcon(fileType) {
    const type = (fileType || "").toLowerCase();

    if (type.includes("pdf")) {
      return `<svg class="h-6 w-6 text-red-500" fill="currentColor" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
        <path d="M9 12h6v2H9zm0 4h6v2H9z"/>
      </svg>`;
    }

    if (
      type.includes("image") ||
      type.includes("png") ||
      type.includes("jpg") ||
      type.includes("jpeg")
    ) {
      return `<svg class="h-6 w-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24">
        <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
      </svg>`;
    }

    return `<svg class="h-6 w-6 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
    </svg>`;
  }

  async function downloadFile(publicUrl, fileName, fileId) {
    console.log("üì• [FILE-MANAGER] Download requested:", { publicUrl, fileName, fileId });

    if (!publicUrl) {
      console.error("‚ùå [FILE-MANAGER] No public URL provided for download");
      showError("File download URL not available");
      return;
    }

    // Check if the URL contains 'undefined' or is empty
    if (publicUrl.includes("undefined") || publicUrl === "") {
      console.error("‚ùå [FILE-MANAGER] Invalid file URL:", publicUrl);
      showError("File is no longer available for download");
      return;
    }

    try {
      // Auto-checkout the file when downloading (if project status allows)
      if (canCheckoutFiles && currentUser?.id) {
        console.log("üîß [FILE-MANAGER] Auto-checking out file for download");
        await handleFileCheckout(fileId, "checkout");
      }

      console.log("üîß [FILE-MANAGER] Creating download link");

      // Detect browser for appropriate download method
      const isFirefox = navigator.userAgent.toLowerCase().includes("firefox");
      const isSafari =
        navigator.userAgent.toLowerCase().includes("safari") &&
        !navigator.userAgent.toLowerCase().includes("chrome");

      if (isFirefox || isSafari) {
        // For Firefox and Safari, use direct link to avoid new tab issues
        console.log("üîß [FILE-MANAGER] Using direct link for Firefox/Safari");
        const link = document.createElement("a");
        link.href = publicUrl;
        link.download = fileName;
        link.style.display = "none";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        console.log("‚úÖ [FILE-MANAGER] Download initiated successfully (direct link)");
      } else {
        // For Chrome and other browsers, open PDF in new tab
        console.log("üîß [FILE-MANAGER] Opening PDF in new tab for Chrome/other browsers");
        window.open(publicUrl, "_blank");
        console.log("‚úÖ [FILE-MANAGER] PDF opened in new tab successfully");
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] Error downloading file:", error);
      showError(`Failed to download ${fileName}`);
    }
  }

  function showError(message) {
    console.error("‚ùå [FILE-MANAGER] Error:", message);
    if (window.showError) {
      window.showError("File Upload Error", message, 0);
    } else {
      console.error("üîî [File Upload Error] " + message);
    }
  }

  // Auto-check-in previous versions when new files are uploaded
  async function autoCheckInPreviousVersions(uploadedFilenames = []) {
    console.log("üîß [FILE-MANAGER] Auto-checking in previous file versions");
    console.log("üîß [FILE-MANAGER] Uploaded filenames:", uploadedFilenames);

    // Find checked out files that match the uploaded filenames
    const checkedOutFiles = files.filter(
      (f) => f.checked_out_by && uploadedFilenames.includes(f.fileName)
    );

    console.log(
      `üîß [FILE-MANAGER] Found ${checkedOutFiles.length} matching checked out files to check in`
    );

    for (const file of checkedOutFiles) {
      try {
        console.log(`üîß [FILE-MANAGER] Auto-checking in matching file: ${file.fileName}`);
        await handleFileCheckout(file.id, "checkin");
      } catch (error) {
        console.error(`‚ùå [FILE-MANAGER] Error auto-checking in file ${file.fileName}:`, error);
      }
    }
  }

  // Simplified checkout - no modal needed

  // Accordion functionality
  function initAccordions() {
    const accordionButtons = document.querySelectorAll("[data-accordion-target]");
    accordionButtons.forEach((button) => {
      button.addEventListener("click", function () {
        const targetId = this.getAttribute("data-accordion-target");
        const target = document.querySelector(targetId);
        const isExpanded = this.getAttribute("aria-expanded") === "true";

        if (target) {
          if (isExpanded) {
            target.classList.add("hidden");
            this.setAttribute("aria-expanded", "false");
            // Update both the main header and the toggle button
            const svg = this.querySelector("svg");
            if (svg) svg.style.transform = "rotate(0deg)";
            // Also update the toggle button if it exists
            const toggleButton = document.querySelector(
              `button[data-accordion-target="${targetId}"]`
            );
            if (toggleButton && toggleButton !== this) {
              const toggleSvg = toggleButton.querySelector("svg");
              if (toggleSvg) toggleSvg.style.transform = "rotate(0deg)";
              toggleButton.setAttribute("aria-expanded", "false");
            }
          } else {
            target.classList.remove("hidden");
            this.setAttribute("aria-expanded", "true");
            // Update both the main header and the toggle button
            const svg = this.querySelector("svg");
            if (svg) svg.style.transform = "rotate(180deg)";
            // Also update the toggle button if it exists
            const toggleButton = document.querySelector(
              `button[data-accordion-target="${targetId}"]`
            );
            if (toggleButton && toggleButton !== this) {
              const toggleSvg = toggleButton.querySelector("svg");
              if (toggleSvg) toggleSvg.style.transform = "rotate(180deg)";
              toggleButton.setAttribute("aria-expanded", "true");
            }
          }
        }
      });
    });
  }

  // Save file details function
  window.saveFileDetails = async function (fileId) {
    console.log("üîß [FILE-MANAGER] Saving file details for:", fileId);

    const title = document.getElementById(`file-title-${fileId}`)?.value || "";
    const comments = document.getElementById(`file-comments-${fileId}`)?.value || "";
    const isPrivate = document.getElementById(`file-private-${fileId}`)?.checked || false;

    try {
      const response = await fetch("/api/update-file-details", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          file_id: fileId,
          title: title,
          comments: comments,
          is_private: isPrivate,
        }),
      });

      const data = await response.json();

      if (data.success && window.showModal) {
        console.log("‚úÖ [FILE-MANAGER] File details saved successfully");
        window.showModal("success", "File details saved successfully", "", 2000);
      } else {
        console.error("‚ùå [FILE-MANAGER] Failed to save file details:", data.error);
        window.showModal(
          "error",
          "Failed to save file details",
          "Please leave feedback via the feedback form button on the bottom right of the screen",
          2000
        );
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] Error saving file details:", error);
      showError("Error saving file details: " + error.message);
    }
  };

  window.downloadFile = downloadFile;

  // Handle file checkout operations (simplified - no modal)
  window.handleFileCheckout = async function (fileId, action) {
    console.log("üîß [FILE-MANAGER] Handling file checkout:", { fileId, action });

    try {
      const response = await fetch("/api/file-checkout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          action: action,
          file_id: fileId,
          user_id: currentUserId,
          notes: `Auto-${action} on ${new Date().toLocaleString()}`,
        }),
      });

      const data = await response.json();
      console.log("üîß [FILE-MANAGER] Checkout response:", data);

      if (data.success) {
        console.log(`‚úÖ [FILE-MANAGER] File ${action} successful`);

        // Refresh file list
        await loadProjectFiles();
        renderFiles();
        if (showManagement) {
          updateManagementPanel();
        }
      } else {
        console.error("‚ùå [FILE-MANAGER] Checkout failed:", data.error);
        showError(data.error || `Failed to ${action} file`);
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] File checkout error:", error);
      showError(`Error ${action}ing file: ${error.message}`);
    }
  };

  // Delete file function (Admin only) - using same pattern as project deletion
  let isDeletingFile = false; // Flag to prevent multiple delete operations

  window.deleteFile = function (fileId, fileName) {
    console.log("üóëÔ∏è [FILE-MANAGER] Delete file requested:", { fileId, fileName });

    // Prevent multiple delete operations
    if (isDeletingFile) {
      console.log("Delete operation already in progress, ignoring request");
      return;
    }

    // Validate file ID
    if (!fileId || fileId <= 0) {
      console.error("Invalid file ID for deletion:", fileId);
      if (window.showModal) {
        window.showModal(
          "error",
          "Delete Failed",
          "Invalid file ID. Cannot delete this file.",
          5000
        );
      }
      return;
    }

    // Show confirmation modal with action buttons (same pattern as project deletion)
    if (window.showModal) {
      window.showModal(
        "warning",
        "Delete File",
        `Are you sure you want to delete "${fileName}"? This action cannot be undone.`,
        6000000, // 6000 seconds timeout
        [
          {
            label: "Cancel",
            action: () => {
              console.log("‚ùå [FILE-MANAGER] File deletion cancelled by user");
            },
          },
          {
            label: "Delete",
            action: () => {
              // Set deleting flag to prevent multiple operations
              isDeletingFile = true;

              // Show loading state on delete button
              const deleteBtn = document.querySelector(
                `button[onclick="deleteFile(${fileId}, '${fileName}')"]`
              );
              if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML =
                  '<svg class="h-5 w-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>';
              }

              // Make API call to delete file
              console.log("üîß [FILE-MANAGER] Sending delete request for file:", fileId);
              fetch("/api/delete-file", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                credentials: "include",
                body: JSON.stringify({
                  file_id: fileId,
                  project_id: currentProjectId,
                }),
              })
                .then(async (response) => {
                  console.log("üîß [FILE-MANAGER] Delete response status:", response.status);
                  const data = await response.json();
                  console.log("üîß [FILE-MANAGER] Delete response data:", data);

                  if (!response.ok) {
                    throw new Error(data.error || "Failed to delete file");
                  }

                  // Show success modal
                  if (window.showModal) {
                    window.showModal(
                      "success",
                      "File Deleted!",
                      data.message || `"${fileName}" has been deleted successfully.`,
                      3000
                    );
                  }

                  // Reset deleting flag
                  isDeletingFile = false;

                  // Refresh the file list after a short delay
                  setTimeout(async () => {
                    console.log("üîÑ [FILE-MANAGER] Refreshing file list after deletion");
                    // Clear any cached file references
                    files = [];

                    // Clear any cached file references in the DOM
                    const filesContainer = document.getElementById("files-container");
                    if (filesContainer) {
                      filesContainer.innerHTML = "";
                    }

                    // Force reload the file list
                    await loadProjectFiles();
                    renderFiles();
                    if (showManagement) {
                      updateManagementPanel();
                    }
                    console.log("‚úÖ [FILE-MANAGER] File list refreshed successfully");
                  }, 1000);
                })
                .catch((error) => {
                  console.error("‚ùå [FILE-MANAGER] Error deleting file:", error);

                  // Show error modal with specific error message
                  if (window.showModal) {
                    window.showModal(
                      "error",
                      "Delete Failed",
                      error.message || "Failed to delete file. Please try again.",
                      6000000 // 6000 seconds timeout
                    );
                  }

                  // Reset deleting flag and button state
                  isDeletingFile = false;
                  if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML =
                      '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>';
                  }
                });
            },
          },
        ]
      );
    }
  };

  // Preview file function - make it globally accessible
  window.previewFile = async function previewFile(fileUrl, fileName, fileType, fileId) {
    console.log("üëÅÔ∏è [FILE-MANAGER] Previewing file:", fileName);

    try {
      // Show loading modal
      // if (window.showModal) {
      //   window.showModal("info", "Loading preview...", "", 0);
      // }

      // Fetch preview content from API
      const response = await fetch("/api/pdf-preview-partial", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          fileUrl: fileUrl,
          fileName: fileName,
          fileType: fileType,
        }),
      });

      const result = await response.json();

      if (result.success) {
        // Create and show preview modal
        showPreviewModal(result.htmlContent, result.documentName);
      } else {
        console.error("‚ùå [FILE-MANAGER] Failed to load preview:", result.message);
        if (window.showModal) {
          window.showModal("error", "Failed to load preview: " + result.message, "", 3000);
        }
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] Error loading preview:", error);
      if (window.showModal) {
        window.showModal("error", "Failed to load preview: " + error.message, "", 3000);
      }
    }
  };

  // Show preview modal - make it globally accessible
  window.showPreviewModal = function showPreviewModal(htmlContent, documentName) {
    // Create modal HTML
    const modalHTML = `
      <div id="previewModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] flex flex-col">
          <!-- Modal Header -->
          <div class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
              üìÑ ${documentName}
            </h3>
            <button 
              id="closePreviewModal" 
              class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
              title="Close preview"
            >
              <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
          
          <!-- Modal Body -->
          <div class="flex-1 overflow-hidden">
            <div id="previewContainer" class="h-full">
              <!-- PDF Preview will be loaded here -->
            </div>
          </div>
        </div>
      </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML("beforeend", modalHTML);

    // Load PDF preview partial
    loadPDFPreviewPartial(htmlContent, documentName);

    // Add close event listener
    document.getElementById("closePreviewModal")?.addEventListener("click", closePreviewModal);

    // Close on backdrop click
    document.getElementById("previewModal")?.addEventListener("click", (e) => {
      if (e.target.id === "previewModal") {
        closePreviewModal();
      }
    });

    // Close on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closePreviewModal();
      }
    });
  };

  // Load PDF preview partial - make it globally accessible
  window.loadPDFPreviewPartial = async function loadPDFPreviewPartial(htmlContent, documentName) {
    try {
      // Create a temporary div to render the partial
      const tempDiv = document.createElement("div");
      tempDiv.innerHTML = `
        <div class="pdf-preview-container" data-document-name="${documentName}">
          <div id="zoomControls" class="mb-4 flex items-center justify-between rounded-lg bg-gray-50 p-3 dark:bg-gray-800">
            <div class="flex items-center space-x-2">
              <button id="zoomOut" class="rounded bg-gray-200 px-3 py-1 text-sm hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" title="Zoom Out">‚àí</button>
              <span id="zoomLevel" class="px-3 py-1 text-sm font-medium text-gray-700 dark:text-gray-300">100%</span>
              <button id="zoomIn" class="rounded bg-gray-200 px-3 py-1 text-sm hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600" title="Zoom In">+</button>
              <button id="resetZoom" class="rounded bg-blue-500 px-3 py-1 text-sm text-white hover:bg-blue-600" title="Reset Zoom">Reset</button>
            </div>
            <div class="flex items-center space-x-2">
              <button id="fitToWidth" class="rounded bg-green-500 px-3 py-1 text-sm text-white hover:bg-green-600" title="Fit to Width">Fit Width</button>
              <button id="fitToPage" class="rounded bg-purple-500 px-3 py-1 text-sm text-white hover:bg-purple-600" title="Fit to Page">Fit Page</button>
            </div>
          </div>
          <div id="previewArea" class="overflow-auto border-0 rounded-lg" style="height: 600px; background: #f5f5f5;">
            <div class="py-8 text-center text-gray-500 dark:text-gray-400">
              <div class="mx-auto mb-4 h-8 w-8 animate-spin rounded-full border-b-2 border-blue-600"></div>
              <p>Loading PDF preview...</p>
            </div>
          </div>
        </div>
      `;

      // Insert into modal
      const previewContainer = document.getElementById("previewContainer");
      if (previewContainer) {
        previewContainer.innerHTML = tempDiv.innerHTML;

        // Initialize preview
        initializePDFPreview(htmlContent);
      }
    } catch (error) {
      console.error("‚ùå [FILE-MANAGER] Error loading PDF preview:", error);
    }
  };

  // Initialize PDF preview - make it globally accessible
  window.initializePDFPreview = function initializePDFPreview(htmlContent) {
    let currentZoom = 100;
    let previewIframe = null;

    function showPreview(htmlContent) {
      const previewArea = document.getElementById("previewArea");
      if (!previewArea) return;

      // Create blob URL
      const blob = new Blob([htmlContent], { type: "text/html" });
      const blobUrl = URL.createObjectURL(blob);

      previewArea.innerHTML = `
        <div id="previewContainer" class="overflow-auto border-0 rounded-lg" style="height: 100%; background: #f5f5f5;">
          <iframe 
            id="previewIframe"
            src="${blobUrl}" 
            class="border-0"
            style="width: 100%; height: 100%; transform-origin: top left;"
            sandbox="allow-same-origin allow-scripts"
          ></iframe>
        </div>
      `;

      previewIframe = document.getElementById("previewIframe");
      if (previewIframe) {
        updateZoom();
        previewIframe.onload = () => {
          setTimeout(() => URL.revokeObjectURL(blobUrl), 1000);
        };
      } else {
        URL.revokeObjectURL(blobUrl);
      }
    }

    function updateZoom() {
      if (previewIframe) {
        previewIframe.style.transform = `scale(${currentZoom / 100})`;
        previewIframe.style.width = `${100 / (currentZoom / 100)}%`;
        previewIframe.style.height = `${600 / (currentZoom / 100)}px`;
        const zoomLevel = document.getElementById("zoomLevel");
        if (zoomLevel) {
          zoomLevel.textContent = `${currentZoom}%`;
        }
      }
    }

    function zoomIn() {
      if (currentZoom < 300) {
        currentZoom += 25;
        updateZoom();
      }
    }

    function zoomOut() {
      if (currentZoom > 25) {
        currentZoom -= 25;
        updateZoom();
      }
    }

    function resetZoom() {
      currentZoom = 100;
      updateZoom();
    }

    function fitToWidth() {
      if (previewIframe) {
        const container = document.getElementById("previewContainer");
        if (container) {
          const containerWidth = container.clientWidth;
          currentZoom = Math.round((containerWidth / 800) * 100);
          updateZoom();
        }
      }
    }

    function fitToPage() {
      if (previewIframe) {
        const container = document.getElementById("previewContainer");
        if (container) {
          const containerWidth = container.clientWidth;
          const containerHeight = container.clientHeight;
          const widthZoom = (containerWidth / 800) * 100;
          const heightZoom = (containerHeight / 600) * 100;
          currentZoom = Math.round(Math.min(widthZoom, heightZoom));
          updateZoom();
        }
      }
    }

    // Add event listeners
    document.getElementById("zoomIn")?.addEventListener("click", zoomIn);
    document.getElementById("zoomOut")?.addEventListener("click", zoomOut);
    document.getElementById("resetZoom")?.addEventListener("click", resetZoom);
    document.getElementById("fitToWidth")?.addEventListener("click", fitToWidth);
    document.getElementById("fitToPage")?.addEventListener("click", fitToPage);

    // Initialize preview
    showPreview(htmlContent);
  };

  // Close preview modal - make it globally accessible
  window.closePreviewModal = function closePreviewModal() {
    const modal = document.getElementById("previewModal");
    if (modal) {
      modal.remove();
    }
  };

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    console.log("üöÄ [FILE-MANAGER] DOM loaded, initializing components");
    initializeFileManager();
    initializeUpload();
    console.log("‚úÖ [FILE-MANAGER] All components initialized");
  });
</script>
