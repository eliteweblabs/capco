---
import BoxIcon from "../common/BoxIcon.astro";

interface Props {
  project: {
    id: any;
    author_id?: any;
    title?: any;
    address: any;
    description: any;
    sq_ft: any;
    new_construction: any;
    status: any;
    created_at: any;
    updated_at: any;
    assigned_to_name?: any;
    assigned_to_id?: any;
    company_name?: any;
    comment_count?: any;
    profiles?: any;
    assigned_profiles?: any;
  };
  projectStatusesObject?: any;
  currentRole?: string;
  user?: any;
  statuses?: any;
}

const { project, projectStatusesObject, currentRole = "Client", user } = Astro.props;

// return if user is staff and project is not assigned to them
if (currentRole === "Staff" && project.assigned_to_id !== user?.id) {
  return null;
}

// Function to generate slug from status name
function generateStatusSlug(statusName: string, currentRole: string, slugify: boolean): string {
  // Generate slug from status name
  const slug = slugify
    ? statusName
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .trim()
    : statusName;

  return slug;
}

import { filteredStatusObj } from "../../pages/api/process-client-status";

// Debug: Check if the status exists in the statuses object
console.log("üîç [PROJECT-LIST-ITEM] Project status:", project.status);
console.log("üîç [PROJECT-LIST-ITEM] Available statuses:", Object.keys(projectStatusesObject || {}));
console.log(
  "üîç [PROJECT-LIST-ITEM] Status object for this project:",
  projectStatusesObject?.[project.status]
);

const filteredStatus = filteredStatusObj(projectStatusesObject?.[project.status], currentRole);

const statusUrl = filteredStatus.status_tab || null;
// Generate the status slug for this project
// Default to "Client" if currentRole is empty or undefined
const statusSlug = generateStatusSlug(filteredStatus.status_name, currentRole, true);
const statusName = generateStatusSlug(filteredStatus.status_name, currentRole, false);

console.log("üîç [PROJECT-LIST-ITEM] Status URL:", projectStatusesObject[project.status]);

const statusSlugOrId = currentRole && currentRole === "Client" ? statusSlug : project.status;
// Debug logging removed for performance

// Function to limit description to 200 words
function limitDescription(text: string, wordLimit: number = 50): string {
  if (!text) return "";
  const words = text.trim().split(/\s+/);
  if (words.length <= wordLimit) return text;
  return words.slice(0, wordLimit).join(" ") + "...";
}

// Get project status info from passed statuses or fallback to default
// let statusName = `Status ${.status}`;
let statusColor = "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300";

// Use author profile data from the project query (no additional DB call needed)
let authorProfile: any = null;
if (project.profiles) {
  authorProfile = project.profiles;
}
---

<div
  class="mb-4 rounded-lg border border-gray-200 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-800"
  data-project-status={statusSlugOrId}
  data-project-id={project.id}
>
  <div class="items-start justify-between md:flex">
    <a
      href={`/project/${project.id}`}
      class="flex-none md:flex-1 hover:opacity-80 transition-opacity"
    >
      {
        currentRole !== "Client" && (authorProfile?.company_name || authorProfile?.email) && (
          <>
            <h3
              class="inline-block text-lg font-semibold text-gray-900 dark:text-white"
              data-searchable
            >
              {authorProfile?.company_name || authorProfile?.name || "Unknown Author"}
            </h3>
            <span class="text-gray-500 dark:text-gray-400">|</span>
          </>
        )
      }
      <h3
        class="inline-flex text-lg font-semibold text-gray-900 dark:text-white"
        data-project-address
        data-searchable
      >
        {project.address}
      </h3>
      <p
        class="mt-2 text-sm text-gray-600 dark:text-gray-300"
        data-project-description
        title={project.description}
      >
        {limitDescription(project.description)}
      </p>
      <div class="mt-4 flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400"></div>
    </a>
    <div class="md:ml-4 relative">
      {
        (() => {
          // For clients, make status label clickable if client_status_tab exists
          if (currentRole === "Client" && statusUrl) {
            const tabUrl = `/project/${project.id}?tab=${statusUrl}`;
            return (
              <a
                href={tabUrl}
                class={`inline-flex items-center rounded-full px-2.5 py-0.5 text-md mb-4 font-large ${statusColor} hover:opacity-80 transition-opacity cursor-pointer`}
                data-refresh="status_name"
                data-project-id={project.id}
                title={`Go to ${statusName} tab`}
              >
                {statusName}
              </a>
            );
          } else {
            // For admins or when no client_status_tab, keep as regular span
            return (
              <span
                class={`inline-flex items-center rounded-full px-2.5 py-0.5 mb-4 text-md font-large ${statusColor}`}
                data-refresh="status_name"
                data-project-id={project.id}
              >
                {statusName}
              </span>
            );
          }
        })()
      }

      <a
        href={`/project/${project.id}?tab=discussion`}
        class="absolute -right-1 -top-1 hover:opacity-80 transition-opacity cursor-pointer"
        title={`${project.comment_count || 0} comments - Go to discussions`}
      >
        <BoxIcon name="message-rounded-dots" class="bx-md text-blue-500 dark:text-blue-400" />
        {
          project.comment_count > 0 && (
            <span class="absolute -right-1 -top-1 inline-flex h-5 w-5 min-w-[1.25rem] items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">
              {project.comment_count > 99 ? "99+" : project.comment_count}
            </span>
          )
        }
      </a>

      {
        currentRole !== "Client" &&
          (project.assigned_profiles ? (
            <span class="flex items-center gap-1">
              <BoxIcon name="user" />
              <span data-searchable>
                {project.assigned_profiles.company_name ||
                  project.assigned_profiles.name ||
                  "Assigned User"}
              </span>
            </span>
          ) : (
            <span class="flex items-center gap-1">
              <BoxIcon name="user" />
              <span data-searchable>Unassigned</span>
            </span>
          ))
      }

      <a
        href={`/project/${project.id}`}
        class="hover:opacity-80 transition-opacity cursor-pointer mb-4"
      >
        <span class="flex items-center gap-1">
          <BoxIcon name="area" />
          {project.sq_ft ? project.sq_ft.toLocaleString() : 0} sq ft
        </span>
        <span class="flex items-center gap-1">
          <BoxIcon name="building" />
          {project.new_construction ? "New Construction" : "Existing"}
        </span>
      </a>
      <span class="flex items-center gap-1">
        Updated: {new Date(project.updated_at).toLocaleDateString()}
        {
          new Date(project.updated_at).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          })
        }</span
      >
      <span class="flex items-center gap-1">
        Created: {new Date(project.created_at).toLocaleDateString()}
        {
          new Date(project.created_at).toLocaleTimeString([], {
            hour: "2-digit",
            minute: "2-digit",
            hour12: true,
          })
        }</span
      >
    </div>
  </div>
</div>
