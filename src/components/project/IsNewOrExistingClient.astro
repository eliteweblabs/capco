---
// This component handles the toggle between new client and existing client
// All toggle logic is contained here, and form data is handled by the parent component

import ClientSelect from "../project/ClientSelectDropdown.astro";

interface Props {
  userRole?: string;
}

// const { currentRole = "Client" } = Astro.props;
---

<div class="space-y-4">
  <!-- Modern New Client Toggle -->
  <div
    class="flex items-center justify-between rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-700 dark:bg-gray-800"
  >
    <div class="flex flex-col">
      <label
        for="new-client-toggle"
        class="cursor-pointer text-sm font-medium text-gray-900 dark:text-gray-100"
      >
        New Client
      </label>
      <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
        Toggle to create a new client or select an existing one
      </p>
    </div>

    <!-- Modern Toggle Switch -->
    <div class="relative">
      <input type="checkbox" id="new-client-toggle" name="new_client" class="peer sr-only" />
      <label
        for="new-client-toggle"
        class="relative flex h-6 w-11 cursor-pointer items-center rounded-full bg-gray-300 px-0.5 transition-colors duration-200 ease-in-out peer-checked:bg-green-500 peer-focus:ring-2 peer-focus:ring-green-500 peer-focus:ring-offset-2 dark:bg-gray-600 dark:peer-checked:bg-green-600"
      >
      </label>
      <span
        class="pointer-events-none absolute left-0.5 top-0.5 inline-block h-5 w-5 transform rounded-full bg-white shadow-lg transition-transform duration-200 ease-in-out peer-checked:translate-x-5"
        aria-hidden="true"></span>
    </div>
  </div>

  <!-- New Client Fields (hidden by default) -->
  <div id="new-client-fields" class="hidden space-y-4">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <!-- First Name -->
      <div>
        <label for="first-name-input" class="mb-1 block text-sm font-medium text-gray-700">
          First Name *
        </label>
        <input
          type="text"
          id="first-name-input"
          name="first_name"
          placeholder="First Name"
          required
          class="w-full rounded-md border border-gray-300 px-3 py-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
        />
      </div>

      <!-- Last Name -->
      <div>
        <label for="last-name-input" class="mb-1 block text-sm font-medium text-gray-700">
          Last Name *
        </label>
        <input
          type="text"
          id="last-name-input"
          name="last_name"
          placeholder="Last Name"
          required
          class="w-full rounded-md border border-gray-300 px-3 py-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
        />
      </div>
    </div>

    <!-- Company Name -->
    <div>
      <label for="company-name-input" class="mb-1 block text-sm font-medium text-gray-700">
        Company Name
      </label>
      <input
        type="text"
        id="company-name-input"
        name="company_name"
        placeholder="Company Name"
        class="w-full rounded-md border border-gray-300 px-3 py-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      />
    </div>

    <!-- Email -->
    <div>
      <label for="email-input" class="mb-1 block text-sm font-medium text-gray-700">
        Email *
      </label>
      <input
        type="email"
        id="email-input"
        name="email"
        placeholder="email@example.com"
        required
        class="w-full rounded-md border border-gray-300 px-3 py-2.5 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      />
    </div>
  </div>

  <!-- Existing Client Select (shown by default) -->
  <div id="existing-client-select-container">
    <ClientSelect
      id="existing-client-select"
      name="author_id"
      label="Select Existing Client"
      required={true}
      class="w-full"
    />
  </div>
</div>

<!-- Using proper Flowbite toggle structure - no custom CSS needed -->

<script>
  // Toggle logic for new/existing client
  document.addEventListener("DOMContentLoaded", function () {
    // console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Initializing toggle logic...");

    const toggle = document.getElementById("new-client-toggle") as HTMLInputElement;
    const newClientFields = document.getElementById("new-client-fields") as HTMLDivElement;
    const existingClientSelect = document.getElementById(
      "existing-client-select-container"
    ) as HTMLDivElement;

    // console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Elements found:", {
    //   toggle: !!toggle,
    //   newClientFields: !!newClientFields,
    //   existingClientSelect: !!existingClientSelect,
    // });

    if (!toggle || !newClientFields || !existingClientSelect) {
      console.error("ðŸ”„ [NEW-CLIENT-TOGGLE] Missing required elements!");
      return;
    }

    function updateVisibility() {
      // console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Toggle state:", toggle.checked);

      if (toggle.checked) {
        // console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Switching to NEW CLIENT mode");

        // Show new client fields, hide existing client select
        newClientFields.classList.remove("hidden");
        existingClientSelect.classList.add("hidden");

        // Remove required from existing client select hidden input
        const selectInput = document.getElementById("existing-client-select") as HTMLInputElement;
        if (selectInput) {
          selectInput.removeAttribute("required");
          console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Removed required from existing client select");
        }

        // Enable new client fields and add required attributes back
        const newFields = newClientFields.querySelectorAll("input");
        console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Found new client fields:", newFields.length);

        newFields.forEach((field) => {
          field.disabled = false;
          // Add required attribute back when enabling
          if (field.name === "first_name" || field.name === "last_name" || field.name === "email") {
            field.setAttribute("required", "required");
          }
          console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Enabled field and added required:", field.name);
        });
      } else {
        console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Switching to EXISTING CLIENT mode");

        // Hide new client fields, show existing client select
        newClientFields.classList.add("hidden");
        existingClientSelect.classList.remove("hidden");

        // Add required to existing client select hidden input
        const selectInput = document.getElementById("existing-client-select") as HTMLInputElement;
        if (selectInput) {
          selectInput.setAttribute("required", "required");
          console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Added required to existing client select");
        }

        // Disable new client fields and remove required attributes
        const newFields = newClientFields.querySelectorAll("input");
        console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Disabling new client fields:", newFields.length);

        newFields.forEach((field) => {
          field.disabled = true;
          field.removeAttribute("required"); // Remove required when disabled
          console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Disabled field and removed required:", field.name);
        });
      }

      // Update the toggle state in the form data
      console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Toggle state updated:", toggle.checked);
    }

    // Initial state - start with existing client mode (toggle unchecked)
    console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Setting initial state...");
    toggle.checked = false; // Ensure toggle starts unchecked

    // Remove required attributes from new client fields initially since they're hidden
    const initialNewFields = newClientFields.querySelectorAll("input");
    initialNewFields.forEach((field) => {
      if (field.name === "first_name" || field.name === "last_name" || field.name === "email") {
        field.removeAttribute("required");
      }
    });

    updateVisibility();

    // Listen for toggle changes
    console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Adding event listener...");
    toggle.addEventListener("change", function () {
      console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Toggle changed!");
      updateVisibility();
    });

    // Add form validation debugging and manual validation
    const form = toggle.closest("form");
    if (form) {
      form.addEventListener("submit", function (event) {
        console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Form submission intercepted for validation check");

        // Check current toggle state
        console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Current toggle state:", toggle.checked);

        // Check required fields
        const requiredFields = form.querySelectorAll("[required]");
        console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Required fields found:", requiredFields.length);

        requiredFields.forEach((field, index) => {
          const input = field as HTMLInputElement;
          console.log(`ðŸ”„ [NEW-CLIENT-TOGGLE] Required field ${index + 1}:`, {
            name: input.name,
            value: input.value,
            disabled: input.disabled,
            hidden: input.closest(".hidden") !== null,
          });
        });

        // Manual validation: ensure only appropriate fields are required
        let isValid = true;

        if (toggle.checked) {
          // New client mode: new client fields should be required, existing client select should not
          const newClientRequired = form.querySelectorAll(
            "#new-client-fields input[required]"
          ).length;
          const existingClientRequired = form.querySelectorAll(
            "#existing-client-select[required]"
          ).length;

          console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Validation - New client mode:", {
            newClientRequired,
            existingClientRequired,
          });

          if (existingClientRequired > 0) {
            console.error(
              "ðŸ”„ [NEW-CLIENT-TOGGLE] Validation failed: existing client select still required in new client mode"
            );
            isValid = false;
          }
        } else {
          // Existing client mode: existing client select should be required, new client fields should not
          const newClientRequired = form.querySelectorAll(
            "#new-client-fields input[required]"
          ).length;
          const existingClientRequired = form.querySelectorAll(
            "#existing-client-select[required]"
          ).length;

          console.log("ðŸ”„ [NEW-CLIENT-TOGGLE] Validation - Existing client mode:", {
            newClientRequired,
            existingClientRequired,
          });

          if (newClientRequired > 0) {
            console.error(
              "ðŸ”„ [NEW-CLIENT-TOGGLE] Validation failed: new client fields still required in existing client mode"
            );
            isValid = false;
          }
        }

        if (!isValid) {
          console.error(
            "ðŸ”„ [NEW-CLIENT-TOGGLE] Form validation failed - fixing required attributes..."
          );
          updateVisibility(); // Re-run visibility update to fix required attributes
        }
      });
    }
  });
</script>
