---
import SimpleIcon from "../common/SimpleIcon.astro";
import SlotMachineModalStaff from "../form/SlotMachineModalStaff.astro";
interface Props {
  project: {
    punchlistComplete?: number;
    punchlistCount?: number;
    incompleteDiscussions: any;
    id: any;
    authorId?: any;
    title?: any;
    address: any;
    description: any;
    sqFt: any;
    newConstruction: any;
    status: any;
    createdAt: any;
    updatedAt: any;
    elapsedTime?: any;
    assignedToId?: any;
    commentCount?: any;
    dueDate?: any;
    generated_document_count?: any;
    authorProfile?: any;
    assignedToProfile?: any;
    featuredImageData?: {
      id: any;
      filePath: string;
      fileName: string;
      fileType: string;
      publicUrl: string;
    };
    // New document data fields
    projectFiles?: Array<{
      id: number;
      projectId: number;
      authorId: string;
      filePath: string;
      fileName: string;
      fileSize: number;
      fileType: string;
      title?: string;
      comments?: string;
      status: string;
      uploadedAt: string;
      createdAt: string;
      updatedAt: string;
    }>;
    generatedDocuments?: Array<{
      id: number;
      projectId: number;
      templateId?: number;
      documentName: string;
      filePath?: string;
      fileSize?: number;
      generationStatus: string;
      errorMessage?: string;
      generationStartedAt?: string;
      generation_completed_at?: string;
      createdAt: string;
      createdBy: string;
    }>;
  };
  statusData?: any;
  currentRole?: string;
  statuses?: any;
  currentStatusName?: string;
  currentStatusInt?: string;
  currentStatusTab?: string;
  currentStatusColor?: string;
  currentStatusEstTime?: string;
  staffOptions?: any;
  dueDateOptions?: any;
  currentUser?: any;
  globalInputClasses?: string;
}

const {
  project,
  currentUser,
  statusData,
  currentStatusName,
  currentStatusInt,
  currentStatusTab,
  currentStatusColor,
  currentStatusEstTime,
  staffOptions,
  dueDateOptions,
  globalInputClasses,
} = Astro.props;

const currentRole = currentUser?.profile?.role;

const description = project?.description || "No description";

// console.log("üîç [PROJECT-feater] Project:", project.featuredImageData);
// console.log("üîç [PROJECT-featured=imaage] Project:", project.featuredImage);
// return if user is staff and project is not assigned to them
// if (currentRole === "Staff" && project.assignedToId !== user?.id) {
//   return null;
// }

// if (currentRole === "Client" && project.authorId !== user?.id) {
//   return null;
// }

const statusSlugOrId =
  currentRole && currentRole === "Client" ? currentStatusTab : currentStatusInt;
// Debug logging removed for performance

// Function to limit description to 200 words
function limitDescription(text: string, wordLimit: number = 50): string {
  if (!text) return "";
  const words = text.trim().split(/\s+/);
  if (words.length <= wordLimit) return text;
  return words.slice(0, wordLimit).join(" ") + "...";
}

// Get project status info from passed statuses or fallback to default
// Status color is now provided by the get-project-statuses API

// Use the pre-calculated elapsedTime from the database
const elapsedTime = project.createdAt;
let projectAgeColor = "rgb(209, 213, 219)"; // Default gray
let projectAlertIconCount = 0;
let elapsedHours = 0; // Initialize outside the if block

// Function to format elapsed time into hours and minutes
function formatElapsedTime(elapsedTime: any): string {
  if (!elapsedTime) return "0h 0m";

  let totalMinutes = 0;

  if (typeof elapsedTime === "string") {
    // Parse interval string (e.g., "2 days 5:30:45")
    const match = elapsedTime.match(/(\d+) days? (\d+):(\d+):(\d+)/);
    if (match) {
      const days = parseInt(match[1]);
      const hours = parseInt(match[2]);
      const minutes = parseInt(match[3]);
      totalMinutes = days * 24 * 60 + hours * 60 + minutes;
    } else {
      // Try to parse as just hours:minutes:seconds
      const timeMatch = elapsedTime.match(/(\d+):(\d+):(\d+)/);
      if (timeMatch) {
        const hours = parseInt(timeMatch[1]);
        const minutes = parseInt(timeMatch[2]);
        totalMinutes = hours * 60 + minutes;
      }
    }
  } else if (elapsedTime.total_seconds) {
    // If it's an object with total_seconds
    totalMinutes = Math.floor(elapsedTime.total_seconds / 60);
  } else if (elapsedTime.days !== undefined) {
    // If it's an object with days, hours, minutes, seconds
    totalMinutes =
      (elapsedTime.days || 0) * 24 * 60 +
      (elapsedTime.hours || 0) * 60 +
      (elapsedTime.minutes || 0);
  }

  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;

  return `${hours}h ${minutes}m`;
}

// Calculate time since last update
function getTimeSinceUpdate(updatedAt: string): string {
  const now = new Date();
  const updated = new Date(updatedAt);
  const diffMs = now.getTime() - updated.getTime();

  const seconds = Math.floor(diffMs / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  const weeks = Math.floor(days / 7);
  const months = Math.floor(days / 30);
  const years = Math.floor(days / 365);

  if (years > 0) {
    return `${years} year${years > 1 ? "s" : ""} ago`;
  } else if (months > 0) {
    return `${months} month${months > 1 ? "s" : ""} ago`;
  } else if (weeks > 0) {
    return `${weeks} week${weeks > 1 ? "s" : ""} ago`;
  } else if (days > 0) {
    return `${days} day${days > 1 ? "s" : ""} ago`;
  } else if (hours > 0) {
    return `${hours} hour${hours > 1 ? "s" : ""} ago`;
  } else if (minutes > 0) {
    return `${minutes} minute${minutes > 1 ? "s" : ""} ago`;
  } else {
    return "Just now";
  }
}

const timeSinceUpdate = getTimeSinceUpdate(project.updatedAt);

if (elapsedTime) {
  // Convert PostgreSQL interval to hours
  // elapsedTime is a string like "2 days 5:30:45" or an object with properties

  if (typeof elapsedTime === "string") {
    // Parse interval string (e.g., "2 days 5:30:45")
    const match = elapsedTime.match(/(\d+) days? (\d+):(\d+):(\d+)/);
    if (match) {
      const days = parseInt(match[1]);
      const hours = parseInt(match[2]);
      elapsedHours = days * 24 + hours;
    }
  } else if (elapsedTime.total_seconds) {
    // If it's an object with total_seconds
    elapsedHours = elapsedTime.total_seconds / 3600;
  } else if (elapsedTime.days !== undefined) {
    // If it's an object with days, hours, minutes, seconds
    elapsedHours =
      (elapsedTime.days || 0) * 24 + (elapsedTime.hours || 0) + (elapsedTime.minutes || 0) / 60;
  }

  const isOver48Hours = elapsedHours > 48;

  if (isOver48Hours) {
    // Calculate how many 12-hour periods have passed since 48 hours
    const hoursPast48 = elapsedHours - 48;
    const colorLevel = Math.floor(hoursPast48 / 12); // Every 12 hours = new color level

    // Progressive red color scale (using standard red colors)
    switch (colorLevel) {
      case 0:
        projectAgeColor = "rgb(254, 242, 242)";
        projectAlertIconCount = 1;
        break; // 48-60 hours
      case 1:
        projectAgeColor = "rgb(254, 226, 226)";
        projectAlertIconCount = 2;
        break; // 60-72 hours
      case 2:
        projectAgeColor = "rgb(252, 202, 202)";
        projectAlertIconCount = 3;
        break; // 72-84 hours
      case 3:
        projectAgeColor = "rgb(251, 173, 173)";
        projectAlertIconCount = 4;
        break; // 84-96 hours
      case 4:
        projectAgeColor = "rgb(239, 68, 68)";
        projectAlertIconCount = 5;
        break; // 96-108 hours
      default:
        projectAgeColor = "rgb(220, 38, 38)";
        projectAlertIconCount = 6;
        break; // 108+ hours
    }
  }
}

const statusColor = currentStatusColor || "gray";

// // Convert to days, hours, and minutes
// const days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
// const hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
// const minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

// Format the duration
// const createdAt = `${days}d ${hours}h ${minutes}m`;
---

<tr
  class="border-b bg-gray-50 dark:bg-gray-900 hover:bg-gray-100 dark:border-gray-800 dark:hover:bg-gray-800"
  data-project-status={statusSlugOrId}
  data-project-id={project.id}
  data-refresh="true"
>
  {
    currentRole !== "Client" && (
      <td class="E9GV5sZJIbfO_GEQ_moc px-4 py-2">
        <div class="align-center flex">
          <SimpleIcon
            name="trash"
            class="text-red-500"
            size="xs"
            dataAttributes={{
              "data-project-id": project.id,
              onclick: `event.stopPropagation(); deleteProject(${project.id})`,
            }}
          />
        </div>
      </td>
    )
  }
  <th scope="row" class="whitespace-nowrap px-4 py-2"
    ><a href={`/project/${project.id}`} class="oJZU4OQzzfXeLbF7UKZ_ relative font-medium"
      >{project.address || "No address"}

      {
        currentRole !== "Client" && projectAlertIconCount > 0 && (
          <span class={`font-large z-1 absolute right-0 top-0 mb-4 cursor-pointer`}>
            {Array.from({ length: projectAlertIconCount }, (_, i) => (
              <svg
                class="text-red-500 w-3 h-3 rounded-full bg-gray-100 color-background block"
                fill="currentColor"
                viewBox="0 0 20 20"
              >
                <path
                  fill-rule="evenodd"
                  d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                  clip-rule="evenodd"
                />
              </svg>
            ))}
          </span>
        )
      }
    </a></th
  >

  {
    currentRole !== "Client" && (
      <td class="whitespace-nowrap px-4 py-2">
        {project?.authorProfile?.companyName || "Unknown Author"}
      </td>
    )
  }

  <td class="whitespace-nowrap px-4 py-2">
    <a
      href={`/project/${project.id}?status=${currentStatusTab}`}
      style={`background-color: ${statusColor};`}
      class="rounded-sm block w-full px-2.5 text-center text-black"
      data-project-id={project.id}
      data-status={project.status}>{currentStatusName || "Unknown Status"}</a
    >
  </td>
  <td class="whitespace-nowrap px-4 py-2 w-32 block">
    <div class="flex justify-center">
      <a href={`/project/${project.id}?status=files`} class="text-sm text-gray-600">
        {
          project.projectFiles?.length && project.projectFiles?.length > 0 ? (
            <div
              class="flex flex-wrap items-center gap-2"
              id="project-files-{project.id}"
              data-project-files={JSON.stringify(project.projectFiles || [])}
            />
          ) : (
            <span class="text-gray-600">No files</span>
          )
        }
      </a>
    </div>
    {
      currentRole !== "Client" && (
        <td class="whitespace-nowrap px-4 py-2 font-medium">
          <div class="flex">
            <SlotMachineModalStaff
              id={`assign-staff-slot-machine-${project.id}`}
              title="Assign Staff Member"
              options={staffOptions}
              selectedValue={project?.assignedToId || ""}
              buttonType="icon"
              buttonText={(() => {
                if (!project?.assignedToId) return "Unassigned";
                const assignedStaff = staffOptions.find(
                  (staff: any) => staff.value === project.assignedToId
                );
                return assignedStaff?.label || "Unknown Staff";
              })()}
              buttonClass="w-8 h-8 rounded-full border-2 block items-center rounded-full p-2 text-center text-sm font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-50 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-600"
              buttonVariant="anchor"
              placeholder=""
              saveApiEndpoint="utils/assign-staff"
              showCloseButton={true}
              showCancelButton={true}
              project={project}
              showNotification={true}
              icon="user"
              component="UserIcon"
              componentProps={{
                users: [project?.assignedToProfile],
              }}
              searchText="Search staff..."
              currentUser={currentUser}
              globalInputClasses={globalInputClasses}
              updateCallback={`updateStaffIcon_${project.id}`}
            />
          </div>
        </td>
      )
    }

    <td class="whitespace-nowrap px-4 py-2 font-medium">
      <div class="flex">
        <span class="text-xs font-medium text-gray-500 dark:text-gray-400"
          >{((project.status / 220) * 100).toFixed(0)}%</span
        >
      </div>
      <div class="w-full dark:bg-gray-700">
        <div style={`width: ${((project.status / 220) * 100).toFixed(0)}%`}></div>
      </div>
    </td>
    <td class="whitespace-nowrap px-4 py-2 font-medium">
      <div class="flex items-center gap-1">
        <span
          data-refresh="true"
          data-project-id={project.id}
          data-meta="punchlistComplete"
          data-meta-value={project.punchlistComplete || 0}
        >
          {project.punchlistComplete || 0}
        </span>
        <span class="text-gray-400">/</span>
        <span
          data-refresh="true"
          data-project-id={project.id}
          data-meta="punchlistCount"
          data-meta-value={project.punchlistCount || 0}
        >
          {project.punchlistCount || 0}
        </span>
      </div>
    </td>
    <td class="whitespace-nowrap px-4 py-2 font-medium">
      <span
        data-refresh="true"
        data-project-id={project.id}
        data-meta="createdAt"
        data-meta-value={project.createdAt}
      >
        {
          formatElapsedTime({
            total_seconds: (Date.now() - new Date(project.createdAt).getTime()) / 1000,
          })
        }
      </span>
    </td>
    <td class="whitespace-nowrap px-4 py-2">
      <div
        class="align-center inline-flex rounded-md border bg-gray-100 dark:border-gray-600 dark:bg-gray-700"
      >
        <span
          data-refresh="true"
          data-project-id={project.id}
          data-meta="updatedAt"
          data-meta-value={project.updatedAt}
        >
          {timeSinceUpdate}
        </span>
      </div>
    </td>
    <td class="whitespace-nowrap px-4 py-2">
      {
        currentRole === "Admin" || currentRole === "Staff" ? (
          <div class="flex items-center gap-1">
            <button
              type="button"
              class="align-center flex px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg"
              data-action="decrement"
              data-project-id={project.id}
              onclick={`adjustDueDate(${project.id}, -1)`}
            >
              <SimpleIcon name="minus" size="xs" class="text-gray-600" />
            </button>
            <div class="relative inline-block">
              <input
                type="text"
                id={`due-date-${project.id}`}
                value={
                  project?.dueDate
                    ? new Date(project.dueDate).toLocaleDateString("en-US", {
                        month: "short",
                        day: "numeric",
                        hour: "numeric",
                        hour12: true,
                      })
                    : ""
                }
                data-due-date={project?.dueDate || ""}
                data-refresh="true"
                data-project-id={project.id}
                data-meta="dueDate"
                data-meta-value={project?.dueDate || ""}
                readonly
                class="w-24 text-center border-0 bg-transparent text-xs focus:ring-0 p-1"
              />
            </div>
            <button
              type="button"
              class="align-center flex px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg"
              data-action="increment"
              data-project-id={project.id}
              onclick={`adjustDueDate(${project.id}, 1)`}
            >
              <SimpleIcon name="plus" size="xs" class="text-gray-600" />
            </button>
          </div>
        ) : (
          <span>
            {new Date(project?.dueDate).toLocaleDateString(undefined, {
              year: "numeric",
              month: "long",
              day: "numeric",
            })}
          </span>
        )
      }
    </td>

    <script>
      import { generateTooltipHTML } from "../../lib/tooltip-styles";

      // Get projectId from the parent tr element's data attribute
      const currentScript = document.currentScript;
      const parentTr = currentScript?.closest("tr[data-project-id]");
      const projectId = parentTr?.getAttribute("data-project-id");

      /**
       * Generic function to update any project field
       * @param element - The DOM element with data-refresh, data-meta, data-meta-value
       * @param newValue - The new value to set
       * @param formatDisplay - Optional function to format the display value
       */
      async function updateProjectField(
        element: HTMLElement,
        newValue: any,
        formatDisplay?: (value: any) => string
      ) {
        const projectId = element.getAttribute("data-project-id");
        const metaName = element.getAttribute("data-meta"); // e.g., "dueDate", "status", etc.

        if (!projectId || !metaName) {
          console.error("Missing data-project-id or data-meta attributes");
          return;
        }

        // Format display value if formatter provided, otherwise use raw value
        const displayValue = formatDisplay ? formatDisplay(newValue) : String(newValue);

        // Update display
        if (element.tagName === "INPUT" || element.tagName === "TEXTAREA") {
          (element as HTMLInputElement).value = displayValue;
        } else {
          element.textContent = displayValue;
        }

        // Update data attributes immediately
        element.setAttribute("data-meta-value", String(newValue));
        if (element.hasAttribute("data-due-date")) {
          element.setAttribute("data-due-date", String(newValue));
        }

        // Mark this element as being edited (for CSS specificity)
        element.setAttribute("data-edited", "true");
        
        console.log(`üéØ [SAVE] Marking element as edited:`, {
          element,
          projectId,
          metaName,
          'data-edited': element.getAttribute('data-edited'),
          'element.id': element.id
        });
        
        // Show saving indicator
        element.classList.add("saving");
        element.classList.remove("saved", "save-error", "fade-out");

        // Clear existing timeout for this element
        const timeoutKey = `fieldTimeout_${projectId}_${metaName}`;
        if ((window as any)[timeoutKey]) {
          clearTimeout((window as any)[timeoutKey]);
        }

        // Debounce: save after 500ms of inactivity
        (window as any)[timeoutKey] = setTimeout(async () => {
          console.log(`üíæ [SAVE] Saving ${metaName} for project ${projectId}`);

          try {
            const response = await fetch("/api/projects/upsert", {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                id: parseInt(projectId),
                [metaName]: newValue, // Dynamic field name
              }),
            });

            if (!response.ok) {
              throw new Error(`Failed to update ${metaName}`);
            }

            // Success: show checkmark
            element.classList.remove("saving");
            element.classList.add("saved");

            // Fade out after 3 seconds
            setTimeout(() => {
              element.classList.add("fade-out");
              setTimeout(() => {
                element.classList.remove("saved", "fade-out");
                element.removeAttribute("data-edited"); // Clear edited flag
              }, 300);
            }, 3000);
          } catch (error) {
            console.error(`Error updating ${metaName}:`, error);

            // Error: show red X
            element.classList.remove("saving", "saved");
            element.classList.add("save-error");

            // Remove error after 3 seconds
            setTimeout(() => {
              element.classList.remove("save-error");
              element.removeAttribute("data-edited"); // Clear edited flag
            }, 3000);

            // Show error toast
            if (typeof window !== "undefined" && (window as any).showNotice) {
              (window as any).showNotice(
                "error",
                "Update Failed",
                `Failed to update ${metaName}. Please try again.`,
                3000
              );
            }
          }
        }, 500);
      }

      // Make updateProjectField globally available
      (window as any).updateProjectField = updateProjectField;

      // Adjust due date by hours (uses generic function)
      async function adjustDueDate(projectId: number, hours: number) {
        console.log(`üóìÔ∏è [ADJUST-DUE-DATE] Called for project ${projectId}, hours: ${hours}`);
        
        const input = document.getElementById(`due-date-${projectId}`) as HTMLInputElement;
        if (!input) {
          console.error(`üóìÔ∏è [ADJUST-DUE-DATE] Input not found for project ${projectId}`);
          return;
        }

        console.log(`üóìÔ∏è [ADJUST-DUE-DATE] Found input:`, input);

        const currentDate = input.getAttribute("data-due-date");
        if (!currentDate) {
          console.error(`üóìÔ∏è [ADJUST-DUE-DATE] No data-due-date attribute found`);
          return;
        }

        const date = new Date(currentDate);
        date.setHours(date.getHours() + hours);

        console.log(`üóìÔ∏è [ADJUST-DUE-DATE] Calling updateProjectField for input`, input.id);

        // Use generic function with date formatter
        await updateProjectField(input, date.toISOString(), (value) =>
          new Date(value).toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            hour: "numeric",
            hour12: true,
          })
        );
      }

      // Make function globally accessible
      (window as any).adjustDueDate = adjustDueDate;

      // Update time display every minute
      function updateTimeDisplay() {
        const timeElements = document.querySelectorAll("[data-time-since-update]");

        timeElements.forEach((element) => {
          const updatedAt = element.getAttribute("data-updated-at");
          if (updatedAt) {
            const now = new Date();
            const updated = new Date(updatedAt);
            const diffMs = now.getTime() - updated.getTime();
            const seconds = Math.floor(diffMs / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            const weeks = Math.floor(days / 7);
            const months = Math.floor(days / 30);
            const years = Math.floor(days / 365);

            let timeText;
            if (years > 0) {
              timeText = `${years} year${years > 1 ? "s" : ""} ago`;
            } else if (months > 0) {
              timeText = `${months} month${months > 1 ? "s" : ""} ago`;
            } else if (weeks > 0) {
              timeText = `${weeks} week${weeks > 1 ? "s" : ""} ago`;
            } else if (days > 0) {
              timeText = `${days} day${days > 1 ? "s" : ""} ago`;
            } else if (hours > 0) {
              timeText = `${hours} hour${hours > 1 ? "s" : ""} ago`;
            } else if (minutes > 0) {
              timeText = `${minutes} minute${minutes > 1 ? "s" : ""} ago`;
            } else {
              timeText = "Just now";
            }

            element.textContent = timeText;
          }
        });
      }

      // Update immediately and then every minute
      updateTimeDisplay();
      setInterval(updateTimeDisplay, 60000); // 60000ms = 1 minute

      // Render file icons for this project
      renderFileIcons();

      // File icon function for displaying file type icons
      function getFileIcon(fileType: string) {
        const type = (fileType || "").toLowerCase();

        if (type.includes("pdf")) {
          return `<svg class="h-3 w-3 text-red-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
          <path d="M9 12h6v2H9zm0 4h6v2H9z"/>
        </svg>`;
        }

        if (
          type.includes("image") ||
          type.includes("png") ||
          type.includes("jpg") ||
          type.includes("jpeg") ||
          type.includes("gif") ||
          type.includes("webp") ||
          type.includes("svg")
        ) {
          return `<svg class="h-3 w-3 text-primary-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
        </svg>`;
        }

        if (type.includes("word") || type.includes("doc")) {
          return `<svg class="h-3 w-3 text-primary-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
          <path d="M9 12h6v2H9zm0 4h6v2H9z"/>
        </svg>`;
        }

        if (type.includes("excel") || type.includes("sheet")) {
          return `<svg class="h-3 w-3 text-green-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
          <path d="M9 12h6v2H9zm0 4h6v2H9z"/>
        </svg>`;
        }

        if (type.includes("powerpoint") || type.includes("presentation")) {
          return `<svg class="h-3 w-3 text-orange-600" fill="currentColor" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
          <path d="M9 12h6v2H9zm0 4h6v2H9z"/>
        </svg>`;
        }

        if (type.includes("zip") || type.includes("rar") || type.includes("archive")) {
          return `<svg class="h-3 w-3 text-purple-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
          <path d="M9 12h6v2H9zm0 4h6v2H9z"/>
        </svg>`;
        }

        if (
          type.includes("video") ||
          type.includes("mp4") ||
          type.includes("avi") ||
          type.includes("mov")
        ) {
          return `<svg class="h-3 w-3 text-pink-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM8 15V9l5 3-5 3z"/>
        </svg>`;
        }

        if (type.includes("audio") || type.includes("mp3") || type.includes("wav")) {
          return `<svg class="h-3 w-3 text-indigo-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
        </svg>`;
        }

        // Default file icon
        return `<svg class="h-3 w-3 text-gray-500" fill="currentColor" viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zm-1 1v5h5v10H6V3h7z"/>
      </svg>`;
      }

      // Render file icons with tooltips
      function renderFileIcons() {
        // Find all project file containers
        const containers = document.querySelectorAll('[id^="project-files-"]');

        containers.forEach((container) => {
          const projectFilesData = container.getAttribute("data-project-files");
          if (!projectFilesData) {
            return;
          }

          const projectFiles = JSON.parse(projectFilesData);

          if (!projectFiles || projectFiles.length === 0) {
            return;
          }

          // Clear existing content
          container.innerHTML = "";

          // Create file icons with tooltips
          projectFiles.forEach((file: any) => {
            const fileIconContainer = document.createElement("div");

            // Use the generateTooltipHTML helper from tooltip-styles.ts
            const iconHTML = `<div class="cursor-pointer">${getFileIcon(file.fileType)}</div>`;
            const tooltipHTML = generateTooltipHTML(file.title || file.fileName, iconHTML, {
              position: "top",
            });

            fileIconContainer.innerHTML = tooltipHTML;

            container.appendChild(fileIconContainer);
          });
        });
      }

      // Define the staff icon update callback function for this project
      window[`updateStaffIcon_${projectId}`] = function (result, assignedToId, staffName) {
        console.log(`üîÑ [PROJECT-${projectId}] updateStaffIcon callback called`, {
          result,
          assignedToId,
          staffName,
        });

        // Find the staff assignment element
        const staffElement = document.querySelector(`#assign-staff-slot-machine-${projectId}`);
        if (!staffElement) {
          console.error(`üîÑ [PROJECT-${projectId}] Staff element not found`);
          return;
        }

        // Update the staff element with the new icon/avatar
        if (result?.updatedProject?.assignedToProfile) {
          const profile = result.updatedProject.assignedToProfile;
          console.log(`üîÑ [PROJECT-${projectId}] Updating with profile:`, profile);

          // Create the initials from the profile data
          const fullName =
            profile.companyName ||
            `${profile.firstName || ""} ${profile.lastName || ""}`.trim() ||
            profile.name ||
            "User";
          const initials = fullName
            .split(" ")
            .map((n: string) => n.charAt(0))
            .join("")
            .toUpperCase()
            .slice(0, 2);

          // Create the new UserIcon HTML with tooltip - matching UserIcon.astro styling
          const newHTML = `
            <div class="relative inline-block group w-8 h-8">
              <span class="sr-only">Open user menu</span>
              <div class="w-8 h-8 text-sm rounded-full border-2 border-white shadow-sm bg-gradient-to-br from-primary-500 to-purple-600 flex items-center justify-center text-white font-medium cursor-pointer">
                ${initials}
              </div>
            </div>
          `;

          staffElement.innerHTML = newHTML;
          if (staffElement instanceof HTMLElement) {
            staffElement.title = staffName || fullName;
          }
          console.log(
            `üîÑ [PROJECT-${projectId}] Successfully updated staff icon with initials: ${initials}`
          );
        } else if (!assignedToId || assignedToId === "") {
          // Handle unassignment - show the default icon
          console.log(`üîÑ [PROJECT-${projectId}] Unassigning staff, showing default icon`);

          const newHTML = `
            <span class="relative inline-block group w-8 h-8">
              <span class="sr-only">Open user menu</span>
              <svg
                class="inline-block avatar-fallback"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M7.5 6.5C7.5 8.981 9.519 11 12 11s4.5-2.019 4.5-4.5S14.481 2 12 2 7.5 4.019 7.5 6.5zM20 21h1v-1c0-3.859-3.141-7-7-7h-4c-3.86 0-7 3.141-7 7v1h17z" />
              </svg>
            </span>
          `;

          staffElement.innerHTML = newHTML;
          if (staffElement instanceof HTMLElement) {
            staffElement.title = "Assign to Staff";
          }
          console.log(`üîÑ [PROJECT-${projectId}] Successfully updated to default icon`);
        }
      };
    </script>
  </td>
</tr>
