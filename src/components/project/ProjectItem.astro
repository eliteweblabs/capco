---
import SimpleIcon from "../common/SimpleIcon.astro";
import SlotMachineModalStaff from "../form/SlotMachineModalStaff.astro";
import DeleteConfirmButton from "../ui/DeleteConfirmButton.astro";
import StaffSelectTooltip from "../form/StaffSelectTooltip.astro";
import LiveRelativeTime from "../common/LiveRelativeTime.astro";
import Stepper from "../common/Stepper.astro";
import SlideToggle from "../form/SlideToggle.astro";
import type { ProjectListColumnConfig } from "../../lib/project-list-table-config";

interface Props {
  columns: ProjectListColumnConfig[];
  project: {
    punchlistComplete?: number;
    punchlistCount?: number;
    incompleteDiscussions: any;
    id: any;
    authorId?: any;
    title?: any;
    address: any;
    description: any;
    sqFt: any;
    newConstruction: any;
    status: any;
    createdAt: any;
    updatedAt: any;
    elapsedTime?: any;
    assignedToId?: any;
    commentCount?: any;
    dueDate?: any;
    generated_document_count?: any;
    authorProfile?: any;
    assignedToProfile?: any;
    featured?: boolean;
    featuredImageData?: {
      id: any;
      filePath: string;
      fileName: string;
      fileType: string;
      publicUrl: string;
    };
    // New document data fields
    projectFiles?: Array<{
      id: number;
      projectId: number;
      authorId: string;
      filePath: string;
      fileName: string;
      fileSize: number;
      fileType: string;
      title?: string;
      comments?: string;
      status: string;
      uploadedAt: string;
      createdAt: string;
      updatedAt: string;
    }>;
    generatedDocuments?: Array<{
      id: number;
      projectId: number;
      templateId?: number;
      documentName: string;
      filePath?: string;
      fileSize?: number;
      generationStatus: string;
      errorMessage?: string;
      generationStartedAt?: string;
      generation_completed_at?: string;
      createdAt: string;
      createdBy: string;
    }>;
  };
  statusData?: any;
  currentRole?: string;
  statuses?: any;
  currentStatusName?: string;
  currentStatusInt?: string;
  currentStatusTab?: string;
  currentStatusColor?: string;
  currentStatusEstTime?: string;
  staffOptions?: any;
  dueDateOptions?: any;
  currentUser?: any;
  globalInputClasses?: string;
  isHidden?: boolean; // For progressive loading
}

const {
  columns = [],
  project,
  currentUser,
  statusData,
  currentStatusName,
  currentStatusInt,
  currentStatusTab,
  isHidden = false,
  currentStatusColor,
  currentStatusEstTime,
  staffOptions,
  dueDateOptions,
  globalInputClasses,
} = Astro.props;

const currentRole = currentUser?.profile?.role;

const description = project?.description || "No description";

// console.log("üîç [PROJECT-feater] Project:", project.featuredImageData);
// console.log("üîç [PROJECT-featured=imaage] Project:", project.featuredImage);
// return if user is staff and project is not assigned to them
// if (currentRole === "Staff" && project.assignedToId !== user?.id) {
//   return null;
// }

// if (currentRole === "Client" && project.authorId !== user?.id) {
//   return null;
// }

const statusSlugOrId =
  currentRole && currentRole === "Client" ? currentStatusTab : currentStatusInt;
// Debug logging removed for performance

// Function to limit description to 200 words
function limitDescription(text: string, wordLimit: number = 50): string {
  if (!text) return "";
  const words = text.trim().split(/\s+/);
  if (words.length <= wordLimit) return text;
  return words.slice(0, wordLimit).join(" ") + "...";
}

// Get project status info from passed statuses or fallback to default
// Status color is now provided by the get-project-statuses API

// Use the pre-calculated elapsedTime from the database
const elapsedTime = project.createdAt;
let projectAgeColor = "rgb(209, 213, 219)"; // Default gray
let projectAlertIconCount = 0;
let elapsedHours = 0; // Initialize outside the if block

// Function to format elapsed time into hours and minutes
function formatElapsedTime(elapsedTime: any): string {
  if (!elapsedTime) return "0h 0m";

  let totalMinutes = 0;

  if (typeof elapsedTime === "string") {
    // Parse interval string (e.g., "2 days 5:30:45")
    const match = elapsedTime.match(/(\d+) days? (\d+):(\d+):(\d+)/);
    if (match) {
      const days = parseInt(match[1]);
      const hours = parseInt(match[2]);
      const minutes = parseInt(match[3]);
      totalMinutes = days * 24 * 60 + hours * 60 + minutes;
    } else {
      // Try to parse as just hours:minutes:seconds
      const timeMatch = elapsedTime.match(/(\d+):(\d+):(\d+)/);
      if (timeMatch) {
        const hours = parseInt(timeMatch[1]);
        const minutes = parseInt(timeMatch[2]);
        totalMinutes = hours * 60 + minutes;
      }
    }
  } else if (elapsedTime.total_seconds) {
    // If it's an object with total_seconds
    totalMinutes = Math.floor(elapsedTime.total_seconds / 60);
  } else if (elapsedTime.days !== undefined) {
    // If it's an object with days, hours, minutes, seconds
    totalMinutes =
      (elapsedTime.days || 0) * 24 * 60 +
      (elapsedTime.hours || 0) * 60 +
      (elapsedTime.minutes || 0);
  }

  const hours = Math.floor(totalMinutes / 60);
  const minutes = totalMinutes % 60;

  return `${hours}h ${minutes}m`;
}

// Calculate time since last update
function getTimeSinceUpdate(updatedAt: string): string {
  const now = new Date();
  const updated = new Date(updatedAt);
  const diffMs = now.getTime() - updated.getTime();

  const seconds = Math.floor(diffMs / 1000);
  const minutes = Math.floor(seconds / 60);
  const hours = Math.floor(minutes / 60);
  const days = Math.floor(hours / 24);
  const weeks = Math.floor(days / 7);
  const months = Math.floor(days / 30);
  const years = Math.floor(days / 365);

  if (years > 0) {
    return `${years} year${years > 1 ? "s" : ""} ago`;
  } else if (months > 0) {
    return `${months} month${months > 1 ? "s" : ""} ago`;
  } else if (weeks > 0) {
    return `${weeks} week${weeks > 1 ? "s" : ""} ago`;
  } else if (days > 0) {
    return `${days} day${days > 1 ? "s" : ""} ago`;
  } else if (hours > 0) {
    return `${hours} hour${hours > 1 ? "s" : ""} ago`;
  } else if (minutes > 0) {
    return `${minutes} minute${minutes > 1 ? "s" : ""} ago`;
  } else {
    return "Just now";
  }
}

const timeSinceUpdate = getTimeSinceUpdate(project.updatedAt);

if (elapsedTime) {
  // Convert PostgreSQL interval to hours
  // elapsedTime is a string like "2 days 5:30:45" or an object with properties

  if (typeof elapsedTime === "string") {
    // Parse interval string (e.g., "2 days 5:30:45")
    const match = elapsedTime.match(/(\d+) days? (\d+):(\d+):(\d+)/);
    if (match) {
      const days = parseInt(match[1]);
      const hours = parseInt(match[2]);
      elapsedHours = days * 24 + hours;
    }
  } else if (elapsedTime.total_seconds) {
    // If it's an object with total_seconds
    elapsedHours = elapsedTime.total_seconds / 3600;
  } else if (elapsedTime.days !== undefined) {
    // If it's an object with days, hours, minutes, seconds
    elapsedHours =
      (elapsedTime.days || 0) * 24 + (elapsedTime.hours || 0) + (elapsedTime.minutes || 0) / 60;
  }

  const isOver48Hours = elapsedHours > 48;

  if (isOver48Hours) {
    // Calculate how many 12-hour periods have passed since 48 hours
    const hoursPast48 = elapsedHours - 48;
    const colorLevel = Math.floor(hoursPast48 / 12); // Every 12 hours = new color level

    // Progressive red color scale (using standard red colors)
    switch (colorLevel) {
      case 0:
        projectAgeColor = "rgb(254, 242, 242)";
        projectAlertIconCount = 1;
        break; // 48-60 hours
      case 1:
        projectAgeColor = "rgb(254, 226, 226)";
        projectAlertIconCount = 2;
        break; // 60-72 hours
      case 2:
        projectAgeColor = "rgb(252, 202, 202)";
        projectAlertIconCount = 3;
        break; // 72-84 hours
      case 3:
        projectAgeColor = "rgb(251, 173, 173)";
        projectAlertIconCount = 4;
        break; // 84-96 hours
      case 4:
        projectAgeColor = "rgb(239, 68, 68)";
        projectAlertIconCount = 5;
        break; // 96-108 hours
      default:
        projectAgeColor = "rgb(220, 38, 38)";
        projectAlertIconCount = 6;
        break; // 108+ hours
    }
  }
}

const statusColor = currentStatusColor || "gray";

// // Convert to days, hours, and minutes
// const days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
// const hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
// const minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

// Format the duration
// const createdAt = `${days}d ${hours}h ${minutes}m`;
---

<tr
  class="border-b bg-gray-50 hover:bg-gray-100 dark:border-gray-800 dark:bg-gray-900 dark:hover:bg-gray-800"
  data-project-status={statusSlugOrId}
  data-project-id={project.id}
  data-hidden={isHidden ? "true" : undefined}
  style={isHidden ? "display: none;" : undefined}
>
  {
    columns.length > 0
      ? columns.map((col) => {
          const baseCellClass = "whitespace-nowrap px-4 py-2";
          const centerClass = `${baseCellClass} text-center`;

          if (col.type === "delete") {
            return (
              <td class="px-4 py-2">
                <div class="align-center flex">
                  <DeleteConfirmButton
                    id={`delete-project-${project.id}`}
                    size="xs"
                    variant="icon"
                    dataAttributes={{ "data-project-id": project.id }}
                  />
                </div>
              </td>
            );
          }

          if (col.type === "edit") {
            return (
              <th scope="row" class={`${centerClass} font-medium`}>
                <a href={`/project/${project.id}`} class="relative font-medium">
                  <SimpleIcon name="edit" size="xs" class="text-gray-600" />
                </a>
              </th>
            );
          }

          if (col.type === "text" && col.field === "address") {
            return (
              <th scope="row" class={`${centerClass} font-medium`}>
                <a
                  href={`/project/${project.id}`}
                  class="relative block min-w-0 truncate font-medium"
                >
                  {project.address || project.title || "No address"}
                  {currentRole !== "Client" && projectAlertIconCount > 0 && (
                    <span class="font-large absolute right-0 top-0 z-1 mb-4 cursor-pointer">
                      {Array.from({ length: projectAlertIconCount }, () => (
                        <svg
                          class="color-background block h-3 w-3 rounded-full bg-gray-100 text-red-500"
                          fill="currentColor"
                          viewBox="0 0 20 20"
                        >
                          <path
                            fill-rule="evenodd"
                            d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z"
                            clip-rule="evenodd"
                          />
                        </svg>
                      ))}
                    </span>
                  )}
                </a>
              </th>
            );
          }

          if (col.type === "company") {
            return (
              <td class={centerClass}>{project?.authorProfile?.companyName || "Unknown Author"}</td>
            );
          }

          if (col.type === "status") {
            return (
              <td class={centerClass}>
                <a
                  href={`/project/${project.id}?status=${currentStatusTab}`}
                  style={`background-color: ${statusColor};`}
                  class="block w-full rounded-sm px-2.5 text-center text-black"
                  data-project-id={project.id}
                  data-status={project.status}
                >
                  {currentStatusName || "Unknown Status"}
                </a>
              </td>
            );
          }

          if (col.type === "featured") {
            return (
              <td class={centerClass}>
                <div class="flex justify-center">
                  <SlideToggle
                    id={`featured-toggle-${project.id}`}
                    checked={project.featured === true}
                    size="md"
                    color="warning"
                    class="featured-toggle"
                    dataAttributes={{
                      "data-project-id": project.id,
                      "data-meta": "featured",
                    }}
                  />
                </div>
              </td>
            );
          }

          if (col.type === "files") {
            const displayOpts = col.displayProjectFiles ?? {
              field: col.field ?? "projectFiles",
              size: "sm",
              tooltips: true,
              emptyText: "No files",
            };
            const files = (project as any)[displayOpts.field ?? "projectFiles"] ?? [];
            const hasFiles = Array.isArray(files) && files.length > 0;
            return (
              <td class="block min-w-0 overflow-hidden whitespace-nowrap px-4 py-2 text-center">
                <div class="flex justify-center">
                  <a href={`/project/${project.id}?status=files`} class="text-sm text-gray-600">
                    {hasFiles ? (
                      <div
                        class="flex flex-wrap items-center gap-2"
                        id={`project-files-${project.id}`}
                        data-project-files={JSON.stringify(files)}
                        data-file-size={displayOpts.size ?? "sm"}
                        data-file-tooltips={displayOpts.tooltips !== false ? "true" : "false"}
                      />
                    ) : (
                      <span class="text-gray-600">{displayOpts.emptyText ?? "No files"}</span>
                    )}
                  </a>
                </div>
              </td>
            );
          }

          if (col.type === "assigned") {
            return (
              <td class="whitespace-nowrap px-4 py-2 font-medium">
                <StaffSelectTooltip
                  id={`assign-staff-slot-machine-${project.id}`}
                  title="Assign Staff Member"
                  options={staffOptions}
                  selectedValue={project?.assignedToId || ""}
                  buttonType="icon"
                  buttonText={
                    !project?.assignedToId
                      ? "Unassigned"
                      : staffOptions.find((s: any) => s.value === project.assignedToId)?.label ||
                        "Unknown Staff"
                  }
                  buttonClass="w-8 h-8 rounded-full border-2 block items-center rounded-full p-2 text-center text-sm font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-50 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-600"
                  buttonVariant="anchor"
                  placeholder=""
                  saveApiEndpoint="utils/assign-staff"
                  showCloseButton={true}
                  showCancelButton={true}
                  project={project}
                  showNotification={true}
                  icon="user"
                  component="UserIcon"
                  componentProps={{ users: [project?.assignedToProfile] }}
                  searchText="Search staff..."
                  currentUser={currentUser}
                  globalInputClasses={globalInputClasses}
                  updateCallback={`updateStaffIcon_${project.id}`}
                />
              </td>
            );
          }

          if (col.type === "progress") {
            const pct = ((project.status / 220) * 100).toFixed(0);
            return (
              <td class={`${centerClass} font-medium`}>
                <div class="flex">
                  <span class="text-xs font-medium text-gray-500 dark:text-gray-400">{pct}%</span>
                </div>
                <div class="w-full dark:bg-gray-700">
                  <div style={`width: ${pct}%`} />
                </div>
              </td>
            );
          }

          if (col.type === "checklist") {
            return (
              <td class="whitespace-nowrap px-4 py-2 font-medium">
                <div class="flex items-center gap-1">
                  <span
                    data-refresh="punchlistComplete"
                    data-project-id={project.id}
                    data-meta="punchlistComplete"
                    data-meta-value={project.punchlistComplete || 0}
                  >
                    {project.punchlistComplete || 0}
                  </span>
                  <span class="text-gray-400">/</span>
                  <span
                    data-refresh="punchlistCount"
                    data-project-id={project.id}
                    data-meta="punchlistCount"
                    data-meta-value={project.punchlistCount || 0}
                  >
                    {project.punchlistCount || 0}
                  </span>
                </div>
              </td>
            );
          }

          if (col.type === "elapsed") {
            return (
              <td class={`${centerClass} font-medium`}>
                <span
                  data-refresh="createdAt"
                  data-project-id={project.id}
                  data-meta="createdAt"
                  data-meta-value={project.createdAt}
                >
                  {formatElapsedTime({
                    total_seconds: (Date.now() - new Date(project.createdAt).getTime()) / 1000,
                  })}
                </span>
              </td>
            );
          }

          if (col.type === "timeSince") {
            return (
              <td class="whitespace-nowrap px-4 py-2">
                <span
                  data-live-timestamp={project.updatedAt}
                  data-project-id={project.id}
                  class="live-time-display"
                >
                  {timeSinceUpdate}
                </span>
              </td>
            );
          }

          if (col.type === "dueDate") {
            return (
              <td class={centerClass}>
                <Stepper
                  entityId={project.id}
                  value={project?.dueDate ?? ""}
                  showStepper={currentRole === "Admin" || currentRole === "Staff"}
                  onIncrement={`adjustDueDate(${project.id}, 1)`}
                  onDecrement={`adjustDueDate(${project.id}, -1)`}
                  meta="dueDate"
                  refresh="dueDate"
                  placeholder=""
                />
              </td>
            );
          }

          return <td class={centerClass}>‚Äî</td>;
        })
      : null
  }

  <script>
    // Set up a global listener for all deleteConfirmed events (runs once)
    if (!(window as any).__projectDeleteListenerInitialized) {
      (window as any).__projectDeleteListenerInitialized = true;

      console.log("[ProjectItem] Setting up GLOBAL deleteConfirmed listener");

      document.addEventListener("deleteConfirmed", async (e: Event) => {
        const customEvent = e as CustomEvent;
        const button = customEvent.target as HTMLElement;
        const projectId = button?.getAttribute("data-project-id");

        console.log("[ProjectItem] ‚úÖ GLOBAL deleteConfirmed event RECEIVED!");
        console.log("[ProjectItem] Button:", button);
        console.log("[ProjectItem] Project ID:", projectId);

        if (!projectId) {
          console.error("[ProjectItem] Missing projectId from button");
          return;
        }

        // Directly call delete API
        console.log("[ProjectItem] Sending delete request for project:", projectId);

        try {
          const response = await fetch(`/api/projects/delete`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ projectId }),
          });

          const data = await response.json();

          if (!response.ok) {
            throw new Error(data.error || "Failed to delete project");
          }

          // Show success notification
          if (window.showNotice) {
            window.showNotice(
              "success",
              "Project Deleted!",
              data.message || "Project has been deleted successfully.",
              1500
            );
          }

          // Remove the project row from the DOM
          document.querySelectorAll(`[data-project-id='${projectId}']`)?.forEach((element) => {
            const row = element.closest("tr");
            if (row) row.remove();
          });

          console.log("[ProjectItem] Project deleted successfully");
        } catch (error) {
          console.error("[ProjectItem] Error deleting project:", error);

          // Show error notification
          if (window.showNotice) {
            window.showNotice(
              "error",
              "Delete Failed",
              error.message || "Failed to delete project. Please try again.",
              6000
            );
          }
        }
      });
    }

    // Get the parent TR for this specific project item
    const currentScript = document.currentScript;
    const parentTr = currentScript?.closest("tr");

    console.log("[ProjectItem] currentScript:", currentScript);
    console.log("[ProjectItem] parentTr:", parentTr);

    const refreshElement = parentTr?.querySelector("[data-project-id][data-refresh]");
    const deleteButtonElement = parentTr?.querySelector(".delete-confirm-btn[data-project-id]");
    const deleteWrapperElement = parentTr?.querySelector(
      ".delete-confirm-wrapper [data-project-id]"
    );

    console.log("[ProjectItem] refreshElement:", refreshElement);
    console.log("[ProjectItem] deleteButtonElement:", deleteButtonElement);
    console.log("[ProjectItem] deleteWrapperElement:", deleteWrapperElement);

    const projectIdElement = refreshElement || deleteButtonElement || deleteWrapperElement;
    const projectId = projectIdElement?.getAttribute("data-project-id");

    console.log("[ProjectItem] Found projectId:", projectId);

    // Initialize live "time ago" display for updatedAt field
    const liveTimeElement = parentTr?.querySelector("[data-live-timestamp]");
    if (liveTimeElement) {
      const timestamp = liveTimeElement.getAttribute("data-live-timestamp");

      function formatTimeAgo(seconds: number): string {
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);
        const weeks = Math.floor(days / 7);
        const months = Math.floor(days / 30);
        const years = Math.floor(days / 365);

        if (years > 0) return `${years} year${years > 1 ? "s" : ""} ago`;
        if (months > 0) return `${months} month${months > 1 ? "s" : ""} ago`;
        if (weeks > 0) return `${weeks} week${weeks > 1 ? "s" : ""} ago`;
        if (days > 0) return `${days} day${days > 1 ? "s" : ""} ago`;
        if (hours > 0) return `${hours} hour${hours > 1 ? "s" : ""} ago`;
        if (minutes > 0) return `${minutes} minute${minutes > 1 ? "s" : ""} ago`;
        return "Just now";
      }

      function updateLiveTime() {
        if (!timestamp) return;
        const now = Date.now();
        const updated = new Date(timestamp).getTime();
        const secondsAgo = Math.floor((now - updated) / 1000);
        liveTimeElement.textContent = formatTimeAgo(secondsAgo);
      }

      // Update immediately
      updateLiveTime();

      // Then update every second for live ticking
      setInterval(updateLiveTime, 1000);
    }

    // Render file icons for this project using global function
    // Wait for global script to load if not ready yet
    const tryRenderFileIcons = () => {
      if ((window as any).renderFileIcons) {
        (window as any).renderFileIcons();
      } else {
        // Global script not loaded yet, try again after a small delay
        setTimeout(tryRenderFileIcons, 50);
      }
    };
    tryRenderFileIcons();

    // Create a project-specific wrapper for the staff icon update callback
    // This just calls the global updateStaffIcon function with the projectId
    if (projectId) {
      window[`updateStaffIcon_${projectId}`] = function (result, assignedToId, staffName) {
        (window as any).updateStaffIcon(projectId, result, assignedToId, staffName);
      };
    }
  </script>
</tr>
