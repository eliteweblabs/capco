---
import type { NavItem } from "../common/SlidingPillNav.astro";
import SlidingPillNav from "../common/SlidingPillNav.astro";

interface Project {
  status: number;
}

interface Status {
  status_code: number;
  client_status_name: string;
  admin_status_name: string;
  status_name: string;
}

interface Props {
  currentRole?: string;
  projects?: Project[];
  statuses?: Status[];
  currentUser?: any;
}

const { currentRole, projects = [], statuses = [], currentUser } = Astro.props;

// Use provided data instead of fetching
let project_statuses: Status[] = statuses;
let statusCounts: Record<string, number> = {};
let roleBasedProjectsCount = 0;

// Calculate status counts from provided projects
if (projects && projects.length > 0) {
  statusCounts = {};

  if (currentRole === "Client") {
    // For clients, count by client_status_name (deduplicated)
    projects.forEach((project: Project) => {
      const statusInfo = project_statuses.find((s: Status) => s.status_code === project.status);
      if (statusInfo && statusInfo.client_status_name && project.author_id === currentUser?.id) {
        const clientStatusName = statusInfo.client_status_name;
        statusCounts[clientStatusName] = (statusCounts[clientStatusName] || 0) + 1;
        roleBasedProjectsCount++;
      }
    });
  } else {
    // For admins/staff, count by status number
    projects.forEach((project: Project) => {
      const status = project.status?.toString() || "10";
      statusCounts[status] = (statusCounts[status] || 0) + 1;
      roleBasedProjectsCount++;
    });
  }
}

if (!projects || projects.length === 0) return;

// Build navigation items
const navItems: NavItem[] = [
  {
    id: "all-statuses",
    label: "All Projects",
    variant: "anchor",
    dataAttributes: {
      "data-label": "All Projects",
      "data-project-status-filter": "all",
      "data-count": projects.length.toString(),
    },
  },
];

if (project_statuses.length > 0) {
  if (currentRole === "Client") {
    // Client navigation: deduplicate by client_status_name and use slugs
    const clientStatuses = project_statuses
      .filter(
        (status: Status) => status.client_status_name && status.client_status_name.trim() !== ""
      )
      .reduce((acc: Status[], status: Status) => {
        // Check if this client_status_name already exists
        const existing = acc.find((s) => s.client_status_name === status.client_status_name);
        if (!existing) {
          acc.push(status);
        }
        return acc;
      }, []);

    clientStatuses.forEach((status: Status) => {
      // Create slug from client_status_name
      const slug = status.client_status_name
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, "")
        .replace(/\s+/g, "-")
        .trim();

      navItems.push({
        id: `status-${slug}`,
        label: status.client_status_name,
        variant: "anchor",
        dataAttributes: {
          "data-project-status-label": status.client_status_name,
          "data-project-status-filter": slug,
          "data-count": (statusCounts[status.client_status_name] || 0).toString(),
        },
      });
    });
  } else {
    // Admin/Staff navigation: use status numbers
    project_statuses.forEach((status: Status) => {
      navItems.push({
        id: `status-${status.status_code}`,
        label: status.admin_status_name,
        variant: "anchor",
        dataAttributes: {
          "data-label": status.admin_status_name,
          "data-project-status-filter": status.status_code.toString(),
          "data-count": (statusCounts[status.status_code] || 0).toString(),
        },
      });
    });
  }
}
---

<SlidingPillNav
  navId="project-nav"
  navClass="text-gray-600 dark:text-gray-400 dark:border-gray-700"
  items={navItems}
/>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Project-specific filtering logic
    const projectList = document.getElementById("project-list");
    const subNav = document.getElementById("project-nav");

    if (!subNav || !projectList) return;

    const projectItems = projectList.querySelectorAll("[data-project-status]");
    const filterButtons = subNav.querySelectorAll("[data-project-status-filter]");
    const allStatusesButton = subNav.querySelector("#all-statuses");

    // Project filtering logic
    function filterProjects(statusFilter: string) {
      const shouldShow = (projectStatusSlug: string) => {
        if (statusFilter === "all") {
          return true;
        }
        return projectStatusSlug === statusFilter;
      };

      let visibleCount = 0;
      projectItems.forEach((item) => {
        const projectStatusSlug = item.getAttribute("data-project-status");
        const shouldShowItem = shouldShow(projectStatusSlug || "");

        if (shouldShowItem && !item.classList.contains("hidden")) {
          (item as any).style.display = "block";
          (item as any).style.opacity = "1";
          visibleCount++;
        } else {
          (item as any).style.display = "none";
          (item as any).style.opacity = "0";
        }
      });

      // Show/hide no projects message
      const noProjectsMessage = document.getElementById("no-projects-message");
      const noProjectsText = document.getElementById("no-projects-text");
      if (noProjectsMessage && noProjectsText) {
        if (visibleCount === 0) {
          noProjectsText.textContent = `No projects currently at ${statusFilter}.`;
          noProjectsMessage.classList.remove("hidden");
        } else {
          noProjectsMessage.classList.add("hidden");
        }
      }
    }

    // Update URL for project filtering
    function updateURL(statusFilter: string) {
      const url = new URL(window.location.href);
      if (statusFilter === "all") {
        url.searchParams.delete("status");
      } else {
        url.searchParams.set("status", statusFilter);
      }
      window.history.pushState({}, "", url.toString());
    }

    // Add project filtering to button clicks
    filterButtons.forEach((button: Element) => {
      button.addEventListener("click", function (this: HTMLElement) {
        const filterValue = this.getAttribute("data-project-status-filter");
        if (filterValue) {
          filterProjects(filterValue);
          updateURL(filterValue);
        }
      });
    });

    if (allStatusesButton) {
      allStatusesButton.addEventListener("click", function (this: HTMLElement) {
        filterProjects("all");
        updateURL("all");
      });
    }
  });
</script>
