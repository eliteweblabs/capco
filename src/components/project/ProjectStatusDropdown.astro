---
import BoxIcon from "../common/BoxIcon.astro";

interface Props {
  projectId: string;
  projectStatus: number;
  statusLabel: string;
  statusColor?: string;
  authorProfile?: any;
  currentRole?: string;
  projectTitle?: string;
  clientEmail?: string;
  statuses?: any[]; // Accept statuses as props to avoid redundant API calls
}

const { 
  projectId, 
  statusLabel, 
  statusColor = "blue",
  authorProfile,
  projectStatus = 0, // Default to 0 if undefined
  currentRole = "Client", // Default to Client if undefined
  projectTitle = "Project",
  clientEmail = "Client",
  statuses = []
} = Astro.props;

// Safety check
if (projectStatus === undefined) {
  console.error('ðŸ”½ [STATUS-DROPDOWN] projectStatus is undefined!', {
    projectId,
    statusLabel,
    currentRole,
    allProps: Astro.props
  });
}

// Debug logging for props
console.log('ðŸ”½ [STATUS-DROPDOWN] Component props:', {
  projectId,
  statusLabel,
  projectStatus,
  currentRole,
  statusesType: typeof statuses,
  statusesIsArray: Array.isArray(statuses),
  statusesLength: Array.isArray(statuses) ? statuses?.length : Object.keys(statuses || {}).length,
  sampleStatus: Array.isArray(statuses) ? statuses?.[0] : Object.values(statuses || {})?.[0], // Show first status structure
  statusesKeys: Object.keys(statuses || {})
});

// Check if user can change status (Admin or Staff only)
const canChangeStatus = currentRole === "Admin" || currentRole === "Staff";

console.log('ðŸ”½ [STATUS-DROPDOWN] Permission check:', {
  currentRole,
  canChangeStatus,
  willShowDropdown: canChangeStatus
});

// Process statuses only if user can change status
let projectStatuses: any[] = [];
if (canChangeStatus) {
  if (statuses && statuses.length > 0) {
    projectStatuses = statuses.map((status: any) => ({
      status_code: status.status_code,
      admin_status_name: status.admin_status_name,
      project_action: status.project_action,
      client_status_name: status.client_status_name,
      client_status_tab: status.client_status_tab
    }));
    console.log("ðŸ”„ [STATUS-DROPDOWN] Using passed statuses:", projectStatuses.length);
  }
}

// Debug the final processed statuses
console.log('ðŸ”½ [STATUS-DROPDOWN] Final processed statuses:', {
  count: projectStatuses.length,
  sampleStatus: projectStatuses[0],
  currentProjectStatus: projectStatus,
  allStatuses: projectStatuses
});
---

{canChangeStatus ? (
  <div class="ml-4 flex-shrink-0 relative">
    <div class="relative inline-block text-left">
      <button
        type="button"
        class={`inline-flex items-center rounded-full px-3 py-1 text-sm font-medium cursor-pointer transition-colors
          bg-${statusColor}-100 text-${statusColor}-800 hover:bg-${statusColor}-200 
          dark:bg-${statusColor}-900/30 dark:text-${statusColor}-400 dark:hover:bg-${statusColor}-900/50`}
        id="status-dropdown-button"
        aria-expanded="false"
        aria-haspopup="true"
        data-project-title={projectTitle}
        data-client-email={clientEmail}
        data-refresh="status_name"
      >
        {statusLabel}
        <svg class="ml-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>

      
      <div
        class="absolute right-0 z-50 mt-2 w-64 origin-top-right rounded-md bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none dark:bg-gray-800 dark:ring-gray-700 hidden"
        id="status-dropdown-menu"
        role="menu"
        aria-orientation="vertical"
        aria-labelledby="status-dropdown-button"
      >
        <div class="py-1" role="none">
          <div class="px-4 py-2 text-sm text-gray-700 dark:text-gray-300 border-b border-gray-200 dark:border-gray-700">
            <div class="font-medium">Change Project Status</div>
            <div class="text-xs text-gray-500 dark:text-gray-400">Project #{projectId}</div>
          </div>
          
          
          {projectStatuses
          .map((status: any) => {
            const isCurrentStatus = status.status_code === projectStatus;
            console.log('ðŸ”½ [STATUS-DROPDOWN] Rendering status:', {
              statusCode: status.status_code,
              adminStatusName: status.admin_status_name,
              projectStatus,
              isCurrentStatus,
              comparison: `${status.status_code} === ${projectStatus}`,
              types: {
                statusCode: typeof status.status_code,
                projectStatus: typeof projectStatus
              },
              rawStatus: status
            });
            return (
            <button
              type="button"
              class={`group flex w-full items-center px-4 py-2 text-md hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors
                ${isCurrentStatus 
                  ? 'bg-blue-50 text-blue-700 dark:bg-blue-900/20 dark:text-blue-400' 
                  : 'text-gray-700 dark:text-gray-300'}`}
              data-status-code={status.status_code}
              data-status-name={status.admin_status_name}
              role="menuitem"
            >
              <div class="flex-1 text-left">
                <div class="font-medium">{status.admin_status_name}</div>
                {status.status_code === projectStatus && (
                  <div class="text-xs text-blue-600 dark:text-blue-400">Current Status</div>
                )}
              </div>
              {status.status_code === projectStatus && (
                <svg class="h-4 w-4 text-blue-600 dark:text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
              )}
            </button>
            );
          })}
        </div>
      </div>
    </div>
  </div>
) : (
  <!-- Non-admin users see static status badge -->
  <div class="flex-shrink-0">
    <span
      class={`inline-flex items-center rounded-full px-3 py-1 text-lg font-large 
        bg-${statusColor}-100 text-${statusColor}-800 
        dark:bg-${statusColor}-900/30 dark:text-${statusColor}-400`}
      data-refresh="status_name"
    ><BoxIcon name="dots-horizontal" class="bx-md" />
      {statusLabel}
    </span>
  </div>
)}

<script define:vars={{projectId, projectStatus, currentRole}}>
  function initializeStatusDropdown() {
    console.log('ðŸ”½ [STATUS-DROPDOWN] Initializing dropdown');
    
    const dropdownButton = document.getElementById('status-dropdown-button');
    const dropdownMenu = document.getElementById('status-dropdown-menu');
    const currentProjectId = projectId;
    
    console.log('ðŸ”½ [STATUS-DROPDOWN] Elements found:', {
      dropdownButton: !!dropdownButton,
      dropdownMenu: !!dropdownMenu,
      projectId: currentProjectId,
      buttonVisible: dropdownButton ? window.getComputedStyle(dropdownButton).display !== 'none' : false,
      buttonText: dropdownButton ? dropdownButton.textContent : 'N/A'
    });
    
    if (!dropdownButton || !dropdownMenu) {
      console.error('ðŸ”½ [STATUS-DROPDOWN] Missing required elements - cannot initialize dropdown');
      return;
    }

    // Toggle dropdown
    dropdownButton.addEventListener('click', function(e) {
      e.stopPropagation();
      console.log('ðŸ”½ [STATUS-DROPDOWN] Button clicked');
      const isOpen = dropdownMenu.getAttribute('aria-expanded') === 'true';
      console.log('ðŸ”½ [STATUS-DROPDOWN] Current state:', isOpen ? 'open' : 'closed');
      
      if (isOpen) {
        closeDropdown();
      } else {
        openDropdown();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
      if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
        closeDropdown();
      }
    });

    // Handle status selection
    const statusButtons = dropdownMenu.querySelectorAll('[data-status-code]');
    console.log('ðŸ”½ [STATUS-DROPDOWN] Found status buttons:', statusButtons.length);
    
    statusButtons.forEach((button, index) => {
      const statusCode = button.getAttribute('data-status-code');
      const statusName = button.getAttribute('data-status-name');
      console.log(`ðŸ”½ [STATUS-DROPDOWN] Button ${index}:`, { statusCode, statusName });
      
      button.addEventListener('click', async function(e) {
        e.stopPropagation();
        console.log('ðŸ”½ [STATUS-DROPDOWN] Status button clicked:', { statusCode, statusName });
        
        if (statusCode && statusName) {
          await changeProjectStatus(currentProjectId, parseInt(statusCode), statusName);
          closeDropdown();
        } else {
          console.error('ðŸ”½ [STATUS-DROPDOWN] Missing status data:', { statusCode, statusName });
        }
      });
    });

    function openDropdown() {
      if (dropdownMenu && dropdownButton) {
        console.log('ðŸ”½ [STATUS-DROPDOWN] Opening dropdown');
        dropdownMenu.classList.remove('hidden');
        dropdownButton.setAttribute('aria-expanded', 'true');
      } else {
        console.error('ðŸ”½ [STATUS-DROPDOWN] Cannot open dropdown - missing elements:', {
          dropdownMenu: !!dropdownMenu,
          dropdownButton: !!dropdownButton
        });
      }
    }

    function closeDropdown() {
      if (dropdownMenu && dropdownButton) {
        console.log('ðŸ”½ [STATUS-DROPDOWN] Closing dropdown');
        dropdownMenu.classList.add('hidden');
        dropdownButton.setAttribute('aria-expanded', 'false');
      }
    }

    async function changeProjectStatus(projectId, newStatus, statusName) {
      console.log('ðŸ”½ [STATUS-DROPDOWN] changeProjectStatus called with:', {
        projectId,
        newStatus,
        statusName,
        dropdownButton: !!dropdownButton
      });
      
      if (!dropdownButton) {
        console.error('ðŸ”½ [STATUS-DROPDOWN] No dropdown button found');
        return;
      }
      
      const originalText = dropdownButton.innerHTML;
      
      try {
        // Show loading state
        dropdownButton.disabled = true;
        dropdownButton.innerHTML = `
          <svg class="animate-spin h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Updating...
        `;

        console.log("ðŸ”” [STATUS-DROPDOWN] Updating project status:", {
          projectId,
          newStatus,
          statusName
        });

        // Get current user ID and old status from the page context
        const currentUserId = document.querySelector('[data-current-user-id]')?.getAttribute('data-current-user-id');
        const oldStatus = document.querySelector('[data-project-status]')?.getAttribute('data-project-status');
        
        console.log("ðŸ”” [STATUS-DROPDOWN] Found page context:", {
          currentUserId,
          oldStatus,
          projectId,
          newStatus
        });
        
        // Make API call to update status using update-status endpoint
        const requestBody = {
          projectId: parseInt(projectId),
          status: newStatus,
          currentUserId: currentUserId,
          oldStatus: oldStatus ? parseInt(oldStatus) : null
        };

        console.log("ðŸ”” [STATUS-DROPDOWN] Making API call to /api/update-status with body:", requestBody);
        
        const response = await fetch('/api/update-status', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include', // Include cookies for authentication
          body: JSON.stringify(requestBody)
        });

        console.log("ðŸ”” [STATUS-DROPDOWN] API response status:", response.status);

        if (response.ok) {
          const result = await response.json();
          console.log("ðŸ”” [STATUS-DROPDOWN] API response result:", result);
          console.log("ðŸ”” [STATUS-DROPDOWN] API response success:", result.success);
          
          // Update the data-project-status attribute to reflect the new status
          const projectStatusElement = document.querySelector('[data-project-status]');
          if (projectStatusElement) {
            projectStatusElement.setAttribute('data-project-status', newStatus.toString());
            console.log("ðŸ”” [STATUS-DROPDOWN] Updated data-project-status to:", newStatus);
          }
          
          // Show success notification using notificationData from API
          if (result.notificationData && window.showModal) {
            // Determine user role from the current user context
            const isAdminOrStaff = window.location.pathname.includes('/admin') || 
                                 document.querySelector('[data-user-role="Admin"]') || 
                                 document.querySelector('[data-user-role="Staff"]');
            
            const notification = isAdminOrStaff ? result.notificationData.admin : result.notificationData.client;
            
            console.log("ðŸ”” [STATUS-DROPDOWN] Showing modal:", { 
              message: notification.message,
              redirect: notification.redirect,
              userType: isAdminOrStaff ? 'admin' : 'client'
            });

            if (notification) {
              window.showModal(
                notification.type,
                notification.title,
                notification.message,
                notification.duration,
                notification.redirect
              );
            }
          
          }
          console.log("ðŸ”” [STATUS-DROPDOWN] Checking for statusConfig:", !!result.statusConfig);
          console.log("ðŸ”” [STATUS-DROPDOWN] Available result:", Object.keys(result || {}));
          console.log("ðŸ”” [STATUS-DROPDOWN] StatusConfig details:", result.statusConfig);
          
          
          // Update the button text to show new status
          if (dropdownButton) {
            dropdownButton.innerHTML = `
              <span class="flex items-center">
                <span class="mr-2">${statusName}</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </span>
            `;
            dropdownButton.disabled = false;
          }
          
          // Update the selected status in the dropdown menu
          const statusButtons = dropdownMenu.querySelectorAll('[data-status-code]');
          statusButtons.forEach(button => {
            const buttonStatusCode = parseInt(button.getAttribute('data-status-code'));
            
            // Remove selection from all buttons first
            button.classList.remove('bg-blue-50', 'text-blue-700', 'dark:bg-blue-900/20', 'dark:text-blue-400');
            button.classList.add('text-gray-700', 'dark:text-gray-300');
            
            // Remove "Current Status" text and checkmark from all buttons
            const currentStatusDiv = button.querySelector('.text-xs');
            if (currentStatusDiv) {
              currentStatusDiv.remove();
            }
            const checkmark = button.querySelector('svg');
            if (checkmark) {
              checkmark.remove();
            }
            
            // Add selection to the new status button
            if (buttonStatusCode === newStatus) {
              button.classList.remove('text-gray-700', 'dark:text-gray-300');
              button.classList.add('bg-blue-50', 'text-blue-700', 'dark:bg-blue-900/20', 'dark:text-blue-400');
              
              // Add "Current Status" text
              const textDiv = button.querySelector('.flex-1');
              if (textDiv) {
                const currentStatusDiv = document.createElement('div');
                currentStatusDiv.className = 'text-xs text-blue-600 dark:text-blue-400';
                currentStatusDiv.textContent = 'Current Status';
                textDiv.appendChild(currentStatusDiv);
              }
              
              // Add checkmark
              const checkmarkSvg = document.createElement('svg');
              checkmarkSvg.className = 'h-4 w-4 text-blue-600 dark:text-blue-400';
              checkmarkSvg.setAttribute('fill', 'currentColor');
              checkmarkSvg.setAttribute('viewBox', '0 0 20 20');
              checkmarkSvg.innerHTML = '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>';
              button.appendChild(checkmarkSvg);
              
              console.log("ðŸ”” [STATUS-DROPDOWN] Added checkmark to status button:", {
                statusCode: buttonStatusCode,
                newStatus,
                buttonText: button.querySelector('.font-medium')?.textContent
              });
            }
          });
          
          // Show success message
          console.log("ðŸ”” [STATUS-DROPDOWN] Status updated successfully to:", statusName);
          console.log("ðŸ”” [STATUS-DROPDOWN] Email notifications should have been triggered");
        } else {
          const errorData = await response.json();
          console.error("ðŸ”” [STATUS-DROPDOWN] API error response:", errorData);
          throw new Error(errorData.error || 'Failed to update status');
        }
      } catch (error) {
        console.error('ðŸ”” [STATUS-DROPDOWN] Error updating project status:', error);
        
        // Show error notification
        const notification = document.createElement('div');
        notification.className = 'fixed top-4 right-4 z-50 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
        notification.textContent = 'Failed to update project status. Please try again.';
        document.body.appendChild(notification);
        
        // Remove notification after 3 seconds
        setTimeout(() => {
          notification.remove();
        }, 3000);
        
        // Reset button
        if (dropdownButton) {
          dropdownButton.disabled = false;
          dropdownButton.innerHTML = originalText;
        }
      }
    }
  }

  // Try to initialize immediately if DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeStatusDropdown);
  } else {
    // DOM is already ready
    initializeStatusDropdown();
  }
</script>

<style>
  /* Ensure the dropdown appears above other elements */
  #status-dropdown-menu {
    z-index: 50;
  }
</style>
