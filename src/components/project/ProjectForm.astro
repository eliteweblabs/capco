---
interface Props {
  project?: any;
  projectId?: string | null;
  userRole?: string | null;
  isNewProject?: boolean;
}

const { project = {}, projectId = "", userRole, isNewProject = false } = Astro.props;

// Generate a temporary ID for new projects
const formId = isNewProject ? `new-project-${Date.now()}` : projectId || "";
---

<form
  class="space-y-4"
  data-project-id={formId}
  data-project-data={JSON.stringify(project || {})}
  data-is-new-project={isNewProject}
>
  <!-- Title Field -->
  <div class="relative">
    <label
      for={`title-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Title *
    </label>
    <input
      type="text"
      id={`title-${formId}`}
      name="title"
      value={project?.title || ""}
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder="Project title"
      required
    />
  </div>

  <!-- Address Field -->
  <div class="relative">
    <label
      for={`address-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Address *
    </label>
    <input
      type="text"
      id={`address-${formId}`}
      name="address"
      value={project?.address || ""}
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder="Project address"
      required
    />
  </div>

  <!-- Owner Field -->
  <div class="relative">
    <label
      for={`owner-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Owner
    </label>
    <input
      type="text"
      id={`owner-${formId}`}
      name="owner"
      value={project?.owner || ""}
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder="Property owner"
    />
  </div>

  <!-- Architect Field -->
  <div class="relative">
    <label
      for={`architect-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Architect
    </label>
    <input
      type="text"
      id={`architect-${formId}`}
      name="architect"
      value={project?.architect || ""}
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder="Project architect"
    />
  </div>

  <!-- Square Footage and Units Row -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <!-- Square Footage Field -->
    <div class="relative">
      <label
        for={`sq_ft-${formId}`}
        class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
      >
        Square Footage
      </label>
      <input
        type="number"
        id={`sq_ft-${formId}`}
        name="sq_ft"
        value={project?.sq_ft || ""}
        class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
        placeholder="Square footage"
      />
    </div>

    <!-- Units Field -->
    <div class="relative">
      <label
        for={`units-${formId}`}
        class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
      >
        Units
      </label>
      <input
        type="number"
        id={`units-${formId}`}
        name="units"
        value={project?.units || "1"}
        min="1"
        class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
        placeholder="Number of units"
      />
    </div>
  </div>

  <!-- Description Field -->
  <div class="relative">
    <label
      for={`description-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Description
    </label>
    <textarea
      id={`description-${formId}`}
      name="description"
      rows="3"
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder="Project description">{project?.description || ""}</textarea>
  </div>

  <!-- New Construction Toggle -->
  <div class="relative">
    <label class="inline-flex cursor-pointer items-center">
      <input
        type="checkbox"
        name="new_construction"
        checked={project?.new_construction}
        class="peer sr-only"
      />
      <div
        class="peer relative h-6 w-11 rounded-full bg-gray-200 after:absolute after:start-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-blue-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 dark:border-gray-600 dark:bg-gray-700 dark:peer-checked:bg-blue-600 dark:peer-focus:ring-blue-800 rtl:peer-checked:after:-translate-x-full"
      >
      </div>
      <span class="ms-3 text-sm font-medium text-gray-900 dark:text-gray-300">
        New Construction
      </span>
    </label>
  </div>

  <!-- Building Data (JSON field) -->
  <div class="relative">
    <label
      for={`building-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Building Information (JSON)
    </label>
    <textarea
      id={`building-${formId}`}
      name="building"
      rows="3"
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder='{"type": "Office Building", "floors": 3, "occupancy": "Commercial"}'>{project?.building ? JSON.stringify(project.building, null, 2) : ""}</textarea>
  </div>

  <!-- Project Data (JSON field) -->
  <div class="relative">
    <label
      for={`project-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Project Information (JSON)
    </label>
    <textarea
      id={`project-${formId}`}
      name="project"
      rows="3"
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder='{"priority": "High", "timeline": "3-6 months", "complexity": "Standard"}'>{project?.project ? JSON.stringify(project.project, null, 2) : ""}</textarea>
  </div>

  <!-- Service Data (JSON field) -->
  <div class="relative">
    <label
      for={`service-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Service Information (JSON)
    </label>
    <textarea
      id={`service-${formId}`}
      name="service"
      rows="3"
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder='{"primary_services": ["Fire Alarm System", "Sprinkler Installation"], "coverage_area": "Full Building"}'>{project?.service ? JSON.stringify(project.service, null, 2) : ""}</textarea>
  </div>

  <!-- Requested Documents (JSON field) -->
  <div class="relative">
    <label
      for={`requested_docs-${formId}`}
      class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
    >
      Requested Documents (JSON Array)
    </label>
    <textarea
      id={`requested_docs-${formId}`}
      name="requested_docs"
      rows="3"
      class="w-full rounded-md border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-blue-500 focus:ring-2 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 dark:focus:ring-blue-400"
      placeholder='["As-Built Drawings", "Fire Safety Plan", "Code Compliance Reports"]'>{project?.requested_docs ? JSON.stringify(project.requested_docs, null, 2) : ""}</textarea>
  </div>

  <!-- Form Actions -->
  <div class="flex gap-2 border-t border-gray-200 pt-4 dark:border-gray-600">
    <!-- Save/Update Button -->
    <button
      type="submit"
      class="rounded-md bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-700"
    >
      <i class="bx bx-save mr-1"></i>
      {isNewProject ? "Create Project" : "Update Project"}
    </button>

    <!-- Delete Button (only for existing projects) -->
    {
      !isNewProject && (
        <button
          type="button"
          id="delete-project-btn"
          class="rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-red-700"
          data-project-id={formId}
        >
          <i class="bx bx-trash mr-1" />
          Delete Project
        </button>
      )
    }
  </div>
</form>

<script>
  // Extend Window interface for toast manager
  declare global {
    interface Window {
      toastAlertManager?: any;
    }
  }

  // Add event listeners when DOM is loaded
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form[data-project-id]");
    if (form) {
      const projectId = form.getAttribute("data-project-id");
      const isNewProject = form.getAttribute("data-is-new-project") === "true";

      // Add form submission handler
      form.addEventListener("submit", handleFormSubmit);

      // Handle delete button (only for existing projects)
      if (!isNewProject) {
        const deleteBtn = document.getElementById("delete-project-btn");
        if (deleteBtn && projectId) {
          deleteBtn.addEventListener("click", function () {
            deleteProject(projectId);
          });
        }
      }
    }
  });

  // Delete project function
  function deleteProject(projectId: string) {
    // Show confirmation toast with action buttons
    if ((window as any).toastAlertManager) {
      (window as any).toastAlertManager.show({
        type: "warning",
        title: "Delete Project",
        message: "Are you sure you want to delete this project? This action cannot be undone.",
        duration: 0, // Don't auto-dismiss
        actions: [
          {
            label: "Cancel",
            action: () => {
              // Just close the toast, do nothing
            },
          },
          {
            label: "Delete",
            action: () => {
              // Show loading state
              const deleteBtn = document.getElementById("delete-project-btn") as HTMLButtonElement;
              if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin mr-1"></i>Deleting...';
              }

              // Make API call to delete project
              fetch(`/api/delete-project`, {
                method: "DELETE",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ projectId }),
              })
                .then((response) => {
                  if (!response.ok) {
                    throw new Error("Failed to delete project");
                  }
                  return response.json();
                })
                .then((data) => {
                  // Show success toast
                  if ((window as any).toastAlertManager) {
                    (window as any).toastAlertManager.show({
                      type: "success",
                      title: "Project Deleted!",
                      message: "Project has been deleted successfully.",
                      duration: 3000,
                    });
                  }

                  // Redirect to dashboard after a short delay
                  setTimeout(() => {
                    window.location.href = "/dashboard";
                  }, 1500);
                })
                .catch((error) => {
                  console.error("Error deleting project:", error);

                  // Show error toast
                  if ((window as any).toastAlertManager) {
                    (window as any).toastAlertManager.show({
                      type: "error",
                      title: "Delete Failed",
                      message: "Failed to delete project. Please try again.",
                      duration: 5000,
                    });
                  }

                  // Reset button state
                  if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="bx bx-trash mr-1"></i>Delete Project';
                  }
                });
            },
          },
        ],
      });
    } else {
      // Fallback confirmation if toast manager is not available
      if (confirm("Are you sure you want to delete this project? This action cannot be undone.")) {
        // Proceed with deletion using the same API call logic
        // (Implementation would be similar to the above)
      }
    }
  }

  // Form submission handler
  function handleFormSubmit(event: Event) {
    event.preventDefault();
    console.log("Form submission started");

    const form = event.target as HTMLFormElement;
    const formData = new FormData(form);
    const projectId = form.getAttribute("data-project-id");
    const isNewProject = form.getAttribute("data-is-new-project") === "true";

    // Collect form data
    const formValues: any = {};
    for (const [key, value] of formData.entries()) {
      formValues[key] = value;
    }

    // Convert checkbox values
    formValues.new_construction = formData.has("new_construction");

    // Parse JSON fields
    try {
      if (formValues.building) {
        formValues.building = JSON.parse(formValues.building);
      }
    } catch (e) {
      console.warn("Invalid JSON in building field");
    }

    try {
      if (formValues.project) {
        formValues.project = JSON.parse(formValues.project);
      }
    } catch (e) {
      console.warn("Invalid JSON in project field");
    }

    try {
      if (formValues.service) {
        formValues.service = JSON.parse(formValues.service);
      }
    } catch (e) {
      console.warn("Invalid JSON in service field");
    }

    try {
      if (formValues.requested_docs) {
        formValues.requested_docs = JSON.parse(formValues.requested_docs);
      }
    } catch (e) {
      console.warn("Invalid JSON in requested_docs field");
    }

    console.log("Form data:", formValues);

    // Determine API endpoint based on new/existing project
    const endpoint = isNewProject ? "/api/create-project" : `/api/update-project`;
    const method = isNewProject ? "POST" : "PUT";

    // Add project ID to form data for updates
    if (!isNewProject) {
      formValues.projectId = projectId;
    }

    // Show loading state
    const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

    if (!submitBtn) {
      console.error("Submit button not found");
      return;
    }

    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="bx bx-loader-alt bx-spin mr-1"></i>Saving...';

    // Submit form data
    fetch(endpoint, {
      method: method,
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(formValues),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to save project");
        }
        return response.json();
      })
      .then((data) => {
        console.log("Project saved successfully:", data);

        // Show success toast
        if ((window as any).toastAlertManager) {
          (window as any).toastAlertManager.show({
            type: "success",
            title: isNewProject ? "Project Created!" : "Project Updated!",
            message: isNewProject
              ? "Your new project has been created successfully."
              : "Your project has been updated successfully.",
            duration: 4000,
          });
        }

        // Redirect to project page if it's a new project
        if (isNewProject && data.id) {
          setTimeout(() => {
            window.location.href = `/project/${data.id}`;
          }, 1500); // Small delay to show the toast
        }
      })
      .catch((error) => {
        console.error("Error saving project:", error);

        // Show error toast
        if ((window as any).toastAlertManager) {
          (window as any).toastAlertManager.show({
            type: "error",
            title: "Save Failed",
            message: "Failed to save project. Please try again.",
            duration: 5000,
          });
        }
      })
      .finally(() => {
        // Reset button state
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
      });
  }

  // Helper function to show toast (fallback)
  function showToast(type: string, title: string, message: string) {
    if ((window as any).toastAlertManager) {
      (window as any).toastAlertManager.show({
        type,
        title,
        message,
        duration: 4000,
      });
    } else {
      // Fallback to console log if toast manager is not available
      console.log(`${type.toUpperCase()}: ${title} - ${message}`);
    }
  }
</script>