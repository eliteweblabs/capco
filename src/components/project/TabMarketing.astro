---
interface Props {
  project: any;
  currentUser?: any;
  secondaryTextClasses?: string;
  primaryTextClasses?: string;
  globalInputClasses?: string;
}

import SimpleIcon from "../common/SimpleIcon.astro";
import Button from "../common/Button.astro";
import StickyActions from "./StickyActions.astro";
import LoadingSpinner from "../ui/LoadingSpinner.astro";

const { project, currentUser, secondaryTextClasses, primaryTextClasses, globalInputClasses } =
  Astro.props;

const currentRole = currentUser?.profile?.role;
const isAdminOrStaff = currentRole === "Admin" || currentRole === "Staff";

// Only allow Admin/Staff to access this tab
if (!isAdminOrStaff) {
  return null;
}
---

<div
  id="content-marketing"
  class="tab-content shadow-lg p-4 color-background relative min-h-[calc(100dvh-24rem)] mb-16"
>
  <div class="space-y-6">
    <!-- Header -->
    <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
        <SimpleIcon name="palette" class="h-7 w-7 text-primary-600 dark:text-primary-400" />
        Marketing & Public Content
      </h2>
      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
        Manage public-facing images for this project's portfolio, microsite, and PDF generation.
        Images uploaded here will be stored in a public bucket.
      </p>
    </div>

    <!-- Featured Image Section -->
    <div class="space-y-4">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <SimpleIcon name="star" class="h-5 w-5 text-yellow-500" />
        Featured Image
      </h3>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        This image will appear as the main project image in the portfolio grid.
      </p>

      <!-- Featured Image URL Input -->
      <div class="space-y-3">
        <label
          for="featured-image-url"
          class="block text-sm font-medium text-gray-700 dark:text-gray-300"
        >
          Featured Image URL
        </label>
        <input
          type="url"
          id="featured-image-url"
          placeholder="https://example.com/image.jpg"
          class={`w-full ${globalInputClasses}`}
        />
        <p class="text-xs text-gray-500 dark:text-gray-400">
          Enter the URL of the image you want to feature. You can copy URLs from the gallery images
          below.
        </p>
      </div>

      <!-- Preview of Featured Image -->
      <div id="featured-image-preview" class="hidden">
        <img
          id="featured-image-preview-img"
          src=""
          alt="Featured image preview"
          class="w-full h-64 object-cover rounded-lg"
        />
      </div>
    </div>

    <!-- Gallery Images Section -->
    <div class="space-y-4 border-t border-gray-200 dark:border-gray-700 pt-6">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white flex items-center gap-2">
        <SimpleIcon name="images" class="h-5 w-5 text-primary-600" />
        Gallery Images
      </h3>
      <p class="text-sm text-gray-600 dark:text-gray-400">
        Additional images to showcase in the project gallery and PDF exports.
      </p>

      <!-- Upload Section -->
      <div
        id="marketing-upload-dropzone"
        class="cursor-pointer border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-8 text-center transition-colors hover:border-primary-400 dark:hover:border-primary-500 bg-gray-50 dark:bg-gray-800"
      >
        <div class="space-y-3">
          <SimpleIcon name="cloud-upload" class="mx-auto h-12 w-12 text-gray-400" />
          <div>
            <p class="font-medium text-gray-600 dark:text-gray-300">
              Drop marketing images here or click to browse
            </p>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
              Upload high-quality images for public display (max 10MB each)
            </p>
          </div>
          <Button icon="folder-open" iconPosition="left" variant="outline"> Browse Images </Button>
        </div>
        <input
          type="file"
          id="marketing-file-input"
          multiple
          accept="image/jpeg,image/jpg,image/png,image/webp,image/gif"
          class="hidden"
        />
      </div>

      <!-- Upload Progress -->
      <div id="marketing-upload-progress" class="hidden space-y-2">
        <div class="h-2 rounded-lg bg-gray-200 dark:bg-gray-700">
          <div
            id="marketing-progress-bar"
            class="h-2 rounded-lg bg-primary-600 transition-all duration-300"
            style="width: 0%"
          >
          </div>
        </div>
        <p id="marketing-upload-status" class="text-sm text-gray-600 dark:text-gray-400">
          Uploading...
        </p>
      </div>

      <!-- Gallery Grid -->
      <div
        id="gallery-images-container"
        class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"
      >
        <LoadingSpinner />
      </div>
    </div>

    <!-- Save Changes Button -->
    <StickyActions columns="1">
      <Button id="save-marketing-btn" variant="primary" size="lg" icon="check" iconPosition="right">
        Save Marketing Content
      </Button>
    </StickyActions>
  </div>
</div>

<script
  define:vars={{
    project,
    globalInputClasses,
    secondaryTextClasses,
    primaryTextClasses,
  }}
  is:inline
>
  const projectId = project?.id;
  const marketingBucket = "project-marketing"; // Public bucket for marketing images
  let featuredImageUrl = null;
  let galleryImages = [];

  async function initializeMarketing() {
    await loadMarketingImages();
    setupUploadHandlers();
    setupFeaturedImageInput();
  }

  async function loadMarketingImages() {
    try {
      // Fetch marketing images from the marketing bucket
      const response = await fetch(
        `/api/files/get?projectId=${projectId}&targetLocation=marketing&bucketName=${marketingBucket}&_t=${Date.now()}`,
        {
          cache: "no-cache",
          headers: {
            "Cache-Control": "no-cache, no-store, must-revalidate",
          },
        }
      );

      const data = await response.json();

      if (data.success) {
        galleryImages = (data.data || []).filter(
          (file) => file.fileType && file.fileType.includes("image")
        );

        // Get current featured image URL from project
        featuredImageUrl = project?.featuredImageUrl;

        // Set the input value
        const urlInput = document.getElementById("featured-image-url");
        if (urlInput && featuredImageUrl) {
          urlInput.value = featuredImageUrl;
          updateFeaturedImagePreview(featuredImageUrl);
        }

        renderGalleryImages();
      } else {
        console.error("❌ [MARKETING] Failed to load images:", data.error);
        showError("Failed to load marketing images");
      }
    } catch (error) {
      console.error("❌ [MARKETING] Error loading images:", error);
      showError("Error loading marketing images");
    }
  }

  function setupFeaturedImageInput() {
    const urlInput = document.getElementById("featured-image-url");

    if (urlInput) {
      // Update preview on input change
      urlInput.addEventListener("input", (e) => {
        const url = e.target.value.trim();
        updateFeaturedImagePreview(url);
      });
    }
  }

  function updateFeaturedImagePreview(url) {
    const previewContainer = document.getElementById("featured-image-preview");
    const previewImg = document.getElementById("featured-image-preview-img");

    if (!previewContainer || !previewImg) return;

    if (url && url.startsWith("http")) {
      previewImg.src = url;
      previewContainer.classList.remove("hidden");
    } else {
      previewContainer.classList.add("hidden");
    }
  }

  function renderGalleryImages() {
    const container = document.getElementById("gallery-images-container");
    if (!container) return;

    if (galleryImages.length === 0) {
      container.innerHTML = `
        <div class="col-span-full py-8 text-center text-gray-500 dark:text-gray-400">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          <p class="mt-2">No marketing images uploaded yet</p>
        </div>
      `;
      return;
    }

    const imageCards = galleryImages
      .map(
        (image) => `
      <div class="relative group rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-shadow">
        <img
          src="${image.publicUrl}"
          alt="${image.title || image.fileName}"
          class="w-full h-48 object-cover"
        />
        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all flex items-center justify-center gap-2">
          <button
            onclick="copyImageUrl('${image.publicUrl}')"
            class="opacity-0 group-hover:opacity-100 transition-opacity bg-blue-500 hover:bg-blue-600 text-white p-2 rounded-full"
            title="Copy image URL"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </button>
          <button
            onclick="deleteMarketingImage(${image.id}, '${image.fileName}')"
            class="opacity-0 group-hover:opacity-100 transition-opacity bg-red-500 hover:bg-red-600 text-white p-2 rounded-full"
            title="Delete image"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </button>
        </div>
        <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black to-transparent p-3">
          <p class="text-white text-sm font-medium truncate">${image.title || image.fileName}</p>
        </div>
      </div>
    `
      )
      .join("");

    container.innerHTML = imageCards;
  }

  function setupUploadHandlers() {
    const dropzone = document.getElementById("marketing-upload-dropzone");
    const fileInput = document.getElementById("marketing-file-input");
    const progressDiv = document.getElementById("marketing-upload-progress");
    const progressBar = document.getElementById("marketing-progress-bar");
    const statusText = document.getElementById("marketing-upload-status");

    dropzone?.addEventListener("click", () => fileInput?.click());

    dropzone?.addEventListener("dragover", (e) => {
      e.preventDefault();
      dropzone.classList.add("border-primary-400", "bg-primary-50");
    });

    dropzone?.addEventListener("dragleave", () => {
      dropzone.classList.remove("border-primary-400", "bg-primary-50");
    });

    dropzone?.addEventListener("drop", (e) => {
      e.preventDefault();
      dropzone.classList.remove("border-primary-400", "bg-primary-50");
      const files = Array.from(e.dataTransfer.files);
      if (files.length > 0) handleFileUpload(files);
    });

    fileInput?.addEventListener("change", (e) => {
      const files = Array.from(e.target.files);
      if (files.length > 0) handleFileUpload(files);
    });

    async function handleFileUpload(files) {
      // Filter to only images
      const imageFiles = files.filter((file) => file.type.startsWith("image/"));

      if (imageFiles.length === 0) {
        showError("Please upload only image files");
        return;
      }

      progressDiv?.classList.remove("hidden");
      progressBar.style.width = "0%";

      let uploadedCount = 0;
      const totalFiles = imageFiles.length;

      for (const file of imageFiles) {
        try {
          statusText.textContent = `Uploading ${file.name}...`;

          const reader = new FileReader();
          const fileData = await new Promise((resolve, reject) => {
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
          });

          const response = await fetch("/api/files/upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({
              mediaData: fileData,
              fileName: file.name,
              fileType: file.type,
              projectId: projectId.toString(),
              targetLocation: "marketing",
              bucketName: marketingBucket,
              title: file.name,
              description: "Marketing image",
            }),
          });

          if (!response.ok) {
            throw new Error("Upload failed");
          }

          uploadedCount++;
          const progress = (uploadedCount / totalFiles) * 100;
          progressBar.style.width = `${progress}%`;

          if (window.showNotice) {
            window.showNotice("success", `Uploaded ${file.name}`, "", 2000);
          }
        } catch (error) {
          console.error(`❌ [MARKETING] Error uploading ${file.name}:`, error);
          if (window.showNotice) {
            window.showNotice("error", `Failed to upload ${file.name}`, "", 3000);
          }
        }
      }

      setTimeout(() => {
        progressDiv?.classList.add("hidden");
        loadMarketingImages();
      }, 1000);

      // Reset file input
      if (fileInput) fileInput.value = "";
    }
  }

  window.copyImageUrl = async function (url) {
    try {
      await navigator.clipboard.writeText(url);

      // Also set it in the input field
      const urlInput = document.getElementById("featured-image-url");
      if (urlInput) {
        urlInput.value = url;
        updateFeaturedImagePreview(url);
      }

      if (window.showNotice) {
        window.showNotice(
          "success",
          "URL copied to clipboard",
          "The featured image field has been updated",
          2000
        );
      }
    } catch (error) {
      console.error("❌ [MARKETING] Error copying URL:", error);
      if (window.showNotice) {
        window.showNotice("error", "Failed to copy URL", "", 2000);
      }
    }
  };

  window.deleteMarketingImage = async function (imageId, fileName) {
    if (!window.showNotice) {
      if (!confirm(`Delete ${fileName}?`)) return;
    } else {
      window.showNotice(
        "error",
        "Delete Marketing Image",
        `Are you sure you want to delete "${fileName}"? This action cannot be undone.`,
        10000,
        [
          { label: "Cancel", action: () => {} },
          {
            label: "Delete",
            action: async () => {
              try {
                const response = await fetch("/api/files/delete", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    fileId: imageId,
                    projectId: projectId,
                    bucketName: marketingBucket,
                  }),
                });

                if (!response.ok) throw new Error("Delete failed");

                if (window.showNotice) {
                  window.showNotice("success", "Image deleted successfully", "", 2000);
                }

                await loadMarketingImages();
              } catch (error) {
                console.error("❌ [MARKETING] Error deleting image:", error);
                if (window.showNotice) {
                  window.showNotice("error", "Failed to delete image", "", 3000);
                }
              }
            },
          },
        ]
      );
      return;
    }
  };

  // Save marketing content
  document.getElementById("save-marketing-btn")?.addEventListener("click", async () => {
    try {
      const urlInput = document.getElementById("featured-image-url");
      const featuredUrl = urlInput?.value?.trim() || null;

      const response = await fetch("/api/projects/upsert", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          id: projectId,
          featuredImageUrl: featuredUrl,
        }),
      });

      const data = await response.json();

      if (data.success) {
        if (window.showNotice) {
          window.showNotice("success", "Marketing content saved successfully", "", 2000);
        }
      } else {
        throw new Error(data.error || "Failed to save");
      }
    } catch (error) {
      console.error("❌ [MARKETING] Error saving:", error);
      if (window.showNotice) {
        window.showNotice("error", "Failed to save marketing content", "", 3000);
      }
    }
  });

  function showError(message) {
    if (window.showNotice) {
      window.showNotice("error", message, "", 3000);
    } else {
      alert(message);
    }
  }

  document.addEventListener("DOMContentLoaded", initializeMarketing);
</script>
