---
import AuthIcon from "../common/AuthIcon.astro";
import Logo from "./Logo.astro";
import ToggleSidebar from "./ToggleSidebar.astro";
import BannerAlertsLoader from "../../features/banner-alert/components/BannerAlertsLoader.astro";
import ThemeToggle from "./ThemeToggle.astro";
import NotificationBellButton from "./NotificationBellButton.astro";
import PunchlistDrawerButton from "./PunchlistDrawerButton.astro";
import ShareWidget from "./ShareWidget.astro";

interface Props {
  currentUser?: any;
  session?: any;
  desktopNavigationHTML: string;
  project?: any;
  id?: string;
  projects?: any[];
  assignedProjectsCount?: number;
  assignedProjectsPreview?: any[];
  isBackend?: boolean;
  supabaseUrl?: string;
  globalIconButtonClasses?: string;
  /** Current pathname for banner alert page targeting */
  pathname?: string;
  /** Page template (layout) for tooltip: default | fullwidth | minimal | centered | fullscreen */
  template?: string;
  hideFooter?: boolean;
}

const {
  currentUser,
  session,
  desktopNavigationHTML,
  assignedProjectsCount = 0,
  assignedProjectsPreview = [],
  isBackend,
  project,
  globalIconButtonClasses,
  pathname,
  template,
  hideFooter = false,
} = Astro.props;
---

<!-- shadow when scrolled: light drop shadow, animated via .navbar-scrolled -->
<nav
  id="main-navbar"
  class="color-background navbar-at-top fixed left-0 right-0 transition-shadow duration-200 ease-out"
  style="top: max(0rem, env(safe-area-inset-top, 0px));"
>
  <!-- Top Banner Alerts (if any) -->
  <BannerAlertsLoader position="top" width="auto" {pathname} template={template} {hideFooter} />

  <!-- Main Navbar Content -->
  <div
    id="navbar-content"
    class="flex h-16 min-w-0 justify-between gap-1 py-3 transition-opacity duration-200"
  >
    <div
      class={`flex min-w-0 flex-shrink-0 items-center gap-1 ${!currentUser ? "md:pl-4" : "md:pl-1.5"}`}
    >
      <ToggleSidebar {currentUser} />
      <Logo link="/" file="svg" className="flex" />
    </div>

    {
      !isBackend && (
        <div class="mx-2 hidden min-w-0 max-w-xl flex-1 items-center md:flex" id="navbar-default">
          <ul
            class="flex w-full flex-row items-center justify-evenly font-medium"
            set:html={desktopNavigationHTML}
          />
        </div>
      )
    }

    <div class="flex flex-shrink-0 items-center gap-2 pr-4">
      <ShareWidget
        direction="left"
        globalIconButtonClasses={globalIconButtonClasses}
        isBackend={isBackend}
      />

      <PunchlistDrawerButton
        currentUser={currentUser}
        project={project}
        globalIconButtonClasses={globalIconButtonClasses}
      />
      <NotificationBellButton
        currentUser={currentUser}
        globalIconButtonClasses={globalIconButtonClasses}
      />

      <ThemeToggle {currentUser} {session} {isBackend} {globalIconButtonClasses} />

      <AuthIcon
        id="account"
        {project}
        {currentUser}
        {session}
        {isBackend}
        assignedProjectsCount={assignedProjectsCount}
        assignedProjectsPreview={assignedProjectsPreview}
        {globalIconButtonClasses}
      />
    </div>
  </div>
</nav>

<script is:inline>
  (function () {
    var SCROLL_THRESHOLD = 8;

    function initNavbarScrollShadow() {
      var scrollEl = document.getElementById("reveal-scroll");
      var navbar = document.getElementById("main-navbar");
      if (!scrollEl || !navbar) return;
      if (navbar.hasAttribute("data-navbar-scroll-shadow-bound")) return;
      navbar.setAttribute("data-navbar-scroll-shadow-bound", "true");

      function updateShadow() {
        if (scrollEl.scrollTop > SCROLL_THRESHOLD) {
          navbar.classList.add("navbar-scrolled");
        } else {
          navbar.classList.remove("navbar-scrolled");
        }
      }
      scrollEl.addEventListener("scroll", updateShadow, { passive: true });
      updateShadow();
    }

    function run() {
      initNavbarScrollShadow();

      var logoutBtn = document.getElementById("logout-btn");
      if (logoutBtn && !logoutBtn.hasAttribute("data-navbar-logout-bound")) {
        logoutBtn.setAttribute("data-navbar-logout-bound", "true");
        logoutBtn.addEventListener("click", function () {
          fetch("/api/auth/signout", { method: "POST" })
            .then(function (response) {
              if (response.ok) {
                var url = new URL(window.location.origin);
                url.searchParams.set("message", "logout_success");
                window.location.href = url.toString();
              } else {
                if (typeof window.showNotice === "function") {
                  window.showNotice(
                    "error",
                    "Logout Failed",
                    "There was an error logging out. Please try again.",
                    0
                  );
                } else {
                  alert("There was an error logging out. Please try again.");
                }
              }
            })
            .catch(function (err) {
              console.error("Logout error:", err);
            });
        });
      }

      var navbar = document.getElementById("main-navbar");
      if (navbar && !navbar.hasAttribute("data-navbar-modal-bound")) {
        navbar.setAttribute("data-navbar-modal-bound", "true");
        function isMobile() {
          return window.innerWidth < 768;
        }
        var observer = new MutationObserver(function () {
          if (!isMobile()) return;
          var modals = document.querySelectorAll('[id*="modal"]');
          var hasVisible = false;
          modals.forEach(function (modal) {
            if (!modal.classList.contains("hidden") && modal.classList.contains("flex"))
              hasVisible = true;
          });
          navbar.style.opacity = hasVisible ? "0" : "1";
          navbar.style.pointerEvents = hasVisible ? "none" : "auto";
        });
        observer.observe(document.body, {
          attributes: true,
          attributeFilter: ["class"],
          subtree: true,
          childList: true,
        });
        window.addEventListener("resize", function () {
          if (!isMobile() && navbar.style.opacity === "0") {
            navbar.style.opacity = "1";
            navbar.style.pointerEvents = "auto";
          }
        });
      }
    }
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
    else run();
    setTimeout(run, 400);
  })();
</script>
<style>
  /* z-100 only at top of page; z-50 when scrolled */
  #main-navbar {
    z-index: 50;
  }
  #main-navbar.navbar-at-top {
    z-index: 100;
  }

  /* Light drop shadow when page has scrolled (animated via transition-shadow on nav) */
  #main-navbar.navbar-scrolled {
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.07);
  }
  :global(.dark) #main-navbar.navbar-scrolled {
    box-shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.05);
  }

  :global(#navbar-default a svg) {
    display: none;
  }
</style>
