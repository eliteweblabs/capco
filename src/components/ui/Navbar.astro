---
// Fixed Flowbite Navbar Component with proper Tailwind classes
import AssignedProjects from "../common/AssignedProjects.astro";
import AuthIcon from "../common/AuthIcon.astro";
import Button from "../common/Button.astro";
import Logo from "./Logo.astro";
import ProjectSearch from "../project/ProjectSearch.astro";
import Punchlist from "../project/Punchlist.astro";
import ToggleSidebar from "./ToggleSidebar.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import SearchForm from "../common/SearchForm.astro";
import NotificationDropdown from "../common/NotificationDropdown.astro";
import ThemeToggle from "./ThemeToggle.astro";
import BannerAlertsLoader from "../../features/banner-alert/components/BannerAlertsLoader.astro";

interface Props {
  currentUser?: any;
  session?: any;
  desktopNavigationHTML: string;
  project?: any;
  id?: string;
  projects?: any[];
  isBackend?: boolean;
  supabaseUrl?: string;
}

const {
  currentUser,
  session,
  desktopNavigationHTML,
  id,
  projects,
  isBackend,
  supabaseUrl,
  project,
} = Astro.props;

const currentUrl = Astro.url.pathname;

const isAuth = currentUser ? true : false;
const currentRole = currentUser?.profile?.role;
---

<nav class=`flex flex-col w-full z-50 fixed top-0 left-0 right-0 color-background`>
  <!-- Top Banner Alerts (if any) -->
  <BannerAlertsLoader position="top" />

  <!-- Main Navbar Content -->
  <div
    class="flex w-full gap-2 px-2 py-4 items-center justify-between border-b h-16 color-border color-background"
  >
    <ToggleSidebar {currentUser} />
    <div
      class=`flex w-full items-center justify-between ${!currentUser ? "max-w-screen-xl mx-auto" : ""}`
    >
      <div class="flex-start flex items-center">
        <Logo link="/" file="svg" className="mr-4 flex" />
      </div>

      {
        !isBackend && (
          <div class="hidden w-full md:block md:w-auto" id="navbar-default">
            <ul
              class="mt-4 flex flex-col font-medium md:mt-0 md:flex-row md:space-x-8 md:border-0 md:p-0 rtl:space-x-reverse"
              set:html={desktopNavigationHTML}
            />
          </div>
        )
      }
      <!-- Search -->
      {
        currentUrl === "/project/dashboard" && currentRole !== "Client" && (
          <ProjectSearch projects={projects} />
        )
      }

      <div class="flex items-center gap-2">
        <!-- Notification Bell -->
        {
          currentUser && currentUser.id && currentRole !== "Client" && (
            <button
              id="notification-bell"
              class="inline-flex items-center rounded-lg p-2 text-center text-sm font-medium text-gray-500 hover:bg-gray-100 hover:text-gray-900 focus:outline-none focus:ring-4 focus:ring-gray-50 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white dark:focus:ring-gray-600"
              data-modal-target="notificationsModal"
              data-modal-toggle="notificationsModal"
            >
              <SimpleIcon name="bell" class="mr-2" />
            </button>
          )
        }

        {
          project && (
            <Punchlist currentUser={currentUser} supabaseUrl={supabaseUrl} project={project} />
          )
        }

        <ThemeToggle />

        <AuthIcon {currentUser} {session} {isBackend} />
      </div>
    </div>
  </div>
</nav>

<script>
  const logoutBtn = document.getElementById("logout-btn") as HTMLButtonElement;

  // Logout functionality (only if logout button exists - when authenticated)
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      // console.log("ðŸ“‹ [HEADER] Logout button clicked");
      try {
        // console.log("ðŸ“‹ [HEADER] Sending logout request...");
        const response = await fetch("/api/auth/signout", {
          method: "POST",
        });
        // console.log("ðŸ“‹ [HEADER] Logout response status:", response.status);

        if (response.ok) {
          // console.log("ðŸ“‹ [HEADER] Logout successful, redirecting...");

          // Simple redirect to home page with success message
          const url = new URL(window.location.origin);
          url.searchParams.set("message", "logout_success");
          window.location.href = url.toString();
        } else {
          // console.error("ðŸ“‹ [HEADER] Logout failed with status:", response.status);

          // Show error modal if logout fails
          if (typeof window.showModal === "function") {
            window.showModal(
              "error",
              "Logout Failed",
              "There was an error logging out. Please try again.",
              0 // No auto-hide for errors
            );
          } else {
            // Fallback if showModal is not available
            alert("There was an error logging out. Please try again.");
          }
        }
      } catch (error) {
        console.error("ðŸ“‹ [HEADER] Logout error:", error);
      }
    });
  }
</script>
<style>
  :global(#navbar-default a svg) {
    display: none;
  }
</style>
