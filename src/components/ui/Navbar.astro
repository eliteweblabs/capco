---
import AuthIcon from "../common/AuthIcon.astro";
import Logo from "./Logo.astro";
import ToggleSidebar from "./ToggleSidebar.astro";
import BannerAlertsLoader from "../../features/banner-alert/components/BannerAlertsLoader.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import ThemeToggle from "./ThemeToggle.astro";
import MultiStepForm from "../form/MultiStepForm.astro";
import { loginFormConfig } from "../../lib/forms/login-form-config";
const redirectUrl = Astro.url.searchParams.get("redirect") || "/project/dashboard";

interface Props {
  currentUser?: any;
  session?: any;
  desktopNavigationHTML: string;
  project?: any;
  id?: string;
  projects?: any[];
  isBackend?: boolean;
  supabaseUrl?: string;
  globalIconButtonClasses?: string;
  /** Current pathname for banner alert page targeting */
  pathname?: string;
  /** Page template (layout) for tooltip: default | fullwidth | minimal | centered | fullscreen */
  template?: string;
  hideFooter?: boolean;
}

const {
  currentUser,
  session,
  desktopNavigationHTML,
  projects,
  isBackend,
  supabaseUrl,
  project,
  globalIconButtonClasses,
  pathname,
  template = "default",
  hideFooter = false,
} = Astro.props;
const currentRole = currentUser?.profile?.role;
---

<nav
  id="main-navbar"
  class="navbar-at-top fixed left-0 right-0 shadow-[0_4px_6px_-1px_rgba(0,0,0,0.07)] dark:shadow-[0_4px_6px_-1px_rgba(255,255,255,0.05)]"
  style="top: max(0rem, env(safe-area-inset-top, 0px)); transform: translateZ(0); -webkit-backface-visibility: hidden; backface-visibility: hidden;"
>
  <!-- Top Banner Alerts (if any) -->
  <BannerAlertsLoader position="top" width="auto" {pathname} {hideFooter} />

  <!-- Main Navbar Content -->
  <div
    id="navbar-content"
    class="color-background flex h-16 min-w-0 justify-between gap-1 px-4 py-3 transition-opacity duration-200 shadow-primary-md"
  >
    <div class="flex min-w-0 flex-shrink-0 items-center gap-1">
      <ToggleSidebar {currentUser} />

      <Logo link="/" file="svg" className="mr-2 flex md:mr-4" />
    </div>

    {
      !isBackend && (
        <div class="mx-2 hidden min-w-0 max-w-3xl flex-1 md:block" id="navbar-default">
          <ul
            class="flex flex-row items-center justify-evenly font-medium"
            set:html={desktopNavigationHTML}
          />
        </div>
      )
    }

    <div class="flex flex-shrink-0 items-center gap-2">
      {
        currentUser && currentUser.id && currentRole !== "Client" && project && (
          <button
            type="button"
            id="punchlist-drawer-toggle"
            title="View Punchlist"
            class={globalIconButtonClasses}
          >
            <SimpleIcon name="menu-check" size="md" />
            <span class="sr-only">View Punchlist</span>
          </button>
        )
      }
      {
        currentUser && (
          <button
            type="button"
            title="Notifications"
            data-dropdown-toggle="notification-dropdown"
            data-dropdown-trigger="hover"
            class={globalIconButtonClasses}
            aria-label="View notifications"
          >
            <SimpleIcon name="notification-bell" size="md" />
            <span class="sr-only">Notifications</span>
          </button>
        )
      }

      <ThemeToggle {currentUser} {session} {isBackend} {projects} {globalIconButtonClasses} />

      <AuthIcon
        id="account"
        {currentUser}
        {session}
        {isBackend}
        {projects}
        {globalIconButtonClasses}
      />

      <button
        data-popover-target="popover-company-profile"
        data-popover-trigger="click"
        type="button"
        class="bg-brand hover:bg-brand-strong focus:ring-brand-medium shadow-xs rounded-base box-border border border-transparent px-4 py-2.5 text-sm font-medium leading-5 text-white focus:outline-none focus:ring-4"
        >Cole</button
      >

      <div
        data-popover
        id="popover-company-profile"
        role="tooltip"
        class="bg-neutral-primary-soft border-default rounded-base shadow-xs invisible absolute z-10 inline-block w-80 border text-body text-sm opacity-0 transition-opacity duration-300"
      >
        <div class="p-3">
          <div class="flex">
            <div class="me-3 shrink-0">
              <button
                type="button"
                class="bg-neutral-tertiary block flex h-10 w-10 items-center justify-center rounded p-2"
              >
                <img
                  class="h-8 w-8 rounded-full"
                  src="https://flowbite.com/docs/images/logo.svg"
                  alt="Flowbite logo"
                />
              </button>
            </div>

            <div>
              <MultiStepForm
                config={loginFormConfig}
                initialData={{ redirect: redirectUrl }}
                testNoCascade={true}
              />
            </div>
          </div>
        </div>
        <div data-popper-arrow></div>
      </div>
    </div>
  </div>
</nav>

<script>
  const logoutBtn = document.getElementById("logout-btn") as HTMLButtonElement;

  // Logout functionality (only if logout button exists - when authenticated)
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      // console.log("ðŸ“‹ [HEADER] Logout button clicked");
      try {
        // console.log("ðŸ“‹ [HEADER] Sending logout request...");
        const response = await fetch("/api/auth/signout", {
          method: "POST",
        });
        // console.log("ðŸ“‹ [HEADER] Logout response status:", response.status);

        if (response.ok) {
          // console.log("ðŸ“‹ [HEADER] Logout successful, redirecting...");

          // Simple redirect to home page with success message
          const url = new URL(window.location.origin);
          url.searchParams.set("message", "logout_success");
          window.location.href = url.toString();
        } else {
          // console.error("ðŸ“‹ [HEADER] Logout failed with status:", response.status);

          // Show error modal if logout fails
          if (typeof window.showNotice === "function") {
            window.showNotice(
              "error",
              "Logout Failed",
              "There was an error logging out. Please try again.",
              0 // No auto-hide for errors
            );
          } else {
            // Fallback if showNotice is not available
            alert("There was an error logging out. Please try again.");
          }
        }
      } catch (error) {
        console.error("ðŸ“‹ [HEADER] Logout error:", error);
      }
    });
  }

  // Hide navbar on mobile when modals open
  function setupNavbarHideOnModal() {
    const navbar = document.getElementById("main-navbar");
    if (!navbar) return;

    // Check if device is mobile (screen width < 768px)
    function isMobile() {
      return window.innerWidth < 768;
    }

    // Observe for modal visibility changes
    const observer = new MutationObserver((mutations) => {
      if (!isMobile()) return;

      // Check if any modal is visible
      const modals = document.querySelectorAll('[id*="modal"]');
      let hasVisibleModal = false;

      modals.forEach((modal) => {
        const isVisible = !modal.classList.contains("hidden") && modal.classList.contains("flex");
        if (isVisible) {
          hasVisibleModal = true;
        }
      });

      // Hide or show navbar based on modal visibility
      if (hasVisibleModal) {
        navbar.style.opacity = "0";
        navbar.style.pointerEvents = "none";
      } else {
        navbar.style.opacity = "1";
        navbar.style.pointerEvents = "auto";
      }
    });

    // Observe the body for modal changes
    observer.observe(document.body, {
      attributes: true,
      attributeFilter: ["class"],
      subtree: true,
      childList: true,
    });

    // Also listen for window resize to re-check mobile status
    window.addEventListener("resize", () => {
      if (!isMobile() && navbar.style.opacity === "0") {
        navbar.style.opacity = "1";
        navbar.style.pointerEvents = "auto";
      }
    });
  }

  // navbar-at-top is synced by BannerAlertsLoader's reveal-scroll logic: translateY 0 === at top (all screens)

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupNavbarHideOnModal);
  } else {
    setupNavbarHideOnModal();
  }
</script>
<style>
  /* z-100 only at top of page; z-50 when scrolled */
  #main-navbar {
    z-index: 50;
  }
  #main-navbar.navbar-at-top {
    z-index: 100;
  }

  :global(#navbar-default a svg) {
    display: none;
  }
</style>
