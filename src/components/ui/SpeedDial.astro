---
import { checkAuth } from "../../lib/auth";
const { currentUser } = await checkAuth(Astro.cookies);

const { globalCompanyPhone } = Astro.props;
const buttonClasses =
  "flex h-12 w-12 items-center justify-center rounded-full bg-primary-700 text-white shadow-xs hover:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800";

const currentRole = currentUser?.profile?.role;
import SimpleIcon from "../common/SimpleIcon.astro";
---

<div id="speed-dial" class="group">
  <div
    id="speed-dial-menu"
    popover="auto"
    class="speed-dial-menu mb-4 flex flex-col items-center space-y-2"
  >
    {
      currentUser && (
        <button
          id="tutorial-trigger"
          type="button"
          title="Start Tutorial"
          aria-label="Start Tutorial"
          class={buttonClasses}
        >
          <SimpleIcon name="book" size="lg" />
        </button>
      )
    }

    {
      currentRole === "Admin" && (
        <button
          id="debug-toggle-btn"
          type="button"
          title="Debug Panel (Admin Only)"
          aria-label="Debug Panel (Admin Only)"
          class={buttonClasses}
        >
          <SimpleIcon name="bug" size="lg" />
        </button>
      )
    }

    {
      !currentUser && (
        <>
          <button
            id="register-toggle-btn"
            type="button"
            title="Register"
            aria-label="Register"
            onclick="window.location.href='/auth/register'"
            class={buttonClasses}
          >
            <SimpleIcon name="user-plus" size="lg" />
          </button>

          <button
            id="login-toggle-btn"
            type="button"
            title="Login"
            aria-label="Login"
            onclick="window.location.href='/auth/login'"
            class={buttonClasses}
          >
            <SimpleIcon name="user" size="lg" />
          </button>
        </>
      )
    }

    <button
      id="phone-call-btn"
      type="button"
      title="Call Us"
      aria-label="Call Us"
      onclick={`window.location.href='tel:${globalCompanyPhone}'`}
      class={buttonClasses}
    >
      <SimpleIcon name="phone" size="lg" />
    </button>

    {
      currentUser && (
        <button
          id="feedback-button"
          type="button"
          title="Feedback"
          aria-label="Open feedback form"
          class={buttonClasses}
        >
          <SimpleIcon name="comment-dots" size="lg" />
        </button>
      )
    }

    <button
      id="contact-toggle-btn"
      type="button"
      title="Contact"
      aria-label="Contact"
      onclick="window.location.href='/contact'"
      class={buttonClasses}
    >
      <SimpleIcon name="message-square" size="lg" />
    </button>
  </div>

  <button
    type="button"
    class="speed-dial-trigger-btn h-14 w-14 sm:h-12 sm:w-12 inline-flex items-center justify-center rounded-full border border-gray-300 bg-white px-5 py-2.5 text-sm font-medium text-gray-900 hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:hover:bg-gray-700 dark:focus:ring-gray-700 [@media(hover:hover)]:hover:translate-y-0"
    popovertarget="speed-dial-menu"
    popovertargetaction="toggle"
    aria-label="Open actions menu"
  >
    <SimpleIcon name="plus" size="md" class="icon-default" />
    <span class="sr-only">Open actions menu</span>
  </button>
</div>

<script is:inline>
  (function () {
    const tutorialButton = document.getElementById("tutorial-trigger");
    if (tutorialButton) {
      const hasTutorials = document.querySelectorAll("[data-welcome]").length > 0 || document.body.getAttribute("data-has-tutorials") === "true";
      if (!hasTutorials) tutorialButton.style.display = "none";
    }

    function positionSpeedDialMenu() {
      const trigger = document.querySelector(".speed-dial-trigger-btn");
      const menu = document.getElementById("speed-dial-menu");
      if (!trigger || !menu || !menu.matches(":popover-open")) return;
      var rect = trigger.getBoundingClientRect();
      menu.style.top = (rect.top - 8) + "px";
      menu.style.left = rect.left + "px";
      menu.style.transformOrigin = "bottom center";
    }

    function initSpeedDial() {
      const trigger = document.querySelector(".speed-dial-trigger-btn");
      const menu = document.getElementById("speed-dial-menu");
      const container = document.getElementById("speed-dial");
      if (!trigger || !menu) return;

      menu.addEventListener("toggle", function () {
        if (menu.matches(":popover-open")) {
          requestAnimationFrame(positionSpeedDialMenu);
          setTimeout(positionSpeedDialMenu, 50);
        }
      });

      const useHover = window.matchMedia("(hover: hover)").matches;

      if (useHover) {
        trigger.addEventListener("mouseenter", function () {
          if (!menu.matches(":popover-open")) menu.showPopover();
        });
        container.addEventListener("mouseleave", function () {
          if (menu.matches(":popover-open")) menu.hidePopover();
        });
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", initSpeedDial);
    } else {
      initSpeedDial();
    }

    function checkTutorials() {
      const hasTutorials = document.body.getAttribute("data-has-tutorials") === "true";
      const tutorialButton = document.getElementById("tutorial-trigger");
      const parent = tutorialButton?.parentElement;
      if (parent && !hasTutorials) parent.style.display = "none";
    }
    checkTutorials();
    window.addEventListener("tutorials-loaded", checkTutorials);
  })();
</script>

<style>
  .speed-dial-menu[popover] {
    position: fixed;
    transform: scale(0.8);
    opacity: 0;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
  }
  .speed-dial-menu[popover]:popover-open {
    transform: scale(1);
    opacity: 1;
  }
  .speed-dial-menu[popover] > * {
    transform: scale(0.8);
    opacity: 0;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
  }
  .speed-dial-menu[popover]:popover-open > *:nth-child(1) { transition-delay: 0ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(2) { transition-delay: 40ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(3) { transition-delay: 80ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(4) { transition-delay: 120ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(5) { transition-delay: 160ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(6) { transition-delay: 200ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(7) { transition-delay: 240ms; }
  .speed-dial-menu[popover]:popover-open > *:nth-child(8) { transition-delay: 280ms; }
  .speed-dial-menu[popover]:popover-open > * {
    transform: scale(1);
    opacity: 1;
  }

  [popover]:popover-open + .speed-dial-trigger-btn svg {
    transform: rotate(45deg);
    transition: transform 0.2s ease;
  }

  .speed-dial-trigger-btn svg.icon-default {
    stroke: currentColor;
    stroke-width: 2;
  }
</style>
