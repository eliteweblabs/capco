---
import { checkAuth } from "../../lib/auth";
const { currentUser } = await checkAuth(Astro.cookies);

const { globalCompanyPhone } = Astro.props;
const buttonClasses =
  "flex h-12 w-12 items-center justify-center rounded-full bg-primary-700 text-white shadow-xs hover:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800";

const currentRole = currentUser?.profile?.role;
import SimpleIcon from "../common/SimpleIcon.astro";
import Tooltip from "./Tooltip.astro";
import Button from "../common/Button.astro";
// Speed dial component for quick actions
---

<div id="speed-dial" class="group">
  <div
    id="speed-dial-menu"
    class="speed-dial-menu mb-4 flex hidden flex-col items-center space-y-2"
  >
    {
      currentUser && (
        <Tooltip position="left" text="Tutorial" className="speed-dial-tooltip" dismissable={false}>
          <button
            id="tutorial-trigger"
            type="button"
            title="Start Tutorial"
            aria-label="Start Tutorial"
            class={buttonClasses}
          >
            <SimpleIcon name="book" size="lg" />
          </button>
        </Tooltip>
      )
    }

    {
      currentUser && currentRole === "Admin" && (
        <Tooltip position="left" text="Debug" className="speed-dial-tooltip" dismissable={false}>
          <button
            id="debug-toggle-btn"
            type="button"
            title="Debug Panel (Admin Only)"
            aria-label="Debug Panel (Admin Only)"
            class={buttonClasses}
          >
            <SimpleIcon name="bug" size="lg" />
          </button>
        </Tooltip>
      )
    }

    {
      !currentUser && (
        <>
          <Tooltip
            position="left"
            text="Register"
            className="speed-dial-tooltip"
            dismissable={false}
          >
            <button
              id="register-toggle-btn"
              type="button"
              title="Login"
              aria-label="Login"
              onclick="window.location.href='/auth/register'"
              class={buttonClasses}
            >
              <SimpleIcon name="user-plus" size="lg" />
            </button>
          </Tooltip>

          <Tooltip position="left" text="Login" className="speed-dial-tooltip" dismissable={false}>
            <button
              id="login-toggle-btn"
              type="button"
              title="Login"
              aria-label="Login"
              onclick="window.location.href='/auth/login'"
              class={buttonClasses}
            >
              <SimpleIcon name="user" size="lg" />
            </button>
          </Tooltip>
        </>
      )
    }

    <Tooltip position="left" text={`Call`} className="speed-dial-tooltip" dismissable={false}>
      <button
        id="phone-call-btn"
        type="button"
        title="Call Us"
        aria-label="Call Us"
        onclick={`window.location.href='tel:${globalCompanyPhone}'`}
        class={buttonClasses}
      >
        <SimpleIcon name="phone" size="lg" />
      </button>
    </Tooltip>

    {
      currentUser && (
        <Tooltip position="left" text="Feedback" className="speed-dial-tooltip" dismissable={false}>
          <button
            id="feedback-button"
            type="button"
            title="Feedback"
            aria-label="Open feedback form"
            class={buttonClasses}
          >
            <SimpleIcon name="comment-dots" size="lg" />
          </button>
        </Tooltip>
      )
    }

    <Tooltip position="left" text="Contact" className="speed-dial-tooltip" dismissable={false}>
      <button
        id="contact-toggle-btn"
        type="button"
        title="Contact"
        aria-label="Contact"
        onclick="window.location.href='/contact'"
        class={buttonClasses}
      >
        <SimpleIcon name="message-square" size="lg" />
      </button>
    </Tooltip>
  </div>

  <Button
    type="button"
    variant="secondary"
    icon="plus"
    iconClasses="mr-0 shrink-0"
    size="md"
    class="speed-dial-trigger-btn h-14 w-14 rounded-full sm:h-12 sm:w-12 [@media(hover:hover)]:hover:translate-y-0"
    dataAttributes={{
      "data-dial-toggle": "speed-dial-menu",
    }}
  >
    <span class="sr-only">Open actions menu</span>
  </Button>
</div>

<script is:inline>
  const tutorials = document.querySelectorAll("[data-welcome]");
  const tutorialButton = document.getElementById("tutorial-trigger");

  if (tutorialButton && tutorials.length === 0) {
    tutorialButton.style.display = "none";
  }

  function initSpeedDial() {
    const speedDialButton = document.querySelector('[data-dial-toggle="speed-dial-menu"]');
    const speedDialMenu = document.getElementById("speed-dial-menu");
    const speedDial = document.getElementById("speed-dial");
    // const speedDialOverlay = document.getElementById("global-backdrop");

    let isOpen = false;
    let isTouchDevice = false;
    let touchHandled = false;

    // Detect if device supports touch
    if ("ontouchstart" in window || navigator.maxTouchPoints > 0) {
      isTouchDevice = true;
    }

    // Toggle function
    function toggleSpeedDial() {
      isOpen = !isOpen;
      const svg = speedDialButton?.querySelector("svg");

      if (isOpen) {
        speedDialMenu?.classList.remove("hidden");
        speedDialButton?.setAttribute("aria-expanded", "true");
        if (svg) {
          svg.style.transform = "rotate(45deg)";
          svg.style.transition = "transform 0.2s ease";
        }
        // Trigger staggered animation on menu items
        requestAnimationFrame(() => {
          speedDialMenu?.classList.add("speed-dial-open");
        });

        // Wait for menu to settle, then show tooltips with simple inline positioning (no import - script is inlined in SSR, browser cannot resolve @floating-ui/dom)
        requestAnimationFrame(() => {
          setTimeout(() => {
            const tooltips = speedDialMenu?.querySelectorAll(".speed-dial-tooltip");
            if (tooltips) {
              const tooltipsArray = Array.from(tooltips).reverse();

              tooltipsArray.forEach((tooltipWrapper, index) => {
                const tooltipContent = tooltipWrapper.querySelector(".tooltip-content");
                if (tooltipContent) {
                  setTimeout(() => {
                    tooltipContent.classList.remove("opacity-0");
                    tooltipContent.classList.add("opacity-100");
                    tooltipContent.style.pointerEvents = "auto";

                    const trigger = tooltipWrapper.firstElementChild;
                    const preferredPosition =
                      tooltipWrapper.getAttribute("data-tooltip-position") || "left";

                    if (trigger) {
                      const wrapper = tooltipWrapper;
                      const wr = wrapper.getBoundingClientRect();
                      const tr = trigger.getBoundingClientRect();
                      const tc = tooltipContent.getBoundingClientRect();
                      const offset = 8;
                      if (preferredPosition === "left") {
                        tooltipContent.style.left = `${tr.left - wr.left - tc.width - offset}px`;
                        tooltipContent.style.top = `${tr.top - wr.top + tr.height / 2 - tc.height / 2}px`;
                      } else {
                        tooltipContent.style.left = `${tr.right - wr.left + offset}px`;
                        tooltipContent.style.top = `${tr.top - wr.top + tr.height / 2 - tc.height / 2}px`;
                      }
                      tooltipContent.setAttribute("data-popper-placement", preferredPosition);
                    }
                  }, index * 100); // 100ms stagger between each tooltip
                }
              });
            }
          }, 50); // 50ms base delay for menu to settle
        });
      } else {
        // Hide tooltips immediately when closing
        const tooltips = speedDialMenu?.querySelectorAll(".speed-dial-tooltip .tooltip-content");
        tooltips?.forEach((tooltip) => {
          tooltip.classList.remove("opacity-100");
          tooltip.classList.add("opacity-0");
          tooltip.style.pointerEvents = "none";
        });

        speedDialMenu?.classList.remove("speed-dial-open");
        speedDialMenu?.classList.add("hidden");
        speedDialButton?.setAttribute("aria-expanded", "false");
        if (svg) {
          svg.style.transform = "rotate(0deg)";
          svg.style.transition = "transform 0.2s ease";
        }
      }
    }

    // Hide function
    function hideSpeedDial() {
      if (isOpen) {
        isOpen = false;

        // Hide tooltips immediately
        const tooltips = speedDialMenu?.querySelectorAll(".speed-dial-tooltip .tooltip-content");
        tooltips?.forEach((tooltip) => {
          tooltip.classList.remove("opacity-100");
          tooltip.classList.add("opacity-0");
          tooltip.style.pointerEvents = "none";
        });

        speedDialMenu?.classList.add("hidden");
        // speedDialOverlay?.classList.add("hidden");
        speedDialButton?.setAttribute("aria-expanded", "false");
        const svg = speedDialButton?.querySelector("svg");
        if (svg) {
          svg.style.transform = "rotate(0deg)";
          svg.style.transition = "transform 0.2s ease";
        }
      }
    }

    // Handle button interaction - works for both touch and click
    if (speedDialButton) {
      // Touch event handler for mobile
      speedDialButton.addEventListener(
        "touchstart",
        function (e) {
          touchHandled = true;
          e.stopPropagation();
          e.preventDefault(); // Prevent click from firing
          toggleSpeedDial();
          // Reset flag after a delay to allow click as fallback if needed
          setTimeout(() => {
            touchHandled = false;
          }, 400);
        },
        { passive: false }
      );

      // Click event handler for mobile only (fallback if touchstart doesn't work)
      // Desktop uses hover, so we skip click handler on non-touch devices
      if (isTouchDevice) {
        speedDialButton.addEventListener(
          "click",
          function (e) {
            // If touch was just handled, ignore this click to prevent double-firing
            if (touchHandled) {
              e.preventDefault();
              e.stopPropagation();
              return;
            }
            e.stopPropagation();
            toggleSpeedDial();
          },
          true
        ); // Use capture phase to handle before document click
      }
    }

    // Desktop hover behavior (only on non-touch devices)
    if (!isTouchDevice) {
      speedDialButton?.addEventListener("mouseenter", function (e) {
        e.stopPropagation();
        // Only auto-open on hover if not already open (prevents flickering)
        if (!isOpen) {
          toggleSpeedDial();
        }
      });

      // Desktop hover behavior - close when mouse leaves entire speed dial area
      speedDial?.addEventListener("mouseleave", function (e) {
        e.stopPropagation();
        // Only auto-close on hover if open (prevents flickering)
        if (isOpen) {
          toggleSpeedDial();
        }
      });
    }

    // Hide when clicking outside (works for both desktop and mobile)
    document.addEventListener("click", function (e) {
      // Don't close if touch was just handled (prevents immediate close on mobile)
      if (touchHandled) {
        return;
      }
      if (!speedDial?.contains(e.target)) {
        hideSpeedDial();
      }
    });

    // Hide when clicking on the overlay
    // speedDialOverlay?.addEventListener("click", function (e) {
    //   e.stopPropagation();
    //   hideSpeedDial();
    // });

    // Hide when pressing Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        hideSpeedDial();
      }
    });

    // Prevent menu clicks from closing the dial (desktop hover)
    speedDialMenu?.addEventListener("mouseover", function (e) {
      e.stopPropagation();
    });

    // Allow all buttons and links in the menu to work properly
    // Stop propagation so document click handler doesn't interfere
    speedDialMenu?.addEventListener("click", function (e) {
      // Allow the click to proceed but prevent it from bubbling to document handler
      e.stopPropagation();

      // If it's a button or link, let the browser handle it naturally
      const target = e.target;
      const button = target.closest("button, a");

      if (button) {
        // Let the button's onclick or href work naturally
        // The stopPropagation above prevents the document click handler from hiding the menu
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSpeedDial);
  } else {
    initSpeedDial();
  }

  // Check for tutorials on load and hide tutorial button if none exist
  function checkTutorials() {
    const hasTutorials = document.body.getAttribute("data-has-tutorials") === "true";
    const tutorialButton = document.getElementById("tutorial-trigger");
    const tutorialButtonParent = tutorialButton ? tutorialButton.parentElement : null;

    if (tutorialButtonParent && !hasTutorials) {
      tutorialButtonParent.style.display = "none";
    }
  }

  // Check immediately and on tutorial load event
  checkTutorials();
  window.addEventListener("tutorials-loaded", checkTutorials);
</script>

<style>
  /* Staggered animation for menu items when dial opens */
  .speed-dial-menu .speed-dial-tooltip {
    transform: scale(0.8) translateY(4px);
    opacity: 0;
    transition:
      opacity 0.2s ease,
      transform 0.2s ease;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip {
    transform: scale(1) translateY(0);
    opacity: 1;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(1) {
    transition-delay: 0ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(2) {
    transition-delay: 40ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(3) {
    transition-delay: 80ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(4) {
    transition-delay: 120ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(5) {
    transition-delay: 160ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(6) {
    transition-delay: 200ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(7) {
    transition-delay: 240ms;
  }
  .speed-dial-menu.speed-dial-open .speed-dial-tooltip:nth-child(8) {
    transition-delay: 280ms;
  }

  /* Ensure plus icon stroke is visible (inherits button text color) */
  .speed-dial-trigger-btn svg.icon-default {
    stroke: currentColor;
    stroke-width: 2;
  }
</style>
