---
import StickySMS from "../../features/sms/components/StickySMS.astro";
import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);

const { globalCompanyPhone, globalCompanyName } = Astro.props;

const currentRole = currentUser?.profile?.role;
import Button from "../common/Button.astro";
import Tooltip from "../common/Tooltip.astro";
const buttonClasses = "shadow-xs h-12 w-12 p-0";
// Speed dial component for quick actions
---

<!-- Blur overlay for small screens -->
<div
  id="speed-dial-overlay"
  class="fixed inset-0 z-[9999] hidden backdrop-blur-sm bg-black/20 md:hidden"
>
</div>

<div
  id="speed-dial"
  data-dial-init
  class="hide-on-form-focus group fixed"
  style="bottom: 1.5rem; right: 1.5rem; z-index: 10000"
>
  <div id="speed-dial-menu" class="mb-4 flex hidden flex-col items-center space-y-2">
    {
      currentUser && (
        <Tooltip position="left" open={true} text="Tutorial" className="-translate-y-2.5">
          <Button
            id="tutorial-trigger"
            type="button"
            title="Start Tutorial"
            iconClasses="mr-0"
            class="p-0"
            icon="book"
            iconPosition="left"
            size="lg"
            class={buttonClasses}
            dataAttributes={{ "aria-label": "Start Tutorial" }}
          />
        </Tooltip>
      )
    }

    {
      currentRole === "Admin" && (
        <Tooltip position="left" open={true} text="Debug" className="-translate-y-2.5">
          <Button
            id="debug-toggle-btn"
            type="button"
            icon="bug"
            iconClasses="mr-0"
            iconPosition="left"
            size="lg"
            class={buttonClasses}
            title="Debug Panel (Admin Only)"
            dataAttributes={{ "aria-label": "Debug Panel (Admin Only)" }}
          />
        </Tooltip>
      )
    }

    {
      !currentUser && (
        <Tooltip position="left" open={true} text="Login" className="-translate-y-2.5">
          <Button
            id="login-toggle-btn"
            type="button"
            icon="user"
            iconClasses="mr-0"
            iconPosition="left"
            size="lg"
            class={buttonClasses}
            title="Login"
            dataAttributes={{ "aria-label": "Login" }}
            onclick={`window.location.href='/auth/login'`}
          />
        </Tooltip>
      )
    }

    {
      !currentUser && (
        <Tooltip
          position="left"
          open={true}
          text={`Call ${globalCompanyName}`}
          className="-translate-y-2.5"
        >
          <Button
            id="phone-call-btn"
            type="button"
            icon="phone"
            iconClasses="mr-0"
            iconPosition="left"
            size="lg"
            class={buttonClasses}
            title="Call Us"
            dataAttributes={{ "aria-label": "Call Us" }}
            onclick={`window.location.href='tel:${globalCompanyPhone}'`}
          />
        </Tooltip>
      )
    }

    <Tooltip position="left" open={true} text="Feedback" className="-translate-y-2.5">
      <Button
        id="feedback-button"
        type="button"
        icon="comment-dots"
        iconClasses="mr-0"
        iconPosition="left"
        size="lg"
        class={buttonClasses}
        title="Feedback"
        dataAttributes={{ "aria-label": "Open feedback form" }}
      />
    </Tooltip>

    <Tooltip position="left" open={true} text="Contact" className="-translate-y-2.5">
      <Button
        id="contact-toggle-btn"
        type="button"
        icon="message-square"
        class="p-0"
        iconClasses="mr-0"
        iconPosition="left"
        size="lg"
        class={buttonClasses}
        title="Contact"
        dataAttributes={{ "aria-label": "Contact" }}
        onclick="window.location.href='/contact'"
      />
    </Tooltip>
  </div>

  <button
    type="button"
    data-dial-toggle="speed-dial-menu"
    aria-controls="speed-dial-menu"
    aria-expanded="false"
    class="flex h-12 w-12 items-center justify-center rounded-full bg-primary-700 text-white hover:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800"
  >
    <svg
      class="h-5 w-5 transition-transform"
      aria-hidden="true"
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 18 18"
    >
      <path
        stroke="currentColor"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M9 1v16M1 9h16"></path>
    </svg>
    <span class="sr-only">Open actions menu</span>
  </button>
</div>

<script>
  const tutorials = document.querySelectorAll("[data-welcome]");
  const tutorialButton = document.getElementById("tutorial-trigger");

  if (tutorialButton && tutorials.length === 0) {
    tutorialButton.style.display = "none";
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const speedDialButton = document.querySelector('[data-dial-toggle="speed-dial-menu"]');

    const speedDialMenu = document.getElementById("speed-dial-menu");
    const speedDial = document.getElementById("speed-dial");
    const speedDialOverlay = document.getElementById("speed-dial-overlay");

    let isOpen = false;
    let isTouchDevice = false;
    let touchHandled = false;

    // Detect if device supports touch
    if ("ontouchstart" in window || navigator.maxTouchPoints > 0) {
      isTouchDevice = true;
    }

    // Toggle function
    function toggleSpeedDial() {
      isOpen = !isOpen;
      const svg = speedDialButton?.querySelector("svg");

      if (isOpen) {
        speedDialMenu?.classList.remove("hidden");
        speedDialOverlay?.classList.remove("hidden");
        speedDialButton?.setAttribute("aria-expanded", "true");
        if (svg) {
          svg.style.transform = "rotate(45deg)";
          svg.style.transition = "transform 0.2s ease";
        }
      } else {
        speedDialMenu?.classList.add("hidden");
        speedDialOverlay?.classList.add("hidden");
        speedDialButton?.setAttribute("aria-expanded", "false");
        if (svg) {
          svg.style.transform = "rotate(0deg)";
          svg.style.transition = "transform 0.2s ease";
        }
      }
    }

    // Hide function
    function hideSpeedDial() {
      if (isOpen) {
        isOpen = false;
        speedDialMenu?.classList.add("hidden");
        speedDialOverlay?.classList.add("hidden");
        speedDialButton?.setAttribute("aria-expanded", "false");
        const svg = speedDialButton?.querySelector("svg");
        if (svg) {
          svg.style.transform = "rotate(0deg)";
          svg.style.transition = "transform 0.2s ease";
        }
      }
    }

    // Handle button interaction - works for both touch and click
    if (speedDialButton) {
      // Touch event handler for mobile
      speedDialButton.addEventListener(
        "touchstart",
        function (e) {
          touchHandled = true;
          e.stopPropagation();
          e.preventDefault(); // Prevent click from firing
          toggleSpeedDial();
          // Reset flag after a delay to allow click as fallback if needed
          setTimeout(() => {
            touchHandled = false;
          }, 400);
        },
        { passive: false }
      );

      // Click event handler for mobile only (fallback if touchstart doesn't work)
      // Desktop uses hover, so we skip click handler on non-touch devices
      if (isTouchDevice) {
        speedDialButton.addEventListener(
          "click",
          function (e) {
            // If touch was just handled, ignore this click to prevent double-firing
            if (touchHandled) {
              e.preventDefault();
              e.stopPropagation();
              return;
            }
            e.stopPropagation();
            toggleSpeedDial();
          },
          true
        ); // Use capture phase to handle before document click
      }
    }

    // Desktop hover behavior (only on non-touch devices)
    if (!isTouchDevice) {
      speedDialButton?.addEventListener("mouseenter", function (e) {
        e.stopPropagation();
        // Only auto-open on hover if not already open (prevents flickering)
        if (!isOpen) {
          toggleSpeedDial();
        }
      });

      // Desktop hover behavior - close when mouse leaves entire speed dial area
      speedDial?.addEventListener("mouseleave", function (e) {
        e.stopPropagation();
        // Only auto-close on hover if open (prevents flickering)
        if (isOpen) {
          toggleSpeedDial();
        }
      });
    }

    // Hide when clicking outside (works for both desktop and mobile)
    document.addEventListener("click", function (e) {
      // Don't close if touch was just handled (prevents immediate close on mobile)
      if (touchHandled) {
        return;
      }
      if (!speedDial?.contains(e.target as Node)) {
        hideSpeedDial();
      }
    });

    // Hide when clicking on the overlay
    speedDialOverlay?.addEventListener("click", function (e) {
      e.stopPropagation();
      hideSpeedDial();
    });

    // Hide when pressing Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape") {
        hideSpeedDial();
      }
    });

    // Prevent menu clicks from closing the dial (desktop hover)
    speedDialMenu?.addEventListener("mouseover", function (e) {
      e.stopPropagation();
    });

    // Allow all buttons and links in the menu to work properly
    // Stop propagation so document click handler doesn't interfere
    speedDialMenu?.addEventListener("click", function (e) {
      // Allow the click to proceed but prevent it from bubbling to document handler
      e.stopPropagation();

      // If it's a button or link, let the browser handle it naturally
      const target = e.target as HTMLElement;
      const button = target.closest("button, a");

      if (button) {
        // Let the button's onclick or href work naturally
        // The stopPropagation above prevents the document click handler from hiding the menu
      }
    });
  });

  // Check for tutorials on load and hide tutorial button if none exist
  function checkTutorials() {
    const hasTutorials = document.body.getAttribute("data-has-tutorials") === "true";
    const tutorialButton = document.getElementById("tutorial-trigger").parentElement;

    if (tutorialButton && !hasTutorials) {
      tutorialButton.style.display = "none";
    }
  }

  // Check immediately and on tutorial load event
  checkTutorials();
  window.addEventListener("tutorials-loaded", checkTutorials);
</script>
