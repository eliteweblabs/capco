---
/**
 * Account dropdown (popover) for non-authenticated users. AuthIcon uses this when !currentUser.
 * When authenticated, AuthIcon opens AccountDrawer instead.
 */
interface Props {
  currentUser: any;
  assignedProjectsCount?: number;
  assignedProjectsPreview?: any[];
  /** When set (e.g. on a project page), Check In is shown for Admin/Staff and uses this project. */
  project?: any;
}

// Redirect to API callback only when code is on a page that shouldn't handle it. Preserve full query.
const authCode = Astro.url.searchParams.get("code");
if (authCode && !Astro.url.pathname.startsWith("/auth/callback")) {
  const query = Astro.url.search ? Astro.url.search : `?code=${encodeURIComponent(authCode)}`;
  return Astro.redirect(`/api/auth/callback${query}`);
}

const {
  currentUser,
  assignedProjectsCount = 0,
  assignedProjectsPreview = [],
  project = null,
} = Astro.props;
const currentRole = currentUser?.profile?.role;
import SimpleIcon from "../common/SimpleIcon.astro";
import CheckInButton from "../common/CheckInButton.astro";
import PageSizeToggle from "./PageSizeToggle.astro";
---

<!-- Login popover: AuthIcon uses data-popover-target when not authenticated -->
<a
  slot="title"
  class="flex items-center gap-2 rounded-lg px-2 py-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-800"
  href="/profile"
>
  <div class="min-w-0 truncate">
    <span class="font-medium text-gray-900 dark:text-white">
      {currentUser?.profile?.companyName || "Add Company Name"}
    </span>
    <span class="text-gray-600 dark:text-gray-400">
      {" / "}
      {currentUser?.profile?.firstName}
      {currentUser?.profile?.lastName}
    </span>
  </div>
</a>
<div class="min-h-0 min-w-0 flex-1 overflow-y-auto overflow-x-hidden p-3">
  <div class="grid grid-cols-2 gap-3 sm:grid-cols-3">
    <a
      href="/profile"
      title="Profile"
      class="dark:hover:bg-primary-950/30 group flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600"
    >
      <SimpleIcon name="user-edit" size="xl" class="text-primary-500 dark:text-primary-400" />
      <span class="text-sm font-medium text-gray-900 dark:text-white">Profile</span>
    </a>

    <a
      href="/project/dashboard"
      title="Dashboard"
      class="dark:hover:bg-primary-950/30 group flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600"
    >
      <SimpleIcon name="dashboard" size="xl" class="text-primary-500 dark:text-primary-400" />
      <span class="text-sm font-medium text-gray-900 dark:text-white">Dashboard</span>
    </a>

    <button
      id="logout-btn"
      type="button"
      title="Sign out"
      class="flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-danger-300 hover:bg-danger-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-danger-600 dark:hover:bg-danger-950/30"
    >
      <SimpleIcon name="log-out" size="xl" class="text-danger-500 dark:text-danger-400" />
      <span class="text-sm font-medium text-gray-900 dark:text-white">Sign Out</span>
    </button>

    <PageSizeToggle variant="tile" idPrefix="dropdown-" />

    {(currentRole === "Admin" || currentRole === "Staff") && project?.id != null && (
      <CheckInButton tile projectId={project.id} />
    )}
  </div>
  {
    (currentRole === "Admin" || currentRole === "Staff") && assignedProjectsCount > 0 && (
      <div class="mt-3 w-full border-t border-gray-200 pt-3 dark:border-gray-700">
        <div class="mb-2 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
          Your Projects:
        </div>
        <div class="flex min-w-0 flex-wrap gap-2">
          {assignedProjectsPreview.map((project: any) => (
            <a
              href={`/project/${project.id}`}
              class="dark:hover:bg-primary-950/30 min-w-0 max-w-full break-words rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-left text-sm font-medium text-gray-900 transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:hover:border-primary-600"
            >
              {project.address || project.title || "Untitled Project"}
            </a>
          ))}
        </div>
      </div>
    )
  }
</div>
