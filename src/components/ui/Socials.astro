---
/**
 * Socials Component
 *
 * Displays social network links with auto-detected icons based on URL.
 * Uses SimpleIcon with brand-colored SVGs. Icons show grayscale by default;
 * hover/focus/active removes grayscale to reveal branding colors.
 *
 * @example
 * <Socials links={[
 *   { url: "https://facebook.com/company" },
 *   { url: "https://linkedin.com/company/name" }
 * ]} />
 *
 * @example with variant
 * <Socials links={socialLinks} variant="footer" size="lg" />
 */

import SimpleIcon from "../common/SimpleIcon.astro";

interface SocialLink {
  url: string;
  label?: string; // Optional custom label/title
}

interface Props {
  // Array of social links
  links?: SocialLink[] | string;

  // Display variant
  variant?: "default" | "footer" | "header" | "minimal";

  // Icon size
  size?: "sm" | "md" | "lg" | "xl";

  // Color scheme
  colorScheme?: "default" | "brand" | "mono" | "white";

  // Show labels
  showLabels?: boolean;

  // Gap between items
  gap?: "sm" | "md" | "lg";

  // Styling
  className?: string;
}

const {
  variant = "default",
  size = "md",
  colorScheme = "default",
  showLabels = false,
  gap = "md",
  className = "",
} = Astro.props;

// Parse links if passed as JSON string
let socialLinks: SocialLink[] = [];
if (typeof Astro.props.links === "string") {
  try {
    socialLinks = JSON.parse(Astro.props.links);
  } catch {
    socialLinks = [];
  }
} else if (Array.isArray(Astro.props.links)) {
  socialLinks = Astro.props.links;
}

// Filter out empty URLs
socialLinks = socialLinks.filter((link) => link.url && link.url.trim() !== "");

/**
 * Detect social network from URL and return SimpleIcon name + label.
 * Icons have brand colors in SVG; grayscale filter reveals them on hover.
 * Uses optional label hint when URL doesn't match known patterns.
 */
function detectSocialNetwork(url: string, labelHint?: string): { icon: string; label: string } {
  const urlLower = url.toLowerCase();
  const labelLower = labelHint?.toLowerCase() ?? "";

  // Networks with brand-colored SVGs in icon-data
  if (
    urlLower.includes("facebook.com") ||
    urlLower.includes("fb.com") ||
    urlLower.includes("fb.me")
  ) {
    return { icon: "facebook", label: "Facebook" };
  }
  if (urlLower.includes("github.com") || urlLower.includes("github.io")) {
    return { icon: "github", label: "GitHub" };
  }
  if (urlLower.includes("google.com") || urlLower.includes("goo.gl")) {
    return { icon: "google", label: "Google" };
  }
  if (urlLower.includes("youtube.com") || urlLower.includes("youtu.be")) {
    return { icon: "youtube", label: "YouTube" };
  }
  // LinkedIn: linkedin.com, lnkd.in, or any regional subdomain (e.g. uk.linkedin.com)
  if (urlLower.includes("linkedin.com") || urlLower.includes("lnkd.in") || urlLower.includes("linkedin.co")) {
    return { icon: "linkedin", label: "LinkedIn" };
  }
  if (urlLower.includes("slack.com")) {
    return { icon: "slack", label: "Slack" };
  }
  if (urlLower.startsWith("mailto:")) {
    return { icon: "mail", label: "Email" };
  }
  if (urlLower.startsWith("tel:")) {
    return { icon: "phone", label: "Phone" };
  }

  // Label-based fallback: if user set "LinkedIn" as label, use linkedin icon
  if (labelLower.includes("linkedin")) {
    return { icon: "linkedin", label: "LinkedIn" };
  }

  // Fallback for unknown URLs
  return { icon: "link-external", label: "Website" };
}

// SimpleIcon size mapping
const sizeMap = { sm: "sm" as const, md: "md" as const, lg: "lg" as const, xl: "xl" as const };

// Gap classes
const gapClasses = { sm: "gap-2", md: "gap-4", lg: "gap-6" };

// Grayscale icon classes: default grayscale, hover/focus/active reveal brand colors from SVG
const grayscaleIconBase =
  "grayscale transition-[filter] duration-200 group-hover:grayscale-0 group-focus-visible:grayscale-0 group-active:grayscale-0";
const grayscaleIconMono = "grayscale"; // mono: always grayscale, no hover reveal

// Build link classes
function getLinkClasses(): string {
  const base = "group inline-flex items-center focus:outline-none focus-visible:ring-2 focus-visible:ring-primary-500 focus-visible:ring-offset-2 rounded-full";

  let variantClass = "";
  switch (variant) {
    case "footer":
      variantClass = "p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800";
      break;
    case "header":
      variantClass = "p-1.5";
      break;
    case "minimal":
      variantClass = "";
      break;
    default:
      variantClass = "p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-800";
  }

  return `${base} ${variantClass}`;
}

// Icon classes: grayscale by default, reveal colors on hover (except mono)
function getIconClasses(): string {
  const scheme = colorScheme === "mono" ? grayscaleIconMono : grayscaleIconBase;
  return scheme;
}
---

{
  socialLinks.length > 0 && (
    <div
      class:list={[
        "socials-component flex w-full flex-row flex-nowrap items-center justify-evenly gap-2 sm:gap-3",
        gapClasses[gap],
        className,
      ]}
    >
      {socialLinks.map((link) => {
        const network = detectSocialNetwork(link.url, link.label);
        const label = link.label || network.label;
        const iconClasses =
          colorScheme === "white"
            ? `${getIconClasses()} text-white/90 group-hover:text-white group-focus-visible:text-white`
            : getIconClasses();

        const isExternal = link.url.startsWith("http");

        return (
          <a
            href={link.url}
            target={isExternal ? "_blank" : undefined}
            rel={isExternal ? "noopener noreferrer" : undefined}
            class={getLinkClasses()}
            title={label}
            aria-label={label}
          >
            <SimpleIcon
              name={network.icon}
              size={sizeMap[size]}
              class={iconClasses}
            />
            {showLabels && <span class="ml-2 text-sm">{label}</span>}
          </a>
        );
      })}
    </div>
  )
}
