---
/**
 * Account dropdown panel for the header avatar (AuthIcon).
 * Flowbite: trigger uses data-dropdown-toggle="account-dropdown"; this panel has id="account-dropdown".
 * Navbar.astro attaches the logout handler to #logout-btn.
 */
interface Props {
  currentUser: any;
  projects: any[];
  globalIconButtonClasses: string;
  closeButton: boolean;
  id: string;
  /** Name of global function to call when dropdown opens (e.g. for refresh). Expose as window.refreshUserProfile. */
  onOpen?: string;
}

// Redirect to API callback only when code is on a page that shouldn't handle it
// /auth/callback must render so client-side JS can exchange the code - do NOT redirect there
const authCode = Astro.url.searchParams.get("code");
if (authCode && !Astro.url.pathname.startsWith("/auth/callback")) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

const {
  currentUser,
  projects,
  globalIconButtonClasses,
  closeButton = false,
  id,
  onOpen,
} = Astro.props;

const currentRole = currentUser?.profile?.role;
const assignedCount = projects?.filter((p: any) => p.assignedToId === currentUser?.id).length ?? 0;
import SimpleIcon from "../common/SimpleIcon.astro";
import Dropdown from "./Dropdown.astro";
import LoginForm from "../../features/forms/components/LoginForm.astro";
import CheckInButton from "../common/CheckInButton.astro";
---

<!-- Account dropdown: Flowbite data-popover-target on AuthIcon trigger -->
<Dropdown
  id={id}
  {currentUser}
  {projects}
  {globalIconButtonClasses}
  {closeButton}
  title="User Profile"
  onOpenCallback={onOpen}
>
  {
    currentUser ? (
      <>
        <a
          slot="title"
          class="flex items-center gap-2 rounded-lg px-2 py-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-800"
          href="/profile"
        >
          <SimpleIcon name="logo" size="lg" class="shrink-0 w-8" />
          <div class="min-w-0 truncate">
            <span class="font-medium text-gray-900 dark:text-white">
              {currentUser?.profile?.companyName || "Add Company Name"}
            </span>
            <span class="text-gray-600 dark:text-gray-400">
              {" / "}
              {currentUser?.profile?.firstName}
              {currentUser?.profile?.lastName}
            </span>
          </div>
        </a>
        <div class="min-h-0 flex-1 overflow-y-auto p-3">
          <div class="grid grid-cols-2 gap-3 sm:grid-cols-3">
            <a
              href="/profile"
              title="Profile"
              class="group flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600 dark:hover:bg-primary-950/30"
            >
              <SimpleIcon
                name="user-edit"
                size="xl"
                class="text-primary-500 dark:text-primary-400"
              />
              <span class="text-sm font-medium text-gray-900 dark:text-white">Profile</span>
            </a>

            <a
              href="/project/dashboard"
              title="Dashboard"
              class="group flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600 dark:hover:bg-primary-950/30"
            >
              <SimpleIcon
                name="dashboard"
                size="xl"
                class="text-primary-500 dark:text-primary-400"
              />
              <span class="text-sm font-medium text-gray-900 dark:text-white">Dashboard</span>
            </a>

            {(currentRole === "Admin" || currentRole === "Staff") && (
              <a
                href="/project/dashboard"
                title="Assigned projects"
                class="flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600 dark:hover:bg-primary-950/30"
              >
                <span class="relative">
                  <SimpleIcon
                    name="folder"
                    size="xl"
                    class="text-primary-500 dark:text-primary-400"
                  />
                  {assignedCount > 0 && (
                    <span class="absolute -right-1 -top-1 flex h-5 w-5 items-center justify-center rounded-full bg-primary-500 text-xs font-bold text-white dark:bg-primary-600">
                      {assignedCount}
                    </span>
                  )}
                </span>
                <span class="text-sm font-medium text-gray-900 dark:text-white">Assigned</span>
              </a>
            )}

            <button
              id="logout-btn"
              type="button"
              title="Sign out"
              class="flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-danger-300 hover:bg-danger-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-danger-600 dark:hover:bg-danger-950/30"
            >
              <SimpleIcon name="log-out" size="xl" class="text-danger-500 dark:text-danger-400" />
              <span class="text-sm font-medium text-gray-900 dark:text-white">Sign Out</span>
            </button>

            <button
              type="button"
              id="page-size-toggle"
              title="Toggle larger page elements"
              class="flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600 dark:hover:bg-primary-950/30"
              aria-pressed="false"
            >
              <SimpleIcon
                name="zoom-in"
                size="xl"
                class="text-primary-500 dark:text-primary-400"
              />
              <span id="page-size-toggle-label" class="text-sm font-medium text-gray-900 dark:text-white">
                Larger
              </span>
            </button>

            {(currentRole === "Admin" || currentRole === "Staff") && (
              <CheckInButton tile />
            )}
          </div>
        </div>
      </>
    ) : (
      <LoginForm />
    )
  }
</Dropdown>
<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof window.initPageSizeToggle === "function") window.initPageSizeToggle();
  });
</script>
