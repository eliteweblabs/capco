---
/**
 * Account drawer for authenticated users. Opened from AuthIcon via data-drawer-target.
 * Renders when currentUser exists. Contains profile links, logout, page size toggle, etc.
 */
import Drawer from "../form/drawer.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import CheckInButton from "../common/CheckInButton.astro";

interface Props {
  currentUser: any;
  assignedProjectsCount?: number;
  assignedProjectsPreview?: any[];
}

const { currentUser, assignedProjectsCount = 0, assignedProjectsPreview = [] } = Astro.props;

const currentRole = currentUser?.profile?.role;
const drawerId = "account-drawer";
---

<Drawer id={drawerId} title="Account" placement="right" size="md">
  <a
    class="mb-4 flex items-center gap-2 rounded-lg px-2 py-1.5 text-sm hover:bg-gray-100 dark:hover:bg-gray-800"
    href="/profile"
  >
    <SimpleIcon name="logo" size="lg" class="w-8 shrink-0" />
    <div class="min-w-0 truncate">
      <span class="font-medium text-gray-900 dark:text-white">
        {currentUser?.profile?.companyName || "Add Company Name"}
      </span>
      <span class="text-gray-600 dark:text-gray-400">
        {" / "}
        {currentUser?.profile?.firstName}
        {currentUser?.profile?.lastName}
      </span>
    </div>
  </a>

  <div class="min-h-0 flex-1 overflow-y-auto">
    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3">
      <a
        href="/profile"
        title="Profile"
        class="dark:hover:bg-primary-950/30 group flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600"
      >
        <SimpleIcon name="user-edit" size="xl" class="text-primary-500 dark:text-primary-400" />
        <span class="text-sm font-medium text-gray-900 dark:text-white">Profile</span>
      </a>

      <a
        href="/project/dashboard"
        title="Dashboard"
        class="dark:hover:bg-primary-950/30 group flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600"
      >
        <SimpleIcon name="dashboard" size="xl" class="text-primary-500 dark:text-primary-400" />
        <span class="text-sm font-medium text-gray-900 dark:text-white">Dashboard</span>
      </a>

      <button
        id="logout-btn"
        type="button"
        title="Sign out"
        class="flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-danger-300 hover:bg-danger-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-danger-600 dark:hover:bg-danger-950/30"
      >
        <SimpleIcon name="log-out" size="xl" class="text-danger-500 dark:text-danger-400" />
        <span class="text-sm font-medium text-gray-900 dark:text-white">Sign Out</span>
      </button>

      <button
        type="button"
        id="page-size-toggle"
        title="Toggle larger page elements"
        class="dark:hover:bg-primary-950/30 relative flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600"
        aria-pressed="false"
      >
        <span id="page-size-icon-in">
          <SimpleIcon name="zoom-in" size="xl" class="text-primary-500 dark:text-primary-400" />
        </span>
        <span id="page-size-icon-out" class="hidden">
          <SimpleIcon name="zoom-out" size="xl" class="text-primary-500 dark:text-primary-400" />
        </span>
        <span id="page-size-toggle-label" class="text-sm font-medium text-gray-900 dark:text-white">
          Larger
        </span>
      </button>

      {(currentRole === "Admin" || currentRole === "Staff") && <CheckInButton tile />}
    </div>

    {
      (currentRole === "Admin" || currentRole === "Staff") && assignedProjectsCount > 0 && (
        <div class="mt-3 w-full border-t border-gray-200 pt-3 dark:border-gray-700">
          <div class="mb-2 text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400">
            Your Projects:
          </div>
          <div class="flex flex-wrap gap-2">
            {assignedProjectsPreview.map((project: any) => (
              <a
                href={`/project/${project.id}`}
                class="dark:hover:bg-primary-950/30 inline-block rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-left text-sm font-medium text-gray-900 transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:hover:border-primary-600"
              >
                {project.address || project.title || "Untitled Project"}
              </a>
            ))}
          </div>
        </div>
      )
    }
  </div>
</Drawer>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof window.initPageSizeToggle === "function") window.initPageSizeToggle();
  });
</script>
