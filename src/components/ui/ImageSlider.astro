---
/**
 * ImageSlider - Grid-Based Multi-Directional Image Slider with Hero Overlay
 * Retina-aware: uses 2x resolution for sharp display on high-DPI screens.
 * ==========================================================================
 * A dynamic grid slider where multiple images are visible and slide
 * in different directions at different times. Creates a Ken Burns-like effect.
 * Includes optional title, description, and button overlay like Hero component.
 *
 * Supports both direct Astro props AND flat shortcode props for CMS usage.
 *
 * @property {Array} slides - Array of slide objects (for direct Astro usage)
 * @property {string} containerClass - Additional CSS classes for container
 * @property {string} gridTemplate - CSS grid template (default: '1fr 1fr / 1fr 1fr')
 * @property {string} height - Container height (default: '400px')
 * @property {string} title - Main headline (h1)
 * @property {string} description - Subtitle (h2)
 * @property {boolean} overlay - Show dark overlay (default: true)
 * @property {number} overlayOpacity - Overlay opacity 0-1 (default: 0.5)
 *
 * Shortcode flat props (for CMS usage):
 * @property {string} image1, image2, image3, image4 - Image URLs
 * @property {string} alt1, alt2, alt3, alt4 - Alt text for images
 * @property {string} direction1, direction2, etc. - Animation direction: left, right, up, down
 * @property {string} leftButtonText, leftButtonHref, etc. - Button props
 *
 * Usage Examples:
 * ---------------
 * CMS Shortcode with overlay text:
 * <ImageSlider
 *   title="Our Projects"
 *   description="Quality construction across the Northeast"
 *   image1="https://example.com/img1.jpg"
 *   image2="https://example.com/img2.jpg"
 *   overlay="true"
 *   overlayOpacity="0.5"
 *   leftButtonText="View Projects"
 *   leftButtonHref="/projects"
 *   height="500px"
 * />
 */

import Button from "../common/Button.astro";
import { getRetinaImageUrl, getRetinaSrcSet } from "../../lib/image-retina";

interface SlideData {
  src: string;
  alt: string;
  direction?: "left" | "right" | "up" | "down";
  delay?: number;
  duration?: number;
  gridArea?: string;
}

interface ButtonProps {
  text: string;
  href: string;
  icon?: string;
  variant?: "primary" | "secondary" | "outline";
}

interface Props {
  slides?: SlideData[];
  containerClass?: string;
  gridTemplate?: string;
  height?: string;
  // Overlay text props
  title?: string;
  description?: string;
  overlay?: boolean | string;
  overlayOpacity?: number | string;
  // Object-based button props (for direct Astro usage)
  leftButton?: ButtonProps;
  rightButton?: ButtonProps;
  // Flat shortcode props for CMS usage - Images
  image1?: string;
  image2?: string;
  image3?: string;
  image4?: string;
  alt1?: string;
  alt2?: string;
  alt3?: string;
  alt4?: string;
  direction1?: string;
  direction2?: string;
  direction3?: string;
  direction4?: string;
  // Flat shortcode props for CMS usage - Buttons
  leftButtonText?: string;
  leftButtonHref?: string;
  leftButtonIcon?: string;
  leftButtonVariant?: string;
  rightButtonText?: string;
  rightButtonHref?: string;
  rightButtonIcon?: string;
  rightButtonVariant?: string;
  /** When true (default), overlay content uses AOS fade-up animation on load. Set false if you init AOS elsewhere or don't use AOS. */
  aosOverlay?: boolean | string;
}

const props = Astro.props;

const {
  containerClass = "",
  gridTemplate: customGridTemplate,
  height = "400px",
  title,
  description,
  aosOverlay = true,
} = props;

// Handle boolean/string conversion for shortcode compatibility
const showOverlay = props.overlay === "false" ? false : (props.overlay ?? true);
const useAosOverlay = aosOverlay === "false" ? false : (aosOverlay ?? true);
const overlayOpacity =
  typeof props.overlayOpacity === "string"
    ? parseFloat(props.overlayOpacity)
    : (props.overlayOpacity ?? 0.5);

// Build button objects from either format
const leftButton: ButtonProps | undefined =
  props.leftButton ||
  (props.leftButtonText
    ? {
        text: props.leftButtonText,
        href: props.leftButtonHref || "#",
        icon: props.leftButtonIcon,
        variant: (props.leftButtonVariant as "primary" | "secondary" | "outline") || "primary",
      }
    : undefined);

const rightButton: ButtonProps | undefined =
  props.rightButton ||
  (props.rightButtonText
    ? {
        text: props.rightButtonText,
        href: props.rightButtonHref || "#",
        icon: props.rightButtonIcon,
        variant: (props.rightButtonVariant as "primary" | "secondary" | "outline") || "secondary",
      }
    : undefined);

const hasButtons = leftButton || rightButton;
const hasOverlayContent = title || description || hasButtons;

// Default demo images (2x resolution for retina)
const defaultImages: SlideData[] = [
  {
    src: "https://images.unsplash.com/photo-1504307651254-35680f356dfd?w=1600&auto=format",
    alt: "Construction site",
    direction: "left",
    delay: 0,
    duration: 25000,
    gridArea: "1 / 1 / 2 / 3",
  },
  {
    src: "https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=1600&auto=format",
    alt: "Industrial work",
    direction: "right",
    delay: 2000,
    duration: 30000,
    gridArea: "2 / 1 / 3 / 2",
  },
  {
    src: "https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=1600&auto=format",
    alt: "Equipment",
    direction: "up",
    delay: 1000,
    duration: 28000,
    gridArea: "2 / 2 / 3 / 3",
  },
  {
    src: "https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=1600&auto=format",
    alt: "Commercial building",
    direction: "down",
    delay: 3000,
    duration: 32000,
    gridArea: "1 / 3 / 3 / 4",
  },
];

// Build slides from either format
let slides: SlideData[] = props.slides || [];

// If no slides array, build from flat props (shortcode usage)
if (slides.length === 0) {
  const flatSlides: SlideData[] = [];

  // Default grid areas for 1-4 images
  const defaultGridAreas = [
    "1 / 1 / 2 / 3", // Image 1: top, spans 2 columns
    "2 / 1 / 3 / 2", // Image 2: bottom left
    "2 / 2 / 3 / 3", // Image 3: bottom right
    "1 / 3 / 3 / 4", // Image 4: right side, spans 2 rows
  ];

  const defaultDirections: Array<"left" | "right" | "up" | "down"> = [
    "left",
    "right",
    "up",
    "down",
  ];
  const defaultDelays = [0, 2000, 1000, 3000];
  const defaultDurations = [25000, 30000, 28000, 32000];

  for (let i = 1; i <= 4; i++) {
    const imageKey = `image${i}` as keyof Props;
    const altKey = `alt${i}` as keyof Props;
    const directionKey = `direction${i}` as keyof Props;

    const imageSrc = props[imageKey] as string | undefined;
    if (imageSrc) {
      flatSlides.push({
        src: imageSrc,
        alt: (props[altKey] as string) || `Image ${i}`,
        direction: ((props[directionKey] as string) ||
          defaultDirections[i - 1]) as SlideData["direction"],
        delay: defaultDelays[i - 1],
        duration: defaultDurations[i - 1],
        gridArea: defaultGridAreas[i - 1],
      });
    }
  }

  slides = flatSlides;
}

// Use default images if no slides provided
if (slides.length === 0) {
  slides = defaultImages;
}

// Determine grid template based on number of slides
let gridTemplate = customGridTemplate;
if (!gridTemplate) {
  switch (slides.length) {
    case 1:
      gridTemplate = "1fr / 1fr";
      break;
    case 2:
      gridTemplate = "1fr / 1fr 1fr";
      break;
    case 3:
      gridTemplate = "1fr 1fr / 1fr 1fr";
      break;
    case 4:
    default:
      gridTemplate = "repeat(2, 1fr) / repeat(3, 1fr)";
      break;
  }
}

// Generate unique ID for this instance
const gridId = `grid-slider-${Math.random().toString(36).substr(2, 9)}`;
---

{
  slides.length > 0 && (
    <div
      class={`image-slider-container ${containerClass}`}
      id={gridId}
      style={`min-height: ${height};`}
    >
      {/* Image Grid - z-0 so overlays stack above */}
      <div class="image-slider-grid" style={`grid-template: ${gridTemplate};`}>
        {slides.map((slide, index) => {
          const slideId = `slide-${index}`;
          const direction = slide.direction || "left";
          const delay = slide.delay || 0;
          const duration = slide.duration || 20000;
          const gridArea = slide.gridArea || "auto";
          const srcset = getRetinaSrcSet(slide.src, 960);
          const dataSrc = srcset ? slide.src : getRetinaImageUrl(slide.src);

          return (
            <div
              class={`grid-slide slide-${direction}`}
              data-direction={direction}
              data-delay={delay}
              data-duration={duration}
              style={`grid-area: ${gridArea};`}
              id={`${gridId}-${slideId}`}
            >
              <img
                src={dataSrc}
                srcset={srcset || undefined}
                sizes="(min-width: 1024px) 50vw, 100vw"
                alt={slide.alt}
                class="slide-image"
                width="800"
                height="600"
                loading="eager"
              />
            </div>
          );
        })}
      </div>

      {/* Dark Overlay */}
      {showOverlay && hasOverlayContent && (
        <div
          class="image-slider-dark-overlay pointer-events-none absolute inset-0 z-[1] bg-black"
          style={`opacity: ${overlayOpacity};`}
        />
      )}

      {/* Content Overlay - fills parent, vertically centered. pointer-events: none on container so iOS Safari can scroll past hero; only buttons/links are clickable. */}
      {hasOverlayContent && (
        <div
          class="image-slider-overlay pointer-events-none absolute inset-0 z-20 flex items-center justify-center"
          {...(useAosOverlay && { "data-aos": "fade-up", "data-aos-duration": "600" })}
        >
          <div class="mx-auto w-full max-w-4xl px-4 text-center sm:px-6 lg:px-8">
            {title && (
              <h1
                class="text-3xl font-bold text-white drop-shadow-lg sm:text-4xl md:text-6xl"
                data-aos="fade-up"
                data-aos-delay="100"
              >
                {title}
              </h1>
            )}
            {description && (
              <h2
                class="mt-6 text-xl text-gray-200 drop-shadow-md"
                set:html={description}
                data-aos="fade-up"
                data-aos-delay="200"
              />
            )}
            {hasButtons && (
              <div
                class="mt-8 flex flex-col items-center justify-center gap-4 sm:flex-row"
                {...(useAosOverlay && { "data-aos": "fade-up", "data-aos-delay": "300" })}
              >
                {leftButton && (
                  <Button
                    href={leftButton.href}
                    variant={leftButton.variant}
                    iconPosition="left"
                    icon={leftButton.icon}
                    size="md"
                  >
                    {leftButton.text}
                  </Button>
                )}
                {rightButton && (
                  <Button
                    href={rightButton.href}
                    variant={rightButton.variant}
                    iconPosition="right"
                    icon={rightButton.icon}
                    size="md"
                  >
                    {rightButton.text}
                  </Button>
                )}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  )
}

<style>
  .image-slider-container {
    position: relative;
    width: 100%;
    overflow: hidden;
  }

  .image-slider-grid {
    display: grid;
    position: absolute;
    z-index: 0;
    gap: 4px;
    inset: 0;
    width: 100%;
    height: 100%;
  }

  .grid-slide {
    position: relative;
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  /* Overlay is pointer-events: none so touch scroll passes through on iOS; only interactive elements receive clicks.
     :global() ensures Button.astro's <a>/<button> are matched (child components may have different Astro scoping). */
  .image-slider-overlay :global(a),
  .image-slider-overlay :global(button) {
    pointer-events: auto;
    position: relative;
    z-index: 1;
  }

  /* Retina: fill container; use scale for Ken Burns overflow (Safari fixes percent + object-fit) */
  .slide-image {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    min-width: 100%;
    min-height: 100%;
    max-width: none;
    object-fit: cover;
    object-position: center;
    /* Ken Burns: scale up so pan animation has room; applied with translate in keyframes */
    transform: scale(1.3);
    transform-origin: center center;
    will-change: transform;
  }

  /* Animation keyframes: scale(1.3) for Ken Burns overflow + pan */
  @keyframes slide-left {
    0% {
      transform: scale(1.3) translateX(0);
    }
    100% {
      transform: scale(1.3) translateX(-8%);
    }
  }
  @keyframes slide-right {
    0% {
      transform: scale(1.3) translateX(0);
    }
    100% {
      transform: scale(1.3) translateX(8%);
    }
  }
  @keyframes slide-up {
    0% {
      transform: scale(1.3) translateY(0);
    }
    100% {
      transform: scale(1.3) translateY(-8%);
    }
  }
  @keyframes slide-down {
    0% {
      transform: scale(1.3) translateY(0);
    }
    100% {
      transform: scale(1.3) translateY(8%);
    }
  }

  /* Apply animations based on direction */
  .slide-left .slide-image {
    animation: slide-left var(--duration, 20s) var(--delay, 0s) infinite alternate ease-in-out;
  }

  .slide-right .slide-image {
    animation: slide-right var(--duration, 20s) var(--delay, 0s) infinite alternate ease-in-out;
  }

  .slide-up .slide-image {
    animation: slide-up var(--duration, 20s) var(--delay, 0s) infinite alternate ease-in-out;
  }

  .slide-down .slide-image {
    animation: slide-down var(--duration, 20s) var(--delay, 0s) infinite alternate ease-in-out;
  }
</style>

<script>
  // Apply custom animation properties to each slide
  document.addEventListener("DOMContentLoaded", () => {
    const slides = document.querySelectorAll(".grid-slide");
    slides.forEach((slide) => {
      const duration = slide.getAttribute("data-duration") || "20000";
      const delay = slide.getAttribute("data-delay") || "0";
      const img = slide.querySelector(".slide-image") as HTMLElement;
      if (img) {
        img.style.setProperty("--duration", `${parseInt(duration)}ms`);
        img.style.setProperty("--delay", `${parseInt(delay)}ms`);
      }
    });
  });
</script>
