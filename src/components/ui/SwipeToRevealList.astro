---
/**
 * SwipeToRevealList - List items that swipe horizontally to reveal action buttons
 * Use for "Swipe to Delete", "Swipe to Archive", etc.
 * Supports touch and mouse for desktop testing.
 */
import SimpleIcon from "../common/SimpleIcon.astro";

export interface SwipeAction {
  label: string;
  variant?: "danger" | "secondary" | "primary" | "success" | "warning" | "outline";
  icon?: string;
  onclick?: string;
}

export interface SwipeItem {
  id: string;
  label: string;
  subtitle?: string;
  actions?: SwipeAction[];
}

interface Props {
  items: SwipeItem[];
  /** Hint text shown above the list, e.g. "Swipe left to reveal actions" */
  hint?: string;
  onRemove?: (id: string) => void;
}

const { items, hint = "Swipe left to reveal actions", onRemove } = Astro.props;
---

<div class="swipe-to-reveal-list">
  {hint && (
    <p class="mb-3 text-center text-sm text-gray-500 dark:text-gray-400">
      {hint}
    </p>
  )}
  <ul class="space-y-2" role="list">
    {items.map((item) => (
      <li
        class="swipe-item relative overflow-hidden rounded-lg bg-gray-100 dark:bg-gray-800"
        data-item-id={item.id}
      >
        <div class="swipe-actions absolute inset-y-0 right-0 flex">
          {(item.actions || [{ label: "Delete", variant: "danger", icon: "trash" }]).map(
            (action) => (
              <button
                type="button"
                class={`swipe-action flex flex-1 items-center justify-center gap-2 px-4 font-medium transition-colors min-w-[80px] ${
                  action.variant === "danger"
                    ? "bg-red-500 text-white hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700"
                    : action.variant === "secondary"
                      ? "bg-gray-500 text-white hover:bg-gray-600 dark:bg-gray-600 dark:hover:bg-gray-700"
                      : action.variant === "primary"
                        ? "bg-[var(--color-primary-500)] text-white hover:opacity-90"
                        : "bg-gray-400 text-white hover:bg-gray-500"
                }`}
                data-action={action.label}
                data-item-id={item.id}
              >
                {action.icon && (
                  <SimpleIcon name={action.icon} size="sm" class="shrink-0" />
                )}
                <span>{action.label}</span>
              </button>
            )
          )}
        </div>
        <div
          class="swipe-content flex cursor-grab touch-pan-y items-center gap-3 px-4 py-3 bg-gray-100 dark:bg-gray-800 active:cursor-grabbing"
          style="transform: translateX(0); touch-action: pan-y;"
        >
          <div class="min-w-0 flex-1">
            <p class="font-medium text-gray-900 dark:text-white truncate">{item.label}</p>
            {item.subtitle && (
              <p class="text-sm text-gray-500 dark:text-gray-400 truncate">{item.subtitle}</p>
            )}
          </div>
        </div>
      </li>
    ))}
  </ul>
</div>

<script>
  function initSwipeList(root: HTMLElement) {
    const items = root.querySelectorAll<HTMLElement>(".swipe-item");
    const threshold = 60;
    const actionWidth = 80;

    items.forEach((item) => {
      const content = item.querySelector<HTMLElement>(".swipe-content");
      const actions = item.querySelector<HTMLElement>(".swipe-actions");
      if (!content || !actions) return;

      const actionsW = actions.offsetWidth;
      let startX = 0;
      let currentX = 0;
      let isDragging = false;

      function setTransform(x: number) {
        const clamped = Math.max(-actionsW, Math.min(0, x));
        content.style.transform = `translateX(${clamped}px)`;
        currentX = clamped;
      }

      function handleStart(clientX: number) {
        startX = clientX;
        isDragging = true;
        content.style.transition = "none";
      }

      function handleMove(clientX: number) {
        if (!isDragging) return;
        const delta = clientX - startX;
        setTransform(currentX + delta);
        startX = clientX;
      }

      function handleEnd() {
        if (!isDragging) return;
        isDragging = false;
        content.style.transition = "transform 0.25s ease-out";
        const shouldOpen = currentX < -threshold;
        setTransform(shouldOpen ? -actionsW : 0);
      }

      content.addEventListener(
        "touchstart",
        (e) => {
          handleStart(e.touches[0].clientX);
        },
        { passive: true }
      );
      content.addEventListener(
        "touchmove",
        (e) => {
          handleMove(e.touches[0].clientX);
        },
        { passive: true }
      );
      content.addEventListener("touchend", handleEnd, { passive: true });

      content.addEventListener("mousedown", (e) => {
        e.preventDefault();
        handleStart(e.clientX);
        const onMouseMove = (e: MouseEvent) => handleMove(e.clientX);
        const onMouseUp = () => {
          document.removeEventListener("mousemove", onMouseMove);
          document.removeEventListener("mouseup", onMouseUp);
          handleEnd();
        };
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      });

      actions.querySelectorAll("button").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          e.stopPropagation();
          const itemId = item.dataset.itemId;
          const action = (e.currentTarget as HTMLElement).dataset.action;
          if (itemId) {
            item.style.transition = "transform 0.2s ease-out, opacity 0.2s";
            item.style.transform = "translateX(-100%)";
            item.style.opacity = "0";
            setTimeout(() => {
              item.remove();
              root.dispatchEvent(
                new CustomEvent("swipe-action", { detail: { itemId, action }, bubbles: true })
              );
            }, 200);
          }
        });
      });
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".swipe-to-reveal-list").forEach((el) => {
      initSwipeList(el as HTMLElement);
    });
  });
</script>

<style>
  .swipe-to-reveal-list {
    user-select: none;
    -webkit-user-select: none;
  }

  .swipe-item {
    list-style: none;
  }

  .swipe-content {
    position: relative;
    z-index: 1;
    will-change: transform;
  }

  .swipe-actions {
    z-index: 0;
  }
</style>
