---
/**
 * Page-size toggle button (normal vs larger page elements). Accessibility preference;
 * persisted in localStorage, applied via html[data-page-size="large"] in global.css.
 * Script is inline so it works when module chunks don't load.
 */
interface Props {
  /** "tile" = drawer/dropdown tile style; "inline" = profile row with description */
  variant?: "tile" | "inline";
  /** Prefix for button/label/icon ids so multiple instances don't clash (e.g. "profile-"). */
  idPrefix?: string;
}

const { variant = "tile", idPrefix = "" } = Astro.props;

const bid = idPrefix ? idPrefix + "page-size-toggle" : "page-size-toggle";
const labelId = idPrefix ? idPrefix + "page-size-toggle-label" : "page-size-toggle-label";
const iconInId = idPrefix ? idPrefix + "page-size-icon-in" : "page-size-icon-in";
const iconOutId = idPrefix ? idPrefix + "page-size-icon-out" : "page-size-icon-out";

import SimpleIcon from "../common/SimpleIcon.astro";
---

{variant === "tile" && (
  <button
    type="button"
    id={bid}
    data-page-size-toggle
    data-id-prefix={idPrefix}
    title="Toggle larger page elements"
    class="dark:hover:bg-primary-950/30 relative flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600"
    aria-pressed="false"
  >
    <span id={iconInId}>
      <SimpleIcon name="zoom-in" size="xl" class="text-primary-500 dark:text-primary-400" />
    </span>
    <span id={iconOutId} class="hidden">
      <SimpleIcon name="zoom-out" size="xl" class="text-primary-500 dark:text-primary-400" />
    </span>
    <span id={labelId} class="text-sm font-medium text-gray-900 dark:text-white">
      Larger
    </span>
  </button>
)}

{variant === "inline" && (
  <div class="flex items-center justify-between rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-700 dark:bg-gray-700/50">
    <div>
      <p class="text-sm font-medium text-gray-900 dark:text-white">
        Larger page elements
      </p>
      <p class="mt-0.5 text-xs text-gray-500 dark:text-gray-400">
        Better readability on mobile; scales buttons and text
      </p>
    </div>
    <button
      type="button"
      id={bid}
      data-page-size-toggle
      data-id-prefix={idPrefix}
      title="Toggle larger page elements"
      class="color-background inline-flex items-center rounded-lg border border-gray-300 px-3 py-2 text-sm font-medium text-gray-900 hover:bg-gray-100 dark:border-gray-600 dark:text-white dark:hover:bg-gray-600"
      aria-pressed="false"
    >
      <span id={iconInId} class="mr-2">
        <SimpleIcon name="zoom-in" size="sm" />
      </span>
      <span id={iconOutId} class="mr-2 hidden">
        <SimpleIcon name="zoom-out" size="sm" />
      </span>
      <span id={labelId}>Larger page elements</span>
    </button>
  </div>
)}

<script is:inline>
  (function () {
    var PAGE_SIZE_KEY = "page-size";
    function getPageSize() {
      var v = document.documentElement.getAttribute("data-page-size");
      return v === "large" ? "large" : "normal";
    }
    function setPageSize(value) {
      document.documentElement.setAttribute("data-page-size", value);
      try { localStorage.setItem(PAGE_SIZE_KEY, value); } catch (_) { /* ignore */ }
    }
    function togglePageSize() {
      var next = getPageSize() === "large" ? "normal" : "large";
      setPageSize(next);
      return next;
    }
    function updatePageSizeToggleUI(ids) {
      ids = ids || {};
      var labelId = ids.labelId || "page-size-toggle-label";
      var buttonId = ids.buttonId || "page-size-toggle";
      var iconInId = ids.iconInId || "page-size-icon-in";
      var iconOutId = ids.iconOutId || "page-size-icon-out";
      var isLarge = getPageSize() === "large";
      var label = document.getElementById(labelId);
      var btn = document.getElementById(buttonId);
      var iconIn = document.getElementById(iconInId);
      var iconOut = document.getElementById(iconOutId);
      if (label) label.textContent = isLarge ? "Normal page elements" : "Larger page elements";
      if (btn) btn.setAttribute("aria-pressed", String(isLarge));
      if (iconIn) iconIn.style.display = isLarge ? "none" : "";
      if (iconOut) iconOut.style.display = isLarge ? "block" : "none";
    }
    function wireOne(btn) {
      if (btn.getAttribute("data-page-size-wired") === "true") return;
      btn.setAttribute("data-page-size-wired", "true");
      var p = btn.getAttribute("data-id-prefix") || "";
      var ids = p
        ? { buttonId: p + "page-size-toggle", labelId: p + "page-size-toggle-label", iconInId: p + "page-size-icon-in", iconOutId: p + "page-size-icon-out" }
        : {};
      updatePageSizeToggleUI(ids);
      btn.addEventListener("click", function () {
        togglePageSize();
        updatePageSizeToggleUI(ids);
      });
    }
    function wireAll() {
      document.querySelectorAll("[data-page-size-toggle]").forEach(wireOne);
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", wireAll);
    } else {
      wireAll();
    }
    setTimeout(wireAll, 300);
  })();
</script>
