---
/**
 * Dropdown panel using native Popover API.
 * Trigger: popovertarget="{id}-dropdown" popovertargetaction="toggle"
 * Positions below trigger; supports onOpenCallback, focusSelector.
 */
import { globalClasses } from "../../pages/api/global/global-classes";

const { globalTextH3, globalSidebarClasses } = globalClasses();

interface Props {
  id: string;
  currentUser?: any;
  globalIconButtonClasses?: string;
  title?: string;
  /** Name of global function to call when dropdown opens (e.g. for lazy load or refresh) */
  onOpenCallback?: string;
  /** Selector for input to focus when dropdown opens. Must run in same click handler for iOS keypad. */
  focusSelector?: string;
  classList?: string[];
}

const { id, title = "", onOpenCallback, focusSelector, classList } = Astro.props;
---

<div
  id={`${id}-dropdown`}
  popover="auto"
  role="menu"
  data-on-open={onOpenCallback || undefined}
  data-focus-on-open={focusSelector || undefined}
  class={`dropdown-popover ${globalSidebarClasses} ${classList ? classList.join(" ") : ""} overflow-y-scroll no-scrollbar fixed z-[1250] w-full max-w-md`}
  data-dynamic-height="height"
>
  {
    title && (
      <div class="py-3">
        <h3 class={globalTextH3} set:html={title} />
      </div>
    )
  }

  <slot />
</div>

<script is:inline>
  (function () {
    function positionDropdown(panel, trigger) {
      if (!panel || !trigger) return;
      var rect = trigger.getBoundingClientRect();
      var panelRect = panel.getBoundingClientRect();
      var gap = 8;
      var top = rect.bottom + gap;
      var left = Math.max(8, Math.min(rect.left, window.innerWidth - panelRect.width - 8));
      panel.style.top = top + "px";
      panel.style.left = left + "px";
    }
    function run() {
      document.querySelectorAll("[id$='-dropdown'][popover]").forEach(function (panel) {
        var panelId = panel.id;
        var trigger = document.querySelector("[popovertarget=\"" + panelId + "\"]");
        if (!trigger) return;
        panel.addEventListener("toggle", function (e) {
          if (panel.matches(":popover-open")) {
            positionDropdown(panel, trigger);
            requestAnimationFrame(function () { positionDropdown(panel, trigger); });
            var focusSel = panel.getAttribute("data-focus-on-open");
            if (focusSel) {
              var el = panel.querySelector(focusSel);
              if (el && typeof el.focus === "function") el.focus();
            }
            var onOpen = panel.getAttribute("data-on-open");
            if (onOpen && typeof window[onOpen] === "function") window[onOpen]();
          }
        });
      });
      window.addEventListener("resize", function () {
        document.querySelectorAll("[id$='-dropdown'][popover]:popover-open").forEach(function (panel) {
          var trigger = document.querySelector("[popovertarget=\"" + panel.id + "\"]");
          if (trigger) positionDropdown(panel, trigger);
        });
      });
      window.addEventListener("scroll", function () {
        document.querySelectorAll("[id$='-dropdown'][popover]:popover-open").forEach(function (panel) {
          var trigger = document.querySelector("[popovertarget=\"" + panel.id + "\"]");
          if (trigger) positionDropdown(panel, trigger);
        });
      }, { passive: true });

      document.querySelectorAll(".auth-icon-close").forEach(function (closeEl) {
        var trigger = closeEl.closest("[popovertarget]");
        if (!trigger) return;
        var panelId = trigger.getAttribute("popovertarget");
        var panel = panelId ? document.getElementById(panelId) : null;
        if (!panel || !panel.matches("[popover]")) return;
        if (closeEl.hasAttribute("data-dropdown-close-bound")) return;
        closeEl.setAttribute("data-dropdown-close-bound", "true");
        closeEl.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          panel.hidePopover();
        });
      });

      document.querySelectorAll("[popovertarget]").forEach(function (trigger) {
        var panelId = trigger.getAttribute("popovertarget");
        var panel = panelId ? document.getElementById(panelId) : null;
        if (!panel) return;
        function updateTrigger() {
          var isOpen = panel.matches(":popover-open");
          var defaultEl = trigger.querySelector(".auth-icon-default");
          var closeEl = trigger.querySelector(".auth-icon-close");
          if (defaultEl && closeEl) {
            defaultEl.style.opacity = isOpen ? "0" : "1";
            defaultEl.style.pointerEvents = isOpen ? "none" : "auto";
            closeEl.style.opacity = isOpen ? "1" : "0";
            closeEl.style.pointerEvents = isOpen ? "auto" : "none";
          }
          trigger.setAttribute("aria-expanded", String(isOpen));
        }
        panel.addEventListener("toggle", updateTrigger);
        updateTrigger();
      });
    }
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
    else run();
  })();
</script>

<style>
  .dropdown-popover[popover] {
    border: 1px solid var(--color-gray-200);
    border-radius: 0.5rem;
    background: var(--color-white);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
  }
  :global(.dark) .dropdown-popover[popover] {
    border-color: var(--color-gray-800);
    background: var(--color-gray-900);
  }
</style>
