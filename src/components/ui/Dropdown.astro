---
/**
 * Account dropdown panel for the header avatar (AuthIcon).
 * Flowbite: trigger uses data-dropdown-toggle="account-dropdown"; this panel has id="account-dropdown".
 * Navbar.astro attaches the logout handler to #logout-btn.
 */
interface Props {
  id: string;
  currentUser?: any;
  globalIconButtonClasses?: string;
  title?: string;
  // closeButton?: boolean;
  /** Name of global function to call when dropdown opens (e.g. for lazy load or refresh) */
  onOpenCallback?: string;
  /** Selector for input to focus when dropdown opens. Must run in same click handler for iOS keypad. */
  focusSelector?: string;
  classList?: string[];
}

const { id, title = "", onOpenCallback, focusSelector, classList } = Astro.props;
---

{/* Account dropdown: Flowbite data-dropdown-toggle / data-popover-target on AuthIcon trigger */}
<div
  id={`${id}-dropdown`}
  data-popover
  role="tooltip"
  {...onOpenCallback ? { "data-on-open": onOpenCallback } : {}}
  {...focusSelector ? { "data-focus-on-open": focusSelector } : {}}
  class={`${classList ? classList.join(" ") : ""} overflow-y-scroll no-scrollbar invisible fixed z-[1250] inline-block w-full max-w-md overflow-visible border border-gray-200 dark:border-gray-800 text-body text-sm opacity-0 transition-opacity duration-300 ease-out backdrop-blur-lg`}
  data-dynamic-height="height"
>
  <div class="dropdown-arrow" data-popper-arrow></div>

  {
    title && (
      <div class="py-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white" set:html={title} />
      </div>
    )
  }

  <slot />
</div>

<script is:inline>
  (function () {
    var DROPDOWN_Z = 9999;
    // Flowbite doesn't portal to body; move panel to body so it (and arrow) paint above navbar (z-100)
    function moveDropdownsToBody() {
      document.querySelectorAll("[id$='-dropdown'][data-popover]").forEach(function (panel) {
        if (panel.parentNode !== document.body) document.body.appendChild(panel);
        panel.style.zIndex = DROPDOWN_Z;
      });
    }

    function run() {
      moveDropdownsToBody();

      // Flowbite handles show/hide; we only: move to body on open, reopen classes, on-open callback, focus, close/X UX
      document.querySelectorAll("[id$='-dropdown']").forEach(function (panel) {
        var panelId = panel.id;
        if (!panelId) return;
        var onOpen = panel.getAttribute("data-on-open");
        var focusSel = panel.getAttribute("data-focus-on-open");
        var selectors =
          "[data-dropdown-toggle='" + panelId + "'], [data-popover-target='" + panelId + "']";
        document.querySelectorAll(selectors).forEach(function (trigger) {
          if (trigger.hasAttribute("data-onopen-bound")) return;
          trigger.setAttribute("data-onopen-bound", "true");
          trigger.addEventListener("click", function () {
            moveDropdownsToBody();
            if (panel) {
              panel.classList.remove(
                "opacity-0",
                "transition-opacity",
                "duration-300",
                "ease-out",
                "invisible",
                "hidden"
              );
            }
            if (focusSel && panel) {
              var el = panel.querySelector(focusSel);
              if (el && typeof el.focus === "function") el.focus();
            }
            setTimeout(function () {
              if (panel && onOpen && typeof window[onOpen] === "function") window[onOpen]();
            }, 50);
          });
        });

        panel.querySelectorAll("[data-dropdown-close]").forEach(function (btn) {
          if (btn.hasAttribute("data-close-bound")) return;
          btn.setAttribute("data-close-bound", "true");
          btn.addEventListener("click", function (e) {
            e.preventDefault();
            var inst =
              window.FlowbiteInstances && window.FlowbiteInstances.getInstance("Popover", panelId);
            if (inst && typeof inst.hide === "function") inst.hide();
            else {
              panel.classList.add("opacity-0", "invisible");
              setTimeout(function () {
                panel.classList.add("hidden");
              }, 150);
            }
          });
        });
      });

      // When dropdown open: show X on trigger; when closed: show default icon. Wire X to close.
      document.querySelectorAll(".auth-icon-close").forEach(function (closeEl) {
        var trigger = closeEl.closest("[data-popover-target], [data-dropdown-toggle]");
        if (!trigger) return;
        var panelId =
          trigger.getAttribute("data-popover-target") ||
          trigger.getAttribute("data-dropdown-toggle");
        var panel = panelId ? document.getElementById(panelId) : null;
        if (!panel) return;
        if (closeEl.hasAttribute("data-dropdown-close-bound")) return;
        closeEl.setAttribute("data-dropdown-close-bound", "true");

        function closePopover() {
          var inst =
            window.FlowbiteInstances && window.FlowbiteInstances.getInstance("Popover", panelId);
          if (inst && typeof inst.hide === "function") inst.hide();
          else {
            panel.classList.add("opacity-0", "invisible");
            setTimeout(function () {
              panel.classList.add("hidden");
            }, 150);
          }
        }
        closeEl.addEventListener("click", function (e) {
          e.preventDefault();
          e.stopPropagation();
          closePopover();
        });

        function updateTrigger(isOpen) {
          var defaultEl = trigger.querySelector(".auth-icon-default");
          if (defaultEl && closeEl) {
            if (isOpen) {
              defaultEl.style.opacity = "0";
              defaultEl.style.pointerEvents = "none";
              closeEl.style.opacity = "1";
              closeEl.style.pointerEvents = "auto";
            } else {
              defaultEl.style.opacity = "1";
              defaultEl.style.pointerEvents = "auto";
              closeEl.style.opacity = "0";
              closeEl.style.pointerEvents = "none";
            }
          }
        }
        var observer = new MutationObserver(function () {
          updateTrigger(
            !panel.classList.contains("hidden") && !panel.classList.contains("invisible")
          );
        });
        observer.observe(panel, { attributes: true, attributeFilter: ["class"] });
        updateTrigger(
          !panel.classList.contains("hidden") && !panel.classList.contains("invisible")
        );
      });
    }
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", run);
    else run();
  })();
</script>

<style>
  /* Panel above navbar: create stacking context so z-[1250] competes with nav (z-100) when panel is in body */
  [role="tooltip"][id$="-dropdown"] {
    isolation: isolate;
  }

  /* Arrow (pointer) above panel content and navbar â€“ high z-index so it never paints under the nav */
  [role="tooltip"] > .dropdown-arrow,
  [role="tooltip"] > [data-popper-arrow] {
    position: relative;
    z-index: 9999;
  }
  [role="tooltip"] > [data-popper-arrow]:before,
  [role="tooltip"] > [data-popper-arrow]:after {
    z-index: inherit;
  }

  /* Only override border-color; Flowbite sets placement-specific border-width for the arrow triangle */
  [role="tooltip"] > [data-popper-arrow]:before {
    border-color: var(--color-gray-200) !important;
  }

  [role="tooltip"] > [data-popper-arrow]:after {
    border-color: var(--color-gray-200) !important;
  }

  :global(.dark) [role="tooltip"] > [data-popper-arrow]:before {
    border-color: var(--color-gray-800) !important;
  }

  :global(.dark) [role="tooltip"] > [data-popper-arrow]:after {
    border-color: var(--color-gray-800) !important;
  }
</style>
