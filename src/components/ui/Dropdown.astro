---
/**
 * Account dropdown panel for the header avatar (AuthIcon).
 * Flowbite: trigger uses data-dropdown-toggle="account-dropdown"; this panel has id="account-dropdown".
 * Navbar.astro attaches the logout handler to #logout-btn.
 */
interface Props {
  currentUser: any;
  projects: any[];
  globalIconButtonClasses: string;
  id: string;
  title?: string;
  closeButton: boolean;
  /** Name of global function to call when dropdown opens (e.g. for lazy load or refresh) */
  onOpenCallback?: string;
  /** Selector for input to focus when dropdown opens. Must run in same click handler for iOS keypad. */
  focusSelector?: string;
}

import SimpleIcon from "../common/SimpleIcon.astro";
import CloseButton from "../ui/CloseButton.astro";
import AssignedProjects from "../common/AssignedProjects.astro";
const { id, title = "", closeButton = true, onOpenCallback, focusSelector } = Astro.props;
---

<!-- Account dropdown: Flowbite data-dropdown-toggle="account-dropdown" on AuthIcon trigger -->
<div
  id={`${id}-dropdown`}
  data-popover
  role="tooltip"
  {...(onOpenCallback ? { "data-on-open": onOpenCallback } : {})}
  {...(focusSelector ? { "data-focus-on-open": focusSelector } : {})}
  class="invisible absolute z-10 inline-block w-full max-w-md overflow-visible rounded-b-lg border border-gray-200 bg-white text-body text-sm opacity-0 shadow-lg transition-opacity duration-300 dark:border-gray-700 dark:bg-gray-900"
>
  <!-- <div class="flex max-h-[85vh] flex-col overflow-hidden">
    <div class="relative flex min-h-0 flex-1 flex-col"> -->

  <div class="p-3">
    <div class="flex">
      {
        closeButton && (
          <div class="flex shrink-0 items-center justify-between border-b border-gray-200 p-3 dark:border-gray-700">
            <slot name="title">
              {title && (
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" set:html={title} />
              )}
            </slot>
            <CloseButton data-dismiss-target={`#${id}-dropdown`} tooltipText="Close" />
          </div>
        )
      }
      <slot />
    </div>
  </div>
  <div class="relative z-10" data-popper-arrow></div>
</div>

<script is:inline>
  // Flowbite adds opacity/transition classes when closing; when reopening, only 'hidden' is
  // removed so the panel can stay invisible. Remove those classes on trigger click so dropdowns
  // (account, notifications) reopen correctly after being closed.
  // Supports both data-dropdown-toggle and data-popover-target (AuthIcon uses popover).
  // iOS keypad: focus() must run in same user gesture as click, so we focus synchronously first.
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll("[id$='-dropdown']").forEach(function (panel) {
      var panelId = panel.id;
      if (!panelId) return;
      var onOpen = panel.getAttribute("data-on-open");
      var focusSel = panel.getAttribute("data-focus-on-open");
      var selectors = "[data-dropdown-toggle='" + panelId + "'], [data-popover-target='" + panelId + "']";
      document.querySelectorAll(selectors).forEach(function (trigger) {
        trigger.addEventListener("click", function () {
          // Sync focus in same click (required for iOS keypad)
          if (focusSel && panel) {
            var el = panel.querySelector(focusSel);
            if (el && typeof el.focus === "function") el.focus();
          }
          setTimeout(function () {
            if (panel && !panel.classList.contains("hidden")) {
              panel.classList.remove(
                "opacity-0",
                "transition-opacity",
                "duration-300",
                "ease-out"
              );
              if (onOpen && typeof window[onOpen] === "function") {
                window[onOpen]();
              }
            }
          }, 10);
        });
      });
    });
  });
</script>
