---
/**
 * Account dropdown (popover) for non-authenticated users. AuthIcon uses this when !currentUser.
 * When authenticated, AuthIcon opens AccountDrawer instead.
 */
interface Props {
  currentUser: any;
  assignedProjectsCount?: number;
  assignedProjectsPreview?: any[];
  globalIconButtonClasses: string;
  id: string;
  /** Name of global function to call when dropdown opens (e.g. for refresh). */
  onOpen?: string;
}

// Redirect to API callback only when code is on a page that shouldn't handle it
const authCode = Astro.url.searchParams.get("code");
if (authCode && !Astro.url.pathname.startsWith("/auth/callback")) {
  return Astro.redirect(`/api/auth/callback?code=${authCode}`);
}

const {
  globalIconButtonClasses,
  id,
  onOpen,
  currentUser,
  assignedProjectsCount,
  assignedProjectsPreview,
} = Astro.props;
import AuthDropdown from "./AuthDropdown.astro";
import Dropdown from "./Dropdown.astro";
import LoginForm from "../../features/forms/components/LoginForm.astro";

const title = currentUser ? "" : "";
---

<Dropdown
  id={id}
  {globalIconButtonClasses}
  title={title}
  onOpenCallback={!currentUser ? onOpen : undefined}
  classList={["p-8"]}
>
  {
    !currentUser ? (
      <LoginForm id={`${id}-login-form`} redirectUrl="/project/dashboard" />
    ) : (
      <AuthDropdown
        currentUser={currentUser}
        assignedProjectsCount={assignedProjectsCount}
        assignedProjectsPreview={assignedProjectsPreview}
      />
    )
  }
</Dropdown>
<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    if (typeof window.initPageSizeToggle === "function") window.initPageSizeToggle();
  });
</script>

<style is:inline>
  :global(#account-dropdown .grid.grid-cols-1.gap-4) {
    grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
  }
</style>
