---
/**
 * Account dropdown (popover) for non-authenticated users. AuthIcon uses this when !currentUser.
 * When authenticated, AuthIcon opens AccountDrawer instead.
 */
interface Props {
  currentUser: any;
  assignedProjectsCount?: number;
  assignedProjectsPreview?: any[];
  globalIconButtonClasses: string;
  id: string;
  /** Name of global function to call when dropdown opens (e.g. for refresh). */
  onOpen?: string;
  /** When set (e.g. on project page), Check In is shown in AuthDropdown for Admin/Staff. */
  project?: any;
}

// Redirect to API callback only when code is on a page that shouldn't handle it. Preserve full query.
const authCode = Astro.url.searchParams.get("code");
if (authCode && !Astro.url.pathname.startsWith("/auth/callback")) {
  const query = Astro.url.search ? Astro.url.search : `?code=${encodeURIComponent(authCode)}`;
  return Astro.redirect(`/api/auth/callback${query}`);
}

const {
  globalIconButtonClasses,
  id,
  onOpen,
  currentUser,
  assignedProjectsCount,
  assignedProjectsPreview,
  project,
} = Astro.props;
import AuthDropdown from "./AuthDropdown.astro";
import Dropdown from "./Dropdown.astro";
import LoginForm from "../../features/forms/components/LoginForm.astro";
import SimpleIcon from "../common/SimpleIcon.astro";

const title = currentUser ? "" : "";
---

<!-- Login popover: AuthIcon uses data-popover-target when not authenticated -->
<Dropdown
  id={id}
  {globalIconButtonClasses}
  title={title}
  onOpenCallback={!currentUser ? onOpen : undefined}
  classList={["p-8"]}
>
  {
    !currentUser ? (
      <div id={id} class="relative flex min-h-[300px] flex-col pb-24">
        <div class="mb-8 flex-1">
          <LoginForm id={`${id}-login-form`} redirectUrl="/project/dashboard" />
        </div>
        <div class="bottom-0 left-0 right-0 flex border-t border-gray-200 pt-3 dark:border-gray-700">
          <a
            href="/auth/forgot-password"
            class="flex w-1/2 flex-col items-center justify-center gap-2 rounded-lg py-3 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
            title="Forgot password?"
          >
            <SimpleIcon name="key" size="lg" class="text-gray-500 dark:text-gray-400" />
            <span class="text-xs font-medium text-gray-600 dark:text-gray-300">
              Forgot password?
            </span>
          </a>
          <a
            href="/auth/register"
            class="flex w-1/2 flex-col items-center justify-center gap-2 rounded-lg py-3 transition-colors hover:bg-gray-100 dark:hover:bg-gray-800"
            title="Need an account? Register"
          >
            <SimpleIcon name="user-plus" size="lg" class="text-gray-500 dark:text-gray-400" />
            <span class="text-xs font-medium text-gray-600 dark:text-gray-300">Register</span>
          </a>
        </div>
      </div>
    ) : (
      <AuthDropdown
        currentUser={currentUser}
        assignedProjectsCount={assignedProjectsCount}
        assignedProjectsPreview={assignedProjectsPreview}
        {project}
      />
    )
  }
</Dropdown>

<style>
  :global(#account-dropdown .grid.grid-cols-1.gap-4) {
    grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
  }
</style>
