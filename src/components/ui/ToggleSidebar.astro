---
interface Props {
  currentUser: any;
}

const { currentUser } = Astro.props;
const currentRole = currentUser?.profile?.role;
const currentUrl = Astro.url.pathname;
// Show toggle: always on mobile, only when logged in on desktop
const responsiveClass = !currentUser ? "sm:hidden" : "";

// don't show toggle button during auto and login pages
if (currentUrl.includes("/auth/register") || currentUrl.includes("/auth/login")) {
  return null;
}
---

<!-- Toggle button - visible on mobile always, on desktop only when logged in -->
<button
  id="sidebar-toggle-button"
  type="button"
  aria-controls="sidebar"
  data-is-auth={currentUser ? "true" : "false"}
  class={`rounded-full inline-flex items-center p-2 text-sm text-gray-500 ${responsiveClass} mr-4 ml-1`}
>
  <div
    class="flex items-center relative h-6 justify-center overflow-hidden w-6"
    id="toggle-icon-container"
  >
    <svg
      class="transition-all duration-300 absolute h-6 lucide transform w-6 lucide-menu opacity-100 rotate-0 scale-100"
      fill="none"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      height="24"
      width="24"
      stroke="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      id="menu-icon"
      ><path d="M4 5h16"></path><path d="M4 12h16"></path><path d="M4 19h16"></path></svg
    >
    <svg
      class="transition-all duration-300 absolute h-6 lucide transform w-6 lucide-x opacity-0 -rotate-90 scale-0"
      fill="none"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      height="24"
      width="24"
      stroke="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="2"
      id="close-icon"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg
    >
  </div>

  <span class="sr-only">Open sidebar</span>
  <!-- <svg
    class="w-7 h-7"
    data-sidebar-toggle-collapse-icon=""
    aria-hidden="true"
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    fill="none"
    viewBox="0 0 24 24"
  >
    <path stroke="currentColor" stroke-linecap="round" stroke-width="1" d="M5 7h14M5 12h14M5 17h10"
    ></path>
  </svg>
  <svg
    class="hidden w-7 h-7"
    data-sidebar-toggle-expand-icon=""
    aria-hidden="true"
    xmlns="http://www.w3.org/2000/svg"
    width="24"
    height="24"
    fill="none"
    viewBox="0 0 24 24"
  >
    <path stroke="currentColor" stroke-linecap="round" stroke-width="1" d="M5 7h14M5 12h14M5 17h14"
    ></path>
  </svg> -->
</button>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggleButton = document.getElementById("sidebar-toggle-button");
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("main-content");
    const stickyActions = document.getElementById("sticky-actions");
    const collapseHideElements = document.querySelectorAll("[data-sidebar-collapse-hide]");
    const collapseShowElements = document.querySelectorAll("[data-sidebar-collapse-show]");
    const collapseIcon = document.querySelector("[data-sidebar-toggle-collapse-icon]");
    const expandIcon = document.querySelector("[data-sidebar-toggle-expand-icon]");
    const menuIcon = document.getElementById("menu-icon");
    const closeIcon = document.getElementById("close-icon");

    if (!toggleButton || !sidebar) return;

    // Check if user is authenticated
    const isAuth = toggleButton.getAttribute("data-is-auth") === "true";

    // Check if mobile (< 640px)
    const isMobile = () => window.innerWidth < 640;

    // Track if sidebar is expanded (for desktop hover behavior)
    let isHovering = false;

    // Toggle icons based on state
    const updateIcons = (isExpanded) => {
      if (collapseIcon && expandIcon) {
        if (isExpanded) {
          collapseIcon.classList.remove("hidden");
          expandIcon.classList.add("hidden");
        } else {
          collapseIcon.classList.add("hidden");
          expandIcon.classList.remove("hidden");
        }
      }

      // Toggle between menu and close icons
      if (menuIcon && closeIcon) {
        if (isExpanded) {
          // Show close icon (X)
          menuIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          menuIcon.classList.add("opacity-0", "rotate-90", "scale-0");
          closeIcon.classList.remove("opacity-0", "-rotate-90", "scale-0");
          closeIcon.classList.add("opacity-100", "rotate-0", "scale-100");
        } else {
          // Show menu icon (hamburger)
          menuIcon.classList.remove("opacity-0", "rotate-90", "scale-0");
          menuIcon.classList.add("opacity-100", "rotate-0", "scale-100");
          closeIcon.classList.remove("opacity-100", "rotate-0", "scale-100");
          closeIcon.classList.add("opacity-0", "-rotate-90", "scale-0");
        }
      }
    };

    // Lock body scroll (mobile only)
    const lockBodyScroll = () => {
      document.body.style.overflow = "hidden";
      document.body.style.touchAction = "none";
    };

    // Unlock body scroll
    const unlockBodyScroll = () => {
      document.body.style.overflow = "";
      document.body.style.touchAction = "";
    };

    // Show collapse-hide elements (expanded state)
    const showCollapseElements = () => {
      collapseHideElements.forEach((el) => el.classList.remove("hidden"));
      collapseShowElements.forEach((el) => el.classList.add("hidden"));
      collapseShowElements.forEach((el) => el.classList.remove("flex"));
    };

    // Hide collapse-hide elements (collapsed state)
    const hideCollapseElements = () => {
      collapseHideElements.forEach((el) => el.classList.add("hidden"));
      collapseShowElements.forEach((el) => el.classList.remove("hidden"));
      collapseShowElements.forEach((el) => el.classList.add("flex"));
    };

    // MOBILE: Show sidebar (slide in)
    const showSidebarMobile = () => {
      sidebar.classList.remove("-translate-x-full");
      sidebar.classList.add("translate-x-0");
      sidebar.classList.remove("w-16");
      sidebar.classList.add("w-64");
      showCollapseElements();
      lockBodyScroll();
      if (mainContent) {
        mainContent.classList.add("overflow-hidden", "blur-sm", "pointer-events-none");
      }
      toggleButton.setAttribute("aria-expanded", "true");
      updateIcons(true);
    };

    // MOBILE: Hide sidebar (slide out)
    const hideSidebarMobile = () => {
      sidebar.classList.remove("translate-x-0");
      sidebar.classList.add("-translate-x-full");
      unlockBodyScroll();
      if (mainContent) {
        mainContent.classList.remove("overflow-hidden", "blur-sm", "pointer-events-none");
      }
      toggleButton.setAttribute("aria-expanded", "false");
      updateIcons(false);
    };

    // DESKTOP: Expand sidebar (show text labels)
    const expandSidebarDesktop = () => {
      sidebar.classList.remove("w-16");
      sidebar.classList.add("w-64");
      showCollapseElements();
      if (mainContent) {
        mainContent.classList.remove("sm:ml-16");
        mainContent.classList.add("ml-64");
      }

      toggleButton.setAttribute("aria-expanded", "true");
      updateIcons(true);
    };

    // DESKTOP: Collapse sidebar (icons only)
    const collapseSidebarDesktop = () => {
      sidebar.classList.remove("w-64");
      sidebar.classList.add("w-16");
      hideCollapseElements();
      if (mainContent) {
        mainContent.classList.remove("ml-64");
        mainContent.classList.add("sm:ml-16");
      }
      toggleButton.setAttribute("aria-expanded", "false");
      updateIcons(false);
    };

    // Toggle handler
    toggleButton.addEventListener("click", () => {
      if (isMobile()) {
        // Mobile: slide in/out
        const isHidden = sidebar.classList.contains("-translate-x-full");
        if (isHidden) {
          showSidebarMobile();
        } else {
          hideSidebarMobile();
        }
      } else {
        // Desktop: expand/collapse (icons only vs full)
        const isCollapsed = sidebar.classList.contains("w-16");
        if (isCollapsed) {
          expandSidebarDesktop();
        } else {
          collapseSidebarDesktop();
        }
      }
    });

    // Desktop hover behavior: expand on hover, collapse on leave
    if (isAuth) {
      sidebar.addEventListener("mouseenter", () => {
        if (!isMobile() && sidebar.classList.contains("w-16")) {
          isHovering = true;
          expandSidebarDesktop();
        }
      });

      sidebar.addEventListener("mouseleave", () => {
        if (!isMobile() && isHovering) {
          isHovering = false;
          collapseSidebarDesktop();
        }
      });
    }

    // Close on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        if (isMobile() && !sidebar.classList.contains("-translate-x-full")) {
          hideSidebarMobile();
        }
      }
    });

    // Close on click outside (mobile only)
    document.addEventListener("click", (e) => {
      if (isMobile() && !sidebar.classList.contains("-translate-x-full")) {
        // Check if click is outside sidebar and toggle button
        if (!sidebar.contains(e.target as Node) && !toggleButton.contains(e.target as Node)) {
          hideSidebarMobile();
        }
      }
    });

    // Swipe to close functionality (mobile only)
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isDragging = false;
    let currentTranslateX = 0;

    sidebar.addEventListener("touchstart", (e) => {
      if (!isMobile()) return;
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isDragging = true;
      sidebar.style.transition = "none";
    });

    sidebar.addEventListener("touchmove", (e) => {
      if (!isMobile() || !isDragging) return;

      const touchCurrentX = e.touches[0].clientX;
      const touchCurrentY = e.touches[0].clientY;
      const deltaX = touchCurrentX - touchStartX;
      const deltaY = touchCurrentY - touchStartY;

      // Only respond to horizontal swipes (left)
      if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX < 0) {
        currentTranslateX = deltaX;
        sidebar.style.transform = `translateX(${deltaX}px)`;
      }
    });

    sidebar.addEventListener("touchend", (e) => {
      if (!isMobile() || !isDragging) return;

      isDragging = false;
      sidebar.style.transition = "";
      sidebar.style.transform = "";

      const deltaX = touchEndX - touchStartX;
      const swipeThreshold = 100; // minimum swipe distance in pixels

      // If swiped left more than threshold, close sidebar
      if (currentTranslateX < -swipeThreshold) {
        hideSidebarMobile();
      }

      currentTranslateX = 0;
      touchStartX = 0;
      touchStartY = 0;
      touchEndX = 0;
      touchEndY = 0;
    });

    // Handle resize
    window.addEventListener("resize", () => {
      if (!isMobile()) {
        // Switching to desktop
        unlockBodyScroll();
        if (mainContent) {
          mainContent.classList.remove("overflow-hidden", "blur-sm", "pointer-events-none");
        }
        // On desktop with auth: show collapsed sidebar
        if (isAuth) {
          sidebar.classList.remove("-translate-x-full");
          sidebar.classList.add("translate-x-0");
          collapseSidebarDesktop();
        }
      } else {
        // Switching to mobile
        if (mainContent) {
          mainContent.classList.remove("sm:ml-64", "sm:ml-16");
        }
        // Hide sidebar on mobile
        hideSidebarMobile();
      }
    });

    // Initialize
    if (isMobile()) {
      // Mobile: sidebar hidden by default
      sidebar.classList.add("-translate-x-full");
    } else if (isAuth) {
      // Desktop with auth: show collapsed sidebar (icons only)
      sidebar.classList.remove("-translate-x-full");
      sidebar.classList.add("translate-x-0");
      collapseSidebarDesktop();
    }
  });
</script>
