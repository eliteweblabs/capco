---
interface Props {
  currentUser: any;
}

const { currentUser } = Astro.props;
const currentRole = currentUser?.profile?.role;
const currentUrl = Astro.url.pathname;
// Show toggle: always on mobile, only when logged in on desktop
const responsiveClass = !currentUser ? "md:hidden" : "";
---

<button
  type="button"
  data-sidebar-toggle-button
  aria-controls="sidebar"
  data-is-auth={currentUser ? "true" : "false"}
  class={`inline-flex items-center p-4 text-sm ${responsiveClass}`}
>
  <div class="relative flex h-6 w-6 items-center justify-center overflow-hidden">
    <svg
      class="sidebar-toggle-menu-icon absolute h-6 w-6 rotate-0 scale-100 transform opacity-100 transition-all duration-300"
      fill="none"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      height="24"
      width="24"
      stroke="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="1"
      ><path d="M4 5h16"></path><path d="M4 12h16"></path><path d="M4 19h16"></path></svg
    >
    <svg
      class="sidebar-toggle-close-icon absolute h-6 w-6 -rotate-90 scale-0 transform opacity-0 transition-all duration-300"
      fill="none"
      viewBox="0 0 24 24"
      xmlns="http://www.w3.org/2000/svg"
      height="24"
      width="24"
      stroke="currentColor"
      stroke-linecap="round"
      stroke-linejoin="round"
      stroke-width="1"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg
    >
  </div>

  <span class="sr-only">Open sidebar</span>
</button>

<script>
  import { BREAKPOINTS } from "../../lib/ux-utils";

  /** AbortController to remove previous listeners when re-initing (SPA navigations). */
  let sidebarAbortController: AbortController | null = null;

  function initSidebar() {
    // Abort previous run to avoid duplicate document/window listeners
    sidebarAbortController?.abort();
    sidebarAbortController = new AbortController();
    const signal = sidebarAbortController.signal;

    const toggleButtons = Array.from(document.querySelectorAll("[data-sidebar-toggle-button]"));
    const sidebar = document.getElementById("sidebar");
    const mainContent = document.getElementById("main-content");
    const collapseHideElements = document.querySelectorAll("[data-sidebar-collapse-hide]");
    const collapseShowElements = document.querySelectorAll("[data-sidebar-collapse-show]");
    const collapseIcon = document.querySelector("[data-sidebar-toggle-collapse-icon]");
    const expandIcon = document.querySelector("[data-sidebar-toggle-expand-icon]");

    if (!toggleButtons.length || !sidebar) return;

    // Check if user is authenticated (from first toggle button)
    const isAuth = toggleButtons[0].getAttribute("data-is-auth") === "true";

    // Use global breakpoint (Tailwind sm)
    const isMobile = () => window.innerWidth < BREAKPOINTS.MD;

    // Track if sidebar is expanded (for desktop hover behavior)
    let isHovering = false;

    // Toggle icons based on state â€” update ALL instances (navbar + sticky actions, etc.) so they stay in sync
    const updateIcons = (isExpanded: boolean) => {
      if (collapseIcon && expandIcon) {
        if (isExpanded) {
          collapseIcon.classList.remove("hidden");
          expandIcon.classList.add("hidden");
        } else {
          collapseIcon.classList.add("hidden");
          expandIcon.classList.remove("hidden");
        }
      }

      const allMenuIcons = document.querySelectorAll(".sidebar-toggle-menu-icon");
      const allCloseIcons = document.querySelectorAll(".sidebar-toggle-close-icon");

      if (isExpanded) {
        allMenuIcons.forEach((el) => {
          el.classList.remove("opacity-100", "rotate-0", "scale-100");
          el.classList.add("opacity-0", "rotate-90", "scale-0");
        });
        allCloseIcons.forEach((el) => {
          el.classList.remove("opacity-0", "-rotate-90", "scale-0");
          el.classList.add("opacity-100", "rotate-0", "scale-100");
        });
      } else {
        allMenuIcons.forEach((el) => {
          el.classList.remove("opacity-0", "rotate-90", "scale-0");
          el.classList.add("opacity-100", "rotate-0", "scale-100");
        });
        allCloseIcons.forEach((el) => {
          el.classList.remove("opacity-100", "rotate-0", "scale-100");
          el.classList.add("opacity-0", "-rotate-90", "scale-0");
        });
      }
    };

    const lockBodyScroll = () => {
      document.body.style.overflow = "hidden";
    };
    const unlockBodyScroll = () => {
      document.body.style.overflow = "";
    };

    const showCollapseElements = () => {
      collapseHideElements.forEach((el) => el.classList.remove("hidden"));
      collapseShowElements.forEach((el) => el.classList.add("hidden"));
      collapseShowElements.forEach((el) => el.classList.remove("flex"));
    };

    const hideCollapseElements = () => {
      collapseHideElements.forEach((el) => el.classList.add("hidden"));
      collapseShowElements.forEach((el) => el.classList.remove("hidden"));
      collapseShowElements.forEach((el) => el.classList.add("flex"));
    };

    const showSidebarMobile = () => {
      sidebar.classList.remove("-translate-x-full");
      sidebar.classList.add("translate-x-0");
      sidebar.classList.remove("w-16");
      sidebar.classList.add("w-64");
      showCollapseElements();
      lockBodyScroll();
      if (mainContent) {
        mainContent.classList.add("overflow-hidden", "pointer-events-none");
      }
      toggleButtons.forEach((btn) => btn.setAttribute("aria-expanded", "true"));
      updateIcons(true);
    };

    const hideSidebarMobile = () => {
      sidebar.classList.remove("translate-x-0");
      sidebar.classList.add("-translate-x-full");
      unlockBodyScroll();
      if (mainContent) {
        mainContent.classList.remove("overflow-hidden", "pointer-events-none");
      }
      toggleButtons.forEach((btn) => btn.setAttribute("aria-expanded", "false"));
      updateIcons(false);
    };

    const SIDEBAR_STORAGE_KEY = "sidebar-expanded";

    const expandSidebarDesktop = () => {
      sidebar.classList.remove("w-16");
      sidebar.classList.add("w-64");
      showCollapseElements();
      if (mainContent) {
        mainContent.style.marginLeft = "16rem";
      }
      toggleButtons.forEach((btn) => btn.setAttribute("aria-expanded", "true"));
      updateIcons(true);
    };

    const collapseSidebarDesktop = () => {
      sidebar.classList.remove("w-64");
      sidebar.classList.add("w-16");
      hideCollapseElements();
      if (mainContent) {
        mainContent.style.marginLeft = "4rem";
      }
      toggleButtons.forEach((btn) => btn.setAttribute("aria-expanded", "false"));
      updateIcons(false);
    };

    const handleToggleClick = () => {
      if (isMobile()) {
        const isHidden = sidebar.classList.contains("-translate-x-full");
        if (isHidden) showSidebarMobile();
        else hideSidebarMobile();
      } else {
        const isCollapsed = sidebar.classList.contains("w-16");
        if (isCollapsed) {
          expandSidebarDesktop();
          try {
            localStorage.setItem(SIDEBAR_STORAGE_KEY, "true");
          } catch {
            /* ignore localStorage errors */
          }
        } else {
          collapseSidebarDesktop();
          try {
            localStorage.setItem(SIDEBAR_STORAGE_KEY, "false");
          } catch {
            /* ignore localStorage errors */
          }
        }
      }
    };

    toggleButtons.forEach((btn) => btn.addEventListener("click", handleToggleClick, { signal }));

    if (isAuth) {
      sidebar.addEventListener(
        "mouseenter",
        () => {
          if (!isMobile() && sidebar.classList.contains("w-16")) {
            isHovering = true;
            expandSidebarDesktop();
          }
        },
        { signal }
      );

      sidebar.addEventListener(
        "mouseleave",
        () => {
          if (!isMobile() && isHovering) {
            isHovering = false;
            collapseSidebarDesktop();
          }
        },
        { signal }
      );
    }

    document.addEventListener(
      "keydown",
      (e) => {
        if (e.key === "Escape") {
          if (isMobile() && !sidebar.classList.contains("-translate-x-full")) {
            hideSidebarMobile();
          }
        }
      },
      { signal }
    );

    document.addEventListener(
      "click",
      (e) => {
        if (isMobile() && !sidebar.classList.contains("-translate-x-full")) {
          if (
            !sidebar.contains(e.target as Node) &&
            !toggleButtons.some((btn) => btn.contains(e.target as Node))
          ) {
            hideSidebarMobile();
          }
        }
      },
      { signal }
    );

    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;
    let isDragging = false;
    let currentTranslateX = 0;

    sidebar.addEventListener(
      "touchstart",
      (e) => {
        if (!isMobile()) return;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        isDragging = true;
        sidebar.style.transition = "none";
      },
      { signal }
    );

    sidebar.addEventListener(
      "touchmove",
      (e) => {
        if (!isMobile() || !isDragging) return;
        const touchCurrentX = e.touches[0].clientX;
        const touchCurrentY = e.touches[0].clientY;
        const deltaX = touchCurrentX - touchStartX;
        const deltaY = touchCurrentY - touchStartY;
        if (Math.abs(deltaX) > Math.abs(deltaY) && deltaX < 0) {
          currentTranslateX = deltaX;
          sidebar.style.transform = `translateX(${deltaX}px)`;
        }
      },
      { signal }
    );

    sidebar.addEventListener(
      "touchend",
      () => {
        if (!isMobile() || !isDragging) return;
        isDragging = false;
        sidebar.style.transition = "";
        sidebar.style.transform = "";
        if (currentTranslateX < -100) hideSidebarMobile();
        currentTranslateX = 0;
        touchStartX = 0;
        touchStartY = 0;
        touchEndX = 0;
        touchEndY = 0;
      },
      { signal }
    );

    window.addEventListener(
      "resize",
      () => {
        if (!isMobile()) {
          unlockBodyScroll();
          if (mainContent) {
            mainContent.classList.remove("overflow-hidden", "blur-sm", "pointer-events-none");
          }
          if (isAuth) {
            sidebar.classList.remove("-translate-x-full");
            sidebar.classList.add("translate-x-0");
            collapseSidebarDesktop();
          }
        } else {
          if (mainContent) mainContent.style.marginLeft = "";
          hideSidebarMobile();
        }
      },
      { signal }
    );

    // Initialize visibility state (critical: runs on SPA swap so sidebar shows after navigation)
    if (isMobile()) {
      sidebar.classList.add("-translate-x-full");
    } else if (isAuth) {
      sidebar.classList.remove("-translate-x-full");
      sidebar.classList.add("translate-x-0");
      try {
        const remembered = localStorage.getItem(SIDEBAR_STORAGE_KEY);
        if (remembered === "true") expandSidebarDesktop();
        else collapseSidebarDesktop();
      } catch (_) {
        collapseSidebarDesktop();
      }
    }
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initSidebar);
  } else {
    initSidebar();
  }
  // SPA disabled: document.addEventListener("astro:page-load", () => requestAnimationFrame(initSidebar));
</script>
