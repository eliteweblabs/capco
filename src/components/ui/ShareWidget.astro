---
/**
 * ShareWidget - Awwwards-style share button with expandable pill.
 * Uses proximity logic: hover to show, delayed hide when leaving so the cursor can
 * move between trigger and pill without closing. Click toggles on touch devices.
 * Uses SimpleIcon for icons.
 */
import SimpleIcon from "../common/SimpleIcon.astro";
import CloseButton from "./CloseButton.astro";

interface Props {
  /** URL to share. Defaults to current page URL (set client-side if not provided). */
  url?: string;
  /** Title for LinkedIn/Open Graph. */
  title?: string;
  /** Text for Twitter tweet. */
  text?: string;
  /** Additional classes for the wrapper. */
  class?: string;

  direction?: "left" | "right";
  globalIconButtonClasses?: string;
  isBackend?: boolean;

}



const {
  url = "",
  title = "",
  text = "",
  class: className = "",
  direction = "left",
  globalIconButtonClasses = "",
  isBackend = false,
} = Astro.props;

if (isBackend) {
  return;
}

// Build share URLs (url/title/text filled client-side if empty)
const encodedUrl = url ? encodeURIComponent(url) : "{{SHARE_URL}}";
const encodedTitle = title ? encodeURIComponent(title) : "{{SHARE_TITLE}}";
const encodedText = text ? encodeURIComponent(text) : "{{SHARE_TEXT}}";

const twitterHref = `https://twitter.com/intent/tweet?text=${encodedText}&url=${encodedUrl}`;
const linkedinHref = `https://www.linkedin.com/shareArticle?mini=true&url=${encodedUrl}&title=${encodedTitle}`;
const facebookHref = `https://www.facebook.com/sharer.php?u=${encodedUrl}&t=${encodedTitle}`;
---

<div class={["share-widget-wrapper", className, globalIconButtonClasses].filter(Boolean).join(" ")}>
  <span
    class="share-widget__item relative inline-flex cursor-pointer"
    data-share-trigger
    aria-label="Share"
  >
    <span class="share-widget__icon" data-share-icon>
      <SimpleIcon name="share" size="sm" />
    </span>
    <div
      class:list={[
        "share-widget__pill pointer-events-none absolute top-1/2 -z-10 flex -translate-y-1/2 items-center gap-3 overflow-hidden rounded-full bg-gray-800 dark:bg-gray-200 p-2 opacity-0 transition-opacity duration-200 data-[visible]:pointer-events-auto data-[visible]:z-10 data-[visible]:opacity-100",
        direction === "left" ? "right-0" : "left-0",
      ]}
      data-share-box
      role="toolbar"
      aria-label="Share options"
    >
      <a
        href={twitterHref}
        target="_blank"
        rel="noopener noreferrer"
        class="share-widget__link share-widget__link--1 flex items-center justify-center text-gray-400 transition-[color,transform] duration-300 ease-out hover:text-gray-200 [&_svg]:!fill-current"
        aria-label="Share on X (Twitter)"
        data-share-link
      >
        <SimpleIcon name="x-twitter" size="md" class="h-5 w-5" />
      </a>
      <a
        href={linkedinHref}
        target="_blank"
        rel="noopener noreferrer"
        class="share-widget__link share-widget__link--2 flex items-center justify-center text-gray-400 transition-[color,transform] duration-300 ease-out hover:text-gray-200 [&_svg_path]:!fill-current"
        aria-label="Share on LinkedIn"
        data-share-link
      >
        <SimpleIcon name="linkedin" size="md" class="h-5 w-5" />
      </a>
      <a
        href={facebookHref}
        target="_blank"
        rel="noopener noreferrer"
        class="share-widget__link share-widget__link--3 flex items-center justify-center text-gray-400 transition-[color,transform] duration-300 ease-out hover:text-gray-200 [&_svg_path]:!fill-current"
        aria-label="Share on Facebook"
        data-share-link
      >
        <SimpleIcon name="facebook" size="md" class="h-5 w-5" />
      </a>
      <CloseButton
        class="share-widget__close ml-0.5 flex items-center justify-center text-white transition-colors hover:text-gray-200"
        aria-label="Close share menu"
        data-share-close
        tooltip={false}
      />
      <!-- <button
        type="button"
        class="share-widget__close ml-0.5 flex items-center justify-center text-white transition-colors hover:text-gray-200"
        aria-label="Close share menu"
        data-share-close
      >
        <SimpleIcon name="x" size="md" class="h-5 w-5" />
      </button> -->
    </div>
  </span>
</div>

<style>
  /* Stacked-coin slide: all 3 start stacked (right), slide left; first stops at slot 1, then 2nd at slot 2, then 3rd at slot 3 */
  [data-share-box] .share-widget__link {
    --slot: 2rem; /* icon 20px + gap 12px â‰ˆ 32px */
    transition:
      transform 0.4s ease-out,
      color 0.2s;
  }
  [data-share-box] .share-widget__link--1 {
    transform: translateX(calc(3 * var(--slot)));
  }
  [data-share-box] .share-widget__link--2 {
    transform: translateX(calc(2 * var(--slot)));
  }
  [data-share-box] .share-widget__link--3 {
    transform: translateX(var(--slot));
  }
  [data-share-box][data-visible] .share-widget__link--1 {
    transform: translateX(0);
    transition-duration: 0.16s;
  }
  [data-share-box][data-visible] .share-widget__link--2 {
    transform: translateX(0);
    transition-duration: 0.32s;
  }
  [data-share-box][data-visible] .share-widget__link--3 {
    transform: translateX(0);
    transition-duration: 0.48s;
  }
</style>

<script is:inline>
  (function () {
    var PROXIMITY_DELAY_MS = 180;
    function initShareWidget() {
      document.querySelectorAll("[data-share-trigger]").forEach(function (trigger) {
        if (trigger.hasAttribute("data-share-bound")) return;
        trigger.setAttribute("data-share-bound", "true");
        var box = trigger.querySelector("[data-share-box]");
        var closeBtn = trigger.querySelector("[data-share-close]");
        var links = trigger.querySelectorAll("[data-share-link]");
        links.forEach(function (link) {
          var href = link.getAttribute("href") || "";
          if (href.indexOf("{{SHARE_URL}}") !== -1 || href.indexOf("{{SHARE_TITLE}}") !== -1 || href.indexOf("{{SHARE_TEXT}}") !== -1) {
            href = href
              .replace("{{SHARE_URL}}", encodeURIComponent(window.location.href))
              .replace("{{SHARE_TITLE}}", encodeURIComponent(document.title || ""))
              .replace("{{SHARE_TEXT}}", encodeURIComponent(document.title || ""));
            link.setAttribute("href", href);
          }
        });
        var iconEl = trigger.querySelector("[data-share-icon]");
        var hideTimer = null;
        function show() {
          if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
          if (box) box.setAttribute("data-visible", "");
          if (iconEl) iconEl.classList.add("invisible");
        }
        function hide() {
          hideTimer = null;
          if (box) box.removeAttribute("data-visible");
          if (iconEl) iconEl.classList.remove("invisible");
        }
        function scheduleHide() {
          if (hideTimer) return;
          hideTimer = window.setTimeout(hide, PROXIMITY_DELAY_MS);
        }
        function cancelHide() {
          if (hideTimer) { clearTimeout(hideTimer); hideTimer = null; }
        }
        var isTouchDevice = "ontouchstart" in window || navigator.maxTouchPoints > 0;
        if (!isTouchDevice) {
          trigger.addEventListener("mouseenter", function () { cancelHide(); show(); });
          trigger.addEventListener("mouseleave", scheduleHide);
          if (box) {
            box.addEventListener("mouseenter", function () { cancelHide(); show(); });
            box.addEventListener("mouseleave", scheduleHide);
          }
        }
        trigger.addEventListener("click", function (e) {
          if (e.target.closest && (e.target.closest("[data-share-close]") || e.target.closest("[data-share-link]"))) return;
          e.preventDefault();
          if (box && box.hasAttribute("data-visible")) hide(); else show();
        });
        if (closeBtn) {
          closeBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            cancelHide();
            hide();
          });
        }
        document.addEventListener("click", function (e) {
          if (!trigger.contains(e.target)) { cancelHide(); hide(); }
        });
      });
    }
    if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", initShareWidget);
    else initShareWidget();
    setTimeout(initShareWidget, 400);
  })();
</script>
