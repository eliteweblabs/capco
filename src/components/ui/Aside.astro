---
// Flowbite Sidebar Component
// Based on Flowbite dashboard design patterns

import { isFeatureEnabled } from "../../lib/features";
import { getSectionNavigation } from "../../lib/feature-navigation";
import HttpChatWidget from "../../features/chat/components/HttpChatWidget.astro";
// import CampfireChatWidget from "../../features/chat/components/CampfireChatWidget.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import Socials from "./Socials.astro";
import { globalCompanyData } from "../../pages/api/global/global-company-data";

interface Props {
  currentUser: any;
  globalInputClasses: string;
  primaryTextClasses: string;
  projects: any[];
  mobileNavigationHTML?: string;
}

const { currentUser, globalInputClasses, primaryTextClasses, projects, mobileNavigationHTML } =
  Astro.props;

const currentRole = currentUser?.profile?.role;

// Check feature flags
const chatEnabled = await isFeatureEnabled("chat");

// Get social networks from CMS settings
const companyData = await globalCompanyData();
const socialNetworks = companyData.socialNetworks || [];

// Get dynamic navigation based on enabled features and user role
const adminNavItems = await getSectionNavigation("admin", currentRole);
const toolsNavItems = await getSectionNavigation("tools", currentRole);

// Get current page URL for active state
const currentPath = Astro.url.pathname;

// Helper function to check if a link is active
const isActive = (href: string) => {
  if (!href || href === "#") return false;
  // Exact match or starts with the path (for subpages)
  return currentPath === href || (href !== "/" && currentPath.startsWith(href));
};

const anchorClasses =
  "hover:bg-gray-300 dark:hover:bg-gray-700 flex w-full align-center rounded-lg px-3 py-2 whitespace-nowrap";
const activeClasses = "bg-gray-300 dark:bg-gray-700 font-bold";
const svgClasses = "h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400";
---

<aside
  id="sidebar"
  class="sticky shadow-primary-md top-[100px] left-0 z-40 w-64 h-[calc(85dvh)] transition-all duration-300 -translate-x-full color-background-80 backdrop-blur-sm shadow-md shadow-black/10 font-secondary flex flex-col rounded-xl"
  aria-label="Sidebar"
>
  <div class="flex-1 px-3 py-4 overflow-y-auto overscroll-contain no-scrollbar">
    <ul
      class={`block md:hidden space-y-2 text-xs font-medium uppercase tracking-wider ${primaryTextClasses}`}
      id="sidebar-menu-1"
    >
      <!-- front end navigation (mobile only) -->
      <Fragment set:html={mobileNavigationHTML} />
    </ul>

    <ul
      class={`space-y-2 text-xs font-medium uppercase tracking-wider ${primaryTextClasses}`}
      id="sidebar-menu"
    >
      <!-- {currentUser && currentUser.id && currentRole !== "Client"  && (

<li class="pt-4 pb-2 text-xs text-gray-500 dark:text-gray-400 uppercase">Pages</li>

       
  )} -->

      <!-- Dashboard (Always shown) -->

      {
        currentUser && currentUser.id && (
          <li>
            <a href="/dashboard" type="button" class={`${anchorClasses} ${isActive("/dashboard") ? activeClasses : ""}`}>
              <SimpleIcon name="dashboard" class={svgClasses} />
              <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                Dashboard
              </span>
            </a>
          </li>
        )
      }

      {
        currentUser && currentUser.id && currentRole === "Admin" && (
          <>
            <li>
              <a href="/admin/settings" type="button" class={`${anchorClasses} ${isActive("/admin/settings") ? activeClasses : ""}`}>
                <SimpleIcon name="settings" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Settings
                </span>
              </a>
            </li>

            <li>
              <a
                type="button"
                class={`${anchorClasses} ${isActive("/admin/design") ? activeClasses : ""}`}
                aria-controls="dropdown-design"
                data-collapse-toggle="dropdown-design"
                data-sidebar-collapse-item=""
                href="#"
              >
                <SimpleIcon name="palette" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Design
                </span>
                <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
              </a>
              <ul id="dropdown-design" class="hidden space-y-2 py-2 pl-6">
                <li>
                  <a
                    href="/admin/design"
                    class={`${anchorClasses} ${isActive("/admin/design") && currentPath === "/admin/design" ? activeClasses : ""}`}
                    data-sidebar-collapse-subitem=""
                  >
                    Components
                  </a>
                </li>
                <li>
                  <a
                    href="/admin/design/placeholders"
                    class={`${anchorClasses} ${isActive("/admin/design/placeholders") ? activeClasses : ""}`}
                    data-sidebar-collapse-subitem=""
                  >
                    Placeholders
                  </a>
                </li>
              </ul>
            </li>

            <li>
              <a href="/admin/cms" type="button" class={`${anchorClasses} ${isActive("/admin/cms") ? activeClasses : ""}`}>
                <SimpleIcon name="dashboard" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Content
                </span>
              </a>
            </li>

            <li>
              <a href="/admin/media" type="button" class={`${anchorClasses} ${isActive("/admin/media") ? activeClasses : ""}`}>
                <SimpleIcon name="image" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Media
                </span>
              </a>
            </li>

            <li>
              <a href="/admin/banner-alerts" type="button" class={`${anchorClasses} ${isActive("/admin/banner-alerts") ? activeClasses : ""}`}>
                <SimpleIcon name="alert" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Alerts
                </span>
              </a>
            </li>
          </>
        )
      }

      {
        currentUser && (
          <li>
            <a
              type="button"
              class={`${anchorClasses} ${isActive("/project") ? activeClasses : ""}`}
              aria-controls="dropdown-projects"
              data-collapse-toggle="dropdown-projects"
              data-sidebar-collapse-item=""
              href="#"
            >
              <SimpleIcon
                name="folder"
                class="h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400"
              />

              <span class="ml-3 flex-1 whitespace-nowrap text-left" data-sidebar-collapse-hide="">
                Projects
              </span>
              <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
            </a>

            <ul id="dropdown-projects" class="hidden space-y-2 py-2 pl-8">
              <li>
                <a
                  href="/project/dashboard/"
                  class={`${anchorClasses} ${isActive("/project/dashboard") ? activeClasses : ""}`}
                  data-sidebar-collapse-subitem=""
                  data-sidebar-collapse-hide
                >
                  Dashboard
                </a>
              </li>
              <li>
                <a href="/project/new" class={`${anchorClasses} ${isActive("/project/new") ? activeClasses : ""}`} data-sidebar-collapse-subitem="" data-sidebar-collapse-hide>
                  New
                </a>
              </li>
              {currentUser && currentRole === "Admin" && (
                <li>
                  <a
                    href="/project/proposals"
                    class={`${anchorClasses} ${isActive("/project/proposals") ? activeClasses : ""}`}
                    data-sidebar-collapse-subitem=""
                    data-sidebar-collapse-hide
                  >
                    Proposals
                  </a>
                </li>
                 <li>
                  <a
                    href="/project/settings"
                    class={`${anchorClasses} ${isActive("/project/settings") ? activeClasses : ""}`}
                    data-sidebar-collapse-subitem=""
                    data-sidebar-collapse-hide
                  >
                    Settings
                  </a>
                </li>
              )}
            </ul>
          </li>
        )
      }

      <!-- Dynamic Admin Features (from site-config.json) -->
      {
        currentUser &&
          currentRole === "Admin" &&
          adminNavItems.map((item) => (
            <li>
              <a href={item.href} class={`${anchorClasses} ${isActive(item.href) ? activeClasses : ""}`} data-sidebar-collapse-item="">
                {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  {item.label}
                </span>
              </a>
            </li>
          ))
      }

      <!-- Notification Bell -->
      {
        currentUser && currentUser.id && currentRole !== "Client" && (
          <li>
            <a
              id="notification-bell"
              href="#"
              class={`${anchorClasses}`}
              data-sidebar-collapse-item=""
              data-modal-target="notificationsModal"
              data-modal-toggle="notificationsModal"
              data-user-id={currentUser.id}
              title="View notifications"
              data-tooltip-target="tooltip-notifications"
              data-tooltip-placement="right"
            >
              <SimpleIcon name="bell" class={svgClasses} />
              <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                View notifications
              </span>
            </a>
            <div
              id="tooltip-notifications"
              role="tooltip"
              class="absolute z-10 invisible inline-block px-3 py-2 text-sm font-medium text-white transition-opacity duration-300 bg-gray-900 rounded-lg shadow-sm opacity-0 tooltip dark:bg-gray-700"
            >
              View notifications
              <div class="tooltip-arrow" data-popper-arrow />
            </div>
          </li>
        )
      }

      <!-- Admin-Only: Send Notifications -->
      {
        currentRole === "Admin" && (
          <li>
            <a href="/admin/notifications" class={`${anchorClasses} ${isActive("/admin/notifications") ? activeClasses : ""}`} data-sidebar-collapse-item="">
              <SimpleIcon name="zap" class={svgClasses} />
              <span class="ml-3 flex-1 whitespace-nowrap text-left" data-sidebar-collapse-hide="">
                Send Notifications
              </span>
            </a>
          </li>
        )
      }

      <!-- Dev Test (Specific user) -->
      {
        currentRole === "Admin" && currentUser.email === "tom@tomsens.com" && (
          <li>
            <a href="/admin/update-test" class={`${anchorClasses} ${isActive("/admin/update-test") ? activeClasses : ""}`} data-sidebar-collapse-item="">
              <SimpleIcon name="alert" class={svgClasses} />
              <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                Update Msg Test
              </span>
            </a>
          </li>
        )
      }

      <!-- Dynamic Tools Features -->
      {
        currentUser && currentRole === "Admin" && toolsNavItems.length > 0 && (
          <li class="pt-4 pb-2">
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase">Tools</span>
          </li>
        )
      }
      {
        currentUser &&
          currentRole === "Admin" &&
          toolsNavItems.map((item) => (
            <li>
              <a href={item.href} class={`${anchorClasses} ${isActive(item.href) ? activeClasses : ""}`} data-sidebar-collapse-item="">
                {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  {item.label}
                </span>
              </a>
            </li>
          ))
      }

      {
        currentUser && currentRole === "Admin" && (
          <li>
            <a
              type="button"
              class={`${anchorClasses} ${isActive("/tests") ? activeClasses : ""}`}
              aria-controls="dropdown-tests"
              data-collapse-toggle="dropdown-tests"
              data-sidebar-collapse-item=""
              href="#"
            >
              <SimpleIcon
                name="folder"
                class="h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400"
              />

              <span class="ml-3 flex-1 whitespace-nowrap text-left" data-sidebar-collapse-hide="">
                Tests
              </span>
              <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
            </a>

            <ul id="dropdown-tests" class="hidden space-y-2 py-2">
              <li>
                <a
                  href="/tests/cal-booking/"
                  class={`${anchorClasses} ${isActive("/tests/cal-booking") ? activeClasses : ""} ml-6`}
                  data-sidebar-collapse-subitem=""
                >
                  Cal.com Booking
                </a>
              </li>
              <li>
                <a
                  href="/tests/push-notifications/"
                  class={`${anchorClasses} ${isActive("/tests/push-notifications") ? activeClasses : ""} ml-6`}
                  data-sidebar-collapse-subitem=""
                >
                  Push Notifications
                </a>
              </li>
              <li>
                <a
                  href="/tests/vapi-booking/"
                  class={`${anchorClasses} ${isActive("/tests/vapi-booking") ? activeClasses : ""} ml-6`}
                  data-sidebar-collapse-subitem=""
                >
                  VAPI Booking
                </a>
              </li>

              <li>
                <a
                  href="/tests/google-signin/"
                  class={`${anchorClasses} ${isActive("/tests/google-signin") ? activeClasses : ""} ml-6`}
                  data-sidebar-collapse-subitem=""
                >
                  Google Sign-In
                </a>
              </li>
            </ul>
          </li>
        )
      }
    </ul>
  </div>

  <!-- Fixed footer with social icons -->
  <div class="px-3 py-4 border-t color-border">
    {
      socialNetworks.length > 0 ? (
        <div data-sidebar-collapse-hide="">
          <Socials
            links={socialNetworks}
            variant="minimal"
            size="md"
            colorScheme="default"
            gap="md"
            className="justify-center"
          />
        </div>
      ) : (
        <div
          class="flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs"
          data-sidebar-collapse-hide=""
        >
          <span>No social links configured</span>
        </div>
      )
    }
    <!-- Collapsed state: show single icon -->
    <div class="hidden items-center justify-center" data-sidebar-collapse-show="">
      <span class="text-gray-500 dark:text-gray-400">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
          ></path>
        </svg>
      </span>
    </div>
  </div>
</aside>

<!-- {chatEnabled && <CampfireChatWidget {currentUser} />}
 
 <div data-sidebar-collapse-hide="">
      <span data-sidebar-collapse-hide="" id="online-count">0 online</span>
      {chatEnabled && <HttpChatWidget {currentUser} {currentRole} {globalInputClasses} />}
    </div>
    
    -->

<script define:vars={{ shouldCheckBell: currentUser?.id && currentRole !== "Client" }}>
  // Debug notification bell rendering (only runs when bell should be present)
  if (shouldCheckBell) {
    console.log("ðŸ”” [ASIDE DEBUG] Aside component script loaded");

    function checkNotificationBell() {
      const bell = document.getElementById("notification-bell");
      console.log("ðŸ”” [ASIDE DEBUG] Checking for notification bell...");
      console.log("ðŸ”” [ASIDE DEBUG] Bell element:", bell);

      if (bell) {
        console.log("âœ… [ASIDE DEBUG] Notification bell found!");
        console.log("ðŸ”” [ASIDE DEBUG] Bell classes:", bell.className);
        console.log("ðŸ”” [ASIDE DEBUG] Bell href:", bell.getAttribute("href"));
        console.log(
          "ðŸ”” [ASIDE DEBUG] Bell data-modal-target:",
          bell.getAttribute("data-modal-target")
        );
        console.log("ðŸ”” [ASIDE DEBUG] Bell parent:", bell.parentElement);
        console.log(
          "ðŸ”” [ASIDE DEBUG] Bell visible:",
          window.getComputedStyle(bell).display !== "none"
        );
      } else {
        console.error("âŒ [ASIDE DEBUG] Notification bell NOT found in DOM!");
        console.log(
          "ðŸ”” [ASIDE DEBUG] All sidebar links:",
          Array.from(document.querySelectorAll("#sidebar a")).map((a) => ({
            id: a.id,
            text: a.textContent?.trim(),
            href: a.getAttribute("href"),
          }))
        );
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", checkNotificationBell);
    } else {
      checkNotificationBell();
    }

    // Check again after delay
    setTimeout(checkNotificationBell, 500);
  }
</script>
