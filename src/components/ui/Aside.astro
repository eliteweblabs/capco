---
// Flowbite Sidebar Component
// Nav items from config (asideNav in config.json). Branch on children: has children → dropdown, else → link.

import { isFeatureEnabled } from "../../lib/features";
import { getAsideNav } from "../../lib/aside-nav-config";
import SimpleIcon from "../common/SimpleIcon.astro";
import Socials from "./Socials.astro";
import { globalClasses } from "../../pages/api/global/global-classes";

interface Props {
  currentUser: any;
  primaryTextClasses: string;
  mobileNavigationHTML?: string;
}

const { currentUser, primaryTextClasses, mobileNavigationHTML } = Astro.props;

const currentRole = currentUser?.profile?.role;

// Check feature flags
const chatEnabled = await isFeatureEnabled("chat");

const asideNavItems = await getAsideNav(currentRole);

// Get current page URL for active state
const currentPath = Astro.url.pathname;

// Helper function to check if a link is active
const isActive = (href: string) => {
  if (!href || href === "#") return false;
  return currentPath === href || (href !== "/" && currentPath.startsWith(href));
};

const { globalSidebarClasses, navAnchorClasses, navActiveClasses, navSvgClasses } = globalClasses();

function slugifyId(s: string) {
  return s
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9-]/g, "");
}
---

<aside
  id="sidebar"
  class={`${globalSidebarClasses} translate-z-0 fixed left-0 z-100 flex min-h-0 w-64 -translate-x-full flex-col font-secondary transition-all ease-in-out ${primaryTextClasses}`}
  aria-label="Sidebar"
  style={currentUser ? "transition-duration: 350ms;" : undefined}
  data-dynamic-height="height"
>
  <!-- <div
    class="absolute -top-1 left-0 h-1 w-full shadow-[0_4px_6px_-1px_rgba(0,0,0,0.07)] dark:shadow-[0_-4px_6px_-1px_rgba(255,255,255,0.05)]"
  >
  </div> -->
  <div
    class="sticky top-0 min-h-0 flex-1 touch-pan-y overflow-y-auto overscroll-contain px-3 py-4 scrollbar-hide"
  >
    <!-- <div data-sidebar-collapse-hide=""> -->
    <ul class="mb-2 block space-y-2 text-xs font-medium uppercase tracking-wider" id="sidebar-menu">
      <!-- Front-end nav (from layout) and aside nav from config -->
      <Fragment set:html={mobileNavigationHTML} />
      {
        asideNavItems.map((item) => {
          if (item.children?.length) {
            const childHrefs = item.children.map((c) => c.href);
            const isDropdownActive = childHrefs.some((h) => isActive(h));
            return (
              <li>
                <details class="group" open={isDropdownActive}>
                  <summary
                    class={`${navAnchorClasses} w-full cursor-pointer list-none ${isDropdownActive ? navActiveClasses : ""} [&::-webkit-details-marker]:hidden`}
                    data-sidebar-collapse-item=""
                  >
                    {item.icon && <SimpleIcon name={item.icon} class={navSvgClasses} />}
                    <span class="ml-3 flex-1 whitespace-nowrap text-left" data-sidebar-collapse-hide="">
                      {item.label}
                    </span>
                    <SimpleIcon
                      name="chevron-right"
                      class="aside-chevron h-4 w-4 transition-transform duration-200 group-open:rotate-90"
                      data-sidebar-collapse-hide=""
                    />
                  </summary>
                  <ul class="space-y-2 py-2 pl-8" data-sidebar-collapse-hide="">
                    {item.children.map((child) => (
                      <li>
                        <a
                          href={child.href}
                          class={`${navAnchorClasses} ${currentPath === child.href ? navActiveClasses : ""}`}
                          data-sidebar-collapse-subitem=""
                        >
                          {child.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </details>
              </li>
            );
          }
          if (item.href) {
            return (
              <li>
                <a
                  href={item.href}
                  class={`${navAnchorClasses} ${isActive(item.href) ? navActiveClasses : ""}`}
                >
                  {item.icon && <SimpleIcon name={item.icon} class={navSvgClasses} />}
                  <span
                    data-sidebar-collapse-hide=""
                    class="ml-3 flex-1 whitespace-nowrap text-left"
                  >
                    {item.label}
                  </span>
                </a>
              </li>
            );
          }
          return <li class="hidden" aria-hidden="true" />;
        })
      }
    </ul>
    <!-- </div> -->
  </div>

  <!-- Fixed footer with social icons -->
  <div class="color-border mt-auto flex-shrink-0 border-t px-3 py-4">
    <div data-sidebar-collapse-hide="">
      <Socials
        variant="minimal"
        size="md"
        colorScheme="default"
        gap="md"
        className="justify-center"
      />
    </div>

    {/* Collapsed state: show single icon */}
    <div class="hidden items-center justify-center" data-sidebar-collapse-show="">
      <span class="text-gray-500 dark:text-gray-400">
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
          ></path>
        </svg>
      </span>
    </div>
  </div>
</aside>
