---
// Flowbite Sidebar Component
// Based on Flowbite dashboard design patterns
// Nav items driven by asideNav in site-config-{company-slug}.json (see aside-nav-config.ts)

import { isFeatureEnabled } from "../../lib/features";
import { getResolvedAsideNav } from "../../lib/aside-nav-config";
import SimpleIcon from "../common/SimpleIcon.astro";
import Socials from "./Socials.astro";
import { globalCompanyData } from "../../pages/api/global/global-company-data";

interface Props {
  currentUser: any;
  primaryTextClasses: string;
  mobileNavigationHTML?: string;
}

const { currentUser, primaryTextClasses, mobileNavigationHTML } = Astro.props;

const currentRole = currentUser?.profile?.role;

// Check feature flags
const chatEnabled = await isFeatureEnabled("chat");

// Get social networks from CMS settings
const companyData = await globalCompanyData();
const socialNetworks = companyData.socialNetworks || [];

// Get aside nav from company-specific config (site-config-{slug}.json)
const asideNavItems = currentUser?.id ? await getResolvedAsideNav(currentRole) : [];

// Get current page URL for active state
const currentPath = Astro.url.pathname;

// Helper function to check if a link is active
const isActive = (href: string) => {
  if (!href || href === "#") return false;
  return currentPath === href || (href !== "/" && currentPath.startsWith(href));
};

const anchorClasses =
  "lowercase hover:bg-gray-300 dark:hover:bg-gray-700 flex w-full align-center rounded-lg px-3 py-2 whitespace-nowrap";
const activeClasses = "bg-gray-300 dark:bg-gray-700 font-bold";
const svgClasses = "h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400";

function slugifyId(s: string) {
  return s
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9-]/g, "");
}
---

<aside
  id="sidebar"
  class={`bg-gray-50/90 dark:bg-gray-950/90 backdrop-blur-sm transition-duration-[350ms] translate-z-0 fixed left-0 z-100 flex min-h-0 w-64 -translate-x-full flex-col font-secondary transition-all ease-in-out ${primaryTextClasses}`}
  aria-label="Sidebar"
  style={currentUser ? "transition-duration: 350ms;" : undefined}
  data-dynamic-height="height"
>
  <!-- <div
    class="absolute -top-1 left-0 h-1 w-full shadow-[0_4px_6px_-1px_rgba(0,0,0,0.07)] dark:shadow-[0_-4px_6px_-1px_rgba(255,255,255,0.05)]"
  >
  </div> -->
  <div
    class="sticky top-0 min-h-0 flex-1 touch-pan-y overflow-y-auto overscroll-contain px-3 py-4 scrollbar-hide"
  >
    <div data-sidebar-collapse-hide="">
      <ul
        class={`mb-2 block md:hidden space-y-2 text-xs font-medium uppercase tracking-wider`}
        id="sidebar-menu-1"
      >
        <!-- front end navigation (mobile only) -->
        <Fragment set:html={mobileNavigationHTML} />
      </ul>
    </div>
    <ul class={`space-y-2 text-xs font-medium uppercase tracking-wider`} id="sidebar-menu">
      {
        asideNavItems.map((item) => {
          if (item.type === "link") {
            return (
              <li>
                <a
                  href={item.href}
                  class={`${anchorClasses} ${isActive(item.href) ? activeClasses : ""}`}
                >
                  {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                  <span
                    data-sidebar-collapse-hide=""
                    class="ml-3 flex-1 whitespace-nowrap text-left"
                  >
                    {item.label}
                  </span>
                </a>
              </li>
            );
          }
          if (item.type === "dropdown") {
            const ddId = `dropdown-${slugifyId(item.label)}`;
            const childHrefs = item.children.map((c) => c.href);
            const isDropdownActive = childHrefs.some((h) => isActive(h));
            return (
              <li>
                <button
                  type="button"
                  class={`${anchorClasses} w-full ${isDropdownActive ? activeClasses : ""}`}
                  aria-controls={ddId}
                  data-collapse-toggle={ddId}
                  data-sidebar-collapse-item=""
                  aria-expanded="false"
                >
                  {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                  <span
                    class="ml-3 flex-1 whitespace-nowrap text-left"
                    data-sidebar-collapse-hide=""
                  >
                    {item.label}
                  </span>
                  <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
                </button>
                <div data-sidebar-collapse-hide="">
                  <ul id={ddId} class="hidden space-y-2 py-2 pl-8">
                    {item.children.map((child) => (
                      <li>
                        <a
                          href={child.href}
                          class={`${anchorClasses} ${currentPath === child.href ? activeClasses : ""}`}
                          data-sidebar-collapse-subitem=""
                          data-sidebar-collapse-hide=""
                        >
                          {child.label}
                        </a>
                      </li>
                    ))}
                  </ul>
                </div>
              </li>
            );
          }
          if ((item as any).type === "feature-admin") {
            return (item as any).items.map((nav: any) => (
              <li>
                <a
                  href={nav.href}
                  class={`${anchorClasses} ${isActive(nav.href) ? activeClasses : ""}`}
                  data-sidebar-collapse-item=""
                >
                  {nav.icon && <SimpleIcon name={nav.icon} class={svgClasses} />}
                  <span
                    data-sidebar-collapse-hide=""
                    class="ml-3 flex-1 whitespace-nowrap text-left"
                  >
                    {nav.label}
                  </span>
                </a>
              </li>
            ));
          }
          if ((item as any).type === "feature-tools") {
            return (
              <>
                {((item as any).items as any[]).length > 0 &&
                  ((item as any).sectionLabel as string | undefined) && (
                    <li class="pb-2 pt-4">
                      <span class="text-xs uppercase text-gray-500 dark:text-gray-400">
                        {(item as any).sectionLabel}
                      </span>
                    </li>
                  )}
                {((item as any).items as any[]).map((nav: any) =>
                  nav.children?.length ? (
                    <li>
                      <button
                        type="button"
                        class={`${anchorClasses} ${nav.children.some((c) => isActive(c.href)) ? activeClasses : ""}`}
                        aria-controls={`dropdown-${slugifyId(nav.label)}`}
                        data-collapse-toggle={`dropdown-${slugifyId(nav.label)}`}
                        data-sidebar-collapse-item=""
                      >
                        {nav.icon && <SimpleIcon name={nav.icon} class={svgClasses} />}
                        <span
                          class="ml-3 flex-1 whitespace-nowrap text-left"
                          data-sidebar-collapse-hide=""
                        >
                          {nav.label}
                        </span>
                        <SimpleIcon
                          name="chevron-right"
                          class="h-4 w-4"
                          data-sidebar-collapse-hide=""
                        />
                      </button>
                      <ul
                        id={`dropdown-${slugifyId(nav.label)}`}
                        class="hidden space-y-2 py-2 pl-8"
                      >
                        {nav.children.map((child) => (
                          <li>
                            <a
                              href={child.href}
                              class={`${anchorClasses} ${isActive(child.href) ? activeClasses : ""}`}
                              data-sidebar-collapse-subitem=""
                              data-sidebar-collapse-hide=""
                            >
                              {child.label}
                            </a>
                          </li>
                        ))}
                      </ul>
                    </li>
                  ) : (
                    <li>
                      <a
                        href={nav.href}
                        class={`${anchorClasses} ${isActive(nav.href) ? activeClasses : ""}`}
                        data-sidebar-collapse-item=""
                      >
                        {nav.icon && <SimpleIcon name={nav.icon} class={svgClasses} />}
                        <span
                          data-sidebar-collapse-hide=""
                          class="ml-3 flex-1 whitespace-nowrap text-left"
                        >
                          {nav.label}
                        </span>
                      </a>
                    </li>
                  )
                )}
              </>
            );
          }
          return null;
        })
      }

      {/* Dev Test (specific user - not in config) */}
      {
        currentUser && currentRole === "Admin" && currentUser.email === "tom@tomsens.com" && (
          <li>
            <a
              href="/admin/update-test"
              class={`${anchorClasses} ${isActive("/admin/update-test") ? activeClasses : ""}`}
              data-sidebar-collapse-item=""
            >
              <SimpleIcon name="alert" class={svgClasses} />
              <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                Update Msg Test
              </span>
            </a>
          </li>
        )
      }
    </ul>
  </div>

  <!-- Fixed footer with social icons -->
  <div
    class="color-border mt-auto flex-shrink-0 border-t px-3 py-4 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.07)] dark:shadow-[0_-4px_6px_-1px_rgba(255,255,255,0.05)]"
  >
    {
      socialNetworks.length > 0 ? (
        <div data-sidebar-collapse-hide="">
          <Socials
            links={socialNetworks}
            variant="minimal"
            size="md"
            colorScheme="default"
            gap="md"
            className="justify-center"
          />
        </div>
      ) : (
        <div
          class="flex items-center justify-center text-xs text-gray-400 dark:text-gray-500"
          data-sidebar-collapse-hide=""
        >
          <span>No social links configured</span>
        </div>
      )
    }
    {/* Collapsed state: show single icon */}
    <div class="hidden items-center justify-center" data-sidebar-collapse-show="">
      <span class="text-gray-500 dark:text-gray-400">
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
          ></path>
        </svg>
      </span>
    </div>
  </div>
</aside>
