---
// Flowbite Sidebar Component
// Based on Flowbite dashboard design patterns

import { isFeatureEnabled } from "../../lib/features";
import { getSectionNavigation } from "../../lib/feature-navigation";
// import HttpChatWidget from "../../features/chat/components/HttpChatWidget.astro";
// import CampfireChatWidget from "../../features/chat/components/CampfireChatWidget.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
// import Tooltip from "../common/TooltipFloating.astro";
import Socials from "./Socials.astro";
import { globalCompanyData } from "../../pages/api/global/global-company-data";

interface Props {
  currentUser: any;
  globalInputClasses: string;
  primaryTextClasses: string;
  projects: any[];
  mobileNavigationHTML?: string;
  globalIconButtonClasses?: string;
}

const {
  currentUser,
  globalInputClasses,
  primaryTextClasses,
  projects,
  mobileNavigationHTML,
  globalIconButtonClasses,
} = Astro.props;

const currentRole = currentUser?.profile?.role;

// Check feature flags
const chatEnabled = await isFeatureEnabled("chat");

// Get social networks from CMS settings
const companyData = await globalCompanyData();
const socialNetworks = companyData.socialNetworks || [];

// Get dynamic navigation based on enabled features and user role
const adminNavItems = await getSectionNavigation("admin", currentRole);
const toolsNavItems = await getSectionNavigation("tools", currentRole);

// Get current page URL for active state
const currentPath = Astro.url.pathname;

// Helper function to check if a link is active
const isActive = (href: string) => {
  if (!href || href === "#") return false;
  // Exact match or starts with the path (for subpages)
  return currentPath === href || (href !== "/" && currentPath.startsWith(href));
};

const anchorClasses =
  "hover:bg-gray-300 dark:hover:bg-gray-700 flex w-full align-center rounded-lg px-3 py-2 whitespace-nowrap";
const activeClasses = "bg-gray-300 dark:bg-gray-700 font-bold";
const svgClasses = "h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400";
---

<aside
  id="sidebar"
  class="fixed shadow-primary-md top-[4rem] left-0 z-40 w-64 h-[calc(100dvh-4rem)] transition-all duration-300 ease-in-out -translate-x-full color-background-80 backdrop-blur-md shadow-md shadow-black/10 font-secondary flex flex-col translate-z-0 min-h-0"
  aria-label="Sidebar"
>
  <div
    class="sticky top-0 flex-1 min-h-0 px-3 py-4 overflow-y-auto overscroll-contain touch-pan-y no-scrollbar"
  >
    <div data-sidebar-collapse-hide="">
      <ul
        class={`mb-2 block md:hidden space-y-2 text-xs font-medium uppercase tracking-wider ${primaryTextClasses}`}
        id="sidebar-menu-1"
      >
        <!-- front end navigation (mobile only) -->
        <Fragment set:html={mobileNavigationHTML} />
      </ul>
    </div>
    <ul
      class={`space-y-2 text-xs font-medium uppercase tracking-wider ${primaryTextClasses}`}
      id="sidebar-menu"
    >
      {
        currentUser && currentUser.id && (
          <li>
            <a
              href="/dashboard"
              type="button"
              class={`${anchorClasses} ${isActive("/dashboard") ? activeClasses : ""}`}
            >
              <SimpleIcon name="dashboard" class={svgClasses} />
              <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                Dashboard
              </span>
            </a>
          </li>
        )
      }

      {
        currentUser && currentUser.id && currentRole === "Admin" && (
          <>
            <li>
              <a
                href="/admin/settings"
                type="button"
                class={`${anchorClasses} ${isActive("/admin/settings") ? activeClasses : ""}`}
              >
                <SimpleIcon name="settings" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Settings
                </span>
              </a>
            </li>

            <li>
              <a
                type="button"
                class={`${anchorClasses} ${isActive("/admin/design") ? activeClasses : ""}`}
                aria-controls="dropdown-design"
                data-collapse-toggle="dropdown-design"
                data-sidebar-collapse-item=""
                href="#"
              >
                <SimpleIcon name="palette" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Design
                </span>
                <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
              </a>
              <div data-sidebar-collapse-hide="">
                <ul id="dropdown-design" class="hidden space-y-2 py-2 pl-8">
                  <li>
                    <a
                      href="/admin/design"
                      class={`${anchorClasses} ${isActive("/admin/design") && currentPath === "/admin/design" ? activeClasses : ""}`}
                      data-sidebar-collapse-subitem=""
                      data-sidebar-collapse-hide=""
                    >
                      Components
                    </a>
                  </li>
                  <li>
                    <a
                      href="/admin/design/placeholders"
                      class={`${anchorClasses} ${isActive("/admin/design/placeholders") ? activeClasses : ""}`}
                      data-sidebar-collapse-subitem=""
                      data-sidebar-collapse-hide=""
                    >
                      Placeholders
                    </a>
                  </li>
                </ul>
              </div>
            </li>

            <li>
              <a
                href="/admin/cms"
                type="button"
                class={`${anchorClasses} ${isActive("/admin/cms") ? activeClasses : ""}`}
              >
                <SimpleIcon name="dashboard" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Content
                </span>
              </a>
            </li>

            <li>
              <a
                href="/admin/media"
                type="button"
                class={`${anchorClasses} ${isActive("/admin/media") ? activeClasses : ""}`}
              >
                <SimpleIcon name="image" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Media
                </span>
              </a>
            </li>

            <li>
              <a
                href="/admin/banner-alerts"
                type="button"
                class={`${anchorClasses} ${isActive("/admin/banner-alerts") ? activeClasses : ""}`}
              >
                <SimpleIcon name="alert" class={svgClasses} />
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  Alerts
                </span>
              </a>
            </li>
          </>
        )
      }

      {
        currentUser && (
          <li>
            <a
              type="button"
              class={`${anchorClasses} ${isActive("/project") ? activeClasses : ""}`}
              aria-controls="dropdown-projects"
              data-collapse-toggle="dropdown-projects"
              data-sidebar-collapse-item=""
              aria-expanded="false"
              href="#"
            >
              <SimpleIcon
                name="folder"
                class="h-4 w-4 flex-shrink-0 text-gray-900 dark:text-gray-400"
              />

              <span class="ml-3 flex-1 whitespace-nowrap text-left" data-sidebar-collapse-hide="">
                Projects
              </span>
              <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
            </a>
            <div data-sidebar-collapse-hide="">
              <ul id="dropdown-projects" class="hidden space-y-2 py-2 pl-8">
                <li>
                  <a
                    href="/project/dashboard/"
                    class={`${anchorClasses} ${isActive("/project/dashboard") ? activeClasses : ""}`}
                    data-sidebar-collapse-subitem=""
                    data-sidebar-collapse-hide
                  >
                    Dashboard
                  </a>
                </li>
                <li>
                  <a
                    href="/project/new"
                    class={`${anchorClasses} ${isActive("/project/new") ? activeClasses : ""}`}
                    data-sidebar-collapse-subitem=""
                    data-sidebar-collapse-hide
                  >
                    New
                  </a>
                </li>
                {currentUser && currentRole === "Admin" && (
                  <>
                    <li>
                      <a
                        href="/project/proposals"
                        class={`${anchorClasses} ${isActive("/project/proposals") ? activeClasses : ""}`}
                        data-sidebar-collapse-subitem=""
                        data-sidebar-collapse-hide
                      >
                        Proposals
                      </a>
                    </li>
                    <li>
                      <a
                        href="/project/settings"
                        class={`${anchorClasses} ${isActive("/project/settings") ? activeClasses : ""}`}
                        data-sidebar-collapse-subitem=""
                        data-sidebar-collapse-hide
                      >
                        Settings
                      </a>
                    </li>
                  </>
                )}
              </ul>
            </div>
          </li>
        )
      }

      <!-- Dynamic Admin Features (from site-config.json) -->
      {
        currentUser &&
          currentRole === "Admin" &&
          adminNavItems.map((item) => (
            <li>
              <a
                href={item.href}
                class={`${anchorClasses} ${isActive(item.href) ? activeClasses : ""}`}
                data-sidebar-collapse-item=""
              >
                {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                  {item.label}
                </span>
              </a>
            </li>
          ))
      }

      <!-- Admin-Only: Send Notifications -->
      {
        currentRole === "Admin" && (
          <li>
            <a
              href="/admin/notifications"
              class={`${anchorClasses} ${isActive("/admin/notifications") ? activeClasses : ""}`}
              data-sidebar-collapse-item=""
            >
              <SimpleIcon name="zap" class={svgClasses} />
              <span class="ml-3 flex-1 whitespace-nowrap text-left" data-sidebar-collapse-hide="">
                Send Notifications
              </span>
            </a>
          </li>
        )
      }

      <!-- Dev Test (Specific user) -->
      {
        currentRole === "Admin" && currentUser.email === "tom@tomsens.com" && (
          <li>
            <a
              href="/admin/update-test"
              class={`${anchorClasses} ${isActive("/admin/update-test") ? activeClasses : ""}`}
              data-sidebar-collapse-item=""
            >
              <SimpleIcon name="alert" class={svgClasses} />
              <span data-sidebar-collapse-hide="" class="ml-3 flex-1 whitespace-nowrap text-left">
                Update Msg Test
              </span>
            </a>
          </li>
        )
      }

      <!-- Dynamic Tools Features -->
      {
        currentUser && currentRole === "Admin" && toolsNavItems.length > 0 && (
          <li class="pt-4 pb-2">
            <span class="text-xs text-gray-500 dark:text-gray-400 uppercase">Tools</span>
          </li>
        )
      }
      {
        currentUser &&
          currentRole === "Admin" &&
          toolsNavItems.map((item) =>
            item.children?.length ? (
              <li>
                <button
                  type="button"
                  class={`${anchorClasses} ${item.children.some((c) => isActive(c.href)) ? activeClasses : ""}`}
                  aria-controls={`dropdown-${item.label.toLowerCase().replace(/\s+/g, "-")}`}
                  data-collapse-toggle={`dropdown-${item.label.toLowerCase().replace(/\s+/g, "-")}`}
                  data-sidebar-collapse-item=""
                >
                  {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                  <span
                    class="ml-3 flex-1 whitespace-nowrap text-left"
                    data-sidebar-collapse-hide=""
                  >
                    {item.label}
                  </span>
                  <SimpleIcon name="chevron-right" class="h-4 w-4" data-sidebar-collapse-hide="" />
                </button>
                <ul
                  id={`dropdown-${item.label.toLowerCase().replace(/\s+/g, "-")}`}
                  class="hidden space-y-2 py-2 pl-8"
                >
                  {item.children.map((child) => (
                    <li>
                      <a
                        href={child.href}
                        class={`${anchorClasses} ${isActive(child.href) ? activeClasses : ""}`}
                        data-sidebar-collapse-subitem=""
                        data-sidebar-collapse-hide=""
                      >
                        {child.label}
                      </a>
                    </li>
                  ))}
                </ul>
              </li>
            ) : (
              <li>
                <a
                  href={item.href}
                  class={`${anchorClasses} ${isActive(item.href) ? activeClasses : ""}`}
                  data-sidebar-collapse-item=""
                >
                  {item.icon && <SimpleIcon name={item.icon} class={svgClasses} />}
                  <span
                    data-sidebar-collapse-hide=""
                    class="ml-3 flex-1 whitespace-nowrap text-left"
                  >
                    {item.label}
                  </span>
                </a>
              </li>
            )
          )
      }
    </ul>
  </div>

  <!-- Fixed footer with social icons -->
  <div class="px-3 py-4 border-t color-border">
    {
      socialNetworks.length > 0 ? (
        <div data-sidebar-collapse-hide="">
          <Socials
            links={socialNetworks}
            variant="minimal"
            size="md"
            colorScheme="default"
            gap="md"
            className="justify-center"
          />
        </div>
      ) : (
        <div
          class="flex items-center justify-center text-gray-400 dark:text-gray-500 text-xs"
          data-sidebar-collapse-hide=""
        >
          <span>No social links configured</span>
        </div>
      )
    }
    <!-- Collapsed state: show single icon -->
    <div class="hidden items-center justify-center" data-sidebar-collapse-show="">
      <span class="text-gray-500 dark:text-gray-400">
        <svg
          class="w-5 h-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"
          ></path>
        </svg>
      </span>
    </div>
  </div>
</aside>
