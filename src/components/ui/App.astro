---
/**
 * Root layout shell: head, theme, nav, footer, global scripts.
 * Refactor notes and script order: see markdowns/APP-COMPONENT-REVIEW.md
 * Note: currentUser and session are always from checkAuth(Astro.cookies), not from props.
 */
interface Props {
  title?: string;
  description?: string;
  currentUser?: any;
  session?: any;
  project?: any;
  supabase?: any;
  supabaseUrl?: string;
  projects?: any;
  isBackend?: boolean;
  id?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  globalInputClasses?: string;
  globalIconButtonClasses?: string;
  year?: string;
  globalCompanyName?: string;
  globalCompanySlogan?: string;
  globalCompanyAddress?: string;
  globalCompanyPhone?: string;
  globalCompanyEmail?: string;
  globalCompanyWebsite?: string;
  globalCompanyLogo?: string;
  statusData?: any;
  statusOptions?: Array<{ value: string; label: string }>;
  mainClasses?: string;
  /** Layout: default | fullwidth | minimal | centered | fullscreen | fullform | reveal-footer | two-column. Drives centering and fullscreen scroll. fullform = full h/w, no reveal-text. Reveal-footer (min-h 100dvh, fixed footer on scroll) is applied site-wide. */
  layout?:
    | "default"
    | "fullwidth"
    | "minimal"
    | "centered"
    | "fullscreen"
    | "fullform"
    | "reveal-footer"
    | "two-column";
  mask?: string;
  horizontalScroll?: boolean;
  hideFooter?: boolean;
}

const {
  title = undefined,
  description = undefined,
  project = undefined,
  supabaseUrl = undefined,
  projects = undefined,
  id = undefined,
  mainClasses = "",
  layout = undefined,
  hideFooter = false,
} = Astro.props;

/** Minimal mode: when true, only Flowbite + theme run (debug nav/forms). See markdowns/APP-COMPONENT-REVIEW.md. */
const ONLY_FLOWBITE_AND_THEME = false;

const stripHtml = (s: string | undefined | null): string =>
  (s ?? "")
    .replace(/<[^>]*>/g, "")
    .replace(/\s+/g, " ")
    .trim();

// Derive layout behavior from layout prop only

// Effective template for data-template

import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyPhone,
  primaryColor,
  secondaryColor,
  backgroundColor,
  backgroundColorDark,
  fontFamily,
  secondaryFontFamily,
  globalCompanyIcon,
  plausibleTrackingScript,
  ogImage,
  customCss,
  customFooterHtml,
} = await globalCompanyData();

const safeTitle = stripHtml(title) || Astro.url.pathname.replace(/\//g, " ").trim() || "Home";
const safeDescription = stripHtml(description || globalCompanySlogan || "");

import { checkAuth } from "../../lib/auth";
const { currentUser, session } = await checkAuth(Astro.cookies);
import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses, globalIconButtonClasses } =
  globalClasses();

// Derived properties (needed for assigned fetch)
// Derived properties (8 props ‚Üí 13 total)
const isAuth = currentUser ? true : false;
const currentUrl = Astro.url.pathname;
const currentRole = currentUser?.profile?.role;

// Fetch assigned projects (count + preview) for Staff/Admin ‚Äî lightweight endpoint, no profiles/files
let assignedProjectsCount = 0;
let assignedProjectsPreview: any[] = [];
if (currentUser && (currentRole === "Admin" || currentRole === "Staff")) {
  try {
    const cookieHeader = Astro.request.headers.get("Cookie") || "";
    const res = await fetch(`${Astro.url.origin}/api/projects/assigned-summary`, {
      headers: { Cookie: cookieHeader },
    });
    if (res.ok) {
      const data = await res.json();
      assignedProjectsCount = data.count ?? 0;
      assignedProjectsPreview = data.items ?? [];
    }
  } catch {
    /* ignore */
  }
}

// Get navigation data
import { navigation } from "@/pages/api/utils/navigation";
import { isBackendPage, isAuthPage, isContactPage } from "../../pages/api/utils/backend-page-check";

const isBackend = isBackendPage(Astro.url.pathname);
const isAuthPageResult = isAuthPage(Astro.url.pathname);
const isContactPageResult = isContactPage(Astro.url.pathname);
const navigationData = await navigation(
  currentUrl,
  isAuth,
  currentRole || "Client",
  isBackend || false
);
const { desktopNavigationHTML, mobileNavigationHTML, visibleNavItems } = navigationData;
// SPA disabled: import { ClientRouter } from "astro:transitions";
import "../../styles/global.css"; // Import Tailwind CSS
// import "../../styles/app.css"; // Import Tailwind CSS

import Footer from "./Footer.astro";
import UnifiedNotification from "./UnifiedNotification.astro";
import CookieBanner from "../common/CookieBanner.astro";
import Navbar from "./Navbar.astro";
import Aside from "./Aside.astro";
import TutorialOverlay from "../common/TutorialOverlay.astro";
import FeedbackPanel from "../common/FeedbackPanel.astro";
import Tooltip from "./Tooltip.astro";
import SpeedDial from "../ui/SpeedDial.astro";
import AdminVoiceAssistantWidget from "../admin/AdminVoiceAssistantWidget.astro";
import CacheIndicator from "./CacheIndicator.astro";
import CMSPreloader from "./CMSPreloader.astro";
import AppHead from "./AppHead.astro";

const isAdmin = currentUser?.profile?.role === "Admin";

// Console suppression: ON by default. Set PUBLIC_SUPPRESS_CONSOLE_NOISE=false to disable (e.g. when debugging).
const suppressConsoleNoise = import.meta.env.PUBLIC_SUPPRESS_CONSOLE_NOISE !== "false";
---

<!doctype html>
<html lang="en">
  <head>
    {!ONLY_FLOWBITE_AND_THEME && (
      <>
        {/* 1. DOMContentLoaded patch - re-enable first if testing */}
        <script is:inline>
          (function () {
            function runIfAlreadyLoaded(type, listener) {
              if (document.readyState !== "loading") {
                setTimeout(function () {
                  if (typeof listener === "function") listener();
                  else if (listener && typeof listener.handleEvent === "function") listener.handleEvent({ type: type });
                }, 0);
                return true;
              }
              return false;
            }
            var docNative = document.addEventListener.bind(document);
            document.addEventListener = function (type, listener, options) {
              if ((type === "DOMContentLoaded" || type === "load") && runIfAlreadyLoaded(type, listener)) return;
              docNative(type, listener, options);
            };
            var winNative = window.addEventListener.bind(window);
            window.addEventListener = function (type, listener, options) {
              if ((type === "DOMContentLoaded" || type === "load") && runIfAlreadyLoaded(type, listener)) return;
              winNative(type, listener, options);
            };
          })();
        </script>
        <script is:inline define:vars={{ suppressConsoleNoise }}>
          if (suppressConsoleNoise) {
            (function () {
              const ow = console.warn, oe = console.error, ol = console.log;
              const skip = function (s) {
                return !s || s.includes("_cf_bm") || s.includes("__cf_bm") || (s.includes("Cookie") && s.includes("rejected")) || s.includes("invalid domain") || s.includes("NS_BINDING_ABORTED") || s.includes("Avatar failed to load") || s.includes("rate limit");
              };
              console.warn = function () {
                if (skip([].join.call(arguments, " "))) return;
                ow.apply(console, arguments);
              };
              console.error = function () {
                if (skip([].join.call(arguments, " "))) return;
                oe.apply(console, arguments);
              };
              console.log = function () {
                var s = [].join.call(arguments, " ");
                if (s && (s.includes("NS_BINDING_ABORTED") || s.includes("net::ERR_") || s.includes("_cf_bm") || s.includes("__cf_bm"))) return;
                ol.apply(console, arguments);
              };
            })();
          }
        </script>
      </>
    )}

    {/* Pre-bundled app-init (theme, notification, typewriter). app-globals + auth-google loaded in body. */}
    {!ONLY_FLOWBITE_AND_THEME && <script is:inline src="/scripts/app-init.js"></script>}

    <AppHead
      safeTitle={safeTitle}
      safeDescription={safeDescription}
      globalCompanyName={globalCompanyName}
      primaryColor={primaryColor ?? ""}
      secondaryColor={secondaryColor}
      backgroundColor={backgroundColor}
      backgroundColorDark={backgroundColorDark}
      fontFamily={fontFamily}
      secondaryFontFamily={secondaryFontFamily}
      globalCompanyIcon={globalCompanyIcon}
      project={project}
      ogImage={ogImage}
      customCss={customCss}
      canonicalUrl={Astro.url.href}
      generator={Astro.generator}
      includeDynamicColorsAndFonts={!ONLY_FLOWBITE_AND_THEME}
    />

    {!ONLY_FLOWBITE_AND_THEME && (
      <>
        {/* 6. Global typewriter (runSimpleTypewriter - vanilla JS, no TypeScript so it runs in prod) */}
        <script is:inline>
          (function () {
            var DONE_ATTR = "data-typewriter-done";

            function runSimpleTypewriter(el, options) {
              var text = el.getAttribute("data-text");
              if (!text || el.hasAttribute(DONE_ATTR)) return;
              el.setAttribute(DONE_ATTR, "true");
              el.textContent = "";
              var opts = options || {};
              var speed = opts.speed != null ? opts.speed : 60;
              var doneClass = opts.doneClass || "typewriter-complete";
              var dispatchEvent = opts.dispatchEvent === true;

              function type(i) {
                if (i < text.length) {
                  el.textContent += text[i];
                  setTimeout(function () { type(i + 1); }, speed);
                } else {
                  el.classList.add(doneClass);
                  if (dispatchEvent) {
                    el.dispatchEvent(new CustomEvent("typewriter-complete", { bubbles: true }));
                  }
                }
              }
              type(0);
            }

            function runSimpleTypewriterOnSelector(selector) {
              document.querySelectorAll(selector).forEach(function (el) { runSimpleTypewriter(el); });
            }

            window.runSimpleTypewriter = runSimpleTypewriter;
            window.runSimpleTypewriterOnSelector = runSimpleTypewriterOnSelector;

            function initLoadingTypewriters() {
              runSimpleTypewriterOnSelector("[data-loading-typewriter]");
            }
            document.addEventListener("DOMContentLoaded", initLoadingTypewriters);
            if (document.readyState === "complete" || document.readyState === "interactive") {
              initLoadingTypewriters();
            }
          })();
        </script>
      </>
    )}

    <!-- Set global user data for client-side components -->

    {/* SPA disabled: persist CMS colors, ClientRouter, prevent swap on 404 - was causing malformed HTML / script errors */}
  </head>

  <body
    class:list={[
      "bg-gray-100 antialiased dark:bg-gray-900",
      layout === "fullform" ? "touch-none overscroll-none" : "touch-manipulation",
    ]}
  >
    {/* SPA disabled: re-apply theme and astro:after-swap/astro:page-load scripts */}
    {/* SPA disabled: debug and runPageInits scripts */}

    <CMSPreloader showByDefault={true} {globalCompanyName} />

    <UnifiedNotification />

    <TutorialOverlay {currentUser} tutorialId="demo-tour" autoStart={false} {isAuth} />

    <!-- <DebugPanel {debugData} {currentRole} /> -->

    <FeedbackPanel {currentUser} />

    <div class="flex h-dvh flex-col overflow-hidden md:min-h-0" data-template={layout}>
      <Navbar
        {globalIconButtonClasses}
        {desktopNavigationHTML}
        {currentUser}
        {session}
        {supabaseUrl}
        {id}
        {projects}
        assignedProjectsCount={assignedProjectsCount}
        assignedProjectsPreview={assignedProjectsPreview}
        {isBackend}
        {project}
        pathname={Astro.url.pathname}
        template={layout}
        {hideFooter}
      />

      <Aside {currentUser} {primaryTextClasses} {mobileNavigationHTML} />

      <!-- Scrolling pane: flex-1 min-h-0 constrains height so this is the scroll container (not body). translateY on mobile for reveal effect. fullform: overscroll-none to prevent pullable rubber-band. -->
      <div
        id="reveal-scroll"
        class:list={[
          "relative z-50 min-h-0 flex-1 touch-pan-y overflow-y-auto bg-gray-100 scrollbar-hide dark:bg-gray-900",
          layout === "fullform"
            ? "touch-none overscroll-none overscroll-y-contain"
            : "overscroll-y-contain",
        ]}
      >
        <div
          id="main-content"
          class:list={[
            // "color-background",
            // "flex-1 min-w-0",
            // currentUser ? "transition-duration-[350ms] ease-in-out" : "",

            // (layout === "default"  || layout === "minimal" || !layout) &&
            //   "",
            mainClasses,
            layout === "default" && "px-4 pt-4 sm:px-6 sm:pt-6 md:px-8 md:pt-8 lg:px-10 lg:pt-10",
          ]}
          style={currentUser ? "transition-duration: 350ms;" : undefined}
        >
          <main>
            <slot />
          </main>

          {
            !isAuthPageResult && layout !== "fullform" && (
              <div class="my-6 text-xs">
                <ul class="align-center flex justify-center">
                  <li>
                    <Tooltip
                      text={`${new Date().getFullYear().toString()} ${globalCompanyName}. All rights reserved.`}
                    >
                      <span class="me-6 no-underline hover:underline">¬©</span>
                    </Tooltip>
                  </li>
                  <li>
                    <a href="/privacy" class="me-6 no-underline hover:underline">
                      {" "}
                      privacy{" "}
                    </a>
                  </li>
                  <li>
                    <a href="/terms" class="me-6 no-underline hover:underline">
                      {" "}
                      terms{" "}
                    </a>
                  </li>
                  <li>
                    <a href="/cookies" class="no-underline hover:underline">
                      {" "}
                      cookie{" "}
                    </a>
                  </li>
                </ul>
              </div>
            )
          }
        </div>
      </div>
      <Footer
        {isAuthPageResult}
        {isContactPageResult}
        {currentUser}
        {isBackend}
        {globalIconButtonClasses}
        {globalCompanyName}
        {isBackend}
        {globalCompanyPhone}
        {primaryTextClasses}
        {secondaryTextClasses}
        {globalInputClasses}
        {customFooterHtml}
        {hideFooter}
      />

      <div id="action-buttons" class="hide-on-form-focus fixed bottom-8 right-4 z-100">
        {
          isAdmin ? (
            <AdminVoiceAssistantWidget {currentUser} {globalCompanyPhone} />
          ) : (
            !isAuthPageResult && (
              <SpeedDial
                {globalCompanyPhone}
                currentUser={currentUser || undefined}
                {isBackend}
                {primaryTextClasses}
                {secondaryTextClasses}
                {globalInputClasses}
                {globalCompanyName}
              />
            )
          )
        }
      </div>
    </div>

    <CookieBanner />

    {/* Cache indicator: dev/test only (localhost or ?cacheIndicator=1) */}
    {isAdmin && <CacheIndicator />}

    {/* app-globals: pre-bundled to public/scripts/app-globals.js (avoids Astro chunk 404 + import-statement errors) */}
    {!ONLY_FLOWBITE_AND_THEME && (
      <script src="/scripts/app-globals.js"></script>
    )}
    {/* auth-google: pre-bundled (avoids Astro chunk 404 so Google OAuth works in prod) */}
    <script src="/scripts/auth-google.js"></script>
    {/* Flowbite: CDN may load slowly or fail (CSP/network). Fallback below retries and can load script dynamically. */}
    <script src="https://unpkg.com/flowbite@2.5.2/dist/flowbite.min.js" defer></script>
    <script is:inline>
      if (window.__jsOrderLog) window.__jsOrderLog("Flowbite script tag (inline after CDN)");
    </script>
    {/* Multi-step form fallback: when Astro module chunks don't load, load typewriter then form so animation runs */}
    <script is:inline>
      (function () {
        function loadFormFallback() {
          if (!document.querySelector("form[data-form-config]") || window.__multistepFormFallbackLoaded) return;
          window.__multistepFormFallbackLoaded = true;
          if (window.__jsOrderLog) window.__jsOrderLog("MultiStepForm fallback loader (inline)");
          function injectFormScript() {
            var s = document.createElement("script");
            s.src = "/scripts/init-multistep-form.js";
            s.async = false;
            document.body.appendChild(s);
          }
          function injectTypewriterThenForm() {
            var tw = document.createElement("script");
            tw.src = "/scripts/typewriter.js";
            tw.async = false;
            tw.onload = injectFormScript;
            tw.onerror = injectFormScript;
            document.body.appendChild(tw);
          }
          if (window.__PUBLIC_SUPABASE_URL__ && window.__PUBLIC_SUPABASE_PUBLISHABLE__) {
            injectTypewriterThenForm();
            return;
          }
          fetch("/api/env/supabase-public")
            .then(function (r) { return r.ok ? r.json() : {}; })
            .then(function (d) {
              if (d && typeof d.url === "string") window.__PUBLIC_SUPABASE_URL__ = d.url;
              if (d && typeof d.key === "string") window.__PUBLIC_SUPABASE_PUBLISHABLE__ = d.key;
              injectTypewriterThenForm();
            })
            .catch(function () { injectTypewriterThenForm(); });
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", loadFormFallback);
        } else {
          loadFormFallback();
        }
      })();
    </script>
    {/* Alert and banner dismiss: inline so close works when module scripts don't load */}
    <script is:inline>
      (function () {
        function initAlertDismiss() {
          document.querySelectorAll("[data-dismiss-alert]").forEach(function (btn) {
            if (btn.getAttribute("data-alert-dismiss-inited") === "1") return;
            btn.setAttribute("data-alert-dismiss-inited", "1");
            btn.addEventListener("click", function () {
              var alertId = btn.getAttribute("data-dismiss-alert");
              var alert = alertId ? document.getElementById(alertId) : null;
              if (alert) {
                alert.style.transition = "opacity 0.3s ease";
                alert.style.opacity = "0";
                setTimeout(function () { alert.remove(); }, 300);
              }
            });
          });
          document.querySelectorAll(".banner-alert").forEach(function (banner) {
            var el = banner;
            var bannerId = el.getAttribute("data-banner-id");
            var dismissBtn = el.querySelector(".banner-dismiss");
            if (!dismissBtn || dismissBtn.getAttribute("data-banner-dismiss-inited") === "1") return;
            dismissBtn.setAttribute("data-banner-dismiss-inited", "1");
            try {
              var stored = localStorage.getItem("dismissedBanners");
              var dismissed = stored ? JSON.parse(stored) : [];
              if (bannerId && dismissed.indexOf(bannerId) !== -1) { el.style.display = "none"; return; }
            } catch (e) {_logger.error("Error dismissing banner:", e);}
            dismissBtn.addEventListener("click", function () {
              el.style.transition = "max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out";
              el.style.opacity = "0";
              el.style.maxHeight = "0";
              el.style.overflow = "hidden";
              el.style.marginTop = "0";
              el.style.marginBottom = "0";
              setTimeout(function () { el.style.display = "none"; }, 300);
              if (bannerId) {
                try {
                  var s = localStorage.getItem("dismissedBanners");
                  var arr = s ? JSON.parse(s) : [];
                  if (arr.indexOf(bannerId) === -1) arr.push(bannerId);
                  localStorage.setItem("dismissedBanners", JSON.stringify(arr));
                } catch (e) {_logger.error("Error dismissing banner:", e);}
              }
            });
          });
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initAlertDismiss);
        } else {
          initAlertDismiss();
        }
        setTimeout(initAlertDismiss, 400);
      })();
    </script>
    {/* Theme toggle: inline so it works when app-globals chunk fails to load (e.g. production SSR) */}
    <script is:inline>
      (function () {
        function initThemeToggle() {
          var themeToggle = document.getElementById("theme-toggle");
          var darkIcon = document.getElementById("theme-toggle-dark-icon");
          var lightIcon = document.getElementById("theme-toggle-light-icon");
          if (!themeToggle || !darkIcon || !lightIcon || themeToggle.getAttribute("data-theme-toggle-inited") === "1") return;
          themeToggle.setAttribute("data-theme-toggle-inited", "1");
          function syncIcons(isDark) {
            if (isDark) { darkIcon.classList.add("hidden"); lightIcon.classList.remove("hidden"); }
            else { darkIcon.classList.remove("hidden"); lightIcon.classList.add("hidden"); }
          }
          syncIcons(document.documentElement.classList.contains("dark"));
          themeToggle.addEventListener("click", function () {
            var isDark = document.documentElement.classList.contains("dark");
            var newTheme = isDark ? "light" : "dark";
            if (isDark) {
              document.documentElement.classList.remove("dark");
              try { localStorage.setItem("color-theme", "light"); } catch { /* ignore */ }
            } else {
              document.documentElement.classList.add("dark");
              try { localStorage.setItem("color-theme", "dark"); } catch { /* ignore */ }
            }
            syncIcons(!isDark);
            document.cookie = "theme=" + newTheme + "; path=/; max-age=31536000; SameSite=Lax";
            if (typeof window.currentTheme !== "undefined") window.currentTheme = newTheme;
            if (typeof window.updateThemeSync === "function") window.updateThemeSync();
          });
        }
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", initThemeToggle);
        } else {
          initThemeToggle();
        }
        setTimeout(initThemeToggle, 200);
      })();
    </script>

    {!ONLY_FLOWBITE_AND_THEME && (
      <>
        {/* 8. hold-progress-init (app-globals loaded earlier, before auth-google) */}
        <script>
          import "../../scripts/hold-progress-init";
        </script>
      </>
    )}

    {/* Theme toggle: inline fallback above; app-globals.ts also binds (uses data-theme-toggle-inited to avoid double-init). Overscroll scale: app-globals.ts DOMContentLoaded */}

    {!ONLY_FLOWBITE_AND_THEME && (
      <>
        {/* 12. DOMContentLoaded init (notification, sidebar) */}
    <script>
      if (typeof window !== "undefined" && (window as any).__jsOrderLog) (window as any).__jsOrderLog("App DOMContentLoaded-init (module)");
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          if (typeof (window as any).hideOnFormFocus === "function") {
            (window as any).hideOnFormFocus();
          }
          const notificationBell = document.getElementById("notification-bell");
          if (notificationBell && typeof (window as any).initializeNotificationCount === "function") {
            await (window as any).initializeNotificationCount();
          }
          const ensureSidebar = (window as any).__ensureSidebarInit;
          if (typeof ensureSidebar === "function") {
            ensureSidebar();
            setTimeout(ensureSidebar, 400);
            setTimeout(ensureSidebar, 1200);
          }
        } catch (error) {
          console.error("üîî [APP] Error in DOMContentLoaded init:", error);
        }
      });
    </script>
      </>
    )}

    {!ONLY_FLOWBITE_AND_THEME && (
      <>
        {/* 13. Global Image Error Handler */}
    <script>
      if (typeof window !== "undefined" && (window as any).__jsOrderLog) (window as any).__jsOrderLog("App image error handler (module)");
      document.addEventListener("DOMContentLoaded", () => {
        // Suppress expected console errors in development
        const isDev =
          window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";

        // Handle all img elements with error handling
        const images = document.querySelectorAll("img");

        images.forEach((img) => {
          img.addEventListener("error", (event) => {
            const target = event.target;
            const src = (target as HTMLImageElement).src;

            // Check if it's a Supabase storage URL that's failing
            if (src && src.includes("supabase.co/storage")) {
              // Only log in production, silent in dev to reduce console noise
              if (!isDev) {
                console.warn("‚ö†Ô∏è [IMAGE-ERROR] Supabase storage image failed to load:", src);
              }

              // Hide the broken image and show a fallback
              (target as HTMLElement).style.display = "none";

              // Create a fallback element if it doesn't exist
              if (
                !(target as HTMLElement).nextElementSibling?.classList.contains("image-fallback")
              ) {
                const fallback = document.createElement("div");
                fallback.className =
                  "image-fallback bg-gray-200 flex items-center justify-center text-gray-500";
                fallback.style.width = (target as HTMLElement).style.width || "100%";
                fallback.style.height = (target as HTMLElement).style.height || "100%";
                fallback.innerHTML = "üì∑";
                (target as HTMLElement).parentNode?.insertBefore(
                  fallback,
                  (target as HTMLElement).nextSibling
                );
              }
            }
          });
        });

        // Handle dynamically added images
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                const element = node as HTMLElement;
                const newImages = element.querySelectorAll("img");
                newImages.forEach((img) => {
                  img.addEventListener("error", (event) => {
                    const target = event.target;
                    const src = (target as HTMLImageElement).src;

                    if (src && src.includes("supabase.co/storage")) {
                      console.warn("‚ö†Ô∏è [IMAGE-ERROR] Supabase storage image failed to load:", src);
                      (target as HTMLElement).style.display = "none";

                      if (
                        !(target as HTMLElement).nextElementSibling?.classList.contains(
                          "image-fallback"
                        )
                      ) {
                        const fallback = document.createElement("div");
                        fallback.className =
                          "image-fallback bg-gray-200 flex items-center justify-center text-gray-500";
                        fallback.style.width = (target as HTMLElement).style.width || "100%";
                        fallback.style.height = (target as HTMLElement).style.height || "100%";
                        fallback.innerHTML = "üì∑";
                        (target as HTMLElement).parentNode?.insertBefore(
                          fallback,
                          (target as HTMLElement).nextSibling
                        );
                      }
                    }
                  });
                });
              }
            });
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });
      });

      // Global error handler for unhandled promise rejections (network errors)
      window.addEventListener("unhandledrejection", (event) => {
        if (
          event.reason &&
          event.reason.message &&
          event.reason.message.includes("ERR_CONNECTION_CLOSED")
        ) {
          console.warn(
            "‚ö†Ô∏è [NETWORK-ERROR] Connection closed error suppressed:",
            event.reason.message
          );
          event.preventDefault(); // Prevent the error from showing in console
        }
      });

      // Global error handler for general errors
      window.addEventListener("error", (event) => {
        if (event.message && event.message.includes("ERR_CONNECTION_CLOSED")) {
          console.warn("‚ö†Ô∏è [NETWORK-ERROR] Connection closed error suppressed:", event.message);
          event.preventDefault(); // Prevent the error from showing in console
        }
      });
    </script>
      </>
    )}

    {!ONLY_FLOWBITE_AND_THEME && (
      <>
    {/* 14. AOS (Animate On Scroll) */}
    <!-- AOS (Animate On Scroll) - Global initialization -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
    <script is:inline>
      if (window.__jsOrderLog) window.__jsOrderLog("AOS init (inline)");
      window.addEventListener("DOMContentLoaded", function () {
        var path = window.location.pathname;
        if (path.startsWith("/admin") || path.startsWith("/project")) return;
        if (typeof AOS !== "undefined") {
          AOS.init({
            duration: 800,
            easing: "ease-in-out",
            once: true,
            offset: 120,
            delay: 50,
          });
        }
      });
    </script>
      </>
    )}

    {!ONLY_FLOWBITE_AND_THEME && (
      <>
        {/* 15. scroll-animations */}
        <script>
          import "../../scripts/scroll-animations";
        </script>
        {/* 16. lazy-load-images */}
        <script>
          import "../../scripts/lazy-load-images";
        </script>
        {/* 17. project-item-handlers */}
        <script>
          import "../../scripts/project-item-handlers";
        </script>
      </>
    )}

    {/* <!-- Plausible Analytics Script --> */}
    {/* {plausibleTrackingScript && <Fragment set:html={plausibleTrackingScript} />} */}
  </body>
</html>
