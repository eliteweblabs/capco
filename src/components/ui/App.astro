---
/** Layout modes (used by layout components and CMS template): default | fullwidth | minimal | centered | fullscreen */
interface Props {
  title?: string;
  description?: string;
  currentUser?: any;
  session?: any;
  project?: any;
  supabase?: any;
  supabaseUrl?: string;
  projects?: any;
  isBackend?: boolean;
  id?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  globalInputClasses?: string;
  globalIconButtonClasses?: string;
  year?: string;
  globalCompanyName?: string;
  globalCompanySlogan?: string;
  globalCompanyAddress?: string;
  globalCompanyPhone?: string;
  globalCompanyEmail?: string;
  globalCompanyWebsite?: string;
  globalCompanyLogo?: string;
  statusData?: any;
  statusOptions?: Array<{ value: string; label: string }>;
  mainClasses?: string;
  /** Layout: default | fullwidth | minimal | centered | fullscreen | fullform | reveal-footer | two-column. Drives centering and fullscreen scroll. fullform = full h/w, no reveal-text. Reveal-footer (min-h 100dvh, fixed footer on scroll) is applied site-wide. */
  layout?:
    | "default"
    | "fullwidth"
    | "minimal"
    | "centered"
    | "fullscreen"
    | "fullform"
    | "reveal-footer"
    | "two-column";
  mask?: string;
  horizontalScroll?: boolean;
  hideFooter?: boolean;
}

const {
  title = undefined,
  description = undefined,
  project = undefined,
  supabaseUrl = undefined,
  projects = undefined,
  id = undefined,
  statusData = undefined,
  mainClasses = "",
  layout = "default",
  mask = "center",
  horizontalScroll = false,
  hideFooter = false,
} = Astro.props;

const stripHtml = (s: string | undefined | null): string =>
  (s ?? "")
    .replace(/<[^>]*>/g, "")
    .replace(/\s+/g, " ")
    .trim();

// Derive layout behavior from layout prop only

// Effective template for data-template

import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  primaryColor,
  secondaryColor,
  backgroundColor,
  backgroundColorDark,
  fontFamily,
  secondaryFontFamily,
  globalCompanyIcon,
  plausibleTrackingScript,
  ogImage,
  customCss,
  customFooterHtml,
} = await globalCompanyData();

const safeTitle = stripHtml(title) || Astro.url.pathname.replace(/\//g, " ").trim() || "Home";
const safeDescription = stripHtml(description || globalCompanySlogan || "");

import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);
import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses, globalIconButtonClasses } =
  globalClasses();

// Get theme from cookie (set by client-side script)
// Note: Cookie is set client-side, so on first load it may not exist yet
const themeCookie = Astro.cookies.get("theme");
const serverTheme = themeCookie?.value || "light"; // Default to light

// Debug logging

// Derived properties (needed for assigned fetch)
const currentRole = currentUser?.profile?.role;

// Fetch assigned projects (count + preview) for Staff/Admin ‚Äî lightweight endpoint, no profiles/files
let assignedProjectsCount = 0;
let assignedProjectsPreview: any[] = [];
if (currentUser && (currentRole === "Admin" || currentRole === "Staff")) {
  try {
    const cookieHeader = Astro.request.headers.get("Cookie") || "";
    const res = await fetch(`${Astro.url.origin}/api/projects/assigned-summary`, {
      headers: { Cookie: cookieHeader },
    });
    if (res.ok) {
      const data = await res.json();
      assignedProjectsCount = data.count ?? 0;
      assignedProjectsPreview = data.items ?? [];
    }
  } catch {
    /* ignore */
  }
}

// Derived properties (8 props ‚Üí 13 total)
const isAuth = currentUser ? true : false;
const projectId = project?.id || undefined;
const currentUrl = Astro.url.pathname;

// Icon sources - convert SVG to data URI; fallback to public favicon so we never use empty href
let iconSrc: string;
if (
  globalCompanyIcon &&
  (globalCompanyIcon.includes("<svg") || globalCompanyIcon.includes("<?xml"))
) {
  const encoded = Buffer.from(globalCompanyIcon).toString("base64");
  iconSrc = "data:image/svg+xml;base64," + encoded;
} else if (globalCompanyIcon && typeof globalCompanyIcon === "string") {
  iconSrc = globalCompanyIcon;
} else {
  iconSrc = "/favicon.svg";
}

// OG Image URL for social sharing - use setting from CMS, with fallback
const ogImageSrc = ogImage || "";
const ogImageType = ogImageSrc?.includes(".gif")
  ? "image/gif"
  : ogImageSrc?.includes(".svg")
    ? "image/svg+xml"
    : ogImageSrc?.includes(".png")
      ? "image/png"
      : ogImageSrc?.includes(".jpg") || ogImageSrc?.includes(".jpeg")
        ? "image/jpeg"
        : ogImageSrc?.includes(".webp")
          ? "image/webp"
          : "image/png";

// Get navigation data
import { navigation } from "@/pages/api/utils/navigation";
import { isBackendPage, isAuthPage, isContactPage } from "../../pages/api/utils/backend-page-check";

const isBackend = isBackendPage(Astro.url.pathname);
const isAuthPageResult = isAuthPage(Astro.url.pathname);
const isContactPageResult = isContactPage(Astro.url.pathname);
const navigationData = await navigation(
  currentUrl,
  isAuth,
  currentRole || "Client",
  isBackend || false
);
const { desktopNavigationHTML, mobileNavigationHTML, visibleNavItems } = navigationData;
// SPA disabled: import { ClientRouter } from "astro:transitions";
import { generateColorPalette, hexToRgb } from "@/lib/color-utils";

// Server-rendered critical CMS colors so first paint uses DB colors before any script runs
const primaryPalette = generateColorPalette(primaryColor || "#825BDD");
const secondaryPalette = generateColorPalette(secondaryColor || "#0ea5e9");
const criticalColorVars = [
  ...Object.entries(primaryPalette)
    .filter(([k]) => k !== "DEFAULT" && !Number.isNaN(Number(k)))
    .map(([shade, color]) => "--color-primary-" + shade + ": " + color + ";"),
  ...Object.entries(secondaryPalette)
    .filter(([k]) => k !== "DEFAULT" && !Number.isNaN(Number(k)))
    .map(([shade, color]) => "--color-secondary-" + shade + ": " + color + ";"),
  "--color-background: " + hexToRgb(backgroundColor || "#ffffff") + ";",
  "--color-background-dark: " + hexToRgb(backgroundColorDark || "#0a0a0a") + ";",
].join("\n");
const criticalColorsCss = ":root {\n  " + criticalColorVars + "\n}";
import "../../styles/global.css"; // Import Tailwind CSS
// import "../../styles/app.css"; // Import Tailwind CSS

import Footer from "./Footer.astro";
import UnifiedNotification from "./UnifiedNotification.astro";
import CookieBanner from "../common/CookieBanner.astro";
import Navbar from "./Navbar.astro";
import Aside from "./Aside.astro";
import TutorialOverlay from "../common/TutorialOverlay.astro";
import DebugPanel from "../common/DebugPanel.astro";
import FeedbackPanel from "../common/FeedbackPanel.astro";
import Tooltip from "./Tooltip.astro";
import SpeedDial from "../ui/SpeedDial.astro";
import AdminVoiceAssistantWidget from "../admin/AdminVoiceAssistantWidget.astro";
import CacheIndicator from "./CacheIndicator.astro";

const isAdmin = currentUser?.profile?.role === "Admin";
---

<!doctype html>
<html lang="en">
  <head>
    <!-- Console suppression MUST run first so it catches all subsequent script output -->
    <script is:inline>
      // Aggressively suppress harmless console errors in development
      (function () {
        const isDev =
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1" ||
          window.location.hostname.startsWith("192.168.");

        if (!isDev) return;

        // Suppress Cloudflare cookie warnings and errors
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalLog = console.log;

        // Override console.warn
        console.warn = function (...args) {
          const message = String(args[0] || "");
          const fullMessage = args.join(" ");

          // Suppress Cloudflare cookie warnings
          if (
            message.includes("_cf_bm") ||
            message.includes("__cf_bm") ||
            (fullMessage.includes("Cookie") && fullMessage.includes("rejected")) ||
            fullMessage.includes("invalid domain") ||
            fullMessage.includes("NS_BINDING_ABORTED") ||
            fullMessage.includes("OpaqueResponseBlocking") ||
            fullMessage.includes("Ignoring Event: localhost") ||
            fullMessage.includes("Avatar failed to load") ||
            fullMessage.includes("rate limit")
          ) {
            return; // Silent fail
          }
          originalWarn.apply(console, args);
        };

        // Override console.error
        console.error = function (...args) {
          const message = String(args[0] || "");
          const fullMessage = args.join(" ");

          // Suppress Cloudflare cookie errors
          if (
            message.includes("_cf_bm") ||
            message.includes("__cf_bm") ||
            (fullMessage.includes("Cookie") && fullMessage.includes("rejected")) ||
            fullMessage.includes("invalid domain") ||
            fullMessage.includes("NS_BINDING_ABORTED")
          ) {
            return; // Silent fail
          }
          originalError.apply(console, args);
        };

        // Override console.log to suppress network errors
        console.log = function (...args) {
          // const message = String(args[0] || ""); // Unused
          const fullMessage = args.join(" ");

          if (
            fullMessage.includes("NS_BINDING_ABORTED") ||
            fullMessage.includes("net::ERR_") ||
            fullMessage.includes("_cf_bm") ||
            fullMessage.includes("__cf_bm")
          ) {
            return; // Silent fail
          }
          originalLog.apply(console, args);
        };

        // Suppress unhandled promise rejections for aborted requests
        window.addEventListener("unhandledrejection", function (event) {
          const reason = event.reason;
          const message = reason?.message || String(reason || "");

          if (
            message.includes("aborted") ||
            message.includes("NS_BINDING_ABORTED") ||
            message.includes("AbortError") ||
            reason?.name === "AbortError"
          ) {
            event.preventDefault(); // Prevent console error
            return;
          }
        });

        // Suppress global error events for network errors
        window.addEventListener(
          "error",
          function (event) {
            const message = event.message || "";
            const filename = event.filename || "";
            const target = event.target;

            // Suppress errors related to aborted requests, cookies, or failed image loads
            if (
              message.includes("NS_BINDING_ABORTED") ||
              message.includes("_cf_bm") ||
              message.includes("__cf_bm") ||
              (message.includes("Cookie") && message.includes("rejected")) ||
              (filename.includes("supabase.co") && message.includes("Failed")) ||
              (target &&
                target.tagName === "IMG" &&
                target.src &&
                target.src.includes("supabase.co/storage"))
            ) {
              event.preventDefault();
              event.stopPropagation();
              return false;
            }
          },
          true
        ); // Use capture phase to catch early

        // Intercept fetch to suppress aborted request errors and failed avatar requests
        const originalFetch = window.fetch;
        window.fetch = function (...args) {
          const url = typeof args[0] === "string" ? args[0] : args[0]?.url || "";
          const method = args[1]?.method || "GET";

          // Suppress HEAD requests to Supabase storage avatars (we know they'll fail)
          if (
            method === "HEAD" &&
            url.includes("supabase.co/storage") &&
            url.includes("/avatars/")
          ) {
            return Promise.resolve(new Response(null, { status: 404, statusText: "Not Found" }));
          }

          let fetchPromise = originalFetch.apply(this, args);

          // Wrap to catch and suppress abort errors
          fetchPromise = fetchPromise.catch(function (error) {
            if (
              error?.name === "AbortError" ||
              error?.message?.includes("aborted") ||
              error?.message?.includes("NS_BINDING_ABORTED")
            ) {
              // Return a silent rejection
              return Promise.reject(new Error("Request aborted (suppressed)"));
            }
            throw error;
          });

          // Also suppress 400 responses for avatar images
          fetchPromise = fetchPromise.then(function (response) {
            if (
              !response.ok &&
              response.status === 400 &&
              url.includes("supabase.co/storage") &&
              url.includes("/avatars/")
            ) {
              // Return a silent failure - don't throw, just return a 404-like response
              return new Response(null, { status: 404, statusText: "Not Found" });
            }
            return response;
          });

          return fetchPromise;
        };

        // Intercept XMLHttpRequest to suppress aborted errors and failed avatar requests
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function (...args) {
          this._suppressAbortError = false;
          this._url = args[1]; // Store URL for later check
          return originalXHROpen.apply(this, args);
        };

        XMLHttpRequest.prototype.send = function (...args) {
          const xhr = this;
          const url = xhr._url || "";

          // Suppress 400 errors for avatar images
          const originalOnLoad = xhr.onload;
          xhr.onload = function (event) {
            if (
              xhr.status === 400 &&
              url.includes("supabase.co/storage") &&
              url.includes("/avatars/")
            ) {
              // Silently fail - don't trigger error handlers
              return;
            }
            if (originalOnLoad) {
              originalOnLoad.call(xhr, event);
            }
          };

          const originalOnError = xhr.onerror;
          xhr.onerror = function (event) {
            // Suppress errors for avatar images
            if (url.includes("supabase.co/storage") && url.includes("/avatars/")) {
              return;
            }
            // Suppress aborted errors
            if (xhr.status === 0 && xhr.readyState === 0) {
              // Likely an aborted request
              return;
            }
            if (originalOnError) {
              originalOnError.call(xhr, event);
            }
          };

          return originalXHRSend.apply(this, args);
        };
      })();
    </script>

    <!-- Theme detection - MUST be first to be available for all components -->
    <script is:inline>
      (function () {
        // Initialize dark mode FIRST to prevent flash (IIFE avoids duplicate-declaration if script is inlined twice)
        var hasExplicitPreference = localStorage.getItem("color-theme") !== null;

        function setThemeCookie(theme) {
          document.cookie = "theme=" + theme + "; path=/; max-age=31536000; SameSite=Lax";
          console.log("[THEME-CLIENT] Cookie set to:", theme);
          console.log("[THEME-CLIENT] All cookies:", document.cookie);
          var cookies = document.cookie.split(";").reduce(function (acc, cookie) {
            var parts = cookie.trim().split("=");
            acc[parts[0]] = parts[1];
            return acc;
          }, {});
          console.log("[THEME-CLIENT] Parsed cookies:", cookies);
          console.log("[THEME-CLIENT] Theme cookie value:", cookies.theme);
        }

        function applyTheme(mode) {
          if (mode === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
          localStorage.setItem("color-theme", mode);
          setThemeCookie(mode);
        }

        if (hasExplicitPreference) {
          applyTheme(localStorage.getItem("color-theme") || "light");
        } else {
          applyTheme(window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
        }

        window.isDarkMode = function () {
          var hasDarkClass = document.documentElement.classList.contains("dark");
          var localStorageTheme = localStorage.getItem("color-theme");
          var systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (hasDarkClass) return true;
          if (localStorageTheme !== null) return localStorageTheme === "dark";
          return systemPrefersDark;
        };

        window.currentTheme = window.isDarkMode() ? "dark" : "light";

        /* page-size-plugin: must run inline before CSS to avoid FOUC (see src/lib/page-size-plugin.ts) */
        var pageSize = localStorage.getItem("page-size") || "normal";
        document.documentElement.setAttribute("data-page-size", pageSize);

        var ua = navigator.userAgent;
        var isIOS = /iPad|iPhone|iPod/.test(ua);
        var versionMatch = ua.match(/Version\/(\d+)/);
        var major = versionMatch ? parseInt(versionMatch[1], 10) : 0;
        if (isIOS && major > 0 && major < 14) {
          window.__legacySafari = true;
        }
      })();
    </script>

    <!-- Expose for components that run in swapped SPA content (bundled so no 404 on /lib/...) -->
    <script>
      import "../../scripts/init-auth-globals";
    </script>

    <!-- Critical CMS colors (server-rendered) so first paint uses DB colors before any script -->
    <style is:global set:html={criticalColorsCss}></style>

    <!-- Dynamic Color & Font Injection - MUST run BEFORE CSS is parsed to prevent flash -->
    <script
      is:inline
      define:vars={{
        primaryColor,
        secondaryColor,
        fontFamily,
        secondaryFontFamily,
        globalCompanyName,
      }}
    >
      (function () {
        // Inject colors and font immediately, synchronously BEFORE any CSS is parsed
        const primary = primaryColor || "#825BDD";
        const secondary = secondaryColor || "#0ea5e9";
        const font = fontFamily || "Outfit Variable";
        const secondaryFont = secondaryFontFamily || "sans-serif";

        // Font loading configuration - maps font names to Google Fonts URLs
        const fontConfigs = {
          "Outfit Variable": null, // Loaded via npm package
          Roboto:
            "https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap",
          "Open Sans":
            "https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap",
          Lato: "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",
          Montserrat:
            "https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap",
          Poppins:
            "https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap",
          Inter: "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap",
          Raleway:
            "https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600;700&display=swap",
          "Source Sans Pro":
            "https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap",
          Nunito:
            "https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap",
          "Playfair Display":
            "https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap",
          Merriweather:
            "https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap",
          Oswald:
            "https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600;700&display=swap",
          Lora: "https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap",
          "PT Sans": "https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap",
          Ubuntu: "https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;700&display=swap",
          "Noto Sans":
            "https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;700&display=swap",
          "Work Sans":
            "https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600;700&display=swap",
          "Crimson Text":
            "https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;700&display=swap",
          "Fira Sans":
            "https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600;700&display=swap",
          "Dancing Script":
            "https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap",
          "Bebas Neue": "https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap",
          Comfortaa:
            "https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;600;700&display=swap",
          Quicksand:
            "https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&display=swap",
          Rubik: "https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700&display=swap",
          "Josefin Sans":
            "https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&display=swap",
          "Libre Baskerville":
            "https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap",
          Cabin: "https://fonts.googleapis.com/css2?family=Cabin:wght@400;600;700&display=swap",
          Dosis: "https://fonts.googleapis.com/css2?family=Dosis:wght@300;400;600;700&display=swap",
          Arvo: "https://fonts.googleapis.com/css2?family=Arvo:wght@400;700&display=swap",
          "Titillium Web":
            "https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap",
          Mukta: "https://fonts.googleapis.com/css2?family=Mukta:wght@300;400;600;700&display=swap",
          Karla: "https://fonts.googleapis.com/css2?family=Karla:wght@300;400;600;700&display=swap",
          Barlow:
            "https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;600;700&display=swap",
          "DM Sans": "https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap",
          Manrope:
            "https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap",
          "Space Grotesk":
            "https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap",
          "Plus Jakarta Sans":
            "https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap",
        };

        // Load font dynamically if not already loaded
        function loadFont(fontName) {
          const url = fontConfigs[fontName];
          if (!url) return; // Skip if no URL (e.g., Outfit Variable loaded via npm)

          // Check if font link already exists
          const existingLink = document.querySelector(`link[href="${url}"]`);
          if (existingLink) {
            console.log("[Font] Already loaded:", fontName);
            return;
          }

          // Create and inject Google Font link
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = url;
          link.crossOrigin = "anonymous";
          document.head.appendChild(link);
          console.log("[Font] Loading font:", fontName);
        }

        // Load primary and secondary fonts
        loadFont(font);
        loadFont(secondaryFont);

        // Generate color palettes inline (same algorithm as dynamic-colors.ts)
        function hexToHsl(hex) {
          const r = parseInt(hex.slice(1, 3), 16) / 255;
          const g = parseInt(hex.slice(3, 5), 16) / 255;
          const b = parseInt(hex.slice(5, 7), 16) / 255;
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          let h = 0,
            s = 0;
          const l = (max + min) / 2;
          if (max !== min) {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
              case r:
                h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
                break;
              case g:
                h = ((b - r) / d + 2) / 6;
                break;
              case b:
                h = ((r - g) / d + 4) / 6;
                break;
            }
          }
          return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
        }

        function hslToHex(h, s, l) {
          l /= 100;
          const a = (s * Math.min(l, 1 - l)) / 100;
          const f = (n) => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color)
              .toString(16)
              .padStart(2, "0");
          };
          return `#${f(0)}${f(8)}${f(4)}`;
        }

        function generatePalette(baseColor) {
          if (!baseColor || !baseColor.match(/^#[0-9A-F]{6}$/i)) {
            baseColor = "#3b82f6";
          }
          const [h, s, l] = hexToHsl(baseColor);
          return {
            50: hslToHex(h, Math.max(s - 20, 10), Math.min(l + 45, 95)),
            100: hslToHex(h, Math.max(s - 15, 15), Math.min(l + 40, 90)),
            200: hslToHex(h, Math.max(s - 10, 20), Math.min(l + 30, 85)),
            300: hslToHex(h, Math.max(s - 5, 25), Math.min(l + 20, 75)),
            400: hslToHex(h, s, Math.min(l + 10, 65)),
            500: baseColor,
            600: hslToHex(h, Math.min(s + 5, 90), Math.max(l - 10, 25)),
            700: hslToHex(h, Math.min(s + 10, 95), Math.max(l - 20, 20)),
            800: hslToHex(h, Math.min(s + 15, 100), Math.max(l - 30, 15)),
            900: hslToHex(h, Math.min(s + 20, 100), Math.max(l - 40, 10)),
            950: hslToHex(h, Math.min(s + 25, 100), Math.max(l - 50, 5)),
          };
        }

        // Inject colors IMMEDIATELY - document.documentElement exists even before DOMContentLoaded
        const root = document.documentElement;
        const primaryPalette = generatePalette(primary);
        const secondaryPalette = generatePalette(secondary);

        Object.entries(primaryPalette).forEach(([shade, color]) => {
          root.style.setProperty(`--color-primary-${shade}`, color);
        });

        Object.entries(secondaryPalette).forEach(([shade, color]) => {
          root.style.setProperty(`--color-secondary-${shade}`, color);
        });

        // Inject font families
        root.style.setProperty("--font-family", font);
        root.style.setProperty("--font-family-secondary", secondaryFont);

        console.log("[App] ‚úÖ Dynamic colors and fonts injected immediately:", {
          primary,
          secondary,
          font,
          secondaryFont,
        });
      })();
    </script>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta name="author" content={globalCompanyName} />
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Preconnect to Google Fonts for better performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <title>
      {safeTitle + " ‚Üí " + globalCompanyName}
    </title>
    <meta name="description" content={safeDescription} />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content={primaryColor} />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-project-title" content={globalCompanyName} />
    <meta name="generator" content={Astro.generator} />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
    <!-- Open Graph / Facebook / iOS Preview -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={globalCompanyName} />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:title" content={safeTitle + " ‚Üí " + globalCompanyName} />
    <meta property="og:description" content={safeDescription} />
    {
      ogImageSrc && (
        <>
          <meta property="og:image" content={ogImageSrc} />
          <meta property="og:image:secure_url" content={ogImageSrc} />
          <meta property="og:image:type" content={ogImageType} />
          <meta property="og:image:width" content="1200" />
          <meta property="og:image:height" content="630" />
          <meta property="og:image:alt" content={globalCompanyName + " - " + safeDescription} />
        </>
      )
    }

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={safeTitle + " ‚Üí " + globalCompanyName} />
    <meta name="twitter:description" content={safeDescription} />
    {ogImageSrc && <meta name="twitter:image" content={ogImageSrc} />}
    {
      ogImageSrc && (
        <meta name="twitter:image:alt" content={globalCompanyName + " - " + safeDescription} />
      )
    }

    <!-- iOS / iMessage Preview -->
    <meta name="robots" content="max-image-preview:large" />

    <link rel="canonical" href={Astro.url.href} />
    <link rel="stylesheet" href="https://flowbite.com/application-ui/demo/app.css" />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Favicons and App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href={iconSrc} />
    <link
      rel="icon"
      type={globalCompanyIcon?.includes("<svg") || globalCompanyIcon?.includes("<?xml")
        ? "image/svg+xml"
        : "image/png"}
      sizes="32x32"
      href={iconSrc}
    />
    <link
      rel="icon"
      type={globalCompanyIcon?.includes("<svg") || globalCompanyIcon?.includes("<?xml")
        ? "image/svg+xml"
        : "image/png"}
      sizes="16x16"
      href={iconSrc}
    />
    <link
      rel="icon"
      type={globalCompanyIcon?.includes("<svg") || globalCompanyIcon?.includes("<?xml")
        ? "image/svg+xml"
        : "image/png"}
      href={iconSrc}
    />
    <link rel="manifest" href="/manifest.json" />
    <link rel="mask-icon" href={iconSrc} color="#5bbad5" />
    <meta name="msapplication-TileColor" content={primaryColor} />
    <meta name="theme-color" content={primaryColor} />

    <!-- Custom CSS from CMS Global Settings -->
    {
      customCss && customCss.trim() && (
        <style is:inline set:html={customCss} data-source="cms-custom-css" />
      )
    }

    <script>
      import {
        initializeNotificationCount,
        loadNotificationCount,
        refreshNotificationCount,
        updateNotificationBellCount,
      } from "@/lib/notification-count-loader";

      // Make functions globally available
      (window as any).initializeNotificationCount = initializeNotificationCount;
      (window as any).updateNotificationBellCount = updateNotificationBellCount;
      (window as any).loadNotificationCount = loadNotificationCount;
      (window as any).refreshNotificationCount = refreshNotificationCount;
    </script>

    <!-- Global typewriter: simple (vanilla) + TypeIt-based -->
    <script>
      (function () {
        const DONE_ATTR = "data-typewriter-done";

        function runSimpleTypewriter(
          el: HTMLElement,
          options?: { speed?: number; doneClass?: string; dispatchEvent?: boolean }
        ): void {
          const text = el.getAttribute("data-text");
          if (!text || el.hasAttribute(DONE_ATTR)) return;
          el.setAttribute(DONE_ATTR, "true");
          el.textContent = "";
          const speed = options?.speed ?? 60;
          const doneClass = options?.doneClass ?? "typewriter-complete";
          const dispatchEvent = options?.dispatchEvent ?? false;

          function type(i: number) {
            if (i < text.length) {
              el.textContent += text[i];
              setTimeout(() => type(i + 1), speed);
            } else {
              el.classList.add(doneClass);
              if (dispatchEvent) {
                el.dispatchEvent(new CustomEvent("typewriter-complete", { bubbles: true }));
              }
            }
          }
          type(0);
        }

        function runSimpleTypewriterOnSelector(selector: string): void {
          document.querySelectorAll<HTMLElement>(selector).forEach((el) => runSimpleTypewriter(el));
        }

        window.runSimpleTypewriter = runSimpleTypewriter;
        window.runSimpleTypewriterOnSelector = runSimpleTypewriterOnSelector;

        function initLoadingTypewriters() {
          runSimpleTypewriterOnSelector("[data-loading-typewriter]");
        }
        document.addEventListener("DOMContentLoaded", initLoadingTypewriters);
        // SPA disabled: document.addEventListener("astro:page-load", initLoadingTypewriters);
        if (document.readyState === "complete" || document.readyState === "interactive") {
          initLoadingTypewriters();
        }
      })();
    </script>
    <script>
      import {
        initTypewriterTexts,
        triggerActiveStepTypewriter,
        skipActiveTypewriterToEnd,
      } from "../../scripts/typewriter-text";
      window.initTypewriterTexts = initTypewriterTexts;
      window.triggerActiveStepTypewriter = triggerActiveStepTypewriter;
      window.skipActiveTypewriterToEnd = skipActiveTypewriterToEnd;
    </script>

    <!-- Set global user data for client-side components -->

    {/* SPA disabled: persist CMS colors for re-apply after client navigation */}
    <!-- {/* {isBackend && (
        <>
          <script id="cms-colors" type="application/json" set:html={JSON.stringify({
            primaryColor: primaryColor || "#825BDD",
            secondaryColor: secondaryColor || "#0ea5e9",
            fontFamily: fontFamily || "Outfit Variable",
            secondaryFontFamily: secondaryFontFamily || "sans-serif",
          })} />
          <script is:inline data-astro-rerun>
            document.addEventListener("astro:after-swap", function reapplyCmsColors() { /* no-op */ 
      //       });
      //     </script>
      //   </>
      // )}}

      {/* SPA disabled: client-side routing for project/* and admin/* (no full page reload) */}
      {/* isBackend && <ClientRouter fallback="swap" />} */}
      {/* SPA disabled: prevent swap on 404 */}
      {/* {isBackend && (
        <script>
          import { isTransitionBeforePreparationEvent, TRANSITION_BEFORE_PREPARATION } from "astro:transitions/client";
          document.addEventListener(TRANSITION_BEFORE_PREPARATION, (event: Event) => { /* no-op */ });
        // </script>
      // )} */} -->
  </head>

  <body
    class:list={[
      "bg-gray-100 antialiased dark:bg-gray-900",
      layout === "fullform" ? "touch-none overscroll-none" : "touch-manipulation",
    ]}
  >
    {/* SPA disabled: re-apply theme and astro:after-swap/astro:page-load scripts */}
    {/* SPA disabled: debug and runPageInits scripts */}

    <UnifiedNotification />

    <TutorialOverlay {currentUser} tutorialId="demo-tour" autoStart={false} {isAuth} />

    <!-- <DebugPanel {debugData} {currentRole} /> -->

    <FeedbackPanel {currentUser} />

    <div class="flex h-dvh flex-col overflow-hidden md:min-h-0" data-template={layout}>
      <Navbar
        {globalIconButtonClasses}
        {desktopNavigationHTML}
        {currentUser}
        {session}
        {supabaseUrl}
        {id}
        {projects}
        assignedProjectsCount={assignedProjectsCount}
        assignedProjectsPreview={assignedProjectsPreview}
        {isBackend}
        {project}
        pathname={Astro.url.pathname}
        template={layout}
        {hideFooter}
      />

      <Aside {currentUser} {primaryTextClasses} {mobileNavigationHTML} />

      <!-- Scrolling pane: flex-1 min-h-0 constrains height so this is the scroll container (not body). translateY on mobile for reveal effect. fullform: overscroll-none to prevent pullable rubber-band. -->
      <div
        id="reveal-scroll"
        class:list={[
          "relative z-50 min-h-0 flex-1 touch-pan-y overflow-y-auto bg-gray-100 scrollbar-hide dark:bg-gray-900",
          layout === "fullform" ? "touch-none overscroll-none" : "overscroll-y-contain",
        ]}
      >
        <div
          id="main-content"
          class:list={[
            // "color-background",
            // "flex-1 min-w-0",
            currentUser ? "transition-duration-[350ms] ease-in-out" : "",

            // (layout === "default"  || layout === "minimal" || !layout) &&
            //   "",
            mainClasses,
            layout === "default" && "px-4 pt-4 sm:px-6 sm:pt-6 md:px-8 md:pt-8 lg:px-10 lg:pt-10",
          ]}
          style={currentUser ? "transition-duration: 350ms;" : undefined}
        >
          <main>
            <slot />
          </main>

          {
            !isAuthPageResult && layout !== "fullform" && (
              <div class="my-6 text-xs">
                <ul class="align-center flex justify-center">
                  <li>
                    <Tooltip
                      text={`${new Date().getFullYear().toString()} ${globalCompanyName}. All rights reserved.`}
                    >
                      <span class="me-6 no-underline hover:underline">¬©</span>
                    </Tooltip>
                  </li>
                  <li>
                    <a href="/privacy" class="me-6 no-underline hover:underline">
                      {" "}
                      privacy{" "}
                    </a>
                  </li>
                  <li>
                    <a href="/terms" class="me-6 no-underline hover:underline">
                      {" "}
                      terms{" "}
                    </a>
                  </li>
                  <li>
                    <a href="/cookies" class="no-underline hover:underline">
                      {" "}
                      cookie{" "}
                    </a>
                  </li>
                </ul>
              </div>
            )
          }
        </div>
      </div>
      <Footer
        {isAuthPageResult}
        {isContactPageResult}
        {currentUser}
        {isBackend}
        {globalIconButtonClasses}
        {globalCompanyName}
        {isBackend}
        {globalCompanyPhone}
        {primaryTextClasses}
        {secondaryTextClasses}
        {globalInputClasses}
        {customFooterHtml}
        {hideFooter}
      />

      <div id="action-buttons" class="hide-on-form-focus fixed bottom-8 right-4 z-[500]">
        {
          isAdmin ? (
            <AdminVoiceAssistantWidget {currentUser} {globalCompanyPhone} />
          ) : (
            !isAuthPageResult &&
            !isContactPageResult && (
              <SpeedDial
                {globalCompanyPhone}
                currentUser={currentUser || undefined}
                {isBackend}
                {primaryTextClasses}
                {secondaryTextClasses}
                {globalInputClasses}
                {globalCompanyName}
              />
            )
          )
        }
      </div>
    </div>

    <CookieBanner />

    {/* Cache indicator: dev/test only (localhost or ?cacheIndicator=1) */}
    {isAdmin && <CacheIndicator />}

    <!-- Flowbite JavaScript -->
    <script src="https://unpkg.com/flowbite@2.5.2/dist/flowbite.min.js"></script>

    <script>
      import "../../scripts/app-globals";
    </script>

    <!-- Overscroll: scale .overscroll-scale linearly with overscroll % (getOverscrollPercent). 0‚Äì100% ‚Üí scale 1; >100% or <0% ‚Üí scale tracks linearly. -->
    <script is:inline>
      (function () {
        var getOverscrollPercent = window.getOverscrollPercent;
        if (typeof getOverscrollPercent !== "function") return;

        var MIN_SCALE = 0.9;
        var MAX_SCALE = 1.25;
        var overscrollScaleEls = [];
        var wasInRange = true;

        function scaleFromPercent(p) {
          if (p >= 0 && p <= 100) return 1;
          if (p > 100) return Math.min(MAX_SCALE, 1 + (p - 100) / 100);
          return Math.max(MIN_SCALE, 1 + p / 100);
        }

        function applyOverscrollScale() {
          var p = getOverscrollPercent();
          var inRange = p >= 0 && p <= 100;
          if (wasInRange && !inRange) {
            console.log("overscroll started", Math.round(p * 10) / 10 + "%");
          }
          wasInRange = inRange;

          var scale = scaleFromPercent(p);
          if (overscrollScaleEls.length === 0)
            overscrollScaleEls = Array.from(document.querySelectorAll(".overscroll-scale"));
          overscrollScaleEls.forEach(function (el) {
            el.style.transform = "scale(" + scale + ")";
          });
        }

        var ticking = false;
        function onScrollOrWheel() {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(function () {
            applyOverscrollScale();
            ticking = false;
          });
        }

        function init() {
          var scrollTarget = document.getElementById("reveal-scroll") || window;
          scrollTarget.addEventListener("scroll", onScrollOrWheel, { passive: true });
          window.addEventListener("wheel", onScrollOrWheel, { passive: true });
          applyOverscrollScale();
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          setTimeout(init, 0);
        }
      })();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        (window as any).hideOnFormFocus();

        // Initialize notification count only if user is authenticated
        try {
          const notificationBell = document.querySelector(
            '[data-dropdown-toggle="notification-dropdown"]'
          );
          if (
            notificationBell &&
            (notificationBell as HTMLElement).dataset?.userId &&
            (window as any).initializeNotificationCount
          ) {
            console.log(
              "üîî [APP] Initializing notifications for user:",
              (notificationBell as HTMLElement).dataset?.userId
            );
            await (window as any).initializeNotificationCount();
          } else {
            console.log("üîî [APP] Skipping notification initialization - no authenticated user");
          }
        } catch (error) {
          console.error("üîî [APP] Error initializing notification count:", error);
        }
      });
    </script>

    <!-- Global Image Error Handler -->
    <script>
      // Global error handler for broken image URLs (especially Supabase storage)
      document.addEventListener("DOMContentLoaded", () => {
        // Suppress expected console errors in development
        const isDev =
          window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";

        // Handle all img elements with error handling
        const images = document.querySelectorAll("img");

        images.forEach((img) => {
          img.addEventListener("error", (event) => {
            const target = event.target;
            const src = (target as HTMLImageElement).src;

            // Check if it's a Supabase storage URL that's failing
            if (src && src.includes("supabase.co/storage")) {
              // Only log in production, silent in dev to reduce console noise
              if (!isDev) {
                console.warn("‚ö†Ô∏è [IMAGE-ERROR] Supabase storage image failed to load:", src);
              }

              // Hide the broken image and show a fallback
              (target as HTMLElement).style.display = "none";

              // Create a fallback element if it doesn't exist
              if (
                !(target as HTMLElement).nextElementSibling?.classList.contains("image-fallback")
              ) {
                const fallback = document.createElement("div");
                fallback.className =
                  "image-fallback bg-gray-200 flex items-center justify-center text-gray-500";
                fallback.style.width = (target as HTMLElement).style.width || "100%";
                fallback.style.height = (target as HTMLElement).style.height || "100%";
                fallback.innerHTML = "üì∑";
                (target as HTMLElement).parentNode?.insertBefore(
                  fallback,
                  (target as HTMLElement).nextSibling
                );
              }
            }
          });
        });

        // Handle dynamically added images
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                const element = node as HTMLElement;
                const newImages = element.querySelectorAll("img");
                newImages.forEach((img) => {
                  img.addEventListener("error", (event) => {
                    const target = event.target;
                    const src = (target as HTMLImageElement).src;

                    if (src && src.includes("supabase.co/storage")) {
                      console.warn("‚ö†Ô∏è [IMAGE-ERROR] Supabase storage image failed to load:", src);
                      (target as HTMLElement).style.display = "none";

                      if (
                        !(target as HTMLElement).nextElementSibling?.classList.contains(
                          "image-fallback"
                        )
                      ) {
                        const fallback = document.createElement("div");
                        fallback.className =
                          "image-fallback bg-gray-200 flex items-center justify-center text-gray-500";
                        fallback.style.width = (target as HTMLElement).style.width || "100%";
                        fallback.style.height = (target as HTMLElement).style.height || "100%";
                        fallback.innerHTML = "üì∑";
                        (target as HTMLElement).parentNode?.insertBefore(
                          fallback,
                          (target as HTMLElement).nextSibling
                        );
                      }
                    }
                  });
                });
              }
            });
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });
      });

      // Global error handler for unhandled promise rejections (network errors)
      window.addEventListener("unhandledrejection", (event) => {
        if (
          event.reason &&
          event.reason.message &&
          event.reason.message.includes("ERR_CONNECTION_CLOSED")
        ) {
          console.warn(
            "‚ö†Ô∏è [NETWORK-ERROR] Connection closed error suppressed:",
            event.reason.message
          );
          event.preventDefault(); // Prevent the error from showing in console
        }
      });

      // Global error handler for general errors
      window.addEventListener("error", (event) => {
        if (event.message && event.message.includes("ERR_CONNECTION_CLOSED")) {
          console.warn("‚ö†Ô∏è [NETWORK-ERROR] Connection closed error suppressed:", event.message);
          event.preventDefault(); // Prevent the error from showing in console
        }
      });
    </script>

    <!-- AOS (Animate On Scroll) - Global initialization -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
    <script is:inline>
      // Wait for AOS library to load before initializing
      window.addEventListener("DOMContentLoaded", function () {
        // @ts-ignore - AOS loaded from CDN
        if (typeof AOS !== "undefined") {
          // @ts-ignore
          AOS.init({
            duration: 800,
            easing: "ease-in-out",
            once: true,
            offset: 120,
            delay: 50,
          });
        }
      });
    </script>

    <!-- Custom Scroll Animations (Blur/Scale effects) -->
    <script>
      import "../../scripts/scroll-animations";
    </script>

    <!-- Lazy Loading Images (Global) -->
    <script>
      import "../../scripts/lazy-load-images";
    </script>

    <!-- Global Project Item Handlers (Extracted from ProjectItem.astro for performance) -->
    <script>
      import "../../scripts/project-item-handlers";
    </script>

    <!-- Button Ripple Effects (Focus and Click animations) -->
    <!-- <script>
      import "../../scripts/button-ripple";
    </script> -->

    {/* Load refresh-manager for Staff/Admin only - keeps project/user data fresh across pages */}
    {
      (currentRole === "Admin" || currentRole === "Staff") && (
        <script>import "../../lib/refresh-manager.ts";</script>
      )
    }

    {/* Project Refresh Manager (DISABLED - use generic refresh-manager.ts instead) */}
    {
      /* <script>
      import "../../lib/project-refresh-manager";
    </script> */
    }

    <!-- Global Modal System -->
    <script>
      import "../../lib/modal-global";
    </script>

    <!-- Plausible Analytics Script -->
    <!-- {plausibleTrackingScript && <Fragment set:html={plausibleTrackingScript} />} -->
  </body>
</html>
