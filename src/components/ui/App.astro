---
/** Layout modes (used by layout components and CMS template): default | fullwidth | minimal | centered | fullscreen */
interface Props {
  title?: string;
  description?: string;
  currentUser?: any;
  session?: any;
  project?: any;
  supabase?: any;
  supabaseUrl?: string;
  projects?: any;
  isBackend?: boolean;
  id?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  globalInputClasses?: string;
  globalIconButtonClasses?: string;
  year?: string;
  globalCompanyName?: string;
  globalCompanySlogan?: string;
  globalCompanyAddress?: string;
  globalCompanyPhone?: string;
  globalCompanyEmail?: string;
  globalCompanyWebsite?: string;
  globalCompanyLogo?: string;
  statusData?: any;
  statusOptions?: Array<{ value: string; label: string }>;
  mainClasses?: string;
  /** Layout: default | fullwidth | minimal | centered | fullscreen | reveal-footer. Drives centering and fullscreen scroll. Reveal-footer (min-h 100dvh, fixed footer on scroll) is applied site-wide. */
  layout?: "default" | "fullwidth" | "minimal" | "centered" | "fullscreen" | "reveal-footer" | "two-column";
  mask?: string;
  horizontalScroll?: boolean;
}

const {
  title = undefined,
  description = undefined,
  project = undefined,
  supabaseUrl = undefined,
  projects = undefined,
  id = undefined,
  statusData = undefined,
  mainClasses = "",
  layout = 'default',
  mask = "center",
  horizontalScroll = false,
} = Astro.props;

// Derive layout behavior from layout prop only


// Effective template for data-template

import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  primaryColor,
  secondaryColor,
  fontFamily,
  secondaryFontFamily,
  globalCompanyIcon,
  plausibleTrackingScript,
  ogImage,
  customCss,
} = await globalCompanyData();

import { checkAuth } from "../../lib/auth";
const { currentUser, session, supabase, refreshToken, accessToken } = await checkAuth(
  Astro.cookies
);
import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses, globalIconButtonClasses } =
  globalClasses();

// Get theme from cookie (set by client-side script)
// Note: Cookie is set client-side, so on first load it may not exist yet
const themeCookie = Astro.cookies.get("theme");
const serverTheme = themeCookie?.value || "light"; // Default to light

// Debug logging

// Derived properties (8 props â†’ 13 total)
const isAuth = currentUser ? true : false;
// const currentUserId = currentUser?.id || undefined; // Unused
const currentRole = currentUser?.profile?.role || undefined;
const projectId = project?.id || undefined;
const currentUrl = Astro.url.pathname;

// Icon sources - convert SVG to data URI; fallback to public favicon so we never use empty href
let iconSrc: string;
if (
  globalCompanyIcon &&
  (globalCompanyIcon.includes("<svg") || globalCompanyIcon.includes("<?xml"))
) {
  const encoded = Buffer.from(globalCompanyIcon).toString("base64");
  iconSrc = "data:image/svg+xml;base64," + encoded;
} else if (globalCompanyIcon && typeof globalCompanyIcon === "string") {
  iconSrc = globalCompanyIcon;
} else {
  iconSrc = "/favicon.svg";
}

// OG Image URL for social sharing - use setting from CMS, with fallback
const ogImageSrc = ogImage || "/videos/CACPCO-share-preview.gif";

// Get navigation data
import { navigation } from "@/pages/api/utils/navigation";
import { isBackendPage, isAuthPage, isContactPage } from "../../pages/api/utils/backend-page-check";

const isBackend = isBackendPage(Astro.url.pathname);
const isAuthPageResult = isAuthPage(Astro.url.pathname);
const isContactPageResult = isContactPage(Astro.url.pathname);
const navigationData = await navigation(
  currentUrl,
  isAuth,
  currentRole || "Client",
  isBackend || false
);
const { desktopNavigationHTML, mobileNavigationHTML, visibleNavItems } = navigationData;
import { ClientRouter } from "astro:transitions";
import { generateColorPalette } from "@/lib/color-utils";

// Server-rendered critical CMS colors so first paint uses DB colors before any script runs
const primaryPalette = generateColorPalette(primaryColor || "#825BDD");
const secondaryPalette = generateColorPalette(secondaryColor || "#0ea5e9");
const criticalColorVars = [
  ...Object.entries(primaryPalette)
    .filter(([k]) => k !== "DEFAULT" && !Number.isNaN(Number(k)))
    .map(([shade, color]) => "--color-primary-" + shade + ": " + color + ";"),
  ...Object.entries(secondaryPalette)
    .filter(([k]) => k !== "DEFAULT" && !Number.isNaN(Number(k)))
    .map(([shade, color]) => "--color-secondary-" + shade + ": " + color + ";"),
].join("\n");
const criticalColorsCss = ":root {\n  " + criticalColorVars + "\n}";
import "../../styles/global.css"; // Import Tailwind CSS
// import "../../styles/app.css"; // Import Tailwind CSS

import Modal from "../ui/Modal.astro";
import Footer from "./Footer.astro";
import UnifiedNotification from "./UnifiedNotification.astro";
import CookieBanner from "../common/CookieBanner.astro";
import Navbar from "./Navbar.astro";
import Aside from "./Aside.astro";
import TutorialOverlay from "../common/TutorialOverlay.astro";
import DebugPanel from "../common/DebugPanel.astro";
import FeedbackPanel from "../common/FeedbackPanel.astro";
import NotificationsModal from "../common/NotificationsModal.astro";
import UserProfileDropdown from "./UserProfileDropdown.astro";
import StickyActionButton from "../project/StickyActions.astro";
import PunchlistDrawer from "../project/PunchlistDrawer.astro";
import ThemeToggle from "./ThemeToggle.astro";
import Tooltip from "../common/TooltipFloating.astro";
import SpeedDial from "../ui/SpeedDial.astro";
import AdminVoiceAssistantWidget from "../admin/AdminVoiceAssistantWidget.astro";

const isAdmin = currentUser?.profile?.role === "Admin";
// import DotGrid from "./DotGrid.astro";

// Notification count loader will be loaded via script tag

// Prepare debug data for admin users
const debugData = {
  // Original props
  title,
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyAddress,
  globalCompanyPhone,
  globalCompanyEmail,
  globalCompanyWebsite,
  globalCompanyLogo,
  description,
  currentUser,
  session,
  project,
  supabase,
  supabaseUrl,
  projects,
  isBackend,
  id,
  statusData,
  // Derived properties
  isAuth,
  projectId,
  currentUrl,
  // Navigation data
  navigationData,
  desktopNavigationHTML,
  visibleNavItems,
  // Additional context
  astroUrl: Astro.url,
  astroRequest: {
    method: Astro.request.method,
    headers: Object.fromEntries(Astro.request.headers.entries()),
    url: Astro.request.url,
  },
};
---

<!doctype html>
<html lang="en">
  <head>
    <!-- Console suppression MUST run first so it catches all subsequent script output -->
    <script is:inline>
      // Aggressively suppress harmless console errors in development
      (function () {
        const isDev =
          window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1" ||
          window.location.hostname.startsWith("192.168.");

        if (!isDev) return;

        // Suppress Cloudflare cookie warnings and errors
        const originalWarn = console.warn;
        const originalError = console.error;
        const originalLog = console.log;

        // Override console.warn
        console.warn = function (...args) {
          const message = String(args[0] || "");
          const fullMessage = args.join(" ");

          // Suppress Cloudflare cookie warnings
          if (
            message.includes("_cf_bm") ||
            message.includes("__cf_bm") ||
            (fullMessage.includes("Cookie") && fullMessage.includes("rejected")) ||
            fullMessage.includes("invalid domain") ||
            fullMessage.includes("NS_BINDING_ABORTED") ||
            fullMessage.includes("OpaqueResponseBlocking") ||
            fullMessage.includes("Ignoring Event: localhost") ||
            fullMessage.includes("Avatar failed to load") ||
            fullMessage.includes("rate limit")
          ) {
            return; // Silent fail
          }
          originalWarn.apply(console, args);
        };

        // Override console.error
        console.error = function (...args) {
          const message = String(args[0] || "");
          const fullMessage = args.join(" ");

          // Suppress Cloudflare cookie errors
          if (
            message.includes("_cf_bm") ||
            message.includes("__cf_bm") ||
            (fullMessage.includes("Cookie") && fullMessage.includes("rejected")) ||
            fullMessage.includes("invalid domain") ||
            fullMessage.includes("NS_BINDING_ABORTED")
          ) {
            return; // Silent fail
          }
          originalError.apply(console, args);
        };

        // Override console.log to suppress network errors
        console.log = function (...args) {
          // const message = String(args[0] || ""); // Unused
          const fullMessage = args.join(" ");

          if (
            fullMessage.includes("NS_BINDING_ABORTED") ||
            fullMessage.includes("net::ERR_") ||
            fullMessage.includes("_cf_bm") ||
            fullMessage.includes("__cf_bm")
          ) {
            return; // Silent fail
          }
          originalLog.apply(console, args);
        };

        // Suppress unhandled promise rejections for aborted requests
        window.addEventListener("unhandledrejection", function (event) {
          const reason = event.reason;
          const message = reason?.message || String(reason || "");

          if (
            message.includes("aborted") ||
            message.includes("NS_BINDING_ABORTED") ||
            message.includes("AbortError") ||
            reason?.name === "AbortError"
          ) {
            event.preventDefault(); // Prevent console error
            return;
          }
        });

        // Suppress global error events for network errors
        window.addEventListener(
          "error",
          function (event) {
            const message = event.message || "";
            const filename = event.filename || "";
            const target = event.target;

            // Suppress errors related to aborted requests, cookies, or failed image loads
            if (
              message.includes("NS_BINDING_ABORTED") ||
              message.includes("_cf_bm") ||
              message.includes("__cf_bm") ||
              (message.includes("Cookie") && message.includes("rejected")) ||
              (filename.includes("supabase.co") && message.includes("Failed")) ||
              (target &&
                target.tagName === "IMG" &&
                target.src &&
                target.src.includes("supabase.co/storage"))
            ) {
              event.preventDefault();
              event.stopPropagation();
              return false;
            }
          },
          true
        ); // Use capture phase to catch early

        // Intercept fetch to suppress aborted request errors and failed avatar requests
        const originalFetch = window.fetch;
        window.fetch = function (...args) {
          const url = typeof args[0] === "string" ? args[0] : args[0]?.url || "";
          const method = args[1]?.method || "GET";

          // Suppress HEAD requests to Supabase storage avatars (we know they'll fail)
          if (
            method === "HEAD" &&
            url.includes("supabase.co/storage") &&
            url.includes("/avatars/")
          ) {
            return Promise.resolve(new Response(null, { status: 404, statusText: "Not Found" }));
          }

          let fetchPromise = originalFetch.apply(this, args);

          // Wrap to catch and suppress abort errors
          fetchPromise = fetchPromise.catch(function (error) {
            if (
              error?.name === "AbortError" ||
              error?.message?.includes("aborted") ||
              error?.message?.includes("NS_BINDING_ABORTED")
            ) {
              // Return a silent rejection
              return Promise.reject(new Error("Request aborted (suppressed)"));
            }
            throw error;
          });

          // Also suppress 400 responses for avatar images
          fetchPromise = fetchPromise.then(function (response) {
            if (
              !response.ok &&
              response.status === 400 &&
              url.includes("supabase.co/storage") &&
              url.includes("/avatars/")
            ) {
              // Return a silent failure - don't throw, just return a 404-like response
              return new Response(null, { status: 404, statusText: "Not Found" });
            }
            return response;
          });

          return fetchPromise;
        };

        // Intercept XMLHttpRequest to suppress aborted errors and failed avatar requests
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSend = XMLHttpRequest.prototype.send;

        XMLHttpRequest.prototype.open = function (...args) {
          this._suppressAbortError = false;
          this._url = args[1]; // Store URL for later check
          return originalXHROpen.apply(this, args);
        };

        XMLHttpRequest.prototype.send = function (...args) {
          const xhr = this;
          const url = xhr._url || "";

          // Suppress 400 errors for avatar images
          const originalOnLoad = xhr.onload;
          xhr.onload = function (event) {
            if (
              xhr.status === 400 &&
              url.includes("supabase.co/storage") &&
              url.includes("/avatars/")
            ) {
              // Silently fail - don't trigger error handlers
              return;
            }
            if (originalOnLoad) {
              originalOnLoad.call(xhr, event);
            }
          };

          const originalOnError = xhr.onerror;
          xhr.onerror = function (event) {
            // Suppress errors for avatar images
            if (url.includes("supabase.co/storage") && url.includes("/avatars/")) {
              return;
            }
            // Suppress aborted errors
            if (xhr.status === 0 && xhr.readyState === 0) {
              // Likely an aborted request
              return;
            }
            if (originalOnError) {
              originalOnError.call(xhr, event);
            }
          };

          return originalXHRSend.apply(this, args);
        };
      })();
    </script>

    <!-- Theme detection - MUST be first to be available for all components -->
    <script is:inline>
      (function() {
        // Initialize dark mode FIRST to prevent flash (IIFE avoids duplicate-declaration if script is inlined twice)
        var hasExplicitPreference = localStorage.getItem("color-theme") !== null;

        function setThemeCookie(theme) {
          document.cookie = "theme=" + theme + "; path=/; max-age=31536000; SameSite=Lax";
          console.log("[THEME-CLIENT] Cookie set to:", theme);
          console.log("[THEME-CLIENT] All cookies:", document.cookie);
          var cookies = document.cookie.split(";").reduce(function(acc, cookie) {
            var parts = cookie.trim().split("=");
            acc[parts[0]] = parts[1];
            return acc;
          }, {});
          console.log("[THEME-CLIENT] Parsed cookies:", cookies);
          console.log("[THEME-CLIENT] Theme cookie value:", cookies.theme);
        }

        if (hasExplicitPreference) {
          var theme = localStorage.getItem("color-theme");
          if (theme === "dark") {
            document.documentElement.classList.add("dark", "zD1iTsv7EQco3GO_szee");
            setThemeCookie("dark");
          } else {
            document.documentElement.classList.remove("dark", "zD1iTsv7EQco3GO_szee");
            setThemeCookie("light");
          }
        } else {
          if (window.matchMedia("(prefers-color-scheme: dark)").matches) {
            document.documentElement.classList.add("dark", "zD1iTsv7EQco3GO_szee");
            localStorage.setItem("color-theme", "dark");
            setThemeCookie("dark");
          } else {
            document.documentElement.classList.remove("dark", "zD1iTsv7EQco3GO_szee");
            localStorage.setItem("color-theme", "light");
            setThemeCookie("light");
          }
        }

        window.isDarkMode = function() {
          var hasDarkClass = document.documentElement.classList.contains("dark");
          var localStorageTheme = localStorage.getItem("color-theme");
          var systemPrefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
          if (hasDarkClass) return true;
          if (localStorageTheme !== null) return localStorageTheme === "dark";
          return systemPrefersDark;
        };

        window.currentTheme = window.isDarkMode() ? "dark" : "light";

        /* page-size-plugin: must run inline before CSS to avoid FOUC (see src/lib/page-size-plugin.ts) */
        var pageSize = localStorage.getItem("page-size") || "normal";
        document.documentElement.setAttribute("data-page-size", pageSize);

        var ua = navigator.userAgent;
        var isIOS = /iPad|iPhone|iPod/.test(ua);
        var versionMatch = ua.match(/Version\/(\d+)/);
        var major = versionMatch ? parseInt(versionMatch[1], 10) : 0;
        if (isIOS && major > 0 && major < 14) {
          window.__legacySafari = true;
        }
      })();
    </script>

    <!-- Expose for components that run in swapped SPA content (bundled so no 404 on /lib/...) -->
    <script>
      import "../../scripts/init-auth-globals";
    </script>

    <!-- Critical CMS colors (server-rendered) so first paint uses DB colors before any script -->
    <style is:global set:html={criticalColorsCss} />

    <!-- Dynamic Color & Font Injection - MUST run BEFORE CSS is parsed to prevent flash -->
    <script
      is:inline
      define:vars={{
        primaryColor,
        secondaryColor,
        fontFamily,
        secondaryFontFamily,
        globalCompanyName,
      }}
    >
      (function () {
        // Inject colors and font immediately, synchronously BEFORE any CSS is parsed
        const primary = primaryColor || "#825BDD";
        const secondary = secondaryColor || "#0ea5e9";
        const font = fontFamily || "Outfit Variable";
        const secondaryFont = secondaryFontFamily || "sans-serif";

        // Font loading configuration - maps font names to Google Fonts URLs
        const fontConfigs = {
          "Outfit Variable": null, // Loaded via npm package
          Roboto:
            "https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap",
          "Open Sans":
            "https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&display=swap",
          Lato: "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",
          Montserrat:
            "https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap",
          Poppins:
            "https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap",
          Inter: "https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap",
          Raleway:
            "https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600;700&display=swap",
          "Source Sans Pro":
            "https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@300;400;600;700&display=swap",
          Nunito:
            "https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700&display=swap",
          "Playfair Display":
            "https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&display=swap",
          Merriweather:
            "https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap",
          Oswald:
            "https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;600;700&display=swap",
          Lora: "https://fonts.googleapis.com/css2?family=Lora:wght@400;700&display=swap",
          "PT Sans": "https://fonts.googleapis.com/css2?family=PT+Sans:wght@400;700&display=swap",
          Ubuntu: "https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;700&display=swap",
          "Noto Sans":
            "https://fonts.googleapis.com/css2?family=Noto+Sans:wght@300;400;600;700&display=swap",
          "Work Sans":
            "https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;600;700&display=swap",
          "Crimson Text":
            "https://fonts.googleapis.com/css2?family=Crimson+Text:wght@400;700&display=swap",
          "Fira Sans":
            "https://fonts.googleapis.com/css2?family=Fira+Sans:wght@300;400;600;700&display=swap",
          "Dancing Script":
            "https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap",
          "Bebas Neue": "https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap",
          Comfortaa:
            "https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;600;700&display=swap",
          Quicksand:
            "https://fonts.googleapis.com/css2?family=Quicksand:wght@300;400;600;700&display=swap",
          Rubik: "https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;600;700&display=swap",
          "Josefin Sans":
            "https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@300;400;600;700&display=swap",
          "Libre Baskerville":
            "https://fonts.googleapis.com/css2?family=Libre+Baskerville:wght@400;700&display=swap",
          Cabin: "https://fonts.googleapis.com/css2?family=Cabin:wght@400;600;700&display=swap",
          Dosis: "https://fonts.googleapis.com/css2?family=Dosis:wght@300;400;600;700&display=swap",
          Arvo: "https://fonts.googleapis.com/css2?family=Arvo:wght@400;700&display=swap",
          "Titillium Web":
            "https://fonts.googleapis.com/css2?family=Titillium+Web:wght@300;400;600;700&display=swap",
          Mukta: "https://fonts.googleapis.com/css2?family=Mukta:wght@300;400;600;700&display=swap",
          Karla: "https://fonts.googleapis.com/css2?family=Karla:wght@300;400;600;700&display=swap",
          Barlow:
            "https://fonts.googleapis.com/css2?family=Barlow:wght@300;400;600;700&display=swap",
          "DM Sans": "https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;700&display=swap",
          Manrope:
            "https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;600;700&display=swap",
          "Space Grotesk":
            "https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap",
          "Plus Jakarta Sans":
            "https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;700&display=swap",
        };

        // Load font dynamically if not already loaded
        function loadFont(fontName) {
          const url = fontConfigs[fontName];
          if (!url) return; // Skip if no URL (e.g., Outfit Variable loaded via npm)

          // Check if font link already exists
          const existingLink = document.querySelector(`link[href="${url}"]`);
          if (existingLink) {
            console.log("[Font] Already loaded:", fontName);
            return;
          }

          // Create and inject Google Font link
          const link = document.createElement("link");
          link.rel = "stylesheet";
          link.href = url;
          link.crossOrigin = "anonymous";
          document.head.appendChild(link);
          console.log("[Font] Loading font:", fontName);
        }

        // Load primary and secondary fonts
        loadFont(font);
        loadFont(secondaryFont);

        // Generate color palettes inline (same algorithm as dynamic-colors.ts)
        function hexToHsl(hex) {
          const r = parseInt(hex.slice(1, 3), 16) / 255;
          const g = parseInt(hex.slice(3, 5), 16) / 255;
          const b = parseInt(hex.slice(5, 7), 16) / 255;
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          let h = 0,
            s = 0;
          const l = (max + min) / 2;
          if (max !== min) {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
              case r:
                h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
                break;
              case g:
                h = ((b - r) / d + 2) / 6;
                break;
              case b:
                h = ((r - g) / d + 4) / 6;
                break;
            }
          }
          return [Math.round(h * 360), Math.round(s * 100), Math.round(l * 100)];
        }

        function hslToHex(h, s, l) {
          l /= 100;
          const a = (s * Math.min(l, 1 - l)) / 100;
          const f = (n) => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color)
              .toString(16)
              .padStart(2, "0");
          };
          return `#${f(0)}${f(8)}${f(4)}`;
        }

        function generatePalette(baseColor) {
          if (!baseColor || !baseColor.match(/^#[0-9A-F]{6}$/i)) {
            baseColor = "#3b82f6";
          }
          const [h, s, l] = hexToHsl(baseColor);
          return {
            50: hslToHex(h, Math.max(s - 20, 10), Math.min(l + 45, 95)),
            100: hslToHex(h, Math.max(s - 15, 15), Math.min(l + 40, 90)),
            200: hslToHex(h, Math.max(s - 10, 20), Math.min(l + 30, 85)),
            300: hslToHex(h, Math.max(s - 5, 25), Math.min(l + 20, 75)),
            400: hslToHex(h, s, Math.min(l + 10, 65)),
            500: baseColor,
            600: hslToHex(h, Math.min(s + 5, 90), Math.max(l - 10, 25)),
            700: hslToHex(h, Math.min(s + 10, 95), Math.max(l - 20, 20)),
            800: hslToHex(h, Math.min(s + 15, 100), Math.max(l - 30, 15)),
            900: hslToHex(h, Math.min(s + 20, 100), Math.max(l - 40, 10)),
            950: hslToHex(h, Math.min(s + 25, 100), Math.max(l - 50, 5)),
          };
        }

        // Inject colors IMMEDIATELY - document.documentElement exists even before DOMContentLoaded
        const root = document.documentElement;
        const primaryPalette = generatePalette(primary);
        const secondaryPalette = generatePalette(secondary);

        Object.entries(primaryPalette).forEach(([shade, color]) => {
          root.style.setProperty(`--color-primary-${shade}`, color);
        });

        Object.entries(secondaryPalette).forEach(([shade, color]) => {
          root.style.setProperty(`--color-secondary-${shade}`, color);
        });

        // Inject font families
        root.style.setProperty("--font-family", font);
        root.style.setProperty("--font-family-secondary", secondaryFont);

        console.log("[App] âœ… Dynamic colors and fonts injected immediately:", {
          primary,
          secondary,
          font,
          secondaryFont,
        });
      })();
    </script>

    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta name="author" content="Tomsens+REKKO" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <!-- Preconnect to Google Fonts for better performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <title>
      {(title || Astro.url.pathname.replace(/\//g, " ").trim()) + " â†’ " + globalCompanyName}
    </title>
    <meta name="description" content={description} />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content={primaryColor} />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-project-title" content={globalCompanyName} />
    <meta name="generator" content={Astro.generator} />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none" />
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups" />
    <!-- Open Graph / Facebook / iOS Preview -->
    <meta property="og:type" content="website" />
    <meta property="og:site_name" content={globalCompanyName} />
    <meta property="og:url" content={Astro.url.href} />
    <meta property="og:title" content={(title || "Home") + " â†’ " + globalCompanyName} />
    <meta property="og:description" content={description || globalCompanySlogan || ""} />
    {
      ogImageSrc && (
        <>
          <meta property="og:image" content={ogImageSrc} />
          <meta property="og:image:secure_url" content={ogImageSrc} />
          <meta
            property="og:image:type"
            content={
              ogImageSrc?.includes(".gif")
                ? "image/gif"
                : ogImageSrc?.includes(".svg")
                  ? "image/svg+xml"
                  : ogImageSrc?.includes(".png")
                    ? "image/png"
                    : ogImageSrc?.includes(".jpg") || ogImageSrc?.includes(".jpeg")
                      ? "image/jpeg"
                      : ogImageSrc?.includes(".webp")
                        ? "image/webp"
                        : "image/png"
            }
          />
          <meta property="og:image:width" content="1200" />
          <meta property="og:image:height" content="630" />
          <meta
            property="og:image:alt"
            content={globalCompanyName + " - " + (description || globalCompanySlogan || "")}
          />
        </>
      )
    }

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={(title || "Home") + " â†’ " + globalCompanyName} />
    <meta name="twitter:description" content={description || globalCompanySlogan || ""} />
    {ogImageSrc && <meta name="twitter:image" content={ogImageSrc} />}
    {
      ogImageSrc && (
        <meta
          name="twitter:image:alt"
          content={globalCompanyName + " - " + (description || globalCompanySlogan || "")}
        />
      )
    }

    <!-- iOS / iMessage Preview -->
    <meta name="robots" content="max-image-preview:large" />

    <link rel="canonical" href={Astro.url.href} />
    <link rel="stylesheet" href="https://flowbite.com/application-ui/demo/app.css" />
    <!-- Font Awesome for icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Favicons and App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href={iconSrc} />
    <link
      rel="icon"
      type={globalCompanyIcon?.includes("<svg") || globalCompanyIcon?.includes("<?xml")
        ? "image/svg+xml"
        : "image/png"}
      sizes="32x32"
      href={iconSrc}
    />
    <link
      rel="icon"
      type={globalCompanyIcon?.includes("<svg") || globalCompanyIcon?.includes("<?xml")
        ? "image/svg+xml"
        : "image/png"}
      sizes="16x16"
      href={iconSrc}
    />
    <link
      rel="icon"
      type={globalCompanyIcon?.includes("<svg") || globalCompanyIcon?.includes("<?xml")
        ? "image/svg+xml"
        : "image/png"}
      href={iconSrc}
    />
    <link rel="manifest" href="/manifest.json" />
    <link rel="mask-icon" href={iconSrc} color="#5bbad5" />
    <meta name="msapplication-TileColor" content={primaryColor} />
    <meta name="theme-color" content={primaryColor} />

    <!-- Custom CSS from CMS Global Settings -->
    {
      customCss && customCss.trim() && (
        <style is:inline set:html={customCss} data-source="cms-custom-css" />
      )
    }

    <script>
      import {
        initializeNotificationCount,
        loadNotificationCount,
        refreshNotificationCount,
        updateNotificationBellCount,
      } from "@/lib/notification-count-loader";

      // Make functions globally available
      (window as any).initializeNotificationCount = initializeNotificationCount;
      (window as any).updateNotificationBellCount = updateNotificationBellCount;
      (window as any).loadNotificationCount = loadNotificationCount;
      (window as any).refreshNotificationCount = refreshNotificationCount;
    </script>

    <!-- Global typewriter: simple (vanilla) + TypeIt-based -->
    <script>
      (function () {
        const DONE_ATTR = "data-typewriter-done";

        function runSimpleTypewriter(
          el: HTMLElement,
          options?: { speed?: number; doneClass?: string; dispatchEvent?: boolean }
        ): void {
          const text = el.getAttribute("data-text");
          if (!text || el.hasAttribute(DONE_ATTR)) return;
          el.setAttribute(DONE_ATTR, "true");
          el.textContent = "";
          const speed = options?.speed ?? 60;
          const doneClass = options?.doneClass ?? "typewriter-complete";
          const dispatchEvent = options?.dispatchEvent ?? false;

          function type(i: number) {
            if (i < text.length) {
              el.textContent += text[i];
              setTimeout(() => type(i + 1), speed);
            } else {
              el.classList.add(doneClass);
              if (dispatchEvent) {
                el.dispatchEvent(new CustomEvent("typewriter-complete", { bubbles: true }));
              }
            }
          }
          type(0);
        }

        function runSimpleTypewriterOnSelector(selector: string): void {
          document.querySelectorAll<HTMLElement>(selector).forEach((el) => runSimpleTypewriter(el));
        }

        (window as any).runSimpleTypewriter = runSimpleTypewriter;
        (window as any).runSimpleTypewriterOnSelector = runSimpleTypewriterOnSelector;

        function initLoadingTypewriters() {
          runSimpleTypewriterOnSelector("[data-loading-typewriter]");
        }
        document.addEventListener("DOMContentLoaded", initLoadingTypewriters);
        document.addEventListener("astro:page-load", initLoadingTypewriters);
        if (document.readyState === "complete" || document.readyState === "interactive") {
          initLoadingTypewriters();
        }
      })();
    </script>
    <script>
      import { initTypewriterTexts, triggerActiveStepTypewriter } from "../../scripts/typewriter-text";
      (window as any).initTypewriterTexts = initTypewriterTexts;
      (window as any).triggerActiveStepTypewriter = triggerActiveStepTypewriter;
    </script>

    <!-- Set global user data for client-side components -->

    <!-- SPA: persist CMS colors for re-apply after client navigation -->
    {isBackend && (
      <>
        <script id="cms-colors" type="application/json" set:html={JSON.stringify({
          primaryColor: primaryColor || "#825BDD",
          secondaryColor: secondaryColor || "#0ea5e9",
          fontFamily: fontFamily || "Outfit Variable",
          secondaryFontFamily: secondaryFontFamily || "sans-serif",
        })} />
        <script is:inline data-astro-rerun>
          document.addEventListener("astro:after-swap", function reapplyCmsColors() {
            const el = document.getElementById("cms-colors");
            if (!el || !el.textContent) return;
            try {
              const cms = JSON.parse(el.textContent);
              const primary = cms.primaryColor || "#825BDD";
              const secondary = cms.secondaryColor || "#0ea5e9";
              const root = document.documentElement;
              function hexToHsl(hex) {
                hex = hex.replace("#", "");
                var r = parseInt(hex.substr(0, 2), 16) / 255, g = parseInt(hex.substr(2, 2), 16) / 255, b = parseInt(hex.substr(4, 2), 16) / 255;
                var max = Math.max(r, g, b), min = Math.min(r, g, b), l = (max + min) / 2, s = 0, h = 0;
                if (max !== min) {
                  var d = max - min;
                  s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                  switch (max) { case r: h = (g - b) / d + (g < b ? 6 : 0); break; case g: h = (b - r) / d + 2; break; case b: h = (r - g) / d + 4; break; }
                  h /= 6;
                }
                return [h * 360, s * 100, l * 100];
              }
              function hslToHex(h, s, l) {
                h /= 360; s /= 100; l /= 100;
                var a = s * Math.min(l, 1 - l) / 100;
                var f = function(n) { var k = (n + h / 30) % 12; return l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1); };
                return "#" + [0, 8, 4].map(function(n) { return Math.round(255 * f(n)).toString(16).padStart(2, "0"); }).join("");
              }
              function palette(base) {
                if (!base || !base.match(/^#[0-9A-F]{6}$/i)) base = "#825BDD";
                var _a = hexToHsl(base), h = _a[0], s = _a[1], l = _a[2];
                return { 50: hslToHex(h, Math.max(s - 20, 10), Math.min(l + 45, 95)), 100: hslToHex(h, Math.max(s - 15, 15), Math.min(l + 40, 90)), 200: hslToHex(h, Math.max(s - 10, 20), Math.min(l + 30, 85)), 300: hslToHex(h, Math.max(s - 5, 25), Math.min(l + 20, 75)), 400: hslToHex(h, s, Math.min(l + 10, 65)), 500: base, 600: hslToHex(h, Math.min(s + 5, 90), Math.max(l - 10, 25)), 700: hslToHex(h, Math.min(s + 10, 95), Math.max(l - 20, 20)), 800: hslToHex(h, Math.min(s + 15, 100), Math.max(l - 30, 15)), 900: hslToHex(h, Math.min(s + 20, 100), Math.max(l - 40, 10)), 950: hslToHex(h, Math.min(s + 25, 100), Math.max(l - 50, 5)) };
              }
              var p = palette(primary), s = palette(secondary);
              Object.keys(p).forEach(function(k) { root.style.setProperty("--color-primary-" + k, p[k]); });
              Object.keys(s).forEach(function(k) { root.style.setProperty("--color-secondary-" + k, s[k]); });
              root.style.setProperty("--font-family", cms.fontFamily || "Outfit Variable");
              root.style.setProperty("--font-family-secondary", cms.secondaryFontFamily || "sans-serif");
            } catch (e) { console.warn("[App] astro:after-swap reapplyCmsColors:", e); }
          });
        </script>
      </>
    )}

    <!-- SPA client-side routing for project/* and admin/* (no full page reload) -->
    {isBackend && <ClientRouter fallback="swap" />}
  </head>

  <body
    class:list={[
      "antialiased"    
    ]}
    transition:animate={isBackend ? "none" : undefined}
    data-spa-enabled={isBackend ? "true" : undefined}
    data-spa-path={isBackend ? currentUrl : undefined}
  >

   
    <!-- SPA: re-apply theme and re-init after client-side navigation (backend only) -->
    {isBackend && (
      <script is:inline>
        (function () {
          function applyTheme() {
            if (!document.documentElement) return;
            var theme = localStorage.getItem("color-theme");
            var dark =
              theme === "dark" ||
              (!theme && window.matchMedia && window.matchMedia("(prefers-color-scheme: dark)").matches);
            document.documentElement.classList.toggle("dark", dark);
            document.documentElement.classList.toggle("zD1iTsv7EQco3GO_szee", dark);
          }
          applyTheme();
          document.addEventListener("astro:page-load", applyTheme);

          // SPA: reset body scroll state after swap so new page can scroll (avoids stuck overflow:hidden from modals)
          document.addEventListener("astro:after-swap", function resetBodyScrollAfterSwap() {
            var body = document.body;
            var html = document.documentElement;
            body.style.overflow = "";
            body.style.position = "";
            body.style.top = "";
            body.style.width = "";
            html.style.overflow = "";
            body.classList.remove("modal-open");
            if (typeof window.forceUnlockBodyScroll === "function") {
              window.forceUnlockBodyScroll();
            }
          });
        })();
      </script>
    )}


    <!-- SPA debug: log transition lifecycle (localhost or ?debug=spa). Open browser console to trace. -->
    {isBackend && (
      <script is:inline data-astro-rerun>
        (function () {
          var isLocal = typeof window !== "undefined" && (window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1");
          var qs = typeof window !== "undefined" && window.location.search;
          var debugSpa = isLocal || (qs && qs.indexOf("debug=spa") !== -1);
          if (!debugSpa) return;
          var path = typeof window !== "undefined" ? window.location.pathname : "";
          console.log("[SPA] Initial load pathname:", path);
          ["astro:before-preparation", "astro:after-preparation", "astro:page-load", "astro:after-swap"].forEach(function (ev) {
            document.addEventListener(ev, function (e) {
              var d = e.detail || {};
              console.log("[SPA] " + ev, {
                from: d.from,
                to: d.to || (ev === "astro:page-load" || ev === "astro:after-swap" ? window.location.pathname : undefined),
                response: d.response ? (d.response.redirected ? "redirect:" + d.response.url : "status:" + d.response.status) : undefined,
              });
            });
          });
        })();
      </script>
    )}

    <!-- SPA: run backend page inits on navigation (when swapped-in scripts may not run) -->
    {isBackend && (
      <script is:inline>
        (function () {
          function runPageInits() {
            var path = window.location.pathname;
            if (path === '/project/dashboard' && typeof window.__initProjectDashboard === 'function') {
              window.__initProjectDashboard();
            }
            if (path === '/dashboard' && typeof window.__initDashboard === 'function') {
              window.__initDashboard();
            }
            if (path === '/profile' && typeof window.__initProfile === 'function') {
              window.__initProfile();
            }
          }
          document.addEventListener('astro:page-load', runPageInits);
        })();
      </script>
    )}


<!-- Global Modal Overlay - Single instance used by all modals -->
    <Modal id="global-backdrop" zIndex={1000} blurAmount="lg" opacity="50" />
    <!-- Global Modals - Must be siblings of overlay for z-index to work -->
    
    <UnifiedNotification />

    <TutorialOverlay {currentUser} tutorialId="demo-tour" autoStart={false} {isAuth} />

    <DebugPanel {debugData} {currentRole} />
    
    <FeedbackPanel {currentUser} />

    <NotificationsModal id="notification" {currentUser} {globalIconButtonClasses} {projects} />

    <UserProfileDropdown {globalIconButtonClasses} {projects} {currentUser} />
  
    <PunchlistDrawer
      {globalIconButtonClasses}
      currentUser={currentUser}
      supabaseUrl={supabaseUrl}
      project={project}
    />


    <!-- Layout shell: one fixed nav (banners + bar), sidebar, then scroll pane. Scripts use #main-navbar height for #reveal-scroll. -->
    <div class="md:min-h-0" data-template={layout}>
      <Navbar
        {globalIconButtonClasses}
        {desktopNavigationHTML}
        {currentUser}
        {session}
        {supabaseUrl}
        {id}
        {projects}
        {isBackend}
        {project}
        pathname={Astro.url.pathname}
        template={layout}
      />

      <Aside
      {globalIconButtonClasses}
      {currentUser}
      {globalInputClasses}
      {primaryTextClasses}
      {projects}
      {mobileNavigationHTML}
    />

      <!-- Scrolling pane: translateY(-scrollTop) so pane slides up with scroll, masking header and revealing footer -->
      <div
        id="reveal-scroll"
        class="scrollbar-hide relative z-50 overflow-y-auto bg-gray-50 dark:bg-gray-950"
      >




    <!-- Backdrop for #page (reveal target): DotGrid + color-background -->
    <!-- <div class="relative min-w-0 overflow-x-hidden flex-1 min-h-0"> -->
      <!-- <div id="page" class="relative z-0 min-w-0 overflow-x-hidden flex-1 flex flex-col min-h-0" data-template={layout}   data-dynamic-height="true"
      > -->
    <!-- ${centerContent ? 'overscroll-behavior-y: contain;' : ''} -->
    <!-- 'overscroll-behavior-y: contain; touch-action: pan-x;' -->
 
      <div
        id="main-content"
        class:list={[
          // "color-background",
          // "flex-1 min-w-0",
          currentUser ? "sm:ml-16" : "",

          // (layout === "default"  || layout === "minimal" || !layout) &&
          //   "px-4 sm:px-6 md:px-8 lg:px-10",
          mainClasses,
          layout === "default" && "px-4 sm:px-6 md:px-8 lg:px-10 pt-4 sm:pt-6 md:pt-8 lg:pt-10",
          layout === "centered" ? "" : "",
        ]}
        style={currentUser ? "" : undefined}
        
      >
        <main>
          <slot />
        </main>
      
     
     
 
      


        </div>

        <ul class="align-center flex justify-center text-gray-500 dark:text-gray-400">
       
          <li>
            <Tooltip
              position="right"
              text={`${new Date().getFullYear().toString()} ${globalCompanyName}. 
              All rights reserved.`}
              ><span class="me-6 no-underline hover:underline">Â©</span>
            </Tooltip>
          </li>
          <li>
            <a href="/privacy" class="me-6 no-underline hover:underline"> privacy </a>
          </li>
          <li>
            <a href="/terms" class="me-6 no-underline hover:underline"> terms </a>
          </li>
          <li>
            <a href="/cookies" class="no-underline hover:underline"> cookie </a>
          </li>
        </ul>
      </div>
      <Footer
      {isAuthPageResult}
      {isContactPageResult}
      {currentUser}
      {isBackend}
      {globalIconButtonClasses}
      {globalCompanyName}
      {isBackend}
      {globalCompanyPhone}
      {primaryTextClasses}
      {secondaryTextClasses}
      {globalInputClasses}
    />

    <div id="action-buttons" class="fixed bottom-8 right-4 hide-on-form-focus z-50">
    {isAdmin ? (
      <AdminVoiceAssistantWidget
        currentUser={currentUser}
        globalCompanyPhone={globalCompanyPhone}
      />
    ) : (
      <SpeedDial
        {globalCompanyPhone}
        currentUser={currentUser || undefined}
        {isBackend}
        {primaryTextClasses}
        {secondaryTextClasses}
        {globalInputClasses}
        {globalCompanyName}
      />
    )}
    </div>

    </div>
    <!-- </div> -->

 




    <CookieBanner />

    <!-- Prevent Flowbite from initializing modals that don't exist -->
    <!-- Flowbite JavaScript -->
    <script src="https://unpkg.com/flowbite@2.5.2/dist/flowbite.min.js"></script>

    <script>
      import "../../scripts/app-globals";
    </script>

    <!-- Overscroll: scale .overscroll-scale linearly with overscroll % (getOverscrollPercent). 0â€“100% â†’ scale 1; >100% or <0% â†’ scale tracks linearly. -->
    <script is:inline>
      (function () {
        var getOverscrollPercent = window.getOverscrollPercent;
        if (typeof getOverscrollPercent !== "function") return;

        var MIN_SCALE = 0.9;
        var MAX_SCALE = 1.25;
        var overscrollScaleEls = [];
        var wasInRange = true;

        function scaleFromPercent(p) {
          if (p >= 0 && p <= 100) return 1;
          if (p > 100) return Math.min(MAX_SCALE, 1 + (p - 100) / 100);
          return Math.max(MIN_SCALE, 1 + p / 100);
        }

        function applyOverscrollScale() {
          var p = getOverscrollPercent();
          var inRange = p >= 0 && p <= 100;
          if (wasInRange && !inRange) {
            console.log("overscroll started", Math.round(p * 10) / 10 + "%");
          }
          wasInRange = inRange;

          var scale = scaleFromPercent(p);
          if (overscrollScaleEls.length === 0) overscrollScaleEls = Array.from(document.querySelectorAll(".overscroll-scale"));
          overscrollScaleEls.forEach(function (el) {
            el.style.transform = "scale(" + scale + ")";
          });
        }

        var ticking = false;
        function onScrollOrWheel() {
          if (ticking) return;
          ticking = true;
          requestAnimationFrame(function () {
            applyOverscrollScale();
            ticking = false;
          });
        }

        function init() {
          window.addEventListener("scroll", onScrollOrWheel, { passive: true });
          window.addEventListener("wheel", onScrollOrWheel, { passive: true });
          applyOverscrollScale();
        }

        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", init);
        } else {
          setTimeout(init, 0);
        }
      })();
    </script>

    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        (window as any).hideOnFormFocus();

        // Initialize notification count only if user is authenticated
        try {
          const notificationBell = document.querySelector('[data-dropdown-toggle="notification-dropdown"]') as HTMLElement | null;
          if (
            notificationBell &&
            notificationBell.dataset?.userId &&
            (window as any).initializeNotificationCount
          ) {
            console.log(
              "ðŸ”” [APP] Initializing notifications for user:",
              notificationBell.dataset.userId
            );
            await (window as any).initializeNotificationCount();
          } else {
            console.log("ðŸ”” [APP] Skipping notification initialization - no authenticated user");
          }
        } catch (error) {
          console.error("ðŸ”” [APP] Error initializing notification count:", error);
        }
      });
    </script>

    <!-- Global Image Error Handler -->
    <script>
      // Global error handler for broken image URLs (especially Supabase storage)
      document.addEventListener("DOMContentLoaded", () => {
        // Suppress expected console errors in development
        const isDev =
          window.location.hostname === "localhost" || window.location.hostname === "127.0.0.1";

        // Handle all img elements with error handling
        const images = document.querySelectorAll("img");

        images.forEach((img) => {
          img.addEventListener("error", (event) => {
            const target = event.target as HTMLImageElement;
            const src = target.src;

            // Check if it's a Supabase storage URL that's failing
            if (src && src.includes("supabase.co/storage")) {
              // Only log in production, silent in dev to reduce console noise
              if (!isDev) {
                console.warn("âš ï¸ [IMAGE-ERROR] Supabase storage image failed to load:", src);
              }

              // Hide the broken image and show a fallback
              target.style.display = "none";

              // Create a fallback element if it doesn't exist
              if (!target.nextElementSibling?.classList.contains("image-fallback")) {
                const fallback = document.createElement("div");
                fallback.className =
                  "image-fallback bg-gray-200 flex items-center justify-center text-gray-500";
                fallback.style.width = target.style.width || "100%";
                fallback.style.height = target.style.height || "100%";
                fallback.innerHTML = "ðŸ“·";
                target.parentNode?.insertBefore(fallback, target.nextSibling);
              }
            }
          });
        });

        // Handle dynamically added images
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            mutation.addedNodes.forEach((node) => {
              if (node.nodeType === Node.ELEMENT_NODE) {
                const element = node as Element;
                const newImages = element.querySelectorAll("img");
                newImages.forEach((img) => {
                  img.addEventListener("error", (event) => {
                    const target = event.target as HTMLImageElement;
                    const src = target.src;

                    if (src && src.includes("supabase.co/storage")) {
                      console.warn("âš ï¸ [IMAGE-ERROR] Supabase storage image failed to load:", src);
                      target.style.display = "none";

                      if (!target.nextElementSibling?.classList.contains("image-fallback")) {
                        const fallback = document.createElement("div");
                        fallback.className =
                          "image-fallback bg-gray-200 flex items-center justify-center text-gray-500";
                        fallback.style.width = target.style.width || "100%";
                        fallback.style.height = target.style.height || "100%";
                        fallback.innerHTML = "ðŸ“·";
                        target.parentNode?.insertBefore(fallback, target.nextSibling);
                      }
                    }
                  });
                });
              }
            });
          });
        });



        observer.observe(document.body, {
          childList: true,
          subtree: true,
        });
      });

      // Global error handler for unhandled promise rejections (network errors)
      window.addEventListener("unhandledrejection", (event) => {
        if (
          event.reason &&
          event.reason.message &&
          event.reason.message.includes("ERR_CONNECTION_CLOSED")
        ) {
          console.warn(
            "âš ï¸ [NETWORK-ERROR] Connection closed error suppressed:",
            event.reason.message
          );
          event.preventDefault(); // Prevent the error from showing in console
        }
      });

      // Global error handler for general errors
      window.addEventListener("error", (event) => {
        if (event.message && event.message.includes("ERR_CONNECTION_CLOSED")) {
          console.warn("âš ï¸ [NETWORK-ERROR] Connection closed error suppressed:", event.message);
          event.preventDefault(); // Prevent the error from showing in console
        }
      });
    </script>

    <!-- AOS (Animate On Scroll) - Global initialization -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer></script>
    <script is:inline>
      // Wait for AOS library to load before initializing
      window.addEventListener("DOMContentLoaded", function () {
        // @ts-ignore - AOS loaded from CDN
        if (typeof AOS !== "undefined") {
          // @ts-ignore
          AOS.init({
            duration: 800,
            easing: "ease-in-out",
            once: true,
            offset: 120,
            delay: 50,
          });
        }
      });
    </script>

    <!-- Custom Scroll Animations (Blur/Scale effects) -->
    <script>
      import "../../scripts/scroll-animations";
    </script>

    <!-- Lazy Loading Images (Global) -->
    <script>
      import "../../scripts/lazy-load-images";
    </script>

    <!-- Global Project Item Handlers (Extracted from ProjectItem.astro for performance) -->
    <script>
      import "../../scripts/project-item-handlers";
    </script>

    <!-- Button Ripple Effects (Focus and Click animations) -->
    <!-- <script>
      import "../../scripts/button-ripple";
    </script> -->

    <!-- Project Refresh Manager (DISABLED - use generic refresh-manager.ts instead) -->
    <!-- <script>
      import "../../lib/project-refresh-manager";
    </script> -->

    <!-- Global Modal System -->
    <script>
      import "../../lib/modal-global";
    </script>




    <!-- Plausible Analytics Script -->
    {plausibleTrackingScript && <Fragment set:html={plausibleTrackingScript} />}
  </body>
</html>
