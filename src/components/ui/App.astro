---
/**
 * Root layout shell: head, theme, nav, footer, global scripts.
 * Refactor notes and script order: see markdowns/APP-COMPONENT-REVIEW.md
 * Note: currentUser and session are always from checkAuth(Astro.cookies), not from props.
 */
interface Props {
  title?: string;
  description?: string;
  currentUser?: any;
  session?: any;
  project?: any;
  supabase?: any;
  supabaseUrl?: string;
  projects?: any;
  isBackend?: boolean;
  id?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  globalInputClasses?: string;
  globalIconButtonClasses?: string;
  year?: string;
  globalCompanyName?: string;
  globalCompanySlogan?: string;
  globalCompanyAddress?: string;
  globalCompanyPhone?: string;
  globalCompanyEmail?: string;
  globalCompanyWebsite?: string;
  globalCompanyLogo?: string;
  statusData?: any;
  statusOptions?: Array<{ value: string; label: string }>;
  mainClasses?: string;
  /** Layout: default | fullwidth | minimal | centered | fullscreen | fullform | reveal-footer | two-column | authCallback. authCallback = minimal chrome (no nav/footer), DB theme/styles only; use for OAuth callback to avoid ResponseSentError while keeping site look. */
  layout?:
    | "default"
    | "fullwidth"
    | "minimal"
    | "centered"
    | "fullscreen"
    | "fullform"
    | "reveal-footer"
    | "two-column"
    | "authCallback";
  mask?: string;
  horizontalScroll?: boolean;
  hideFooter?: boolean;
}

const {
  title = undefined,
  description = undefined,
  project = undefined,
  supabaseUrl = undefined,
  projects = undefined,
  id = undefined,
  mainClasses = "",
  layout = undefined,
  hideFooter = false,
} = Astro.props;

/** Minimal mode: when true, only Flowbite + theme run (debug nav/forms). See markdowns/APP-COMPONENT-REVIEW.md. */
const ONLY_FLOWBITE_AND_THEME = false;

/** Body touch/scroll classes by layout (computed once to avoid type-narrowing lint in class:list). */
const bodyTouchClass =
  layout === "fullform"
    ? "touch-none overscroll-none"
    : layout === "authCallback"
      ? ""
      : "touch-manipulation";

const stripHtml = (s: string | undefined | null): string =>
  (s ?? "")
    .replace(/<[^>]*>/g, "")
    .replace(/\s+/g, " ")
    .trim();

// Derive layout behavior from layout prop only

// Effective template for data-template

import { globalCompanyData } from "../../pages/api/global/global-company-data";
const {
  globalCompanyName,
  globalCompanySlogan,
  globalCompanyPhone,
  primaryColor,
  secondaryColor,
  backgroundColor,
  backgroundColorDark,
  fontFamily,
  secondaryFontFamily,
  globalCompanyIcon,
  plausibleTrackingScript,
  ogImage,
  customCss,
  customFooterHtml,
} = await globalCompanyData();

const safeTitle = stripHtml(title) || Astro.url.pathname.replace(/\//g, " ").trim() || "Home";
const safeDescription = stripHtml(description || globalCompanySlogan || "");

import { checkAuth } from "../../lib/auth";
const { currentUser, session } = await checkAuth(Astro.cookies);
import { globalClasses } from "../../pages/api/global/global-classes";
const { globalInputClasses, primaryTextClasses, secondaryTextClasses, globalIconButtonClasses } =
  globalClasses();

// Derived properties (needed for assigned fetch)
// Derived properties (8 props → 13 total)
const isAuth = currentUser ? true : false;
const currentUrl = Astro.url.pathname;
const currentRole = currentUser?.profile?.role;

// Fetch assigned projects (count + preview) for Staff/Admin — lightweight endpoint, no profiles/files
// Skip for authCallback layout to keep pipeline minimal and avoid any async that could affect response
let assignedProjectsCount = 0;
let assignedProjectsPreview: any[] = [];
const skipAssignedFetch = layout === "authCallback";
if (!skipAssignedFetch && currentUser && (currentRole === "Admin" || currentRole === "Staff")) {
  try {
    const cookieHeader = Astro.request.headers.get("Cookie") || "";
    const res = await fetch(`${Astro.url.origin}/api/projects/assigned-summary`, {
      headers: { Cookie: cookieHeader },
    });
    if (res.ok) {
      const data = await res.json();
      assignedProjectsCount = data.count ?? 0;
      assignedProjectsPreview = data.items ?? [];
    }
  } catch {
    /* ignore */
  }
}

// Get navigation data
import { navigation } from "@/pages/api/utils/navigation";
import { isBackendPage, isAuthPage, isContactPage } from "../../pages/api/utils/backend-page-check";

const isBackend = isBackendPage(Astro.url.pathname);
const isAuthPageResult = isAuthPage(Astro.url.pathname);
const isContactPageResult = isContactPage(Astro.url.pathname);
// Skip navigation fetch for authCallback to keep pipeline minimal
const navigationData =
  layout === "authCallback"
    ? { desktopNavigationHTML: "", mobileNavigationHTML: "", visibleNavItems: [] }
    : await navigation(currentUrl, isAuth, currentRole || "Client", isBackend || false);
const { desktopNavigationHTML, mobileNavigationHTML, visibleNavItems } = navigationData;
// SPA disabled: import { ClientRouter } from "astro:transitions";
import "../../styles/global.css"; // Import Tailwind CSS
// import "../../styles/app.css"; // Import Tailwind CSS

import Footer from "./Footer.astro";
import UnifiedNotification from "./UnifiedNotification.astro";
import CookieBanner from "../common/CookieBanner.astro";
import Navbar from "./Navbar.astro";
import Aside from "./Aside.astro";
import TutorialOverlay from "../common/TutorialOverlay.astro";
import FeedbackPanel from "../common/FeedbackPanel.astro";
import SpeedDial from "../ui/SpeedDial.astro";
import SubFooter from "./SubFooter.astro";
import AdminVoiceAssistantWidget from "../admin/AdminVoiceAssistantWidget.astro";
import CacheIndicator from "./CacheIndicator.astro";
import CMSPreloader from "./CMSPreloader.astro";
import AppHead from "./AppHead.astro";

const isAdmin = currentUser?.profile?.role === "Admin";

// Console suppression: ON by default. Set PUBLIC_SUPPRESS_CONSOLE_NOISE=false to disable (e.g. when debugging).
const suppressConsoleNoise = import.meta.env.PUBLIC_SUPPRESS_CONSOLE_NOISE !== "false";
---

<!doctype html>
<html lang="en" data-suppress-console-noise={suppressConsoleNoise ? "1" : "0"}>
  <head>
    {
      !ONLY_FLOWBITE_AND_THEME && (
        <>
          {/* 1. DOMContentLoaded patch - re-enable first if testing */}
          <script is:inline src="/scripts/dom-content-loaded-patch.js" />
          <script is:inline src="/scripts/console-suppress.js" />
        </>
      )
    }

    {
      /* Pre-bundled app-init (theme, notification, typewriter). app-globals + auth-google loaded in body. */
    }
    {!ONLY_FLOWBITE_AND_THEME && <script is:inline src="/scripts/app-init.js" />}

    <AppHead
      safeTitle={safeTitle}
      safeDescription={safeDescription}
      globalCompanyName={globalCompanyName}
      primaryColor={primaryColor ?? ""}
      secondaryColor={secondaryColor}
      backgroundColor={backgroundColor}
      backgroundColorDark={backgroundColorDark}
      fontFamily={fontFamily}
      secondaryFontFamily={secondaryFontFamily}
      globalCompanyIcon={globalCompanyIcon}
      project={project}
      ogImage={ogImage}
      customCss={customCss}
      canonicalUrl={Astro.url.href}
      generator={Astro.generator}
      includeDynamicColorsAndFonts={!ONLY_FLOWBITE_AND_THEME}
    />

    {
      !ONLY_FLOWBITE_AND_THEME && (
        <>
          {/* 6. Global typewriter (runSimpleTypewriter - vanilla JS, no TypeScript so it runs in prod) */}
          <script is:inline src="/scripts/typewriter-inline.js" />
        </>
      )
    }

    <!-- Set global user data for client-side components -->

    {
      /* SPA disabled: persist CMS colors, ClientRouter, prevent swap on 404 - was causing malformed HTML / script errors */
    }
  </head>

  <body
    class:list={[
      layout === "authCallback"
        ? "flex min-h-dvh items-center justify-center antialiased"
        : "antialiased",
      bodyTouchClass,
    ]}
  >
    {
      /* authCallback: minimal chrome so OAuth callback gets DB theme/styles without nav/footer or heavy pipeline */
    }
    {
      layout === "authCallback" ? (
        <>
          <div
            class="flex w-full flex-col items-center justify-center gap-6 p-4"
            data-dynamic-height="true"
          >
            <slot />
          </div>
          {!ONLY_FLOWBITE_AND_THEME && <script is:inline src="/scripts/app-globals.js" />}
          <script is:inline src="/scripts/auth-google.js" />
        </>
      ) : (
        <>
          {/* SPA disabled: re-apply theme and astro:after-swap/astro:page-load scripts */}
          {/* SPA disabled: debug and runPageInits scripts */}

          <CMSPreloader showByDefault={true} {globalCompanyName} />

          <UnifiedNotification />

          <TutorialOverlay {currentUser} tutorialId="demo-tour" autoStart={false} {isAuth} />

          {/* <!-- <DebugPanel {debugData} {currentRole} /> --> */}

          {/* <FeedbackPanel {currentUser} /> */}

          <div class="flex h-dvh flex-col overflow-hidden md:min-h-0" data-template={layout}>
            <Navbar
              {globalIconButtonClasses}
              {desktopNavigationHTML}
              {currentUser}
              {session}
              {supabaseUrl}
              {id}
              {projects}
              assignedProjectsCount={assignedProjectsCount}
              assignedProjectsPreview={assignedProjectsPreview}
              {isBackend}
              {project}
              pathname={Astro.url.pathname}
              template={layout}
              {hideFooter}
            />

            <Aside {currentUser} {primaryTextClasses} {mobileNavigationHTML} />

            {/* <!-- Scrolling pane: flex-1 min-h-0 constrains height so this is the scroll container (not body). translateY on mobile for reveal effect. fullform: overscroll-none to prevent pullable rubber-band. --> */}
            <div
              id="reveal-scroll"
              class:list={[
                "relative z-50 min-h-0 flex-1 touch-pan-y overflow-y-auto bg-gray-100 scrollbar-hide dark:bg-gray-900",
                layout === "fullform"
                  ? "touch-none overscroll-none overscroll-y-contain"
                  : "overscroll-y-contain",
              ]}
            >
              <div
                id="main-content"
                class:list={[
                  // "color-background",
                  // "flex-1 min-w-0",
                  // currentUser ? "transition-duration-[350ms] ease-in-out" : "",

                  // (layout === "default"  || layout === "minimal" || !layout) &&
                  //   "",
                  mainClasses,
                ]}
                style={currentUser ? "transition-duration: 350ms;" : undefined}
              >
                <main>
                  <slot />
                  {!isAuthPageResult && layout !== "fullform" && <SubFooter {globalCompanyName} />}
                </main>
              </div>
            </div>

            <Footer
              {isAuthPageResult}
              {isContactPageResult}
              {currentUser}
              {isBackend}
              {globalIconButtonClasses}
              {globalCompanyName}
              {isBackend}
              {globalCompanyPhone}
              {primaryTextClasses}
              {secondaryTextClasses}
              {globalInputClasses}
              {customFooterHtml}
              {hideFooter}
            />

            <div id="action-buttons" class="hide-on-form-focus fixed bottom-8 right-4 z-100">
              {isAdmin ? (
                <AdminVoiceAssistantWidget {currentUser} {globalCompanyPhone} />
              ) : (
                !isAuthPageResult &&
                !isContactPageResult && (
                  <SpeedDial
                    {globalCompanyPhone}
                    currentUser={currentUser || undefined}
                    {isBackend}
                    {primaryTextClasses}
                    {secondaryTextClasses}
                    {globalInputClasses}
                    {globalCompanyName}
                  />
                )
              )}
            </div>
          </div>

          <CookieBanner />

          {/* Cache indicator: dev/test only (localhost or ?cacheIndicator=1) */}
          {isAdmin && <CacheIndicator />}

          {/* app-globals: pre-bundled to public/scripts/app-globals.js (avoids Astro chunk 404 + import-statement errors). is:inline prevents Vite from bundling public/ asset. */}
          {!ONLY_FLOWBITE_AND_THEME && <script is:inline src="/scripts/app-globals.js" />}
          {/* auth-google: pre-bundled (avoids Astro chunk 404 so Google OAuth works in prod). is:inline prevents Vite from bundling public/ asset. */}
          <script is:inline src="/scripts/auth-google.js" />
          {/* Flowbite: CDN may load slowly or fail (CSP/network). Fallback below retries and can load script dynamically. */}
          <script src="https://unpkg.com/flowbite@2.5.2/dist/flowbite.min.js" defer />
          <script is:inline>
            if (window.__jsOrderLog) window.__jsOrderLog("Flowbite script tag (inline after CDN)");
          </script>
          {/* Multi-step form fallback: load form init first (critical), then typewriter (animation) so Next button works immediately */}
          <script is:inline src="/scripts/multistep-form-fallback.js" />
          {/* Alert and banner dismiss: inline so close works when module scripts don't load */}
          <script is:inline src="/scripts/alert-banner-dismiss.js" />
          {/* Theme toggle: inline so it works when app-globals chunk fails to load (e.g. production SSR) */}
          <script is:inline src="/scripts/theme-toggle-inline.js" />

          {!ONLY_FLOWBITE_AND_THEME && (
            <script is:inline src="/scripts/app-page-scripts.js" data-script="hold-progress-init" />
          )}

          {/* Theme toggle: inline fallback above; app-globals.ts also binds (uses data-theme-toggle-inited to avoid double-init). Overscroll scale: app-globals.ts DOMContentLoaded */}

          {!ONLY_FLOWBITE_AND_THEME && (
            <script is:inline src="/scripts/app-domcontentloaded-init.js" />
          )}

          {/* Commented out: App image error handler + ERR_CONNECTION_CLOSED suppress (see git history) */}

          {!ONLY_FLOWBITE_AND_THEME && !isBackend && (
            <>
              {/* 14. AOS (Animate On Scroll) - skip on backend pages (admin, project, etc.) */}
              <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
              <script src="https://unpkg.com/aos@2.3.1/dist/aos.js" defer />
              <script is:inline src="/scripts/aos-init.js" />
            </>
          )}

          {/* 15-17. scroll-animations, lazy-load-images, project-item-handlers - in app-page-scripts.js above */}

          {/* <!-- Plausible Analytics Script --> */}
          {/* {plausibleTrackingScript && <Fragment set:html={plausibleTrackingScript} />} */}
        </>
      )
    }
  </body>
</html>
