---
/**
 * `ProfileTeamSection`
 *
 * Displays team members from profiles where teamMember === true.
 * Queries Supabase directly; no props required for members.
 *
 * @example
 * <ProfileTeamSection />
 * <ProfileTeamSection title="Our Team" description="Meet the crew" />
 */

import SimpleIcon from "../common/SimpleIcon.astro";
import { supabaseAdmin } from "../../lib/supabase-admin";

interface TeamMember {
  id: string;
  name: string;
  title?: string;
  bio?: string;
  avatarUrl?: string | null;
  email?: string;
}

interface Props {
  title?: string;
  description?: string;
  /** Override: pass members to bypass the internal query (for testing or custom data) */
  members?: TeamMember[] | null;
  emptyMessage?: string;
  emptyIcon?: string;
  className?: string;
  class?: string; // Allow class for Astro compatibility
}

const {
  title = "Team",
  description = "People in your organization",
  members: membersProp = null,
  emptyMessage = "No team members yet. Team management coming soon.",
  emptyIcon = "users",
  className = "",
  class: classProp = "",
} = Astro.props;
const sectionClass = classProp || className;

// Query team members (profiles where teamMember === true)
let members: TeamMember[] = [];
if (membersProp !== null && Array.isArray(membersProp)) {
  members = membersProp;
} else if (supabaseAdmin) {
  const { data } = await supabaseAdmin
    .from("profiles")
    .select("id, firstName, lastName, title, bio, avatarUrl")
    .eq("teamMember", true)
    .order("displayOrder", { ascending: true, nullsFirst: false })
    .order("lastName", { ascending: true });
  members = (data || []).map((p: any) => ({
    id: p.id,
    name: [p.firstName, p.lastName].filter(Boolean).join(" ") || "Unknown",
    title: p.title || undefined,
    bio: p.bio || undefined,
    avatarUrl: p.avatarUrl || null,
  }));
}

function getInitials(name: string): string {
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);
}
---

<section class:list={["profile-team-section py-8", sectionClass]}>
  <div
    class="rounded-lg border border-gray-200 bg-white p-6 dark:border-gray-700 dark:bg-gray-800/50"
  >
    {
      (title || description) && (
        <div class="mb-6">
          {title && <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{title}</h3>}
          {description && (
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{description}</p>
          )}
        </div>
      )
    }

    {
      members?.length > 0 ? (
        <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
          {members.map((member) => (
            <div
              class="flex items-center gap-4 rounded-lg border border-gray-100 bg-gray-50/50 p-4 dark:border-gray-700 dark:bg-gray-800/30"
              data-team-member-id={member.id}
            >
              <div class="dark:bg-primary-900/50 flex h-12 w-12 shrink-0 items-center justify-center overflow-hidden rounded-full bg-primary-100 font-semibold text-primary-600 dark:text-primary-400">
                {member.avatarUrl ? (
                  <img
                    src={member.avatarUrl}
                    alt={member.name}
                    class="h-12 w-12 rounded-full object-cover"
                  />
                ) : (
                  <span class="text-sm">{getInitials(member.name)}</span>
                )}
              </div>
              <div class="min-w-0 flex-1">
                <p class="truncate font-medium text-gray-900 dark:text-white">{member.name}</p>
                {member.title && (
                  <p class="truncate text-sm text-gray-500 dark:text-gray-400">{member.title}</p>
                )}
                {member.bio && (
                  <p class="mt-1 line-clamp-2 text-sm text-gray-600 dark:text-gray-400">
                    {member.bio}
                  </p>
                )}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div
          class="flex flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-200 py-12 text-center dark:border-gray-700"
          data-team-empty
        >
          <SimpleIcon name={emptyIcon} class="mx-auto h-12 w-12 text-gray-400 dark:text-gray-500" />
          <p class="mt-4 text-sm text-gray-500 dark:text-gray-400">{emptyMessage}</p>
          {/* <!-- Framework: add "Invite team member" or other actions here --> */}
          <div class="mt-4" data-team-actions />
        </div>
      )
    }
  </div>
</section>
