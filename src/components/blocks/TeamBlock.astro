---
/**
 * TeamBlock - Team Member Cards
 *
 * Display team members in a grid with photos and social links.
 *
 * @example With JSON:
 * <TeamBlock
 *   title="Our Team"
 *   members={[
 *     { name: "John Doe", role: "CEO", photo: "/images/john.jpg", bio: "..." },
 *   ]}
 * />
 */
import SimpleIcon from "../common/SimpleIcon.astro";
import { parseJsonProp, buildArrayFromFlatProps } from "./BlockRegistry";

interface TeamMember {
  name: string;
  role?: string;
  photo?: string;
  bio?: string;
  email?: string;
  phone?: string;
  linkedin?: string;
  twitter?: string;
}

interface Props {
  // Section content
  title?: string;
  description?: string;

  // Layout
  variant?: "grid" | "cards" | "compact" | "detailed";
  columns?: number | string;

  // Members as JSON
  members?: string | TeamMember[];

  // Flat props for up to 8 members
  member1Name?: string;
  member1Role?: string;
  member1Photo?: string;
  member1Bio?: string;
  member1Email?: string;
  member1Linkedin?: string;
  member2Name?: string;
  member2Role?: string;
  member2Photo?: string;
  member2Bio?: string;
  member2Email?: string;
  member2Linkedin?: string;
  member3Name?: string;
  member3Role?: string;
  member3Photo?: string;
  member3Bio?: string;
  member3Email?: string;
  member3Linkedin?: string;
  member4Name?: string;
  member4Role?: string;
  member4Photo?: string;
  member4Bio?: string;
  member4Email?: string;
  member4Linkedin?: string;
  member5Name?: string;
  member5Role?: string;
  member5Photo?: string;
  member5Bio?: string;
  member5Email?: string;
  member5Linkedin?: string;
  member6Name?: string;
  member6Role?: string;
  member6Photo?: string;
  member6Bio?: string;
  member6Email?: string;
  member6Linkedin?: string;
  member7Name?: string;
  member7Role?: string;
  member7Photo?: string;
  member7Bio?: string;
  member7Email?: string;
  member7Linkedin?: string;
  member8Name?: string;
  member8Role?: string;
  member8Photo?: string;
  member8Bio?: string;
  member8Email?: string;
  member8Linkedin?: string;

  // Styling
  className?: string;
  id?: string;
}

const props = Astro.props;
const { title, description, variant = "grid", className = "", id } = props;

const columns = typeof props.columns === "string" ? parseInt(props.columns) : (props.columns ?? 4);

// Build members array
let memberItems: TeamMember[] = [];

if (props.members) {
  memberItems = parseJsonProp<TeamMember[]>(props.members, []);
} else {
  memberItems = buildArrayFromFlatProps<TeamMember>(
    props,
    "member",
    ["name", "role", "photo", "bio", "email", "phone", "linkedin", "twitter"],
    8
  );
}

// Column classes
const columnClasses: Record<number, string> = {
  2: "grid-cols-1 sm:grid-cols-2",
  3: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",
  4: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-4",
};

const gridClass = columnClasses[columns] || columnClasses[4];

// Get initials from name
const getInitials = (name: string): string => {
  return name
    .split(" ")
    .map((n) => n[0])
    .join("")
    .toUpperCase()
    .slice(0, 2);
};
---

<section {id} class:list={["team-block py-16 md:py-24", className]}>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    {
      (title || description) && (
        <div class="mb-12 text-center">
          {title && (
            <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">
              {title}
            </h2>
          )}
          {description && (
            <p class="mx-auto mt-4 max-w-3xl text-lg text-gray-600 dark:text-gray-300">
              {description}
            </p>
          )}
        </div>
      )
    }

    <div class={`grid gap-8 ${gridClass}`}>
      {
        memberItems.map((member) => (
          <div
            class:list={[
              "team-member group",
              variant === "cards" &&
                "rounded-xl border border-gray-100 bg-white p-6 text-center shadow-sm dark:border-gray-700 dark:bg-gray-900",
              variant === "grid" && "text-center",
              variant === "compact" && "flex items-center gap-4",
              variant === "detailed" && "rounded-xl bg-white p-6 shadow-sm dark:bg-gray-900",
            ]}
          >
            {/* Photo */}
            <div class={variant === "compact" ? "shrink-0" : "mb-4"}>
              {member.photo ? (
                <img
                  data-src={member.photo}
                  alt={member.name}
                  width="160"
                  height="160"
                  class:list={[
                    "lazyload object-cover blur-sm",
                    variant === "compact" && "h-16 w-16 rounded-full",
                    variant === "cards" && "mx-auto h-32 w-32 rounded-full",
                    variant === "grid" && "mx-auto h-40 w-40 rounded-full",
                    variant === "detailed" && "h-24 w-24 rounded-full",
                  ]}
                />
              ) : (
                <div
                  class:list={[
                    "dark:bg-primary-900/30 flex items-center justify-center bg-primary-100 font-bold text-primary-600 dark:text-primary-400",
                    variant === "compact" && "h-16 w-16 rounded-full text-lg",
                    variant === "cards" && "mx-auto h-32 w-32 rounded-full text-2xl",
                    variant === "grid" && "mx-auto h-40 w-40 rounded-full text-3xl",
                    variant === "detailed" && "h-24 w-24 rounded-full text-xl",
                  ]}
                >
                  {getInitials(member.name)}
                </div>
              )}
            </div>

            {/* Info */}
            <div class={variant === "compact" ? "" : ""}>
              <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{member.name}</h3>
              {member.role && (
                <p class="font-medium text-primary-600 dark:text-primary-400">{member.role}</p>
              )}
              {member.bio && (variant === "detailed" || variant === "cards") && (
                <p class="mt-2 line-clamp-3 text-sm text-gray-600 dark:text-gray-300">
                  {member.bio}
                </p>
              )}

              {/* Social links */}
              {(member.email || member.linkedin || member.twitter) && (
                <div class={`mt-4 flex gap-3 ${variant === "compact" ? "" : "justify-center"}`}>
                  {member.email && (
                    <a
                      href={`mailto:${member.email}`}
                      class="text-gray-400 transition-colors hover:text-primary-600 dark:hover:text-primary-400"
                      aria-label={`Email ${member.name}`}
                    >
                      <SimpleIcon name="envelope" class="h-5 w-5" />
                    </a>
                  )}
                  {member.linkedin && (
                    <a
                      href={member.linkedin}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 transition-colors hover:text-primary-600 dark:hover:text-primary-400"
                      aria-label={`${member.name}'s LinkedIn`}
                    >
                      <SimpleIcon name="linkedin" class="h-5 w-5" />
                    </a>
                  )}
                  {member.twitter && (
                    <a
                      href={member.twitter}
                      target="_blank"
                      rel="noopener noreferrer"
                      class="text-gray-400 transition-colors hover:text-primary-600 dark:hover:text-primary-400"
                      aria-label={`${member.name}'s Twitter`}
                    >
                      <SimpleIcon name="twitter" class="h-5 w-5" />
                    </a>
                  )}
                  {member.phone && (
                    <a
                      href={`tel:${member.phone}`}
                      class="text-gray-400 transition-colors hover:text-primary-600 dark:hover:text-primary-400"
                      aria-label={`Call ${member.name}`}
                    >
                      <SimpleIcon name="phone" class="h-5 w-5" />
                    </a>
                  )}
                </div>
              )}
            </div>
          </div>
        ))
      }
    </div>
  </div>
</section>
