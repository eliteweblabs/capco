---
/**
 * GalleryBlock - Image Gallery
 *
 * Display images in a grid, masonry, or carousel layout.
 * Supports lightbox functionality.
 *
 * @example:
 * <GalleryBlock
 *   title="Our Work"
 *   images={[
 *     { src: "/images/project1.jpg", alt: "Project 1", caption: "Downtown Office" },
 *   ]}
 * />
 */
import { parseJsonProp, buildArrayFromFlatProps } from "./BlockRegistry";
import CloseButton from "../ui/CloseButton.astro";

interface GalleryImage {
  src: string;
  alt: string;
  caption?: string;
  category?: string;
}

interface Props {
  // Section content
  title?: string;
  description?: string;

  // Layout
  variant?: "grid" | "masonry" | "carousel" | "featured";
  columns?: number | string;
  gap?: "none" | "small" | "medium" | "large";

  // Features
  lightbox?: boolean | string;
  showCaptions?: boolean | string;
  aspectRatio?: "square" | "video" | "portrait" | "auto";

  // Images as JSON
  images?: string | GalleryImage[];

  // Flat props for up to 12 images
  image1Src?: string;
  image1Alt?: string;
  image1Caption?: string;
  image2Src?: string;
  image2Alt?: string;
  image2Caption?: string;
  image3Src?: string;
  image3Alt?: string;
  image3Caption?: string;
  image4Src?: string;
  image4Alt?: string;
  image4Caption?: string;
  image5Src?: string;
  image5Alt?: string;
  image5Caption?: string;
  image6Src?: string;
  image6Alt?: string;
  image6Caption?: string;
  image7Src?: string;
  image7Alt?: string;
  image7Caption?: string;
  image8Src?: string;
  image8Alt?: string;
  image8Caption?: string;
  image9Src?: string;
  image9Alt?: string;
  image9Caption?: string;
  image10Src?: string;
  image10Alt?: string;
  image10Caption?: string;
  image11Src?: string;
  image11Alt?: string;
  image11Caption?: string;
  image12Src?: string;
  image12Alt?: string;
  image12Caption?: string;

  // Styling
  className?: string;
  id?: string;

  // Animation
  animate?:
    | boolean
    | string
    | "fade-blur-scale"
    | "fade-blur"
    | "fade-scale"
    | "fade-up"
    | "fade-up-blur"
    | "zoom-blur"
    | "fade";
  animateDelay?: string;
  animateStagger?: boolean | string;
}

const props = Astro.props;
const {
  title,
  description,
  variant = "grid",
  gap = "medium",
  aspectRatio = "square",
  className = "",
  id,
} = props;

const columns = typeof props.columns === "string" ? parseInt(props.columns) : (props.columns ?? 3);
const lightbox = props.lightbox === "false" ? false : (props.lightbox ?? true);
const showCaptions = props.showCaptions === "false" ? false : (props.showCaptions ?? true);

// Handle animation prop - enabled by default with stagger for grids
const getAnimationType = () => {
  if (props.animate === "false" || props.animate === false) return null;
  if (props.animate === "true" || props.animate === true) return "fade-blur";
  if (typeof props.animate === "string") return props.animate;
  return "fade-blur"; // Default animation for gallery
};
const animationType = getAnimationType();
const animateDelay = props.animateDelay;
// Enable stagger by default for grids, unless explicitly disabled
const animateStagger = props.animateStagger !== "false" && props.animateStagger !== false;

// Build images array
let imageItems: GalleryImage[] = [];

if (props.images) {
  imageItems = parseJsonProp<GalleryImage[]>(props.images, []);
} else {
  imageItems = buildArrayFromFlatProps<GalleryImage>(
    props,
    "image",
    ["src", "alt", "caption", "category"],
    12
  );
}

// Column classes
const columnClasses: Record<number, string> = {
  2: "grid-cols-1 sm:grid-cols-2",
  3: "grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",
  4: "grid-cols-2 lg:grid-cols-4",
  5: "grid-cols-2 lg:grid-cols-5",
};

const gridClass = columnClasses[columns] || columnClasses[3];

// Gap classes
const gapClasses = {
  none: "gap-0",
  small: "gap-2",
  medium: "gap-4",
  large: "gap-8",
};

// Aspect ratio classes
const aspectClasses = {
  square: "aspect-square",
  video: "aspect-video",
  portrait: "aspect-[3/4]",
  auto: "",
};

// Gallery ID for lightbox
const galleryId = id || `gallery-${Math.random().toString(36).slice(2, 9)}`;
---

<section
  {id}
  class:list={["gallery-block py-16 md:py-24", className]}
  data-animate={animationType || undefined}
  data-animate-delay={animateDelay || undefined}
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    {
      (title || description) && (
        <div class="mb-12 text-center">
          {title && (
            <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">
              {title}
            </h2>
          )}
          {description && (
            <p class="mt-4 text-lg text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
              {description}
            </p>
          )}
        </div>
      )
    }

    {
      variant === "featured" && imageItems.length > 0 ? (
        <div class="grid gap-4 lg:grid-cols-3">
          {/* Featured large image */}
          <div class="lg:col-span-2 lg:row-span-2">
            <button
              type="button"
              class="group relative block w-full overflow-hidden rounded-xl"
              data-gallery={galleryId}
              data-index="0"
            >
              <img
                data-src={imageItems[0].src}
                alt={imageItems[0].alt}
                width="800"
                height="600"
                class="lazyload blur-sm w-full h-full object-cover aspect-[4/3] lg:aspect-auto lg:h-full transition-transform duration-300 group-hover:scale-105"
              />
              {showCaptions && imageItems[0].caption && (
                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                  <p class="text-white font-medium">{imageItems[0].caption}</p>
                </div>
              )}
            </button>
          </div>

          {/* Smaller images */}
          {imageItems.slice(1, 5).map((image, index) => (
            <button
              type="button"
              class="group relative block overflow-hidden rounded-xl"
              data-gallery={galleryId}
              data-index={index + 1}
            >
              <img
                data-src={image.src}
                alt={image.alt}
                width="400"
                height="300"
                class="lazyload blur-sm w-full h-full object-cover aspect-video transition-transform duration-300 group-hover:scale-105"
              />
              {showCaptions && image.caption && (
                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                  <p class="text-white text-sm">{image.caption}</p>
                </div>
              )}
              {index === 3 && imageItems.length > 5 && (
                <div class="absolute inset-0 flex items-center justify-center bg-black/50">
                  <span class="text-white text-2xl font-bold">+{imageItems.length - 5}</span>
                </div>
              )}
            </button>
          ))}
        </div>
      ) : variant === "masonry" ? (
        <div class={`columns-1 sm:columns-2 lg:columns-${columns} ${gapClasses[gap]}`}>
          {imageItems.map((image, index) => (
            <button
              type="button"
              class="group relative block w-full overflow-hidden rounded-xl mb-4 break-inside-avoid"
              data-gallery={galleryId}
              data-index={index}
            >
              <img
                data-src={image.src}
                alt={image.alt}
                width="400"
                height="600"
                class="lazyload blur-sm w-full object-cover transition-transform duration-300 group-hover:scale-105"
              />
              {showCaptions && image.caption && (
                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                  <p class="text-white text-sm">{image.caption}</p>
                </div>
              )}
            </button>
          ))}
        </div>
      ) : variant === "carousel" ? (
        <div class="relative overflow-hidden">
          <div class="flex gap-4 overflow-x-auto snap-x snap-mandatory pb-4 scrollbar-hide">
            {imageItems.map((image, index) => (
              <button
                type="button"
                class="group relative flex-shrink-0 snap-center overflow-hidden rounded-xl"
                data-gallery={galleryId}
                data-index={index}
              >
                <img
                  data-src={image.src}
                  alt={image.alt}
                  width="320"
                  height="240"
                  class={`lazyload blur-sm w-80 h-60 object-cover transition-transform duration-300 group-hover:scale-105`}
                />
                {showCaptions && image.caption && (
                  <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3">
                    <p class="text-white text-sm">{image.caption}</p>
                  </div>
                )}
              </button>
            ))}
          </div>
        </div>
      ) : (
        <div
          class={`grid ${gridClass} ${gapClasses[gap]}`}
          data-animate-stagger={animateStagger || undefined}
        >
          {imageItems.map((image, index) => (
            <button
              type="button"
              class="group relative block overflow-hidden rounded-xl"
              data-gallery={galleryId}
              data-index={index}
            >
              <img
                data-src={image.src}
                alt={image.alt}
                width="600"
                height="400"
                class={`lazyload blur-sm w-full object-cover ${aspectClasses[aspectRatio]} transition-transform duration-300 group-hover:scale-105`}
              />
              {showCaptions && image.caption && (
                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent p-3 opacity-0 group-hover:opacity-100 transition-opacity">
                  <p class="text-white text-sm">{image.caption}</p>
                </div>
              )}
            </button>
          ))}
        </div>
      )
    }
  </div>
</section>

{/* Lightbox Modal */}
{
  lightbox && (
    <div
      id={`${galleryId}-lightbox`}
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/90 p-4"
      data-lightbox-modal
    >
      <div class="absolute top-4 right-4 z-10">
        <CloseButton
          tooltipText="Close lightbox"
          position="bottom"
          class="!text-white hover:!bg-white/10 hover:!text-gray-300"
          data-lightbox-close
        />
      </div>

      <button
        type="button"
        class="absolute left-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300"
        data-lightbox-prev
      >
        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"
          />
        </svg>
      </button>

      <button
        type="button"
        class="absolute right-4 top-1/2 -translate-y-1/2 text-white hover:text-gray-300"
        data-lightbox-next
      >
        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>

      <img src="" alt="" class="max-h-[90vh] max-w-[90vw] object-contain" data-lightbox-image />

      <p
        class="absolute bottom-4 left-1/2 -translate-x-1/2 text-white text-center"
        data-lightbox-caption
      />
    </div>
  )
}

<script define:vars={{ galleryId, imageItems, lightbox }}>
  if (lightbox) {
    document.addEventListener("DOMContentLoaded", () => {
      const modal = document.getElementById(`${galleryId}-lightbox`);
      const image = modal?.querySelector("[data-lightbox-image]");
      const caption = modal?.querySelector("[data-lightbox-caption]");
      const buttons = document.querySelectorAll(`[data-gallery="${galleryId}"]`);
      let currentIndex = 0;

      const showImage = (index) => {
        if (index < 0) index = imageItems.length - 1;
        if (index >= imageItems.length) index = 0;
        currentIndex = index;

        const item = imageItems[index];
        if (image) {
          image.src = item.src;
          image.alt = item.alt;
        }
        if (caption) {
          caption.textContent = item.caption || "";
        }
      };

      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const index = parseInt(btn.dataset.index || "0");
          showImage(index);
          modal?.classList.remove("hidden");
          modal?.classList.add("flex");
          document.body.style.overflow = "hidden";
        });
      });

      modal?.querySelector("[data-lightbox-close]")?.addEventListener("click", () => {
        modal?.classList.add("hidden");
        modal?.classList.remove("flex");
        document.body.style.overflow = "";
      });

      modal?.querySelector("[data-lightbox-prev]")?.addEventListener("click", () => {
        showImage(currentIndex - 1);
      });

      modal?.querySelector("[data-lightbox-next]")?.addEventListener("click", () => {
        showImage(currentIndex + 1);
      });

      modal?.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal?.classList.add("hidden");
          modal?.classList.remove("flex");
          document.body.style.overflow = "";
        }
      });

      document.addEventListener("keydown", (e) => {
        if (!modal?.classList.contains("hidden")) {
          if (e.key === "Escape") {
            modal?.classList.add("hidden");
            modal?.classList.remove("flex");
            document.body.style.overflow = "";
          } else if (e.key === "ArrowLeft") {
            showImage(currentIndex - 1);
          } else if (e.key === "ArrowRight") {
            showImage(currentIndex + 1);
          }
        }
      });
    });
  }
</script>
