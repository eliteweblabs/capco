---
/**
 * LogoCloudBlock - Partner/Client Logos
 * 
 * Display partner, client, or technology logos.
 * Supports static grid or animated marquee (use marqueeDirection="left"|"right" for direction).
 * Now supports Font Awesome icons as well as images.
 * 
 * @example with images:
 * <LogoCloudBlock 
 *   title="Trusted By"
 *   logos={[
 *     { src: "/logos/company1.png", alt: "Company 1", href: "https://..." },
 *   ]}
 * />
 * 
 * @example with Font Awesome icons:
 * <LogoCloudBlock 
 *   title="Industries We Serve"
 *   logo1Icon="fa-solid fa-leaf"
 *   logo1Alt="Environmental"
 *   logo1IconColor="text-green-600"
 *   logo2Icon="fa-solid fa-hospital"
 *   logo2Alt="Healthcare"
 *   logo2IconColor="text-blue-600"
 * />
 */
import { parseJsonProp, buildArrayFromFlatProps } from "./BlockRegistry";

interface Logo {
  src?: string;
  alt: string;
  href?: string;
  width?: number;
  icon?: string; // Font Awesome icon class (e.g., "fa-solid fa-leaf")
  iconColor?: string; // Tailwind color class (e.g., "text-green-600")
}

interface Props {
  // Section content
  title?: string;
  description?: string;
  
  // Layout
  variant?: 'simple' | 'grid' | 'marquee' | 'centered';
  columns?: number | string;
  /** Marquee animation direction. Only applies when variant="marquee". Default: left */
  marqueeDirection?: 'left' | 'right';
  grayscale?: boolean | string;
  
  // Logos as JSON
  logos?: string | Logo[];
  
  // Flat props for up to 12 logos
  logo1Src?: string;
  logo1Alt?: string;
  logo1Href?: string;
  logo1Icon?: string;
  logo1IconColor?: string;
  logo2Src?: string;
  logo2Alt?: string;
  logo2Href?: string;
  logo2Icon?: string;
  logo2IconColor?: string;
  logo3Src?: string;
  logo3Alt?: string;
  logo3Href?: string;
  logo3Icon?: string;
  logo3IconColor?: string;
  logo4Src?: string;
  logo4Alt?: string;
  logo4Href?: string;
  logo4Icon?: string;
  logo4IconColor?: string;
  logo5Src?: string;
  logo5Alt?: string;
  logo5Href?: string;
  logo5Icon?: string;
  logo5IconColor?: string;
  logo6Src?: string;
  logo6Alt?: string;
  logo6Href?: string;
  logo6Icon?: string;
  logo6IconColor?: string;
  logo7Src?: string;
  logo7Alt?: string;
  logo7Href?: string;
  logo7Icon?: string;
  logo7IconColor?: string;
  logo8Src?: string;
  logo8Alt?: string;
  logo8Href?: string;
  logo8Icon?: string;
  logo8IconColor?: string;
  logo9Src?: string;
  logo9Alt?: string;
  logo9Href?: string;
  logo9Icon?: string;
  logo9IconColor?: string;
  logo10Src?: string;
  logo10Alt?: string;
  logo10Href?: string;
  logo10Icon?: string;
  logo10IconColor?: string;
  logo11Src?: string;
  logo11Alt?: string;
  logo11Href?: string;
  logo11Icon?: string;
  logo11IconColor?: string;
  logo12Src?: string;
  logo12Alt?: string;
  logo12Href?: string;
  logo12Icon?: string;
  logo12IconColor?: string;
  
  // Styling
  className?: string;
  /** Extra classes on the section (e.g. "flex sm:hidden pt-0") */
  wrapperClass?: string;
  id?: string;
  
  // Animation (note: stagger disabled for LogoCloudBlock to preserve grayscale filters)
  animate?: boolean | string | 'fade-blur-scale' | 'fade-blur' | 'fade-scale' | 'fade-up' | 'fade-up-blur' | 'zoom-blur' | 'fade';
  animateDelay?: string;
}

const props = Astro.props;
const {
  title,
  description,
  variant = 'simple',
  className = '',
  wrapperClass,
  id,
  marqueeDirection = 'left',
} = props;

const columns = typeof props.columns === 'string' ? parseInt(props.columns) : (props.columns ?? 6);
const grayscale = props.grayscale === 'false' ? false : (props.grayscale ?? true);

// Handle animation prop - enabled by default
const getAnimationType = () => {
  if (props.animate === 'false' || props.animate === false) return null;
  if (props.animate === 'true' || props.animate === true) return 'fade-blur';
  if (typeof props.animate === 'string') return props.animate;
  return 'fade-blur'; // Default animation
};
const animationType = getAnimationType();
const animateDelay = props.animateDelay;

// Build logos array
let logoItems: Logo[] = [];

if (props.logos) {
  logoItems = parseJsonProp<Logo[]>(props.logos, []);
} else {
  logoItems = buildArrayFromFlatProps<Logo>(
    props,
    'logo',
    ['src', 'alt', 'href', 'width', 'icon', 'iconColor'],
    12
  );
}

// Column classes
const columnClasses: Record<number, string> = {
  3: 'grid-cols-2 sm:grid-cols-3',
  4: 'grid-cols-2 sm:grid-cols-4',
  5: 'grid-cols-2 sm:grid-cols-5',
  6: 'grid-cols-2 sm:grid-cols-3 lg:grid-cols-6',
};

const gridClass = columnClasses[columns] || columnClasses[6];
---

<section 
  id={id} 
  class:list={['logo-cloud-block skip py-12 md:py-16 overflow-x-hidden', className, wrapperClass]}
  data-animate={animationType || undefined}
  data-animate-delay={animateDelay || undefined}
>
  <div class="">
    {(title || description) && (
      <div class="w-full mb-10 text-center px-4 sm:px-6 lg:px-8">
        {title && (
          <h2 class="text-lg font-semibold text-gray-600 dark:text-gray-400 uppercase tracking-wider">
            {title}
          </h2>
        )}
        {description && (
          <p class="mt-2 text-gray-500 dark:text-gray-400">
            {description}
          </p>
        )}
      </div>
    )}
    
    {(variant === 'marquee' || variant === 'simple') ? (
      <div class="logo-cloud-marquee relative w-full min-w-0 overflow-hidden" style="--marquee-gap: 3rem;">
        {/* Fade edges */}
        {/* <div class="absolute left-0 top-0 bottom-0 w-20 bg-gradient-to-r from-white dark:from-gray-900 to-transparent z-10 pointer-events-none" /> */}
        {/* <div class="absolute right-0 top-0 bottom-0 w-20 bg-gradient-to-l from-white dark:from-gray-900 to-transparent z-10 pointer-events-none" /> */}
        
        <div class:list={['flex flex-nowrap animate-marquee gap-[var(--marquee-gap)]', marqueeDirection === 'right' && 'animate-marquee--right']}>
          {[...logoItems, ...logoItems, ...logoItems].map((logo) => (
            logo.href ? (
              <a 
                href={logo.href}
                target="_blank"
                rel="noopener noreferrer"
                class="flex-shrink-0"
              >
                {logo.icon ? (
                  <i 
                    class:list={[
                      logo.icon,
                      'text-4xl',
                      logo.iconColor || 'text-gray-600 dark:text-gray-400',
                      grayscale && 'grayscale opacity-60 hover:grayscale-0 hover:opacity-100 transition-all',
                    ]}
                    title={logo.alt}
                  />
                ) : (
                  <img 
                    src={logo.src} 
                    alt={logo.alt}
                    width={logo.width || 160}
                    height="40"
                    class:list={[
                      'h-10 w-auto object-contain flex-shrink-0 mix-blend-multiply dark:invert dark:mix-blend-normal',
                      grayscale && 'grayscale opacity-60 hover:grayscale-0 hover:opacity-100 transition-all',
                    ]}
                  />
                )}
              </a>
            ) : logo.icon ? (
              <i 
                class:list={[
                  logo.icon,
                  'text-4xl flex-shrink-0',
                  logo.iconColor || 'text-gray-600 dark:text-gray-400',
                  grayscale && 'grayscale opacity-60',
                ]}
                title={logo.alt}
              />
            ) : (
              <img 
                src={logo.src} 
                alt={logo.alt}
                width={logo.width || 160}
                height="40"
                class:list={[
                  'h-10 w-auto object-contain flex-shrink-0 mix-blend-multiply dark:invert dark:mix-blend-normal',
                  grayscale && 'grayscale opacity-60 hover:grayscale-0 hover:opacity-100 transition-all',
                ]}
              />
            )
          ))}
        </div>
      </div>
    ) : variant === 'centered' ? (
      <div class="flex flex-nowrap items-center justify-start gap-x-12 gap-y-8 overflow-x-auto scrollbar-hide">
        {logoItems.map((logo) => (
          logo.href ? (
            <a 
              href={logo.href}
              target="_blank"
              rel="noopener noreferrer"
              class="group"
            >
              {logo.icon ? (
                <i 
                  class:list={[
                    logo.icon,
                    'text-4xl',
                    logo.iconColor || 'text-gray-600 dark:text-gray-400',
                    grayscale && 'grayscale opacity-60 group-hover:grayscale-0 group-hover:opacity-100 transition-all',
                  ]}
                  title={logo.alt}
                />
              ) : (
                <img 
                  src={logo.src} 
                  alt={logo.alt}
                  class:list={[
                    'h-10 w-auto object-contain mix-blend-multiply dark:invert dark:mix-blend-normal',
                    grayscale && 'grayscale opacity-60 group-hover:grayscale-0 group-hover:opacity-100 transition-all',
                  ]}
                  width={logo.width || 160}
                />
              )}
            </a>
          ) : logo.icon ? (
            <i 
              class:list={[
                logo.icon,
                'text-4xl',
                logo.iconColor || 'text-gray-600 dark:text-gray-400',
                grayscale && 'grayscale opacity-60',
              ]}
              title={logo.alt}
            />
          ) : (
            <img 
              src={logo.src} 
              alt={logo.alt}
              class:list={[
                'h-10 w-auto object-contain mix-blend-multiply dark:invert dark:mix-blend-normal',
                grayscale && 'grayscale opacity-60',
              ]}
              width={logo.width || 160}
            />
          )
        ))}
      </div>
    ) : (
      <div class="flex flex-nowrap items-center justify-start gap-x-12 gap-y-8 overflow-x-auto scrollbar-hide">
        {logoItems.map((logo) => (
          logo.href ? (
            <a 
              href={logo.href}
              target="_blank"
              rel="noopener noreferrer"
              class="group"
            >
              {logo.icon ? (
                <i 
                  class:list={[
                    logo.icon,
                    'text-4xl',
                    logo.iconColor || 'text-gray-600 dark:text-gray-400',
                    grayscale && 'grayscale opacity-60 group-hover:grayscale-0 group-hover:opacity-100 transition-all',
                  ]}
                  title={logo.alt}
                />
              ) : (
                <img 
                  src={logo.src} 
                  alt={logo.alt}
                  class:list={[
                    'h-10 w-auto object-contain mix-blend-multiply dark:invert dark:mix-blend-normal',
                    grayscale && 'grayscale opacity-60 group-hover:grayscale-0 group-hover:opacity-100 transition-all',
                  ]}
                  width={logo.width || 160}
                />
              )}
            </a>
          ) : logo.icon ? (
            <i 
              class:list={[
                logo.icon,
                'text-4xl',
                logo.iconColor || 'text-gray-600 dark:text-gray-400',
                grayscale && 'grayscale opacity-60',
              ]}
              title={logo.alt}
            />
          ) : (
            <img 
              src={logo.src} 
              alt={logo.alt}
              class:list={[
                'h-10 w-auto object-contain mix-blend-multiply dark:invert dark:mix-blend-normal',
                grayscale && 'grayscale opacity-60',
              ]}
              width={logo.width || 160}
            />
          )
        ))}
      </div>
    )}
  </div>
</section>

{(variant === 'marquee' || variant === 'simple') && (
  <>
    <style is:global>
      .logo-cloud-block .animate-marquee {
        will-change: transform;
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
    </style>
    <script>
      (function initLogoCloudMarquee() {
        if (typeof document === "undefined") return;
        const run = () => {
          if (window.matchMedia("(prefers-reduced-motion: reduce)").matches) return;

          const containers = document.querySelectorAll(".logo-cloud-block .logo-cloud-marquee");
        const duration = 10000; // 10s per full cycle

        containers.forEach((container) => {
          const track = container.querySelector(".animate-marquee") as HTMLElement;
          if (!track) return;

          const isRight = track.classList.contains("animate-marquee--right");
          let startTime: number | null = null;
          let rafId: number;

          const animate = (time: number) => {
            if (startTime === null) startTime = time;
            const elapsed = (time - startTime) % duration;
            const t = elapsed / duration;
            // t 0→1; left: offset 0→W/3; right: offset W/3→0 (seamless loop, 3 copies)
            const trackWidth = track.scrollWidth;
            const offset = isRight ? ((1 - t) * trackWidth) / 3 : (t * trackWidth) / 3;
            track.style.transform = `translate3d(${-offset}px, 0, 0)`;
            rafId = requestAnimationFrame(animate);
          };

          rafId = requestAnimationFrame(animate);

          const pause = () => cancelAnimationFrame(rafId);
          const resume = () => {
            startTime = null;
            rafId = requestAnimationFrame(animate);
          };
          container.addEventListener("mouseenter", pause);
          container.addEventListener("mouseleave", resume);
        });
        };
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", run);
        } else {
          run();
        }
      })();
    </script>
  </>
)}
