---
/**
 * GoogleReviewsBlock - Google Reviews Widget
 *
 * Display Google-style review cards. Supports static reviews (from CMS/props)
 * or optional live fetching via Google Place ID (requires GOOGLE_MAPS_API_KEY env).
 *
 * @example Static reviews (CMS-friendly):
 * <GoogleReviewsBlock
 *   title="What Our Clients Say"
 *   businessName="Rothco Built"
 *   businessUrl="https://g.page/..."
 *   averageRating="4.9"
 *   totalReviews="127"
 *   reviews={[
 *     { text: "Excellent service!", author: "John D.", rating: 5, date: "2 weeks ago" },
 *   ]}
 * />
 */
import SimpleIcon from "../common/SimpleIcon.astro";
import { parseJsonProp, buildArrayFromFlatProps } from "./BlockRegistry";

interface Review {
  text: string;
  author: string;
  rating?: number;
  date?: string;
  avatar?: string;
}

interface Props {
  // Section content
  title?: string;
  description?: string;

  // Business info
  businessName?: string;
  /** Google Maps or Business Profile URL - used for "View on Google" link */
  businessUrl?: string;
  /** Aggregate rating (e.g. "4.9") - shown in header badge */
  averageRating?: string;
  /** Total review count - shown in header badge */
  totalReviews?: string;

  // Layout
  variant?: "grid" | "carousel" | "minimal";
  columns?: number | string;

  // Reviews as JSON or flat props
  reviews?: string | Review[];

  // Flat props for up to 6 reviews
  review1Text?: string;
  review1Author?: string;
  review1Rating?: string;
  review1Date?: string;
  review1Avatar?: string;
  review2Text?: string;
  review2Author?: string;
  review2Rating?: string;
  review2Date?: string;
  review2Avatar?: string;
  review3Text?: string;
  review3Author?: string;
  review3Rating?: string;
  review3Date?: string;
  review3Avatar?: string;
  review4Text?: string;
  review4Author?: string;
  review4Rating?: string;
  review4Date?: string;
  review4Avatar?: string;
  review5Text?: string;
  review5Author?: string;
  review5Rating?: string;
  review5Date?: string;
  review5Avatar?: string;
  review6Text?: string;
  review6Author?: string;
  review6Rating?: string;
  review6Date?: string;
  review6Avatar?: string;

  // Optional: Fetch live from Google (placeId + GOOGLE_MAPS_API_KEY env)
  placeId?: string;

  // Styling
  className?: string;
  id?: string;

  // Animation
  animate?: boolean | string;
  animateDelay?: string;
  animateStagger?: boolean | string;
}

const props = Astro.props;
const {
  title,
  description,
  businessName,
  businessUrl,
  averageRating,
  totalReviews,
  variant = "grid",
  className = "",
  id,
  placeId,
} = props;

const columns = typeof props.columns === "string" ? parseInt(props.columns) : (props.columns ?? 3);

// Handle animation
const getAnimationType = () => {
  if (props.animate === "false" || props.animate === false) return null;
  if (props.animate === "true" || props.animate === true) return "fade-blur-scale";
  if (typeof props.animate === "string") return props.animate;
  return "fade-blur-scale";
};
const animationType = getAnimationType();
const animateDelay = props.animateDelay;
const animateStagger = props.animateStagger !== "false" && props.animateStagger !== false;

// Build reviews array
let reviewItems: Review[] = [];

if (props.reviews) {
  reviewItems = parseJsonProp<Review[]>(props.reviews, []);
} else {
  reviewItems = buildArrayFromFlatProps<Review>(
    props,
    "review",
    ["text", "author", "rating", "date", "avatar"],
    6
  );
}

// Parse ratings to numbers
reviewItems = reviewItems.map((r) => ({
  ...r,
  rating: typeof r.rating === "string" ? parseInt(r.rating) : r.rating,
}));

const columnClasses: Record<number, string> = {
  1: "grid-cols-1",
  2: "grid-cols-1 md:grid-cols-2",
  3: "grid-cols-1 md:grid-cols-2 lg:grid-cols-3",
};

const gridClass = columnClasses[columns] || columnClasses[3];

const renderStars = (rating: number | undefined) => {
  if (!rating) return null;
  const stars = [];
  for (let i = 1; i <= 5; i++) {
    stars.push({ filled: i <= rating });
  }
  return stars;
};
---

<section
  {id}
  class:list={["google-reviews-block py-16 md:py-24", className]}
  data-animate={animationType || undefined}
  data-animate-delay={animateDelay || undefined}
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    {(title || description || businessName || averageRating) && (
      <div class="mb-12 text-center">
        {title && (
          <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">
            {title}
          </h2>
        )}
        {description && (
          <p class="mt-4 text-lg text-gray-600 dark:text-gray-300">{description}</p>
        )}

        {/* Google badge + aggregate rating */}
        {(businessName || averageRating || businessUrl) && (
          <div class="mt-6 flex flex-wrap items-center justify-center gap-4">
            <a
              href={businessUrl || "#"}
              target={businessUrl ? "_blank" : undefined}
              rel={businessUrl ? "noopener noreferrer" : undefined}
              class:list={[
                "inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-4 py-2 shadow-sm transition hover:border-gray-300 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-gray-600",
                !businessUrl && "pointer-events-none",
              ]}
            >
              <SimpleIcon name="google" class="h-5 w-5" />
              <span class="font-medium text-gray-700 dark:text-gray-300">
                {businessName || "Google Reviews"}
              </span>
              {averageRating && (
                <span class="flex items-center gap-1 text-amber-600 dark:text-amber-400">
                  <SimpleIcon name="star" class="h-4 w-4 fill-current" />
                  <span class="font-semibold">{averageRating}</span>
                </span>
              )}
              {totalReviews && (
                <span class="text-sm text-gray-500 dark:text-gray-400">
                  ({totalReviews} reviews)
                </span>
              )}
            </a>
          </div>
        )}
      </div>
    )}

    {reviewItems.length > 0 ? (
      variant === "carousel" ? (
        <div class="relative">
          <div
            class="flex gap-6 overflow-x-auto scrollbar-hide pb-4 snap-x snap-mandatory"
            data-google-reviews-carousel
          >
            {reviewItems.map((review) => (
              <article
                class="min-w-[320px] max-w-[400px] flex-shrink-0 snap-center rounded-xl border border-gray-100 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-900"
              >
                <div class="mb-3 flex items-center gap-2">
                  {review.rating && (
                    <div class="flex gap-0.5">
                      {renderStars(review.rating)?.map((s) => (
                        <SimpleIcon
                          name="star"
                          class={`h-4 w-4 ${s.filled ? "text-amber-500 fill-amber-500" : "fill-none text-gray-300 dark:text-gray-600"}`}
                        />
                      ))}
                    </div>
                  )}
                  {review.date && (
                    <span class="text-sm text-gray-500 dark:text-gray-400">
                      {review.date}
                    </span>
                  )}
                </div>
                <blockquote class="text-gray-700 dark:text-gray-300">
                  "{review.text}"
                </blockquote>
                <div class="mt-4 flex items-center gap-3">
                  {review.avatar ? (
                    <img
                      src={review.avatar}
                      alt={review.author}
                      width="40"
                      height="40"
                      class="h-10 w-10 rounded-full object-cover"
                    />
                  ) : (
                    <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700">
                      <SimpleIcon name="user" class="h-5 w-5 text-gray-500" />
                    </div>
                  )}
                  <div>
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                      {review.author}
                    </div>
                    <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
                      <SimpleIcon name="google" class="h-3 w-3" />
                      Google Review
                    </div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      ) : variant === "minimal" ? (
        <div class={`grid gap-8 ${gridClass}`} data-animate-stagger={animateStagger || undefined}>
          {reviewItems.map((review) => (
            <div class="text-center">
              {review.rating && (
                <div class="mb-2 flex justify-center gap-0.5">
                  {renderStars(review.rating)?.map((s) => (
                    <SimpleIcon
                      name="star"
                      class={`h-4 w-4 ${s.filled ? "text-amber-500 fill-amber-500" : "fill-none text-gray-300 dark:text-gray-600"}`}
                    />
                  ))}
                </div>
              )}
              <blockquote class="text-lg italic text-gray-700 dark:text-gray-300">
                "{review.text}"
              </blockquote>
              <div class="mt-4 font-medium text-gray-900 dark:text-white">
                — {review.author}
                {review.date && (
                  <span class="text-gray-500 dark:text-gray-400"> · {review.date}</span>
                )}
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class={`grid gap-8 ${gridClass}`} data-animate-stagger={animateStagger || undefined}>
          {reviewItems.map((review) => (
            <article class="rounded-xl border border-gray-100 bg-white p-6 shadow-sm dark:border-gray-700 dark:bg-gray-900">
              <div class="mb-3 flex items-center justify-between">
                {review.rating && (
                  <div class="flex gap-0.5">
                    {renderStars(review.rating)?.map((s) => (
                      <SimpleIcon
                        name="star"
                        class={`h-4 w-4 ${s.filled ? "text-amber-500 fill-amber-500" : "text-gray-300 dark:text-gray-600"}`}
                      />
                    ))}
                  </div>
                )}
                {review.date && (
                  <span class="text-sm text-gray-500 dark:text-gray-400">
                    {review.date}
                  </span>
                )}
              </div>
              <blockquote class="text-gray-700 dark:text-gray-300">
                "{review.text}"
              </blockquote>
              <div class="mt-4 flex items-center gap-3">
                {review.avatar ? (
                  <img
                    src={review.avatar}
                    alt={review.author}
                    width="40"
                    height="40"
                    class="h-10 w-10 rounded-full object-cover"
                  />
                ) : (
                  <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-700">
                    <SimpleIcon name="user" class="h-5 w-5 text-gray-500" />
                  </div>
                )}
                <div>
                  <div class="text-sm font-medium text-gray-900 dark:text-white">
                    {review.author}
                  </div>
                  <div class="flex items-center gap-1 text-xs text-gray-500 dark:text-gray-400">
                    <SimpleIcon name="google" class="h-3 w-3" />
                    Google Review
                  </div>
                </div>
              </div>
            </article>
          ))}
        </div>
      )
    ) : placeId ? (
      <div
        id="google-reviews-placeholder"
        data-place-id={placeId}
        class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-12 text-center dark:border-gray-600 dark:bg-gray-800"
      >
        <p class="text-gray-500 dark:text-gray-400">
          Loading reviews from Google...
        </p>
        <p class="mt-2 text-sm text-gray-400 dark:text-gray-500">
          (Requires GOOGLE_MAPS_API_KEY and client-side script)
        </p>
      </div>
    ) : (
      <p class="rounded-xl border border-dashed border-gray-300 bg-gray-50 p-8 text-center text-gray-500 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-400">
        No reviews yet. Add reviews via the <code class="rounded bg-gray-200 px-1 dark:bg-gray-700">reviews</code> prop
        or configure <code class="rounded bg-gray-200 px-1 dark:bg-gray-700">placeId</code> for live fetching.
      </p>
    )}
  </div>
</section>
