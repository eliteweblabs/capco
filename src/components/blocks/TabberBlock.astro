---
/**
 * TabberBlock - Sliding pill nav tabs with content panels
 *
 * CMS-ready tabber using SlidingTabs for the nav. Content can be HTML from rich text.
 *
 * @example Direct usage:
 * <TabberBlock tabs={[
 *   { label: "Overview", content: "<p>Overview content...</p>" },
 *   { label: "Details", content: "<p>Details content...</p>" }
 * ]} />
 *
 * @example CMS shortcode:
 * <TabberBlock
 *   tab1Label="Overview"
 *   tab1Content="<p>Overview content...</p>"
 *   tab2Label="Details"
 *   tab2Content="<p>Details content...</p>"
 * />
 */
import SlidingTabs from "../common/SlidingTabs.astro";
import { parseJsonProp, buildArrayFromFlatProps } from "./BlockRegistry";
import { globalClasses } from "../../pages/api/global/global-classes";
const { globalContainerClasses } = globalClasses();

interface TabItem {
  label: string;
  content?: string;
  icon?: string;
}

interface Props {
  tabs?: string | TabItem[];

  // Flat props for CMS (tab1Label, tab1Content, tab2Label, tab2Content, ...)
  tab1Label?: string;
  tab1Content?: string;
  tab1Icon?: string;
  tab2Label?: string;
  tab2Content?: string;
  tab2Icon?: string;
  tab3Label?: string;
  tab3Content?: string;
  tab3Icon?: string;
  tab4Label?: string;
  tab4Content?: string;
  tab4Icon?: string;
  tab5Label?: string;
  tab5Content?: string;
  tab5Icon?: string;
  tab6Label?: string;
  tab6Content?: string;
  tab6Icon?: string;

  className?: string;
  id?: string;
  /** Unique nav ID for SlidingTabs; defaults to generated */
  navId?: string;
  /** Compact nav (smaller padding) */
  compact?: boolean | string;
  /** Zero-based index of the initially active tab (default 0) */
  activeItem?: number;
}

const props = Astro.props;
const {
  className = "",
  id,
  navId: propsNavId,
  compact = false,
  activeItem: activeItemProp = 0,
} = props;
const isCompact = compact === true || compact === "true";

// Build tabs from JSON or flat props
let tabs: TabItem[] = [];
if (props.tabs) {
  tabs = parseJsonProp<TabItem[]>(props.tabs, []);
} else {
  tabs = buildArrayFromFlatProps<TabItem>(props, "tab", ["label", "content", "icon"], 6);
}

tabs = tabs.filter((t) => t.label);

// Clamp activeItem to valid index
const activeItem = Math.max(0, Math.min(activeItemProp, tabs.length - 1));

// Unique ID for this tabber instance
const blockId = id || `tabber-${Math.random().toString(36).slice(2, 9)}`;
const navId = propsNavId || `${blockId}-nav`;

const CHECK_ICON =
  '<svg data-icon="check" class="inline-block align-middle mt-0.5 h-5 w-5 shrink-0 text-primary-600 dark:text-primary-400" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"></path></svg>';

function styleListHtml(html: string): string {
  if (!html) return html;
  return html
    .replace(/<ul(\s|>)/gi, '<ul class="mt-6 space-y-3"$1')
    .replace(/<li(\s|>)/gi, `<li class="flex items-start gap-3 text-gray-600 dark:text-gray-300 is-visible" data-animate="fade-up-subtle"> ${CHECK_ICON} <span>`)
    .replace(/<\/li>/gi, "</span> </li>");
}

// SlidingTabs expects NavItem shape
const navItems = tabs.map((t) => ({
  label: t.label,
  icon: t.icon,
  id: undefined,
  variant: "tab" as const,
}));
---

<section
  id={blockId}
  class={`tabber-block ${className} ${globalContainerClasses}`}
  data-tabber
  style="
position: relative;
top: -38px;
"
>
  <SlidingTabs
    items={navItems}
    navId={navId}
    activeItem={activeItem}
    compact={isCompact}
    urlParam=""
  />
  <div class="tabber-panels mt-6">
    {
      /* activeItem panel visible on server, rest hidden â€“ see .cursor/rules/tabber-sliding-tabs-ssr.mdc */
    }
    {
      tabs.map((tab, index) => (
        <div
          data-tab-index={index}
          data-tabber-panel
          class:list={[
            "tabber-panel prose max-w-none dark:prose-invert",
            index === activeItem ? "" : "hidden",
          ]}
          set:html={styleListHtml(tab.content || "")}
        />
      ))
    }
  </div>
</section>

<script>
  function initTabberPanels() {
    document.querySelectorAll("[data-tabber]").forEach((block) => {
      const nav = block.querySelector("nav");
      const panels = block.querySelectorAll("[data-tabber-panel]");
      if (!nav || !panels.length) return;

      const buttons = nav.querySelectorAll("button[data-index]");
      buttons.forEach((btn) => {
        btn.addEventListener("click", function () {
          const idx = parseInt((this as HTMLElement).dataset.index ?? "0", 10);
          panels.forEach((panel, i) => {
            (panel as HTMLElement).classList.toggle("hidden", i !== idx);
          });
        });
      });
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initTabberPanels);
  } else {
    initTabberPanels();
  }
</script>
