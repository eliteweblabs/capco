---
/**
 * ImageBlock - Image with Options
 * 
 * Display images with captions, alignment, sizing, and styling options.
 * Perfect for CMS/markdown usage.
 * 
 * @example Basic usage:
 * <ImageBlock src="/images/hero.jpg" alt="Hero image" />
 * 
 * @example With caption and styling:
 * <ImageBlock 
 *   src="/images/photo.jpg" 
 *   alt="Photo description"
 *   caption="Photo by John Doe"
 *   align="center"
 *   rounded="true"
 *   shadow="lg"
 * />
 * 
 * @example As a link:
 * <ImageBlock src="/images/logo.png" alt="Logo" href="https://example.com" />
 */

interface Props {
  // Image source (required)
  src: string;
  
  // Alt text (required for accessibility)
  alt: string;
  
  // Dimensions
  width?: number | string;
  height?: number | string;
  
  // Sizing mode
  size?: 'auto' | 'full' | 'contain' | 'cover' | 'small' | 'medium' | 'large';
  
  // Alignment
  align?: 'left' | 'center' | 'right';
  
  // Caption text
  caption?: string;
  
  // Link wrapper
  href?: string;
  target?: '_blank' | '_self';
  
  // Styling
  rounded?: boolean | string | 'sm' | 'md' | 'lg' | 'xl' | 'full';
  shadow?: 'none' | 'sm' | 'md' | 'lg' | 'xl' | '2xl';
  border?: boolean | string;
  
  // Effects
  grayscale?: boolean | string;
  hoverZoom?: boolean | string;
  
  // Loading
  loading?: 'lazy' | 'eager';
  
  // Aspect ratio
  aspectRatio?: 'auto' | 'square' | 'video' | '4/3' | '3/2' | '16/9' | '21/9';
  
  // Container max width
  maxWidth?: string;
  
  // Styling
  className?: string;
  id?: string;
  
  // Animation
  animate?: boolean | string | 'fade-blur-scale' | 'fade-blur' | 'fade-scale' | 'fade-up' | 'fade-up-blur' | 'zoom-blur' | 'fade';
  animateDelay?: string;
}

const props = Astro.props;
const {
  src,
  alt,
  caption,
  href,
  target = '_blank',
  loading = 'lazy',
  className = '',
  id,
} = props;

// Parse numeric values
const width = typeof props.width === 'string' ? parseInt(props.width) || props.width : props.width;
const height = typeof props.height === 'string' ? parseInt(props.height) || props.height : props.height;

// Parse boolean/string values
const border = props.border === 'true' || props.border === true;
const grayscale = props.grayscale === 'true' || props.grayscale === true;
const hoverZoom = props.hoverZoom === 'true' || props.hoverZoom === true;

// Handle rounded - can be boolean or size string
const getRoundedClass = () => {
  if (props.rounded === 'true' || props.rounded === true) return 'rounded-lg';
  if (props.rounded === 'false' || props.rounded === false) return '';
  if (props.rounded === 'sm') return 'rounded-sm';
  if (props.rounded === 'md') return 'rounded-md';
  if (props.rounded === 'lg') return 'rounded-lg';
  if (props.rounded === 'xl') return 'rounded-xl';
  if (props.rounded === 'full') return 'rounded-full';
  return '';
};

// Size classes
const sizeClasses: Record<string, string> = {
  auto: 'w-auto h-auto',
  full: 'w-full h-auto',
  contain: 'w-full h-full object-contain',
  cover: 'w-full h-full object-cover',
  small: 'max-w-xs',
  medium: 'max-w-md',
  large: 'max-w-2xl',
};

// Alignment classes
const alignClasses: Record<string, string> = {
  left: 'mr-auto',
  center: 'mx-auto',
  right: 'ml-auto',
};

// Shadow classes
const shadowClasses: Record<string, string> = {
  none: '',
  sm: 'shadow-sm',
  md: 'shadow-md',
  lg: 'shadow-lg',
  xl: 'shadow-xl',
  '2xl': 'shadow-2xl',
};

// Aspect ratio classes
const aspectClasses: Record<string, string> = {
  auto: '',
  square: 'aspect-square',
  video: 'aspect-video',
  '4/3': 'aspect-[4/3]',
  '3/2': 'aspect-[3/2]',
  '16/9': 'aspect-[16/9]',
  '21/9': 'aspect-[21/9]',
};

const size = props.size || 'auto';
const align = props.align || 'center';
const shadow = props.shadow || 'none';
const aspectRatio = props.aspectRatio || 'auto';
const maxWidth = props.maxWidth;

// Handle animation prop - enabled by default
const getAnimationType = () => {
  if (props.animate === 'false' || props.animate === false) return null;
  if (props.animate === 'true' || props.animate === true) return 'fade-blur-scale';
  if (typeof props.animate === 'string') return props.animate;
  return 'fade-blur-scale'; // Default animation
};
const animationType = getAnimationType();
const animateDelay = props.animateDelay;

const imageClasses = [
  sizeClasses[size] || sizeClasses.auto,
  getRoundedClass(),
  shadowClasses[shadow],
  aspectClasses[aspectRatio],
  border && 'border border-gray-200 dark:border-gray-700',
  grayscale && 'grayscale hover:grayscale-0 transition-all duration-300',
  hoverZoom && 'transition-transform duration-300 hover:scale-105',
];

const containerClasses = [
  'image-block block',
  alignClasses[align],
  size === 'full' ? 'w-full' : 'w-fit',
  className,
];

const containerStyle = maxWidth ? `max-width: ${maxWidth};` : '';
---

<figure 
  id={id}
  class:list={containerClasses}
  style={containerStyle}
  data-animate={animationType || undefined}
  data-animate-delay={animateDelay || undefined}
>
  {href ? (
    <a 
      href={href} 
      target={target}
      rel={target === '_blank' ? 'noopener noreferrer' : undefined}
      class="block overflow-hidden"
    >
      <img 
        data-src={src} 
        alt={alt}
        width={typeof width === 'number' ? width : 800}
        height={typeof height === 'number' ? height : 600}
        class:list={[...imageClasses, 'lazyload', 'blur-sm']}
      />
    </a>
  ) : (
    <img 
      data-src={src} 
      alt={alt}
      width={typeof width === 'number' ? width : 800}
      height={typeof height === 'number' ? height : 600}
      class:list={[...imageClasses, 'lazyload', 'blur-sm']}
    />
  )}
  
  {caption && (
    <figcaption class="mt-3 text-sm text-gray-500 dark:text-gray-400 text-center">
      {caption}
    </figcaption>
  )}
</figure>
