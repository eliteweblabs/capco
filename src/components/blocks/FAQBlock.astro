---
/**
 * FAQBlock - FAQ Accordion
 * 
 * Displays frequently asked questions in an accordion or grid layout.
 * Uses Flowbite accordion pattern for interactivity.
 * 
 * @example With JSON:
 * <FAQBlock 
 *   title="Frequently Asked Questions" 
 *   faqs={[
 *     { question: "How does it work?", answer: "..." },
 *     { question: "What's included?", answer: "..." }
 *   ]}
 * />
 * 
 * @example With flat props:
 * {{FAQBlock faq1Question="How?" faq1Answer="Like this..." faq2Question="Why?" faq2Answer="Because..."}}
 */
import SimpleIcon from "../common/SimpleIcon.astro";
import { parseJsonProp, buildArrayFromFlatProps } from "./BlockRegistry";
import { globalClasses } from "../../pages/api/global/global-classes";

const { globalTextH3 } = globalClasses();

interface FAQ {
  question: string;
  answer: string;
  icon?: string;
}

interface Props {
  // Section content
  title?: string;
  description?: string;
  
  // Layout
  variant?: 'accordion' | 'grid' | 'simple' | 'cards';
  columns?: number | string;
  
  // FAQs as JSON
  faqs?: string | FAQ[];
  
  // Flat props for up to 12 FAQs
  faq1Question?: string;
  faq1Answer?: string;
  faq2Question?: string;
  faq2Answer?: string;
  faq3Question?: string;
  faq3Answer?: string;
  faq4Question?: string;
  faq4Answer?: string;
  faq5Question?: string;
  faq5Answer?: string;
  faq6Question?: string;
  faq6Answer?: string;
  faq7Question?: string;
  faq7Answer?: string;
  faq8Question?: string;
  faq8Answer?: string;
  faq9Question?: string;
  faq9Answer?: string;
  faq10Question?: string;
  faq10Answer?: string;
  faq11Question?: string;
  faq11Answer?: string;
  faq12Question?: string;
  faq12Answer?: string;
  
  // Open first item by default
  defaultOpen?: boolean | string;
  
  // Styling
  className?: string;
  id?: string;
  
  // Animation
  animate?: boolean | string | 'fade-blur-scale' | 'fade-blur' | 'fade-scale' | 'fade-up' | 'fade-up-blur' | 'zoom-blur' | 'fade';
  animateDelay?: string;
  animateStagger?: boolean | string;
}

const props = Astro.props;
const {
  title,
  description,
  variant = 'accordion',
  className = '',
  id,
} = props;

const columns = typeof props.columns === 'string' ? parseInt(props.columns) : (props.columns ?? 2);
const defaultOpen = props.defaultOpen === 'false' ? false : (props.defaultOpen ?? true);

// Handle animation prop - enabled by default with stagger
const getAnimationType = () => {
  if (props.animate === 'false' || props.animate === false) return null;
  if (props.animate === 'true' || props.animate === true) return 'fade-up';
  if (typeof props.animate === 'string') return props.animate;
  return 'fade-up'; // Default animation for FAQ
};
const animationType = getAnimationType();
const animateDelay = props.animateDelay;
// Enable stagger by default, unless explicitly disabled
const animateStagger = props.animateStagger !== 'false' && props.animateStagger !== false;

// Default demo FAQs
const defaultFaqs: FAQ[] = [
  { 
    question: "What services do you offer?", 
    answer: "We provide comprehensive services including design, installation, inspection, and maintenance for commercial and residential properties." 
  },
  { 
    question: "How long does the process take?", 
    answer: "Project timelines vary based on scope. Small projects typically take 1-2 weeks, while larger installations may take 4-8 weeks." 
  },
  { 
    question: "Do you offer emergency services?", 
    answer: "Yes, we offer 24/7 emergency response services for all clients with active maintenance contracts." 
  },
  { 
    question: "What certifications do you have?", 
    answer: "Our team holds industry certifications, state licenses, and manufacturer certifications for all major brands." 
  },
];

// Build FAQs array
let faqItems: FAQ[] = [];

if (props.faqs) {
  faqItems = parseJsonProp<FAQ[]>(props.faqs, []);
} else {
  faqItems = buildArrayFromFlatProps<FAQ>(
    props,
    'faq',
    ['question', 'answer', 'icon'],
    12
  );
}

// Use default FAQs if none provided
if (faqItems.length === 0) {
  faqItems = defaultFaqs;
}

// Generate unique ID for accordion
const accordionId = id || `faq-accordion-${Math.random().toString(36).slice(2, 9)}`;

// Column classes for grid variant
const columnClasses: Record<number, string> = {
  1: 'grid-cols-1',
  2: 'grid-cols-1 lg:grid-cols-2',
};

const gridClass = columnClasses[columns] || columnClasses[2];
---

<section 
  id={id} 
  class:list={['faq-block py-16 md:py-24', className]}
  data-animate={animationType || undefined}
  data-animate-delay={animateDelay || undefined}
>
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
    {(title || description) && (
      <div class="mb-12 text-center">
        {title && (
          <h2 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-white sm:text-4xl">
            {title}
          </h2>
        )}
        {description && (
          <p class="mt-4 text-lg text-gray-600 dark:text-gray-300 max-w-3xl mx-auto">
            {description}
          </p>
        )}
      </div>
    )}
    
    {variant === 'accordion' ? (
      <div class="mx-auto max-w-3xl">
        <div id={accordionId} class="faq-details-accordion">
          {faqItems.map((faq, index) => (
            <details
              name={accordionId}
              class="border-b border-gray-200 dark:border-gray-700 group"
              open={index === 0 && defaultOpen}
            >
              <summary class="flex cursor-pointer list-none items-center justify-between gap-3 py-5 px-1 font-medium text-left text-gray-900 dark:text-white hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors [&::-webkit-details-marker]:hidden">
                <span class="text-lg">{faq.question}</span>
                <SimpleIcon
                  name="chevron-down"
                  class="faq-chevron h-5 w-5 shrink-0 transition-transform duration-200 group-open:rotate-180"
                />
              </summary>
              <div class="py-5 px-1">
                <p class="text-gray-600 dark:text-gray-300 leading-relaxed" set:html={faq.answer} />
              </div>
            </details>
          ))}
        </div>
      </div>
    ) : variant === 'grid' ? (
      <div class={`grid gap-8 ${gridClass}`}>
        {faqItems.map((faq) => (
          <div class="faq-item">
            <h3 class={`${globalTextH3} mb-2 flex items-start gap-2`}>
              {faq.icon && <SimpleIcon name={faq.icon} class="h-5 w-5 text-primary-600 dark:text-primary-400 mt-0.5 shrink-0" />}
              {faq.question}
            </h3>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed" set:html={faq.answer} />
          </div>
        ))}
      </div>
    ) : variant === 'cards' ? (
      <div class={`grid gap-6 ${gridClass}`}>
        {faqItems.map((faq) => (
          <div class="rounded-xl bg-white dark:bg-gray-900 p-6 shadow-sm border border-gray-100 dark:border-gray-700">
            <h3 class={`${globalTextH3} mb-3 flex items-start gap-2`}>
              <SimpleIcon name="help-circle" class="h-5 w-5 text-primary-600 dark:text-primary-400 mt-0.5 shrink-0" />
              {faq.question}
            </h3>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed" set:html={faq.answer} />
          </div>
        ))}
      </div>
    ) : (
      <div class="space-y-8 max-w-3xl mx-auto">
        {faqItems.map((faq) => (
          <div class="faq-item">
            <h3 class={`${globalTextH3} mb-2`}>
              {faq.question}
            </h3>
            <p class="text-gray-600 dark:text-gray-300 leading-relaxed" set:html={faq.answer} />
          </div>
        ))}
      </div>
    )}
  </div>
</section>

