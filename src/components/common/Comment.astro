---
// Comment component that works both as a regular component and as a partial
export const partial = true;

// Detect if this is being used as a partial
const isPartial = Astro.request.headers.has("x-comment-id");

let comment, currentUserRole, currentUserId, supabaseUrl, depth;

if (isPartial) {
  // Extract props from headers when used as partial
  const commentData = Astro.request.headers.get("x-comment-data");
  comment = commentData ? JSON.parse(commentData) : null;
  currentUserRole = Astro.request.headers.get("x-current-user-role") || "Client";
  currentUserId = Astro.request.headers.get("x-current-user-id") || "";
  supabaseUrl = Astro.request.headers.get("x-supabase-url") || "";
  depth = parseInt(Astro.request.headers.get("x-comment-depth") || "0");
} else {
  // Use regular props when used as a component
  const props = Astro.props;
  comment = props.comment;
  currentUserRole = props.currentUserRole || "Client";
  currentUserId = props.currentUserId || "";
  supabaseUrl = props.supabaseUrl || "";
  depth = props.depth || 0;
}

if (!comment) {
  return <div>No comment data</div>;
}

const isInternal = comment.internal;
const isAuthor = comment.author_id === currentUserId;
const canToggleCompleted = currentUserRole === "Admin" || currentUserRole === "Staff" || isAuthor;
const canReply = currentUserRole === "Admin" || currentUserRole === "Staff" || currentUserRole === "Client";

const marginLeft = depth > 0 ? `ml-${Math.min(depth * 8, 32)}` : "";
const borderLeft = depth > 0 ? "border-l-2 border-gray-200 dark:border-gray-600 pl-4" : "";

// Helper function to get image URL
function getImageUrl(imagePath: string): string {
  if (imagePath.startsWith("http")) {
    return imagePath;
  }
  
  if (!supabaseUrl || supabaseUrl === "undefined" || supabaseUrl.includes("your-project")) {
    return `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjNmNGY2Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzY2NjY2NiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkltYWdlIG5vdCBhdmFpbGFibGU8L3RleHQ+PC9zdmc+`;
  }
  
  return `${supabaseUrl}/storage/v1/object/public/${imagePath}`;
}

// Helper function to highlight mentions
function highlightMentions(text: string): string {
  return text.replace(
    /@([a-zA-Z0-9_]+)/g,
    '<span class="inline-flex items-center rounded-lg bg-blue-100 px-2 py-1 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200">@$1</span>'
  );
}
---

<div class={`comment-item ${marginLeft} ${borderLeft}`} data-discussion-id={comment.id}>
  <div class="rounded-lg border border-gray-200 bg-white p-4 dark:border-gray-700 dark:bg-gray-800">
    <div class="flex items-start justify-between">
      <div class="flex items-center space-x-3">
        <div class="flex h-8 w-8 items-center justify-center rounded-lg bg-gray-200 dark:bg-gray-600">
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
            {comment.company_name ? comment.company_name.charAt(0).toUpperCase() : "U"}
          </span>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-900 dark:text-white">
            {comment.company_name || "Unknown User"}
            {isInternal && (
              <span class="ml-2 inline-flex items-center rounded-lg bg-red-100 px-2 py-1 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200">
                <i class="bx bx-lock mr-1"></i>Internal
              </span>
            )}
          </p>
          <p class="text-xs text-gray-500 dark:text-gray-400">
            {new Date(comment.created_at).toLocaleString()}
          </p>
        </div>
      </div>
      
      {canToggleCompleted && (
        <div class="flex items-center space-x-2" id={`toggle-container-${comment.id}`}>
          <!-- Toggle will be loaded here -->
        </div>
      )}
    </div>
    
    <div class="mt-3">
      <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" set:html={highlightMentions(comment.message)} />
      
      {comment.image_paths && comment.image_paths.length > 0 && (
        <div class="mt-3 flex flex-wrap gap-2">
          {comment.image_paths.map((imagePath) => (
            <div class="relative group">
              <img 
                src={getImageUrl(imagePath)} 
                alt="Discussion image"
                class="max-w-xs max-h-48 object-cover rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:opacity-90 transition-opacity"
                onclick={`console.log('ðŸ–¼ï¸ [DISCUSSION] Image clicked:', '${getImageUrl(imagePath)}'); openImageModal('${getImageUrl(imagePath)}')`}
              />
              <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all rounded-lg flex items-center justify-center">
                <i class="bx bx-zoom-in text-white opacity-0 group-hover:opacity-100 transition-opacity text-2xl"></i>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
    
    {canReply && (
      <div class="mt-3 flex items-center justify-between">
        <button
          class="reply-button text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200"
          data-discussion-id={comment.id}
        >
          <i class="bx bx-reply mr-1"></i>
          Reply
        </button>
      </div>
    )}
  </div>
</div>
