---
import { globalCompanyData } from "../../pages/api/global/global-company-data";
import { readFileSync, existsSync } from "fs";
import { join } from "path";

const companyData = globalCompanyData();

// Load SVG file
function loadSvgFile(): string {
  const svgPath = join(process.cwd(), "public", "img", "capco-logo.svg");
  if (!existsSync(svgPath)) return "";

  try {
    let svg = readFileSync(svgPath, "utf-8")
      .replace(/<\?xml[^>]*\?>/gi, "")
      .replace(/\s+/g, " ")
      .trim();

    // Fix dark mode: use currentColor for fills
    svg = svg
      .replace(/@media\s*\(prefers-color-scheme:\s*dark\)\s*\{[^}]*\}/gi, "")
      .replace(/\.fill\s*\{[^}]*fill:\s*#[^;]+[^}]*\}/gi, ".fill { fill: currentColor; }")
      .replace(/\}\s*\}/g, "}")
      .replace(/fill="#231f20"|fill="#000"|fill="#fff"|fill="[^"]*"/gi, 'class="fill"');

    return svg;
  } catch {
    return "";
  }
}

// Get logo (prefer file, fallback to env var)
const svgFromFile = loadSvgFile();
const logoSvg = svgFromFile || companyData.globalCompanyLogo || "";

// Props
export interface Props {
  link?: string;
  className?: string;
}

const { link = "/", className = "" } = Astro.props;

// Validate link
let validLink = link;
if (typeof validLink === "string") {
  if (validLink.includes("<svg") || validLink.includes("<?xml") || validLink.includes("xmlns=")) {
    validLink = "/";
  } else if (validLink && !validLink.startsWith("/") && !validLink.startsWith("http")) {
    validLink = "/";
  }
}

if (!logoSvg || !logoSvg.includes("<svg")) return null;
---

<a
  href={validLink}
  title="Go to home page"
  class={`logo-svg-wrapper w-40 ${className}`.trim()}
  set:html={logoSvg}
/>
