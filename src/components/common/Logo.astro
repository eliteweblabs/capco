---
import { replacePlaceholders } from "../../lib/placeholder-utils";

const logoSvg = replacePlaceholders("{{COMPANY_LOGO}}", null);
const logoSvgIcon = replacePlaceholders("{{COMPANY_ICON}}", null);

// Check if logo is actually set (not empty and not just placeholder text)
const hasLogo =
  logoSvg &&
  logoSvg.trim() &&
  logoSvg !== "{{COMPANY_LOGO_LIGHT}}" &&
  !logoSvg.includes("<text") && // Don't show text-based fallback logos
  logoSvg.includes("<svg"); // Must be valid SVG

export interface Props {
  file?: "svg" | "string" | "data-url" | "base64";
  size?: "sm" | "md" | "lg" | "xl";
  link?: string;
  className?: string;
  isBackend?: boolean;
}

const { file = "svg", link: rawLink = "/", size = "md", isBackend } = Astro.props;

// Defensive check: ensure link is a valid URL path (not SVG/XML content)
let link = rawLink;
if (
  typeof link === "string" &&
  (link.includes("<svg") || link.includes("<?xml") || link.includes("xmlns="))
) {
  console.error("ðŸš¨ [LOGO] Invalid link prop contains SVG/XML content, defaulting to '/'");
  link = "/";
}
// Ensure link starts with "/" or "http" for valid URL paths
if (typeof link === "string" && link && !link.startsWith("/") && !link.startsWith("http")) {
  link = "/";
}

// If no logo is set, return null (don't render anything)
if (!hasLogo) {
  return null;
}

// Return different types based on the file prop
if (file === "string") {
  // Return just the SVG string for use in utilities
  return logoSvg;
} else if (file === "data-url") {
  // Return as data URL
  const encoded = Buffer.from(logoSvg).toString("base64");
  return `data:image/svg+xml;base64,${encoded}`;
} else if (file === "base64") {
  // Return just the base64 encoded string
  return Buffer.from(logoSvg).toString("base64");
}
---

{
  hasLogo && file === "svg" && link && isBackend && (
    <>
      <a class="flex sm:hidden w-10" href={link} title="Go to home page" set:html={logoSvgIcon} />
      <a class="hidden sm:flex" href={link} title="Go to home page" set:html={logoSvg} />
    </>
  )
}
{
  hasLogo && file === "svg" && link && !isBackend && (
    <a href={link} title="Go to home page" set:html={logoSvg} />
  )
}
{hasLogo && file === "svg" && !link && <div set:html={logoSvg} />}
