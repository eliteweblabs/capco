---
// Campfire Chat Widget Component
// Embeds the Campfire Chat widget into the website
// Typically appears as a floating chat button in the bottom-right corner

interface Props {
  currentUser?: {
    id?: string;
    email?: string;
    name?: string;
    profile?: {
      firstName?: string;
      lastName?: string;
      companyName?: string;
    };
  };
  position?: "bottom-right" | "bottom-left";
  theme?: "light" | "dark" | "auto";
  
}

const { currentUser, position = "bottom-right", theme = "auto" } = Astro.props;

if (!currentUser) {
  return null;
}

// Skip Campfire widget in development to avoid localhost errors
// Set ENABLE_CAMPFIRE_IN_DEV=true if you want to test it locally
const isDevelopment = import.meta.env.DEV || import.meta.env.NODE_ENV === "development";
const enableInDev = import.meta.env.PUBLIC_ENABLE_CAMPFIRE_IN_DEV === "true";

if (isDevelopment && !enableInDev) {
  return null;
}

// Get Campfire URL from environment variable
// In Astro, PUBLIC_ prefixed vars are available client-side
// Check both regular and PUBLIC_ prefixed versions
let campfireUrl = import.meta.env.PUBLIC_CAMPFIRE_URL;
let campfireWidgetId =
  import.meta.env.PUBLIC_CAMPFIRE_WIDGET_ID;

// // Ensure URL has protocol (required for script loading)
// if (campfireUrl && !campfireUrl.startsWith("http://") && !campfireUrl.startsWith("https://")) {
//   campfireUrl = `https://${campfireUrl}`;
// }

// // If no Campfire URL or widget ID is configured, don't render the widget
// if (!campfireUrl && !campfireWidgetId) {
//   console.warn(
//     "‚ö†Ô∏è [CAMPFIRE-WIDGET] Campfire URL or Widget ID not configured. Set PUBLIC_CAMPFIRE_URL or PUBLIC_CAMPFIRE_WIDGET_ID in environment variables."
//   );
// }

// Determine theme - pass as string for client-side evaluation
const themeMode = theme;
---

{
  campfireUrl || campfireWidgetId ? (
    <div id="campfire-chat-widget-container" data-position={position}>
      {/* <!-- Campfire Chat Widget will be injected here by the script --> */}
    </div>
  ) : (
    <script is:inline>
      console.warn('[---CAMPFIRE-WIDGET] Widget not rendered - missing environment variables:', {
        hasPublicUrl: false,
        hasUrl: false,
        hasPublicWidgetId: false,
        hasWidgetId: false,
        message: 'Set PUBLIC_CAMPFIRE_URL or PUBLIC_CAMPFIRE_WIDGET_ID in environment variables'
      });
    </script>
  )
}

{
  campfireUrl || campfireWidgetId ? (
    <script define:vars={{ campfireUrl, campfireWidgetId, themeMode, currentUser }}>
      (function() {
        // Prevent duplicate initialization
        if (window.campfireWidgetInitialized) {
          console.log('[---CAMPFIRE-WIDGET] Widget already initialized, skipping');
          return;
        }
        window.campfireWidgetInitialized = true;
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCampfireWidget);
        } else {
          initCampfireWidget();
        }

        function initCampfireWidget() {
          const container = document.getElementById('campfire-chat-widget-container');
          if (!container) {
            console.error('[---CAMPFIRE-WIDGET] Container not found');
            return;
          }

          // Determine theme
          let isDark = false;
          if (themeMode === 'dark') {
            isDark = true;
          } else if (themeMode === 'light') {
            isDark = false;
          } else {
            // Auto theme: check document class and system preference
            isDark = document.documentElement.classList.contains('dark') || 
                     window.matchMedia('(prefers-color-scheme: dark)').matches;
          }

          console.log('[---CAMPFIRE-WIDGET] Initializing...', {
            campfireUrl: campfireUrl || 'not set',
            campfireWidgetId: campfireWidgetId || 'not set',
            hasCurrentUser: !!currentUser,
            containerFound: !!container,
            theme: themeMode,
            isDark: isDark
          });

          // Create popup button function (defined early for use in fallbacks)
          function createPopupButton() {
            if (!campfireUrl) {
              console.error('[---CAMPFIRE-WIDGET] Cannot create popup button - CAMPFIRE_URL is not set');
              container.innerHTML = '<div style="padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 12px;">Campfire widget failed to load. Check console for details.</div>';
              return;
            }
            
            console.log('[---CAMPFIRE-WIDGET] Creating popup button (skipping iframe attempts)');
            
            // Create a button that opens Campfire in a popup window
            const chatUrl = campfireUrl + (campfireWidgetId ? '?widget=' + campfireWidgetId : '');
            container.innerHTML = `
              <button 
                onclick="window.open('${chatUrl}', 'campfire-chat', 'width=600,height=800,resizable=yes,scrollbars=yes')"
                style="
                  position: fixed;
                  bottom: 20px;
                  right: 20px;
                  background: #007bff;
                  color: white;
                  border: none;
                  border-radius: 50px;
                  padding: 16px 24px;
                  font-size: 16px;
                  font-weight: 600;
                  cursor: pointer;
                  box-shadow: 0 4px 12px rgba(0,123,255,0.3);
                  z-index: 9999;
                  transition: all 0.3s ease;
                "
                onmouseover="this.style.background='#0056b3'; this.style.transform='scale(1.05)'"
                onmouseout="this.style.background='#007bff'; this.style.transform='scale(1)'"
              >
                üí¨ Open Chat
              </button>
            `;
            console.log('[---CAMPFIRE-WIDGET] Popup button created. Users can click to open Campfire in a new window.');
          }

          // Method 1: If you have a widget ID (standard Campfire embed)
          if (campfireWidgetId) {
            try {
              console.log('[---CAMPFIRE-WIDGET] Loading widget with ID:', campfireWidgetId);
              
              // Construct widget script URL
              // Ensure campfireUrl has protocol and correct format
              let baseUrl = campfireUrl || 'https://app.campfire.so';
              if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                baseUrl = `https://${baseUrl}`;
              }
              
              // Try multiple possible widget script paths
              // Campfire might use different paths: /widget.js, /widget/embed.js, /embed.js, etc.
              const possiblePaths = [
                `${baseUrl}/widget.js?id=${campfireWidgetId}`,
                `${baseUrl}/widget/embed.js?id=${campfireWidgetId}`,
                `${baseUrl}/embed.js?id=${campfireWidgetId}`,
                `${baseUrl}/widget?id=${campfireWidgetId}`,
              ];
              
              // Try loading widget script with multiple URL paths
              let currentPathIndex = 0;
              
              function tryLoadScript() {
                if (currentPathIndex >= possiblePaths.length) {
                  console.warn('[---CAMPFIRE-WIDGET] All widget script paths failed, using popup button');
                  createPopupButton();
                  return;
                }
                
                const widgetScriptUrl = possiblePaths[currentPathIndex];
                console.log('[---CAMPFIRE-WIDGET] Attempting to load (attempt ' + (currentPathIndex + 1) + '/' + possiblePaths.length + '):', widgetScriptUrl);
                
                const script = document.createElement('script');
                script.src = widgetScriptUrl;
                script.async = true;
                script.setAttribute('data-widget-id', campfireWidgetId);
                script.setAttribute('data-theme', isDark ? 'dark' : 'light');
                
                // Add user info if available
                if (currentUser) {
                  script.setAttribute('data-user-id', currentUser.id || '');
                  script.setAttribute('data-user-email', currentUser.email || '');
                  script.setAttribute('data-user-name', currentUser.name || currentUser.profile?.companyName || '');
                  console.log('[---CAMPFIRE-WIDGET] Adding user info:', {
                    id: currentUser.id,
                    email: currentUser.email,
                    name: currentUser.name || currentUser.profile?.companyName
                  });
                }

                // Add timeout to detect if script never loads
                const timeoutId = setTimeout(() => {
                  if (!document.querySelector('[data-campfire-loaded="true"]')) {
                    console.warn('[---CAMPFIRE-WIDGET] Script load timeout for:', widgetScriptUrl);
                    currentPathIndex++;
                    tryLoadScript(); // Try next path
                  }
                }, 3000); // Reduced timeout for faster fallback
                
                script.onload = () => {
                  clearTimeout(timeoutId);
                  script.setAttribute('data-campfire-loaded', 'true');
                  console.log('[---CAMPFIRE-WIDGET] Campfire widget script loaded successfully from:', widgetScriptUrl);
                };
                
                script.onerror = (error) => {
                  clearTimeout(timeoutId);
                  console.warn('[---CAMPFIRE-WIDGET] Failed to load script from:', widgetScriptUrl);
                  currentPathIndex++;
                  tryLoadScript(); // Try next path
                };
                
                document.body.appendChild(script);
              }
              
              // Start trying to load the script
              tryLoadScript();
            } catch (error) {
              console.error('[---CAMPFIRE-WIDGET] Error loading widget:', error);
              createPopupButton();
            }
          }
          // Method 2: If you have a direct Campfire URL (self-hosted)
          else if (campfireUrl) {
            try {
              console.log('[---CAMPFIRE-WIDGET] Loading widget from URL:', campfireUrl);
              
              // Use popup button directly (no iframe attempts)
              createPopupButton();
            } catch (error) {
              console.error('[---CAMPFIRE-WIDGET] Error loading widget:', error);
              createPopupButton();
            }
          } else {
            console.warn('[---CAMPFIRE-WIDGET] No Campfire URL or Widget ID configured');
          }

        }
      })();
    </script>
  ) : null
}

<style>
  #campfire-chat-widget-container {
    position: fixed;
    z-index: 9999;
  }

  #campfire-chat-widget-container[data-position="bottom-right"] {
    bottom: 120px;
    right: 120px;
  }

  #campfire-chat-widget-container[data-position="bottom-left"] {
    bottom: 120px;
    left: 120px;
  }

  /* Ensure widget doesn't interfere with other elements */
  @media (max-width: 768px) {
    #campfire-chat-widget-container {
      bottom: 10px;
      right: 10px;
    }
  }
</style>
