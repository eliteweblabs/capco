---
// Campfire Chat Widget Component
// Embeds the Campfire Chat widget into the website
// Typically appears as a floating chat button in the bottom-right corner

interface Props {
  currentUser?: {
    id?: string;
    email?: string;
    name?: string;
    profile?: {
      firstName?: string;
      lastName?: string;
      companyName?: string;
    };
  };
  position?: "bottom-right" | "bottom-left";
  theme?: "light" | "dark" | "auto";
}

const { currentUser, position = "bottom-right", theme = "auto" } = Astro.props;

// Get Campfire URL from environment variable
// In Astro, PUBLIC_ prefixed vars are available client-side
// Check both regular and PUBLIC_ prefixed versions
let campfireUrl = import.meta.env.PUBLIC_CAMPFIRE_URL || import.meta.env.CAMPFIRE_URL || undefined;
let campfireWidgetId =
  import.meta.env.PUBLIC_CAMPFIRE_WIDGET_ID || import.meta.env.CAMPFIRE_WIDGET_ID || undefined;

// Log what we found (server-side only, won't expose in client)
if (import.meta.env.NODE_ENV === "development") {
  console.log("[---CAMPFIRE-WIDGET] Environment check:", {
    hasPublicUrl: !!import.meta.env.PUBLIC_CAMPFIRE_URL,
    hasUrl: !!import.meta.env.CAMPFIRE_URL,
    hasPublicWidgetId: !!import.meta.env.PUBLIC_CAMPFIRE_WIDGET_ID,
    hasWidgetId: !!import.meta.env.CAMPFIRE_WIDGET_ID,
    finalUrl: campfireUrl ? `${campfireUrl.substring(0, 20)}...` : "not set",
    finalWidgetId: campfireWidgetId ? "set" : "not set",
  });
}

// Ensure URL has protocol (required for script loading)
if (campfireUrl && !campfireUrl.startsWith("http://") && !campfireUrl.startsWith("https://")) {
  campfireUrl = `https://${campfireUrl}`;
}

// If no Campfire URL or widget ID is configured, don't render the widget
if (!campfireUrl && !campfireWidgetId) {
  console.warn(
    "‚ö†Ô∏è [CAMPFIRE-WIDGET] Campfire URL or Widget ID not configured. Set PUBLIC_CAMPFIRE_URL or PUBLIC_CAMPFIRE_WIDGET_ID in environment variables."
  );
}

// Determine theme based on preference
const resolvedTheme =
  theme === "auto"
    ? `document.documentElement.classList.contains("dark") || window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light"`
    : theme;
---

{
  campfireUrl || campfireWidgetId ? (
    <div id="campfire-chat-widget-container" data-position={position}>
      {/* <!-- Campfire Chat Widget will be injected here by the script --> */}
    </div>
  ) : null
}

{
  campfireUrl || campfireWidgetId ? (
    <script define:vars={{ campfireUrl, campfireWidgetId, resolvedTheme, currentUser }}>
      {`
      (function() {
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCampfireWidget);
        } else {
          initCampfireWidget();
        }

        function initCampfireWidget() {
          const container = document.getElementById('campfire-chat-widget-container');
          if (!container) {
            console.error('‚ùå [CAMPFIRE-WIDGET] Container not found');
            return;
          }

          // Determine theme
          const isDark = ${resolvedTheme.includes("dark") ? "true" : `typeof ${resolvedTheme} === "string" ? ${resolvedTheme} : (document.documentElement.classList.contains("dark") || window.matchMedia("(prefers-color-scheme: dark)").matches)`};

          console.log('üîç [CAMPFIRE-WIDGET] Initializing...', {
            campfireUrl: campfireUrl || 'not set',
            campfireWidgetId: campfireWidgetId || 'not set',
            hasCurrentUser: !!currentUser,
            containerFound: !!container
          });

          // Method 1: If you have a widget ID (standard Campfire embed)
          if (campfireWidgetId) {
            try {
              console.log('üì¶ [CAMPFIRE-WIDGET] Loading widget with ID:', campfireWidgetId);
              
              // Construct widget script URL
              // Ensure campfireUrl has protocol and correct format
              let baseUrl = campfireUrl || 'https://app.campfire.so';
              if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                baseUrl = \`https://\${baseUrl}\`;
              }
              
              // Try multiple possible widget script paths
              const widgetScriptUrl = \`\${baseUrl}/widget.js?id=\${campfireWidgetId}\`;
              console.log('üîó [CAMPFIRE-WIDGET] Attempting to load:', widgetScriptUrl);
              
              const script = document.createElement('script');
              script.src = widgetScriptUrl;
              script.async = true;
              script.setAttribute('data-widget-id', campfireWidgetId);
              script.setAttribute('data-theme', isDark ? 'dark' : 'light');
              
              // Add user info if available
              if (currentUser) {
                script.setAttribute('data-user-id', currentUser.id || '');
                script.setAttribute('data-user-email', currentUser.email || '');
                script.setAttribute('data-user-name', currentUser.name || currentUser.profile?.companyName || '');
                console.log('üë§ [CAMPFIRE-WIDGET] Adding user info:', {
                  id: currentUser.id,
                  email: currentUser.email,
                  name: currentUser.name || currentUser.profile?.companyName
                });
              }

              script.onload = () => {
                console.log('‚úÖ [CAMPFIRE-WIDGET] Campfire widget script loaded successfully');
              };
              script.onerror = (error) => {
                console.error('‚ùå [CAMPFIRE-WIDGET] Failed to load Campfire widget script:', widgetScriptUrl, error);
                // Fallback: try iframe approach
                tryIframeFallback();
              };
              document.body.appendChild(script);
            } catch (error) {
              console.error('‚ùå [CAMPFIRE-WIDGET] Error loading widget:', error);
              tryIframeFallback();
            }
          }
          // Method 2: If you have a direct Campfire URL (self-hosted)
          else if (campfireUrl) {
            try {
              console.log('üì¶ [CAMPFIRE-WIDGET] Loading widget from URL:', campfireUrl);
              
              // Try iframe approach first for self-hosted instances
              tryIframeFallback();
            } catch (error) {
              console.error('‚ùå [CAMPFIRE-WIDGET] Error loading widget:', error);
            }
          } else {
            console.warn('‚ö†Ô∏è [CAMPFIRE-WIDGET] No Campfire URL or Widget ID configured');
          }

          // Fallback: Iframe approach for self-hosted Campfire
          function tryIframeFallback() {
            console.log('üîÑ [CAMPFIRE-WIDGET] Trying iframe fallback...');
            try {
              const iframe = document.createElement('iframe');
              iframe.src = \`\${campfireUrl}/embed\${campfireWidgetId ? '?id=' + campfireWidgetId : ''}\`;
              iframe.style.width = '400px';
              iframe.style.height = '600px';
              iframe.style.border = 'none';
              iframe.style.borderRadius = '8px';
              iframe.style.position = 'fixed';
              iframe.style.bottom = '20px';
              iframe.style.right = '20px';
              iframe.style.zIndex = '9999';
              iframe.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
              iframe.allow = 'camera; microphone; geolocation';
              iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox');
              
              iframe.onload = () => {
                console.log('‚úÖ [CAMPFIRE-WIDGET] Campfire iframe loaded successfully');
              };
              iframe.onerror = (error) => {
                console.error('‚ùå [CAMPFIRE-WIDGET] Failed to load Campfire iframe:', error);
              };
              
              container.appendChild(iframe);
            } catch (error) {
              console.error('‚ùå [CAMPFIRE-WIDGET] Error creating iframe:', error);
            }
          }

        }
      })();
    `}
    </script>
  ) : null
}

<style>
  #campfire-chat-widget-container {
    position: fixed;
    z-index: 9999;
  }

  #campfire-chat-widget-container[data-position="bottom-right"] {
    bottom: 120px;
    right: 120px;
  }

  #campfire-chat-widget-container[data-position="bottom-left"] {
    bottom: 120px;
    left: 120px;
  }

  /* Ensure widget doesn't interfere with other elements */
  @media (max-width: 768px) {
    #campfire-chat-widget-container {
      bottom: 10px;
      right: 10px;
    }
  }
</style>
