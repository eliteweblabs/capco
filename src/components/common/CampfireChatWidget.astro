---
// Campfire Chat Widget Component
// Embeds the Campfire Chat widget into the website
// Typically appears as a floating chat button in the bottom-right corner

interface Props {
  currentUser?: {
    id?: string;
    email?: string;
    name?: string;
    profile?: {
      firstName?: string;
      lastName?: string;
      companyName?: string;
    };
  };
  position?: "bottom-right" | "bottom-left";
  theme?: "light" | "dark" | "auto";
  
}

const { currentUser, position = "bottom-right", theme = "auto" } = Astro.props;

// Get Campfire URL from environment variable
// In Astro, PUBLIC_ prefixed vars are available client-side
// Check both regular and PUBLIC_ prefixed versions
let campfireUrl = import.meta.env.PUBLIC_CAMPFIRE_URL;
let campfireWidgetId =
  import.meta.env.PUBLIC_CAMPFIRE_WIDGET_ID;

// Log what we found (server-side only, won't expose in client)
if (import.meta.env.NODE_ENV === "development") {
  console.log("[---CAMPFIRE-WIDGET] Environment check:", {
    hasPublicUrl: !!import.meta.env.PUBLIC_CAMPFIRE_URL,
    hasUrl: !!import.meta.env.CAMPFIRE_URL,
    hasPublicWidgetId: !!import.meta.env.PUBLIC_CAMPFIRE_WIDGET_ID,
    hasWidgetId: !!import.meta.env.CAMPFIRE_WIDGET_ID,
    finalUrl: campfireUrl ? `${campfireUrl.substring(0, 20)}...` : "not set",
    finalWidgetId: campfireWidgetId ? "set" : "not set",
  });
}

// // Ensure URL has protocol (required for script loading)
// if (campfireUrl && !campfireUrl.startsWith("http://") && !campfireUrl.startsWith("https://")) {
//   campfireUrl = `https://${campfireUrl}`;
// }

// // If no Campfire URL or widget ID is configured, don't render the widget
// if (!campfireUrl && !campfireWidgetId) {
//   console.warn(
//     "⚠️ [CAMPFIRE-WIDGET] Campfire URL or Widget ID not configured. Set PUBLIC_CAMPFIRE_URL or PUBLIC_CAMPFIRE_WIDGET_ID in environment variables."
//   );
// }

// Determine theme - pass as string for client-side evaluation
const themeMode = theme;
---

{
  campfireUrl || campfireWidgetId ? (
    <div id="campfire-chat-widget-container" data-position={position}>
      {/* <!-- Campfire Chat Widget will be injected here by the script --> */}
    </div>
  ) : (
    <script is:inline>
      console.warn('[---CAMPFIRE-WIDGET] Widget not rendered - missing environment variables:', {
        hasPublicUrl: false,
        hasUrl: false,
        hasPublicWidgetId: false,
        hasWidgetId: false,
        message: 'Set PUBLIC_CAMPFIRE_URL or PUBLIC_CAMPFIRE_WIDGET_ID in environment variables'
      });
    </script>
  )
}

{
  campfireUrl || campfireWidgetId ? (
    <script define:vars={{ campfireUrl, campfireWidgetId, themeMode, currentUser }}>
      (function() {
        // Prevent duplicate initialization
        if (window.campfireWidgetInitialized) {
          console.log('[---CAMPFIRE-WIDGET] Widget already initialized, skipping');
          return;
        }
        window.campfireWidgetInitialized = true;
        
        // Wait for DOM to be ready
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initCampfireWidget);
        } else {
          initCampfireWidget();
        }

        function initCampfireWidget() {
          const container = document.getElementById('campfire-chat-widget-container');
          if (!container) {
            console.error('[---CAMPFIRE-WIDGET] Container not found');
            return;
          }

          // Determine theme
          let isDark = false;
          if (themeMode === 'dark') {
            isDark = true;
          } else if (themeMode === 'light') {
            isDark = false;
          } else {
            // Auto theme: check document class and system preference
            isDark = document.documentElement.classList.contains('dark') || 
                     window.matchMedia('(prefers-color-scheme: dark)').matches;
          }

          console.log('[---CAMPFIRE-WIDGET] Initializing...', {
            campfireUrl: campfireUrl || 'not set',
            campfireWidgetId: campfireWidgetId || 'not set',
            hasCurrentUser: !!currentUser,
            containerFound: !!container,
            theme: themeMode,
            isDark: isDark
          });

          // Method 1: If you have a widget ID (standard Campfire embed)
          if (campfireWidgetId) {
            try {
              console.log('[---CAMPFIRE-WIDGET] Loading widget with ID:', campfireWidgetId);
              
              // Construct widget script URL
              // Ensure campfireUrl has protocol and correct format
              let baseUrl = campfireUrl || 'https://app.campfire.so';
              if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                baseUrl = `https://${baseUrl}`;
              }
              
              // Try multiple possible widget script paths
              // Campfire might use different paths: /widget.js, /widget/embed.js, /embed.js, etc.
              const possiblePaths = [
                `${baseUrl}/widget.js?id=${campfireWidgetId}`,
                `${baseUrl}/widget/embed.js?id=${campfireWidgetId}`,
                `${baseUrl}/embed.js?id=${campfireWidgetId}`,
                `${baseUrl}/widget?id=${campfireWidgetId}`,
              ];
              
              // Try loading widget script with multiple URL paths
              let currentPathIndex = 0;
              
              function tryLoadScript() {
                if (currentPathIndex >= possiblePaths.length) {
                  console.warn('[---CAMPFIRE-WIDGET] All widget script paths failed, trying iframe fallback');
                  tryIframeFallback();
                  return;
                }
                
                const widgetScriptUrl = possiblePaths[currentPathIndex];
                console.log('[---CAMPFIRE-WIDGET] Attempting to load (attempt ' + (currentPathIndex + 1) + '/' + possiblePaths.length + '):', widgetScriptUrl);
                
                const script = document.createElement('script');
                script.src = widgetScriptUrl;
                script.async = true;
                script.setAttribute('data-widget-id', campfireWidgetId);
                script.setAttribute('data-theme', isDark ? 'dark' : 'light');
                
                // Add user info if available
                if (currentUser) {
                  script.setAttribute('data-user-id', currentUser.id || '');
                  script.setAttribute('data-user-email', currentUser.email || '');
                  script.setAttribute('data-user-name', currentUser.name || currentUser.profile?.companyName || '');
                  console.log('[---CAMPFIRE-WIDGET] Adding user info:', {
                    id: currentUser.id,
                    email: currentUser.email,
                    name: currentUser.name || currentUser.profile?.companyName
                  });
                }

                // Add timeout to detect if script never loads
                const timeoutId = setTimeout(() => {
                  if (!document.querySelector('[data-campfire-loaded="true"]')) {
                    console.warn('[---CAMPFIRE-WIDGET] Script load timeout for:', widgetScriptUrl);
                    currentPathIndex++;
                    tryLoadScript(); // Try next path
                  }
                }, 3000); // Reduced timeout for faster fallback
                
                script.onload = () => {
                  clearTimeout(timeoutId);
                  script.setAttribute('data-campfire-loaded', 'true');
                  console.log('[---CAMPFIRE-WIDGET] Campfire widget script loaded successfully from:', widgetScriptUrl);
                };
                
                script.onerror = (error) => {
                  clearTimeout(timeoutId);
                  console.warn('[---CAMPFIRE-WIDGET] Failed to load script from:', widgetScriptUrl);
                  currentPathIndex++;
                  tryLoadScript(); // Try next path
                };
                
                document.body.appendChild(script);
              }
              
              // Start trying to load the script
              tryLoadScript();
            } catch (error) {
              console.error('[---CAMPFIRE-WIDGET] Error loading widget:', error);
              tryIframeFallback();
            }
          }
          // Method 2: If you have a direct Campfire URL (self-hosted)
          else if (campfireUrl) {
            try {
              console.log('[---CAMPFIRE-WIDGET] Loading widget from URL:', campfireUrl);
              
              // Try iframe approach first for self-hosted instances
              tryIframeFallback();
            } catch (error) {
              console.error('[---CAMPFIRE-WIDGET] Error loading widget:', error);
            }
          } else {
            console.warn('[---CAMPFIRE-WIDGET] No Campfire URL or Widget ID configured');
          }

          // Fallback: Iframe approach for self-hosted Campfire
          function tryIframeFallback() {
            console.log('[---CAMPFIRE-WIDGET] Trying iframe fallback...');
            
            if (!campfireUrl) {
              console.error('[---CAMPFIRE-WIDGET] Cannot use iframe fallback - CAMPFIRE_URL is not set');
              container.innerHTML = '<div style="padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 12px;">Campfire widget failed to load. Check console for details.</div>';
              return;
            }
            
            // Try multiple possible embed URLs
            const possibleEmbedUrls = [
              `${campfireUrl}/embed${campfireWidgetId ? '?id=' + campfireWidgetId : ''}`,
              `${campfireUrl}/widget${campfireWidgetId ? '?id=' + campfireWidgetId : ''}`,
              `${campfireUrl}/chat${campfireWidgetId ? '?id=' + campfireWidgetId : ''}`,
              `${campfireUrl}${campfireWidgetId ? '?widget=' + campfireWidgetId : ''}`,
              `${campfireUrl}${campfireWidgetId ? '?embed=' + campfireWidgetId : ''}`,
            ];
            
            let currentEmbedIndex = 0;
            
            function tryEmbedUrl() {
              if (currentEmbedIndex >= possibleEmbedUrls.length) {
                console.error('[---CAMPFIRE-WIDGET] All embed URLs failed. The Campfire server may be blocking iframe embedding (X-Frame-Options) or the embed endpoints don\'t exist.');
                container.innerHTML = '<div style="padding: 10px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c33; font-size: 12px;">Campfire widget failed to load. Check that:<br>1. Campfire server allows iframe embedding (remove X-Frame-Options header)<br>2. The embed endpoint exists on your Campfire deployment</div>';
                return;
              }
              
              const embedUrl = possibleEmbedUrls[currentEmbedIndex];
              console.log('[---CAMPFIRE-WIDGET] Trying embed URL (' + (currentEmbedIndex + 1) + '/' + possibleEmbedUrls.length + '):', embedUrl);
              
              try {
                const iframe = document.createElement('iframe');
                iframe.src = embedUrl;
                iframe.style.width = '400px';
                iframe.style.height = '600px';
                iframe.style.border = 'none';
                iframe.style.borderRadius = '8px';
                iframe.style.position = 'fixed';
                iframe.style.bottom = '20px';
                iframe.style.right = '20px';
                iframe.style.zIndex = '9999';
                iframe.style.boxShadow = '0 4px 6px rgba(0, 0, 0, 0.1)';
                iframe.style.display = 'none';
                iframe.allow = 'camera; microphone; geolocation';
                iframe.setAttribute('sandbox', 'allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox');
                
                let loadVerified = false;
                
                // Check if iframe actually loaded content (not just the onload event)
                const verifyLoad = () => {
                  try {
                    // Try to access iframe content - if blocked by X-Frame-Options, this will throw
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow?.document;
                    if (iframeDoc && iframeDoc.body && iframeDoc.body.innerHTML) {
                      loadVerified = true;
                      iframe.style.display = 'block';
                      console.log('[---CAMPFIRE-WIDGET] Campfire iframe loaded and verified:', embedUrl);
                      return true;
                    }
                  } catch (e) {
                    // Cross-origin or X-Frame-Options blocked
                    console.warn('[---CAMPFIRE-WIDGET] Cannot verify iframe content (may be blocked by X-Frame-Options):', e.message);
                  }
                  return false;
                };
                
                iframe.onload = () => {
                  setTimeout(() => {
                    if (!verifyLoad()) {
                      // onload fired but content not accessible - likely blocked
                      console.warn('[---CAMPFIRE-WIDGET] Iframe onload fired but content not accessible - trying next URL');
                      container.removeChild(iframe);
                      currentEmbedIndex++;
                      tryEmbedUrl();
                    }
                  }, 500);
                };
                
                iframe.onerror = (error) => {
                  console.warn('[---CAMPFIRE-WIDGET] Iframe load error:', embedUrl);
                  if (container.contains(iframe)) {
                    container.removeChild(iframe);
                  }
                  currentEmbedIndex++;
                  tryEmbedUrl();
                };
                
                // Check for X-Frame-Options blocking after a delay
                setTimeout(() => {
                  if (!loadVerified && container.contains(iframe)) {
                    console.warn('[---CAMPFIRE-WIDGET] Iframe may be blocked by X-Frame-Options, trying next URL');
                    container.removeChild(iframe);
                    currentEmbedIndex++;
                    tryEmbedUrl();
                  }
                }, 2000);
                
                container.appendChild(iframe);
              } catch (error) {
                console.error('[---CAMPFIRE-WIDGET] Error creating iframe:', error);
                currentEmbedIndex++;
                tryEmbedUrl();
              }
            }
            
            tryEmbedUrl();
          }

        }
      })();
    </script>
  ) : null
}

<style>
  #campfire-chat-widget-container {
    position: fixed;
    z-index: 9999;
  }

  #campfire-chat-widget-container[data-position="bottom-right"] {
    bottom: 120px;
    right: 120px;
  }

  #campfire-chat-widget-container[data-position="bottom-left"] {
    bottom: 120px;
    left: 120px;
  }

  /* Ensure widget doesn't interfere with other elements */
  @media (max-width: 768px) {
    #campfire-chat-widget-container {
      bottom: 10px;
      right: 10px;
    }
  }
</style>
