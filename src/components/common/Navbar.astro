---
// Fixed Flowbite Navbar Component with proper Tailwind classes
import AssignedProjects from "./AssignedProjects.astro";
import AuthIcon from "./AuthIcon.astro";
import Button from "./Button.astro";
import Logo from "./Logo.astro";
import ProjectSearch from "../project/ProjectSearch.astro";
import Punchlist from "../project/Punchlist.astro";
import ToggleSidebar from "./ToggleSidebar.astro";
import BoxIcon from "./BoxIcon.astro";
import SearchForm from "./SearchForm.astro";
import NotificationDropdown from "./NotificationDropdown.astro";

interface Props {
  currentUser?: any;
  session?: any;
  desktopNavigationHTML: string;
  project?: any;
  id?: string;
  projects?: any[];
  isBackend?: boolean;
  supabaseUrl?: string;
}

const {
  currentUser,
  session,
  desktopNavigationHTML,
  id,
  projects,
  isBackend,
  supabaseUrl,
  project,
} = Astro.props;

const currentUrl = Astro.url.pathname;

const isAuth = currentUser ? true : false;
const currentRole = currentUser?.profile?.role;
---

<nav
  class="_LPVUrp9Uina5fcERqWC QhmQ_v3mmDFIP9VaVOfb YRrCJSr_j5nopfm4duUc mU8yQmXJPYHX95JD515m t6gkcSf0Bt4MLItXvDJ_ Q_jg_EPdNf9eDMn1mLI2 EpUSgjHdM6oyMXUiK_8_ qUWbS_LTZujDB4XCd11V _Ybd3WwuTVljUT4vEaM3 RZmKBZs1E1eXw8vkE6jY _fGhMnSfYmaGrv7DvZ00 _1jTZ8KXRZul60S6czNi"
>
  <div class="YRrCJSr_j5nopfm4duUc t6gkcSf0Bt4MLItXvDJ_ Q_jg_EPdNf9eDMn1mLI2 sJNGKHxFYdN5Nzml5J2j">
    <div class="YRrCJSr_j5nopfm4duUc Q_jg_EPdNf9eDMn1mLI2 _HgeI6Dx9I__pBEYsPz0">
      <ToggleSidebar currentUser={currentUser} />
      <Logo link="/" file="svg" />
    </div>

    {
      !isBackend && (
        <div class="hidden w-full md:block md:w-auto" id="navbar-default">
          <ul
            class="mt-4 flex flex-col font-medium md:mt-0 md:flex-row md:space-x-8 md:border-0 md:p-0 rtl:space-x-reverse"
            set:html={desktopNavigationHTML}
          />
        </div>
      )
    }
    <!-- Search Form -->
    {
      currentUrl === "/dashboard" && currentRole !== "Client" && (
        <ProjectSearch projects={projects} />
      )
    }

    <div class="YRrCJSr_j5nopfm4duUc Q_jg_EPdNf9eDMn1mLI2 WD962RTivt8M5sMg7WrS">
      <div
        class="YRrCJSr_j5nopfm4duUc Q_jg_EPdNf9eDMn1mLI2 R0X5VtiZIoV7IjvrxBJ_ tS181Wfa_gkJpFt03pqL"
      >
        {isAuth && currentRole !== "Client" && <AssignedProjects currentUser={currentUser} />}

        {
          project && (
            <Punchlist currentUser={currentUser} supabaseUrl={supabaseUrl} project={project} />
          )
        }

        {isAuth && <NotificationDropdown currentUser={currentUser} />}
      </div>
    </div>
  </div>
  <button
    id="theme-toggle"
    data-tooltip-target="tooltip-toggle"
    type="button"
    class="mveJTCIb2WII7J4sY22F Z4DH5a4vmjReSFRBpPgz c8dCx6gnV43hTOLV6ks5 PeR2JZ9BZHYIH8Ea3F36 _7KA5gD55t2lxf9Jkj20 BkIbg_JwkgiyRW804Hhu _q0p_O8QLU1paqtuqmI2 _6wdnQrxT_dGdAdNk5AQ XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX yChACvAr1v8czJ2VO22j"
  >
    <svg
      id="theme-toggle-dark-icon"
      class="_SmdlCf6eUKB_V9S5IDj MnxxlQlR1H0xJuMEE8Yr YIUegm7fh_CpJbivTu6B"
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      fill="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        d="M12.3224 5.68708c.2935-.31028.3575-.77266.1594-1.15098-.1981-.37832-.6146-.5891-1.0368-.52467-1.50847.2302-2.93175.83665-4.12869 1.76276-1.19717.92628-2.12732 2.1411-2.69465 3.52702-.56744 1.38619-.75115 2.89299-.53164 4.37079.2195 1.4776.83393 2.8711 1.77895 4.0436.9448 1.1722 2.18683 2.0826 3.60103 2.6449 1.414.5623 2.9539.7584 4.4683.57 1.5145-.1884 2.9549-.7551 4.1784-1.6475 1.2237-.8924 2.1892-2.0806 2.7972-3.4499.1723-.3879.0809-.8423-.2279-1.1335-.3089-.2911-.7679-.3556-1.145-.1608-.8631.4459-1.8291.6799-2.8118.6791h-.0018c-1.1598.0013-2.2925-.3234-3.2596-.931-.9667-.6074-1.7244-1.4697-2.1856-2.4779-.4611-1.0078-.6079-2.1209-.4243-3.20511.1835-1.08442.6905-2.09837 1.4645-2.91681Z"
      ></path>
    </svg>

    <svg
      id="theme-toggle-light-icon"
      class="_SmdlCf6eUKB_V9S5IDj MnxxlQlR1H0xJuMEE8Yr YIUegm7fh_CpJbivTu6B"
      aria-hidden="true"
      xmlns="http://www.w3.org/2000/svg"
      width="24"
      height="24"
      fill="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        fill-rule="evenodd"
        d="M13 3a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0V3ZM6.343 4.929A1 1 0 0 0 4.93 6.343l1.414 1.414a1 1 0 0 0 1.414-1.414L6.343 4.929Zm12.728 1.414a1 1 0 0 0-1.414-1.414l-1.414 1.414a1 1 0 0 0 1.414 1.414l1.414-1.414ZM12 7a5 5 0 1 0 0 10 5 5 0 0 0 0-10Zm-9 4a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2H3Zm16 0a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2h-2ZM7.757 17.657a1 1 0 1 0-1.414-1.414l-1.414 1.414a1 1 0 1 0 1.414 1.414l1.414-1.414Zm9.9-1.414a1 1 0 0 0-1.414 1.414l1.414 1.414a1 1 0 0 0 1.414-1.414l-1.414-1.414ZM13 19a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0v-2Z"
        clip-rule="evenodd"></path>
    </svg>
  </button>
  <div
    id="tooltip-toggle"
    role="tooltip"
    class="H78G_4yayxs5C3xdFbnK ZBSHeVK3dmgzHTRX3hLO pq2JRWtiWcwYnw3xueNl QhmQ_v3mmDFIP9VaVOfb VPGGthdu3cy_ZP7AL7dt mveJTCIb2WII7J4sY22F foDHZclRWUf2bqma2a8U _Cj_M6jt2eLjDgkBBNgI b9aD6g2qw84oyZNsMO8j c8dCx6gnV43hTOLV6ks5 ezMFUVl744lvw6ht0lFe y6GKdvUrd7vp_pxsFb57 Db4Wzva4DMepJJiQLY7M fzhbbDQ686T8arwvi_bJ mc9bwhBTHL8mVzJvl6gz rqOAGYeDo9iWuroePkaf"
  >
    Toggle dark mode

    <div class="tkX8MMO2MiTlgtbd_jG3" data-popper-arrow=""></div>
  </div>

  <div
    class="_SmdlCf6eUKB_V9S5IDj rxe6apEJoEk8r75xaVNG xUcCzntJXjlyYV0K8cfa _9dH7mrOkzM4RTmidHTs jqg6J89cvxmDiFpnV56r q9tHTtfvjP4K5atJnf4v"
  >
    <!-- seperator -->
  </div>

  <!-- Hidden data attribute for notifications -->
  {isAuth && <div data-user-id={currentUser?.id} style="display: none;" />}

  <AuthIcon currentUser={currentUser} session={session} />

  <nav class="hidden border-b border-gray-200 bg-white dark:border-gray-700 dark:bg-gray-900">
    <div class="mx-auto flex max-w-screen-xl flex-wrap items-center justify-between p-4">
      <!-- Logo with back button support -->
      <div class="flex items-center space-x-3 rtl:space-x-reverse">
        {
          id && (
            <div class="flex items-center space-x-2">
              <Button
                href="/dashboard"
                variant="anchor"
                size="xl"
                icon="chevron-left"
                class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white"
              />
            </div>
          )
        }
      </div>
    </div>
  </nav>

  <script>
    const logoutBtn = document.getElementById("logout-btn") as HTMLButtonElement;

    // Logout functionality (only if logout button exists - when authenticated)
    if (logoutBtn) {
      logoutBtn.addEventListener("click", async () => {
        // console.log("ðŸ“‹ [HEADER] Logout button clicked");
        try {
          // console.log("ðŸ“‹ [HEADER] Sending logout request...");
          const response = await fetch("/api/auth/signout", {
            method: "POST",
          });
          // console.log("ðŸ“‹ [HEADER] Logout response status:", response.status);

          if (response.ok) {
            // console.log("ðŸ“‹ [HEADER] Logout successful, redirecting...");

            // Simple redirect to home page with success message
            const url = new URL(window.location.origin);
            url.searchParams.set("message", "logout_success");
            window.location.href = url.toString();
          } else {
            // console.error("ðŸ“‹ [HEADER] Logout failed with status:", response.status);

            // Show error modal if logout fails
            if (typeof window.showModal === "function") {
              window.showModal(
                "error",
                "Logout Failed",
                "There was an error logging out. Please try again.",
                0 // No auto-hide for errors
              );
            } else {
              // Fallback if showModal is not available
              alert("There was an error logging out. Please try again.");
            }
          }
        } catch (error) {
          console.error("ðŸ“‹ [HEADER] Logout error:", error);
        }
      });
    }
  </script>
</nav>
