---
// Enable this component to work as both regular component and partial
export const partial = true;
import { getButtonClasses } from "../../lib/button-styles";
import SimpleIcon from "./SimpleIcon.astro";
// Button component for standardized button styling throughout the project
export interface Props {
  type?: "button" | "submit" | "reset";
  variant?:
    | "primary"
    | "secondary"
    | "success"
    | "warning"
    | "danger"
    | "outline"
    | "ghost"
    | "link"
    | "loading"
    | "disabled"
    | "anchor"
    | "selected"
    | "icon"
    | "tab"
    | "antispam";
  size?: "xs" | "sm" | "md" | "lg" | "xl";
  href?: string;
  target?: "_blank" | "_self" | "_parent" | "_top";
  disabled?: boolean;
  loading?: boolean;
  icon?: string;
  iconOnly?: boolean; // Use width/height sizing (not padding) when true ‚Äì for icon-only buttons
  iconPosition?: "left" | "right";
  iconClasses?: string;
  fullWidth?: boolean;
  focus?: boolean;
  class?: string;
  id?: string;
  name?: string;
  value?: string;
  title?: string;
  form?: string;
  onclick?: string;
  dataAttributes?: Record<string, string>;
  selectedClasses?: string;
  style?: string;
}

// Check if this is being used as a partial (X-headers present) or regular component
const isPartial =
  Astro.request.headers.has("x-button-variant") || Astro.request.headers.has("x-button-text");

// Extract props from either Astro.props or X-headers
const type = Astro.props.type || Astro.request.headers.get("x-button-type") || "button";
const variant = Astro.props.variant || Astro.request.headers.get("x-button-variant") || "primary";
const size = Astro.props.size || Astro.request.headers.get("x-button-size") || "md";
const href = Astro.props.href || Astro.request.headers.get("x-button-href") || undefined;
const target = Astro.props.target || Astro.request.headers.get("x-button-target") || "_self";
const disabled =
  Astro.props.disabled || Astro.request.headers.get("x-button-disabled") === "true" || false;
const loading =
  Astro.props.loading || Astro.request.headers.get("x-button-loading") === "true" || false;
const icon = Astro.props.icon || Astro.request.headers.get("x-button-icon") || undefined;
const iconPosition =
  Astro.props.iconPosition || Astro.request.headers.get("x-button-icon-position") || "left";
const iconClasses =
  Astro.props.iconClasses || Astro.request.headers.get("x-button-icon-classes") || undefined;

// Debug logging for iconClasses
// if (icon) {
//   console.log("üîç [BUTTON] Icon classes:", {
//     icon,
//     iconClasses,
//     propsIconClasses: Astro.props.iconClasses,
//     iconPosition,
//     finalClass: iconClasses || (iconPosition === "left" ? "mr-2" : "ml-2"),
//   });
// }

const fullWidth =
  Astro.props.fullWidth || Astro.request.headers.get("x-button-full-width") === "true" || false;
const focus = Astro.props.focus || Astro.request.headers.get("x-button-focus") === "true" || false;
const className = Astro.props.class || Astro.request.headers.get("x-button-class") || "";
const id = Astro.props.id || Astro.request.headers.get("x-button-id") || undefined;
const name = Astro.props.name || Astro.request.headers.get("x-button-name") || undefined;
const value = Astro.props.value || Astro.request.headers.get("x-button-value") || undefined;
const title = Astro.props.title || Astro.request.headers.get("x-button-title") || undefined;
const form = Astro.props.form || Astro.request.headers.get("x-button-form") || undefined;
const onclick = Astro.props.onclick || Astro.request.headers.get("x-button-onclick") || undefined;
const buttonText = Astro.request.headers.get("x-button-text") || "";
const selectedClasses = Astro.props.selectedClasses || "";
const style = Astro.props.style || Astro.request.headers.get("x-button-style") || "";

// Handle data attributes from both props and headers
let dataAttributes = Astro.props.dataAttributes || {};
if (isPartial) {
  for (const [key, value] of Astro.request.headers.entries()) {
    if (key.startsWith("x-button-data-")) {
      const dataKey = key.replace("x-button-data-", "").replace(/-/g, "-");
      dataAttributes[`data-${dataKey}`] = value;
    }
  }
}

// Use shared button styling logic (icon: true when icon-only so size classes are h/w, not padding)
const isIconOnly = Astro.props.iconOnly === true || variant === "icon";
const buttonClasses = getButtonClasses({
  variant: variant as any,
  size: size as any,
  fullWidth,
  focus,
  className,
  icon: isIconOnly,
});

// Map button size to icon size
const iconSizeMap = {
  xs: "xs",
  sm: "sm",
  md: "md",
  lg: "lg",
  xl: "xl",
} as const;

const iconSize = iconSizeMap[size as keyof typeof iconSizeMap] || "md";

// console.log(
//   "üîò [BUTTON] Size:",
//   size,
//   "Size classes:",
//   iconSizeMap[size as keyof typeof iconSizeMap],
//   "Full classes:",
//   buttonClasses
// );

// Build data attributes object - don't add the data- prefix as it's already in the keys
const dataAttrs = dataAttributes;

// Add selected classes data attribute if provided
const selectedDataAttr = selectedClasses ? { "data-selected-classes": selectedClasses } : {};

// Determine if this should be a link or button
const isLink = href && !disabled;

// Antispam: only for buttons (not links), adds hold-for-5s on mobile
const isAntispam = variant === "antispam" && !isLink;

// Build attributes object
const attributes = {
  class: buttonClasses,
  ...(id && { id }),
  ...(name && { name }),
  ...(value && { value }),
  ...(form && { form }),
  ...(onclick && { onclick }),
  ...(disabled && !isLink && { disabled }),
  ...(isLink && { href, target }),
  ...dataAttrs,
  ...selectedDataAttr,
  ...(style && { style }),
  ...(isAntispam && {
    "data-antispam": "true",
    "data-antispam-hold": "5000",
  }),
};
---

{
  isLink ? (
    <a title={title} {...attributes}>
      {loading && (
        <svg class="-ml-1 mr-2 h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
      )}
      {icon && iconPosition === "left" && !loading && (
        <SimpleIcon name={icon} size={iconSize} class={`${iconClasses || "mr-2"} icon-default`} />
      )}
      {buttonText ? (
        buttonText
      ) : (
        // <span class="button-text">
        <slot />
        // </span>
      )}
      {icon && iconPosition === "right" && !loading && (
        <SimpleIcon name={icon} size={iconSize} class={`${iconClasses || "ml-2"} icon-default`} />
      )}
      {dataAttributes?.["data-count"] && parseInt(dataAttributes["data-count"]) > 0 && (
        <span class="dark:bg-background-dark absolute -right-2 -top-2 flex h-5 w-5 items-center justify-center rounded-full border border-primary-500 bg-gray-100 text-xs font-medium text-primary-500 dark:border-primary-400 dark:text-primary-400">
          {dataAttributes["data-count"]}
        </span>
      )}
    </a>
  ) : (
    <button type={type as "button" | "submit" | "reset"} {...attributes}>
      {isAntispam && <span class="antispam-progress" aria-hidden="true" />}
      {loading && (
        <svg class="-ml-1 mr-2 h-4 w-4 animate-spin" fill="none" viewBox="0 0 24 24">
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="4"
          />
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
          />
        </svg>
      )}
      {icon && iconPosition === "left" && !loading && (
        <SimpleIcon name={icon} size={iconSize} class={`${iconClasses || "mr-2"} icon-default`} />
      )}
      {buttonText ? (
        buttonText
      ) : (
        // <span class="button-text select-none">
        <slot />
        // </span>
      )}
      {icon && iconPosition === "right" && !loading && (
        <SimpleIcon name={icon} size={iconSize} class={`${iconClasses || "ml-2"} icon-default`} />
      )}
      {dataAttributes?.["data-count"] && parseInt(dataAttributes["data-count"]) > 0 && (
        <span class="bg-background dark:bg-background-dark absolute right-0 top-0 flex h-5 w-5 items-center justify-center rounded-full border border-primary bg-gray-100 text-xs font-medium text-primary-500 dark:border-primary dark:text-primary-400">
          {dataAttributes["data-count"]}
        </span>
      )}
    </button>
  )
}

<style>
  /* Additional button styles for specific variants */
  .btn-loading {
    position: relative;
    pointer-events: none;
  }

  .btn-loading::after {
    position: absolute;
    top: 50%;
    left: 50%;
    animation: spin 1s linear infinite;
    margin: -10px 0 0 -10px;
    border: 2px solid transparent;
    border-top: 2px solid currentColor;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    content: "";
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  /* Focus styles for better accessibility */
  button:focus-visible,
  a:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }

  /* Hover effects for better UX */
  /* button:not(.disabled):not(.link):hover,
  a:not([aria-disabled="true"]):not(.disabled):not(.link):hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
  }

  button:not(.disabled):not(.link):active,
  a:not([aria-disabled="true"]):not(.disabled):not(.link):active {
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.12);
  } */

  /* Ensure button text inherits proper color */
  /* .button-text {
    color: inherit;
    font-weight: inherit;
  } */

  .sliding-tabs-item {
    opacity: 0.75 !important;
  }

  .dark .sliding-tabs-item {
    opacity: 0.75 !important;
  }
  /* Active sliding tabs item styles */
  .sliding-tabs-item[data-active="true"] {
    opacity: 1 !important;
  }

  .dark .sliding-tabs-item[data-active="true"] {
    opacity: 1 !important;
  }

  /* .sliding-tabs-item[data-active="true"]:hover {
    color: black !important;
  }

  .dark .sliding-tabs-item[data-active="true"]:hover {
    color: white !important;
  } */

  /* Antispam: horizontal color transition progress bar */
  .antispam-button {
    --antispam-progress: 0;
  }

  .antispam-progress {
    position: absolute;
    inset: 0;
    left: 0;
    width: calc(var(--antispam-progress, 0) * 100%);
    background: linear-gradient(
      90deg,
      var(--color-primary-300, #b099e6) 0%,
      var(--color-primary-500, #825bdd) 50%,
      var(--color-success-500, #22c55e) 100%
    );
    border-radius: inherit;
    pointer-events: none;
    transition: width 0.05s linear;
    z-index: 0;
  }

  .antispam-button > *:not(.antispam-progress) {
    position: relative;
    z-index: 1;
  }
</style>

{isAntispam && (
  <script>
    (function initAntispam() {
      if ((window as any).__antispamInited) return;
      (window as any).__antispamInited = true;

      const isTouchDevice = () => window.matchMedia("(hover: none)").matches();
      if (!isTouchDevice()) return;

      document.querySelectorAll<HTMLButtonElement>("[data-antispam]").forEach((btn) => {
        if (btn.dataset.antispamInited) return;
        btn.dataset.antispamInited = "true";

        const holdMs = parseInt(btn.dataset.antispamHold ?? "5000", 10) || 5000;
        let holdTimer: ReturnType<typeof setTimeout> | null = null;
        let progressInterval: ReturnType<typeof setInterval> | null = null;
        let startTime = 0;

        const reset = () => {
          if (holdTimer) clearTimeout(holdTimer);
          if (progressInterval) clearInterval(progressInterval);
          holdTimer = null;
          progressInterval = null;
          btn.style.setProperty("--antispam-progress", "0");
        };

        const complete = () => {
          reset();
          btn.style.setProperty("--antispam-progress", "1");
          const el = btn as HTMLButtonElement & { dataset: { antispamAllowed?: string } };
          el.dataset.antispamAllowed = "true";
          btn.click();
          delete el.dataset.antispamAllowed;
        };

        const startHold = () => {
          if (btn.disabled) return;
          startTime = Date.now();
          progressInterval = setInterval(() => {
            const elapsed = Date.now() - startTime;
            const progress = Math.min(elapsed / holdMs, 1);
            btn.style.setProperty("--antispam-progress", String(progress));
          }, 50);
          holdTimer = setTimeout(complete, holdMs);
        };

        btn.addEventListener(
          "click",
          (e) => {
            const el = btn as HTMLButtonElement & { dataset: { antispamAllowed?: string } };
            if (!el.dataset.antispamAllowed) {
              e.preventDefault();
              e.stopPropagation();
            }
          },
          { capture: true }
        );

        btn.addEventListener("touchstart", startHold, { passive: true });
        btn.addEventListener("touchend", reset, { passive: true });
        btn.addEventListener("touchcancel", reset, { passive: true });
      });
    })();
  </script>
)}
