---
/**
 * DeleteConfirmButton Component
 * Reusable delete button with 2-step confirmation (no alerts)
 * Uses Button.astro and SimpleIcon for consistency
 *
 * Usage:
 * <DeleteConfirmButton
 *   id="delete-item-123"
 * />
 *
 * Behavior:
 * 1. First click: Shows timer icon for 3 seconds
 * 2. Second click within 3 seconds: Executes delete
 * 3. Auto-reverts to trash icon if not confirmed
 */

import Button from "./Button.astro";

export interface Props {
  id: string;
  class?: string;
  timeout?: number; // milliseconds, default 3000
  size?: "xs" | "sm" | "md" | "lg" | "xl"; // default "sm"
  variant?: "icon" | "button"; // default "icon"
  label?: string; // for button variant
  dataAttributes?: Record<string, string>; // custom data attributes
}

const {
  id,
  class: className = "",
  timeout = 30000,
  size = "sm",
  variant = "icon",
  label = "Delete",
  dataAttributes = {},
} = Astro.props;

// Build button variant based on whether it's icon-only or with label
const buttonVariant = "danger";

// Merge custom data attributes with internal ones
const mergedDataAttributes = {
  "data-state": "trash",
  "data-timeout": timeout.toString(),
  ...dataAttributes,
};
---

{
  variant === "icon" ? (
    <Button
      id={id}
      type="button"
      variant={buttonVariant}
      size={size}
      icon="trash"
      iconClasses="delete-confirm-icon"
      class={`delete-confirm-btn rounded-full ${className}`}
      title="Delete"
      dataAttributes={mergedDataAttributes}
    />
  ) : (
    <Button
      id={id}
      type="button"
      variant={buttonVariant}
      size={size}
      icon="trash"
      class={`delete-confirm-btn ${className}`}
      title="Delete"
      dataAttributes={mergedDataAttributes}
    >
      {label}
    </Button>
  )
}

<style>
  @keyframes draw-ring {
    from {
      stroke-dashoffset: 100.53;
    }
    to {
      stroke-dashoffset: 0;
    }
  }

  .timer-ring-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 10;
  }

  .timer-ring-overlay .timer-icon {
    animation: draw-ring var(--timer-duration, 3000ms) linear forwards;
  }

  .delete-confirm-btn {
    cursor: pointer;
    user-select: none;
    position: relative;
  }

  .delete-confirm-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<script>
  /**
   * Initialize delete confirm buttons
   * This script sets up the 2-step delete confirmation behavior with timer ring overlay
   */
  function initDeleteConfirmButtons() {
    // Track active timeouts to prevent memory leaks
    const activeTimeouts = new Map<string, number>();

    // Get timer ring SVG overlay - draws around the button
    function getTimerRingSvg(buttonSize: number, timeout: number): string {
      const size = buttonSize + 4; // Slightly larger than button
      const center = size / 2;
      const radius = center - 2; // Ring radius
      const circumference = 2 * Math.PI * radius;

      return `
        <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" fill="none" xmlns="http://www.w3.org/2000/svg" class="timer-ring-overlay">
          <circle 
            cx="${center}" 
            cy="${center}" 
            r="${radius}" 
            fill="none" 
            stroke="#ef4444" 
            stroke-width="2.5"
            stroke-dasharray="${circumference}"
            stroke-dashoffset="${circumference}"
            transform="rotate(-90 ${center} ${center})"
            class="timer-icon"
            style="--timer-duration: ${timeout}ms"
          />
        </svg>
      `;
    }

    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const button = target.closest(".delete-confirm-btn") as HTMLElement;

      if (!button) return;

      const buttonId = button.id;
      const timeout = parseInt(button.dataset.timeout || "3000", 10);
      const currentState = button.getAttribute("data-state") || "trash";

      // Get button size (assuming it's square for rounded-full buttons)
      const buttonRect = button.getBoundingClientRect();
      const buttonSize = Math.max(buttonRect.width, buttonRect.height);

      if (currentState === "trash") {
        // First click: Show timer ring overlay
        e.stopPropagation();

        // Add timer ring overlay
        const timerRingSvg = getTimerRingSvg(buttonSize, timeout);
        button.insertAdjacentHTML("beforeend", timerRingSvg);

        button.setAttribute("data-state", "confirm");
        button.title = "Click again to confirm deletion";

        // Clear any existing timeout for this button
        if (activeTimeouts.has(buttonId)) {
          clearTimeout(activeTimeouts.get(buttonId)!);
        }

        // Auto-revert after timeout
        const timeoutId = window.setTimeout(() => {
          if (button.getAttribute("data-state") === "confirm") {
            // Remove timer ring
            const timerOverlay = button.querySelector(".timer-ring-overlay");
            if (timerOverlay) {
              timerOverlay.remove();
            }

            button.setAttribute("data-state", "trash");
            button.title = "Delete";
            activeTimeouts.delete(buttonId);
          }
        }, timeout);

        activeTimeouts.set(buttonId, timeoutId);
      } else if (currentState === "confirm") {
        // Second click: Execute deletion
        e.stopPropagation();

        // Clear timeout
        if (activeTimeouts.has(buttonId)) {
          clearTimeout(activeTimeouts.get(buttonId)!);
          activeTimeouts.delete(buttonId);
        }

        // Remove timer ring
        const timerOverlay = button.querySelector(".timer-ring-overlay");
        if (timerOverlay) {
          timerOverlay.remove();
        }

        button.setAttribute("data-state", "trash");
        button.title = "Delete";

        // Dispatch custom event for parent to handle
        const deleteEvent = new CustomEvent("deleteConfirmed", {
          detail: { buttonId },
          bubbles: true,
          cancelable: true,
        });
        button.dispatchEvent(deleteEvent);
      }
    });
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDeleteConfirmButtons);
  } else {
    initDeleteConfirmButtons();
  }

  // Also initialize on Astro page transitions
  document.addEventListener("astro:page-load", initDeleteConfirmButtons);
</script>
