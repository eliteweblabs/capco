---
/**
 * DeleteConfirmButton Component
 * Reusable delete button with 2-step confirmation (no alerts)
 * Uses Button.astro and SimpleIcon for consistency
 *
 * Usage:
 * <DeleteConfirmButton
 *   id="delete-item-123"
 * />
 *
 * Behavior:
 * 1. First click: Shows timer icon for 3 seconds
 * 2. Second click within 3 seconds: Executes delete
 * 3. Auto-reverts to trash icon if not confirmed
 */

import Button from "./Button.astro";

export interface Props {
  id: string;
  class?: string;
  timeout?: number; // milliseconds, default 3000
  size?: "xs" | "sm" | "md" | "lg" | "xl"; // default "sm"
  variant?: "icon" | "button"; // default "icon"
  label?: string; // for button variant
  dataAttributes?: Record<string, string>; // custom data attributes
  itemType?: string; // type of item being deleted (for logging/analytics)
  apiEndpoint?: string; // API endpoint for deletion (for future use)
  onDeleteCallback?: string; // callback function name (for future use)
  tooltipText?: string; // custom tooltip text
  confirmTitle?: string; // custom confirmation title (for future use)
  confirmMessage?: string; // custom confirmation message (for future use)
}

const {
  id,
  class: className = "",
  timeout = 3000,
  size = "sm",
  variant = "icon",
  label = "Delete",
  dataAttributes = {},
  itemType,
  apiEndpoint,
  onDeleteCallback,
  tooltipText = "Delete",
  confirmTitle,
  confirmMessage,
} = Astro.props;

// Build button variant based on whether it's icon-only or with label
const buttonVariant = "ghost";

// Merge custom data attributes with internal ones
const mergedDataAttributes = {
  "data-state": "trash",
  "data-timeout": timeout.toString(),
  ...(itemType && { "data-item-type": itemType }),
  ...(apiEndpoint && { "data-api-endpoint": apiEndpoint }),
  ...(onDeleteCallback && { "data-callback": onDeleteCallback }),
  ...dataAttributes,
};
---

{
  variant === "icon" ? (
    <div class="delete-confirm-wrapper">
      <Button
        id={id}
        type="button"
        variant={buttonVariant}
        size={size}
        icon="trash"
        iconClasses="delete-confirm-icon"
        class={`delete-confirm-btn rounded-full ${className}`}
        title={tooltipText}
        dataAttributes={mergedDataAttributes}
      >
        <svg
          width="44"
          height="44"
          viewBox="0 0 44 44"
          fill="none"
          xmlns="http://www.w3.org/2000/svg"
          class="absolute top-0 left-0 timer-ring-overlay"
        >
          <circle
            cx="22"
            cy="22"
            r="18"
            fill="none"
            stroke="#ef4444"
            stroke-width="3"
            stroke-dasharray="113.1"
            stroke-dashoffset="113.1"
            transform="rotate(-90 22 22)"
            class="timer-icon-test"
          />
        </svg>
      </Button>
    </div>
  ) : (
    <Button
      id={id}
      type="button"
      variant={buttonVariant}
      size={size}
      icon="trash"
      class={`delete-confirm-btn ${className}`}
      title={tooltipText}
      dataAttributes={mergedDataAttributes}
    >
      {label}
    </Button>
  )
}

<style is:global>
  @keyframes draw-ring {
    from {
      stroke-dashoffset: 113.1;
    }
    to {
      stroke-dashoffset: 0;
    }
  }
</style>

<style>
  .delete-confirm-wrapper {
    position: relative;
    display: inline-flex;
  }

  .timer-ring-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 1;
    opacity: 0;
    transition: opacity 0.2s;
  }

  .delete-confirm-wrapper:has([data-state="confirm"]) .timer-ring-overlay {
    opacity: 1 !important;
  }

  .delete-confirm-wrapper:has([data-state="confirm"]) .timer-icon-test {
    animation: draw-ring 3000ms linear forwards;
  }

  /* Hide trash icon when in confirm state */
  .delete-confirm-wrapper [data-state="confirm"] .delete-confirm-icon {
    display: none;
  }

  .delete-confirm-btn {
    cursor: pointer;
    user-select: none;
    position: relative;
  }

  .delete-confirm-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
</style>

<script>
  /**
   * Initialize delete confirm buttons
   * Completely self-contained - handles API calls and callbacks
   */
  function initDeleteConfirmButtons() {
    console.log("[DeleteConfirmButton] üöÄ Initializing delete confirm buttons...");

    // Check how many buttons exist on page
    const buttons = document.querySelectorAll(".delete-confirm-btn");
    console.log(`[DeleteConfirmButton] Found ${buttons.length} delete buttons on page`);
    buttons.forEach((btn, idx) => {
      console.log(`[DeleteConfirmButton]   Button ${idx + 1}:`, btn.id, btn.className);
    });

    const activeTimeouts = new Map<string, number>();

    // Add click listener
    document.addEventListener("click", async (e) => {
      console.log("[DeleteConfirmButton] üñ±Ô∏è  Click detected anywhere on page");

      const target = e.target as HTMLElement;
      console.log("[DeleteConfirmButton]   Click target:", target.tagName, target.className);

      const button = target.closest(".delete-confirm-btn") as HTMLElement;
      console.log("[DeleteConfirmButton]   Closest button found:", button ? button.id : "NONE");

      if (!button) {
        console.log("[DeleteConfirmButton]   ‚ùå Not a delete button, ignoring");
        return;
      }

      console.log("[DeleteConfirmButton] ‚úÖ Delete button clicked:", button.id);

      const buttonId = button.id;
      const timeout = parseInt(button.dataset.timeout || "3000", 10);
      const currentState = button.getAttribute("data-state") || "trash";
      const apiEndpoint = button.dataset.apiEndpoint;
      const callbackName = button.dataset.callback;
      const itemType = button.dataset.itemType;

      console.log(
        "[DeleteConfirmButton] State:",
        currentState,
        "API:",
        apiEndpoint,
        "Callback:",
        callbackName,
        "ItemType:",
        itemType
      );

      if (currentState === "trash") {
        // First click: Show timer ring
        e.stopPropagation();
        console.log("[DeleteConfirmButton] üéØ FIRST CLICK - showing timer ring");

        // Find the wrapper and timer ring
        const wrapper = button.closest(".delete-confirm-wrapper") as HTMLElement;
        console.log("[DeleteConfirmButton]   Wrapper found:", wrapper ? "YES" : "NO");

        const timerRing = wrapper?.querySelector(".timer-ring-overlay") as HTMLElement;
        console.log("[DeleteConfirmButton]   Timer ring found:", timerRing ? "YES" : "NO");

        const timerCircle = timerRing?.querySelector(".timer-icon-test") as SVGCircleElement;
        console.log("[DeleteConfirmButton]   Timer circle found:", timerCircle ? "YES" : "NO");

        if (timerCircle) {
          console.log("[DeleteConfirmButton]   Resetting timer animation");
          // Reset animation by removing and re-adding class
          timerCircle.classList.remove("timer-icon-test");
          void (timerCircle as unknown as HTMLElement).offsetWidth; // Force reflow
          timerCircle.classList.add("timer-icon-test");
        }

        console.log("[DeleteConfirmButton]   Setting state to 'confirm'");
        button.setAttribute("data-state", "confirm");
        button.title = "Click again to confirm deletion";

        // Change icon to stopwatch
        const iconElement = button.querySelector(".delete-confirm-icon") as SVGElement;
        console.log("[DeleteConfirmButton]   Icon element found:", iconElement ? "YES" : "NO");

        if (iconElement) {
          console.log("[DeleteConfirmButton]   Changing icon to stopwatch");
          iconElement.outerHTML = `<svg class="inline-block stopwatch-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="13" r="8"/>
            <path d="M12 9v4l2 2"/>
            <path d="M10 2h4"/>
          </svg>`;
        }

        // Clear any existing timeout
        if (activeTimeouts.has(buttonId)) {
          console.log("[DeleteConfirmButton]   Clearing existing timeout");
          clearTimeout(activeTimeouts.get(buttonId)!);
        }

        // Auto-revert after timeout
        console.log(`[DeleteConfirmButton]   Setting ${timeout}ms auto-revert timeout`);
        const timeoutId = window.setTimeout(() => {
          if (button.getAttribute("data-state") === "confirm") {
            console.log("[DeleteConfirmButton] ‚è∞ Timeout expired, reverting button");
            resetButton(button);
            activeTimeouts.delete(buttonId);
          }
        }, timeout);

        activeTimeouts.set(buttonId, timeoutId);
        console.log("[DeleteConfirmButton] ‚úÖ First click complete - waiting for confirmation");
      } else if (currentState === "confirm") {
        // Second click: Execute deletion
        e.stopPropagation();
        console.log("[DeleteConfirmButton] üéØ SECOND CLICK - executing deletion");

        // Clear timeout
        if (activeTimeouts.has(buttonId)) {
          clearTimeout(activeTimeouts.get(buttonId)!);
          activeTimeouts.delete(buttonId);
        }

        // Reset button immediately
        resetButton(button);

        // Disable button during deletion
        button.setAttribute("disabled", "true");

        // Extract item ID from button ID
        // Expected format: delete-{itemType}-{id} or custom format
        const itemId = extractItemId(buttonId, itemType);

        if (!itemId) {
          console.error("[DeleteConfirmButton] Could not extract item ID from:", buttonId);
          button.removeAttribute("disabled");
          if ((window as any).showNotice) {
            (window as any).showNotice("error", "Delete Failed", "Invalid item ID");
          }
          return;
        }

        console.log("[DeleteConfirmButton] Extracted item ID:", itemId);

        // Call API if endpoint provided
        if (apiEndpoint) {
          try {
            console.log("[DeleteConfirmButton] Calling API:", apiEndpoint);

            const response = await fetch(apiEndpoint, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              credentials: "include",
              body: JSON.stringify({
                itemId: itemId,
                id: itemId, // Some APIs might expect 'id' instead
              }),
            });

            const data = await response.json();

            if (data.success || response.ok) {
              console.log("[DeleteConfirmButton] API call successful");

              // Call callback if provided
              if (callbackName && typeof (window as any)[callbackName] === "function") {
                console.log("[DeleteConfirmButton] Calling callback:", callbackName);
                await (window as any)[callbackName](itemId);
              } else {
                // Show default success message
                if ((window as any).showSuccess) {
                  (window as any).showSuccess(
                    "Deleted",
                    `${itemType || "Item"} deleted successfully`,
                    3000
                  );
                }
              }
            } else {
              console.error("[DeleteConfirmButton] API returned error:", data.error);
              if ((window as any).showNotice) {
                (window as any).showNotice(
                  "error",
                  "Delete Failed",
                  data.error || "Failed to delete item"
                );
              }
            }
          } catch (error) {
            console.error("[DeleteConfirmButton] API call failed:", error);
            if ((window as any).showNotice) {
              (window as any).showNotice(
                "error",
                "Delete Failed",
                "An error occurred while deleting"
              );
            }
          } finally {
            button.removeAttribute("disabled");
          }
        } else {
          // No API endpoint - just call callback or dispatch event
          console.log("[DeleteConfirmButton] No API endpoint, calling callback only");

          if (callbackName && typeof (window as any)[callbackName] === "function") {
            try {
              await (window as any)[callbackName](itemId);
            } catch (error) {
              console.error("[DeleteConfirmButton] Callback error:", error);
            }
          }

          button.removeAttribute("disabled");

          // Dispatch event for backward compatibility
          const deleteEvent = new CustomEvent("deleteConfirmed", {
            detail: { buttonId, itemId, itemType },
            bubbles: true,
            cancelable: true,
          });
          button.dispatchEvent(deleteEvent);
        }
      }
    });

    function resetButton(button: HTMLElement) {
      button.setAttribute("data-state", "trash");
      button.title = button.dataset.originalTitle || "Delete";

      // Restore trash icon
      const stopwatchIcon = button.querySelector(".stopwatch-icon") as SVGElement;
      if (stopwatchIcon) {
        stopwatchIcon.outerHTML = `<svg class="inline-block delete-confirm-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 6h18"></path>
          <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
          <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
          <path d="M10 11v6"></path>
          <path d="M14 11v6"></path>
        </svg>`;
      }
    }

    function extractItemId(buttonId: string, itemType?: string): number | null {
      // Try different patterns to extract ID

      // Pattern 1: delete-{itemType}-{id}
      if (itemType) {
        const pattern1 = new RegExp(`delete-${itemType}-(\\d+)`);
        const match1 = buttonId.match(pattern1);
        if (match1) {
          return parseInt(match1[1], 10);
        }
      }

      // Pattern 2: delete-{anything}-{id}
      const pattern2 = /delete-\w+-(\d+)$/;
      const match2 = buttonId.match(pattern2);
      if (match2) {
        return parseInt(match2[1], 10);
      }

      // Pattern 3: just the last number in the ID
      const pattern3 = /(\d+)$/;
      const match3 = buttonId.match(pattern3);
      if (match3) {
        return parseInt(match3[1], 10);
      }

      return null;
    }
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDeleteConfirmButtons);
  } else {
    initDeleteConfirmButtons();
  }

  // Also initialize on Astro page transitions
  document.addEventListener("astro:page-load", initDeleteConfirmButtons);
</script>
