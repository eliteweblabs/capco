---
/**
 * DeleteConfirmButton Component
 * Reusable delete button with 2-step confirmation (no alerts)
 * Uses Button.astro and SimpleIcon for consistency
 * 
 * Usage:
 * <DeleteConfirmButton
 *   id="delete-item-123"
 * />
 * 
 * Behavior:
 * 1. First click: Shows timer icon for 3 seconds
 * 2. Second click within 3 seconds: Executes delete
 * 3. Auto-reverts to trash icon if not confirmed
 */

import Button from "./Button.astro";

export interface Props {
  id: string;
  class?: string;
  timeout?: number; // milliseconds, default 3000
  size?: "xs" | "sm" | "md" | "lg" | "xl"; // default "sm"
  variant?: "icon" | "button"; // default "icon"
  label?: string; // for button variant
}

const { 
  id, 
  class: className = "",
  timeout = 3000,
  size = "sm",
  variant = "icon",
  label = "Delete"
} = Astro.props;

// Build button variant based on whether it's icon-only or with label
const buttonVariant = "danger";
---

{variant === "icon" ? (
  <Button
    id={id}
    type="button"
    variant={buttonVariant}
    size={size}
    icon="trash"
    iconClasses="delete-confirm-icon"
    class={`delete-confirm-btn rounded-full ${className}`}
    title="Delete"
    dataAttributes={{
      "data-state": "trash",
      "data-timeout": timeout.toString(),
    }}
  />
) : (
  <Button
    id={id}
    type="button"
    variant={buttonVariant}
    size={size}
    icon="trash"
    class={`delete-confirm-btn ${className}`}
    title="Delete"
    dataAttributes={{
      "data-state": "trash",
      "data-timeout": timeout.toString(),
    }}
  >
    {label}
  </Button>
)}

<style>
  @keyframes spin-timer {
    from {
      stroke-dashoffset: 62.83;
    }
    to {
      stroke-dashoffset: 0;
    }
  }

  .timer-icon {
    animation: spin-timer var(--timer-duration, 3000ms) linear infinite;
  }

  .delete-confirm-btn {
    cursor: pointer;
    user-select: none;
  }

  .delete-confirm-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  .timer-question {
    mix-blend-mode: difference;
  }
</style>

<script>
  import { getIcon } from "../../lib/simple-icons";

  /**
   * Initialize delete confirm buttons
   * This script sets up the 2-step delete confirmation behavior
   */
  function initDeleteConfirmButtons() {
    // Track active timeouts to prevent memory leaks
    const activeTimeouts = new Map<string, number>();

    // Icon size mapping to match Button.astro
    const iconSizeMap = {
      xs: 12,
      sm: 16,
      md: 20,
      lg: 24,
      xl: 32
    };

    // Get timer SVG
    function getTimerSvg(size: number, timeout: number): string {
      return `
        <svg width="${size}" height="${size}" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="inline-block">
          <circle 
            cx="12" 
            cy="12" 
            r="10" 
            fill="transparent" 
            stroke="white" 
            stroke-width="2.5"
            stroke-dasharray="62.83"
            stroke-dashoffset="62.83"
            stroke-linecap="round"
            transform="rotate(-90 12 12)"
            class="timer-icon"
            style="--timer-duration: ${timeout}ms"
          />
          <text 
            x="12" 
            y="18" 
            text-anchor="middle" 
            font-size="22" 
            font-weight="bold" 
            fill="currentColor"
            class="timer-question"
          >?</text>
        </svg>
      `;
    }

    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const button = target.closest(".delete-confirm-btn") as HTMLElement;
      
      if (!button) return;

      const buttonId = button.id;
      const timeout = parseInt(button.dataset.timeout || "3000", 10);
      const currentState = button.getAttribute("data-state") || "trash";

      // Find the icon container (SimpleIcon or direct SVG)
      const iconContainer = button.querySelector(".delete-confirm-icon")?.parentElement || button.querySelector("svg")?.parentElement || button;
      
      // Determine icon size from button size classes
      let iconSize = 16; // default sm
      if (button.classList.contains("text-xs")) iconSize = iconSizeMap.xs;
      else if (button.classList.contains("text-sm")) iconSize = iconSizeMap.sm;
      else if (button.classList.contains("text-base")) iconSize = iconSizeMap.md;
      else if (button.classList.contains("text-lg")) iconSize = iconSizeMap.lg;
      else if (button.classList.contains("text-xl")) iconSize = iconSizeMap.xl;

      if (currentState === "trash") {
        // First click: Show confirmation timer
        e.stopPropagation();
        
        // Replace icon with timer
        const timerSvg = getTimerSvg(iconSize, timeout);
        if (iconContainer) {
          iconContainer.innerHTML = timerSvg;
        }
        
        button.setAttribute("data-state", "confirm");
        button.title = "Click again to confirm deletion";
        
        // Update classes for confirm state (white background, red text)
        button.classList.remove("bg-red-500", "text-white", "hover:bg-red-600");
        button.classList.add("bg-white", "text-red-600", "hover:bg-red-600", "hover:text-white");

        // Clear any existing timeout for this button
        if (activeTimeouts.has(buttonId)) {
          clearTimeout(activeTimeouts.get(buttonId)!);
        }

        // Auto-revert after timeout
        const timeoutId = window.setTimeout(() => {
          if (button.getAttribute("data-state") === "confirm") {
            // Restore trash icon
            const trashSvg = getIcon("trash", { size: iconSize, className: "delete-confirm-icon" });
            if (iconContainer) {
              iconContainer.innerHTML = trashSvg;
            }
            
            button.setAttribute("data-state", "trash");
            button.title = "Delete";
            
            // Restore original classes
            button.classList.remove("bg-white", "text-red-600", "hover:text-white");
            button.classList.add("bg-red-500", "text-white", "hover:bg-red-600");
            activeTimeouts.delete(buttonId);
          }
        }, timeout);

        activeTimeouts.set(buttonId, timeoutId);
      } else if (currentState === "confirm") {
        // Second click: Execute deletion
        e.stopPropagation();
        
        // Clear timeout
        if (activeTimeouts.has(buttonId)) {
          clearTimeout(activeTimeouts.get(buttonId)!);
          activeTimeouts.delete(buttonId);
        }

        // Restore trash icon
        const trashSvg = getIcon("trash", { size: iconSize, className: "delete-confirm-icon" });
        if (iconContainer) {
          iconContainer.innerHTML = trashSvg;
        }
        
        button.setAttribute("data-state", "trash");
        button.title = "Delete";
        
        // Restore original classes
        button.classList.remove("bg-white", "text-red-600", "hover:text-white");
        button.classList.add("bg-red-500", "text-white", "hover:bg-red-600");

        // Dispatch custom event for parent to handle
        const deleteEvent = new CustomEvent("deleteConfirmed", {
          detail: { buttonId },
          bubbles: true,
          cancelable: true
        });
        button.dispatchEvent(deleteEvent);
      }
    });
  }

  // Initialize on DOM ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDeleteConfirmButtons);
  } else {
    initDeleteConfirmButtons();
  }

  // Also initialize on Astro page transitions
  document.addEventListener("astro:page-load", initDeleteConfirmButtons);
</script>
