---
import SimpleIcon from "./SimpleIcon.astro";
import Button from "./Button.astro";
import { checkAuth } from "../../lib/auth";
import Tooltip from "./TooltipFloating.astro";
import AssignedProjects from "../common/AssignedProjects.astro";
import CloseButton from "../ui/CloseButton.astro";

interface Props {
  currentUser: any;
  session: any;
  isBackend?: boolean;
  projects: any[];
  globalIconButtonClasses?: string;
}

const { currentUser, session, isBackend, projects, globalIconButtonClasses } = Astro.props;
const currentRole = currentUser?.profile?.role;

// Get current path to determine auth link
const currentPath = Astro.url.pathname;
const isLoginPage = currentPath.includes("/auth/login");
const isRegisterPage = currentPath.includes("/auth/register");

// Determine auth link and tooltip text
const authLink = isLoginPage ? "/auth/register" : "/auth/login";
const authTooltipText = isLoginPage ? "Register" : isRegisterPage ? "Login" : "Register / Login";

// Prioritize profile.avatarUrl (Supabase Storage) over user_metadata.avatarUrl (Google CDN)
const avatarUrl =
  currentUser?.profile?.avatarUrl ||
  currentUser?.user_metadata?.avatarUrl ||
  currentUser?.user_metadata?.picture;
---

{
  currentUser ? (
    <a
      href="#"
      data-dropdown-toggle="account-dropdown"
      aria-expanded="false"
      data-dropdown-trigger="click"
      data-avatar-url={avatarUrl}
      class={globalIconButtonClasses}
    >
      <span class="sr-only">Open user menu</span>
      {/* <!-- Fallback icon (visible initially, hidden if avatar loads) --> */}
      {avatarUrl && avatarUrl !== "" ? (
        <SimpleIcon
          name="user"
          class="avatar-fallback"
          size="md"
          class="text-black dark:text-white"
        />
      ) : (
        <SimpleIcon name="user" size="md" />
      )}
    </a>
  ) : (
    // <Button href="/auth/login" variant="anchor" size="xs">
    <a href={authLink} title={authTooltipText} class={globalIconButtonClasses}>
      <Tooltip text={authTooltipText} position="bottom" touchable={false}>
        <SimpleIcon name="user" size="md" />
        <span class="sr-only">{authTooltipText}</span>
      </Tooltip>
    </a>
  )
}

<script>
  // Handle Google avatar loading errors and rate limiting (429 errors)
  // Page size toggle is initialized in UserProfileDropdown.astro
  document.addEventListener("DOMContentLoaded", () => {
    const avatarButton = document.querySelector(".avatar-button");

    if (avatarButton) {
      const avatarUrl = avatarButton.getAttribute("data-avatar-url");
      const fallbackIcon = avatarButton.querySelector(".avatar-fallback");

      if (avatarUrl && fallbackIcon) {
        // Test if the image can load BEFORE applying it
        const img = new Image();

        img.onload = () => {
          console.log("✅ [AUTH-ICON] Avatar loaded successfully");

          // Avatar loaded successfully - apply it as background and hide fallback
          (avatarButton as HTMLElement).style.backgroundImage = `url('${avatarUrl}')`;
          (avatarButton as HTMLElement).style.backgroundSize = "cover";
          (avatarButton as HTMLElement).style.backgroundPosition = "center";
          (avatarButton as HTMLElement).style.backgroundRepeat = "no-repeat";
          (fallbackIcon as HTMLElement).style.display = "none";
        };

        img.onerror = () => {
          console.warn(
            "⚠️ [AUTH-ICON] Avatar failed to load (likely Google rate limit 429), keeping fallback icon"
          );
          // Do nothing - fallback icon is already visible
        };

        // Start loading the image
        img.src = avatarUrl;
      }
    }
  });
</script>
