---
import SimpleIcon from "./SimpleIcon.astro";

interface Props {
  currentUser: any;
  session: any;
  isBackend?: boolean;
  projects: any[];
  globalIconButtonClasses?: string;
  id: string;
}

const {
  currentUser,
  session,
  isBackend,
  projects,
  globalIconButtonClasses,
  id = "account",
} = Astro.props;

import UserProfileDropdown from "../ui/UserProfileDropdown.astro";

// Get current path to determine auth link
const currentPath = Astro.url.pathname;
const isLoginPage = currentPath.includes("/auth/login");
const isRegisterPage = currentPath.includes("/auth/register");

// Determine auth link and tooltip text
// const authLink = isLoginPage ? "/auth/register" : "/auth/login";
// const authTooltipText = isLoginPage ? "Register" : isRegisterPage ? "Login" : "Register / Login";

// Prioritize profile.avatarUrl (Supabase Storage) over user_metadata.avatarUrl (Google CDN)
const avatarUrl =
  currentUser?.profile?.avatarUrl ||
  currentUser?.user_metadata?.avatarUrl ||
  currentUser?.user_metadata?.picture;
---

<button
  class={`avatar-button ${globalIconButtonClasses || ""}`.trim()}
  data-popover-trigger="click"
  data-popover-target={`${id}-dropdown`}
  data-avatar-url={avatarUrl}
  data-refresh="true"
  data-meta="avatarUrl"
  data-meta-value={avatarUrl}
  data-user-id={currentUser?.id}
  data-project-id={currentUser?.projectId}
  type="button"
>
  <span class="sr-only">Open user menu</span>
  {/* <!-- Fallback icon (visible initially, hidden if avatar loads) --> */}
  {
    avatarUrl && avatarUrl !== "" ? (
      <SimpleIcon name="user" class="avatar-fallback text-black dark:text-white" size="md" />
    ) : (
      <SimpleIcon name="user" size="md" />
    )
  }
</button>

<UserProfileDropdown
  id={id}
  {globalIconButtonClasses}
  {projects}
  {currentUser}
  closeButton={false}
/>
<script>
  function applyAvatarToButton(button, urlOrUndefined) {
    const avatarUrl =
      urlOrUndefined != null ? urlOrUndefined : button.getAttribute("data-avatar-url");
    const fallbackIcon = button.querySelector(".avatar-fallback");
    if (!avatarUrl || !fallbackIcon) return;

    const img = new Image();
    img.onload = () => {
      console.log("✅ [AUTH-ICON] Avatar loaded successfully");
      button.style.backgroundImage = `url('${avatarUrl}')`;
      button.style.backgroundSize = "cover";
      button.style.backgroundPosition = "center";
      button.style.backgroundRepeat = "no-repeat";
      fallbackIcon.style.visibility = "hidden";
      fallbackIcon.style.opacity = "0";
      fallbackIcon.style.pointerEvents = "none";
      fallbackIcon.style.userSelect = "none";
      fallbackIcon.style.webkitUserSelect = "none";
    };
    img.onerror = () => {
      console.warn("⚠️ [AUTH-ICON] Avatar failed to load, keeping fallback icon");
    };
    img.src = avatarUrl;
  }

  function refreshAuthAvatar(newUrl) {
    document.querySelectorAll(".avatar-button").forEach((btn) => {
      const url = newUrl ?? btn.getAttribute("data-avatar-url");
      btn.setAttribute("data-avatar-url", url || "");
      btn.setAttribute("data-meta-value", url || "");
      if (!url) {
        btn.style.backgroundImage = "";
        const fallback = btn.querySelector(".avatar-fallback");
        if (fallback) {
          fallback.style.visibility = "";
          fallback.style.opacity = "";
          fallback.style.pointerEvents = "";
        }
      } else {
        applyAvatarToButton(btn, url);
      }
    });
  }

  window.refreshAuthAvatar = refreshAuthAvatar;

  document.addEventListener("DOMContentLoaded", () => {
    document
      .querySelectorAll(".avatar-button")
      .forEach((btn) => applyAvatarToButton(btn, undefined));
  });

  document.addEventListener("avatarUpdated", (e) => {
    const url = e instanceof CustomEvent && e.detail ? e.detail.avatarUrl : undefined;
    refreshAuthAvatar(url);
  });
</script>
