---
import SimpleIcon from "./SimpleIcon.astro";

interface Props {
  currentUser: any;
  session: any;
  isBackend?: boolean;
  projects: any[];
  globalIconButtonClasses?: string;
  id: string;
}

const {
  currentUser,
  session,
  isBackend,
  projects,
  globalIconButtonClasses,
  id = "account",
} = Astro.props;

import UserProfileDropdown from "../ui/UserProfileDropdown.astro";

// Get current path to determine auth link
const currentPath = Astro.url.pathname;
const isLoginPage = currentPath.includes("/auth/login");
const isRegisterPage = currentPath.includes("/auth/register");

if (isLoginPage || isRegisterPage) {
  return;
}

// Determine auth link and tooltip text
// const authLink = isLoginPage ? "/auth/register" : "/auth/login";
// const authTooltipText = isLoginPage ? "Register" : isRegisterPage ? "Login" : "Register / Login";

// Prioritize profile.avatarUrl (Supabase Storage) over user_metadata.avatarUrl (Google CDN)
const avatarUrl =
  currentUser?.profile?.avatarUrl ||
  currentUser?.user_metadata?.avatarUrl ||
  currentUser?.user_metadata?.picture;
---

<button
  class={`h-8 w-8 overflow-hidden rounded-full ${globalIconButtonClasses || ""}`.trim()}
  data-popover-trigger="click"
  data-popover-target={`${id}-dropdown`}
  data-avatar-url={avatarUrl || ""}
  data-user-id={currentUser?.id}
  data-project-id={currentUser?.projectId}
  type="button"
  style="padding: 0;"
>
  <span class="sr-only">Open user menu</span>
  <img
    src={avatarUrl || undefined}
    alt="Profile"
    class="avatar-img h-full w-full min-w-0 object-cover object-center p-0"
    style={!avatarUrl ? "display:none" : undefined}
    onerror="this.style.display='none'; const f=this.nextElementSibling; if(f) { f.classList.remove('hidden'); f.classList.add('flex'); }"
  />
  <span
    class:list={[
      "avatar-fallback",
      "h-full",
      "w-full",
      "items-center",
      "justify-center",
      avatarUrl ? "hidden" : "flex",
    ]}
    aria-hidden="true"
  >
    <SimpleIcon name="user" size="md" />
  </span>
</button>

<UserProfileDropdown
  id={id}
  {globalIconButtonClasses}
  {projects}
  {currentUser}
  closeButton={false}
/>
<script>
  /**
   * Refresh avatar img src across all [data-avatar-url] elements.
   * Uses <img> for content manipulation; works for AuthIcon and any avatar using this pattern.
   * @param newUrl - New avatar URL, or empty string to clear. Omit to re-apply current data-avatar-url.
   * @param userId - Optional: only update elements with matching data-user-id
   */
  function refreshAvatar(newUrl?: string, userId?: string) {
    document.querySelectorAll("[data-avatar-url]").forEach((container) => {
      if (userId && container.getAttribute("data-user-id") !== userId) return;

      const url = newUrl !== undefined ? newUrl || "" : container.getAttribute("data-avatar-url");
      container.setAttribute("data-avatar-url", url || "");

      const img = container.querySelector("img");
      const fallback = container.querySelector(".avatar-fallback");

      if (!url) {
        if (img instanceof HTMLImageElement) {
          img.removeAttribute("src");
          img.style.display = "none";
        }
        if (fallback instanceof HTMLElement) {
          fallback.classList.remove("hidden");
          fallback.classList.add("flex");
          fallback.style.display = "";
        }
      } else if (img instanceof HTMLImageElement) {
        img.src = url;
        img.style.display = "";
        if (fallback instanceof HTMLElement) {
          fallback.classList.add("hidden");
          fallback.style.display = "none";
        }
      }
    });
  }

  (window as any).refreshAvatar = refreshAvatar;

  document.addEventListener("avatarUpdated", (e) => {
    const url = e instanceof CustomEvent && e.detail ? e.detail.avatarUrl : undefined;
    refreshAvatar(url, undefined);
  });
</script>
