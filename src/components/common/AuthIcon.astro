---
import UserIcon from "../ui/UserIcon.astro";
import UserDropdown from "../ui/UserDropdown.astro";
import UserDrawer from "../ui/UserDrawer.astro";

/**
 * Auth/profile icon for the navbar. Combines UserIcon (visual) with UserDropdown.
 * Use UserIcon.astro elsewhere when you need only the visual avatar (e.g. project dashboard).
 */
interface Props {
  currentUser: any;
  session: any;
  isBackend?: boolean;
  assignedProjectsCount?: number;
  assignedProjectsPreview?: any[];
  globalIconButtonClasses?: string;
  id: string;
}

const {
  currentUser,
  session,
  isBackend,
  assignedProjectsCount = 0,
  assignedProjectsPreview = [],
  globalIconButtonClasses,
  id = "account",
} = Astro.props;

const currentPath = Astro.url.pathname;
const isLoginPage = currentPath.includes("/auth/login");
const isRegisterPage = currentPath.includes("/auth/register");

if (isLoginPage || isRegisterPage) {
  return;
}

const avatarUrl =
  currentUser?.profile?.avatarUrl ||
  currentUser?.user_metadata?.avatarUrl ||
  currentUser?.user_metadata?.picture;
---

<button
  class={`auth-icon-trigger relative h-10 w-10 overflow-hidden rounded-full ${globalIconButtonClasses || ""}`.trim()}
  {...currentUser
    ? {
        "data-drawer-target": "user",
        "data-drawer-show": "user",
        "data-drawer-placement": "right",
        "aria-controls": "user",
      }
    : {
        "data-popover-trigger": "click",
        "data-popover-target": `${id}-dropdown`,
        "data-popover-placement": "bottom",
      }}
  data-avatar-url={avatarUrl || ""}
  data-user-id={currentUser?.id}
  data-project-id={currentUser?.projectId}
  type="button"
  style="padding: 0;"
>
  <span class="sr-only">Open user menu</span>
  <span class="auth-icon-default flex h-full w-full items-center justify-center" aria-hidden="true">
    <UserIcon user={currentUser} class="h-full w-full" />
  </span>
  {
    !currentUser && (
      <span
        class="auth-icon-close absolute inset-0 flex items-center justify-center transition-opacity"
        aria-hidden="true"
        style="opacity: 0; pointer-events: none;"
      >
        <svg
          class="h-5 w-5"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M6 18L18 6M6 6l12 12"
          />
        </svg>
      </span>
    )
  }
</button>

{
  !currentUser ? (
    <UserDropdown
      {id}
      {globalIconButtonClasses}
      {assignedProjectsCount}
      {assignedProjectsPreview}
      {currentUser}
    />
  ) : (
    <UserDrawer {currentUser} {assignedProjectsCount} {assignedProjectsPreview} />
  )
}
<script>
  /**
   * Refresh avatar img src across all [data-avatar-url] elements.
   * Uses <img> for content manipulation; works for AuthIcon and any avatar using this pattern.
   * @param newUrl - New avatar URL, or empty string to clear. Omit to re-apply current data-avatar-url.
   * @param userId - Optional: only update elements with matching data-user-id
   */
  function refreshAvatar(newUrl?: string, userId?: string) {
    document.querySelectorAll("[data-avatar-url]").forEach((container) => {
      if (userId && container.getAttribute("data-user-id") !== userId) return;

      const url = newUrl !== undefined ? newUrl || "" : container.getAttribute("data-avatar-url");
      container.setAttribute("data-avatar-url", url || "");

      const img = container.querySelector("img");
      const fallback = container.querySelector(".avatar-fallback");

      if (!url) {
        if (img instanceof HTMLImageElement) {
          img.removeAttribute("src");
          img.style.display = "none";
        }
        if (fallback instanceof HTMLElement) {
          fallback.classList.remove("hidden");
          fallback.classList.add("flex");
          fallback.style.display = "";
        }
      } else if (img instanceof HTMLImageElement) {
        img.src = url;
        img.style.display = "";
        if (fallback instanceof HTMLElement) {
          fallback.classList.add("hidden");
          fallback.style.display = "none";
        }
      }
    });
  }

  (window as any).refreshAvatar = refreshAvatar;

  document.addEventListener("avatarUpdated", (e) => {
    const url = e instanceof CustomEvent && e.detail ? e.detail.avatarUrl : undefined;
    refreshAvatar(url, undefined);
  });

  // When popover is open, show X on trigger; when closed, show avatar. Wire X to close popover.
  function wireAuthIconClose() {
    document.querySelectorAll(".auth-icon-close").forEach((closeEl) => {
      const trigger = closeEl.closest("[data-popover-target]");
      if (!trigger || !(closeEl instanceof HTMLElement)) return;
      const panelId = trigger.getAttribute("data-popover-target");
      const panel = panelId ? document.getElementById(panelId) : null;
      if (!panel) return;

      function closePopover() {
        const inst = (window as any).FlowbiteInstances?.getInstance?.("Popover", panelId);
        if (inst && typeof inst.hide === "function") {
          inst.hide();
        } else {
          panel.classList.add("opacity-0", "invisible");
          setTimeout(() => panel.classList.add("hidden"), 150);
        }
      }

      closeEl.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        closePopover();
      });

      function updateTrigger(isOpen: boolean) {
        const defaultEl = trigger.querySelector(".auth-icon-default");
        if (defaultEl instanceof HTMLElement && closeEl instanceof HTMLElement) {
          if (isOpen) {
            defaultEl.style.opacity = "0";
            defaultEl.style.pointerEvents = "none";
            closeEl.style.opacity = "1";
            closeEl.style.pointerEvents = "auto";
          } else {
            defaultEl.style.opacity = "1";
            defaultEl.style.pointerEvents = "auto";
            closeEl.style.opacity = "0";
            closeEl.style.pointerEvents = "none";
          }
        }
      }
      const observer = new MutationObserver(() => {
        const isOpen =
          !panel.classList.contains("hidden") && !panel.classList.contains("invisible");
        updateTrigger(isOpen);
      });
      observer.observe(panel, { attributes: true, attributeFilter: ["class"] });
      updateTrigger(!panel.classList.contains("hidden") && !panel.classList.contains("invisible"));
    });
  }
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", wireAuthIconClose);
  } else {
    wireAuthIconClose();
  }
</script>
