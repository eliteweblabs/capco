---
// Hero section component
// Supports both direct Astro props AND flat shortcode props
import SimpleIcon from "./SimpleIcon.astro";
import Button from "./Button.astro";

interface ButtonProps {
  text: string;
  href: string;
  icon?: string;
  variant?: "primary" | "secondary" | "outline";
}

interface Props {
  title: string;
  /** DB field name for refresh (e.g. "companyName"). Enables polling when combined with context. */
  titleRefreshField?: string;
  /** Raw value for change detection - must match API response format. */
  titleRefreshValue?: string | null;
  /** User ID for user-context polling (profiles table) */
  titleRefreshUserId?: string;
  /** Project ID for project-context polling */
  titleRefreshProjectId?: string;
  /** Suffix for display (e.g. "'s Profile") - appended to refreshed value */
  titleRefreshSuffix?: string;
  description: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  globalInputClasses?: string;
  backgroundImage?: string;
  backgroundOverlay?: boolean | string;
  overlayOpacity?: number | string;
  /** When set, uses adaptive video as background. Use base name (e.g. "uhd_30fps") for local /videos/, or full URL (e.g. Supabase) for remote. */
  backgroundVideoSource?: string;
  backgroundVideoPoster?: string;
  backgroundVideoAlt?: string;
  // Object-based button props (for direct Astro usage)
  leftButton?: ButtonProps;
  rightButton?: ButtonProps;
  // Flat shortcode props (for CMS shortcode usage)
  leftButtonText?: string;
  leftButtonHref?: string;
  leftButtonIcon?: string;
  leftButtonVariant?: string;
  rightButtonText?: string;
  rightButtonHref?: string;
  rightButtonIcon?: string;
  rightButtonVariant?: string;
}

const props = Astro.props;

// Default demo content
const defaultTitle = "Welcome to Our Platform";
const defaultDescription =
  "Build amazing solutions with our comprehensive tools and dedicated support.";

// Destructure with support for both formats
const {
  title = defaultTitle,
  titleRefreshField,
  titleRefreshValue,
  titleRefreshUserId,
  titleRefreshProjectId,
  titleRefreshSuffix,
  description = defaultDescription,
  primaryTextClasses,
  secondaryTextClasses,
  globalInputClasses,
  backgroundImage,
  backgroundVideoSource,
  backgroundVideoPoster = backgroundImage || "/hero.png",
  backgroundVideoAlt = "Hero background",
} = props;

// Handle boolean/string conversion for shortcode compatibility
const backgroundOverlay =
  props.backgroundOverlay === "false" ? false : (props.backgroundOverlay ?? true);
const overlayOpacity =
  typeof props.overlayOpacity === "string"
    ? parseFloat(props.overlayOpacity)
    : (props.overlayOpacity ?? 0.5);

// Build button objects from either format
const leftButton: ButtonProps | undefined =
  props.leftButton ||
  (props.leftButtonText
    ? {
        text: props.leftButtonText,
        href: props.leftButtonHref || "#",
        icon: props.leftButtonIcon,
        variant: (props.leftButtonVariant as "primary" | "secondary" | "outline") || "primary",
      }
    : undefined);

const rightButton: ButtonProps | undefined =
  props.rightButton ||
  (props.rightButtonText
    ? {
        text: props.rightButtonText,
        href: props.rightButtonHref || "#",
        icon: props.rightButtonIcon,
        variant: (props.rightButtonVariant as "primary" | "secondary" | "outline") || "secondary",
      }
    : undefined);

const hasButtons = leftButton || rightButton;
const hasBackground = backgroundImage || backgroundVideoSource;

---

<div
  class={`col-span-12 py-8 md:py-12 w-max-w-7xl mx-auto relative overflow-hidden ${hasBackground ? "min-h-[400px] flex items-center" : ""}`}
  data-aos="fade-up"
  data-aos-duration="600"
  style={backgroundImage && !backgroundVideoSource
    ? `background-image: url('${backgroundImage}'); background-size: cover; background-position: center;`
    : ""}
>
  {/* Adaptive video background when backgroundVideoSource is set */}
  {
    backgroundVideoSource && (
      <div class="hero-adaptive-video-container absolute inset-0 h-full w-full">
        <video
          class="hero-adaptive-video absolute inset-0 h-full w-full object-cover"
          data-video-source={backgroundVideoSource}
          data-poster={backgroundVideoPoster}
          data-alt={backgroundVideoAlt}
          autoplay
          muted
          loop
          playsinline
          poster={backgroundVideoPoster}
        >
          <img
            src={backgroundVideoPoster}
            alt={backgroundVideoAlt}
            class="absolute inset-0 h-full w-full object-cover"
          />
        </video>
      </div>
    )
  }
  {
    (backgroundImage || backgroundVideoSource) && backgroundOverlay && (
      <div class="absolute inset-0 bg-black" style={`opacity: ${overlayOpacity};`} />
    )
  }

  <div class={`mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 ${hasBackground ? "relative z-10" : ""}`}>
    <div class="text-center">
      <!-- Main Headline -->
      <h1
        class={`${primaryTextClasses || ""} md:text-6xl sm:text-3xl text-2xl font-bold ${hasBackground ? "text-white" : ""}`}
        {...titleRefreshField && {
          "data-refresh": titleRefreshField,
          "data-meta-value": titleRefreshValue ?? title ?? "",
          ...(titleRefreshUserId && { "data-user-id": titleRefreshUserId }),
          ...(titleRefreshProjectId && { "data-project-id": String(titleRefreshProjectId) }),
          ...(titleRefreshSuffix && { "data-refresh-suffix": titleRefreshSuffix }),
        }}
      >
        {title}
      </h1>
      {
        description && (
          <h2
            id="page-subtitle"
            class={`mt-6 text-xl ${hasBackground ? "text-gray-200" : "text-black dark:text-white"}`}
            set:html={description}
          />
        )
      }

      {
        hasButtons && (
          <div class="mt-8 flex flex-col items-center justify-center gap-4 sm:flex-row">
            {leftButton && (
              <Button href={leftButton.href} variant={leftButton.variant} icon={leftButton.icon}>
                {leftButton.text}
              </Button>
            )}
            {rightButton && (
              <Button href={rightButton.href} variant={rightButton.variant} icon={rightButton.icon}>
                {rightButton.text}
              </Button>
            )}
          </div>
        )
      }
    </div>
  </div>
</div>

{
  backgroundVideoSource && (
    <script is:inline>
      (function () {
        const initHeroAdaptiveVideo = async (videoEl) => {
          if (videoEl.dataset.heroVideoInitialized === "true") return;
          videoEl.dataset.heroVideoInitialized = "true";

          const videoSource = videoEl.getAttribute("data-video-source") || "uhd_30fps";
          const posterUrl = videoEl.getAttribute("data-poster") || "/hero.png";

          const isFullUrl = videoSource.startsWith("http://") || videoSource.startsWith("https://");
          const videoQualities = isFullUrl
            ? { low: videoSource, medium: videoSource, high: videoSource, original: videoSource }
            : {
                low: `/videos/${videoSource}_low.mp4`,
                medium: `/videos/${videoSource}_medium.mp4`,
                high: `/videos/${videoSource}_high.mp4`,
                original: `/videos/${videoSource}.mp4`,
              };

          let connectionSpeed = "unknown";
          try {
            if ("connection" in navigator) {
              const conn = navigator.connection;
              switch (conn.effectiveType) {
                case "slow-2g":
                case "2g":
                  connectionSpeed = "slow";
                  break;
                case "3g":
                  connectionSpeed = "medium";
                  break;
                case "4g":
                  connectionSpeed = "fast";
                  break;
              }
            } else {
              const start = performance.now();
              const r = await fetch("/hero.png", { method: "HEAD", cache: "no-cache" });
              if (r.ok) {
                const dur = performance.now() - start;
                connectionSpeed = dur < 100 ? "fast" : dur < 500 ? "medium" : "slow";
              }
            }
          } catch (_) {}

          const isMobile =
            (typeof window.isAnyMobile === "function" && window.isAnyMobile()) ||
            window.innerWidth < 768;
          let quality;
          if (isMobile) {
            quality =
              connectionSpeed === "fast"
                ? "medium"
                : connectionSpeed === "medium"
                  ? "low"
                  : "low";
          } else {
            quality =
              connectionSpeed === "fast"
                ? "high"
                : connectionSpeed === "medium"
                  ? "medium"
                  : connectionSpeed === "slow"
                    ? "low"
                    : "medium";
          }

          const src = videoQualities[quality];
          if (!src) return;
          const source = document.createElement("source");
          source.src = src;
          source.type = "video/mp4";
          videoEl.innerHTML = "";
          videoEl.appendChild(source);
          const img = document.createElement("img");
          img.src = posterUrl;
          img.alt = videoEl.getAttribute("data-alt") || "Hero background";
          img.className = "absolute inset-0 h-full w-full object-cover";
          videoEl.appendChild(img);
          videoEl.load();
        };

        document.addEventListener("DOMContentLoaded", () => {
          document.querySelectorAll(".hero-adaptive-video").forEach((el) => {
            initHeroAdaptiveVideo(el);
          });
        });
      })();
    </script>
  )
}
