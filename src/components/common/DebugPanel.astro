---
// Debug Panel Component - Admin Only
// Shows all App component parameters in an accordion modal

import CloseButton from "../ui/CloseButton.astro";

interface Props {
  debugData?: Record<string, any>;
  currentRole?: string;
}

const { debugData, currentRole } = Astro.props;

// Only show for Admin users
const isAdmin = currentRole === "Admin";

if (!isAdmin) {
  // Return empty component for non-admin users
  return;
}

// Helper function to format values for display
function formatValue(value: any): string {
  if (value === null) return "null";
  if (value === undefined) return "undefined";
  if (typeof value === "boolean") return value.toString();
  if (typeof value === "string") return `"${value}"`;
  if (typeof value === "number") return value.toString();
  if (typeof value === "object") {
    try {
      return JSON.stringify(value, null, 2);
    } catch {
      return "[Object - cannot stringify]";
    }
  }
  return String(value);
}

// Get data type for styling
function getDataType(value: any): string {
  if (value === null) return "null";
  if (value === undefined) return "undefined";
  if (Array.isArray(value)) return "array";
  return typeof value;
}

// Group data by categories
const categories = {
  "Basic Info": ["title", "description", "currentUrl"],
  "User & Auth": ["currentUser", "session", "isAuth", "currentUserId", "currentRole"],
  "Project Data": ["project", "projectId", "projects"],
  "System Config": ["supabase", "supabaseUrl", "isBackend"],
  Navigation: ["navigationData", "desktopNavigationHTML", "visibleNavItems"],
  Other: [],
};

// Categorize the debug data
const categorizedData: Record<string, Array<[string, any]>> = {};
const usedKeys = new Set<string>();

// Check if debugData exists
if (debugData && typeof debugData === "object") {
  // First, categorize known keys
  Object.entries(categories).forEach(([category, keys]) => {
    categorizedData[category] = [];
    keys.forEach((key) => {
      if (key in debugData) {
        categorizedData[category].push([key, debugData[key]]);
        usedKeys.add(key);
      }
    });
  });

  // Add remaining keys to "Other"
  categorizedData["Other"] = Object.entries(debugData)
    .filter(([key]) => !usedKeys.has(key))
    .sort(([a], [b]) => a.localeCompare(b));
} else {
  // If debugData is undefined or not an object, show a message
  categorizedData["Debug Info"] = [["debugData", "No debug data available"]];
}

// Remove empty categories
Object.keys(categorizedData).forEach((category) => {
  if (categorizedData[category].length === 0) {
    delete categorizedData[category];
  }
});
---

<!-- Debug Sticky Button (Admin Only) --><!-- Debug Modal -->
<div
  id="debug-modal"
  class="fixed inset-0 z-50 hidden overflow-y-auto"
  aria-labelledby="debug-modal-project-title"
  role="dialog"
  aria-modal="true"
>
  <!-- Backdrop -->
  <div
    class="flex min-h-screen items-end justify-center px-4 pb-20 pt-4 text-center sm:block sm:p-0"
  >
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" aria-hidden="true">
    </div>

    <!-- Modal panel -->
    <div
      class="color-background inline-block transform overflow-hidden rounded-lg bg-gray-100 px-4 pb-4 pt-5 text-left align-bottom shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl sm:p-6 sm:align-middle"
    >
      <!-- Header -->
      <div class="mb-4 flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <div class="flex-shrink-0">
            <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"
              ></path>
            </svg>
          </div>
          <h3
            class="text-lg font-medium leading-6 text-gray-900 dark:text-white"
            id="debug-modal-project-title"
          >
            Debug Panel - App Component Parameters
          </h3>
          <span
            class="inline-flex items-center rounded-full bg-red-100 px-2.5 py-0.5 text-xs font-medium text-red-800 dark:bg-red-900 dark:text-red-200"
          >
            Admin Only
          </span>
        </div>
        <CloseButton id="debug-close-btn" tooltipText="Close" />
      </div>

      <!-- Content -->
      <div class="max-h-96 overflow-y-auto">
        <div class="space-y-2">
          {
            Object.entries(categorizedData).map(([category, items]) => (
              <div class="rounded-lg border border-gray-200 dark:border-gray-700">
                {/* <!-- Accordion Header --> */}
                <button
                  type="button"
                  class="debug-accordion-header color-background flex w-full items-center justify-between rounded-lg px-4 py-3 text-left text-sm font-medium text-gray-700 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-red-500 dark:text-gray-200 dark:hover:bg-gray-600"
                  data-category={category}
                >
                  <span class="flex items-center space-x-2">
                    <span>{category}</span>
                    <span class="inline-flex items-center rounded bg-gray-200 px-2 py-0.5 text-xs font-medium text-gray-800 dark:bg-gray-600 dark:text-gray-200">
                      {items.length}
                    </span>
                  </span>
                  <svg
                    class="debug-accordion-icon h-5 w-5 transform transition-transform duration-200"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M19 9l-7 7-7-7"
                    />
                  </svg>
                </button>

                {/* <!-- Accordion Content --> */}
                <div class="debug-accordion-content hidden border-t border-gray-200 px-4 py-3 dark:border-gray-600">
                  <div class="space-y-3">
                    {items.map(([key, value]) => {
                      const dataType = getDataType(value);
                      const formattedValue = formatValue(value);

                      return (
                        <div class="color-background rounded-md p-3">
                          <div class="mb-2 flex items-start justify-between">
                            <div class="flex items-center space-x-2">
                              <span class="font-mono text-sm font-semibold text-primary-600 dark:text-primary-400">
                                {key}
                              </span>
                              <span
                                class={`inline-flex items-center rounded px-1.5 py-0.5 text-xs font-medium ${
                                  dataType === "string"
                                    ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200"
                                    : dataType === "number"
                                      ? "bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200"
                                      : dataType === "boolean"
                                        ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200"
                                        : dataType === "object"
                                          ? "bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-200"
                                          : dataType === "array"
                                            ? "bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200"
                                            : "bg-gray-100 text-gray-800 dark:bg-gray-600 dark:text-gray-200"
                                }`}
                              >
                                {dataType}
                              </span>
                            </div>
                            <button
                              type="button"
                              class="debug-copy-btn text-xs text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200"
                              data-value={formattedValue}
                              title="Copy to clipboard"
                            >
                              Copy
                            </button>
                          </div>
                          <pre class="color-background max-h-32 overflow-y-auto whitespace-pre-wrap break-all rounded border bg-gray-100 p-2 text-xs text-gray-600 dark:text-gray-300">
                            {formattedValue}
                          </pre>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>

      <!-- Footer -->
      <div class="mt-5 flex items-center justify-between sm:mt-6">
        <div class="text-sm text-gray-500 dark:text-gray-400">
          Total parameters: {debugData ? Object.keys(debugData).length : 0}
        </div>
        <button
          id="debug-close-btn-2"
          type="button"
          class="inline-flex justify-center rounded-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"
        >
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Debug Panel JavaScript
  document.addEventListener("DOMContentLoaded", function () {
    const toggleBtn = document.getElementById("debug-toggle-btn");
    const modal = document.getElementById("debug-modal");
    const closeBtns = [
      document.getElementById("debug-close-btn"),
      document.getElementById("debug-close-btn-2"),
    ];
    const backdrop = modal?.querySelector(".fixed.inset-0");

    // Toggle modal
    function toggleModal() {
      if (modal) {
        modal.classList.toggle("hidden");
        document.body.style.overflow = modal.classList.contains("hidden") ? "" : "hidden";
      }
    }

    // Open modal
    toggleBtn?.addEventListener("click", toggleModal);

    // Close modal
    closeBtns.forEach((btn) => {
      btn?.addEventListener("click", toggleModal);
    });

    // Close on backdrop click
    backdrop?.addEventListener("click", toggleModal);

    // Close on Escape key
    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && !modal?.classList.contains("hidden")) {
        toggleModal();
      }
    });

    // Accordion functionality
    const accordionHeaders = document.querySelectorAll(".debug-accordion-header");
    accordionHeaders.forEach((header) => {
      header.addEventListener("click", function (this: HTMLElement) {
        const category = this.getAttribute("data-category");
        const content = this.nextElementSibling;
        const icon = this.querySelector(".debug-accordion-icon") as HTMLElement;

        if (content && icon) {
          const isHidden = content.classList.contains("hidden");

          if (isHidden) {
            content.classList.remove("hidden");
            icon.style.transform = "rotate(180deg)";
          } else {
            content.classList.add("hidden");
            icon.style.transform = "rotate(0deg)";
          }
        }
      });
    });

    // Copy to clipboard functionality
    const copyBtns = document.querySelectorAll(".debug-copy-btn");
    copyBtns.forEach((btn) => {
      btn.addEventListener("click", async function (this: HTMLElement, e: Event) {
        e.stopPropagation();
        const value = this.getAttribute("data-value");

        try {
          await navigator.clipboard.writeText(value || "");
          this.textContent = "Copied!";
          setTimeout(() => {
            this.textContent = "Copy";
          }, 2000);
        } catch (err) {
          console.error("Failed to copy to clipboard:", err);
          this.textContent = "Failed";
          setTimeout(() => {
            this.textContent = "Copy";
          }, 2000);
        }
      });
    });
  });
</script>
