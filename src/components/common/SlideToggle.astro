---
import SimpleIcon from "./SimpleIcon.astro";

// Toggle component that works both as a regular component and as a partial
export const partial = true;

// Detect if this is being used as a partial
const isPartial = Astro.request.headers.has("x-toggle-id");

let id, name, label, icon, color, checked, size, className, dataAttributes;

if (isPartial) {
  // Extract props from headers when used as partial
  id = Astro.request.headers.get("x-toggle-id") || "";
  name = Astro.request.headers.get("x-toggle-name") || "";
  label = Astro.request.headers.get("x-toggle-label") || "";
  icon = Astro.request.headers.get("x-toggle-icon") || "";
  color = Astro.request.headers.get("x-toggle-color") || "primary";
  checked = Astro.request.headers.get("x-toggle-checked") === "true";
  size = Astro.request.headers.get("x-toggle-size") || "md";
  className = Astro.request.headers.get("x-toggle-class") || "";

  // Extract data attributes from headers
  dataAttributes = {} as Record<string, string>;
  for (const [key, value] of Astro.request.headers.entries()) {
    if (key.startsWith("x-toggle-data-")) {
      const dataKey = key.replace("x-toggle-data-", "").replace(/-/g, "-");
      dataAttributes[`data-${dataKey}`] = value;
    }
  }
} else {
  // Use regular props when used as a component
  const props = Astro.props;
  id = props.id;
  name = props.name;
  label = props.label;
  icon = props.icon;
  color = props.color || "primary";
  checked = props.checked || false;
  size = props.size || "md";
  className = props.class || "";
  dataAttributes = props.dataAttributes || {};
}

// Map color to Tailwind classes
const colorClasses = {
  primary:
    "peer-checked:bg-primary-600 peer-focus:ring-primary-300 dark:peer-focus:ring-primary-800",
  secondary:
    "peer-checked:bg-secondary-600 peer-focus:ring-secondary-300 dark:peer-focus:ring-secondary-800",
  danger: "peer-checked:bg-danger-600 peer-focus:ring-danger-300 dark:peer-focus:ring-danger-800",
  success:
    "peer-checked:bg-success-600 peer-focus:ring-success-300 dark:peer-focus:ring-success-800",
  warning:
    "peer-checked:bg-warning-600 peer-focus:ring-warning-300 dark:peer-focus:ring-warning-800",
};

const colorClass = colorClasses[color as keyof typeof colorClasses] || colorClasses.primary;
---

<label class="toggle-wrapper flex cursor-pointer items-center gap-3">
  <span
    class:list={[
      "text-gray-700 dark:text-gray-300",
      size === "xl" ? "text-2xl font-medium" : "text-sm",
    ]}
  >
    {icon && <SimpleIcon name={icon} class="mr-1" />}
    {label}
  </span>
  <div class="relative">
    <input
      type="checkbox"
      {id}
      {name}
      class={`toggle-input peer sr-only ${className}`}
      {checked}
      {...dataAttributes}
    />
    <div
      class:list={[
        "rounded-full bg-gray-200 after:absolute after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all after:content-['']",
        "peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 dark:border-gray-600 dark:bg-gray-700",
        colorClass,
        size === "xl"
          ? "h-12 w-20 after:left-[4px] after:top-[4px] after:h-10 after:w-10 peer-checked:after:translate-x-8"
          : "h-6 w-11 after:left-[2px] after:top-[2px] after:h-5 after:w-5 peer-checked:after:translate-x-full",
      ]}
    >
    </div>
  </div>
</label>
