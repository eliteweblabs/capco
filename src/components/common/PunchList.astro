---
import SimpleIcon from "./SimpleIcon.astro";
import DeleteConfirmButton from "./DeleteConfirmButton.astro";

export const partial = true;

// Extract all data from X-headers
const commentData = Astro.request.headers.get("x-comment-data");
const comment = commentData ? JSON.parse(decodeURIComponent(commentData)) : null;
const currentUserRole = Astro.request.headers.get("x-current-user-role") || "Client";
const currentUserId = Astro.request.headers.get("x-current-user-id") || "";
const supabaseUrl = Astro.request.headers.get("x-supabase-url") || "";
const depth = parseInt(Astro.request.headers.get("x-comment-depth") || "0");

// Pre-computed values passed from parent
const isInternal = Astro.request.headers.get("x-is-internal") === "true";
const isAuthor = Astro.request.headers.get("x-is-author") === "true";
const canToggleCompleted = Astro.request.headers.get("x-can-toggle-completed") === "true";
const canReply = Astro.request.headers.get("x-can-reply") === "true";
const marginLeft = Astro.request.headers.get("x-margin-left") || "";
const borderLeft = Astro.request.headers.get("x-border-left") || "";

// Check if user is Admin
const isAdmin = currentUserRole === "Admin";
---

{
  comment ? (
    <div class={`punchlist-item ${marginLeft} ${borderLeft}`} data-discussion-id={comment.id}>
      <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-900 dark:bg-gray-900 flex items-start gap-3">
        <div class="flex items-center space-x-2">
          {canToggleCompleted && (
            <div class="flex items-start space-x-2" id={`toggle-container-${comment.id}`}>
              {/* Toggle will be loaded here */}
            </div>
          )}
        </div>

        <div class="min-w-0 flex-1">
          <p
            class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap"
            set:html={comment.message}
          />
        </div>

        {isAdmin && (
          <div class="flex-shrink-0">
            <DeleteConfirmButton
              id={`delete-punchlist-${comment.id}`}
              itemType="punchlist"
              apiEndpoint="/api/punchlist/delete"
              onDeleteCallback="handlePunchlistDelete"
              size="xs"
              tooltipText="Delete punchlist item"
              confirmTitle="Delete Punchlist Item?"
              confirmMessage="Are you sure you want to delete this punchlist item? This action cannot be undone."
            />
          </div>
        )}

        {canReply && (
          <div class="mt-3 flex items-center justify-between">
            <button
              class="reply-button text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-200"
              data-discussion-id={comment.id}
            >
              <SimpleIcon name="reply" class="mr-1" />
              Reply
            </button>
          </div>
        )}
      </div>
    </div>
  ) : (
    '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><SimpleIcon name="message-circle" class="mx-auto mb-4 text-4xl" /><p>No comments yet. Be the first to start the discussion!</p></div>'
  )
}
