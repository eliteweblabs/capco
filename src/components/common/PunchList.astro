---
import SimpleIcon from "./SimpleIcon.astro";

export const partial = true;

// Extract all data from X-headers
const commentData = Astro.request.headers.get("x-comment-data");
const comment = commentData ? JSON.parse(decodeURIComponent(commentData)) : null;
const currentUserRole = Astro.request.headers.get("x-current-user-role") || "Client";
const currentUserId = Astro.request.headers.get("x-current-user-id") || "";
const supabaseUrl = Astro.request.headers.get("x-supabase-url") || "";
const depth = parseInt(Astro.request.headers.get("x-comment-depth") || "0");

// Pre-computed values passed from parent
const isInternal = Astro.request.headers.get("x-is-internal") === "true";
const isAuthor = Astro.request.headers.get("x-is-author") === "true";
const canToggleCompleted = Astro.request.headers.get("x-can-toggle-completed") === "true";
const canReply = Astro.request.headers.get("x-can-reply") === "true";
const marginLeft = Astro.request.headers.get("x-margin-left") || "";
const borderLeft = Astro.request.headers.get("x-border-left") || "";

---

{comment ? (

<div class={`punchlist-item ${marginLeft} ${borderLeft}`} data-discussion-id={comment.id}>
  <div class="rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-900 dark:bg-gray-900 flex items-start justify-between">
      <div class="flex items-center space-x-2">
     
     
      {canToggleCompleted && (
        <div class="flex items-start space-x-2" id={`toggle-container-${comment.id}`}>
          <!-- Toggle will be loaded here -->
        </div>
      )}
    </div>
    
    <div class="min-w-0 flex-1">
      <p class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap" set:html={comment.message}></p>
      
      {(() => {
        const imageCount = parseInt(Astro.request.headers.get("x-image-count") || "0");
        if (imageCount > 0) {
          const images = [];
          for (let i = 0; i < imageCount; i++) {
            const imageUrl = Astro.request.headers.get(`x-image-url-${i}`);
            const imageName = Astro.request.headers.get(`x-image-name-${i}`) || `Image ${i + 1}`;
            if (imageUrl) {
              images.push({ url: imageUrl, name: imageName });
            }
          }
          
          if (images.length > 0) {
            return (
              <div class="mt-3 flex flex-wrap gap-2">
                {images.map((image, index) => (
                  <div class="relative group">
                    <img 
                      src={image.url} 
                      alt={image.name}
                      class="max-w-xs max-h-48 object-cover rounded-lg border border-gray-300 dark:border-gray-600 cursor-pointer hover:opacity-90 transition-opacity"
                      onclick={`console.log('ðŸ–¼ï¸ [DISCUSSION] Image clicked:', '${image.url}'); window.openImageModal('${image.url}')`}
                    />
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-all rounded-lg flex items-center justify-center">
                      <SimpleIcon name="zoom-in" class="text-white opacity-0 group-hover:opacity-100 transition-opacity text-2xl" />
                    </div>
                  </div>
                ))}
              </div>
            );
          }
        }
        return null;
      })()}
    </div>
    
    {canReply && (
      <div class="mt-3 flex items-center justify-between">
        <button
          class="reply-button text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-200"
          data-discussion-id={comment.id}
        >
          <SimpleIcon name="reply" class="mr-1" />
          Reply
        </button>
      </div>
    )}
  </div>
</div>

) : (
  '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><SimpleIcon name="message-circle" class="mx-auto mb-4 text-4xl" /><p>No comments yet. Be the first to start the discussion!</p></div>'
)}