---
import Breadcrumb from "./Breadcrumb.astro";
import SlidingTabs, { type NavItem } from "./SlidingTabs.astro";

interface Props {
  title: string;
  description: string;
  statusColor?: string;
  project?: any;
  currentStatusInt?: string;
  currentStatusName?: string;
  currentStatusTab?: string;
  currentUser?: any;
  statusesOptions?: any; // Accept statuses object for slot machine picker
  staffOptions?: any;
  secondaryTextClasses?: string;
  primaryTextClasses?: string;
  globalInputClasses?: string;
  statusData?: any;
  fullWidth?: boolean;
  globalCompanyName?: string;
  /** Tab nav items (e.g. Project Form, Discussion, Files). When set, SlidingTabs is rendered inside the hero. */
  tabNavItems?: NavItem[];
  /** Active tab index for SlidingTabs when tabNavItems is used */
  activeTabIndex?: number;
}

const {
  title,
  description,
  currentUser,
  project,
  currentStatusName = "",
  statusData = {},
  tabNavItems,
  activeTabIndex = 0,
} = Astro.props;

const projectId = project?.id;
const currentRole = currentUser?.profile?.role;

// console.log("ðŸ” [HERO-PROJECT] Project:", project);
// console.log("ðŸ” [HERO-PROJECT] Current user:", currentUser);
// console.log("ðŸ” [HERO-PROJECT] Current role:", currentRole);
// console.log("ðŸ” [HERO-PROJECT] Current status tab:", currentStatusTab);
// console.log("ðŸ” [HERO-PROJECT] Current status int:", currentStatusInt);
// console.log("ðŸ” [HERO-PROJECT] Current status name:", currentStatusName);
// console.log("ðŸ” [HERO-PROJECT] Project ID:", projectId);

import SimpleIcon from "./SimpleIcon.astro";
import Button from "./Button.astro";
import CheckInButton from "./CheckInButton.astro";

// Create array of 36 datetime options (9 days Ã— 4 times per day)
const createDueDateOptions = () => {
  const options = [];
  const now = new Date();
  const times = [8, 12, 16, 20]; // 8am, 12pm, 4pm, 8pm

  for (let day = 0; day < 9; day++) {
    for (const hour of times) {
      const date = new Date(now);
      date.setDate(date.getDate() + day);
      date.setHours(hour, 0, 0, 0); // Set to exact hour, 0 minutes/seconds

      const dateStr = date.toISOString();
      const displayDate = date.toLocaleDateString();
      const displayTime = date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

      let label;
      if (day === 0) {
        label = `Today at ${displayTime}`;
      } else if (day === 1) {
        label = `Tomorrow at ${displayTime}`;
      } else {
        label = `${displayDate} at ${displayTime}`;
      }

      options.push({
        value: dateStr,
        label: label,
      });
    }
  }

  return options;
};

const dueDateOptions = createDueDateOptions();

// Use same source as marketing tab (#featured-image-url): featuredImageUrl, else featuredImageData.publicUrl
const featuredImageUrl = project?.featuredImageUrl || project?.featuredImageData?.publicUrl || null;
---

{
  featuredImageUrl && (
    <div
      id="featured-image-background"
      class="absolute inset-0 -z-10 w-full rounded-lg bg-cover bg-center blur-sm transition-transform duration-200 hover:scale-105"
      style={`background-image: url(${featuredImageUrl});`}
      data-refresh="featuredImageUrl"
      data-project-id={projectId}
      data-featured-image-url={featuredImageUrl}
      role="img"
      aria-label={`Featured image for ${project.address}`}
    >
      <div class="absolute inset-0 rounded-lg bg-white/60 dark:bg-black/60" aria-hidden="true" />
      <div class="featured-image-fallback hidden text-center">
        <SimpleIcon name="image-x" class="mx-auto mb-2 h-8 w-8" />
        <p class="text-xs">Image failed to load</p>
      </div>
    </div>
  )
}

<!-- <div class={`align-center justify-between p-4`}> -->

<!-- </div> -->

<div class="mx-auto flex px-4 py-8">
  <div class="flex-start flex flex-1 flex-col gap-2 space-y-2">
    <h1
      class="text-2xl font-medium"
      id="page-project-title"
      data-refresh
      data-project-id={projectId}
      data-title={title}
      data-meta-value={title}
    >
      {title}
    </h1>
    <Breadcrumb
      items={[
        {
          label: "",
          href: "/project/dashboard",
          icon: "home",
        },
        {
          label: project.title || "Untitled Project",
          current: false,
        },
        {
          label: currentStatusName,
          current: true,
        },
      ]}
    />
    <div class="inline-flex">
      <SimpleIcon name="user" class="inline-flex h-4 w-4" /><h2
        id="page-subtitle"
        class="inline-flex"
        set:html={description}
      />

      {project?.client_email && <p class="inline-block">{project.client_email}</p>}
    </div>
  </div>

  <div class="flex-end hidden flex-col gap-2 sm:flex sm:flex-row sm:items-center">
    {
      currentRole !== "Client" && (
        <Button
          variant="outline"
          size="sm"
          icon="plus"
          iconPosition="left"
          iconClasses="mr-0 md:mr-2"
          onclick="sendStatusEmailToClient()"
        >
          Send Current Status Email
        </Button>
      )
    }
  </div>
</div>

{
  tabNavItems && tabNavItems.length > 0 && (
    <SlidingTabs
      navId="project-tab-nav"
      activeItem={activeTabIndex}
      showTooltips={false}
      {currentUser}
      items={tabNavItems}
    />
  )
}

<script type="module" define:vars={{ project, statusData }} is:inline>
  window.sendStatusEmailToClient = () => {
    window.updateStatus(project, project.status, statusData[project.status]).then((data) => {
      if (data.success) {
        window.handleNewStatusModalAndEmail(data, "HERO-PROJECT");
      } else {
        window.showNotice("error", "Error", data.error || "Failed to update project status");
      }
    });
  };
</script>
