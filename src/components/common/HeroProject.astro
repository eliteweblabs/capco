---
import Breadcrumb from "./Breadcrumb.astro";

interface Props {
  title: string;
  description: string;
  statusColor?: string;
  project?: any;
  currentStatusInt?: string;
  currentStatusName?: string;
  currentStatusTab?: string;
  currentUser?: any;
  statusesOptions?: any; // Accept statuses object for slot machine picker
  staffOptions?: any;
  globalSecondaryTextClasses?: string;
  globalPrimaryTextClasses?: string;
  globalInputClasses?: string;
}

const {
  title,
  description,
  currentUser,
  statusColor = "blue",
  project,
  currentStatusInt = "",
  currentStatusName = "",
  currentStatusTab = "",
  statusesOptions,
  staffOptions = [],
  globalSecondaryTextClasses = "",
  globalPrimaryTextClasses = "",
  globalInputClasses = "",
} = Astro.props;

const projectId = project?.id;

const currentRole = currentUser?.profile?.role;

// console.log("ðŸ” [HERO-PROJECT] Project:", project);
// console.log("ðŸ” [HERO-PROJECT] Current user:", currentUser);
// console.log("ðŸ” [HERO-PROJECT] Current role:", currentRole);
// console.log("ðŸ” [HERO-PROJECT] Current status tab:", currentStatusTab);
// console.log("ðŸ” [HERO-PROJECT] Current status int:", currentStatusInt);
// console.log("ðŸ” [HERO-PROJECT] Current status name:", currentStatusName);
// console.log("ðŸ” [HERO-PROJECT] Project ID:", projectId);

import SlotMachineModal from "../form/SlotMachineModal.astro";
import SlotMachineModalStaff from "../form/SlotMachineModalStaff.astro";
import BoxIcon from "./BoxIcon.astro";
import Button from "./Button.astro";
// import SectionContainer from "./SectionContainer.astro";

// // Get status options from the unified API if not provided
// let statusOptions: any[] = [];
// if (Object.keys(statusesOptions).length > 0) {
//   // Use provided statuses (legacy support)
//   statusOptions = Object.values(statuses).map((status: any) => ({
//     value: status.statusCode?.toString() || "",
//     label:
//       status.adminStatusName +
//         " / " +
//         (status.estTime === null ? "No Est. Time Value" : status.estTime) || "",
//   }));
// } else {
//   // Fetch from unified API
//   try {
//     const statusResponse = await fetch(`${Astro.url.origin}/api/project-statuses`, {
//       method: "GET",
//       headers: {
//         Cookie: Astro.request.headers.get("Cookie") || "",
//       },
//     });

//     if (statusResponse.ok) {
//       const statusData = await statusResponse.json();
//       if (statusData.success) {
//         statusOptions = statusData.selectOptions;
//       }
//     }
//   } catch (error) {
//     console.error("Failed to fetch status options:", error);
//   }
// }

// Create array of 36 datetime options (9 days Ã— 4 times per day)
const createDueDateOptions = () => {
  const options = [];
  const now = new Date();
  const times = [8, 12, 16, 20]; // 8am, 12pm, 4pm, 8pm

  for (let day = 0; day < 9; day++) {
    for (const hour of times) {
      const date = new Date(now);
      date.setDate(date.getDate() + day);
      date.setHours(hour, 0, 0, 0); // Set to exact hour, 0 minutes/seconds

      const dateStr = date.toISOString();
      const displayDate = date.toLocaleDateString();
      const displayTime = date.toLocaleTimeString([], { hour: "numeric", minute: "2-digit" });

      let label;
      if (day === 0) {
        label = `Today at ${displayTime}`;
      } else if (day === 1) {
        label = `Tomorrow at ${displayTime}`;
      } else {
        label = `${displayDate} at ${displayTime}`;
      }

      options.push({
        value: dateStr,
        label: label,
      });
    }
  }

  return options;
};

const dueDateOptions = createDueDateOptions();

// Debug logging for HeroProject component props
// console.log("ðŸŽ¯ [HERO-PROJECT] HeroProject component props:", {
//   currentStatusTab,
//   title,
//   currentStatusName,
//   projectId,
//   currentRole,
//   hasProject: !!project,
//   showStatusAndStaff: !!(currentStatusName && projectId),
//   isAdminOrStaff: currentRole === "Admin" || currentRole === "Staff",
// });
---

<div class="align-center col-span-full justify-between p-4 md:flex hidden">
  {
    project.featuredImageData?.publicUrl && (
      <div id="featured-image-background" class="absolute inset-0 -z-10">
        <img
          src={project.featuredImageData.publicUrl}
          alt={`Featured image for ${project.address}`}
          class="h-32 w-full rounded-lg rounded-b-none object-cover transition-transform duration-200 hover:scale-105"
          loading="lazy"
          referrerpolicy="strict-origin-when-cross-origin"
          crossorigin="anonymous"
          onerror="console.warn('Featured image failed to load:', this.src, 'Project ID:', this.closest('[data-project-id]')?.dataset.projectId); this.style.display='none'; const fallback = this.parentElement.querySelector('.featured-image-fallback'); if (fallback) fallback.style.display='flex';"
        />
        <div class="featured-image-fallback hidden text-center">
          <BoxIcon name="image-x" class="mx-auto mb-2 h-8 w-8" />
          <p class="text-xs">Image failed to load</p>
        </div>
      </div>
    )
  }
  <div class="mb-4">
    <Breadcrumb
      items={[
        {
          label: "Dashboard",
          href: "/project/dashboard",
          icon: "home",
        },
        {
          label: "Projects",
          href: "/project/dashboard",
        },
        {
          label: project.title || "Untitled Project",
          current: true,
        },
      ]}
    />
  </div>
</div>

<div class="relative mx-auto flex p-4">
  <div class="mx-4 ml-0 flex flex-1 flex-col gap-2">
    <h1
      class="text-2xl font-medium text-black dark:text-white"
      id="page-project-title"
      data-refresh
    >
      {title}
    </h1>
    <h2 id="page-subtitle" class="text-black dark:text-white" set:html={description} />
    {
      project?.client_email && (
        <p class="text-sm text-gray-500 dark:text-gray-400">{project.client_email}</p>
      )
    }
  </div>

  <div class="flex-end hidden md:flex">
    <Button
      href="/project/new"
      variant="primary"
      size="sm"
      icon="plus"
      iconPosition="left"
      iconClasses="mr-0 md:mr-2"
      class="w-full"
    >
      New Project
    </Button>
  </div>
</div>
