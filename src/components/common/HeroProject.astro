---
import SlotMachineModal from "../form/SlotMachineModal.astro";
import Button from "./Button.astro";
import SectionContainer from "./SectionContainer.astro";

interface Props {
  title: string;
  description: string;
  statusColor?: string;
  projectId?: string;
  currentStatusInt?: string;
  currentStatusName?: string;
  currentStatusTab?: string;
  currentRole?: string;
  project?: any;
  statuses?: any; // Accept statuses object for slot machine picker
  authorProfile?: any;
}

const {
  title,
  description,
  currentRole,
  statusColor = "blue",
  projectId,
  currentStatusInt = "",
  currentStatusName = "",
  currentStatusTab = "",
  authorProfile,
  project,
  statuses = {},
} = Astro.props;

// Get status options from the unified API if not provided
let statusOptions: any[] = [];
if (Object.keys(statuses).length > 0) {
  // Use provided statuses (legacy support)
  statusOptions = Object.values(statuses).map((status: any) => ({
    value: status.status_code?.toString() || "",
    label: status.admin_status_name || "",
  }));
} else {
  // Fetch from unified API
  try {
    const statusResponse = await fetch(`${Astro.url.origin}/api/project-statuses`, {
      method: "GET",
      headers: {
        Cookie: Astro.request.headers.get("Cookie") || "",
      },
    });

    if (statusResponse.ok) {
      const statusData = await statusResponse.json();
      if (statusData.success) {
        statusOptions = statusData.selectOptions;
      }
    }
  } catch (error) {
    console.error("Failed to fetch status options:", error);
  }
}

// Fetch staff data for staff selection
let staffOptions: any[] = [];
if (currentRole === "Admin" || currentRole === "Staff") {
  try {
    const staffResponse = await fetch(`${Astro.url.origin}/api/get-user-emails-by-role`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        roles: ["Admin", "Staff"],
      }),
    });
    if (staffResponse.ok) {
      const staffData = await staffResponse.json();
      if (staffData.success && staffData.staffUsers) {
        staffOptions = [
          { value: "", label: "Unassigned" },
          ...staffData.staffUsers.map((staff: any) => ({
            value: staff.id,
            label: staff.company_name || staff.name || "Unknown Staff",
          })),
        ];
      }
    }
  } catch (error) {
    console.error("Failed to fetch staff data:", error);
    staffOptions = [{ value: "", label: "Unassigned" }];
  }
}

// Debug logging for HeroProject component props
// console.log("ðŸŽ¯ [HERO-PROJECT] HeroProject component props:", {
//   currentStatusTab,
//   title,
//   currentStatusName,
//   projectId,
//   currentRole,
//   hasProject: !!project,
//   showStatusAndStaff: !!(currentStatusName && projectId),
//   isAdminOrStaff: currentRole === "Admin" || currentRole === "Staff",
// });
---

<SectionContainer>
  <div class="relative mx-auto flex">
    <div class="mx-4 ml-0 flex flex-1 flex-col gap-2">
      <h1 class="text-2xl font-medium text-black dark:text-white" id="page-title" data-refresh>
        {title}
      </h1>
      <h2
        id="page-subtitle"
        class="text-secondary dark:text-secondary-dark"
        set:html={description}
      />
      {
        authorProfile?.email && (
          <p class="text-sm text-gray-500 dark:text-gray-400">{authorProfile.email}</p>
        )
      }
    </div>

    <div class="mx-4 mr-0 flex flex-shrink-0 flex-col gap-2">
      {
        currentRole === "Admin" || currentRole === "Staff" ? (
          <>
            <div class="relative flex w-full">
              <SlotMachineModal
                id="update-status"
                title="Select Status"
                options={statusOptions}
                selectedValue={currentStatusInt || ""}
                placeholder="Choose status"
                buttonText={currentStatusName}
                showCloseButton={true}
                showCancelButton={true}
                skipSaveToAPI={false}
                projectId={projectId}
                showNotification={false}
                icon="code"
                searchText="Search status..."
              />
            </div>

            <div class="relative w-full">
              <SlotMachineModal
                id="assign-staff"
                title="Assign Staff Member"
                options={staffOptions}
                selectedValue={project?.assigned_to_id || ""}
                placeholder="Assign staff..."
                buttonText={(() => {
                  if (!project?.assigned_to_id) return "Unassigned";
                  const assignedStaff = staffOptions.find(
                    (staff) => staff.value === project.assigned_to_id
                  );
                  return assignedStaff?.label || "Unknown Staff";
                })()}
                showCloseButton={true}
                showCancelButton={true}
                skipSaveToAPI={false}
                projectId={projectId}
                showNotification={true}
                icon="user"
                searchText="Search staff..."
                buttonVariant="outline"
              />
            </div>
          </>
        ) : (
          <Button
            href={`/project/${projectId}?status=${currentStatusTab}`}
            title={`Go to ${currentStatusName} status`}
            variant="outline"
            icon="chevron-right"
            iconPosition="right"
            class="ml-4 flex-shrink-0 cursor-pointer transition-opacity hover:opacity-80"
          >
            {currentStatusName}
          </Button>
        )
      }
    </div>
  </div>
</SectionContainer>
