---
// Preloader: dot grid (all black) with random dots turning primary, ease-in-out, each dot once.
// #page stays hidden until ready.
---

<div id="preloader-dot-grid" class="preloader-dot-grid color-background" aria-hidden="true"></div>

<script>
  const DOT_SIZE_PX = 20;

  function ready() {
    document.body?.classList.remove("preloading");
    const page = document.getElementById("page");
    if (page) page.removeAttribute("hidden");
    const grid = document.getElementById("preloader-dot-grid");
    if (grid) grid.style.pointerEvents = "none";
    // Grid stays visible; animation runs to 100% and we do not hide or remove it
  }

  if (document.readyState === "complete") {
    ready();
  } else {
    window.addEventListener("load", ready);
  }
  document.addEventListener("DOMContentLoaded", () => setTimeout(ready, 80));

  (function initDotGrid() {
    const grid = document.getElementById("preloader-dot-grid");
    if (!grid) return;
    const cols = Math.ceil((window.innerWidth || 800) / DOT_SIZE_PX);
    const rows = Math.ceil((window.innerHeight || 600) / DOT_SIZE_PX);
    const total = cols * rows;
    const indices = Array.from({ length: total }, (_, i) => i);
    for (let i = total - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [indices[i], indices[j]] = [indices[j], indices[i]];
    }
    const maxDelayMs = 4000;
    for (let i = 0; i < total; i++) {
      const dot = document.createElement("span");
      dot.className = "preloader-dot";
      dot.style.setProperty("--delay", (indices[i] / total) * maxDelayMs + "ms");
      grid.appendChild(dot);
    }
  })();
</script>

<style is:global>
  .preloader-dot-grid {
    position: fixed;
    inset: 0;
    z-index: auto;
    display: grid;
    grid-template-columns: repeat(auto-fill, 20px);
    grid-auto-rows: 20px;
    gap: 0;
    align-content: start;
    justify-content: start;
    transition: opacity 0.4s ease-out;
  }
  .preloader-dot {
    width: 1px;
    height: 1px;
    background: #000;
    border-radius: 50%;
    justify-self: center;
    align-self: center;
    animation: preloader-dot-to-primary 0.5s ease-in-out var(--delay, 0) forwards;
  }
  .preloader-dot-grid.preloader-completing .preloader-dot {
    animation: preloader-dot-to-primary 0.2s cubic-bezier(0.4, 0, 1, 1) 0s forwards;
  }
  @keyframes preloader-dot-to-primary {
    from {
      background-color: #000;
    }
    to {
      background-color: var(--preloader-dot-primary, var(--color-primary-500));
    }
  }
</style>
