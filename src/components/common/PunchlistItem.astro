---
import SimpleIcon from "./SimpleIcon.astro";
import DeleteConfirmButton from "../ui/DeleteConfirmButton.astro";

export const partial = true;

// Extract all data from X-headers
const commentData = Astro.request.headers.get("x-comment-data");
const comment = commentData ? JSON.parse(decodeURIComponent(commentData)) : null;
const currentUserRole = Astro.request.headers.get("x-current-user-role") || "Client";
const currentUserId = Astro.request.headers.get("x-current-user-id") || "";
const supabaseUrl = Astro.request.headers.get("x-supabase-url") || "";
const depth = parseInt(Astro.request.headers.get("x-comment-depth") || "0");

// Pre-computed values passed from parent
const isInternal = Astro.request.headers.get("x-is-internal") === "true";
const isAuthor = Astro.request.headers.get("x-is-author") === "true";
const canToggleCompleted = Astro.request.headers.get("x-can-toggle-completed") === "true";
const canReply = Astro.request.headers.get("x-can-reply") === "true";
const marginLeft = Astro.request.headers.get("x-margin-left") || "";
const borderLeft = Astro.request.headers.get("x-border-left") || "";

// NEW: Check if this is an editable/new item form
const editable = Astro.request.headers.get("x-editable") === "true";

// Check if user is Admin
const isAdmin = currentUserRole === "Admin";
---

{
  editable ? (
    <div class="punchlist-item-new rounded-lg border border-primary-300 p-4 dark:border-primary-700">
      <div class="space-y-3">
        <div>
          <input
            type="text"
            id="new-punchlist-message"
            placeholder="Enter punchlist item"
            class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-900 focus:border-primary-500 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-800 dark:text-white dark:placeholder-gray-400"
            required
            autofocus
          />
        </div>

        <div class="flex items-center gap-2">
          <button
            type="button"
            id="save-new-punchlist-btn"
            class="inline-flex items-center gap-2 rounded-lg bg-primary-600 px-4 py-2 text-sm font-medium text-white hover:bg-primary-700 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-500 dark:hover:bg-primary-600 dark:focus:ring-primary-800"
          >
            <SimpleIcon name="check" class="h-4 w-4" />
            Save Item
          </button>

          <button
            type="button"
            id="cancel-new-punchlist-btn"
            class="inline-flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-4 focus:ring-gray-200 dark:border-gray-600 dark:bg-gray-800 dark:text-gray-300 dark:hover:bg-gray-700 dark:focus:ring-gray-700"
          >
            <SimpleIcon name="x" class="h-4 w-4" />
            Cancel
          </button>
        </div>
      </div>
    </div>
  ) : comment ? (
    <div class={`punchlist-item ${marginLeft} ${borderLeft}`} data-discussion-id={comment.id}>
      <div class="flex items-start gap-3 rounded-lg border border-gray-200 bg-gray-50 p-4 dark:border-gray-900 dark:bg-gray-900">
        <div class="flex items-center space-x-2">
          {canToggleCompleted && (
            <div class="flex items-start space-x-2" id={`toggle-container-${comment.id}`}>
              {/* Toggle will be loaded here */}
            </div>
          )}
        </div>

        <div class="min-w-0 flex-1">
          <p
            class="whitespace-pre-wrap text-sm text-gray-700 dark:text-gray-300"
            set:html={comment.message}
          />
        </div>

        {isAdmin && (
          <div class="flex-shrink-0">
            <DeleteConfirmButton
              id={`delete-punchlist-${comment.id}`}
              itemType="punchlist"
              apiEndpoint="/api/punchlist/delete"
              onDeleteCallback="handlePunchlistDelete"
              size="xs"
              tooltipText="Delete punchlist item"
              confirmTitle="Delete Punchlist Item?"
              confirmMessage="Are you sure you want to delete this punchlist item? This action cannot be undone."
            />
          </div>
        )}

        {canReply && (
          <div class="mt-3 flex items-center justify-between">
            <button
              class="reply-button text-sm text-primary-600 hover:text-primary-800 dark:text-primary-400 dark:hover:text-primary-200"
              data-discussion-id={comment.id}
            >
              <SimpleIcon name="reply" class="mr-1" />
              Reply
            </button>
          </div>
        )}
      </div>
    </div>
  ) : (
    <div class="py-8 text-center text-gray-500 dark:text-gray-400">
      <SimpleIcon name="message-circle" class="mx-auto mb-4 text-4xl" />
      <p>No comments yet. Be the first to start the discussion!</p>
    </div>
  )
}
