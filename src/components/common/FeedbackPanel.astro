---
// Feedback Widget Component
// Floating panel (no modal) for authenticated users to submit feedback

import CloseButton from "../ui/CloseButton.astro";

interface Props {
  currentUser?: any;
}

const { currentUser } = Astro.props;

// Only show for authenticated users
const isAuth = currentUser && currentUser.id;

if (!isAuth) {
  // Return empty component for non-authenticated users
  return;
}
---

<div id="feedback-widget" class="fixed bottom-4 right-4" style="z-index: 10000;">
  <!-- Feedback panel (floating card, no overlay) -->
  <div
    id="feedback-panel"
    class="feedback-panel color-background fixed bottom-20 right-4 hidden max-h-[85vh] w-full max-w-md flex-col rounded-lg border border-gray-200 bg-gray-100 shadow-xl dark:border-gray-700"
    role="dialog"
    aria-labelledby="feedback-panel-title"
    aria-hidden="true"
  >
    <!-- Panel Header -->
    <div
      class="flex shrink-0 items-center justify-between border-b border-gray-200 p-4 dark:border-gray-700"
    >
      <h3 id="feedback-panel-title" class="text-lg font-semibold text-gray-900 dark:text-white">
        Leave Feedback
      </h3>
      <CloseButton id="feedback-close" tooltipText="Close feedback form" />
    </div>

    <!-- Panel Body -->
    <div class="overflow-y-auto p-4">
      <form id="feedback-form" class="space-y-4">
        <!-- Feedback Type -->
        <div>
          <label
            for="feedback-type"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Type of Feedback
          </label>
          <select
            id="feedback-type"
            name="type"
            required
            class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
          >
            <option value="">Select feedback type...</option>
            <option value="bug">üêõ Bug Report</option>
            <option value="feature">üí° Feature Request</option>
            <option value="improvement">‚ö° Improvement</option>
            <option value="design">üé® Design Feedback</option>
            <option value="general">üí¨ General Comment</option>
          </select>
        </div>

        <!-- Priority -->
        <div>
          <label
            for="feedback-priority"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Priority
          </label>
          <select
            id="feedback-priority"
            name="priority"
            required
            class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
          >
            <option value="low">üü¢ Low</option>
            <option value="medium" selected> üü° Medium </option>
            <option value="high">üü† High</option>
            <option value="urgent">üî¥ Urgent</option>
          </select>
        </div>

        <!-- Subject -->
        <div>
          <label
            for="feedback-subject"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Subject
          </label>
          <input
            type="text"
            id="feedback-subject"
            name="subject"
            required
            maxlength="100"
            placeholder="Brief description of your feedback..."
            class="w-full rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
          />
        </div>

        <!-- Message -->
        <div>
          <label
            for="feedback-message"
            class="mb-2 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Message
          </label>
          <textarea
            id="feedback-message"
            name="message"
            required
            rows="4"
            maxlength="1000"
            placeholder="Please provide detailed feedback..."
            class="w-full resize-none rounded-md border border-gray-300 px-3 py-2 shadow-sm focus:border-primary-500 focus:outline-none focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
          ></textarea>
          <div class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            <span id="message-count">0</span>/1000 characters
          </div>
        </div>

        <!-- Anonymous Option -->
        <div class="flex items-center">
          <input
            type="checkbox"
            id="feedback-anonymous"
            name="anonymous"
            class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500 dark:border-gray-600"
          />
          <label
            for="feedback-anonymous"
            class="ml-2 block text-sm text-gray-700 dark:text-gray-300"
          >
            Submit anonymously
          </label>
        </div>
      </form>
    </div>

    <!-- Panel Footer -->
    <div
      class="color-background flex shrink-0 justify-end space-x-3 border-t border-gray-200 p-4 dark:border-gray-700"
    >
      <button
        type="button"
        id="feedback-cancel"
        class="rounded-md border border-gray-300 bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2 dark:border-gray-500 dark:bg-gray-600 dark:text-gray-300 dark:hover:bg-gray-500"
      >
        Cancel
      </button>
      <button
        type="submit"
        id="feedback-submit"
        form="feedback-form"
        class="rounded-md border border-transparent bg-primary-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <span class="submit-text">Submit Feedback</span>
        <span class="loading-text hidden">Submitting...</span>
      </button>
    </div>
  </div>
</div>

<script>
  // Feedback panel (floating card, no modal)
  document.addEventListener("DOMContentLoaded", function () {
    const feedbackButton = document.getElementById("feedback-button") as HTMLButtonElement;
    const feedbackPanel = document.getElementById("feedback-panel") as HTMLDivElement;
    const feedbackClose = document.getElementById("feedback-close") as HTMLButtonElement;
    const feedbackCancel = document.getElementById("feedback-cancel") as HTMLButtonElement;
    const feedbackForm = document.getElementById("feedback-form") as HTMLFormElement;
    const feedbackSubmit = document.getElementById("feedback-submit") as HTMLButtonElement;
    const messageTextarea = document.getElementById("feedback-message") as HTMLTextAreaElement;
    const messageCount = document.getElementById("message-count") as HTMLSpanElement;

    if (!feedbackButton) console.warn("Feedback button not found in DOM");
    if (!feedbackPanel) console.warn("Feedback panel not found in DOM");

    function showFeedbackPanel() {
      feedbackPanel.classList.remove("hidden");
      feedbackPanel.setAttribute("aria-hidden", "false");
      const firstInput = feedbackForm?.querySelector("input, select, textarea") as HTMLElement;
      if (firstInput) setTimeout(() => firstInput.focus(), 100);
    }

    function hideFeedbackPanel() {
      feedbackPanel.classList.add("hidden");
      feedbackPanel.setAttribute("aria-hidden", "true");
      feedbackForm?.reset();
      updateMessageCount();
    }

    function updateMessageCount() {
      if (!messageTextarea || !messageCount) return;
      const count = messageTextarea.value.length;
      messageCount.textContent = count.toString();
      messageCount.classList.toggle("text-red-500", count > 900);
    }

    feedbackButton?.addEventListener("click", showFeedbackPanel);
    feedbackClose?.addEventListener("click", hideFeedbackPanel);
    feedbackCancel?.addEventListener("click", hideFeedbackPanel);
    messageTextarea?.addEventListener("input", updateMessageCount);

    // Close on click outside (panel or trigger button)
    document.addEventListener("click", function (e) {
      const target = e.target as Node;
      if (
        feedbackPanel.classList.contains("hidden") ||
        !feedbackPanel ||
        feedbackPanel.contains(target) ||
        feedbackButton?.contains(target)
      )
        return;
      hideFeedbackPanel();
    });

    document.addEventListener("keydown", function (e) {
      if (e.key === "Escape" && feedbackPanel && !feedbackPanel.classList.contains("hidden")) {
        hideFeedbackPanel();
      }
    });

    feedbackForm?.addEventListener("submit", async function (e) {
      e.preventDefault();
      if (!feedbackSubmit) return;

      const submitText = feedbackSubmit.querySelector(".submit-text") as HTMLElement;
      const loadingText = feedbackSubmit.querySelector(".loading-text") as HTMLElement;
      feedbackSubmit.disabled = true;
      submitText?.classList.add("hidden");
      loadingText?.classList.remove("hidden");

      try {
        const formData = new FormData(feedbackForm);
        const feedbackData = {
          type: formData.get("type"),
          priority: formData.get("priority"),
          subject: formData.get("subject"),
          message: formData.get("message"),
          anonymous: formData.get("anonymous") === "on",
        };
        const response = await fetch("/api/feedback", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(feedbackData),
        });
        const result = await response.json();

        if (response.ok) {
          if ((window as any).showNotice) {
            (window as any).showNotice({
              type: "success",
              title: "Feedback Submitted",
              message: "Thank you for your feedback! We appreciate your input.",
              duration: 3000,
            });
          } else {
            alert("Feedback submitted successfully! Thank you for your input.");
          }
          hideFeedbackPanel();
        } else {
          throw new Error(result.error || "Failed to submit feedback");
        }
      } catch (error) {
        console.error("Feedback submission error:", error);
        if ((window as any).showNotice) {
          (window as any).showNotice({
            type: "error",
            title: "Submission Failed",
            message: "Failed to submit feedback. Please try again.",
            duration: 5000,
          });
        } else {
          alert("Failed to submit feedback. Please try again.");
        }
      } finally {
        feedbackSubmit.disabled = false;
        submitText?.classList.remove("hidden");
        loadingText?.classList.add("hidden");
      }
    });

    updateMessageCount();
  });
</script>

<style>
  #feedback-widget {
    font-family: inherit;
  }

  .feedback-panel {
    transition: opacity 0.2s ease-out;
  }
  .feedback-panel:not(.hidden) {
    display: flex;
    flex-direction: column;
  }

  #feedback-button:focus,
  #feedback-close:focus,
  #feedback-cancel:focus,
  #feedback-submit:focus {
    outline: 2px solid #3b82f6;
    outline-offset: 2px;
  }

  /* [OVERHAUL] Input validation border colors ‚Äì see global.css INPUT OVERHAUL REFERENCE (section 12) */
  /*
  #feedback-form input:invalid,
  #feedback-form select:invalid,
  #feedback-form textarea:invalid {
    border-color: #ef4444;
  }
  #feedback-form input:valid,
  #feedback-form select:valid,
  #feedback-form textarea:valid {
    border-color: #10b981;
  }
  */
</style>
