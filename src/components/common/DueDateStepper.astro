---
/**
 * DueDateStepper â€“ due date display with optional +/- hour stepper.
 * Uses global adjustDueDate(projectId, hours). Pass showStepper=false for read-only long date.
 */
import SimpleIcon from "./SimpleIcon.astro";

export interface Props {
  /** Project id (required for adjustDueDate and data attributes) */
  projectId: string | number;
  /** Due date value (ISO string or empty) */
  value?: string | null;
  /** Show stepper (+/-) and short input; false = read-only long date */
  showStepper?: boolean;
  /** Field name for data-meta and data-refresh (default "dueDate") */
  meta?: string;
  /** data-refresh value (defaults to meta) */
  refresh?: string;
  /** Shown when value is empty (stepper mode) */
  placeholder?: string;
  /** Input element id (default `due-date-${projectId}`) */
  inputId?: string;
  /** Wrapper class (e.g. "flex items-center gap-1") */
  wrapperClass?: string;
  /** Decrement button class */
  decrementButtonClass?: string;
  /** Increment button class */
  incrementButtonClass?: string;
  /** Input class */
  inputClass?: string;
  /** Span class when showStepper is false (display-only) */
  displayOnlyClass?: string;
  /** Hours to add on increment (default 1) */
  incrementHours?: number;
  /** Hours to add on decrement (default -1) */
  decrementHours?: number;
  /** Locale for date formatting */
  locale?: string;
  /** Short format options (input display) */
  dateFormatShort?: Intl.DateTimeFormatOptions;
  /** Long format options (display-only) */
  dateFormatLong?: Intl.DateTimeFormatOptions;
}

const {
  projectId,
  value = "",
  showStepper = true,
  meta = "dueDate",
  refresh,
  placeholder = "",
  inputId,
  wrapperClass = "flex items-center gap-1",
  decrementButtonClass = "align-center flex px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg",
  incrementButtonClass = "align-center flex px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg",
  inputClass = "w-24 text-center border-0 bg-transparent text-xs focus:ring-0 p-1",
  displayOnlyClass = "",
  incrementHours = 1,
  decrementHours = -1,
  locale = "en-US",
  dateFormatShort = {
    month: "short",
    day: "numeric",
    hour: "numeric",
    hour12: true,
  },
  dateFormatLong = {
    year: "numeric",
    month: "long",
    day: "numeric",
  },
} = Astro.props;

const refreshValue = refresh ?? meta;
const resolvedInputId = inputId ?? `due-date-${projectId}`;
const rawValue = value ?? "";
const displayShort = rawValue
  ? new Date(rawValue).toLocaleDateString(locale, dateFormatShort)
  : placeholder;
const displayLong = rawValue
  ? new Date(rawValue).toLocaleDateString(locale, dateFormatLong)
  : placeholder;
---

{
  showStepper ? (
    <div class={wrapperClass}>
      <button
        type="button"
        class={decrementButtonClass}
        data-action="decrement"
        data-project-id={projectId}
        onclick={`event.stopPropagation(); adjustDueDate(${projectId}, ${decrementHours})`}
      >
        <SimpleIcon name="minus" size="xs" class="text-gray-600" />
      </button>
      <div class="relative inline-block">
        <input
          type="text"
          id={resolvedInputId}
          value={displayShort}
          data-due-date={rawValue}
          data-refresh={refreshValue}
          data-project-id={projectId}
          data-meta={meta}
          data-meta-value={rawValue}
          readonly
          class={inputClass}
          placeholder={placeholder || undefined}
        />
      </div>
      <button
        type="button"
        class={incrementButtonClass}
        data-action="increment"
        data-project-id={projectId}
        onclick={`event.stopPropagation(); adjustDueDate(${projectId}, ${incrementHours})`}
      >
        <SimpleIcon name="plus" size="xs" class="text-gray-600" />
      </button>
    </div>
  ) : (
    <span class={displayOnlyClass}>
      {displayLong || placeholder}
    </span>
  )
}
