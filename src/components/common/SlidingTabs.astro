---
// Sliding tabs navigation component
import Button from "./Button.astro";
import SimpleIcon from "./SimpleIcon.astro";
import Tooltip from "./TooltipFloating.astro";

export interface NavItem {
  id?: string;
  label: string;
  icon?: string;
  variant?: string;
  dataAttributes?: Record<string, string>;
  onclick?: string;
  clientHide?: boolean;
  showLabel?: boolean; // When true, show label text (for tabs without icons)
  /** Override tooltip text (defaults to label). Set to empty string to hide tooltip for this item. */
  tooltipText?: string;
}

interface Props {
  items?: NavItem[];
  activeItem?: number;
  class?: string;
  navId?: string;
  navClass?: string;
  urlParam?: string; // URL parameter to check (e.g. "status", "tab"); empty = no URL sync
  switchHandler?: string; // Global function to call when URL has param (e.g. "switchTab", "switchAuthTab")
  compact?: boolean; // Compact layout (smaller padding, for auth-style)
  /** When true, show tooltips on tab buttons. Default false. */
  showTooltips?: boolean;
  currentUser?: any; // Current user object to check role
}

const {
  items = [],
  activeItem = 0,
  class: className = "",
  navId,
  navClass = "",
  urlParam = "status",
  switchHandler = "switchTab",
  compact = false,
  showTooltips = false,
  currentUser,
} = Astro.props as Props;

// Filter items based on clientHide parameter
const filteredItems = items.filter((item) => {
  // If clientHide is true and current user is a Client, hide this item
  if (item.clientHide && currentUser?.profile?.role === "Client") {
    return false;
  }
  return true;
});
---

<nav
  id={navId}
  class={`scrollbar-hide pb-0 relative flex gap-2 overflow-x-scroll overflow-y-hidden whitespace-nowrap mb-0 ${
    compact ? "px-2 pt-2" : "px-4 pt-12"
  } ${navClass}`}
  data-active-item={activeItem}
  data-url-param={urlParam || ""}
  data-switch-handler={switchHandler}
>
  <!-- Sliding tabs indicator background -->
  <div
    id="nav-tabs-indicator"
    class={`color-background absolute shadow-lg transition-all duration-300 ease-out bottom-0 left-0 ${
      compact ? "h-10 translate-y-0.5" : "h-12 translate-y-1"
    }`}
    style="width: 0px;"
  >
  </div>

  {
    filteredItems.map((item: NavItem, index: number) => {
      const tooltipText = item.tooltipText !== undefined ? item.tooltipText : item.label;
      const showItemTooltip = showTooltips && tooltipText !== "";
      const button = (
        <Button
          id={item.id}
          variant={item.variant as any}
          size="sm"
          data-index={index}
          class={compact ? "px-4 py-2" : "px-5 py-2.5"}
          data-active={index === activeItem ? "true" : "false"}
          dataAttributes={item.dataAttributes || {}}
          onclick={item.onclick}
        >
          {item.icon && <SimpleIcon name={item.icon} size="sm" class="mr-0 sm:mr-2" />}
          {(item.showLabel ?? !item.icon) ? (
            <span>{item.label}</span>
          ) : (
            <span class="sr-only">{item.label}</span>
          )}
        </Button>
      );
      return showItemTooltip ? (
        <Tooltip text={tooltipText} position="top" mobileClickable={true} inline={false}>
          {button}
        </Tooltip>
      ) : (
        button
      );
    })
  }
</nav>

<script>
  // Generic sliding tabs - works with any nav that has the right structure
  function initializeSlidingTabs(navId: string) {
    const nav = document.getElementById(navId);
    if (!nav) return;

    const tabsIndicator =
      nav.querySelector('[id$="-tabs-indicator"]') || nav.querySelector("#nav-tabs-indicator");
    const buttons = nav.querySelectorAll("button[data-index], button[id], a[data-index], a[id]");

    // Update active button data attributes only (styling handled by parent component)
    function updateActiveButton(activeButton: Element | null) {
      if (!nav) return;

      // Remove active state from all buttons (data attributes only)
      nav.querySelectorAll("button, a").forEach((btn) => {
        btn.setAttribute("data-active", "false");
      });

      // Set active state on the selected button (data attribute only)
      if (activeButton) {
        activeButton.setAttribute("data-active", "true");
      }
    }

    // Update sliding tabs indicator position
    function updateSlidingTabsIndicator(activeButton: Element | null) {
      if (!tabsIndicator || !activeButton || !nav) return;

      const navRect = nav.getBoundingClientRect();
      const buttonRect = activeButton.getBoundingClientRect();

      // Calculate position relative to the nav container, accounting for scroll offset
      const left = buttonRect.left - navRect.left + nav.scrollLeft;
      const width = buttonRect.width;

      // Update indicator position and size
      (tabsIndicator as HTMLElement).style.left = `${left}px`;
      (tabsIndicator as HTMLElement).style.width = `${width}px`;

      // Always try to center the active item
      setTimeout(() => {
        const buttonRect = activeButton.getBoundingClientRect();
        const navRect = nav.getBoundingClientRect();
        // Calculate button position relative to nav container
        const buttonLeft = buttonRect.left - navRect.left + nav.scrollLeft;
        // Center the button in the nav
        const scrollTo = buttonLeft - nav.clientWidth / 2 + buttonRect.width / 2;
        // Ensure we don't scroll past the bounds
        const maxScroll = nav.scrollWidth - nav.clientWidth;
        const boundedScrollTo = Math.max(0, Math.min(scrollTo, maxScroll));

        nav.scrollTo({
          left: boundedScrollTo,
          behavior: "smooth",
        });
      }, 300);
    }

    // Handle button clicks - update indicator position
    buttons.forEach((button: Element) => {
      button.addEventListener("click", function (this: HTMLElement) {
        updateActiveButton(this);
        updateSlidingTabsIndicator(this);
      });
    });

    // Function to determine active button from URL
    function getActiveButtonFromURL(): Element | null {
      if (!nav) return null;

      const urlParam = nav.getAttribute("data-url-param");
      if (!urlParam) return null; // No URL sync for this nav

      const urlParams = new URLSearchParams(window.location.search);
      const paramValue = urlParams.get(urlParam);

      if (paramValue) {
        // Numeric = dashboard project status filter (don't activate tab)
        const isNumeric = /^\d+$/.test(paramValue);
        if (isNumeric) return null;

        // Call the page-specific switch handler (e.g. switchTab, switchAuthTab)
        const handlerName = nav.getAttribute("data-switch-handler") || "switchTab";
        const fn = (window as any)[handlerName];
        if (typeof fn === "function") {
          fn(paramValue);
        } else {
          setTimeout(() => {
            const retryFn = (window as any)[handlerName];
            if (typeof retryFn === "function") retryFn(paramValue);
          }, 100);
        }
        // Find button with ID "{urlParam}-{paramValue}"
        const targetButton = nav.querySelector(`#${CSS.escape(urlParam + "-" + paramValue)}`);
        if (targetButton) return targetButton;
      }

      const firstButton = nav.querySelector("button, a");
      if (firstButton) firstButton.setAttribute("data-active", "true");
      return firstButton;
    }

    // Initialize indicator position - find button from URL or marked as active
    setTimeout(() => {
      let activeButton = getActiveButtonFromURL();

      // If no active button found, force the first button to be active
      if (!activeButton) {
        const firstButton =
          nav.querySelector("button, a") ||
          nav.querySelector("button:first-of-type, a:first-of-type");
        if (firstButton) {
          firstButton.setAttribute("data-active", "true");
          activeButton = firstButton;
        }
      }

      if (activeButton) {
        updateActiveButton(activeButton);
        updateSlidingTabsIndicator(activeButton);
      }
    }, 300);

    // Handle window resize to reposition indicator
    let resizeTimeout: NodeJS.Timeout;
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const activeButton = nav.querySelector('[data-active="true"]');
        if (activeButton) {
          updateSlidingTabsIndicator(activeButton);
        }
      }, 100);
    });
  }

  // Initialize function that can be called immediately or on DOMContentLoaded
  function initializeAllSlidingTabs() {
    // Initialize any sliding tabs found on the page
    const slidingTabsNavs = document.querySelectorAll('[class*="sliding-tabs"], [id*="nav"]');
    slidingTabsNavs.forEach((nav) => {
      if (nav.id) {
        initializeSlidingTabs(nav.id);
      }
    });

    // Also initialize common nav IDs
    const commonNavIds = [
      "project-nav",
      "tab-nav",
      "project-tab-nav",
      "settings-tab-nav",
      "banner-alerts-tab-nav",
      "auth-tabs",
      "project-form-tabs",
      "default-tab",
    ];
    commonNavIds.forEach((navId) => {
      if (document.getElementById(navId)) {
        initializeSlidingTabs(navId);
      }
    });
  }

  // Initialize immediately if DOM is ready, otherwise wait for DOMContentLoaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initializeAllSlidingTabs);
  } else {
    // DOM is already loaded, initialize immediately
    initializeAllSlidingTabs();
  }
</script>
