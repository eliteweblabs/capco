---
import SimpleIcon from "./SimpleIcon.astro";

/**
 * Simple visual user avatar. Use for project dashboard, staff pickers, etc.
 * For the auth/navbar area with UserDropdown, use AuthIcon.astro instead.
 *
 * Props (avatar resolved in order):
 * - avatarUrl: direct URL
 * - user: currentUser shape (profile.avatarUrl, user_metadata.picture)
 * - profile: profile shape (avatarUrl)
 * - users: array, uses first item as profile
 */
interface Props {
  avatarUrl?: string;
  user?: any;
  profile?: any;
  users?: any[];
  class?: string;
}

const { avatarUrl: avatarUrlProp, user, profile, users, class: className = "" } = Astro.props;

function resolveAvatarUrl(): string | undefined {
  if (avatarUrlProp) return avatarUrlProp;
  if (user) {
    return (
      user?.profile?.avatarUrl || user?.user_metadata?.avatarUrl || user?.user_metadata?.picture
    );
  }
  const p = profile || users?.[0];
  return p?.avatarUrl;
}

const avatarUrl = resolveAvatarUrl();
---

<span
  class={`inline-block h-8 w-8 overflow-hidden rounded-full ${className}`.trim()}
  role="img"
  aria-hidden="true"
>
  <img
    src={avatarUrl || undefined}
    alt="User avatar"
    class="avatar-img h-full w-full min-w-0 object-cover object-center p-0"
    style={!avatarUrl ? "display:none" : undefined}
    onerror="this.style.display='none'; const f=this.nextElementSibling; if(f) { f.classList.remove('hidden'); f.classList.add('flex'); }"
  />
  <span
    class:list={[
      "avatar-fallback",
      "h-full",
      "w-full",
      "items-center",
      "justify-center",
      avatarUrl ? "hidden" : "flex",
    ]}
  >
    <SimpleIcon name="user" size="md" />
  </span>
</span>
