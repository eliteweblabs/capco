---
import Tooltip from "./TooltipFloating.astro";

export interface Props {
  user?: {
    id: string;
    firstName?: string;
    lastName?: string;
    email?: string;
    avatarUrl?: string;
    companyName?: string;
  };
  users?: Array<
    | {
        id: string;
        firstName?: string;
        lastName?: string;
        email?: string;
        avatarUrl?: string;
        companyName?: string;
      }
    | null
    | undefined
  >;
  size?: "sm" | "md" | "lg";
  showTooltip?: boolean;
  maxDisplay?: number;
  tooltipPosition?: "top" | "bottom" | "left" | "right";
}

const {
  user,
  users,
  size = "md",
  showTooltip = true,
  maxDisplay = 3,
  tooltipPosition = "top",
} = Astro.props;

// Determine which users to display
const displayUsers = users || (user ? [user] : []);
// Filter out null/undefined users and get valid users
const validUsers = displayUsers.filter((userItem) => userItem && userItem.id) as Array<{
  id: string;
  firstName?: string;
  lastName?: string;
  email?: string;
  avatarUrl?: string;
  companyName?: string;
}>;
const visibleUsers = validUsers.slice(0, maxDisplay);
const remainingCount = validUsers.length - maxDisplay;

// Size classes
const sizeClasses = {
  sm: "w-6 h-6 text-xs",
  md: "w-8 h-8 text-sm",
  lg: "w-12 h-12 text-base",
};
---

<div class="flex items-center -space-x-2">
  {
    validUsers.length === 0 ? (
      <div
        class={`${sizeClasses[size]} flex items-center justify-center rounded-full border-2 border-white bg-gray-300 font-medium text-gray-600 shadow-sm`}
      >
        ?
      </div>
    ) : (
      visibleUsers.map((userItem, index) => {
        const fullName =
          `${userItem.firstName || ""} ${userItem.lastName || ""}`.trim() ||
          userItem.companyName ||
          "User";
        const initials = fullName
          .split(" ")
          .map((name) => name.charAt(0))
          .join("")
          .toUpperCase()
          .slice(0, 2);

        const tooltipText = `${fullName}${userItem.email ? `\n${userItem.email}` : ""}`;

        const avatarUrl = userItem.avatarUrl || undefined;
        return (
          <Tooltip
            text={tooltipText}
            position={tooltipPosition}
            disabled={!showTooltip}
            tooltipClass="whitespace-pre-line"
          >
            <div
              class={`${sizeClasses[size]} overflow-hidden cursor-pointer rounded-full border-2 border-white shadow-sm`}
              data-avatar-url={avatarUrl || ""}
              data-user-id={userItem.id}
              data-user-name={fullName}
            >
              <img
                src={avatarUrl}
                alt={fullName}
                class={`avatar-img ${sizeClasses[size]} min-w-0 object-cover object-center`}
                style={!avatarUrl ? "display:none" : undefined}
                onerror="this.style.display='none'; const f=this.nextElementSibling; if(f) { f.classList.remove('hidden'); f.classList.add('flex'); }"
              />
              <span
                class:list={[
                  "avatar-fallback",
                  sizeClasses[size],
                  "flex",
                  "items-center",
                  "justify-center",
                  "rounded-full",
                  "border-2",
                  "border-white",
                  "bg-gradient-to-br",
                  "from-primary-500",
                  "to-purple-600",
                  "font-medium",
                  "text-white",
                  "shadow-sm",
                  avatarUrl ? "hidden" : "",
                ]}
              >
                {initials}
              </span>
            </div>
          </Tooltip>
        );
      })
    )
  }

  {
    remainingCount > 0 && (
      <Tooltip
        text={`+${remainingCount} more user${remainingCount > 1 ? "s" : ""}`}
        position={tooltipPosition}
        disabled={!showTooltip}
      >
        <div
          class={`${sizeClasses[size]} flex cursor-pointer items-center justify-center rounded-full border-2 border-white bg-gray-500 font-medium text-white shadow-sm`}
        >
          +{remainingCount}
        </div>
      </Tooltip>
    )
  }
</div>
