---
import Button from "./Button.astro";
import CloseButton from "../ui/CloseButton.astro";
import SlideToggle from "./SlideToggle.astro";
import SimpleIcon from "./SimpleIcon.astro";
import { checkAuth } from "../../lib/auth";
// GDPR-Compliant Cookie Banner Component
// Handles cookie consent and preferences management
const { currentUser } = await checkAuth(Astro.cookies);
import { isContactPage as isContactPageUtils } from "../../pages/api/utils/backend-page-check";
const isContactPage = isContactPageUtils(Astro.url.pathname);
if (currentUser || isContactPage) {
  return;
}
---

<div
  id="cookie-banner"
  class="color-background fixed bottom-2 left-2 right-2 mx-auto hidden min-w-0 max-w-7xl translate-y-full transform rounded-xl px-4 py-4 antialiased shadow-lg transition-transform duration-300 ease-in-out sm:bottom-4 sm:left-4 sm:right-4 sm:px-6 md:bottom-6 md:left-6 md:right-6 lg:bottom-8 lg:left-8 lg:right-8 lg:px-8"
>
  <div class="absolute right-2 top-2 z-[1]">
    <CloseButton id="reject-all-btn" tooltipText="Reject all cookies" position="left" />
  </div>

  <div class="relative">
    <div
      class="flex min-w-0 flex-col items-start justify-between gap-4 sm:flex-row sm:items-center"
    >
      <!-- Cookie Information -->
      <div class="min-w-0 flex-1">
        <h3 class="mb-2 text-lg font-semibold text-gray-900 dark:text-white">üç™ We use cookies</h3>
        <p class="text-sm leading-relaxed text-gray-600 dark:text-gray-300">
          We use cookies to enhance your browsing experience, serve personalized content, and
          analyze our traffic. By clicking "Accept All", you consent to our use of cookies. You can
          manage your preferences or learn more in our
          <a
            href="/privacy"
            class="text-secondary-600 hover:text-secondary-700 hover:underline dark:text-secondary-400 dark:hover:text-secondary-300"
            >Privacy Policy</a
          >.
        </p>
      </div>

      <!-- Action Buttons -->
      <div class="flex flex-row items-center justify-end gap-3">
        <!-- Manage Preferences Button -->

        <!-- Accept All Button -->
        <Button
          id="accept-all-btn"
          variant="outline"
          size="sm"
          icon="check"
          iconPosition="right"
          fullWidth={false}
        >
          Accept
        </Button>

        <!-- Decline All Button -->
        <Button
          id="decline-all-btn"
          variant="primary"
          size="sm"
          icon="close"
          iconPosition="right"
          fullWidth={false}
        >
          Decline
        </Button>
        <!-- <Button
          id="manage-preferences-btn"
          variant="secondary"
          size="sm"
          class="hidden md:block"
          fullWidth={false}
        >
          Preferences
        </Button> -->
      </div>
    </div>

    <!-- Cookie Preferences Accordion (inline in banner) -->
    <div
      id="cookie-preferences-accordion"
      class="mt-4 border-t border-gray-200 pt-4 dark:border-gray-700"
      data-accordion="collapse"
    >
      <h2 id="cookie-preferences-accordion-heading">
        <button
          type="button"
          id="cookie-preferences-accordion-trigger"
          class="flex w-full items-center justify-between rounded p-2 text-left text-sm font-medium text-gray-900 hover:bg-gray-100 focus:ring-2 focus:ring-gray-200 dark:text-white dark:hover:bg-gray-800 dark:focus:ring-gray-700"
          data-accordion-target="#cookie-preferences-accordion-body"
          aria-expanded="false"
          aria-controls="cookie-preferences-accordion-body"
        >
          <span>Cookie Preferences</span>
          <svg
            data-accordion-icon
            class="h-4 w-4 shrink-0 rotate-180"
            fill="currentColor"
            viewBox="0 0 20 20"
            aria-hidden="true"
          >
            <path
              fill-rule="evenodd"
              d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
              clip-rule="evenodd"></path>
          </svg>
        </button>
      </h2>
      <div
        id="cookie-preferences-accordion-body"
        class="hidden"
        aria-labelledby="cookie-preferences-accordion-heading"
      >
        <div class="space-y-4 py-4">
          <p class="text-sm text-gray-600 dark:text-gray-300">
            Manage your cookie preferences below. Some cookies are essential for the website to
            function properly.
          </p>

          <!-- Essential Cookies -->
          <div class="flex items-center justify-between gap-4">
            <div>
              <h3 class="text-sm font-medium text-gray-900 dark:text-white">Essential Cookies</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Required for basic functionality, authentication, and security.
              </p>
            </div>
            <span class="shrink-0 text-xs text-gray-500 dark:text-gray-400">Always active</span>
          </div>

          <!-- Analytics Cookies -->
          <div class="flex items-center justify-between gap-4">
            <div>
              <h3 class="text-sm font-medium text-gray-900 dark:text-white">Analytics Cookies</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Anonymous information about how visitors use the site.
              </p>
            </div>
            <SlideToggle id="analytics-cookies" checked={true} />
          </div>

          <!-- Marketing Cookies -->
          <div class="flex items-center justify-between gap-4">
            <div>
              <h3 class="text-sm font-medium text-gray-900 dark:text-white">Marketing Cookies</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Used to display relevant advertisements.
              </p>
            </div>
            <SlideToggle id="marketing-cookies" checked={true} />
          </div>

          <!-- Functional Cookies -->
          <div class="flex items-center justify-between gap-4">
            <div>
              <h3 class="text-sm font-medium text-gray-900 dark:text-white">Functional Cookies</h3>
              <p class="text-xs text-gray-500 dark:text-gray-400">
                Remember your preferences and enhance functionality.
              </p>
            </div>
            <SlideToggle id="functional-cookies" checked={true} />
          </div>

          <div class="flex flex-wrap gap-2 pt-2">
            <Button id="save-preferences-btn" variant="primary" size="sm">
              Save Preferences
            </Button>
            <Button
              id="accept-all-preferences-btn"
              variant="secondary"
              size="sm"
              icon="check"
              iconPosition="right"
            >
              Accept
            </Button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Cookie Banner Management
  document.addEventListener("DOMContentLoaded", function () {
    const cookieBanner = document.getElementById("cookie-banner");
    const preferencesAccordionBody = document.getElementById("cookie-preferences-accordion-body");
    const preferencesAccordionTrigger = document.getElementById(
      "cookie-preferences-accordion-trigger"
    );
    const acceptAllBtn = document.getElementById("accept-all-btn");
    const rejectAllBtn = document.getElementById("reject-all-btn");
    const declineAllBtn = document.getElementById("decline-all-btn");
    const managePreferencesBtn = document.getElementById("manage-preferences-btn");
    const savePreferencesBtn = document.getElementById("save-preferences-btn");
    const acceptAllPreferencesBtn = document.getElementById("accept-all-preferences-btn");

    // Check if user has already made a choice
    const cookieConsent = localStorage.getItem("cookie-consent");

    if (!cookieConsent) {
      // Show banner after a short delay
      setTimeout(() => {
        cookieBanner?.classList.remove("translate-y-full", "hidden");

        const element = document.querySelectorAll(".hide-on-form-focus");
        if (!element.length) return;

        // Set up CSS transitions for fade effect
        const transitionDuration = 300; // milliseconds
        const blurDelay = 100; // Delay before showing (prevents flash when tabbing between inputs)
        let blurTimeout: ReturnType<typeof setTimeout> | null = null;

        element.forEach((el) => {
          const htmlEl = el as HTMLElement;
          htmlEl.style.transition = `opacity ${transitionDuration}ms ease-in-out`;
          htmlEl.style.opacity = "0";
        });
        // If page is already scrolled when banner appears, hide it
        requestAnimationFrame(updateBannerVisibilityFromScroll);
      }, 1000);

      // Hide banner when user scrolls down (railway.com-style); show again when back at top
      const SCROLL_HIDE_THRESHOLD_PX = 120;
      let scrollTicking = false;

      function updateBannerVisibilityFromScroll() {
        if (localStorage.getItem("cookie-consent")) return; // user already chose
        const scrollY = window.scrollY;
        const isVisible = !cookieBanner?.classList.contains("translate-y-full");
        if (scrollY > SCROLL_HIDE_THRESHOLD_PX && isVisible) {
          cookieBanner?.classList.add("translate-y-full");
        } else if (scrollY <= SCROLL_HIDE_THRESHOLD_PX && !isVisible) {
          cookieBanner?.classList.remove("translate-y-full");
        }
        scrollTicking = false;
      }

      window.addEventListener(
        "scroll",
        () => {
          if (scrollTicking) return;
          scrollTicking = true;
          requestAnimationFrame(updateBannerVisibilityFromScroll);
        },
        { passive: true }
      );
    } else {
      // cookieBanner?.remove();
    }

    // Accept All Cookies
    function acceptAllCookies() {
      const consent = {
        essential: true,
        analytics: true,
        marketing: true,
        functional: true,
        timestamp: new Date().toISOString(),
      };

      localStorage.setItem("cookie-consent", JSON.stringify(consent));
      hideBanner();

      // Initialize analytics and other services
      initializeServices(consent);

      // Show success message
      if ((window as any).showNotice) {
        (window as any).showNotice(
          "success",
          "Cookies Accepted",
          "Your cookie preferences have been saved.",
          1500
        );
      }
    }

    // Reject All Cookies (except essential)
    function rejectAllCookies() {
      const consent = {
        essential: true,
        analytics: false,
        marketing: false,
        functional: false,
        timestamp: new Date().toISOString(),
      };

      localStorage.setItem("cookie-consent", JSON.stringify(consent));
      hideBanner();

      // Initialize only essential services
      initializeServices(consent);

      // Show success message
      if ((window as any).showNotice) {
        (window as any).showNotice(
          "success",
          "Cookies Rejected",
          "Only essential cookies will be used.",
          1500
        );
      }
    }

    // Save Custom Preferences
    function saveCustomPreferences() {
      const analytics = document.getElementById("analytics-cookies") as HTMLInputElement;
      const marketing = document.getElementById("marketing-cookies") as HTMLInputElement;
      const functional = document.getElementById("functional-cookies") as HTMLInputElement;

      const consent = {
        essential: true,
        analytics: analytics?.checked || false,
        marketing: marketing?.checked || false,
        functional: functional?.checked || false,
        timestamp: new Date().toISOString(),
      };

      localStorage.setItem("cookie-consent", JSON.stringify(consent));
      hideBanner();
      hidePreferencesPanel();

      // Initialize services based on preferences
      initializeServices(consent);

      // Show success message
      if ((window as any).showNotice) {
        (window as any).showNotice(
          "success",
          "Preferences Saved",
          "Your cookie preferences have been updated.",
          1500
        );
      }
    }

    // Hide Banner
    function hideBanner() {
      cookieBanner?.classList.add("translate-y-full");
      const element = document.querySelectorAll(".hide-on-form-focus");
      if (!element.length) return;

      // Set up CSS transitions for fade effect
      const transitionDuration = 300; // milliseconds
      const blurDelay = 100; // Delay before showing (prevents flash when tabbing between inputs)
      let blurTimeout: ReturnType<typeof setTimeout> | null = null;

      element.forEach((el) => {
        const htmlEl = el as HTMLElement;
        htmlEl.style.transition = `opacity ${transitionDuration}ms ease-in-out`;
        htmlEl.style.opacity = "1";
      });
    }

    // Show Preferences accordion (expand)
    function showPreferencesPanel() {
      preferencesAccordionBody?.classList.remove("hidden");
      preferencesAccordionTrigger?.setAttribute("aria-expanded", "true");
    }

    // Hide Preferences accordion (collapse)
    function hidePreferencesPanel() {
      preferencesAccordionBody?.classList.add("hidden");
      preferencesAccordionTrigger?.setAttribute("aria-expanded", "false");
    }

    // Initialize Services Based on Consent
    function initializeServices(consent: any) {
      // console.log("üç™ [COOKIE-BANNER] Initializing services with consent:", consent);

      // Essential services (always enabled)
      // These are already running (authentication, basic functionality)

      // Analytics services
      if (consent.analytics) {
        // Initialize Google Analytics, etc.
        // console.log("üç™ [COOKIE-BANNER] Analytics services enabled");
        // Example: gtag('consent', 'update', { 'analytics_storage': 'granted' });
      }

      // Marketing services
      if (consent.marketing) {
        // Initialize marketing tracking, etc.
        // console.log("üç™ [COOKIE-BANNER] Marketing services enabled");
        // Example: gtag('consent', 'update', { 'ad_storage': 'granted' });
      }

      // Functional services
      if (consent.functional) {
        // Initialize enhanced functionality
        // console.log("üç™ [COOKIE-BANNER] Functional services enabled");
      }
    }

    // Load existing preferences into modal
    function loadPreferencesIntoModal() {
      const existingConsent = localStorage.getItem("cookie-consent");
      if (existingConsent) {
        const consent = JSON.parse(existingConsent);
        const analytics = document.getElementById("analytics-cookies") as HTMLInputElement;
        const marketing = document.getElementById("marketing-cookies") as HTMLInputElement;
        const functional = document.getElementById("functional-cookies") as HTMLInputElement;

        if (analytics) analytics.checked = consent.analytics;
        if (marketing) marketing.checked = consent.marketing;
        if (functional) functional.checked = consent.functional;
      }
    }

    // Event Listeners
    acceptAllBtn?.addEventListener("click", acceptAllCookies);
    rejectAllBtn?.addEventListener("click", rejectAllCookies);
    declineAllBtn?.addEventListener("click", rejectAllCookies);

    managePreferencesBtn?.addEventListener("click", () => {
      loadPreferencesIntoModal();
      showPreferencesPanel();
    });
    savePreferencesBtn?.addEventListener("click", saveCustomPreferences);
    acceptAllPreferencesBtn?.addEventListener("click", acceptAllCookies);

    // Initialize services on page load if consent already exists
    if (cookieConsent) {
      const consent = JSON.parse(cookieConsent);
      initializeServices(consent);
    }
  });

  // Export functions for external use
  (window as any).cookieBanner = {
    show: () => {
      const banner = document.getElementById("cookie-banner");
      banner?.classList.remove("translate-y-full");
    },
    hide: () => {
      const banner = document.getElementById("cookie-banner");
      banner?.classList.add("translate-y-full");
    },
    getConsent: () => {
      const consent = localStorage.getItem("cookie-consent");
      return consent ? JSON.parse(consent) : null;
    },
    updateConsent: (newConsent: any) => {
      localStorage.setItem("cookie-consent", JSON.stringify(newConsent));
    },
  };
</script>

<style>
  /* Ensure banner appears above other content and never causes overflow-x */
  #cookie-banner {
    z-index: 11111;
    max-width: 100vw;
    overflow-x: hidden;
    /* When "hidden" (translate-y-full), push fully off-screen so no sliver shows */
  }

  #cookie-banner.translate-y-full {
    transform: translateY(calc(100% + 2rem));
  }

  #cookie-preferences-modal {
    z-index: 10000;
  }

  /* Smooth transitions */
  .transition-transform {
    transition-duration: 300ms;
    transition-property: transform;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }
</style>
