---
// import { getI18N } from "@/i18n";
import BoxIcon from "./BoxIcon.astro";
import Logo from "./Logo.astro";
import AuthIcon from "./AuthIcon.astro";
// import LanguagePicker from "../LanguagePicker.astro";
import Tooltip from "./Tooltip.astro";
// import SectionContainer from "./SectionContainer.astro";
// import NavLi from "./NavLi.astro";
import ThemeToggle from "./ThemeToggle.astro";

interface Props {
  isAuth: boolean;
  currentUser: any;
  currentRole: string | null;
  session: any;
}

// console.log("ðŸ“‹ [HEADER] Header component loading...");

const { isAuth, currentUser, session, currentRole } = Astro.props;

// Get current URL and determine page type
const currentUrl = Astro.url.pathname;
import { isBackendPage } from "../../pages/api/backend-page-check";
const isBackend = isBackendPage(currentUrl);

// Navigation schema
type UserRole = "any" | "Client" | "Admin" | "Staff";
type NavType = "frontend" | "backend";

interface NavItem {
  label: string;
  href: string;
  roles: UserRole[]; // Array of roles that can access this item
  isPrimary: boolean; // For styling primary CTA buttons
  pageType: NavType; // Frontend or backend navigation
}

const navigation: NavItem[] = [
  // Always visible - Home link for easy return to main site
  // {
  //   label: "Home",
  //   href: "/",
  //   roles: ["any"],
  //   pageType: "frontend",
  //   isPrimary: currentUrl === "/",
  // },

  // Frontend navigation (hidden on backend pages to reduce clutter)
  {
    label: "About",
    href: "/about",
    roles: ["any"],
    pageType: "frontend",
    isPrimary: currentUrl.startsWith("/about"),
  },
  {
    label: "Projects",
    href: "/projects",
    roles: ["any"],
    pageType: "frontend",
    isPrimary: currentUrl.startsWith("/projects"),
  },

  // Backend navigation (shown on backend pages)
  {
    label: "New Project",
    href: "/dashboard#new-project",
    roles: ["Client", "Admin", "Staff"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/dashboard#new-project"),
  },
  {
    label: "Discussions",
    href: "/discussions",
    roles: ["Admin", "Staff"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/discussions"),
  },
  {
    label: "Global Activity",
    href: "/admin/global-activity",
    roles: ["Admin"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/admin/global-activity"),
  },
  {
    label: "Users",
    href: "/users",
    roles: ["Admin"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/users"),
  },
];

// Filter navigation items based on auth state, role, and page type
function getVisibleNavItems(
  navItems: NavItem[],
  isAuth: boolean,
  userRole?: string | null,
  isBackend: boolean = false
): NavItem[] {
  return navItems.filter((item) => {
    // Always show Home link - users should always be able to return to main site
    if (item.href === "/") {
      return true;
    }

    // Page type filtering - hide other frontend nav on backend pages to reduce clutter
    if (isBackend && item.pageType === "frontend") {
      return false;
    }

    // Show backend nav only on backend pages
    if (item.pageType === "backend" && !isBackend) {
      return false;
    }

    // If item allows "any" role, show it based on page type rules above
    if (item.roles.includes("any")) return true;

    // If user is not authenticated, only show "any" role items
    if (!isAuth) return false;

    // Map database role to our role system
    const mappedRole: UserRole =
      userRole === "Admin" ? "Admin" : userRole === "Staff" ? "Staff" : "Client";

    // Check if user's role is in the allowed roles for this item
    return item.roles.includes(mappedRole);
  });
}

const visibleNavigation = getVisibleNavItems(navigation, isAuth, currentRole, isBackend);
---

<header
  class="section sticky top-0 z-50 mx-auto border-b border-gray-200 bg-hub-background p-6 dark:border-gray-700 dark:bg-hub-background-dark"
  style="position: -webkit-sticky !important; position: sticky !important; transform: translateZ(0) !important; backface-visibility: hidden !important; will-change: transform !important;"
>
  <!-- <SectionContainer> -->
  <div class="flex items-center justify-between">
    <Logo />

    {
      isAuth && isBackend && currentUrl !== "/dashboard" && (
        <a
          href="/dashboard"
          class="inline-flex items-center rounded-lg bg-gray-500 px-3 py-2 text-sm font-medium text-white transition-colors hover:bg-gray-600"
        >
          <BoxIcon name="arrow-back" class="mr-2" />
          <span class="hidden md:inline">Back to Projects</span>
        </a>
      )
    }
    <!-- Navigation (Desktop) -->
    <nav class="hidden items-center space-x-8 md:flex">
      {
        visibleNavigation.map((item) =>
          item.isPrimary ? (
            <a
              href={item.href}
              class="inline-flex items-center rounded-lg bg-red-600 px-4 py-2 font-medium text-white transition-colors hover:bg-red-700"
            >
              {item.label}
            </a>
          ) : (
            <a
              href={item.href}
              class="font-medium text-gray-700 transition-colors hover:text-red-600 dark:text-gray-300 dark:hover:text-red-400"
            >
              {item.label}
            </a>
          )
        )
      }
    </nav>

    <div class="flex items-center gap-2">
      <!-- Admin Quick Actions -->
      <ThemeToggle />
      {
        currentRole === "Admin" && isBackend && (
          <>
            <Tooltip content="Global Activity Feed" id="global-activity-tooltip">
              <a
                href="/admin/global-activity"
                aria-label="btn-global-activity"
                class="flex size-8 items-center justify-center rounded-full bg-purple-600 text-white transition-colors hover:bg-purple-700"
              >
                <BoxIcon name="pulse" class="text-lg" />
              </a>
            </Tooltip>
            <Tooltip
              content="New Project"
              id="new-project-tooltip"
              class="cursor-pointer md:hidden"
            >
              <a
                href="/dashboard#new-project"
                aria-label="btn-new-project"
                class="flex size-8 items-center justify-center rounded-full bg-blue-600 text-white transition-colors hover:bg-blue-700"
              >
                <BoxIcon name="plus-circle" class="text-lg" />
              </a>
            </Tooltip>

            <Tooltip content="Users" id="add-user-tooltip">
              <a
                href="/users"
                aria-label="btn-add-user"
                class="flex size-8 items-center justify-center rounded-full bg-blue-600 text-white transition-colors hover:bg-blue-700"
              >
                <BoxIcon name="user-plus" class="text-lg" />
              </a>
            </Tooltip>
          </>
        )
      }

      {/* <LanguagePicker /> */}

      <AuthIcon
        isAuth={isAuth}
        currentUser={currentUser}
        currentRole={currentRole}
        session={session}
      />

      {/* Mobile Menu Button (Hamburger) */}
      <button
        type="button"
        id="mobile-menu-btn"
        aria-controls="drawer-example"
        aria-label="Toggle mobile menu"
        class="hamburger z-50 size-10 text-gray-700 transition-colors dark:text-gray-300 md:hidden"
      >
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </button>
      {/* Mobile Navigation Menu */}
      <div
        id="drawer-example"
        class="fixed left-0 top-0 z-40 h-screen w-screen -translate-x-full overflow-y-auto bg-white p-4 transition-transform dark:bg-gray-800"
        tabindex="-1"
        aria-labelledby="drawer-label"
      >
        <nav class="space-y-4 px-6 py-4">
          {/* Navigation Items */}
          {
            visibleNavigation.map((item) =>
              item.isPrimary ? (
                <a
                  href={item.href}
                  class="block w-full rounded-lg bg-red-600 px-4 py-3 text-center font-medium text-white transition-colors hover:bg-red-700"
                >
                  {item.label}
                </a>
              ) : (
                <a
                  href={item.href}
                  class="block py-2 font-medium text-gray-700 transition-colors hover:text-red-600 dark:text-gray-300 dark:hover:text-red-400"
                >
                  {item.label}
                </a>
              )
            )
          }
        </nav>
      </div>
    </div>
  </div>
  <!-- </SectionContainer> -->
</header>

<script>
  // Virtual keyboard detection
  let initialViewportHeight = window.innerHeight;
  let isVirtualKeyboardOpen = false;

  function detectVirtualKeyboard() {
    console.log("ðŸ“± [HEADER] Detecting virtual keyboard");
    const currentHeight = window.innerHeight;
    const heightDifference = initialViewportHeight - currentHeight;

    // If viewport height decreased by more than 150px, likely virtual keyboard is open
    if (heightDifference > 150) {
      if (!isVirtualKeyboardOpen) {
        isVirtualKeyboardOpen = true;
        console.log("ðŸ“± [HEADER] Virtual keyboard detected as OPEN");
        document.body.classList.add("virtual-keyboard-open");
      }
    } else {
      if (isVirtualKeyboardOpen) {
        isVirtualKeyboardOpen = false;
        console.log("ðŸ“± [HEADER] Virtual keyboard detected as CLOSED");
        document.body.classList.remove("virtual-keyboard-open");
      }
    }
  }

  // Safari 18 beta fix - ensure header stays fixed to top
  function fixHeaderPosition() {
    console.log("ðŸ“± [HEADER] Fixing header position");
    const header = document.querySelector("header");
    if (header) {
      // Skip header fixes when virtual keyboard is open to prevent layout issues
      if (isVirtualKeyboardOpen) {
        console.log("ðŸ“± [HEADER] Skipping header fixes - virtual keyboard is open");
        return;
      }

      // Force re-apply positioning with !important
      header.style.setProperty("position", "sticky", "important");
      header.style.setProperty("top", "0", "important");
      header.style.setProperty("z-index", "50", "important"); // Increased z-index
      header.style.setProperty("transform", "translateZ(0)", "important"); // Force hardware acceleration
      header.style.setProperty("backface-visibility", "hidden", "important"); // Prevent flickering
      header.style.setProperty("will-change", "transform", "important"); // Optimize for transforms

      // Additional Safari-specific fixes
      header.style.setProperty("position", "-webkit-sticky", "important"); // Webkit fallback

      // Force a reflow to ensure styles are applied
      header.offsetHeight;
    }
  }

  // Apply fix on load and multiple events
  fixHeaderPosition();

  // Add multiple event listeners to catch Safari 18 beta resets
  window.addEventListener("resize", () => {
    console.log("ðŸ“± [HEADER] Resizing window");
    detectVirtualKeyboard();
    fixHeaderPosition();
  });
  window.addEventListener("orientationchange", () => {
    // Update initial height after orientation change
    console.log("ðŸ“± [HEADER] Orientation changed");
    setTimeout(() => {
      initialViewportHeight = window.innerHeight;
      detectVirtualKeyboard();
      fixHeaderPosition();
    }, 100);
  });
  window.addEventListener("scroll", fixHeaderPosition);
  window.addEventListener("scroll", fixHeaderPosition);
  window.addEventListener("focus", fixHeaderPosition);
  window.addEventListener("blur", fixHeaderPosition);

  // Additional Safari mobile specific events
  window.addEventListener("touchstart", fixHeaderPosition);
  window.addEventListener("touchend", fixHeaderPosition);
  window.addEventListener("touchmove", fixHeaderPosition);
  document.addEventListener("visibilitychange", fixHeaderPosition);
  window.addEventListener("pageshow", fixHeaderPosition);
  window.addEventListener("pagehide", fixHeaderPosition);

  // More aggressive periodic check for homepage (every 1 second)
  const isHomepage = window.location.pathname === "/" || window.location.pathname === "/index.html";
  const checkInterval = isHomepage ? 1000 : 3000;
  setInterval(fixHeaderPosition, checkInterval);

  // Use MutationObserver to catch DOM changes that might reset positioning
  const headerObserver = new MutationObserver((mutations) => {
    let shouldFix = false;
    mutations.forEach((mutation) => {
      if (
        mutation.type === "attributes" &&
        (mutation.attributeName === "style" || mutation.attributeName === "class")
      ) {
        const target = mutation.target;
        if (target instanceof HTMLElement && target.tagName === "HEADER") {
          shouldFix = true;
        }
      }
    });
    if (shouldFix) {
      setTimeout(fixHeaderPosition, 50);
    }
  });

  // Start observing
  const header = document.querySelector("header");
  if (header) {
    headerObserver.observe(header, {
      attributes: true,
      attributeFilter: ["style", "class"],
    });
  }

  // console.log("ðŸ“‹ [HEADER] Header initialized with Safari 18 beta fix");
</script>

<style>
  .hamburger .line {
    width: 20px;
    background-color: currentColor;
    height: 2px;
    display: block;
    margin: 3px auto;
    border-radius: 1px;
    -webkit-transition: all 0.3s ease-in-out;
    -o-transition: all 0.3s ease-in-out;
    transition: all 0.3s ease-in-out;
  }
  #mobile-menu-btn {
    -webkit-transition: all 0.3s ease-in-out;
    -o-transition: all 0.3s ease-in-out;
    transition: all 0.3s ease-in-out;
  }

  #mobile-menu-btn.is-active {
    animation: smallbig 0.6s forwards;
  }

  #mobile-menu-btn.is-active .line:nth-child(1),
  #mobile-menu-btn.is-active .line:nth-child(2),
  #mobile-menu-btn.is-active .line:nth-child(3) {
    -webkit-transition-delay: 0.2s;
    -o-transition-delay: 0.2s;
    transition-delay: 0.2s;
  }

  #mobile-menu-btn.is-active .line:nth-child(2) {
    opacity: 0;
  }

  #mobile-menu-btn.is-active .line:nth-child(1) {
    -webkit-transform: translateY(5px) rotate(45deg);
    -ms-transform: translateY(5px) rotate(45deg);
    -o-transform: translateY(5px) rotate(45deg);
    transform: translateY(5px) rotate(45deg);
  }

  #mobile-menu-btn.is-active .line:nth-child(3) {
    -webkit-transform: translateY(-5px) rotate(-45deg);
    -ms-transform: translateY(-5px) rotate(-45deg);
    -o-transform: translateY(-5px) rotate(-45deg);
    transform: translateY(-5px) rotate(-45deg);
  }

  @keyframes smallbig {
    0%,
    100% {
      -webkit-transform: scale(1);
      -ms-transform: scale(1);
      -o-transform: scale(1);
      transform: scale(1);
    }

    50% {
      -webkit-transform: scale(0);
      -ms-transform: scale(0);
      -o-transform: scale(0);
      transform: scale(0);
    }
  }

  /* Safari 18 beta fix for header */
  header {
    position: sticky !important;
    top: 0 !important;
    z-index: 10 !important;
    transform: translateZ(0) !important; /* Force hardware acceleration */
  }

  /* Virtual keyboard open state - prevent header interference */
  .virtual-keyboard-open header {
    position: relative !important;
    top: auto !important;
    transform: none !important;
  }

  /* Adjust sticky elements when virtual keyboard is open */
  .virtual-keyboard-open #sticky-container {
    bottom: 0.5rem !important;
    transform: translateY(-50px) !important;
  }

  /* Prevent layout shifts when virtual keyboard opens/closes */
  .virtual-keyboard-open {
    overflow: hidden;
  }
</style>
