---
import { isBackendPage } from "../../pages/api/backend-page-check";
import AuthIcon from "./AuthIcon.astro";
import BoxIcon from "./BoxIcon.astro";
import ThemeToggle from "./ThemeToggle.astro";
import Logo from "./Logo.astro";
import Button from "./Button.astro";
import ProjectDrawer from "../project/ProjectDrawer.astro";

interface Props {
  isAuth: boolean;
  currentUser: any;
  currentRole: string | null;
  session: any;
}

// Header component
const { isAuth, currentUser, session, currentRole } = Astro.props;

// Fetch user's projects for the drawer
let projects: any[] = [];
if (isAuth && currentUser?.id) {
  try {
    const { supabase } = await import("../../lib/supabase");
    if (supabase) {
      const { data, error } = await supabase
        .from("projects")
        .select("id, title, address, status, created_at")
        .order("created_at", { ascending: false });

      if (!error && data) {
        projects = data;
      }
    }
  } catch (error) {
    console.error("Error fetching projects for header:", error);
  }
}

// Get current URL and determine page type
const currentUrl = Astro.url.pathname;
const isBackend = isBackendPage(currentUrl);

// Navigation schema
type UserRole = "any" | "Client" | "Admin" | "Staff";
type NavType = "frontend" | "backend";

interface NavItem {
  label: string;
  href: string;
  roles: UserRole[];
  pageType: NavType;
  isPrimary: boolean;
  isDrawer?: boolean; // Special flag for drawer trigger
  mobileOnly?: boolean; // Show only on mobile
  desktopOnly?: boolean; // Show only on desktop
  buttonStyle?: "primary" | "secondary" | "ghost" | "outline"; // Button variant
  isDropdown?: boolean; // Is a dropdown menu
  dropdownItems?: DropdownItem[]; // Items for dropdown
}

interface DropdownItem {
  label: string;
  href: string;
}

interface DropdownMenu {
  label: string;
  items: DropdownItem[];
}

// Navigation items
const navItems: NavItem[] = [
  // Frontend navigation (hidden on backend pages to reduce clutter)
  {
    label: "Why CAPCo",
    href: "#",
    roles: ["any"],
    pageType: "frontend",
    isPrimary: false,
    isDropdown: true,
    dropdownItems: [
      { label: "Unified Fire Protection Platform", href: "/solutions" },
      { label: "CAPCo vs Competitors", href: "/solutions" },
      { label: "Move to CAPCo", href: "/solutions" },
      { label: "See Our Customers", href: "/customers" },
    ],
  },
  {
    label: "Pricing",
    href: "/pricing",
    roles: ["any"],
    pageType: "frontend",
    isPrimary: currentUrl.startsWith("/pricing"),
    desktopOnly: true,
  },
  {
    label: "Book Demo",
    href: "/demo",
    roles: ["any"],
    pageType: "frontend",
    isPrimary: currentUrl.startsWith("/demo"),
    buttonStyle: "primary",
    desktopOnly: true,
  },
  {
    label: "Log In",
    href: "/login",
    roles: ["any"],
    pageType: "frontend",
    isPrimary: currentUrl.startsWith("/login"),
    buttonStyle: "ghost",
    desktopOnly: true,
  },

  // Backend navigation (shown on backend pages)
  {
    label: "New Project",
    href: "/dashboard#new-project",
    roles: ["Client", "Admin", "Staff"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/dashboard#new-project"),
  },
  {
    label: "Projects",
    href: "#",
    roles: ["Client", "Admin", "Staff"],
    pageType: "backend",
    isPrimary: false,
    isDrawer: true, // Special flag for drawer trigger
  },
  {
    label: "Discussions",
    href: "/discussions",
    roles: ["Admin", "Staff"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/discussions"),
  },
  {
    label: "Global Activity",
    href: "/admin/global-activity",
    roles: ["Admin"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/admin/global-activity"),
  },
  {
    label: "Users",
    href: "/users",
    roles: ["Admin"],
    pageType: "backend",
    isPrimary: currentUrl.startsWith("/users"),
  },
];

// Dropdown menus are now integrated into navItems array above

// Filter navigation items based on auth state, role, and page type
function getVisibleNavItems(
  navItems: NavItem[],
  isAuth: boolean,
  currentRole: string | null,
  isBackend: boolean
): NavItem[] {
  return navItems.filter((item) => {
    // Show frontend items when not on backend pages
    if (item.pageType === "frontend" && !isBackend) {
      return (
        item.roles.includes("any") ||
        (isAuth && currentRole && item.roles.includes(currentRole as UserRole))
      );
    }

    // Show backend items when on backend pages and authenticated
    if (item.pageType === "backend" && isBackend && isAuth) {
      return (
        item.roles.includes("any") || (currentRole && item.roles.includes(currentRole as UserRole))
      );
    }

    return false;
  });
}

const visibleNavItems = getVisibleNavItems(navItems, isAuth, currentRole, isBackend);
---

<header
  class="bg-background-light dark:bg-background-dark border-b border-border-light dark:border-border-dark sticky top-0 z-50 backdrop-blur-sm"
>
  <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      {/* Logo */}
      <div class="flex-shrink-0">
        <Logo />
      </div>

      {/* Unified Navigation - Desktop */}
      <div class="hidden md:flex items-center space-x-8">
        {/* Navigation Items */}
        {
          visibleNavItems
            .filter((item) => !item.mobileOnly) // Show only desktop items
            .map((item) => {
              // Handle dropdown items
              if (item.isDropdown && item.dropdownItems) {
                return (
                  <div class="relative group">
                    <Button
                      variant="ghost"
                      size="sm"
                      class="text-primary dark:text-primary-dark hover:text-primary-600 px-3 py-2 text-sm font-medium flex items-center"
                      icon="chevron-down"
                      iconPosition="right"
                    >
                      {item.label}
                    </Button>
                    <div class="absolute left-0 mt-2 w-64 bg-background-card dark:bg-background-card-dark rounded-lg shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 border border-border-light dark:border-border-dark">
                      <div class="py-1">
                        {item.dropdownItems.map((dropdownItem) => (
                          <a
                            href={dropdownItem.href}
                            class="block px-4 py-2 text-sm text-secondary dark:text-secondary-dark hover:bg-neutral-100 dark:hover:bg-neutral-700"
                          >
                            {dropdownItem.label}
                          </a>
                        ))}
                      </div>
                    </div>
                  </div>
                );
              }

              // Handle drawer items
              if (item.isDrawer) {
                return (
                  <Button
                    variant="ghost"
                    size="sm"
                    dataAttributes={{
                      "drawer-target": "project-drawer",
                      "drawer-toggle": "project-drawer",
                    }}
                    class="px-3 py-2 text-sm font-medium text-primary dark:text-primary-dark hover:text-primary-600 transition-colors"
                  >
                    {item.label}
                  </Button>
                );
              }

              // Handle button style items
              if (item.buttonStyle) {
                return (
                  <Button
                    href={item.href}
                    variant={item.buttonStyle}
                    size="sm"
                    class={
                      item.buttonStyle === "ghost"
                        ? "text-primary dark:text-primary-dark hover:text-primary-600"
                        : ""
                    }
                  >
                    {item.label}
                  </Button>
                );
              }

              // Handle regular links
              return (
                <a
                  href={item.href}
                  class={`px-3 py-2 text-sm font-medium transition-colors ${
                    item.isPrimary
                      ? "text-primary-600 dark:text-primary-400"
                      : "text-primary dark:text-primary-dark hover:text-primary-600"
                  }`}
                >
                  {item.label}
                </a>
              );
            })
        }

        {/* Theme Toggle */}
        <ThemeToggle />

        {/* Auth Section */}
        {
          isAuth ? (
            <div class="text-center">
              <button
                class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800"
                type="button"
                data-drawer-target="drawer-right-example"
                data-drawer-show="drawer-right-example"
                data-drawer-placement="right"
                aria-controls="drawer-right-example"
              >
                <AuthIcon
                  isAuth={isAuth}
                  currentUser={currentUser}
                  currentRole={currentRole}
                  session={session}
                />
              </button>
            </div>
          ) : null
        }
      </div>

      {/* Mobile Controls */}
      <div class="md:hidden flex items-center space-x-4">
        <ThemeToggle />
        <AuthIcon
          isAuth={isAuth}
          currentUser={currentUser}
          currentRole={currentRole}
          session={session}
        />
      </div>
    </div>
  </nav>
</header>

<!-- Project Drawer -->
{
  isAuth && (
    <ProjectDrawer
      projects={projects}
      currentProjectId={
        currentUrl.includes("/project/")
          ? currentUrl.split("/project/")[1]?.split("?")[0] || ""
          : ""
      }
      currentUser={currentUser}
      currentRole={currentRole || ""}
    />
  )
}

<style>
  .hamburger .line {
    width: 20px;
    background-color: currentColor;
    height: 2px;
    display: block;
    margin: 3px auto;
    border-radius: 1px;
    -webkit-transition: all 0.3s ease-in-out;
    -o-transition: all 0.3s ease-in-out;
    transition: all 0.3s ease-in-out;
  }
  #mobile-menu-btn {
    -webkit-transition: all 0.3s ease-in-out;
    -o-transition: all 0.3s ease-in-out;
    transition: all 0.3s ease-in-out;
  }

  #mobile-menu-btn.is-active {
    animation: smallbig 0.6s forwards;
  }

  #mobile-menu-btn.is-active .line:nth-child(1),
  #mobile-menu-btn.is-active .line:nth-child(2),
  #mobile-menu-btn.is-active .line:nth-child(3) {
    -webkit-transition-delay: 0.2s;
    -o-transition-delay: 0.2s;
    transition-delay: 0.2s;
  }

  #mobile-menu-btn.is-active .line:nth-child(2) {
    opacity: 0;
  }

  #mobile-menu-btn.is-active .line:nth-child(1) {
    -webkit-transform: translateY(5px) rotate(45deg);
    -ms-transform: translateY(5px) rotate(45deg);
    -o-transform: translateY(5px) rotate(45deg);
    transform: translateY(5px) rotate(45deg);
  }

  #mobile-menu-btn.is-active .line:nth-child(3) {
    -webkit-transform: translateY(-5px) rotate(-45deg);
    -ms-transform: translateY(-5px) rotate(-45deg);
    -o-transform: translateY(-5px) rotate(-45deg);
    transform: translateY(-5px) rotate(-45deg);
  }

  @keyframes smallbig {
    0%,
    100% {
      -webkit-transform: scale(1);
      -ms-transform: scale(1);
      -o-transform: scale(1);
      transform: scale(1);
    }
    50% {
      -webkit-transform: scale(0);
      -ms-transform: scale(0);
      -o-transform: scale(0);
      transform: scale(0);
    }
  }

  /* Mobile menu overlay */
  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 30;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
  }

  .mobile-menu-overlay.active {
    opacity: 1;
    visibility: visible;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Initialize Flowbite components
    if (typeof window !== "undefined" && (window as any).initFlowbite) {
      (window as any).initFlowbite();
    }
  });
</script>
