---
// Direct Messaging Component - 1-on-1 messaging with Socket.io
// Only visible to Admin/Staff users

import BoxIcon from "./BoxIcon.astro";

interface Props {
  currentUser?: any;
}

const { currentUser } = Astro.props;
const currentRole = currentUser?.profile?.role;

// Debug logging
// // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Component props:", {
  hasCurrentUser: !!currentUser,
  currentRole,
  userId: currentUser?.id,
  userName: currentUser?.profile?.company_name,
});

if (currentRole !== "Admin" && currentRole !== "Staff") {
  // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] User not Admin/Staff, hiding component");
  return null;
}

// // // console.log("ðŸ’¬ [DIRECT-MESSAGING] User is Admin/Staff, showing component");
---

<!-- Direct Messaging Widget -->
<div
  id="direct-messaging-widget"
  class="z-100 fixed -right-4 bottom-4"
  data-user-role={currentRole || "Client"}
  data-user-id={currentUser?.id || "unknown"}
  data-user-name={currentUser?.profile?.company_name || "Unknown User"}
>
  <!-- Direct Message Toggle Button -->
  <div class="relative">
    <BoxIcon
      name="message-square-dots"
      variant="primary"
      size="lg"
      id="direct-message-toggle"
      dataAttributes={{ "data-count": "0" }}
      backgroundColor="primary"
      shape="circle"
    />
    <!-- Debug indicator -->
    <div
      class="absolute -right-2 -top-2 flex h-4 w-4 items-center justify-center rounded-full bg-green-500"
    >
      <span class="text-xs font-bold text-white">DM</span>
    </div>
  </div>

  <!-- Direct Message Panel -->
  <div
    id="direct-message-panel"
    class="absolute -right-40 bottom-16 hidden h-96 w-80 flex-col bg-white shadow-xl dark:border-gray-700 dark:bg-gray-800"
  >
    <!-- Header -->
    <div class="flex items-center justify-between bg-gray-50 p-4 dark:bg-gray-700">
      <div class="flex items-center space-x-2">
        <div
          class="flex h-8 w-8 items-center justify-center rounded-lg bg-primary-100 dark:bg-primary-900/30"
        >
          <i class="bx bx-message-square-dots text-primary-600 dark:text-primary-400"></i>
        </div>
        <div>
          <h3 class="text-sm font-medium text-gray-900 dark:text-white">Direct Messages</h3>
          <p class="text-xs text-gray-500 dark:text-gray-400" id="dm-online-count">0 online</p>
        </div>
      </div>
      <button
        id="dm-close"
        class="rounded-lg p-1 text-gray-400 hover:bg-gray-200 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-gray-300"
        title="Close direct messages"
      >
        <i class="bx bx-x text-lg"></i>
      </button>
    </div>

    <!-- User List / Conversation Selector -->
    <div id="dm-user-list" class="flex-1 space-y-1 overflow-y-auto p-2">
      <div class="py-8 text-center text-sm text-gray-500 dark:text-gray-400">
        <i class="bx bx-message-square-dots mx-auto mb-2 text-2xl"></i>
        <p>Loading users...</p>
      </div>
    </div>

    <!-- Conversation View (hidden initially) -->
    <div id="dm-conversation" class="hidden flex-1 flex-col">
      <!-- Conversation Header -->
      <div
        class="flex items-center justify-between border-b border-gray-200 bg-gray-50 p-3 dark:border-gray-700 dark:bg-gray-700"
      >
        <div class="flex items-center space-x-2">
          <button
            id="dm-back-to-users"
            class="rounded-lg p-1 text-gray-400 hover:bg-gray-200 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-gray-300"
          >
            <i class="bx bx-arrow-left text-lg"></i>
          </button>
          <div>
            <h4 class="text-sm font-medium text-gray-900 dark:text-white" id="dm-conversation-user">
              User Name
            </h4>
            <p class="text-xs text-gray-500 dark:text-gray-400" id="dm-conversation-status">
              Online
            </p>
          </div>
        </div>
        <button
          id="dm-conversation-options"
          class="rounded-lg p-1 text-gray-400 hover:bg-gray-200 hover:text-gray-600 dark:hover:bg-gray-600 dark:hover:text-gray-300"
        >
          <i class="bx bx-dots-vertical text-lg"></i>
        </button>
      </div>

      <!-- Messages -->
      <div id="dm-messages" class="flex-1 space-y-2 overflow-y-auto p-3">
        <div class="py-8 text-center text-sm text-gray-500 dark:text-gray-400">
          <i class="bx bx-message-square-dots mx-auto mb-2 text-2xl"></i>
          <p>Start a conversation...</p>
        </div>
      </div>

      <!-- Message Input -->
      <div class="border-t border-gray-200 p-3 dark:border-gray-700">
        <div class="flex space-x-2">
          <input
            type="text"
            id="dm-message-input"
            placeholder="Type a message..."
            class="flex-1 rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-transparent focus:ring-2 focus:ring-primary-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white"
            maxlength="500"
          />
          <button
            id="dm-send-button"
            class="rounded-full bg-primary-600 px-4 py-2 text-sm text-white transition-colors hover:bg-primary-700 disabled:cursor-not-allowed disabled:opacity-50"
            disabled
          >
            <i class="bx bx-send"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Socket.io Client Library -->
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<script>
  // Direct Messaging JavaScript
  let socket: any = null;
  let currentUser: any = null;
  let onlineUsers: any[] = [];
  let currentConversation: any = null;
  let conversations: any = {};
  let isInitialized = false;
  let unreadCount = 0;

  // Initialize direct messaging
  function initializeDirectMessaging() {
    if (isInitialized) {
      // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Already initialized");
      return;
    }

    // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Initializing direct messaging");

    const widget = document.getElementById("direct-messaging-widget");
    if (!widget) {
      // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Widget not found");
      return;
    }

    const userRole = widget.dataset.userRole || "Client";
    const userId = widget.dataset.userId || "unknown";
    const userName = widget.dataset.userName || "Unknown User";

    if (userRole !== "Admin" && userRole !== "Staff") {
      // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] User not Admin/Staff, hiding widget");
      widget.classList.add("hidden");
      return;
    }

    currentUser = {
      id: userId,
      name: userName,
      role: userRole,
    };

    // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Current user:", currentUser);

    // Initialize Socket.io connection
    initializeSocket();

    // Setup event listeners
    setupDirectMessagingEvents();

    // Load users
    loadUsers();

    isInitialized = true;
    // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Initialization complete");
  }

  // Initialize Socket.io connection
  function initializeSocket() {
    try {
      if (typeof (window as any).io === "undefined") {
        console.error("âŒ [DIRECT-MESSAGING] Socket.io library not loaded");
        return;
      }

      socket = (window as any).io("http://localhost:3001", {
        transports: ["websocket", "polling"],
        timeout: 20000,
        forceNew: true,
      });

      // Connection events
      socket.on("connect", () => {
        // // // console.log("âœ… [DIRECT-MESSAGING] Connected to server");
        socket.emit("join_dm", {
          userId: currentUser.id,
          userName: currentUser.name,
          userRole: currentUser.role,
        });
      });

      socket.on("disconnect", () => {
        // // // console.log("âŒ [DIRECT-MESSAGING] Disconnected from server");
      });

      // Direct messaging events
      socket.on("dm_user_list", (users: any) => {
        // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Online users:", users.length);
        onlineUsers = users;
        updateUserList();
        updateOnlineCount();
      });

      socket.on("dm_message", (message: any) => {
        // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] New direct message:", message);
        handleDirectMessage(message);
      });

      socket.on("dm_conversation_history", (data: any) => {
        // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] Conversation history:", data.messages.length);
        loadConversationHistory(data.messages);
      });

      socket.on("dm_user_typing", (data: any) => {
        handleTypingIndicator(data);
      });
    } catch (error) {
      console.error("âŒ [DIRECT-MESSAGING] Error initializing socket:", error);
    }
  }

  // Setup event listeners
  function setupDirectMessagingEvents() {
    const toggle = document.getElementById("direct-message-toggle");
    const close = document.getElementById("dm-close");
    const backToUsers = document.getElementById("dm-back-to-users");
    const messageInput = document.getElementById("dm-message-input");
    const sendButton = document.getElementById("dm-send-button");

    // Toggle panel
    toggle?.addEventListener("click", () => {
      const panel = document.getElementById("direct-message-panel");
      const isHidden = panel?.classList.contains("hidden");

      if (isHidden) {
        panel?.classList.remove("hidden");
        loadUsers();
      } else {
        panel?.classList.add("hidden");
      }
    });

    // Close panel
    close?.addEventListener("click", () => {
      document.getElementById("direct-message-panel")?.classList.add("hidden");
    });

    // Back to user list
    backToUsers?.addEventListener("click", () => {
      showUserList();
    });

    // Message input
    messageInput?.addEventListener("input", (e) => {
      const target = e.target as HTMLInputElement;
      const sendBtn = document.getElementById("dm-send-button") as HTMLButtonElement;
      sendBtn.disabled = !target.value.trim();

      // Handle typing indicator
      if (target.value.trim()) {
        socket?.emit("dm_typing", {
          isTyping: true,
          to: currentConversation?.id,
        });
      } else {
        socket?.emit("dm_typing", {
          isTyping: false,
          to: currentConversation?.id,
        });
      }
    });

    // Send message
    sendButton?.addEventListener("click", sendDirectMessage);

    // Enter key
    messageInput?.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendDirectMessage();
      }
    });
  }

  // Load users for direct messaging
  async function loadUsers() {
    try {
      const response = await fetch("/api/get-user-emails-by-role", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ roles: ["Admin", "Staff"] }),
      });
      const data = await response.json();

      if (data.success) {
        const users = data.staffUsers || [];
        // Filter out current user
        const otherUsers = users.filter((user: any) => user.id !== currentUser.id);
        updateUserList(otherUsers);
      }
    } catch (error) {
      console.error("Error loading users:", error);
    }
  }

  // Update user list
  function updateUserList(users = onlineUsers) {
    const userList = document.getElementById("dm-user-list");
    if (!userList) return;

    if (users.length === 0) {
      userList.innerHTML = `
        <div class="py-8 text-center text-sm text-gray-500 dark:text-gray-400">
          <i class="bx bx-user-x mx-auto mb-2 text-2xl"></i>
          <p>No other users online</p>
        </div>
      `;
      return;
    }

    userList.innerHTML = users
      .map((user: any) => {
        const isOnline = onlineUsers.some((u) => u.id === user.id);
        const unreadCount = conversations[user.id]?.unreadCount || 0;

        return `
        <div class="flex items-center space-x-3 rounded-lg p-3 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer" 
             onclick="startConversation('${user.id}', '${user.company_name || user.email}')">
          <div class="relative">
            <div class="h-10 w-10 rounded-full bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center">
              <i class="bx bx-user text-primary-600 dark:text-primary-400"></i>
            </div>
            <div class="absolute -bottom-1 -right-1 h-3 w-3 rounded-full border-2 border-white dark:border-gray-800 ${isOnline ? "bg-green-400" : "bg-gray-400"}"></div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-medium text-gray-900 dark:text-white truncate">
              ${user.company_name || user.email}
            </p>
            <p class="text-xs text-gray-500 dark:text-gray-400">
              ${user.role} â€¢ ${isOnline ? "Online" : "Offline"}
            </p>
          </div>
          ${
            unreadCount > 0
              ? `
            <div class="flex h-5 w-5 items-center justify-center rounded-full bg-primary-600 text-xs text-white">
              ${unreadCount > 99 ? "99+" : unreadCount}
            </div>
          `
              : ""
          }
        </div>
      `;
      })
      .join("");
  }

  // Start conversation with user
  function startConversation(userId: string, userName: string) {
    currentConversation = { id: userId, name: userName };

    // Show conversation view
    document.getElementById("dm-user-list")?.classList.add("hidden");
    document.getElementById("dm-conversation")?.classList.remove("hidden");

    // Update conversation header
    const conversationUser = document.getElementById("dm-conversation-user");
    if (conversationUser) {
      conversationUser.textContent = userName;
    }

    // Load conversation history
    socket?.emit("get_dm_history", { userId });

    // Reset unread count
    if (conversations[userId]) {
      conversations[userId].unreadCount = 0;
    }
  }

  // Show user list
  function showUserList() {
    document.getElementById("dm-user-list")?.classList.remove("hidden");
    document.getElementById("dm-conversation")?.classList.add("hidden");
    currentConversation = null;
  }

  // Send direct message
  function sendDirectMessage() {
    const input = document.getElementById("dm-message-input") as HTMLInputElement;
    const message = input.value.trim();

    if (!message || !socket || !currentConversation) return;

    socket.emit("dm_message", {
      to: currentConversation.id,
      message: message,
    });

    input.value = "";
    document.getElementById("dm-send-button")?.setAttribute("disabled", "true");
  }

  // Handle incoming direct message
  function handleDirectMessage(message: any) {
    const fromUserId = message.from || message.user_id;
    const isFromCurrentConversation = currentConversation?.id === fromUserId;

    // Add to conversations
    if (!conversations[fromUserId]) {
      conversations[fromUserId] = { messages: [], unreadCount: 0 };
    }

    conversations[fromUserId].messages.push(message);

    // If this is the current conversation, add to UI
    if (isFromCurrentConversation) {
      addMessageToConversation(message);
    } else {
      // Increment unread count
      conversations[fromUserId].unreadCount++;
      updateUserList();
    }
  }

  // Add message to conversation UI
  function addMessageToConversation(message: any) {
    const messagesContainer = document.getElementById("dm-messages");
    if (!messagesContainer) return;

    const isOwnMessage = message.from === currentUser.id;
    const messageElement = document.createElement("div");
    messageElement.className = `flex ${isOwnMessage ? "justify-end" : "justify-start"}`;

    messageElement.innerHTML = `
      <div class="max-w-xs ${isOwnMessage ? "bg-primary-600 text-white" : "bg-gray-100 dark:bg-gray-600 text-gray-900 dark:text-white"} rounded-lg px-3 py-2">
        <p class="text-sm">${message.message}</p>
        <p class="text-xs opacity-75 mt-1">${new Date(message.timestamp || Date.now()).toLocaleTimeString()}</p>
      </div>
    `;

    messagesContainer.appendChild(messageElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  }

  // Load conversation history
  function loadConversationHistory(messages: any[]) {
    const messagesContainer = document.getElementById("dm-messages");
    if (!messagesContainer) return;

    messagesContainer.innerHTML = "";
    messages.forEach((message) => addMessageToConversation(message));
  }

  // Handle typing indicator
  function handleTypingIndicator(data: any) {
    // You can implement typing indicators here
    // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] User typing:", data);
  }

  // Update online count
  function updateOnlineCount() {
    const countElement = document.getElementById("dm-online-count");
    if (countElement) {
      countElement.textContent = `${onlineUsers.length} online`;
    }
  }

  // Make functions globally available
  (window as any).startConversation = startConversation;

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    // // // console.log("ðŸ’¬ [DIRECT-MESSAGING] DOM Content Loaded");
    setTimeout(initializeDirectMessaging, 1000);
  });

  // Cleanup on page unload
  window.addEventListener("beforeunload", () => {
    if (socket) {
      socket.disconnect();
    }
  });
</script>
