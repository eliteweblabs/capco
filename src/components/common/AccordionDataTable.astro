---
/**
 * AccordionDataTable - Generic accordion table with title, description, data
 * Extracted from CMS page pattern. Each row expands to show a detail slot.
 *
 * @example
 * <AccordionDataTable
 *   id="admin-users"
 *   title="All Users"
 *   description="Click a row to expand and edit"
 *   data={users}
 *   getItemId={(u) => u.id}
 *   columns={[
 *     { key: "name", label: "Name", getValue: (u) => `${u.firstName} ${u.lastName}` },
 *     { key: "email", label: "Email" },
 *     { key: "role", label: "Role" },
 *   ]}
 *   slotIdPrefix="user-slot"
 *   emptyMessage="No items found"
 * />
 */
import SimpleIcon from "./SimpleIcon.astro";

export interface ColumnConfig<T = any> {
  key: string;
  label: string;
  getValue?: (item: T) => string;
  headerClass?: string;
  cellClass?: string;
  colSpan?: number;
  /** When true, render cell value as HTML (use for rich content) */
  allowHtml?: boolean;
  /** Default width in px for resizable columns */
  width?: number;
  /** Data attributes for the cell (e.g. data-refresh, data-user-id for refresh-manager) */
  getCellDataAttrs?: (item: T) => Record<string, string>;
}

interface Props<T = any> {
  id: string;
  title?: string;
  description?: string;
  data: T[];
  getItemId: (item: T) => string;
  columns: ColumnConfig<T>[];
  slotIdPrefix?: string;
  emptyMessage?: string;
  draggable?: boolean;
  showCreateRow?: boolean;
  createRowLabel?: string;
  getCreateSlotId?: () => string;
  /** Render function for actions column - returns VNode(s). Or use actionsComponent + actionsGetProps. */
  actionsRenderer?: (item: T) => any;
  /** Component to render in actions column (alternative to actionsRenderer) */
  actionsComponent?: any;
  /** Props getter for actionsComponent */
  actionsGetProps?: (item: T) => Record<string, unknown>;
  /** Extra data attributes for trigger row */
  getTriggerDataAttrs?: (item: T) => Record<string, string>;
  /** Extra data attributes for detail row (e.g. data-editor-slot for CMS) */
  getDetailRowDataAttrs?: (item: T) => Record<string, string>;
  globalInputClasses?: string;
  /** When draggable, ID for reorder API (defaults to getItemId). Rows get data-reorder-id. */
  getReorderId?: (item: T) => string;
  /** Window function name to call on reorder: (order: {id:string,displayOrder:number}[]) => void */
  reorderCallback?: string;
  /** Override trigger/detail/slot class names for CMS compatibility */
  triggerClass?: string;
  detailClass?: string;
  slotClass?: string;
  /** Override chevron class (e.g. cms-chevron for CMS) */
  chevronClass?: string;
  /** Override detail row id prefix (e.g. "cms" gives cms-detail-{slotId}) */
  detailRowIdPrefix?: string;
  /** Data attributes for create row (e.g. { editorSlot: "create" } for CMS) */
  createRowDataAttrs?: Record<string, string>;
  /** Enable resizable columns (default: true) */
  resizable?: boolean;
}

const {
  id,
  title,
  description,
  data = [],
  getItemId,
  columns,
  slotIdPrefix = "slot",
  emptyMessage = "No items found",
  draggable = false,
  showCreateRow = false,
  createRowLabel = "+ Create new",
  getCreateSlotId = () => "create",
  actionsRenderer,
  actionsComponent,
  actionsGetProps,
  getTriggerDataAttrs,
  getDetailRowDataAttrs,
  globalInputClasses = "",
  getReorderId,
  reorderCallback,
  triggerClass = "accordion-trigger",
  detailClass = "accordion-detail",
  slotClass = "accordion-slot",
  chevronClass = "accordion-chevron",
  detailRowIdPrefix,
  createRowDataAttrs,
  resizable = true,
} = Astro.props;

const toDataAttrs = (obj: Record<string, string>) =>
  Object.fromEntries(
    Object.entries(obj).map(([k, v]) => [
      `data-${k.replace(/([A-Z])/g, (m: string) => "-" + m.toLowerCase())}`,
      v,
    ])
  );

const detailRowId = detailRowIdPrefix
  ? (slot: string) => `${detailRowIdPrefix}-detail-${slot}`
  : (slot: string) => `${id}-detail-${slot}`;

const hasActions = actionsRenderer || (actionsComponent && actionsGetProps);

const createSlotId = getCreateSlotId();
const colspan = columns.length + (draggable ? 1 : 0) + (hasActions ? 1 : 0) + 1; // +1 for chevron
---

<div class="accordion-data-table overflow-hidden rounded-lg bg-white shadow dark:bg-gray-900">
  {
    (title || description) && (
      <div class="border-b border-gray-200 px-6 py-4 dark:border-gray-700">
        {title && <h2 class="text-lg font-semibold text-gray-900 dark:text-white">{title}</h2>}
        {description && <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">{description}</p>}
      </div>
    )
  }
  <div class="overflow-x-auto">
    <table
      id={`${id}-table`}
      class="w-full min-w-max table-fixed divide-gray-200 text-sm dark:divide-gray-700"
      {...resizable && { "data-accordion-resizable": "true", "data-table-id": id }}
    >
      <thead class="text-uppercase color-background select-none text-xs">
        <tr>
          {
            draggable && (
              <th class="w-10 px-2 py-3" aria-label="Drag to reorder">
                &nbsp;
              </th>
            )
          }
          {
            columns.map((col) => (
              <th
                scope="col"
                data-col-id={col.key}
                data-col-default-width={col.width ?? 100}
                style={
                  resizable
                    ? `width: ${col.width ?? 100}px; min-width: ${col.width ?? 100}px`
                    : undefined
                }
                class={`color-border-primary border-r border-gray-200 px-4 py-3 font-semibold dark:border-gray-700 ${col.headerClass || ""}`}
              >
                {col.label}
              </th>
            ))
          }
          {
            hasActions && (
              <th
                scope="col"
                class="color-border-primary w-32 min-w-32 max-w-32 border-r border-gray-200 px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-700 dark:border-gray-700 dark:text-gray-300"
              >
                Actions
              </th>
            )
          }
          <th class="w-12 px-2 py-3" aria-label="Expand">&nbsp;</th>
        </tr>
      </thead>
      <tbody
        id={`${id}-tbody`}
        class="divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900"
      >
        {
          showCreateRow && (
            <>
              <tr
                class={`${triggerClass} select-none border-b border-gray-200 transition-colors hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700`}
                data-slot={createSlotId}
                role="button"
                tabindex="0"
                aria-expanded="false"
                aria-controls={detailRowId(createSlotId)}
                {...(createRowDataAttrs && toDataAttrs(createRowDataAttrs))}
              >
                {draggable && <td class="w-10 px-2 py-3">&nbsp;</td>}
                <td
                  class="px-4 py-3 text-center text-sm font-medium text-primary-600 dark:text-primary-400"
                  colspan={columns.length + (hasActions ? 1 : 0)}
                >
                  {createRowLabel}
                </td>
              </tr>
              <tr
                id={detailRowId(createSlotId)}
                class={`${detailClass} hidden`}
                data-slot={createSlotId}
                aria-hidden="true"
                {...(createRowDataAttrs && toDataAttrs(createRowDataAttrs))}
              >
                <td colspan={colspan} class="bg-gray-50 p-0 dark:bg-gray-800/50">
                  <div
                    id={`${slotIdPrefix}-${createSlotId}`}
                    class={`${slotClass} min-h-[120px]`}
                  />
                </td>
              </tr>
            </>
          )
        }
        {
          data.length === 0 && !showCreateRow ? (
            <tr>
              <td
                colspan={colspan}
                class="px-4 py-8 text-center text-sm text-gray-500 dark:text-gray-400"
              >
                {emptyMessage}
              </td>
            </tr>
          ) : (
            data.flatMap((item) => {
              const itemId = getItemId(item);
              const reorderId = getReorderId ? getReorderId(item) : itemId;
              const slotId = `${slotIdPrefix}-${itemId}`;
              const dataAttrs = getTriggerDataAttrs?.(item) || {};
              const detailDataAttrs = getDetailRowDataAttrs?.(item) || {};
              return [
                <tr
                  class={`${triggerClass} select-none border-b border-gray-200 transition-colors hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700 ${draggable ? "cursor-grab" : ""}`}
                  data-slot={itemId}
                  data-item-id={itemId}
                  data-reorder-id={draggable && reorderId ? reorderId : undefined}
                  role="button"
                  tabindex="0"
                  aria-expanded="false"
                  aria-controls={detailRowId(itemId)}
                  {...(dataAttrs &&
                    Object.fromEntries(
                      Object.entries(dataAttrs).map(([k, v]) => [
                        `data-${k.replace(/([A-Z])/g, (m: string) => "-" + m.toLowerCase())}`,
                        v,
                      ])
                    ))}
                  draggable={draggable || undefined}
                >
                  {draggable && (
                    <td
                      class="accordion-drag-handle w-10 px-2 py-3 align-middle text-gray-400 dark:text-gray-500"
                      aria-hidden="true"
                    >
                      <SimpleIcon name="grip-dots" class="h-5 w-5" />
                    </td>
                  )}
                  {columns.map((col) => {
                    const value = col.getValue ? col.getValue(item) : (item as any)[col.key];
                    const display = value ?? "â€”";
                    const cellDataAttrs = col.getCellDataAttrs?.(item);
                    const attrs = cellDataAttrs
                      ? Object.fromEntries(
                          Object.entries(cellDataAttrs).map(([k, v]) => [
                            `data-${k.replace(/([A-Z])/g, (m: string) => "-" + m.toLowerCase())}`,
                            v,
                          ])
                        )
                      : {};
                    return col.allowHtml && typeof display === "string" ? (
                      <td
                        class={`px-4 py-2 text-sm text-gray-900 dark:text-white ${col.cellClass || ""}`}
                        set:html={display}
                        {...attrs}
                      />
                    ) : (
                      <td
                        class={`px-4 py-2 text-sm text-gray-900 dark:text-white ${col.cellClass || ""}`}
                        {...attrs}
                      >
                        {display}
                      </td>
                    );
                  })}
                  {hasActions && (
                    <td class="whitespace-nowrap px-4 py-2 text-right">
                      {actionsRenderer
                        ? actionsRenderer(item)
                        : actionsComponent &&
                          (() => {
                            const Comp = actionsComponent;
                            const props = actionsGetProps ? actionsGetProps(item) : {};
                            return <Comp {...props} />;
                          })()}
                    </td>
                  )}
                  <td class="w-12 px-2 py-3 align-middle">
                    <svg
                      class={`${chevronClass} h-5 w-5 rotate-0 text-gray-500 transition-transform`}
                      fill="currentColor"
                      viewBox="0 0 20 20"
                      aria-hidden="true"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </td>
                </tr>,
                <tr
                  id={detailRowId(itemId)}
                  class={`${detailClass} hidden`}
                  data-slot={itemId}
                  aria-hidden="true"
                  {...(detailDataAttrs && toDataAttrs(detailDataAttrs))}
                >
                  <td colspan={colspan} class="bg-gray-50 p-0 dark:bg-gray-800/50">
                    <div id={slotId} class={`${slotClass} min-h-[120px]`} />
                  </td>
                </tr>,
              ];
            })
          )
        }
      </tbody>
    </table>
  </div>
</div>

{resizable && <script>import "../../scripts/accordion-data-table-resizable-columns";</script>}

{
  draggable && reorderCallback && (
    <>
      <div
        data-accordion-reorder-init
        data-table-id={id}
        data-trigger-class={triggerClass}
        data-detail-class={detailClass}
        data-reorder-callback={reorderCallback}
        hidden
      />
      <script>import "../../scripts/accordion-reorder-init";</script>
    </>
  )
}
