---
/**
 * AccordionDataTable - Generic accordion table with title, description, data
 * Extracted from CMS page pattern. Each row expands to show a detail slot.
 *
 * @example
 * <AccordionDataTable
 *   id="admin-users"
 *   title="All Users"
 *   description="Click a row to expand and edit"
 *   data={users}
 *   getItemId={(u) => u.id}
 *   columns={[
 *     { key: "name", label: "Name", getValue: (u) => `${u.firstName} ${u.lastName}` },
 *     { key: "email", label: "Email" },
 *     { key: "role", label: "Role" },
 *   ]}
 *   slotIdPrefix="user-slot"
 *   emptyMessage="No items found"
 * />
 */
import Button from "./Button.astro";
import SimpleIcon from "./SimpleIcon.astro";
import { globalClasses } from "../../pages/api/global/global-classes";

const {
  dataTableCardClasses,
  dataTableHeaderBarClasses,
  dataTableTitleClasses,
  dataTableDescriptionClasses,
  dataTableClearButtonClasses,
  dataTableTableWrapperClasses,
  dataTableTableClasses,
  dataTableTheadClasses,
  dataTableThClasses,
  dataTableActionsThClasses,
  dataTableTbodyClasses,
  dataTableEmptyCellClasses,
  dataTableTriggerRowBaseClasses,
  dataTableDragHandleTdClasses,
  dataTableDataCellClasses,
  dataTableActionsCellClasses,
  dataTableDetailTdClasses,
  dataTableSlotMinHeightClasses,
  dataTableCreateFooterClasses,
  dataTableCreateDetailClasses,
  dataTableCreateSlotClasses,
  dataTableDragThClasses,
} = globalClasses();

export interface ColumnConfig<T = any> {
  key: string;
  label: string;
  getValue?: (item: T) => string;
  headerClass?: string;
  cellClass?: string;
  colSpan?: number;
  /** When true, render cell value as HTML (use for rich content) */
  allowHtml?: boolean;
  /** Default width in % for resizable columns (e.g. 20 = 20%) */
  width?: number;
  /** Data attributes for the cell (e.g. data-refresh, data-user-id for refresh-manager) */
  getCellDataAttrs?: (item: T) => Record<string, string>;
}

interface Props<T = any> {
  id: string;
  title?: string;
  description?: string;
  data: T[];
  getItemId: (item: T) => string;
  columns: ColumnConfig<T>[];
  slotIdPrefix?: string;
  emptyMessage?: string;
  draggable?: boolean;
  showCreateRow?: boolean;
  createRowLabel?: string;
  getCreateSlotId?: () => string;
  /** Render function for actions column - returns VNode(s). Or use actionsComponent + actionsGetProps. */
  actionsRenderer?: (item: T) => any;
  /** Component to render in actions column (alternative to actionsRenderer) */
  actionsComponent?: any;
  /** Props getter for actionsComponent */
  actionsGetProps?: (item: T) => Record<string, unknown>;
  /** Extra data attributes for trigger row */
  getTriggerDataAttrs?: (item: T) => Record<string, string>;
  /** Extra data attributes for detail row (e.g. data-editor-slot for CMS) */
  getDetailRowDataAttrs?: (item: T) => Record<string, string>;
  globalInputClasses?: string;
  /** When draggable, ID for reorder API (defaults to getItemId). Rows get data-reorder-id. */
  getReorderId?: (item: T) => string;
  /** Window function name to call on reorder: (order: {id:string,displayOrder:number}[]) => void */
  reorderCallback?: string;
  /** Override trigger/detail/slot class names for CMS compatibility */
  triggerClass?: string;
  detailClass?: string;
  slotClass?: string;
  /** Override chevron class (e.g. cms-chevron for CMS) */
  chevronClass?: string;
  /** Override detail row id prefix (e.g. "cms" gives cms-detail-{slotId}) */
  detailRowIdPrefix?: string;
  /** Data attributes for create row (e.g. { editorSlot: "create" } for CMS) */
  createRowDataAttrs?: Record<string, string>;
  /** Optional id for the create button (e.g. "create-page-btn" for CMS script) */
  createButtonId?: string;
  /** Enable resizable columns (default: true) */
  resizable?: boolean;
}

const {
  id,
  title,
  description,
  data = [],
  getItemId,
  columns,
  slotIdPrefix = "slot",
  emptyMessage = "No items found",
  draggable = false,
  showCreateRow = false,
  createRowLabel = "+ Create new",
  getCreateSlotId = () => "create",
  actionsRenderer,
  actionsComponent,
  actionsGetProps,
  getTriggerDataAttrs,
  getDetailRowDataAttrs,
  globalInputClasses = "",
  getReorderId,
  reorderCallback,
  triggerClass = "accordion-trigger",
  detailClass = "accordion-detail",
  slotClass = "accordion-slot",
  chevronClass = "accordion-chevron",
  detailRowIdPrefix,
  createRowDataAttrs,
  createButtonId,
  resizable = true,
} = Astro.props;

const toDataAttrs = (obj: Record<string, string>) =>
  Object.fromEntries(
    Object.entries(obj).map(([k, v]) => [
      `data-${k.replace(/([A-Z])/g, (m: string) => "-" + m.toLowerCase())}`,
      v,
    ])
  );

const detailRowId = detailRowIdPrefix
  ? (slot: string) => `${detailRowIdPrefix}-detail-${slot}`
  : (slot: string) => `${id}-detail-${slot}`;

const hasActions = actionsRenderer || (actionsComponent && actionsGetProps);

const createSlotId = getCreateSlotId();
const colspan = columns.length + (draggable ? 1 : 0) + (hasActions ? 1 : 0) + 1; // +1 for chevron
---

<div class={`accordion-data-table ${dataTableCardClasses}`}>
  {
    (title || description || resizable) && (
      <div class={dataTableHeaderBarClasses}>
        <div class="min-w-0 flex-1">
          {title && <h2 class={dataTableTitleClasses}>{title}</h2>}
          {description && <p class={dataTableDescriptionClasses}>{description}</p>}
        </div>
        {resizable && (
          <button
            type="button"
            class={`clear-accordion-column-widths ${dataTableClearButtonClasses}`}
            data-table-id={id}
            title="Reset column widths to defaults"
          >
            Reset column widths
          </button>
        )}
      </div>
    )
  }
  <div class={dataTableTableWrapperClasses}>
    <table
      id={`${id}-table`}
      class={dataTableTableClasses}
      {...resizable && { "data-accordion-resizable": "true", "data-table-id": id }}
    >
      <thead class={dataTableTheadClasses}>
        <tr>
          {
            draggable && (
              <th class={dataTableDragThClasses} aria-label="Drag to reorder">
                <SimpleIcon name="grip-dots" class="h-5 w-5" />
              </th>
            )
          }
          {
            columns.map((col) => (
              <th
                scope="col"
                data-col-id={col.key}
                data-col-default-width={col.width ?? 16}
                style={
                  resizable
                    ? `width: ${col.width ?? 16}%; min-width: ${col.width ?? 16}%`
                    : undefined
                }
                class={`${dataTableThClasses} ${col.headerClass || ""}`}
              >
                {col.label}
              </th>
            ))
          }
          {
            hasActions && (
              <th scope="col" class={dataTableActionsThClasses}>
                Actions
              </th>
            )
          }
        </tr>
      </thead>
      <tbody id={`${id}-tbody`} class={dataTableTbodyClasses}>
        {
          data.length === 0 ? (
            <tr>
              <td colspan={colspan} class={dataTableEmptyCellClasses}>
                {emptyMessage}
              </td>
            </tr>
          ) : (
            data.flatMap((item) => {
              const itemId = getItemId(item);
              const reorderId = getReorderId ? getReorderId(item) : itemId;
              const slotId = `${slotIdPrefix}-${itemId}`;
              const dataAttrs = getTriggerDataAttrs?.(item) || {};
              const detailDataAttrs = getDetailRowDataAttrs?.(item) || {};
              const triggerRowClasses = `${triggerClass} ${dataTableTriggerRowBaseClasses} ${draggable ? "cursor-grab" : ""}`;
              return [
                <tr
                  class={triggerRowClasses}
                  data-slot={itemId}
                  data-item-id={itemId}
                  data-reorder-id={draggable && reorderId ? reorderId : undefined}
                  role="button"
                  tabindex="0"
                  aria-expanded="false"
                  aria-controls={detailRowId(itemId)}
                  {...(dataAttrs &&
                    Object.fromEntries(
                      Object.entries(dataAttrs).map(([k, v]) => [
                        `data-${k.replace(/([A-Z])/g, (m: string) => "-" + m.toLowerCase())}`,
                        v,
                      ])
                    ))}
                  draggable={draggable || undefined}
                >
                  {draggable && (
                    <td
                      class={`accordion-drag-handle ${dataTableDragHandleTdClasses}`}
                      aria-hidden="true"
                    >
                      <SimpleIcon name="grip-dots" class="h-5 w-5" />
                    </td>
                  )}
                  {columns.map((col) => {
                    const value = col.getValue ? col.getValue(item) : (item as any)[col.key];
                    const display = value ?? "â€”";
                    const cellDataAttrs = col.getCellDataAttrs?.(item);
                    const attrs = cellDataAttrs
                      ? Object.fromEntries(
                          Object.entries(cellDataAttrs).map(([k, v]) => [
                            `data-${k.replace(/([A-Z])/g, (m: string) => "-" + m.toLowerCase())}`,
                            v,
                          ])
                        )
                      : {};
                    const cellClasses = `${dataTableDataCellClasses} ${col.cellClass || ""}`;
                    return col.allowHtml && typeof display === "string" ? (
                      <td class={cellClasses} set:html={display} {...attrs} />
                    ) : (
                      <td class={cellClasses} {...attrs}>
                        {display}
                      </td>
                    );
                  })}
                  {hasActions && (
                    <td class={dataTableActionsCellClasses}>
                      {actionsRenderer
                        ? actionsRenderer(item)
                        : actionsComponent &&
                          (() => {
                            const Comp = actionsComponent;
                            const props = actionsGetProps ? actionsGetProps(item) : {};
                            return <Comp {...props} />;
                          })()}
                    </td>
                  )}
                </tr>,
                <tr
                  id={detailRowId(itemId)}
                  class={`${detailClass} hidden`}
                  data-slot={itemId}
                  aria-hidden="true"
                  {...(detailDataAttrs && toDataAttrs(detailDataAttrs))}
                >
                  <td colspan={colspan} class={dataTableDetailTdClasses}>
                    <div id={slotId} class={`${slotClass} ${dataTableSlotMinHeightClasses}`} />
                  </td>
                </tr>,
              ];
            })
          )
        }
      </tbody>
    </table>
  </div>
  {
    showCreateRow && (
      <div class={dataTableCreateFooterClasses}>
        <Button
          type="button"
          variant="outline"
          size="sm"
          {...(createButtonId && { id: createButtonId })}
          class="text-primary-600 dark:text-primary-400"
        >
          {createRowLabel}
        </Button>
        <div
          id={detailRowId(createSlotId)}
          class={`${detailClass} hidden ${dataTableCreateDetailClasses}`}
          data-slot={createSlotId}
          aria-hidden="true"
          {...(createRowDataAttrs && toDataAttrs(createRowDataAttrs))}
        >
          <div
            id={`${slotIdPrefix}-${createSlotId}`}
            class={`${slotClass} ${dataTableCreateSlotClasses}`}
          />
        </div>
      </div>
    )
  }
</div>

{resizable && <script>import "../../scripts/accordion-data-table-resizable-columns";</script>}

{
  draggable && reorderCallback && (
    <>
      <div
        data-accordion-reorder-init
        data-table-id={id}
        data-trigger-class={triggerClass}
        data-detail-class={detailClass}
        data-reorder-callback={reorderCallback}
        hidden
      />
      <script>import "../../scripts/accordion-reorder-init";</script>
    </>
  )
}
