---
import SimpleIcon from "./SimpleIcon.astro";
import Button from "./Button.astro";
import GridFilter from "../../features/grid-filter/GridFilter.astro";
import { formatDate } from "../../lib/global-display-utils";

// Fetch featured projects
interface Project {
  id: number;
  title: string;
  address: string;
  description?: string;
  squareFootage: number | null;
  isNewConstruction: boolean | null;
  completedAt: string;
  featured: boolean;
  featuredImageUrl: string | null;
  featuredImageId: number | null;
  createdAt: string;
}

let featuredProjects: Project[] = [];
let error: string | null = null;

try {
  const baseUrl = Astro.url.origin;
  const apiUrl = `${baseUrl}/api/projects/get?featured=true`;
  console.log("üêõ [FEATURED-PROJECTS] Fetching from:", apiUrl);
  console.log("üêõ [FEATURED-PROJECTS] Has cookies:", !!Astro.request.headers.get("cookie"));

  const response = await fetch(apiUrl, {
    headers: {
      Cookie: Astro.request.headers.get("cookie") || "",
    },
  });

  console.log("üêõ [FEATURED-PROJECTS] Response status:", response.status, response.statusText);

  if (response.ok) {
    const data = await response.json();
    const projects = data.projects || [];

    console.log("üêõ [FEATURED-PROJECTS] Projects count:", projects.length);

    featuredProjects = await Promise.all(
      (projects || [])
        .filter((project: any) => project.featured === true || project.featured === "yes")
        .map(async (project: any) => {
          let featuredImageUrl = project.featuredImageUrl || null;

          if (!featuredImageUrl && project.featuredImageId) {
            try {
              const imageResponse = await fetch(
                `${baseUrl}/api/files/get?projectId=${project.id}&targetLocation=marketing&bucketName=project-marketing`,
                {
                  headers: {
                    Cookie: Astro.request.headers.get("cookie") || "",
                  },
                }
              );

              if (imageResponse.ok) {
                const imageData = await imageResponse.json();
                const images = imageData.data || [];
                const featuredImage = images.find(
                  (img: any) => img.id === parseInt(project.featuredImageId)
                );

                if (featuredImage && featuredImage.publicUrl) {
                  featuredImageUrl = featuredImage.publicUrl;
                }
              }
            } catch (imgError) {
              console.error("‚ùå [FEATURED-PROJECTS] Error fetching featured image:", imgError);
            }
          }

          return {
            id: project.id,
            title: project.title || project.address,
            address: project.address,
            description: project.description,
            squareFootage: project.sqFt,
            isNewConstruction: project.newConstruction,
            completedAt: project.completedAt || project.updatedAt,
            featured: project.featured,
            featuredImageUrl: featuredImageUrl,
            featuredImageId: project.featuredImageId,
            createdAt: project.createdAt,
          };
        })
    );
  } else {
    const errorText = await response.text();
    console.error("üêõ [FEATURED-PROJECTS] Error:", response.status, errorText);
    error = `Failed to load featured projects (${response.status})`;
  }
} catch (err) {
  console.error("üêõ [FEATURED-PROJECTS] Exception:", err);
  error = "Unable to load featured projects";
}

function formatSquareFootage(sqFt: number | null | undefined): string {
  if (!sqFt) return "N/A";
  return new Intl.NumberFormat().format(sqFt) + " sq ft";
}

const categories = ["All Projects", "New Construction", "Renovation"];

export type GridLayout = "masonry" | 2 | 3 | 4 | 6 | "2" | "3" | "4" | "6";
interface Props {
  gridLayout?: GridLayout;
  masonry?: boolean;
}
const { gridLayout: gridLayoutProp = "masonry", masonry: masonryProp } = Astro.props;
// Normalize: HTML/JSON can pass "3" as string
const gridLayout =
  gridLayoutProp === "masonry"
    ? "masonry"
    : typeof gridLayoutProp === "string"
      ? (parseInt(gridLayoutProp, 10) as 2 | 3 | 4 | 6) || "masonry"
      : gridLayoutProp;
const masonry = masonryProp ?? (gridLayout === "masonry");
---

<div class="mx-auto max-w-7xl px-4 sm:px-6 md:px-8 lg:px-10">
  {
    error ? (
      <div class="py-16 text-center">
        <div class="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-primary-100 dark:bg-primary-900/30">
          <SimpleIcon name="alert-circle" class="text-primary-600 dark:text-primary-400" />
        </div>
        <h2 class="mb-4 text-2xl font-bold text-gray-900 dark:text-white">No Projects Found</h2>
        <p class="mb-6 text-gray-800 dark:text-gray-200">{error}</p>
        <Button
          onclick="window.location.reload()"
          variant="danger"
          icon="refresh"
          iconPosition="left"
        >
          Try Again
        </Button>
      </div>
    ) : featuredProjects.length === 0 ? (
      <div class="py-16 text-center">
        <div class="mx-auto mb-6 flex h-16 w-16 items-center justify-center rounded-full bg-primary-100 dark:bg-primary-900/30">
          <SimpleIcon name="building" class="h-8 w-8 text-primary-600 dark:text-primary-400" />
        </div>
        <h2 class="mb-4 text-2xl font-bold text-gray-900 dark:text-white">
          No Featured Projects Yet
        </h2>
        <p class="mb-6 text-gray-600 dark:text-gray-300">
          We're working on exciting fire protection projects. Check back soon to see our latest
          completed work!
        </p>
        <Button href="/" variant="primary" icon="home" iconPosition="left">
          Back to Home
        </Button>
      </div>
    ) : (
      <div class="projects-container projects-container-masonry">
        <GridFilter
          filters={categories}
          itemSelector=".project-item"
          dataAttribute="data-category"
          multiSelect={true}
          masonry={masonry}
          itemsContainer=".projects-container-masonry"
        />

        <div
          id="projects-grid-masonry"
          class:list={[
            "grid gap-3 auto-rows-[300px]",
            gridLayout === "masonry" && "masonry-grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 xl:grid-cols-8",
            gridLayout === 2 && "projects-grid grid-cols-1 sm:grid-cols-2",
            gridLayout === 3 && "projects-grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3",
            gridLayout === 4 && "projects-grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4",
            gridLayout === 6 && "projects-grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6",
          ]}
        >
          {featuredProjects.map((project, index) => {
            const isMasonry = gridLayout === "masonry";
            const sizes = [
              { col: 1, row: 1 }, { col: 1, row: 2 }, { col: 1, row: 4 },
              { col: 2, row: 1 }, { col: 3, row: 1 }, { col: 2, row: 2 },
              { col: 2, row: 3 }, { col: 4, row: 2 },
            ];
            const sizePattern = sizes[index % sizes.length];
            const colSpan = isMasonry ? `col-span-${sizePattern.col}` : "col-span-1";
            const rowSpan = isMasonry ? `row-span-${sizePattern.row}` : "row-span-1";

            return (
              <div
                class={`project-item group overflow-hidden rounded-xl shadow-lg transition-all duration-300 hover:shadow-2xl color-background relative ${colSpan} ${rowSpan}`}
                data-category={project.isNewConstruction ? "New Construction" : "Renovation"}
                style="min-height: 300px;"
              >
                {project.featuredImageUrl ? (
                  <div class="relative overflow-hidden h-full">
                    <img
                      src={project.featuredImageUrl}
                      alt={`Featured image for ${project.address}`}
                      class="h-full w-full object-cover transition-transform duration-500 hover:scale-110 rounded-base"
                      loading="lazy"
                      referrerpolicy="strict-origin-when-cross-origin"
                      crossorigin="anonymous"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>

                    <div class="absolute right-3 top-3 flex items-center gap-1 rounded-full bg-yellow-500 px-3 py-1.5 text-xs font-semibold text-white shadow-lg">
                      <SimpleIcon name="star" class="h-3 w-3" />
                      <span>{project.isNewConstruction ? "New Construction" : "Renovation"}</span>
                    </div>

                    <div class="absolute bottom-0 left-0 right-0 p-4 sm:p-6 text-white transform translate-y-4 opacity-0 group-hover:translate-y-0 group-hover:opacity-100 transition-all duration-300">
                      <div class="flex items-start justify-between mb-3">
                        <div class="flex-1">
                          <h3 class="text-lg sm:text-xl font-bold mb-1 drop-shadow-lg text-white">
                            {project.address}
                          </h3>
                          {project.description && (
                            <p class="text-sm opacity-90 line-clamp-2 drop-shadow text-white">
                              {project.description}
                            </p>
                          )}
                        </div>
                        <div class="ml-3 flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-white/20 backdrop-blur-md">
                          <SimpleIcon name="building" class="h-5 w-5" />
                        </div>
                      </div>

                      <div class="flex flex-wrap gap-2 text-xs sm:text-sm">
                        <div class="flex items-center gap-1.5 bg-white/20 backdrop-blur-md px-3 py-1.5 rounded-full">
                          <SimpleIcon name="expand" class="h-3 w-3" />
                          <span>{formatSquareFootage(project.squareFootage)}</span>
                        </div>
                        <div class="flex items-center gap-1.5 bg-green-500/80 backdrop-blur-md px-3 py-1.5 rounded-full">
                          <SimpleIcon name="calendar-check" class="h-3 w-3" />
                          <span>{formatDate(project.completedAt)}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : (
                  <div class="flex h-full items-center justify-center bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 rounded-base">
                    <div class="text-center text-gray-400 dark:text-gray-500 p-6">
                      <SimpleIcon name="image" class="mx-auto mb-3 h-12 w-12 opacity-50" />
                      <p class="text-sm font-medium">No featured image</p>
                      <p class="text-xs mt-2 font-bold">{project.address}</p>
                    </div>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      </div>
    )
  }
</div>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .masonry-grid {
    display: grid;
    grid-auto-flow: dense;
    transition: all 0.3s ease-out;
  }

  .masonry-grid.masonry-recalculate {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .col-span-1 { grid-column: span 1; }
  .col-span-2 { grid-column: span 2; }
  .col-span-3 { grid-column: span 3; }
  .col-span-4 { grid-column: span 4; }

  .row-span-1 { grid-row: span 1; }
  .row-span-2 { grid-row: span 2; }
  .row-span-3 { grid-row: span 3; }
  .row-span-4 { grid-row: span 4; }

  @media (max-width: 640px) {
    .masonry-grid {
      grid-template-columns: repeat(2, 1fr) !important;
    }
    .project-item {
      grid-column: span 1 !important;
      grid-row: span 1 !important;
    }
  }

  @media (min-width: 641px) and (max-width: 768px) {
    .masonry-grid {
      grid-template-columns: repeat(3, 1fr) !important;
    }
    .col-span-4 { grid-column: span 3 !important; }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    .masonry-grid {
      grid-template-columns: repeat(4, 1fr) !important;
    }
    .col-span-4 { grid-column: span 4 !important; }
  }

  @media (min-width: 1025px) and (max-width: 1280px) {
    .masonry-grid {
      grid-template-columns: repeat(6, 1fr) !important;
    }
    .col-span-4 { grid-column: span 3 !important; }
  }

  .project-item {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform, box-shadow;
  }

  .project-item[style*="display: none"] {
    opacity: 0;
    transform: scale(0.95);
  }

  .project-item:not([style*="display: none"]) {
    opacity: 1;
    transform: scale(1);
  }

  .project-item:hover {
    transform: translateY(-4px) scale(1);
    z-index: 10;
  }

  .project-item img {
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
  }
</style>
