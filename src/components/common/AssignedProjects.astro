---
// User center component for header
import BoxIcon from "./BoxIcon.astro";

const { currentUser } = Astro.props;

const currentRole = currentUser?.profile?.role;
if (currentRole === "Client") {
  return null;
}
let assignedProjectsCount = 0;
let assignedProjects: any[] = [];

if (currentRole === "Staff" || currentRole === "Admin") {
  // console.log("üèóÔ∏è [APP] Fetching assigned projects for user:", currentUser.id);
  const baseUrl = Astro.url.origin;
  const fullUrl = `${baseUrl}/api/get-project?assigned_to_id=${currentUser.id}`;
  // console.log("üèóÔ∏è [APP] Full URL:", fullUrl);
  try {
    const response = await fetch(fullUrl);
    if (response.ok) {
      const data = await response.json();
      // console.log("üèóÔ∏è [APP] Assigned projects:", data);
      assignedProjects = data.projects || [];
      assignedProjectsCount = data.projects.length || 0;
    }
  } catch (error) {
    console.error("Error fetching assigned projects:", error);
  }
} else if (currentRole === "Client") {
  const baseUrl = Astro.url.origin;
  const fullUrl = `${baseUrl}/api/get-project?author_id=${currentUser.id}`;
  // console.log("üèóÔ∏è [APP] Full URL:", fullUrl);
  try {
    const response = await fetch(fullUrl);
    if (response.ok) {
      const data = await response.json();
      // console.log("üèóÔ∏è [APP] Assigned projects:", data);
      assignedProjects = data.projects || [];
      assignedProjectsCount = data.projects.length || 0;
    }
  } catch (error) {
    console.error("Error fetching assigned projects:", error);
  }
}

// Fetch projects assigned to current user
---

<BoxIcon
  name="folder-open"
  variant="secondary"
  size="sm"
  class="mveJTCIb2WII7J4sY22F Z4DH5a4vmjReSFRBpPgz c8dCx6gnV43hTOLV6ks5 PeR2JZ9BZHYIH8Ea3F36 _7KA5gD55t2lxf9Jkj20 BkIbg_JwkgiyRW804Hhu _q0p_O8QLU1paqtuqmI2 _6wdnQrxT_dGdAdNk5AQ XIIs8ZOri3wm8Wnj9N_y OPrb_iG5WDy_7F05BDOX yChACvAr1v8czJ2VO22j"
  id="assigned-projects-button"
  dataAttributes={{
    "data-count": assignedProjectsCount.toString(),
    "data-dropdown-toggle": "assigned-projects-dropdown",
    "data-tooltip-target": "tooltip-assigned-projects",
  }}
>
  <span class="_DVAfiyo21kM68EUVzEQ">View assigned projects</span>
</BoxIcon>

<div
  id="tooltip-assigned-projects"
  role="tooltip"
  class="H78G_4yayxs5C3xdFbnK ZBSHeVK3dmgzHTRX3hLO pq2JRWtiWcwYnw3xueNl QhmQ_v3mmDFIP9VaVOfb VPGGthdu3cy_ZP7AL7dt mveJTCIb2WII7J4sY22F foDHZclRWUf2bqma2a8U _Cj_M6jt2eLjDgkBBNgI b9aD6g2qw84oyZNsMO8j c8dCx6gnV43hTOLV6ks5 ezMFUVl744lvw6ht0lFe y6GKdvUrd7vp_pxsFb57 Db4Wzva4DMepJJiQLY7M fzhbbDQ686T8arwvi_bJ mc9bwhBTHL8mVzJvl6gz rqOAGYeDo9iWuroePkaf"
>
  Assigned Projects

  <div class="tkX8MMO2MiTlgtbd_jG3" data-popper-arrow=""></div>
</div>
<div
  class="Jq3rRDG6Hsr3eAZ0KJeH aJF41JQLhtfw_MCGt5Th _SmdlCf6eUKB_V9S5IDj ZhzOGpbwY0R4TKKYr5pG xdunzYpzbwcYs_0Tjgcz wBVMFkIGfrKshbvi2gS1 mveJTCIb2WII7J4sY22F _Ybd3WwuTVljUT4vEaM3 d3C8uAdJKNl1jzfE9ynq mfNtySJCsKVaP2xnoGBY jqg6J89cvxmDiFpnV56r"
  id="assigned-projects-dropdown"
  data-popper-placement="bottom"
>
  <div
    class="YRrCJSr_j5nopfm4duUc Q_jg_EPdNf9eDMn1mLI2 sJNGKHxFYdN5Nzml5J2j EpUSgjHdM6oyMXUiK_8_ qUWbS_LTZujDB4XCd11V _9dH7mrOkzM4RTmidHTs RZmKBZs1E1eXw8vkE6jY b9aD6g2qw84oyZNsMO8j ijrOHNoSVGATsWYKl4Id ezMFUVl744lvw6ht0lFe __9sbu0yrzdhGIkLWNXl Mmx5lX7HVdrWCgh3EpTP jqg6J89cvxmDiFpnV56r OyABRrnTV_kvHV7dJ0uE"
  >
    <h3>Assigned Projects</h3>
  </div>
  <div
    class="xCPtuxM4_gihvpPwv9bX sbr_wTGs60B3xicVVLBT iHPddplqYvrN6qWgvntn _wYiJGbRZyFZeCc8y7Sf _1jTZ8KXRZul60S6czNi max-h-[80dvh] overflow-y-scroll"
  >
    {
      assignedProjectsCount > 0 ? (
        <div class="space-y-2">
          {assignedProjects.slice(0, 5).map((project: any) => (
            <a
              href={`/project/${project.id}`}
              class="block rounded-lg border border-gray-200 p-3 transition-colors hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700"
            >
              <div class="flex items-start justify-between">
                <div class="min-w-0 flex-1">
                  <p class="truncate text-sm font-medium text-gray-900 dark:text-white">
                    {project.title || "Untitled Project"}
                  </p>
                  <p class="truncate text-xs text-gray-500 dark:text-gray-400">
                    {project.address || "No address"}
                  </p>
                  <p class="text-xs text-gray-400 dark:text-gray-500">
                    Status: {project.status || "Unknown"}
                  </p>
                </div>
                <div class="ml-2 flex-shrink-0">
                  <span class="inline-flex items-center rounded-full bg-blue-100 px-2 py-1 text-xs font-medium text-blue-800 dark:bg-blue-900 dark:text-blue-200">
                    {project.comment_count || 0} comments
                  </span>
                </div>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <div class="py-4 text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">
            No projects currently assigned to you
          </p>
        </div>
      )
    }
  </div>
</div>
