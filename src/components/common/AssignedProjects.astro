---
/**
 * AssignedProjects - Shows count + preview of projects assigned to current user.
 * Uses assignedProjectsCount + assignedProjectsPreview (fetched by App) â€” no full projects array.
 */
import SimpleIcon from "./SimpleIcon.astro";

interface Props {
  currentUser: any;
  /** Pre-fetched count (from App). Prefer over projects. */
  assignedProjectsCount?: number;
  /** Pre-fetched preview of up to 5 projects (from App). Prefer over projects. */
  assignedProjectsPreview?: any[];
  /** @deprecated Pass assignedProjectsCount + assignedProjectsPreview instead. Fallback only. */
  projects?: any[];
}

const {
  currentUser,
  assignedProjectsCount: countProp = 0,
  assignedProjectsPreview: previewProp = [],
  projects = [],
} = Astro.props;

const currentRole = currentUser?.profile?.role;
const showAssigned = currentRole !== "Client";
let assignedProjectsCount = countProp;
let assignedProjects = previewProp;

if (assignedProjectsCount === 0 && assignedProjects.length === 0 && projects?.length) {
  assignedProjects = projects.filter((p: any) => p.assignedToId === currentUser?.id);
  assignedProjectsCount = assignedProjects.length;
}
---

{showAssigned && assignedProjectsCount > 0 && (
    <button
      type="button"
      class="align-center relative flex w-full rounded-lg p-2 hover:bg-gray-300 dark:hover:bg-gray-700"
      aria-expanded="false"
    >
      <SimpleIcon name="folder" variant="secondary" size="xs" id="assigned-projects-button">
        {" "}
        Assigned Projects
        <span class="sr-only">View assigned projects</span>
      </SimpleIcon>

      <span
        class="count-bubble dark:bg-primary-dark pulse absolute -right-2 -top-2 flex h-5 w-5 animate-pulse items-center justify-center rounded-full bg-primary-500 text-xs font-bold text-white"
        style="display: flex;"
      >
        {assignedProjectsCount.toString()}
      </span>
      <div>
        <ul class="space-y-2 py-2">
          {assignedProjects.slice(0, 5).map((project: any) => (
            <li>
              <a
                href={`/project/${project.id}`}
                class="align-center ml-2 flex w-full gap-2 rounded-lg p-2 hover:bg-gray-300 dark:hover:bg-gray-700"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="SimpleIcon map-pin-icon map-pin"
                >
                  <path d="M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0" />
                  <circle cx="12" cy="10" r="3" />
                </svg>
                {project.title || project.address || "Untitled Project"}
              </a>
            </li>
          ))}
        </ul>
      </div>
    </button>
  )
}
