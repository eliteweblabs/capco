---
/**
 * CheckInButton: Check in / Check out at location for Admin and Staff.
 * - Sends a notification to all Admins with the user's geolocation.
 * - Starts a billing time entry (optional projectId); check-out ends it.
 * - While checked in, sends periodic location pings to /api/location/ping for live dashboard.
 */
import SimpleIcon from "./SimpleIcon.astro";

interface Props {
  globalIconButtonClasses?: string;
  tile?: boolean;
  /** Optional project to attach this session to (billing + live map). Set when on a project page. */
  projectId?: number | null;
}

const {
  globalIconButtonClasses = "inline-flex items-center rounded-full justify-center p-2 text-black dark:text-white hover:bg-gray-100 focus:ring-4 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-700 focus:outline-none",
  tile = false,
  projectId = null,
} = Astro.props;

const tileClasses =
  "flex flex-col items-center justify-center gap-2 rounded-xl border border-gray-200 bg-gray-50 p-4 text-center transition-colors hover:border-primary-300 hover:bg-primary-50 dark:border-gray-700 dark:bg-gray-800 dark:hover:border-primary-600 dark:hover:bg-primary-950/30";
const buttonClass = tile ? tileClasses : globalIconButtonClasses;
const iconSize = tile ? "xl" : "md";
---

<button
  type="button"
  id="check-in-btn"
  title="Check in at location"
  aria-label="Check in at location"
  class={buttonClass}
  data-state="checked_out"
  data-project-id={projectId ?? undefined}
>
  <span id="check-in-icon" class="check-in-icon" aria-hidden="true">
    <SimpleIcon name="map-pin" size={iconSize} class="text-primary-500 dark:text-primary-400" />
  </span>
  <span id="check-out-icon" class="check-out-icon hidden" aria-hidden="true">
    <SimpleIcon name="log-out" size={iconSize} class="text-primary-500 dark:text-primary-400" />
  </span>
  {
    tile && (
      <span id="check-in-label" class="text-sm font-medium text-gray-900 dark:text-white">
        Check In
      </span>
    )
  }
  <span class="sr-only">Check in at location</span>
</button>

<style>
  .check-out-icon.hidden {
    display: none;
  }
  #check-in-btn[data-state="checked_in"] .check-in-icon {
    display: none;
  }
  #check-in-btn[data-state="checked_in"] .check-out-icon {
    display: inline;
  }
</style>

<script>
  const STORAGE_KEY = "location-checkin-state";
  const TIME_ENTRY_KEY = "location-checkin-time-entry-id";
  const PING_INTERVAL_MS = 60 * 1000; // 1 minute

  function getState(): "checked_in" | "checked_out" {
    try {
      const s = sessionStorage.getItem(STORAGE_KEY);
      return s === "checked_in" ? "checked_in" : "checked_out";
    } catch {
      return "checked_out";
    }
  }

  function setState(state: "checked_in" | "checked_out") {
    try {
      sessionStorage.setItem(STORAGE_KEY, state);
    } catch (_) {}
  }

  function getTimeEntryId(): number | null {
    try {
      const s = sessionStorage.getItem(TIME_ENTRY_KEY);
      if (s == null) return null;
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? n : null;
    } catch {
      return null;
    }
  }

  function setTimeEntryId(id: number | null) {
    try {
      if (id == null) sessionStorage.removeItem(TIME_ENTRY_KEY);
      else sessionStorage.setItem(TIME_ENTRY_KEY, String(id));
    } catch (_) {}
  }

  function updateButton(state: "checked_in" | "checked_out") {
    const btn = document.getElementById("check-in-btn") as HTMLButtonElement | null;
    if (!btn) return;

    const isCheckedIn = state === "checked_in";
    btn.dataset.state = state;
    btn.title = isCheckedIn ? "Check out" : "Check in at location";
    btn.setAttribute("aria-label", isCheckedIn ? "Check out" : "Check in at location");
    btn.disabled = false;

    const srOnly = btn.querySelector(".sr-only");
    if (srOnly) {
      srOnly.textContent = isCheckedIn ? "Check out" : "Check in at location";
    }
    const labelEl = btn.querySelector("#check-in-label");
    if (labelEl) {
      labelEl.textContent = isCheckedIn ? "Check out" : "Check In";
    }
  }

  function getPosition(): Promise<{ lat: number; lng: number; accuracy?: number }> {
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        reject(new Error("Geolocation not supported"));
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) =>
          resolve({
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
          }),
        (err) => reject(err),
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
      );
    });
  }

  let pingIntervalId: ReturnType<typeof setInterval> | null = null;

  function stopPingInterval() {
    if (pingIntervalId != null) {
      clearInterval(pingIntervalId);
      pingIntervalId = null;
    }
  }

  function startPingInterval(timeEntryId: number, projectIdNum: number | null) {
    stopPingInterval();
    const sendPing = () => {
      getPosition()
        .then((pos) =>
          fetch("/api/location/ping", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              timeEntryId,
              projectId: projectIdNum,
              lat: pos.lat,
              lng: pos.lng,
              accuracy: pos.accuracy,
            }),
          })
        )
        .catch(() => {});
    };
    sendPing(); // send once soon
    pingIntervalId = setInterval(sendPing, PING_INTERVAL_MS);
  }

  async function handleClick() {
    const btn = document.getElementById("check-in-btn") as HTMLButtonElement | null;
    if (!btn || btn.disabled) return;

    const state = getState();
    const isCheckIn = state === "checked_out";
    const projectIdStr = btn.dataset.projectId;
    const projectIdNum =
      projectIdStr != null && projectIdStr !== "" ? parseInt(projectIdStr, 10) : null;
    const validProjectId = Number.isFinite(projectIdNum) ? projectIdNum : null;

    btn.disabled = true;

    try {
      const pos = await getPosition();
      const lat = pos.lat;
      const lng = pos.lng;
      const accuracy = pos.accuracy;

      const body: Record<string, unknown> = {
        action: isCheckIn ? "check_in" : "check_out",
        lat,
        lng,
        accuracy,
      };
      if (isCheckIn) {
        if (validProjectId != null) body.projectId = validProjectId;
      } else {
        const teId = getTimeEntryId();
        if (teId != null) body.timeEntryId = teId;
      }

      const res = await fetch("/api/location/check-in", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });

      const data = await res.json();

      if (!res.ok) {
        throw new Error(data.error || "Request failed");
      }

      const newState = isCheckIn ? "checked_in" : "checked_out";
      setState(newState);
      updateButton(newState);

      if (isCheckIn && data.timeEntryId != null) {
        setTimeEntryId(data.timeEntryId);
        startPingInterval(data.timeEntryId, validProjectId);
      } else {
        setTimeEntryId(null);
        stopPingInterval();
      }

      if (typeof (window as any).showNotice === "function") {
        const loc = data.address ?? data.location ?? "your location";
        (window as any).showNotice(
          "success",
          isCheckIn ? "Checked in" : "Checked out",
          isCheckIn
            ? `Successfully checked in at ${loc}. Timer started for billing.`
            : `Successfully checked out from ${loc}.`,
          3000
        );
      }
    } catch (err) {
      const msg = err instanceof Error ? err.message : "Failed to get location";
      if (typeof (window as any).showNotice === "function") {
        (window as any).showNotice("error", "Location Error", msg, 5000);
      } else {
        alert(msg);
      }
    } finally {
      btn.disabled = false;
    }
  }

  function init() {
    const btn = document.getElementById("check-in-btn") as HTMLButtonElement | null;
    if (!btn) return;

    const state = getState();
    updateButton(state);

    const teId = getTimeEntryId();
    if (state === "checked_in" && teId != null) {
      const projectIdStr = btn.dataset.projectId;
      const projectIdNum =
        projectIdStr != null && projectIdStr !== "" ? parseInt(projectIdStr, 10) : null;
      startPingInterval(teId, Number.isFinite(projectIdNum) ? projectIdNum : null);
    }

    btn.addEventListener("click", handleClick);

    window.addEventListener("beforeunload", stopPingInterval);
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
</script>
