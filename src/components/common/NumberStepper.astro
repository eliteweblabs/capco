---
// Enable use as both component and partial (partial page passes props from X-headers)
export const partial = true;
import SimpleIcon from "./SimpleIcon.astro";

export interface Props {
  value?: number | string;
  min?: number;
  max?: number;
  step?: number;
  name?: string;
  id?: string;
  class?: string;
  inputClass?: string;
  /** For proposal line items: row index */
  dataRowIndex?: string | number;
  /** For proposal line items: field name (e.g. "quantity") */
  dataField?: string;
  /** Inline onchange handler string (e.g. "window.proposalManager.updateLineItemFromInput(this)") */
  onchangeInline?: string;
  disabled?: boolean;
}

const {
  value = 0,
  min,
  max,
  step = 1,
  name,
  id,
  class: className = "",
  inputClass = "",
  dataRowIndex,
  dataField,
  onchangeInline,
  disabled = false,
} = Astro.props;

const numValue = typeof value === "string" ? (value === "" ? 0 : Number(value)) : Number(value);
const wrapperClass =
  "number-stepper flex items-center gap-0 rounded-md border border-gray-300 dark:border-gray-600 overflow-hidden";
const btnClass =
  "flex items-center justify-center p-2 h-9 w-9 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 border-0 text-gray-600 dark:text-gray-300 disabled:opacity-50 disabled:pointer-events-none transition-colors";
const inputBaseClass =
  "w-14 sm:w-20 text-center border-0 border-x border-gray-300 dark:border-gray-600 bg-gray-50 dark:bg-gray-700 text-sm focus:ring-primary-500 focus:border-primary-500 py-1.5 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none";
const resolvedInputClass = [inputBaseClass, inputClass].filter(Boolean).join(" ");
---

<div class={`${wrapperClass} ${className}`.trim()}>
  <button
    type="button"
    class={btnClass}
    data-action="decrement"
    aria-label="Decrease"
    disabled={disabled || (min != null && numValue <= min)}
  >
    <SimpleIcon name="minus" size="xs" />
  </button>
  <input
    type="number"
    value={numValue}
    min={min}
    max={max}
    step={step}
    name={name}
    id={id}
    class={resolvedInputClass}
    data-row-index={dataRowIndex != null ? String(dataRowIndex) : undefined}
    data-field={dataField}
    autocomplete="off"
    disabled={disabled}
    {...(onchangeInline && { onchange: onchangeInline })}
  />
  <button
    type="button"
    class={btnClass}
    data-action="increment"
    aria-label="Increase"
    disabled={disabled || (max != null && numValue >= max)}
  >
    <SimpleIcon name="plus" size="xs" />
  </button>
</div>

<script>
  // Event delegation: handle +/- for any .number-stepper (including dynamically added rows)
  function handleStepperClick(e: Event) {
    const target = (e.target as HTMLElement).closest("[data-action='decrement'], [data-action='increment']");
    if (!target) return;
    const wrap = (target as HTMLElement).closest(".number-stepper");
    const input = wrap?.querySelector("input[type='number']") as HTMLInputElement;
    if (!input || input.disabled) return;
    const action = (target as HTMLElement).getAttribute("data-action");
    const step = Number(input.step) || 1;
    const min = input.min ? Number(input.min) : undefined;
    const max = input.max ? Number(input.max) : undefined;
    let val = Number(input.value) || 0;
    if (action === "decrement") {
      val = min != null ? Math.max(min, val - step) : val - step;
    } else {
      val = max != null ? Math.min(max, val + step) : val + step;
    }
    input.value = String(val);
    input.dispatchEvent(new Event("change", { bubbles: true }));
  }

  document.addEventListener("click", handleStepperClick);
</script>
