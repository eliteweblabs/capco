---
/**
 * AdminDiscussions Component
 * Global discussions management panel - can be embedded in any page
 */
import Hero from "../common/Hero.astro";
import DiscussionsComponent from "../form/Discussions.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import { globalClasses } from "../../pages/api/global/global-classes";

export interface Props {
  currentUser: any;
  globalInputClasses?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  showHero?: boolean;
}

const gc = globalClasses();
const {
  currentUser,
  globalInputClasses = gc.globalInputClasses,
  primaryTextClasses = gc.primaryTextClasses,
  secondaryTextClasses = gc.secondaryTextClasses,
  showHero = true,
} = Astro.props;
const { globalAdminContainerClasses, dataTableDescriptionClasses } = gc;

// Fetch projects for overview stats
let projects: any[] = [];
let discussionStats: any = {
  recent_24h: 0,
  active_users_24h: 0,
};

if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    const apiUrl = `${baseUrl}/api/projects/get`;
    const response = await fetch(apiUrl, {
      headers: {
        Cookie: Astro.request.headers.get("cookie") || "",
      },
    });

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
    }
  } catch (error) {
    console.error("Error fetching projects:", error);
  }

  // Fetch discussion stats server-side
  try {
    const baseUrl = Astro.url.origin;
    const statsUrl = `${baseUrl}/api/discussions/get`;
    const statsResponse = await fetch(statsUrl, {
      headers: {
        Cookie: Astro.request.headers.get("cookie") || "",
      },
    });

    if (statsResponse.ok) {
      const statsData = await statsResponse.json();
      if (statsData.success && statsData.stats) {
        discussionStats = statsData.stats;
      }
    }
  } catch (error) {
    console.error("Error fetching discussion stats:", error);
  }
}
---

<div class="admin-discussions-component">
  {
    showHero && (
      <Hero
        title="Global Discussions"
        description="Monitor all project discussions, client comments, and internal conversations across the platform."
        {primaryTextClasses}
        {secondaryTextClasses}
        {globalInputClasses}
      />
    )
  }

  <!-- Overview Cards -->
  <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
    <!-- Total Projects -->
    <div class={`${globalAdminContainerClasses} p-6`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="building" class="h-8 w-8 text-primary-600 dark:text-primary-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class={`text-sm font-medium ${dataTableDescriptionClasses}`}>Total Projects</p>
          <p id="total-projects" class={`text-lg font-semibold ${primaryTextClasses}`}>
            {projects.length}
          </p>
        </div>
      </div>
    </div>

    <!-- Active Projects -->
    <div class={`${globalAdminContainerClasses} p-6`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="trending-up" class="h-8 w-8 text-green-600 dark:text-green-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class={`text-sm font-medium ${dataTableDescriptionClasses}`}>Active Projects</p>
          <p id="active-projects" class={`text-lg font-semibold ${primaryTextClasses}`}>
            {projects.filter((p) => p.status > 0 && p.status < 90).length}
          </p>
        </div>
      </div>
    </div>

    <!-- Total Discussions (24h) -->
    <div class={`${globalAdminContainerClasses} p-6`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="message-square" class="h-8 w-8 text-yellow-600 dark:text-yellow-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class={`text-sm font-medium ${dataTableDescriptionClasses}`}>Discussions (24h)</p>
          <p id="recent-discussions-header" class={`text-lg font-semibold ${primaryTextClasses}`}>
            {discussionStats.recent_24h}
          </p>
        </div>
      </div>
    </div>

    <!-- Active Users -->
    <div class={`${globalAdminContainerClasses} p-6`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="users" class="h-8 w-8 text-purple-600 dark:text-purple-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class={`text-sm font-medium ${dataTableDescriptionClasses}`}>Active Users</p>
          <p id="active-users-header" class={`text-lg font-semibold ${primaryTextClasses}`}>
            {discussionStats.active_users_24h}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Discussions Component -->
  <div class={globalAdminContainerClasses}>
    <DiscussionsComponent
      project={null}
      {currentUser}
      {globalInputClasses}
      {secondaryTextClasses}
      {primaryTextClasses}
    />
  </div>
</div>

<script>
  // Update dynamic stats when the discussions load
  document.addEventListener("DOMContentLoaded", () => {
    // Load stats from the unified discussions API
    loadDiscussionStats();

    // Initialize the discussions system for global discussions
    if (typeof window.initializeDiscussions === "function") {
      console.log("üé¨ [GLOBAL-DISCUSSIONS] Initializing global discussions system");
      window.initializeDiscussions();
    } else {
      console.error("‚ùå [GLOBAL-DISCUSSIONS] initializeDiscussions function not found");
    }
  });

  async function loadDiscussionStats() {
    try {
      const response = await fetch("/api/discussions/get", {
        credentials: "include",
      });

      const data = await response.json();

      if (data.success && data.stats) {
        updateStatsDisplay(data.stats);
      } else {
        console.error("Failed to load discussion stats:", data.error);
        // Set fallback values
        updateStatsDisplay({
          recent_24h: 0,
          active_users_24h: 0,
        });
      }
    } catch (error) {
      console.error("Error loading discussion stats:", error);
      // Set fallback values
      updateStatsDisplay({
        recent_24h: 0,
        active_users_24h: 0,
      });
    }
  }

  function updateStatsDisplay(stats: any) {
    const headerRecentEl = document.getElementById("recent-discussions-header");
    const headerActiveUsersEl = document.getElementById("active-users-header");

    if (headerRecentEl) {
      headerRecentEl.textContent = stats.recent_24h || 0;
    }
    if (headerActiveUsersEl) {
      headerActiveUsersEl.textContent = stats.active_users_24h || 0;
    }

    console.log("üìä [GLOBAL-DISCUSSIONS] Updated stats display:", {
      recent_24h: stats.recent_24h || 0,
      active_users_24h: stats.active_users_24h || 0,
    });
  }
</script>
