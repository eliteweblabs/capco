---
/**
 * Admin-only Voice Assistant Widget
 * Replaces SpeedDial for admins. Polls for new form submissions and notifies
 * out loud via VAPI (e.g. "New MEP project submitted by Client Joe, read it?").
 */

import CloseButton from "../ui/CloseButton.astro";

interface Props {
  currentUser?: any;
  globalCompanyPhone?: string;
}

const { currentUser, globalCompanyPhone } = Astro.props;

const assistantId =
  import.meta.env.PUBLIC_PUBLIC_VAPI_ASSISTANT_ID || import.meta.env.PUBLIC_VAPI_ASSISTANT_ID || "";
const publicKey = import.meta.env.PUBLIC_VAPI_KEY || "";
const currentUserRole = currentUser?.profile?.role || "Client";
---

<div id="admin-voice-widget" class="group">
  <div
    id="admin-voice-panel"
    class="admin-voice-panel fixed hidden w-72 overflow-hidden rounded-xl border border-gray-200 bg-white shadow-xl dark:border-gray-700 dark:bg-gray-900"
    style="bottom: 5rem; right: 1.5rem;"
  >
    <div
      id="admin-voice-panel-drag"
      class="flex cursor-move select-none items-center justify-between gap-2 border-b border-gray-200 bg-gray-50 px-4 py-2 dark:border-gray-700 dark:bg-gray-800/50"
    >
      <div class="flex min-w-0 flex-1 items-center gap-2">
        <span
          class="dark:bg-primary-900/50 shrink-0 rounded bg-primary-100 px-1.5 py-0.5 text-[10px] font-medium uppercase tracking-wide text-primary-700 dark:text-primary-300"
          title="Admin mode: form alerts, create project, welcome email"
        >
          Admin
        </span>
        <div id="admin-voice-status-dot" class="h-2.5 w-2.5 shrink-0 rounded-full bg-gray-400">
        </div>
        <span id="admin-voice-status-text" class="truncate text-sm text-gray-700 dark:text-gray-300"
          >Ready</span
        >
      </div>
      <CloseButton
        id="admin-voice-panel-close"
        tooltipText="Close"
        position="left"
        class="shrink-0"
      />
    </div>
    <div class="p-4 pt-3">
      <button
        id="admin-voice-start"
        type="button"
        class="flex w-full items-center justify-center gap-2 rounded-lg bg-primary-600 px-4 py-3 text-sm font-medium text-white transition-colors hover:bg-primary-700 disabled:cursor-not-allowed disabled:opacity-50"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"
          ></path>
        </svg>
        <span id="admin-voice-btn-label">Start Voice Assistant</span>
      </button>
      <button
        id="admin-voice-stop"
        type="button"
        class="hidden w-full items-center justify-center gap-2 rounded-lg bg-red-600 px-4 py-3 text-sm font-medium text-white transition-colors hover:bg-red-700"
      >
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path>
        </svg>
        Stop
      </button>
      <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
        New form submissions will be announced when the assistant is active.
      </p>
      <p id="admin-voice-error-hint" class="mt-2 hidden text-xs text-amber-600 dark:text-amber-400">
        If connection fails, add this site’s URL to VAPI Dashboard → API Keys → Allowed origins.
      </p>
      <p
        id="admin-voice-localhost-hint"
        class="mt-2 hidden text-xs text-blue-600 dark:text-blue-400"
      >
        VAPI only works with a public URL. Test voice on your deployed site, or use a tunnel (e.g.
        ngrok) and add that URL to VAPI allowed origins.
      </p>
    </div>
  </div>

  <button
    id="admin-voice-fab"
    type="button"
    aria-label="Voice Assistant"
    title="Voice Assistant (Admin)"
    class="flex h-14 w-14 items-center justify-center rounded-full bg-primary-700 text-white shadow-lg hover:bg-primary-800 focus:outline-none focus:ring-4 focus:ring-primary-300 dark:bg-primary-600 dark:hover:bg-primary-700 dark:focus:ring-primary-800 sm:h-12 sm:w-12"
  >
    <svg
      class="h-8 w-8 shrink-0"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      aria-hidden="true"
    >
      <!-- Equalizer bar: 6×20px, rounded top; scales from bottom center -->
      <rect
        class="admin-voice-equalizer-rect"
        x="9"
        y="4"
        width="6"
        height="20"
        rx="2"
        ry="2"
        fill="white"></rect>
      <path
        d="M19 9v3a5.006 5.006 0 0 1-5 5h-4a5.006 5.006 0 0 1-5-5V9m7 9v3m-3 0h6M11 3h2a3 3 0 0 1 3 3v5a3 3 0 0 1-3 3h-2a3 3 0 0 1-3-3V6a3 3 0 0 1 3-3Z"
      ></path>
    </svg>
  </button>
</div>

<style>
  .admin-voice-equalizer-rect {
    transform: translateY(-10px) scaleY(0.1);
    /* Rect bottom center (12,24); max ~75%; up 10px; scaleY driven by JS */
    transform-origin: 12px 24px;
  }

  .admin-voice-panel-dragging {
    user-select: none;
  }
</style>

<script>
  (function () {
    const rect = document.querySelector(".admin-voice-equalizer-rect");
    if (!rect) return;
    const MIN = 0.05;
    const MAX = 0.62;
    const LOW_MAX = 0.14; // ~1–3px height range; bias toward this for 2–3s feel
    const LERP = 0.85; // ~50ms to reach next value
    const TICK_MS = 50;
    let current = 0.08;
    let target = 0.1;
    function rand(min, max) {
      return min + Math.random() * (max - min);
    }
    function pickTarget() {
      return Math.random() < 0.72 ? rand(MIN, LOW_MAX) : rand(MIN, MAX);
    }
    function setScale(sy) {
      (rect as SVGElement).style.transform = "translateY(-10px) scaleY(" + sy + ")";
    }
    function tick() {
      current += (target - current) * LERP;
      if (Math.random() < 0.18) {
        target = pickTarget();
      }
      setScale(current);
      setTimeout(tick, TICK_MS);
    }
    target = pickTarget();
    setScale(current);
    setTimeout(tick, TICK_MS);
  })();
</script>

<script
  src="https://cdn.jsdelivr.net/gh/balacodeio/Vapi-Web-UMD@latest/dist/latest/vapi-web-bundle.min.js"
  is:inline></script>

<script define:vars={{ assistantId, publicKey, currentUser, currentUserRole }}>
  (function () {
    const LOG = "[---ADMIN-VOICE]";
    let vapi = null;
    let isCallActive = false;
    let submissionPollInterval = null;
    let lastPollTime = null;
    const POLL_INTERVAL_MS = 30000;

    const fab = document.getElementById("admin-voice-fab");
    const panel = document.getElementById("admin-voice-panel");
    const startBtn = document.getElementById("admin-voice-start");
    const stopBtn = document.getElementById("admin-voice-stop");
    const statusDot = document.getElementById("admin-voice-status-dot");
    const statusText = document.getElementById("admin-voice-status-text");
    const btnLabel = document.getElementById("admin-voice-btn-label");
    const errorHint = document.getElementById("admin-voice-error-hint");

    function setStatus(text, colorClass) {
      if (statusText) statusText.textContent = text;
      if (statusDot) statusDot.className = `w-2.5 h-2.5 rounded-full ${colorClass}`;
    }

    function showConnectionError(showHint) {
      console.log(LOG, "showConnectionError", { showHint });
      setStatus("Connection failed", "bg-red-400");
      if (btnLabel) btnLabel.textContent = "Retry";
      if (startBtn) startBtn.disabled = false;
      if (startBtn) startBtn.classList.remove("hidden");
      if (stopBtn) {
        stopBtn.classList.add("hidden");
        stopBtn.classList.remove("flex");
      }
      if (errorHint) errorHint.classList.toggle("hidden", !showHint);
    }

    function announceToAgent(text) {
      if (!vapi || !isCallActive) {
        console.log(LOG, "announceToAgent skipped (no vapi or call inactive)", {
          hasVapi: !!vapi,
          isCallActive,
        });
        return;
      }
      try {
        console.log(LOG, "announceToAgent sending", { text });
        vapi.send({
          type: "add-message",
          message: { role: "system", content: text },
        });
        console.log(LOG, "announceToAgent sent ok");
      } catch (e) {
        console.warn(LOG, "announce failed", e);
      }
    }

    /** Format ISO timestamp for spoken announcement (e.g. "2:30 PM" or "today at 2:30 PM") */
    function formatTimeForSpeech(isoStr) {
      if (!isoStr) return "";
      try {
        const d = new Date(isoStr);
        if (isNaN(d.getTime())) return "";
        const now = new Date();
        const isToday = d.toDateString() === now.toDateString();
        const timeStr = d.toLocaleTimeString("en-US", {
          hour: "numeric",
          minute: "2-digit",
          hour12: true,
        });
        return isToday ? `at ${timeStr}` : `on ${d.toLocaleDateString("en-US", { month: "short", day: "numeric" })} at ${timeStr}`;
      } catch (e) {
        return "";
      }
    }

    /** Build VAPI announcement: user name, action, time, project name (if applicable) */
    function buildAnnouncement({ userName, action, timeIso, projectName, address }) {
      const timePart = formatTimeForSpeech(timeIso);
      const timePhrase = timePart ? ` ${timePart}` : "";
      const parts = [`Read aloud: ${userName} ${action}${timePhrase}`];
      if (projectName) parts.push(`Project: ${projectName}`);
      if (address) parts.push(`Address: ${address}`);
      return parts.join(". ") + ".";
    }

    async function pollNewSubmissions() {
      if (!lastPollTime) lastPollTime = new Date().toISOString();
      const url = `/api/admin/new-submissions?since=${encodeURIComponent(lastPollTime)}`;
      console.log(LOG, "pollNewSubmissions start", { since: lastPollTime, url });
      try {
        const res = await fetch(url, { credentials: "include" });
        console.log(LOG, "pollNewSubmissions response", { ok: res.ok, status: res.status });
        if (!res.ok) return;
        const data = await res.json();
        console.log(LOG, "pollNewSubmissions data", {
          success: data.success,
          contactCount: data.contactSubmissions?.length ?? 0,
          mepCount: data.mepProjects?.length ?? 0,
        });
        if (!data.success) return;

        const contact = data.contactSubmissions || [];
        const mep = data.mepProjects || [];
        const seen = new Set();

        for (const c of contact) {
          const key = `contact-${c.id}`;
          if (seen.has(key)) continue;
          seen.add(key);
          const userName = [c.firstName, c.lastName].filter(Boolean).join(" ") || "Someone";
          const msg = buildAnnouncement({
            userName,
            action: "submitted a new contact form",
            timeIso: c.submittedAt || c.createdAt,
          });
          console.log(LOG, "pollNewSubmissions new contact", { id: c.id, userName, msg });
          announceToAgent(msg);
        }

        for (const p of mep) {
          const key = `mep-${p.id}`;
          if (seen.has(key)) continue;
          seen.add(key);
          const userName = p.clientName || "A client";
          const msg = buildAnnouncement({
            userName,
            action: "submitted a new MEP project",
            timeIso: p.createdAt,
            projectName: p.title || undefined,
            address: p.address || undefined,
          });
          console.log(LOG, "pollNewSubmissions new MEP", {
            id: p.id,
            userName,
            title: p.title,
            address: p.address,
            msg,
          });
          announceToAgent(msg);
        }

        if (contact.length > 0 || mep.length > 0) {
          lastPollTime = new Date().toISOString();
          console.log(LOG, "pollNewSubmissions updated lastPollTime", {
            lastPollTime,
            contactCount: contact.length,
            mepCount: mep.length,
          });
        }
      } catch (e) {
        console.warn(LOG, "poll error", e);
      }
    }

    function startSubmissionPolling() {
      if (submissionPollInterval) {
        console.log(LOG, "startSubmissionPolling already running");
        return;
      }
      lastPollTime = new Date(Date.now() - 60 * 1000).toISOString();
      submissionPollInterval = setInterval(pollNewSubmissions, POLL_INTERVAL_MS);
      console.log(LOG, "startSubmissionPolling", { intervalMs: POLL_INTERVAL_MS, lastPollTime });
      pollNewSubmissions();
    }

    function stopSubmissionPolling() {
      if (submissionPollInterval) {
        clearInterval(submissionPollInterval);
        submissionPollInterval = null;
        console.log(LOG, "stopSubmissionPolling");
      }
    }

    function initVapi() {
      console.log(LOG, "initVapi", {
        hasPublicKey: !!publicKey,
        hasAssistantId: !!assistantId,
        assistantIdLength: assistantId?.length,
      });
      if (!publicKey || !assistantId) {
        console.warn(LOG, "initVapi not configured, disabling start");
        setStatus("Not configured", "bg-red-400");
        if (startBtn) startBtn.disabled = true;
        if (btnLabel) btnLabel.textContent = "Missing VAPI config";
        return;
      }

      try {
        vapi = new window.Vapi(publicKey);
        console.log(LOG, "initVapi VAPI instance created");
      } catch (e) {
        console.error(LOG, "VAPI init error", e);
        setStatus("Error", "bg-red-400");
        if (startBtn) startBtn.disabled = true;
        return;
      }

      vapi.on("call-start", () => {
        console.log(LOG, "vapi event call-start");
        isCallActive = true;
        if (startBtn) startBtn.classList.add("hidden");
        if (stopBtn) {
          stopBtn.classList.remove("hidden");
          stopBtn.classList.add("flex");
        }
        setStatus("Listening...", "bg-green-400");
        startSubmissionPolling();
      });

      vapi.on("call-end", () => {
        console.log(LOG, "vapi event call-end");
        isCallActive = false;
        if (startBtn) startBtn.classList.remove("hidden");
        if (stopBtn) {
          stopBtn.classList.add("hidden");
          stopBtn.classList.remove("flex");
        }
        setStatus("Ready", "bg-gray-400");
        stopSubmissionPolling();
      });

      vapi.on("speech-start", () => {
        console.log(LOG, "vapi event speech-start");
        setStatus("Speaking...", "bg-purple-400");
      });
      vapi.on("speech-end", () => {
        console.log(LOG, "vapi event speech-end");
        setStatus("Listening...", "bg-green-400");
      });
      vapi.on("error", (err) => {
        console.error(LOG, "vapi event error", err);
        setStatus("Error", "bg-red-400");
        const isNetworkError =
          err?.message === "Failed to fetch" ||
          (err?.message && String(err.message).toLowerCase().includes("fetch"));
        if (errorHint) errorHint.classList.toggle("hidden", !isNetworkError);
      });
      console.log(LOG, "initVapi event listeners attached");
    }

    function closePanel() {
      if (!panel || !fab) return;
      console.log(LOG, "closePanel");
      panel.classList.add("hidden");
      fab.classList.remove("hidden");
    }

    function openPanel() {
      if (!panel || !fab) return;
      console.log(LOG, "openPanel");
      panel.classList.remove("hidden");
      fab.classList.add("hidden");
    }

    function togglePanel() {
      if (!panel || !fab) return;
      const isHidden = panel.classList.contains("hidden");
      console.log(LOG, "togglePanel", { isHidden, action: isHidden ? "open" : "close" });
      if (isHidden) openPanel();
      else closePanel();
    }

    function setupDraggable() {
      const dragHandle = document.getElementById("admin-voice-panel-drag");
      if (!dragHandle || !panel) {
        console.log(LOG, "setupDraggable skipped", {
          hasDragHandle: !!dragHandle,
          hasPanel: !!panel,
        });
        return;
      }
      console.log(LOG, "setupDraggable");

      let isDragging = false;
      let startX = 0;
      let startY = 0;
      let startLeft = 0;
      let startTop = 0;

      function getPanelRect() {
        const r = panel.getBoundingClientRect();
        return { left: r.left, top: r.top, width: r.width, height: r.height };
      }

      function startDrag(clientX, clientY) {
        const r = getPanelRect();
        startLeft = r.left;
        startTop = r.top;
        startX = clientX;
        startY = clientY;
        isDragging = true;
        panel.style.right = "auto";
        panel.style.bottom = "auto";
        panel.style.left = startLeft + "px";
        panel.style.top = startTop + "px";
        panel.classList.add("admin-voice-panel-dragging");
      }

      function moveDrag(clientX, clientY) {
        if (!isDragging) return;
        const dx = clientX - startX;
        const dy = clientY - startY;
        const newLeft = Math.max(0, Math.min(window.innerWidth - 50, startLeft + dx));
        const newTop = Math.max(0, Math.min(window.innerHeight - 100, startTop + dy));
        panel.style.left = newLeft + "px";
        panel.style.top = newTop + "px";
      }

      function endDrag() {
        if (isDragging) console.log(LOG, "drag end");
        isDragging = false;
        panel.classList.remove("admin-voice-panel-dragging");
      }

      dragHandle.addEventListener("mousedown", (e) => {
        if (e.button !== 0) return;
        if (e.target.closest("#admin-voice-panel-close")) return;
        startDrag(e.clientX, e.clientY);
        e.preventDefault();
      });

      document.addEventListener("mousemove", (e) => {
        if (!isDragging) return;
        moveDrag(e.clientX, e.clientY);
        e.preventDefault();
      });

      document.addEventListener("mouseup", () => {
        endDrag();
      });

      dragHandle.addEventListener(
        "touchstart",
        (e) => {
          if (e.target.closest("#admin-voice-panel-close")) return;
          if (e.changedTouches.length) {
            startDrag(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
            e.preventDefault();
          }
        },
        { passive: false }
      );

      document.addEventListener(
        "touchmove",
        (e) => {
          if (!isDragging || !e.changedTouches.length) return;
          moveDrag(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
          e.preventDefault();
        },
        { passive: false }
      );

      document.addEventListener("touchend", () => {
        endDrag();
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const isLocal =
        typeof window !== "undefined" &&
        (window.location.hostname === "localhost" ||
          window.location.hostname === "127.0.0.1" ||
          window.location.hostname.startsWith("192.168."));
      const localhostHint = document.getElementById("admin-voice-localhost-hint");
      if (isLocal && localhostHint) {
        localhostHint.classList.remove("hidden");
        console.log(
          LOG,
          "localhost detected – VAPI only tests online; use deployed site or tunnel"
        );
      }

      console.log(LOG, "DOMContentLoaded", {
        hasFab: !!fab,
        hasPanel: !!panel,
        hasStartBtn: !!startBtn,
        hasStopBtn: !!stopBtn,
        isLocal,
      });
      if (!fab || !panel) {
        console.warn(LOG, "DOMContentLoaded missing elements, aborting");
        return;
      }

      setupDraggable();

      const closeBtn = document.getElementById("admin-voice-panel-close");
      if (closeBtn) {
        closeBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log(LOG, "close button clicked");
          closePanel();
        });
      }

      fab.addEventListener("click", (e) => {
        e.stopPropagation();
        togglePanel();
      });

      document.addEventListener("click", (e) => {
        const el = e.target;
        if (panel && !panel.contains(el) && !fab.contains(el)) {
          console.log(LOG, "outside click close");
          closePanel();
        }
      });

      if (startBtn) {
        startBtn.addEventListener("click", async () => {
          if (!vapi) return;
          console.log(LOG, "start button clicked", {
            assistantId: assistantId ? `${assistantId.slice(0, 8)}...` : "",
            metadata: { mode: "admin", userRole: currentUserRole },
          });
          if (errorHint) errorHint.classList.add("hidden");
          setStatus("Connecting...", "bg-yellow-400");
          if (btnLabel) btnLabel.textContent = "Connecting...";
          try {
            await vapi.start(assistantId, {
              metadata: {
                mode: "admin",
                userId: currentUser?.id,
                userEmail: currentUser?.email,
                userName: currentUser?.profile?.name,
                userRole: currentUserRole,
                sessionStarted: new Date().toISOString(),
              },
            });
            console.log(LOG, "vapi.start resolved");
            if (btnLabel) btnLabel.textContent = "Start Voice Assistant";
          } catch (e) {
            const isNetworkError =
              e?.message === "Failed to fetch" ||
              e?.name === "TypeError" ||
              (e?.message && String(e.message).toLowerCase().includes("fetch"));
            console.error(LOG, "start error", e);
            showConnectionError(isNetworkError);
            if (btnLabel) btnLabel.textContent = "Retry";
          }
        });
      }

      if (stopBtn) {
        stopBtn.addEventListener("click", () => {
          console.log(LOG, "stop button clicked", { isCallActive });
          if (vapi && isCallActive) vapi.stop();
        });
      }

      initVapi();
      console.log(LOG, "DOMContentLoaded setup complete");
    });
  })();
</script>
