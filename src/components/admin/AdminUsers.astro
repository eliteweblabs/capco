---
/**
 * AdminUsers Component
 * User management panel - accordion table with inline profile editing
 */
import Alert from "../partials/Alert.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import StaffCreationForm from "../form/StaffCreationForm.astro";
import AccordionDataTable from "../common/AccordionDataTable.astro";
import ProfileTabForm from "../profile/ProfileTabForm.astro";
import AdminUserRowActions from "./AdminUserRowActions.astro";

export interface Props {
  currentUser: any;
  supabase: any;
  globalInputClasses?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
}

const {
  currentUser,
  supabase,
  globalInputClasses = "",
  primaryTextClasses = "",
  secondaryTextClasses = "",
} = Astro.props;

// Fetch all users for the admin panel
let users: any[] = [];
let error = null;

try {
  if (supabase) {
    const { data: allProfiles, error: profilesError } = await supabase
      .from("profiles")
      .select("id, firstName, lastName, companyName, phone, role, email, createdAt, displayOrder")
      .order("displayOrder", { ascending: true, nullsFirst: false })
      .order("createdAt", { ascending: false });

    if (profilesError) {
      console.error("Error fetching profiles:", profilesError);
      error = profilesError.message;
    } else if (allProfiles) {
      users = allProfiles.map((profile: any) => ({
        ...profile,
        email: profile.email || "No email found",
        phone: profile.phone || null,
      }));
    }
  }
} catch (fetchError) {
  console.error("Error in users fetch:", fetchError);
  error = "Failed to fetch users";
}

const userCounts = {
  Admin: users.filter((u) => u.role === "Admin").length,
  Staff: users.filter((u) => u.role === "Staff").length,
  Client: users.filter((u) => u.role === "Client").length,
  Total: users.length,
};
---

<div class="admin-users-component px-4 pt-4">
  <div class="mb-8">
    <h1 class="mb-2 text-3xl font-bold">User Management</h1>
    <p class="text-gray-800 dark:text-gray-200">Create, view, and manage all system users</p>
  </div>

  <div class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div
      class="color-background rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="users" class="h-8 w-8 text-primary-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">
            Total Users: {userCounts.Total}
          </dt>
        </div>
      </div>
    </div>
    <div
      class="color-background rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="shield-check" class="h-8 w-8 text-red-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Admins: {userCounts.Admin}</dt>
        </div>
      </div>
    </div>
    <div
      class="color-background rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user-check" class="h-8 w-8 text-green-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Staff:{userCounts.Staff}</dt>
        </div>
      </div>
    </div>
    <div
      class="color-background rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user" class="h-8 w-8 text-purple-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">
            Clients: {userCounts.Client}
          </dt>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
    <div class="lg:col-span-2">
      <div
        class="color-background rounded-lg bg-gray-100 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
      >
        <div class="border-border-light dark:border-border-dark border-b p-6">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div class="relative flex-1">
              <SimpleIcon
                name="search"
                class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"
              />
              <input
                type="text"
                id="user-search"
                placeholder="Search by name or email..."
                class={`${globalInputClasses} w-full pl-10 pr-4`}
              />
            </div>
            <select
              id="role-filter"
              class="border-border-light dark:border-border-dark color-background rounded-lg border px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:text-white dark:focus:border-primary-400"
            >
              <option value="">All Roles</option>
              <option value="Admin">Admin</option>
              <option value="Staff">Staff</option>
              <option value="Client">Client</option>
            </select>
          </div>
        </div>

        <div class="overflow-hidden">
          <AccordionDataTable
            id="admin-users-accordion"
            title=""
            data={users}
            getItemId={(u) => u.id}
            getReorderId={(u) => u.id}
            slotIdPrefix="user-slot"
            draggable={true}
            reorderCallback="handleUsersReorder"
            emptyMessage={error
              ? `Error: ${error}`
              : "No users found. Create one in the panel to the right."}
            columns={[
              {
                key: "name",
                label: "Name",
                getValue: (u) => {
                  const fullName = `${u.firstName || ""} ${u.lastName || ""}`.trim();
                  return fullName || u.companyName || "Unknown User";
                },
                cellClass: "whitespace-nowrap",
              },
              { key: "email", label: "Email", cellClass: "whitespace-nowrap" },
              {
                key: "role",
                label: "Role",
                getValue: (u) => u.role,
                cellClass: "whitespace-nowrap",
              },
              {
                key: "createdAt",
                label: "Created",
                getValue: (u) => (u.createdAt ? new Date(u.createdAt).toLocaleDateString() : "â€”"),
                cellClass: "whitespace-nowrap text-gray-500 dark:text-gray-400",
              },
            ]}
            getTriggerDataAttrs={(u) => {
              const fullName = ((u.firstName || "") + " " + (u.lastName || "")).trim();
              const displayName = fullName || u.companyName || "unknown";
              return {
                role: u.role,
                name: displayName.toLowerCase(),
                email: (u.email || "").toLowerCase(),
                userId: u.id,
              };
            }}
            actionsComponent={AdminUserRowActions}
            actionsGetProps={(u) => ({ user: u })}
          />
        </div>
      </div>
    </div>

    <div class="lg:col-span-1">
      <Alert
        type="info"
        title="Account Setup"
        class="mb-4"
        description="<ol class='list-inside list-decimal space-y-1 text-xs'><li>An invitation email will be sent</li><li>User can set up authentication</li><li>User will appear in the list immediately</li></ol>"
      />
      <StaffCreationForm {globalInputClasses} {secondaryTextClasses} {primaryTextClasses} />
    </div>
  </div>
</div>

<!-- Profile form pool: single form moved into accordion slot on expand (on-demand load) -->
<div id="admin-profile-form-pool" class="hidden">
  <div id="admin-profile-form-container">
    <div class="p-5">
      <ProfileTabForm
        userProfile={null}
        currentUser={currentUser}
        globalInputClasses={globalInputClasses}
        formIdPrefix="admin-"
        isAdminEdit={true}
        showSettingsTab={false}
        showSignOut={false}
        switchHandlerName="adminSwitchProfileTab"
      />
    </div>
  </div>
</div>

<script define:vars={{ basePath: "/admin/users" }}>
  document.addEventListener("DOMContentLoaded", initAdminUsers);

  function initAdminUsers() {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    if (searchInput) searchInput.value = "";
    if (roleFilter) roleFilter.value = "";

    setupSearchFilter();
    setupAccordionFormPool();
    if (typeof window.handleUserDeleted !== "function") {
      window.handleUserDeleted = handleUserDeleted;
    }
    if (typeof window.handleUsersReorder !== "function") {
      window.handleUsersReorder = handleUsersReorder;
    }
  }

  async function handleUsersReorder(order) {
    try {
      const res = await fetch("/api/users/reorder", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ orders: order }),
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update order");
      }
      window.showSuccess?.("Order Updated", "User order saved.", 2000);
    } catch (err) {
      console.error("Users reorder failed:", err);
      window.showError?.("Save Failed", "Failed to save order. Reloading...", 3000);
      setTimeout(() => window.location.reload(), 1000);
    }
  }

  function setupSearchFilter() {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    const filter = () => filterUserRows();
    searchInput?.addEventListener("input", filter);
    roleFilter?.addEventListener("change", filter);
    setTimeout(filter, 100);
  }

  function filterUserRows() {
    const searchInput = document.getElementById("user-search");
    const roleEl = document.getElementById("role-filter");
    const searchTerm = (searchInput?.value?.toLowerCase() || "").trim();
    const roleVal = roleEl?.value || "";
    document.querySelectorAll("tr.accordion-trigger[data-user-id]").forEach((trigger) => {
      const el = trigger;
      const name = (el.dataset.name || "").toLowerCase();
      const email = (el.dataset.email || "").toLowerCase();
      const role = el.dataset.role || "";
      const matchSearch = !searchTerm || name.includes(searchTerm) || email.includes(searchTerm);
      const matchRole = !roleVal || role === roleVal;
      const show = matchSearch && matchRole;
      el.style.display = show ? "" : "none";
      const slotId = el.dataset.slot;
      const detail = document.querySelector(`tr.accordion-detail[data-slot="${slotId}"]`);
      if (detail) detail.style.display = show ? "" : "none";
    });
  }

  let openSlotId = null;
  const formPool = document.getElementById("admin-profile-form-pool");
  const formContainer = document.getElementById("admin-profile-form-container");
  const tableId = "admin-users-accordion";
  const slotPrefix = "user-slot";

  function setupAccordionFormPool() {
    if (!formContainer || !formPool) return;
    const form = document.getElementById("admin-profile-form");
    if (!form) return;

    // Tab switching for admin form
    window.adminSwitchProfileTab = (tab) => {
      ["general", "social", "team"].forEach((id) => {
        const el = document.getElementById(`admin-${id}`);
        if (el) el.classList.toggle("hidden", id !== tab);
      });
    };

    document.querySelectorAll(`#${tableId}-tbody tr.accordion-trigger`).forEach((triggerRow) => {
      triggerRow.addEventListener("click", async (e) => {
        if (e.target?.closest?.(".delete-confirm-btn, .delete-confirm-wrapper")) return;
        const slotId = triggerRow.dataset.slot;
        if (!slotId) return;
        const slotEl = document.getElementById(`${slotPrefix}-${slotId}`);
        if (!slotEl) return;

        if (openSlotId === slotId) {
          closeEditor();
          return;
        }

        closeEditor();
        slotEl.appendChild(formContainer);
        const detailRow = document.getElementById(`${tableId}-detail-${slotId}`);
        const chevron = triggerRow.querySelector(".accordion-chevron");
        if (detailRow) {
          detailRow.classList.remove("hidden");
          detailRow.setAttribute("aria-hidden", "false");
        }
        if (chevron) chevron.classList.add("rotate-180");
        triggerRow.setAttribute("aria-expanded", "true");
        openSlotId = slotId;

        const targetUserId = slotId;
        const targetInput = document.getElementById("admin-target-user-id");
        if (targetInput && targetInput instanceof HTMLInputElement)
          targetInput.value = targetUserId;
        try {
          const res = await fetch(`/api/users/get?id=${targetUserId}`);
          const json = await res.json();
          const profile = json?.data;
          if (profile) populateAdminForm(profile);
        } catch (err) {
          console.error("Failed to load user:", err);
          if (window.showNotice)
            window.showNotice("error", "Load Failed", "Could not load user data", 4000);
        }
        detailRow?.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });
    });

    function closeEditor() {
      if (!openSlotId) return;
      const detailRow = document.getElementById(`${tableId}-detail-${openSlotId}`);
      const triggerRow = document.querySelector(`tr.accordion-trigger[data-slot="${openSlotId}"]`);
      if (detailRow) {
        detailRow.classList.add("hidden");
        detailRow.setAttribute("aria-hidden", "true");
      }
      if (triggerRow) {
        triggerRow.setAttribute("aria-expanded", "false");
        const chevron = triggerRow.querySelector(".accordion-chevron");
        if (chevron) chevron.classList.remove("rotate-180");
      }
      if (formContainer && formPool) formPool.appendChild(formContainer);
      openSlotId = null;
    }

    function populateAdminForm(profile) {
      const set = (id, value) => {
        const el = document.getElementById(`admin-${id}`);
        if (
          !el ||
          !(
            el instanceof HTMLInputElement ||
            el instanceof HTMLSelectElement ||
            el instanceof HTMLTextAreaElement
          )
        )
          return;
        el.value = value ?? "";
      };
      const setCheckbox = (id, checked) => {
        const el = document.getElementById(`admin-${id}`);
        if (el && el instanceof HTMLInputElement) el.checked = !!checked;
      };
      set("company-name", profile.companyName);
      set("first-name", profile.firstName);
      set("last-name", profile.lastName);
      set("title", profile.title);
      set("email", profile.email);
      set("phone", profile.phone);
      set("bio", profile.bio);
      set("role-select", profile.role);
      setCheckbox("sms-alerts-phone", profile.smsAlerts);
      const socialInput = document.getElementById("admin-profile-socials-hidden");
      if (socialInput && socialInput instanceof HTMLInputElement) {
        socialInput.value = JSON.stringify(profile.socialNetworks || []);
      }
      const avatarImg = document.getElementById("admin-profile-avatar");
      if (avatarImg && avatarImg instanceof HTMLImageElement) {
        avatarImg.src = profile.avatarUrl || "";
        avatarImg.style.display = profile.avatarUrl ? "" : "none";
        const fallback = document.getElementById("admin-profile-avatar-fallback");
        if (fallback) fallback.style.display = profile.avatarUrl ? "none" : "flex";
      }
    }

    form?.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formEl = form;
      if (!formEl.checkValidity()) {
        formEl.reportValidity();
        return;
      }
      const targetInput = document.getElementById("admin-target-user-id");
      const targetUserId =
        targetInput instanceof HTMLInputElement ? targetInput.value?.trim() : null;
      if (!targetUserId) {
        window.showNotice?.("error", "No user selected", "Expand a user row first.", 4000);
        return;
      }
      const formData = new FormData(formEl);
      const companyName = formData.get("company-name");
      const firstName = formData.get("firstName");
      const lastName = formData.get("lastName");
      const title = formData.get("title");
      const phone = formData.get("phone");
      const bio = formData.get("bio");
      const roleEl = document.getElementById("admin-role-select");
      const smsEl = document.getElementById("admin-sms-alerts-phone");
      const role = roleEl?.value;
      const smsAlerts = smsEl?.checked || false;
      const mobileCarrier = formData.get("mobileCarrier");
      let socialNetworks = [];
      try {
        const raw = formData.get("socialNetworks");
        if (raw && typeof raw === "string") socialNetworks = JSON.parse(raw);
      } catch {
        /* ignore invalid JSON */
      }
      if (!Array.isArray(socialNetworks)) socialNetworks = [];
      const saveBtns = formEl.querySelectorAll(".save-profile-btn");
      saveBtns.forEach((b) => {
        b.disabled = true;
        b.textContent = "Saving...";
      });
      try {
        const res = await fetch("/api/users/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            targetUserId,
            companyName,
            firstName,
            lastName,
            title: title?.toString().trim() || null,
            phone,
            bio: bio?.toString().trim() || null,
            role,
            smsAlerts,
            mobileCarrier: smsAlerts ? mobileCarrier : null,
            socialNetworks,
          }),
        });
        const result = await res.json();
        if (res.ok) {
          window.showNotice?.("success", "Profile Updated", "User profile saved.", 2500);
          const userRes = await fetch(`/api/users/get?id=${targetUserId}`);
          const userJson = await userRes.json();
          if (userJson?.data) populateAdminForm(userJson.data);
        } else {
          window.showNotice?.("error", "Update Failed", result?.error || "Failed to save.", 5000);
        }
      } catch (err) {
        console.error("Profile update error:", err);
        window.showNotice?.("error", "Network Error", "Failed to update. Try again.", 5000);
      } finally {
        saveBtns.forEach((b) => {
          b.disabled = false;
          b.textContent = "Save Changes";
        });
      }
    });
  }

  async function handleUserDeleted(userId) {
    window.showNotice?.("success", "User Deleted", "User has been deleted.", 3000);
    const trigger = document.querySelector(`tr.accordion-trigger[data-user-id="${userId}"]`);
    const slotId = trigger?.dataset?.slot;
    if (trigger) trigger.remove();
    if (slotId) {
      const detail = document.querySelector(`tr.accordion-detail[data-slot="${slotId}"]`);
      if (detail) detail.remove();
    }
    setTimeout(() => window.location.reload(), 1500);
  }
</script>
