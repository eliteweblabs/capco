---
/**
 * AdminUsers Component
 * User management panel - clickable user list with profile form in side panel
 */
import Alert from "../partials/Alert.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import ProfileTabForm from "../profile/ProfileTabForm.astro";
import AdminUserRowActions from "./AdminUserRowActions.astro";

export interface Props {
  currentUser: any;
  supabase: any;
  globalInputClasses?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
}

const {
  currentUser,
  supabase,
  globalInputClasses = "",
  primaryTextClasses = "",
  secondaryTextClasses = "",
} = Astro.props;

// Fetch all users for the admin panel
let users: any[] = [];
let error = null;

try {
  if (supabase) {
    const { data: allProfiles, error: profilesError } = await supabase
      .from("profiles")
      .select("id, firstName, lastName, companyName, phone, role, email, createdAt, displayOrder")
      .order("displayOrder", { ascending: true, nullsFirst: false })
      .order("createdAt", { ascending: false });

    if (profilesError) {
      console.error("Error fetching profiles:", profilesError);
      error = profilesError.message;
    } else if (allProfiles) {
      users = allProfiles.map((profile: any) => ({
        ...profile,
        email: profile.email || "No email found",
        phone: profile.phone || null,
      }));
    }
  }
} catch (fetchError) {
  console.error("Error in users fetch:", fetchError);
  error = "Failed to fetch users";
}

const userCounts = {
  Admin: users.filter((u) => u.role === "Admin").length,
  Staff: users.filter((u) => u.role === "Staff").length,
  Client: users.filter((u) => u.role === "Client").length,
  Total: users.length,
};
---

<div class="admin-users-component px-4 pt-4">
  <div class="mb-8">
    <h1 class="mb-2 text-3xl font-bold">User Management</h1>
    <p class="text-gray-800 dark:text-gray-200">Create, view, and manage all system users</p>
  </div>

  <div class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div
      class="color-background rounded-lg bg-gray-100 p-4 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="users" class="h-8 w-8 text-primary-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">
            Total: {userCounts.Total}
          </dt>
        </div>
      </div>
    </div>
    <div
      class="color-background rounded-lg bg-gray-100 p-4 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="shield-check" class="h-8 w-8 text-red-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Admins: {userCounts.Admin}</dt>
        </div>
      </div>
    </div>
    <div
      class="color-background rounded-lg bg-gray-100 p-4 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user-check" class="h-8 w-8 text-green-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Staff:{userCounts.Staff}</dt>
        </div>
      </div>
    </div>
    <div
      class="color-background rounded-lg bg-gray-100 p-4 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user" class="h-8 w-8 text-purple-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">
            Clients: {userCounts.Client}
          </dt>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
    <div id="admin-users-list" class="lg:col-span-2">
      <div
        class="color-background rounded-lg bg-gray-100 shadow-sm ring-1 ring-gray-200 dark:ring-gray-700"
      >
        <div class="border-border-light dark:border-border-dark border-b p-6">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div class="relative flex-1">
              <SimpleIcon
                name="search"
                class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"
              />
              <input
                type="text"
                id="user-search"
                placeholder="Search by name or email..."
                class={`${globalInputClasses} w-full pl-10 pr-4`}
              />
            </div>
            <select
              id="role-filter"
              class="border-border-light dark:border-border-dark color-background rounded-lg border px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 dark:text-white dark:focus:border-primary-400"
            >
              <option value="">All Roles</option>
              <option value="Admin">Admin</option>
              <option value="Staff">Staff</option>
              <option value="Client">Client</option>
            </select>
          </div>
        </div>

        <div class="overflow-hidden">
          <div
            class="accordion-data-table overflow-hidden rounded-lg bg-white shadow dark:bg-gray-900"
          >
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead class="bg-gray-50 dark:bg-gray-900">
                  <tr>
                    <th
                      class="w-12 px-2 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400"
                    >
                      <SimpleIcon name="drag-handle-y" class="h-4 w-4" />
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400"
                    >
                      Name
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400"
                    >
                      Email
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400"
                    >
                      Role
                    </th>
                    <th
                      class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400"
                    >
                      Created
                    </th>
                    <th
                      class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-500 dark:text-gray-400"
                    >
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody
                  id="admin-users-tbody"
                  class="divide-y divide-gray-200 bg-white dark:divide-gray-700 dark:bg-gray-900"
                >
                  {
                    users.length === 0 ? (
                      <tr>
                        <td
                          colspan="6"
                          class="px-6 py-8 text-center text-sm text-gray-500 dark:text-gray-400"
                        >
                          {error
                            ? `Error: ${error}`
                            : "No users found. Create one in the panel to the right."}
                        </td>
                      </tr>
                    ) : (
                      users.map((u) => {
                        const fullName = `${u.firstName || ""} ${u.lastName || ""}`.trim();
                        const displayName = fullName || u.companyName || "Unknown User";
                        return (
                          <tr
                            class="accordion-trigger user-row cursor-pointer border-b border-gray-200 transition-colors hover:bg-gray-50 dark:border-gray-700 dark:hover:bg-gray-700"
                            data-item-id={u.id}
                            data-reorder-id={u.id}
                            data-user-id={u.id}
                            data-name={(displayName || "unknown").toLowerCase()}
                            data-email={(u.email || "").toLowerCase()}
                            data-role={u.role || ""}
                            role="button"
                            tabindex="0"
                            draggable
                          >
                            <td class="w-12 cursor-grab px-2 py-3 text-center text-gray-400 active:cursor-grabbing dark:text-gray-500">
                              <SimpleIcon name="drag-handle-y" class="mx-auto h-5 w-5" />
                            </td>
                            <td class="whitespace-nowrap px-6 py-3 text-sm text-gray-900 dark:text-white">
                              {displayName}
                            </td>
                            <td class="whitespace-nowrap px-6 py-3 text-sm text-gray-900 dark:text-white">
                              {u.email}
                            </td>
                            <td class="whitespace-nowrap px-6 py-3 text-sm text-gray-900 dark:text-white">
                              {u.role}
                            </td>
                            <td class="whitespace-nowrap px-6 py-3 text-sm text-gray-500 dark:text-gray-400">
                              {u.createdAt ? new Date(u.createdAt).toLocaleDateString() : "â€”"}
                            </td>
                            <td class="whitespace-nowrap px-6 py-3 text-right">
                              <AdminUserRowActions user={u} />
                            </td>
                          </tr>
                        );
                      })
                    )
                  }
                </tbody>
              </table>
            </div>
          </div>
          <div
            data-accordion-reorder-init
            data-table-id="admin-users"
            data-trigger-class="accordion-trigger"
            data-detail-class="accordion-detail"
            data-reorder-callback="handleUsersReorder"
            hidden
          >
          </div>
        </div>
      </div>
    </div>

    <div id="user-form-panel" class="lg:col-span-1">
      <Alert
        type="info"
        title="Account Setup"
        class="mb-4"
        description="<ol class='list-inside list-decimal space-y-1 text-xs'><li>An invitation email will be sent</li><li>User can set up authentication</li><li>User will appear in the list immediately</li></ol>"
      />
      <div class="mb-3 flex items-center justify-between">
        <h3 id="user-form-title" class="text-lg font-semibold text-gray-900 dark:text-white">
          Create User
        </h3>
        <button
          type="button"
          id="admin-new-user-btn"
          class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300"
        >
          + New User
        </button>
      </div>
      <div class="color-background rounded-lg bg-gray-50 p-4 dark:bg-gray-800">
        <ProfileTabForm
          userProfile={null}
          currentUser={currentUser}
          globalInputClasses={globalInputClasses}
          formIdPrefix="admin-"
          isAdminEdit={true}
          showSettingsTab={false}
          showSignOut={false}
          switchHandlerName="adminSwitchProfileTab"
          generalOnly={true}
          includeAllModes={true}
        />
      </div>
    </div>
  </div>
</div>

<script>
  import "../../scripts/accordion-reorder-init";
</script>
<script define:vars={{ basePath: "/admin/users", formIdPrefix: "admin-" }}>
  let selectedUserId = null;

  async function handleUsersReorder(order) {
    try {
      const res = await fetch("/api/users/reorder", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ orders: order }),
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update order");
      }
      window.showSuccess?.("Order Updated", "User order saved.", 2000);
    } catch (err) {
      console.error("Users reorder failed:", err);
      window.showError?.("Save Failed", "Failed to save order. Reloading...", 3000);
      setTimeout(() => window.location.reload(), 1000);
    }
  }

  window.handleUsersReorder = handleUsersReorder;

  document.addEventListener("DOMContentLoaded", initAdminUsers);

  function initAdminUsers() {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    if (searchInput) searchInput.value = "";
    if (roleFilter) roleFilter.value = "";

    setupSearchFilter();
    setupUserRowClicks();
    setupNewUserButton();
    setupAdminFormSubmit();
    setCreateMode();
    if (typeof window.handleUserDeleted !== "function") {
      window.handleUserDeleted = handleUserDeleted;
    }
  }

  function setupSearchFilter() {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    const filter = () => filterUserRows();
    searchInput?.addEventListener("input", filter);
    roleFilter?.addEventListener("change", filter);
    setTimeout(filter, 100);
  }

  function filterUserRows() {
    const searchInput = document.getElementById("user-search");
    const roleEl = document.getElementById("role-filter");
    const searchTerm = (searchInput?.value?.toLowerCase() || "").trim();
    const roleVal = roleEl?.value || "";
    document.querySelectorAll("tr.user-row[data-user-id]").forEach((row) => {
      const name = (row.dataset.name || "").toLowerCase();
      const email = (row.dataset.email || "").toLowerCase();
      const role = row.dataset.role || "";
      const matchSearch = !searchTerm || name.includes(searchTerm) || email.includes(searchTerm);
      const matchRole = !roleVal || role === roleVal;
      row.style.display = matchSearch && matchRole ? "" : "none";
    });
  }

  function setCreateMode() {
    selectedUserId = null;
    document.getElementById("admin-users-list")?.classList.remove("max-md:hidden");
    document
      .querySelectorAll("tr.user-row")
      .forEach((r) => r.classList.remove("ring-2", "ring-primary-500"));
    document.querySelectorAll("[data-create-only]").forEach((el) => el.classList.remove("hidden"));
    document.querySelectorAll("[data-update-only]").forEach((el) => el.classList.add("hidden"));
    const title = document.getElementById("user-form-title");
    if (title) title.textContent = "Create User";
    const targetInput = document.getElementById("admin-target-user-id");
    if (targetInput && targetInput instanceof HTMLInputElement) targetInput.value = "";
    document.querySelectorAll(".save-profile-btn").forEach((b) => (b.textContent = "Create User"));
    const form = document.getElementById("admin-profile-form");
    if (form && form instanceof HTMLFormElement) form.reset();
    const emailInput = document.getElementById("admin-email");
    if (emailInput && emailInput instanceof HTMLInputElement) emailInput.removeAttribute("readonly");
    const roleSelect = document.getElementById("admin-role-select");
    if (roleSelect && roleSelect instanceof HTMLSelectElement) roleSelect.value = "Staff";
  }

  function setUpdateMode(userId) {
    selectedUserId = userId;
    document.getElementById("admin-users-list")?.classList.add("max-md:hidden");
    document.querySelectorAll("[data-create-only]").forEach((el) => el.classList.add("hidden"));
    document.querySelectorAll("[data-update-only]").forEach((el) => el.classList.remove("hidden"));
    const title = document.getElementById("user-form-title");
    if (title) title.textContent = "Update User";
    const targetInput = document.getElementById("admin-target-user-id");
    if (targetInput && targetInput instanceof HTMLInputElement) targetInput.value = userId;
    document.querySelectorAll(".save-profile-btn").forEach((b) => (b.textContent = "Update User"));
    const emailInput = document.getElementById("admin-email");
    if (emailInput && emailInput instanceof HTMLInputElement) emailInput.setAttribute("readonly", "");
  }

  function setupUserRowClicks() {
    window.adminSwitchProfileTab = (tab) => {
      ["general", "social", "team"].forEach((id) => {
        const el = document.getElementById(`admin-${id}`);
        if (el) el.classList.toggle("hidden", id !== tab);
      });
    };

    document.querySelectorAll("tr.user-row[data-user-id]").forEach((row) => {
      row.addEventListener("click", async (e) => {
        if (e.target?.closest?.(".delete-confirm-btn, .delete-confirm-wrapper")) return;
        const userId = row.dataset.userId;
        if (!userId) return;

        setUpdateMode(userId);
        document.querySelectorAll("tr.user-row").forEach((r) => {
          r.classList.toggle("ring-2 ring-primary-500", r.dataset.userId === userId);
        });

        try {
          const res = await fetch(`/api/users/get?id=${userId}`);
          const json = await res.json();
          const profile = json?.data;
          if (profile) populateAdminForm(profile);
          document.querySelectorAll(".save-profile-btn").forEach((b) => {
            b.textContent = "Update User";
          });
        } catch (err) {
          console.error("Failed to load user:", err);
          if (window.showNotice)
            window.showNotice("error", "Load Failed", "Could not load user data", 4000);
        }

        document
          .getElementById("user-form-panel")
          ?.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });
    });
  }

  function setupNewUserButton() {
    document.getElementById("admin-new-user-btn")?.addEventListener("click", setCreateMode);
  }

  function populateAdminForm(profile) {
    const set = (id, value) => {
      const el = document.getElementById(`admin-${id}`);
      if (
        !el ||
        !(
          el instanceof HTMLInputElement ||
          el instanceof HTMLSelectElement ||
          el instanceof HTMLTextAreaElement
        )
      )
        return;
      el.value = value ?? "";
    };
    const setCheckbox = (id, checked) => {
      const el = document.getElementById(`admin-${id}`);
      if (el && el instanceof HTMLInputElement) el.checked = !!checked;
    };
    set("companyName", profile.companyName);
    set("firstName", profile.firstName);
    set("lastName", profile.lastName);
    set("title", profile.title);
    set("email", profile.email);
    set("phone", profile.phone);
    set("bio", profile.bio);
    set("role-select", profile.role);
    const smsCheckboxId = `sms-alerts-${formIdPrefix}phone`;
    const smsCheckbox = document.getElementById(smsCheckboxId);
    if (smsCheckbox && smsCheckbox instanceof HTMLInputElement) smsCheckbox.checked = !!profile.smsAlerts;
    const socialInput = document.getElementById("admin-profile-socials-hidden");
    if (socialInput && socialInput instanceof HTMLInputElement) {
      socialInput.value = JSON.stringify(profile.socialNetworks || []);
    }
    const avatarImg = document.getElementById("admin-profile-avatar");
    if (avatarImg && avatarImg instanceof HTMLImageElement) {
      avatarImg.src = profile.avatarUrl || "";
      avatarImg.style.display = profile.avatarUrl ? "" : "none";
      const fallback = document.getElementById("admin-profile-avatar-fallback");
      if (fallback) fallback.style.display = profile.avatarUrl ? "none" : "flex";
    }
  }

  function setupAdminFormSubmit() {
    const form = document.getElementById("admin-profile-form");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formEl = form;
      if (!formEl.checkValidity()) {
        formEl.reportValidity();
        return;
      }
      const targetInput = document.getElementById("admin-target-user-id");
      const targetUserId =
        targetInput instanceof HTMLInputElement ? targetInput.value?.trim() : null;
      const formData = new FormData(formEl);

      if (!targetUserId) {
        // Create mode: call upsert
        const roleEl = document.getElementById("admin-role-select");
        const smsEl = document.getElementById(`sms-alerts-${formIdPrefix}phone`);
        const role = roleEl?.value || "Staff";
        const smsAlerts = smsEl?.checked || false;
        const mobileCarrier = formData.get("mobileCarrier")?.toString()?.trim() || undefined;
        const passwordValue = formData.get("password")?.toString()?.trim();
        const userData = {
          email: formData.get("email"),
          role,
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          companyName: formData.get("companyName") || undefined,
          phone: formData.get("phone") || undefined,
          smsAlerts,
          mobileCarrier: smsAlerts ? mobileCarrier : undefined,
        };
        if (passwordValue) userData.password = passwordValue;
        if (!userData.companyName) {
          userData.companyName = `${userData.firstName} ${userData.lastName}`;
        }
        const saveBtns = formEl.querySelectorAll(".save-profile-btn");
        saveBtns.forEach((b) => {
          b.textContent = "Creating...";
          b.disabled = true;
        });
        try {
          const res = await fetch("/api/users/upsert", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData),
          });
          const result = await res.json();
          if (res.ok) {
            window.showNotice?.("success", "User Created", "User has been created.", 2500);
            setCreateMode();
            setTimeout(() => window.location.reload(), 1500);
          } else {
            window.showNotice?.(
              "error",
              "Creation Failed",
              result?.error || result?.details || "Failed to create user.",
              5000
            );
          }
        } catch (err) {
          console.error("Create user error:", err);
          window.showNotice?.("error", "Network Error", "Failed to create. Try again.", 5000);
        } finally {
          saveBtns.forEach((b) => {
            b.disabled = false;
            b.textContent = "Create User";
          });
        }
        return;
      }

      // Update mode: call update
      const companyName = formData.get("companyName");
      const firstName = formData.get("firstName");
      const lastName = formData.get("lastName");
      const title = formData.get("title");
      const phone = formData.get("phone");
      const bio = formData.get("bio");
      const roleEl = document.getElementById("admin-role-select");
      const smsEl = document.getElementById(`sms-alerts-${formIdPrefix}phone`);
      const role = roleEl?.value;
      const smsAlerts = smsEl?.checked || false;
      const mobileCarrier = formData.get("mobileCarrier");
      let socialNetworks = [];
      try {
        const raw = formData.get("socialNetworks");
        if (raw && typeof raw === "string") socialNetworks = JSON.parse(raw);
      } catch {
        /* ignore invalid JSON */
      }
      if (!Array.isArray(socialNetworks)) socialNetworks = [];
      const saveBtns = formEl.querySelectorAll(".save-profile-btn");
      saveBtns.forEach((b) => {
        b.disabled = true;
        b.textContent = "Saving...";
      });
      try {
        const res = await fetch("/api/users/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            targetUserId,
            companyName,
            firstName,
            lastName,
            title: title?.toString().trim() || null,
            phone,
            bio: bio?.toString().trim() || null,
            role,
            smsAlerts,
            mobileCarrier: smsAlerts ? mobileCarrier : null,
            socialNetworks,
          }),
        });
        const result = await res.json();
        if (res.ok) {
          window.showNotice?.("success", "Profile Updated", "User profile saved.", 2500);
          const userRes = await fetch(`/api/users/get?id=${targetUserId}`);
          const userJson = await userRes.json();
          if (userJson?.data) populateAdminForm(userJson.data);
        } else {
          window.showNotice?.("error", "Update Failed", result?.error || "Failed to save.", 5000);
        }
      } catch (err) {
        console.error("Profile update error:", err);
        window.showNotice?.("error", "Network Error", "Failed to update. Try again.", 5000);
      } finally {
        saveBtns.forEach((b) => {
          b.disabled = false;
          b.textContent = "Update User";
        });
      }
    });
  }

  async function handleUserDeleted(userId) {
    window.showNotice?.("success", "User Deleted", "User has been deleted.", 3000);
    if (selectedUserId === userId) {
      setCreateMode();
    }
    const row = document.querySelector(`tr.user-row[data-user-id="${userId}"]`);
    if (row) row.remove();
    setTimeout(() => window.location.reload(), 1500);
  }
</script>
