---
/**
 * AdminUsers Component
 * User management panel - can be embedded in any page
 */
import Alert from "../partials/Alert.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import Button from "../common/Button.astro";
import StaffCreationForm from "../form/StaffCreationForm.astro";

export interface Props {
  currentUser: any;
  supabase: any;
  globalInputClasses?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
}

const {
  currentUser,
  supabase,
  globalInputClasses = "",
  primaryTextClasses = "",
  secondaryTextClasses = "",
} = Astro.props;

// Fetch all users for the admin panel
let users: any[] = [];
let error = null;

try {
  if (supabase) {
    // First get all profiles
    const { data: allProfiles, error: profilesError } = await supabase
      .from("profiles")
      .select("id, firstName, lastName, companyName, phone, role, email, createdAt")
      .order("createdAt", { ascending: false });

    if (profilesError) {
      console.error("Error fetching profiles:", profilesError);
      error = profilesError.message;
    } else if (allProfiles) {
      const profilesWithEmails = allProfiles.map((profile: any) => {
        return {
          ...profile,
          email: profile.email || "No email found",
          phone: profile.phone || null,
        };
      });

      users = profilesWithEmails;
    }
  }
} catch (fetchError) {
  console.error("Error in users fetch:", fetchError);
  error = "Failed to fetch users";
}

// Get user counts by role
const userCounts = {
  Admin: users.filter((u) => u.role === "Admin").length,
  Staff: users.filter((u) => u.role === "Staff").length,
  Client: users.filter((u) => u.role === "Client").length,
  Total: users.length,
};
---

<div class="admin-users-component px-4 pt-4">
  <!-- Page Header -->
  <div class="mb-8">
    <h1 class="mb-2 text-3xl font-bold">User Management</h1>
    <p class="text-gray-800 dark:text-gray-200">Create, view, and manage all system users</p>
  </div>

  <!-- User Statistics Cards -->
  <div class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div
      class="rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 color-background dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="users" class="h-8 w-8 text-primary-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Total Users</dt>
          <dd class="text-2xl font-semibold text-gray-900 dark:text-white">
            {userCounts.Total}
          </dd>
        </div>
      </div>
    </div>

    <div
      class="rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 color-background dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="shield-check" class="h-8 w-8 text-red-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Admins</dt>
          <dd class="text-2xl font-semibold text-gray-900 dark:text-white">
            {userCounts.Admin}
          </dd>
        </div>
      </div>
    </div>

    <div
      class="rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 color-background dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user-check" class="h-8 w-8 text-green-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Staff</dt>
          <dd class="text-2xl font-semibold text-gray-900 dark:text-white">
            {userCounts.Staff}
          </dd>
        </div>
      </div>
    </div>

    <div
      class="rounded-lg bg-gray-100 p-6 shadow-sm ring-1 ring-gray-200 color-background dark:ring-gray-700"
    >
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user" class="h-8 w-8 text-purple-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Clients</dt>
          <dd class="text-2xl font-semibold text-gray-900 dark:text-white">
            {userCounts.Client}
          </dd>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
    <!-- User List (Left Side - 2 columns) -->
    <div class="lg:col-span-2">
      <div
        class="rounded-lg bg-gray-100 shadow-sm ring-1 ring-gray-200 color-background dark:ring-gray-700"
      >
        <!-- Header with Search and Filters -->
        <div class="border-border-light dark:border-border-dark border-b p-6">
          <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex items-center gap-4">
              <h2 class="text-lg font-semibold text-gray-900 dark:text-white">All Users</h2>
            </div>

            <div class="relative">
              <SimpleIcon
                name="search"
                class="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400"
              />
              <input
                type="text"
                id="user-search"
                placeholder="Search by name or email..."
                class={`${globalInputClasses} pl-10 pr-4`}
              />
            </div>
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
              <!-- Search -->

              <!-- Role Filter -->
              <select
                id="role-filter"
                class="border-border-light dark:border-border-dark rounded-lg border px-3 py-2 text-sm focus:border-primary-500 focus:outline-none focus:ring-1 focus:ring-primary-500 color-background dark:text-white dark:focus:border-primary-400"
              >
                <option value="">All Roles</option>
                <option value="Admin">Admin</option>
                <option value="Staff">Staff</option>
                <option value="Client">Client</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="overflow-hidden">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead
                class="bg-gray-50 text-xs uppercase text-gray-700 dark:bg-gray-700 dark:text-gray-400"
              >
                <tr>
                  <th
                    class="text-muted dark:text-muted dark:hover:text-primary-dark cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-primary"
                    data-sort="name"
                  >
                    <div class="flex items-center gap-1">
                      Name
                      <SimpleIcon name="chevrons-up-down" class="h-3 w-3" />
                    </div>
                  </th>
                  <th
                    class="text-muted dark:text-muted dark:hover:text-primary-dark cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-primary"
                    data-sort="email"
                  >
                    <div class="flex items-center gap-1">
                      Email
                      <SimpleIcon name="chevrons-up-down" class="h-3 w-3" />
                    </div>
                  </th>
                  <th
                    class="text-muted dark:text-muted dark:hover:text-primary-dark cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-primary"
                    data-sort="role"
                  >
                    <div class="flex items-center gap-1">
                      Role
                      <SimpleIcon name="chevrons-up-down" class="h-3 w-3" />
                    </div>
                  </th>
                  <th
                    class="text-muted dark:text-muted dark:hover:text-primary-dark cursor-pointer px-6 py-3 text-left text-xs font-medium uppercase tracking-wider hover:text-primary"
                    data-sort="created"
                  >
                    <div class="flex items-center gap-1">
                      Created
                      <SimpleIcon name="chevrons-up-down" class="h-3 w-3" />
                    </div>
                  </th>
                  <th
                    class="text-muted dark:text-muted px-6 py-3 text-right text-xs font-medium uppercase tracking-wider"
                  >
                    Actions
                  </th>
                </tr>
              </thead>
              <tbody
                id="users-table-body"
                class="divide-y divide-gray-200 bg-gray-100 dark:divide-gray-700 color-background"
              >
                {
                  users.map((user) => {
                    const fullName = `${user.firstName || ""} ${user.lastName || ""}`.trim();
                    const displayName = fullName || user.companyName || "Unknown User";
                    const createdDate = new Date(user.createdAt).toLocaleDateString();

                    return (
                      <tr
                        class="user-row hover:bg-gray-50 dark:hover:bg-gray-700"
                        data-role={user.role}
                        data-name={displayName.toLowerCase()}
                        data-email={user.email.toLowerCase()}
                      >
                        <td class="whitespace-nowrap px-6 py-4">
                          <div class="flex items-center">
                            <div class="flex-shrink-0">
                              <div
                                class={`flex h-10 w-10 items-center justify-center rounded-lg ${
                                  user.role === "Admin"
                                    ? "bg-red-100 dark:bg-red-900/30"
                                    : user.role === "Staff"
                                      ? "bg-green-100 dark:bg-green-900/30"
                                      : "bg-purple-100 dark:bg-purple-900/30"
                                }`}
                              >
                                <SimpleIcon
                                  name={
                                    user.role === "Admin"
                                      ? "shield-check"
                                      : user.role === "Staff"
                                        ? "user-check"
                                        : "user"
                                  }
                                  class={`h-5 w-5 ${
                                    user.role === "Admin"
                                      ? "text-red-600 dark:text-red-400"
                                      : user.role === "Staff"
                                        ? "text-green-600 dark:text-green-400"
                                        : "text-purple-600 dark:text-purple-400"
                                  }`}
                                />
                              </div>
                            </div>
                            <div class="ml-4">
                              <div class="text-sm font-medium text-gray-900 dark:text-white">
                                {displayName}
                              </div>
                              {user.phone && (
                                <div class="text-muted dark:text-muted text-sm">{user.phone}</div>
                              )}
                            </div>
                          </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4">
                          <div class="text-sm text-gray-900 dark:text-white">{user.email}</div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4">
                          <span
                            class={`inline-flex rounded-lg px-2 py-1 text-xs font-semibold ${
                              user.role === "Admin"
                                ? "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"
                                : user.role === "Staff"
                                  ? "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400"
                                  : "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400"
                            }`}
                          >
                            {user.role}
                          </span>
                        </td>
                        <td class="text-muted dark:text-muted whitespace-nowrap px-6 py-4 text-sm">
                          {createdDate}
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                          <Button
                            variant="ghost"
                            size="sm"
                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300 delete-user-btn"
                            data-user-id={user.id}
                            data-user-name={displayName}
                            title="Delete user"
                            icon="trash"
                          />
                        </td>
                      </tr>
                    );
                  })
                }
              </tbody>
            </table>

            {
              users.length === 0 && (
                <div class="py-12 text-center">
                  <SimpleIcon name="users" class="mx-auto h-12 w-12 text-gray-400" />
                  <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">
                    No users found
                  </h3>
                  <p class="text-muted dark:text-muted mt-1 text-sm">
                    {error ? `Error: ${error}` : "Get started by creating a new user."}
                  </p>
                </div>
              )
            }
          </div>
        </div>
      </div>
    </div>

    <!-- Create User Form (Right Side - 1 column) -->
    <div class="lg:col-span-1">
      <!-- Header -->
      <Alert
        type="info"
        title="Account Setup"
        class="mb-4"
        description="<ol class='list-inside list-decimal space-y-1 text-xs'><li>An invitation email will be sent</li><li>User can set up authentication</li><li>User will appear in the list immediately</li></ol>"
      />

      <StaffCreationForm {globalInputClasses} {secondaryTextClasses} {primaryTextClasses} />
    </div>
  </div>
</div>

<script>
  // User management functionality
  interface User {
    element: Element;
    name: string;
    email: string;
    role: string;
    created: string;
  }

  let currentUsers: User[] = [];
  let currentSort = { field: "created", direction: "desc" };
  let deleteUserId: string | null = null;

  document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    if (searchInput) (searchInput as HTMLInputElement).value = "";
    if (roleFilter) (roleFilter as HTMLSelectElement).value = "";

    initializeUserManagement();
  });

  function initializeUserManagement() {
    currentUsers = Array.from(document.querySelectorAll(".user-row")).map((row) => ({
      element: row,
      name: (row as HTMLElement).dataset.name || "",
      email: (row as HTMLElement).dataset.email || "",
      role: (row as HTMLElement).dataset.role || "",
      created: (row as HTMLElement).querySelector("td:nth-child(4)")?.textContent?.trim() || "",
    }));

    setupSearchAndFilter();
    setupSorting();
    setupDeleteHandlers();

    setTimeout(() => {
      filterUsers();
    }, 100);
  }

  function setupSearchAndFilter() {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");

    if (searchInput) {
      searchInput.addEventListener("input", filterUsers as EventListener);
    }

    if (roleFilter) {
      roleFilter.addEventListener("change", filterUsers as EventListener);
    }
  }

  function setupSorting() {
    const sortHeaders = document.querySelectorAll("[data-sort]");
    sortHeaders.forEach((header) => {
      header.addEventListener("click", () => {
        const field = (header as HTMLElement).dataset.sort;
        if (currentSort.field === field) {
          currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
        } else {
          currentSort.field = field as keyof typeof currentSort;
          currentSort.direction = "asc";
        }
        sortUsers();
      });
    });
  }

  function setupDeleteHandlers() {
    document.querySelectorAll(".delete-user-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        const userId = (btn as HTMLElement).dataset.userId;
        const userName = (btn as HTMLElement).dataset.userName;
        if (userId && userName) {
          confirmDeleteUser(userId, userName);
        }
      });
    });
  }

  function filterUsers() {
    const searchTerm =
      ((
        document.getElementById("user-search") as HTMLInputElement
      )?.value?.toLowerCase() as string) || "";
    const roleFilter =
      ((document.getElementById("role-filter") as HTMLSelectElement)?.value as string) || "";

    currentUsers.forEach((user) => {
      const matchesSearch =
        !searchTerm || user.name.includes(searchTerm) || user.email.includes(searchTerm);
      const matchesRole = !roleFilter || user.role === roleFilter;
      const shouldShow = matchesSearch && matchesRole;

      if (shouldShow) {
        (user.element as HTMLElement).style.display = "";
      } else {
        (user.element as HTMLElement).style.display = "none";
      }
    });
  }

  function sortUsers() {
    const tbody = document.getElementById("users-table-body") as HTMLTableSectionElement;
    if (!tbody) return;

    const sortedUsers = [...currentUsers].sort((a, b) => {
      let aVal: any, bVal: any;

      switch (currentSort.field) {
        case "name":
          aVal = a.name;
          bVal = b.name;
          break;
        case "email":
          aVal = a.email;
          bVal = b.email;
          break;
        case "role":
          aVal = a.role;
          bVal = b.role;
          break;
        case "created":
          aVal = new Date(a.created);
          bVal = new Date(b.created);
          break;
        default:
          return 0;
      }

      if (aVal < bVal) return currentSort.direction === "asc" ? -1 : 1;
      if (aVal > bVal) return currentSort.direction === "asc" ? 1 : -1;
      return 0;
    });

    sortedUsers.forEach((user) => {
      tbody.appendChild(user.element);
    });
  }

  function confirmDeleteUser(userId: string, userName: string) {
    deleteUserId = userId;

    if ((window as any).showNotice) {
      (window as any).showNotice(
        "error",
        "Delete User",
        `Are you sure you want to delete ${userName}? This action cannot be undone.`,
        6000000,
        [
          {
            label: "Cancel",
            variant: "secondary",
            fullWidth: true,
            action: () => {
              deleteUserId = null;
            },
          },
          {
            label: "Delete User",
            variant: "danger",
            fullWidth: true,
            action: () => {
              executeDeleteUser();
            },
          },
        ]
      );
    } else {
      if (confirm(`Are you sure you want to delete ${userName}? This action cannot be undone.`)) {
        executeDeleteUser();
      }
    }
  }

  async function executeDeleteUser() {
    if (!deleteUserId) return;

    try {
      const response = await fetch("/api/users/delete", {
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: deleteUserId }),
        method: "DELETE",
      });

      if (response.ok) {
        if ((window as any).showNotice) {
          (window as any).showNotice(
            "success",
            "User Deleted",
            "User has been successfully deleted.",
            3000
          );
        }

        const userRow = document
          .querySelector(`[data-user-id="${deleteUserId}"]`)
          ?.closest(".user-row");
        if (userRow) {
          userRow.remove();
        }

        setTimeout(() => window.location.reload(), 1500);
      } else {
        const errorData = await response.json();
        throw new Error(errorData.error || "Failed to delete user");
      }
    } catch (error) {
      console.error("Delete user error:", error);
      if ((window as any).showNotice) {
        (window as any).showNotice(
          "error",
          "Delete Failed",
          (error as Error).message || "Failed to delete user",
          5000
        );
      }
    } finally {
      deleteUserId = null;
    }
  }
</script>
