---
/**
 * AdminUsers Component
 * User management panel - clickable user list with profile form in side panel
 */
import Alert from "../partials/Alert.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import ProfileTabForm from "../profile/ProfileTabForm.astro";
import AdminUserRowActions from "./AdminUserRowActions.astro";
import AccordionDataTable from "../common/AccordionDataTable.astro";
import SearchInput from "../form/SearchInput.astro";
import { globalClasses } from "../../pages/api/global/global-classes";

export interface Props {
  currentUser: any;
  supabase: any;
  globalInputClasses?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
}

const gc = globalClasses();
const {
  currentUser,
  supabase,
  globalInputClasses = gc.globalInputClasses,
  primaryTextClasses = gc.primaryTextClasses,
  secondaryTextClasses = gc.secondaryTextClasses,
} = Astro.props;
const { globalAdminContainerClasses } = gc;

// Fetch all users for the admin panel
let users: any[] = [];
let error = null;

try {
  if (supabase) {
    const { data: allProfiles, error: profilesError } = await supabase
      .from("profiles")
      .select("id, firstName, lastName, companyName, phone, role, email, createdAt, displayOrder")
      .order("displayOrder", { ascending: true, nullsFirst: false })
      .order("createdAt", { ascending: false });

    if (profilesError) {
      console.error("Error fetching profiles:", profilesError);
      error = profilesError.message;
    } else if (allProfiles) {
      users = allProfiles.map((profile: any) => ({
        ...profile,
        email: profile.email || "No email found",
        phone: profile.phone || null,
      }));
    }
  }
} catch (fetchError) {
  console.error("Error in users fetch:", fetchError);
  error = "Failed to fetch users";
}

const userCounts = {
  Admin: users.filter((u) => u.role === "Admin").length,
  Staff: users.filter((u) => u.role === "Staff").length,
  Client: users.filter((u) => u.role === "Client").length,
  Total: users.length,
};
---

<div class="admin-users-component px-4 pt-4">
  <style>
    #admin-users-tbody tr[role="button"] {
      overflow: visible !important;
    }
  </style>
  <div class="mb-8">
    <h1 class={`mb-2 text-3xl font-bold ${primaryTextClasses}`}>User Management</h1>
    <p class={secondaryTextClasses}>Create, view, and manage all system users</p>
  </div>

  <div class="mb-8 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
    <div class={`${globalAdminContainerClasses} p-4`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="users" class="h-8 w-8 text-primary-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">
            Total: {userCounts.Total}
          </dt>
        </div>
      </div>
    </div>
    <div class={`${globalAdminContainerClasses} p-4`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="shield-check" class="h-8 w-8 text-red-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Admins: {userCounts.Admin}</dt>
        </div>
      </div>
    </div>
    <div class={`${globalAdminContainerClasses} p-4`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user-check" class="h-8 w-8 text-green-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">Staff:{userCounts.Staff}</dt>
        </div>
      </div>
    </div>
    <div class={`${globalAdminContainerClasses} p-4`}>
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="user" class="h-8 w-8 text-purple-600" />
        </div>
        <div class="ml-4">
          <dt class="text-muted dark:text-muted text-sm font-medium">
            Clients: {userCounts.Client}
          </dt>
        </div>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 gap-8 sm:grid-cols-2 md:grid-cols-3">
    <div id="admin-users-list" class="sm:col-span-2 md:col-span-2 lg:col-span-2">
      <div class={globalAdminContainerClasses}>
        <div class="flex flex-col gap-4 p-6 sm:flex-row sm:items-center sm:justify-between">
          <div class="flex-1">
            <SearchInput
              id="user-search"
              placeholder="Search by name, email, or company..."
              globalInputClasses={globalInputClasses}
            />
          </div>
          <select id="role-filter" class={`${globalInputClasses} w-auto min-w-[140px]`}>
            <option value="">All Roles</option>
            <option value="Admin">Admin</option>
            <option value="Staff">Staff</option>
            <option value="Client">Client</option>
          </select>
        </div>

        <div class="overflow-hidden overflow-x-auto">
          <AccordionDataTable
            id="admin-users"
            data={users}
            getItemId={(u) => u.id}
            getReorderId={(u) => u.id}
            draggable={true}
            reorderCallback="handleUsersReorder"
            slotIdPrefix="user-slot"
            triggerClass="accordion-trigger user-row"
            emptyMessage={error
              ? `Error: ${error}`
              : "No users found. Create one in the panel to the right."}
            getTriggerDataAttrs={(u) => {
              const fullName = `${u.firstName || ""} ${u.lastName || ""}`.trim();
              const displayName = fullName || u.companyName || "Unknown User";
              return {
                userId: u.id,
                name: (displayName || "unknown").toLowerCase(),
                email: (u.email || "").toLowerCase(),
                role: u.role || "",
                company: (u.companyName || "").toLowerCase(),
              };
            }}
            columns={[
              {
                key: "displayName",
                label: "Name",
                getValue: (u) => {
                  const fn = `${u.firstName || ""} ${u.lastName || ""}`.trim();
                  return fn || u.companyName || "Unknown User";
                },
                cellClass: "whitespace-nowrap",
                width: 20,
                getCellDataAttrs: (u) => ({
                  refresh: "displayName",
                  userId: u.id,
                  metaValue:
                    [u.firstName, u.lastName].filter(Boolean).join(" ") || u.companyName || "",
                }),
              },
              {
                key: "email",
                label: "Email",
                getValue: (u) => u.email || "",
                cellClass: "whitespace-nowrap",
                width: 31,
                getCellDataAttrs: (u) => ({
                  refresh: "email",
                  userId: u.id,
                  metaValue: u.email || "",
                }),
              },
              {
                key: "role",
                label: "Role",
                getValue: (u) => u.role || "",
                cellClass: "whitespace-nowrap",
                width: 14,
                getCellDataAttrs: (u) => ({
                  refresh: "role",
                  userId: u.id,
                  metaValue: u.role || "",
                }),
              },
              {
                key: "companyName",
                label: "Company",
                getValue: (u) => u.companyName || "—",
                cellClass: "whitespace-nowrap",
                width: 20,
                getCellDataAttrs: (u) => ({
                  refresh: "companyName",
                  userId: u.id,
                  metaValue: u.companyName || "",
                }),
              },
              {
                key: "createdAt",
                label: "Created",
                getValue: (u) => (u.createdAt ? new Date(u.createdAt).toLocaleDateString() : "—"),
                cellClass: "whitespace-nowrap text-gray-500 dark:text-gray-400",
                width: 15,
              },
            ]}
            actionsComponent={AdminUserRowActions}
            actionsGetProps={(u) => ({ user: u })}
          />
        </div>
      </div>
    </div>

    <div id="user-form-panel" class="sm:col-span-1 md:col-span-1 lg:col-span-1">
      <Alert
        type="info"
        title="Account Setup"
        class="mb-4"
        description="<ol class='list-inside list-decimal space-y-1 text-xs'><li>An invitation email will be sent</li><li>User can set up authentication</li><li>User will appear in the list immediately</li></ol>"
      />
      <div class="mb-3 flex items-center justify-between">
        <h3 id="user-form-title" class={`text-lg font-semibold ${primaryTextClasses}`}>
          Create User
        </h3>
        <button
          type="button"
          id="admin-new-user-btn"
          class="text-sm text-primary-600 hover:text-primary-700 dark:text-primary-400 dark:hover:text-primary-300"
        >
          + New User
        </button>
      </div>
      <div class={`${globalAdminContainerClasses} p-4`}>
        <ProfileTabForm
          userProfile={null}
          globalInputClasses={globalInputClasses}
          formIdPrefix="admin-"
          isAdminEdit={true}
          showSettingsTab={false}
          showSignOut={false}
          switchHandlerName="adminSwitchProfileTab"
          generalOnly={true}
          includeAllModes={true}
        />
      </div>
    </div>
  </div>
</div>

<script define:vars={{ basePath: "/admin/users", formIdPrefix: "admin-" }}>
  let selectedUserId = null;

  async function handleUsersReorder(order) {
    try {
      const res = await fetch("/api/users/reorder", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ orders: order }),
      });
      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.error || "Failed to update order");
      }
      window.showSuccess?.("Order Updated", "User order saved.", 2000);
    } catch (err) {
      console.error("Users reorder failed:", err);
      window.showError?.("Save Failed", "Failed to save order. Reloading...", 3000);
      setTimeout(() => window.location.reload(), 1000);
    }
  }

  window.handleUsersReorder = handleUsersReorder;

  document.addEventListener("DOMContentLoaded", initAdminUsers);

  function initAdminUsers() {
    // Start refresh manager for polling name, email, role
    if (
      window.refreshManager &&
      document.querySelectorAll("[data-refresh][data-user-id]").length > 0
    ) {
      window.refreshManager.startAutoRefreshWithInterval?.(5);
    }
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    if (searchInput) searchInput.value = "";
    if (roleFilter) roleFilter.value = "";

    setupSearchFilter();
    setupUserRowClicks();
    setupNewUserButton();
    setupAdminFormSubmit();
    setupAdminAvatarUpload();
    setCreateMode();
    if (typeof window.handleUserDeleted !== "function") {
      window.handleUserDeleted = handleUserDeleted;
    }
  }

  function setupSearchFilter() {
    const searchInput = document.getElementById("user-search");
    const roleFilter = document.getElementById("role-filter");
    const filter = () => filterUserRows();
    searchInput?.addEventListener("input", filter);
    roleFilter?.addEventListener("change", filter);
    setTimeout(filter, 100);
  }

  function filterUserRows() {
    const searchInput = document.getElementById("user-search");
    const roleEl = document.getElementById("role-filter");
    const searchTerm = (searchInput?.value?.toLowerCase() || "").trim();
    const roleVal = roleEl?.value || "";
    document.querySelectorAll("tr.user-row[data-user-id]").forEach((row) => {
      const name = (row.dataset.name || "").toLowerCase();
      const email = (row.dataset.email || "").toLowerCase();
      const company = (row.dataset.company || "").toLowerCase();
      const role = row.dataset.role || "";
      const matchSearch =
        !searchTerm ||
        name.includes(searchTerm) ||
        email.includes(searchTerm) ||
        company.includes(searchTerm);
      const matchRole = !roleVal || role === roleVal;
      row.style.display = matchSearch && matchRole ? "" : "none";
    });
  }

  function setCreateMode() {
    selectedUserId = null;
    document.getElementById("admin-users-list")?.classList.remove("max-md:hidden");
    document
      .querySelectorAll("tr.user-row")
      .forEach((r) => r.classList.remove("ring-2", "ring-primary-500"));
    document.querySelectorAll("[data-create-only]").forEach((el) => el.classList.remove("hidden"));
    document.querySelectorAll("[data-update-only]").forEach((el) => el.classList.add("hidden"));
    const title = document.getElementById("user-form-title");
    if (title) title.textContent = "Create User";
    const targetInput = document.getElementById("admin-target-user-id");
    if (targetInput && targetInput instanceof HTMLInputElement) targetInput.value = "";
    document.querySelectorAll(".save-profile-btn").forEach((b) => (b.textContent = "Create User"));
    const form = document.getElementById("admin-profile-form");
    if (form && form instanceof HTMLFormElement) form.reset();
    const emailInput = document.getElementById("admin-email");
    if (emailInput && emailInput instanceof HTMLInputElement)
      emailInput.removeAttribute("readonly");
    const roleSelect = document.getElementById("admin-role-select");
    if (roleSelect && roleSelect instanceof HTMLSelectElement) roleSelect.value = "Staff";
  }

  function setUpdateMode(userId) {
    selectedUserId = userId;
    document.getElementById("admin-users-list")?.classList.add("max-md:hidden");
    document.querySelectorAll("[data-create-only]").forEach((el) => el.classList.add("hidden"));
    document.querySelectorAll("[data-update-only]").forEach((el) => el.classList.remove("hidden"));
    const title = document.getElementById("user-form-title");
    if (title) title.textContent = "Update User";
    const targetInput = document.getElementById("admin-target-user-id");
    if (targetInput && targetInput instanceof HTMLInputElement) targetInput.value = userId;
    document.querySelectorAll(".save-profile-btn").forEach((b) => (b.textContent = "Update User"));
    const emailInput = document.getElementById("admin-email");
    if (emailInput && emailInput instanceof HTMLInputElement)
      emailInput.setAttribute("readonly", "");
  }

  function setupUserRowClicks() {
    window.adminSwitchProfileTab = (tab) => {
      ["general", "social", "team"].forEach((id) => {
        const el = document.getElementById(`admin-${id}`);
        if (el) el.classList.toggle("hidden", id !== tab);
      });
    };

    document.querySelectorAll("tr.user-row[data-user-id]").forEach((row) => {
      row.addEventListener("click", async (e) => {
        if (
          e.target?.closest?.(
            ".delete-confirm-btn, .delete-confirm-wrapper, .accordion-drag-handle"
          )
        )
          return;
        const userId = row.dataset.userId;
        if (!userId) return;

        setUpdateMode(userId);
        document.querySelectorAll("tr.user-row").forEach((r) => {
          const isSelected = r.dataset.userId === userId;
          r.classList.toggle("ring-2", isSelected);
          r.classList.toggle("ring-primary-500", isSelected);
        });

        try {
          const res = await fetch(`/api/users/get?id=${userId}`);
          const json = await res.json();
          const profile = json?.data;
          if (profile) populateAdminForm(profile);
          document.querySelectorAll(".save-profile-btn").forEach((b) => {
            b.textContent = "Update User";
          });
        } catch (err) {
          console.error("Failed to load user:", err);
          if (window.showNotice)
            window.showNotice("error", "Load Failed", "Could not load user data", 4000);
        }

        document
          .getElementById("user-form-panel")
          ?.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });
    });
  }

  function setupNewUserButton() {
    document.getElementById("admin-new-user-btn")?.addEventListener("click", setCreateMode);
  }

  function loadCropperjs() {
    if (window.Cropper?.default) return Promise.resolve(window.Cropper.default);
    const loadCss = () => {
      if (document.querySelector('link[href*="cropper.min.css"]')) return Promise.resolve();
      return new Promise((resolve) => {
        const link = document.createElement("link");
        link.rel = "stylesheet";
        link.href = "https://cdn.jsdelivr.net/npm/cropperjs@2.1.0/dist/cropper.min.css";
        link.onload = () => resolve();
        link.onerror = () => resolve();
        document.head.appendChild(link);
      });
    };
    return loadCss().then(
      () =>
        new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = "https://cdn.jsdelivr.net/npm/cropperjs@2.1.0/dist/cropper.min.js";
          script.async = true;
          script.onload = () => resolve(window.Cropper?.default || window.Cropper);
          script.onerror = () => reject(new Error("Failed to load Cropper.js"));
          document.head.appendChild(script);
        })
    );
  }

  function setupAdminAvatarUpload() {
    const prefix = "admin-";
    const uploadBtn = document.getElementById(`${prefix}upload-avatar-btn`);
    const avatarInput = document.getElementById(`${prefix}avatar-input`);
    const removeBtn = document.getElementById(`${prefix}remove-avatar-btn`);
    const profileAvatarImg = document.getElementById(`${prefix}profile-avatar`);
    const profileAvatarFallback = document.getElementById(`${prefix}profile-avatar-fallback`);
    const cropperBlock = document.getElementById(`${prefix}profile-avatar-cropper`);
    const cropperImg = document.getElementById(`${prefix}avatar-cropper-image`);
    const cropperContainer = document.getElementById(`${prefix}avatar-cropper-container`);
    let avatarCropperInstance = null;
    let avatarCropperPendingFile = null;

    const closeAvatarCropper = () => {
      if (avatarCropperInstance) {
        avatarCropperInstance.destroy();
        avatarCropperInstance = null;
      }
      avatarCropperPendingFile = null;
      cropperBlock?.classList.add("hidden");
      if (avatarInput) avatarInput.value = "";
    };

    document.querySelectorAll("[data-avatar-cropper-close]").forEach((btn) => {
      btn.addEventListener("click", closeAvatarCropper);
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && cropperBlock && !cropperBlock.classList.contains("hidden")) {
        closeAvatarCropper();
      }
    });

    uploadBtn?.addEventListener("click", () => avatarInput?.click());

    document
      .getElementById(`${prefix}avatar-cropper-apply`)
      ?.addEventListener("click", async () => {
        if (!avatarCropperInstance || !avatarCropperPendingFile) return;
        const targetInput = document.getElementById(`${prefix}target-user-id`);
        const targetUserId =
          targetInput instanceof HTMLInputElement ? targetInput.value?.trim() : null;
        if (!targetUserId) {
          window.showNotice?.(
            "error",
            "No user selected",
            "Select a user to update their photo.",
            4000
          );
          return;
        }
        const cropperSelection = avatarCropperInstance.getCropperSelection();
        if (!cropperSelection) return;
        try {
          const outputCanvas = await cropperSelection.$toCanvas({ width: 400, height: 400 });
          if (!outputCanvas) return;
          outputCanvas.toBlob(
            async (blob) => {
              if (!blob) return;
              const base64 = await new Promise((resolve, reject) => {
                const r = new FileReader();
                r.onload = () => resolve(r.result);
                r.onerror = reject;
                r.readAsDataURL(blob);
              });
              const fileName =
                avatarCropperPendingFile.name.replace(/[^a-zA-Z0-9.-]/g, "_") || "avatar";
              const mediaRes = await fetch("/api/media", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  mediaData: base64,
                  fileName,
                  fileType: blob.type || "image/jpeg",
                  targetLocation: "profiles",
                }),
              });
              const mediaJson = await mediaRes.json();
              if (!mediaRes.ok || !mediaJson?.file?.publicUrl) {
                throw new Error(mediaJson?.error || "Upload failed");
              }
              const updateRes = await fetch("/api/users/update", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  targetUserId,
                  avatarUrl: mediaJson.file.publicUrl,
                }),
              });
              const updateJson = await updateRes.json();
              if (!updateRes.ok) throw new Error(updateJson?.error || "Failed to update profile");
              if (profileAvatarImg) {
                profileAvatarImg.src = mediaJson.file.publicUrl;
                profileAvatarImg.style.display = "";
                if (profileAvatarFallback) profileAvatarFallback.style.display = "none";
              }
              if (removeBtn) removeBtn.style.display = "";
              window.showNotice?.("success", "Photo updated", "User photo has been updated.", 2500);
              closeAvatarCropper();
            },
            "image/jpeg",
            0.9
          );
        } catch (err) {
          console.error("Avatar crop/upload error:", err);
          window.showNotice?.(
            "error",
            "Upload failed",
            err instanceof Error ? err.message : "Failed to upload photo. Please try again.",
            5000
          );
        }
      });

    avatarInput?.addEventListener("change", async (e) => {
      const inputEl = e.target;
      const file = inputEl?.files?.[0];
      if (!file) return;
      const targetInput = document.getElementById(`${prefix}target-user-id`);
      const targetUserId =
        targetInput instanceof HTMLInputElement ? targetInput.value?.trim() : null;
      if (!targetUserId) {
        window.showNotice?.(
          "error",
          "Select user first",
          "Select a user to update before uploading a photo.",
          4000
        );
        if (inputEl) inputEl.value = "";
        return;
      }
      const maxSize = 5 * 1024 * 1024;
      if (file.size > maxSize) {
        window.showNotice?.("error", "File too large", "Please choose an image under 5MB.", 5000);
        if (inputEl) inputEl.value = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = async () => {
        const dataUrl = reader.result;
        if (typeof dataUrl !== "string" || !cropperBlock || !cropperImg || !cropperContainer)
          return;
        avatarCropperPendingFile = file;
        cropperImg.src = dataUrl;
        cropperImg.style.display = "block";
        cropperBlock.classList.remove("hidden");
        const Cropper = await loadCropperjs();
        avatarCropperInstance = new Cropper(cropperImg, {
          container: cropperContainer,
        });
        const sel = avatarCropperInstance.getCropperSelection();
        if (sel) {
          sel.aspectRatio = 1;
          sel.initialAspectRatio = 1;
          sel.initialCoverage = 0.8;
          sel.movable = true;
          sel.resizable = true;
        }
      };
      reader.readAsDataURL(file);
    });

    removeBtn?.addEventListener("click", async () => {
      const targetInput = document.getElementById(`${prefix}target-user-id`);
      const targetUserId =
        targetInput instanceof HTMLInputElement ? targetInput.value?.trim() : null;
      if (!targetUserId) return;
      try {
        const res = await fetch("/api/users/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ targetUserId, avatarUrl: null }),
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data?.error || "Failed to remove photo");
        if (profileAvatarImg) {
          profileAvatarImg.src = "";
          profileAvatarImg.style.display = "none";
        }
        if (profileAvatarFallback) profileAvatarFallback.style.display = "flex";
        if (removeBtn) removeBtn.style.display = "none";
        window.showNotice?.("success", "Photo removed", "User photo has been removed.", 2500);
      } catch (err) {
        console.error("Avatar remove error:", err);
        window.showNotice?.(
          "error",
          "Remove failed",
          err instanceof Error ? err.message : "Failed to remove photo.",
          5000
        );
      }
    });
  }

  function populateAdminForm(profile) {
    const set = (id, value) => {
      const el = document.getElementById(`admin-${id}`);
      if (
        !el ||
        !(
          el instanceof HTMLInputElement ||
          el instanceof HTMLSelectElement ||
          el instanceof HTMLTextAreaElement
        )
      )
        return;
      el.value = value ?? "";
    };
    const setCheckbox = (id, checked) => {
      const el = document.getElementById(`admin-${id}`);
      if (el && el instanceof HTMLInputElement) el.checked = !!checked;
    };
    set("companyName", profile.companyName);
    set("firstName", profile.firstName);
    set("lastName", profile.lastName);
    set("title", profile.title);
    set("email", profile.email);
    set("phone", profile.phone);
    set("bio", profile.bio);
    set("role-select", profile.role);
    const smsCheckboxId = `sms-alerts-${formIdPrefix}phone`;
    const smsCheckbox = document.getElementById(smsCheckboxId);
    if (smsCheckbox && smsCheckbox instanceof HTMLInputElement)
      smsCheckbox.checked = !!profile.smsAlerts;
    const socialInput = document.getElementById("admin-profile-socials-hidden");
    if (socialInput && socialInput instanceof HTMLInputElement) {
      socialInput.value = JSON.stringify(profile.socialNetworks || []);
    }
    const avatarImg = document.getElementById("admin-profile-avatar");
    if (avatarImg && avatarImg instanceof HTMLImageElement) {
      avatarImg.src = profile.avatarUrl || "";
      avatarImg.style.display = profile.avatarUrl ? "" : "none";
      const fallback = document.getElementById("admin-profile-avatar-fallback");
      if (fallback) fallback.style.display = profile.avatarUrl ? "none" : "flex";
    }
  }

  function setupAdminFormSubmit() {
    const form = document.getElementById("admin-profile-form");
    if (!form) return;

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formEl = form;
      if (!formEl.checkValidity()) {
        formEl.reportValidity();
        return;
      }
      const targetInput = document.getElementById("admin-target-user-id");
      const targetUserId =
        targetInput instanceof HTMLInputElement ? targetInput.value?.trim() : null;
      const formData = new FormData(formEl);

      if (!targetUserId) {
        // Create mode: call upsert
        const roleEl = document.getElementById("admin-role-select");
        const smsEl = document.getElementById(`sms-alerts-${formIdPrefix}phone`);
        const role = roleEl?.value || "Staff";
        const smsAlerts = smsEl?.checked || false;
        const mobileCarrier = formData.get("mobileCarrier")?.toString()?.trim() || undefined;
        const passwordValue = formData.get("password")?.toString()?.trim();
        const userData = {
          email: formData.get("email"),
          role,
          firstName: formData.get("firstName"),
          lastName: formData.get("lastName"),
          companyName: formData.get("companyName") || undefined,
          phone: formData.get("phone") || undefined,
          smsAlerts,
          mobileCarrier: smsAlerts ? mobileCarrier : undefined,
        };
        if (passwordValue) userData.password = passwordValue;
        if (!userData.companyName) {
          userData.companyName = `${userData.firstName} ${userData.lastName}`;
        }
        const saveBtns = formEl.querySelectorAll(".save-profile-btn");
        saveBtns.forEach((b) => {
          b.textContent = "Creating...";
          b.disabled = true;
        });
        try {
          const res = await fetch("/api/users/upsert", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData),
          });
          const result = await res.json();
          if (res.ok) {
            window.showNotice?.("success", "User Created", "User has been created.", 2500);
            setCreateMode();
            setTimeout(() => window.location.reload(), 1500);
          } else {
            window.showNotice?.(
              "error",
              "Creation Failed",
              result?.error || result?.details || "Failed to create user.",
              5000
            );
          }
        } catch (err) {
          console.error("Create user error:", err);
          window.showNotice?.("error", "Network Error", "Failed to create. Try again.", 5000);
        } finally {
          saveBtns.forEach((b) => {
            b.disabled = false;
            b.textContent = "Create User";
          });
        }
        return;
      }

      // Update mode: call update
      const companyName = formData.get("companyName");
      const firstName = formData.get("firstName");
      const lastName = formData.get("lastName");
      const title = formData.get("title");
      const phone = formData.get("phone");
      const bio = formData.get("bio");
      const roleEl = document.getElementById("admin-role-select");
      const smsEl = document.getElementById(`sms-alerts-${formIdPrefix}phone`);
      const role = roleEl?.value;
      const smsAlerts = smsEl?.checked || false;
      const mobileCarrier = formData.get("mobileCarrier");
      let socialNetworks = [];
      try {
        const raw = formData.get("socialNetworks");
        if (raw && typeof raw === "string") socialNetworks = JSON.parse(raw);
      } catch {
        /* ignore invalid JSON */
      }
      if (!Array.isArray(socialNetworks)) socialNetworks = [];
      const saveBtns = formEl.querySelectorAll(".save-profile-btn");
      saveBtns.forEach((b) => {
        b.disabled = true;
        b.textContent = "Saving...";
      });
      try {
        const res = await fetch("/api/users/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            targetUserId,
            companyName,
            firstName,
            lastName,
            title: title?.toString().trim() || null,
            phone,
            bio: bio?.toString().trim() || null,
            role,
            smsAlerts,
            mobileCarrier: smsAlerts ? mobileCarrier : null,
            socialNetworks,
          }),
        });
        const result = await res.json();
        if (res.ok) {
          window.showNotice?.("success", "Profile Updated", "User profile saved.", 2500);
          const userRes = await fetch(`/api/users/get?id=${targetUserId}`);
          const userJson = await userRes.json();
          if (userJson?.data) {
            const d = userJson.data;
            populateAdminForm(d);
            const fullName = `${d.firstName || ""} ${d.lastName || ""}`.trim();
            const displayName = fullName || d.companyName || "Unknown User";
            window.refreshManager?.updateFields(
              {
                displayName,
                email: d.email || "",
                role: d.role || "",
                companyName: d.companyName || "",
              },
              undefined,
              targetUserId
            );
          }
        } else {
          window.showNotice?.("error", "Update Failed", result?.error || "Failed to save.", 5000);
        }
      } catch (err) {
        console.error("Profile update error:", err);
        window.showNotice?.("error", "Network Error", "Failed to update. Try again.", 5000);
      } finally {
        saveBtns.forEach((b) => {
          b.disabled = false;
          b.textContent = "Update User";
        });
      }
    });
  }

  async function handleUserDeleted(userId) {
    window.showNotice?.("success", "User Deleted", "User has been deleted.", 3000);
    if (selectedUserId === userId) {
      setCreateMode();
    }
    const row = document.querySelector(`tr.user-row[data-user-id="${userId}"]`);
    if (row) row.remove();
  }
</script>
