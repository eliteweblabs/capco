---
/**
 * AdminGlobalActivity Component
 * Global activity feed panel - can be embedded in any page
 */
import Hero from "../common/Hero.astro";
import GlobalActivityFeed from "../common/GlobalActivityFeed.astro";
import SimpleIcon from "../common/SimpleIcon.astro";

export interface Props {
  currentUser: any;
  globalInputClasses?: string;
  primaryTextClasses?: string;
  secondaryTextClasses?: string;
  showHero?: boolean;
  limit?: number;
}

const {
  currentUser,
  globalInputClasses = "",
  primaryTextClasses = "",
  secondaryTextClasses = "",
  showHero = true,
  limit = 100,
} = Astro.props;

// Fetch projects for overview stats
let projects: any[] = [];
if (currentUser?.id) {
  try {
    const baseUrl = Astro.url.origin;
    const apiUrl = `${baseUrl}/api/get-project`;
    const response = await fetch(apiUrl, {
      headers: {
        Cookie: Astro.request.headers.get("cookie") || "",
      },
    });

    if (response.ok) {
      const data = await response.json();
      projects = data.projects || [];
    }
  } catch (error) {
    console.error("Error fetching projects:", error);
  }
}
---

<div class="admin-global-activity-component">
  {
    showHero && (
      <Hero
        title="Global Activity Feed"
        description="Monitor all project activities, status changes, and user actions across the platform."
        {primaryTextClasses}
        {secondaryTextClasses}
        {globalInputClasses}
      />
    )
  }

  <!-- Activity Overview Cards -->
  <div class="mb-8 grid grid-cols-1 gap-5 sm:grid-cols-2 lg:grid-cols-4">
    <!-- Total Projects -->
    <div class="rounded-lg bg-gray-100 p-6 shadow color-background">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="building" class="h-8 w-8 text-primary-600 dark:text-primary-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Projects</p>
          <p id="total-projects" class="text-lg font-semibold text-gray-900 dark:text-white">
            {projects.length}
          </p>
        </div>
      </div>
    </div>

    <!-- Active Projects -->
    <div class="rounded-lg bg-gray-100 p-6 shadow color-background">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="trending-up" class="h-8 w-8 text-green-600 dark:text-green-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Projects</p>
          <p id="active-projects" class="text-lg font-semibold text-gray-900 dark:text-white">
            {projects.filter((p) => p.status > 0 && p.status < 90).length}
          </p>
        </div>
      </div>
    </div>

    <!-- Recent Activity -->
    <div class="rounded-lg bg-gray-100 p-6 shadow color-background">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="clock" class="h-8 w-8 text-yellow-600 dark:text-yellow-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Last 24h</p>
          <p id="recent-activity" class="text-lg font-semibold text-gray-900 dark:text-white">
            <span class="inline-block h-4 w-8 animate-pulse rounded bg-gray-200 dark:bg-gray-700"
            ></span>
          </p>
        </div>
      </div>
    </div>

    <!-- Active Users -->
    <div class="rounded-lg bg-gray-100 p-6 shadow color-background">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <SimpleIcon name="users" class="h-8 w-8 text-purple-600 dark:text-purple-400" />
        </div>
        <div class="ml-3 w-0 flex-1">
          <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Active Users</p>
          <p id="active-users-header" class="text-lg font-semibold text-gray-900 dark:text-white">
            <span class="inline-block h-4 w-8 animate-pulse rounded bg-gray-200 dark:bg-gray-700"
            ></span>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Global Activity Feed Component -->
  <GlobalActivityFeed {limit} />
</div>

<script is:inline>
  // Update dynamic stats when the activity feed loads
  document.addEventListener("DOMContentLoaded", () => {
    // Wait for the global activity feed to load its stats
    setTimeout(() => {
      const recentCountEl = document.getElementById("recent-count");
      const activeUsersEl = document.getElementById("active-users");
      const headerRecentEl = document.getElementById("recent-activity");
      const headerActiveUsersEl = document.getElementById("active-users-header");

      if (recentCountEl && headerRecentEl && recentCountEl.textContent) {
        headerRecentEl.textContent = recentCountEl.textContent;
      }
      if (activeUsersEl && headerActiveUsersEl && activeUsersEl.textContent) {
        headerActiveUsersEl.textContent = activeUsersEl.textContent;
      }
    }, 2000); // Wait for global feed to load
  });
</script>
