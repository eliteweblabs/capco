---
// Reusable multi-step form component that renders from JSON configuration
import type { MultiStepFormConfig } from "../../lib/multi-step-form-config";
import { getButtonConfig } from "../../lib/multi-step-form-config";
import Button from "../common/Button.astro";
import SimpleIcon from "../common/SimpleIcon.astro";
import Tooltip from "../common/TooltipFloating.astro";
import SlotMachineModalStaff from "./SlotMachineModalStaff.astro";
import InlineAddressSearch from "./InlineAddressSearch.astro";
import SlideToggle from "../common/SlideToggle.astro";
import { SMS_UTILS } from "../../lib/sms-utils";
import { globalClasses } from "../../pages/api/global/global-classes";

interface Props {
  config: MultiStepFormConfig;
  containerClass?: string;
  initialData?: Record<string, any>;
}

const { config, containerClass = "", initialData = {} } = Astro.props;

const { globalInputClasses } = globalClasses();
const appendedGlobalInputClasses = `${globalInputClasses} text-center`;

// Get carrier options for mobile carrier component
const mobileCarrierOptions = SMS_UTILS.CARRIERS.map((carrier: any) => ({
  value: carrier.id,
  label: carrier.name,
}));
---

<div class={containerClass} style="overscroll-behavior-y: contain; touch-action: pan-x;">
  <!-- Advanced Stepper - Fixed to bottom -->
  {
    config.progressBar && (
      <div class="fixed bottom-0 left-0 right-0 z-40 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 py-4 px-4">
        <div class="max-w-4xl mx-auto">
          <ol class="flex items-center w-full" id={`${config.formId}-stepper`}>
            {config.steps.map((step, index) => (
              <li
                class={`relative flex items-center ${index < config.steps.length - 1 ? "w-full" : ""}`}
                data-step-indicator={step.stepNumber}
              >
                {/* Step Circle/Icon with Tooltip */}
                <Tooltip text={step.title} position="top" mobileClickable={true}>
                  <span
                    class="relative step-indicator flex items-center justify-center w-3 h-3 sm:w-4 sm:h-4 rounded-full shrink-0 transition-all duration-300 bg-gray-300 dark:bg-gray-700"
                    data-step-title={step.title}
                  />
                </Tooltip>

                {/* Connecting Line */}
                {index < config.steps.length - 1 && (
                  <div class="w-full h-1 mx-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                    <div
                      class="h-full bg-primary-500 dark:bg-primary-600 transition-all duration-500 ease-out step-progress-line"
                      style="width: 0%"
                    />
                  </div>
                )}
              </li>
            ))}
          </ol>
        </div>
      </div>
    )
  }

  <form
    id={config.formId}
    action={config.formAction}
    method={config.formMethod || "post"}
    class={config.progressBar ? "" : ""}
  >
    {
      config.steps.map((step) => (
        <div class="step-content" data-step={step.stepNumber}>
          <div class="space-y-12 sm:space-y-6 lg:space-y-8">
            {/* Step Header */}
            <div>
              {step.showIcon && step.icon && (
                <div class="mx-auto mb-4 flex h-16 w-16 sm:h-20 sm:w-20 items-center justify-center rounded-full bg-primary-100 dark:bg-primary-900/30">
                  <SimpleIcon
                    name={step.icon}
                    size="xl"
                    class="text-primary-600 dark:text-primary-400"
                  />
                </div>
              )}
              <h2
                class="text-xl sm:text-3xl lg:text-4xl font-bold text-gray-900 dark:text-white typewriter-text"
                data-text={step.title}
                set:html={step.title}
              />
              {step.subtitle && (
                <p class="mt-2 sm:mt-3 text-sm sm:text-base text-gray-600 dark:text-gray-400 max-w-md">
                  {step.subtitle}
                </p>
              )}
            </div>

            {/* Step Fields */}
            {step.isReview ? (
              // Review step - show summary
              <div class="space-y-4 rounded-lg border border-gray-200 p-8 dark:border-gray-700 color-background">
                {step.reviewFields?.map((fieldName) => (
                  <div class="flex items-start justify-between border-b border-gray-200 pb-2 dark:border-gray-700 last:border-b-0">
                    <div>
                      <p class="text-sm text-gray-600 dark:text-gray-400 capitalize">
                        {fieldName.replace(/([A-Z])/g, " $1").trim()}
                      </p>
                      <p
                        id={`review-${fieldName}`}
                        class="text-lg font-medium text-gray-900 dark:text-white"
                      >
                        {fieldName === "password" ? "••••••" : "-"}
                      </p>
                    </div>
                    <button
                      type="button"
                      class="edit-step text-sm font-medium text-primary-600 hover:text-primary-700 dark:text-primary-400"
                      data-edit={
                        config.steps.findIndex((s) => s.fields.some((f) => f.name === fieldName)) +
                        1
                      }
                    >
                      Edit
                    </button>
                  </div>
                ))}
              </div>
            ) : (
              <div
                class:list={[
                  step.fieldLayout === "grid"
                    ? "grid grid-cols-1 gap-6 md:grid-cols-2"
                    : "space-y-6",
                ]}
              >
                {step.fields.map((field) => (
                  <div class:list={["input-wrapper", field.columns === 1 ? "md:col-span-2" : ""]}>
                    {field.type === "component" && field.component === "SlotMachineModalStaff" ? (
                      <SlotMachineModalStaff
                        id={field.id}
                        name={field.name}
                        title={field.label || "Select an option"}
                        options={mobileCarrierOptions}
                        selectedValue=""
                        globalInputClasses={appendedGlobalInputClasses}
                        {...field.componentProps}
                      />
                    ) : field.type === "component" && field.component === "SlideToggle" ? (
                      <div class="flex items-center justify-center py-8">
                        <SlideToggle id={field.id} name={field.name} {...field.componentProps} />
                      </div>
                    ) : field.type === "component" && field.component === "InlineAddressSearch" ? (
                      <InlineAddressSearch
                        id={field.id}
                        name={field.name}
                        globalInputClasses={appendedGlobalInputClasses}
                        {...field.componentProps}
                      />
                    ) : field.type === "textarea" ? (
                      <textarea
                        id={field.id}
                        name={field.name}
                        placeholder={field.placeholder}
                        required={field.required}
                        rows={field.rows || 4}
                        autocomplete={field.autocomplete}
                        class={appendedGlobalInputClasses}
                        data-error={field.errorMessage}
                      />
                    ) : field.name === "firstName" || field.name === "lastName" ? (
                      <div class="relative">
                        <input
                          type={field.type as "text" | "email" | "tel" | "password" | "hidden"}
                          id={field.id}
                          name={field.name}
                          placeholder=""
                          required={field.required}
                          autocomplete={field.autocomplete}
                          minlength={field.minlength}
                          autofocus={field.autofocus}
                          class={appendedGlobalInputClasses}
                          data-error={field.errorMessage}
                          data-has-animated-placeholder="true"
                          data-original-placeholder={field.placeholder}
                        />
                        <span
                          class="animated-placeholder absolute left-0 top-0 flex items-center justify-center w-full h-full pointer-events-none text-gray-400 dark:text-gray-500"
                          data-for={field.id}
                        >
                          {field.placeholder}
                        </span>
                      </div>
                    ) : (
                      <input
                        type={field.type as "text" | "email" | "tel" | "password" | "hidden"}
                        id={field.id}
                        name={field.name}
                        placeholder={field.placeholder}
                        required={field.required}
                        autocomplete={field.autocomplete}
                        minlength={field.minlength}
                        autofocus={field.autofocus}
                        class={appendedGlobalInputClasses}
                        data-error={field.errorMessage}
                      />
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Google OAuth (for registration form only) */}
            {step.additionalContent === "google-oauth" && (
              <div class="mx-auto w-full my-6 md:my-8 lg:my-12">
                <div>
                  <hr class="mt-14 h-0 border-t border-zinc-300 dark:border-zinc-600" />
                  <p class="-mt-2.5 text-center text-xs mb-14">
                    <span class="px-4 color-background">Or</span>
                  </p>
                </div>

                <Button
                  variant="outline"
                  fullWidth
                  name="provider"
                  value="google"
                  onclick="handleGoogleSignup()"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    preserveAspectRatio="xMidYMid"
                    viewBox="0 0 256 262"
                    class="mr-2 inline-flex h-5 w-auto"
                  >
                    <path
                      fill="#4285F4"
                      d="M255.878 133.451c0-10.734-.871-18.567-2.756-26.69H130.55v48.448h71.947c-1.45 12.04-9.283 30.172-26.69 42.356l-.244 1.622 38.755 30.023 2.685.268c24.659-22.774 38.875-56.282 38.875-96.027"
                    />
                    <path
                      fill="#34A853"
                      d="M130.55 261.1c35.248 0 64.839-11.605 86.453-31.622l-41.196-31.913c-11.024 7.688-25.82 13.055-45.257 13.055-34.523 0-63.824-22.773-74.269-54.25l-1.531.13-40.298 31.187-.527 1.465C35.393 231.798 79.49 261.1 130.55 261.1"
                    />
                    <path
                      fill="#FBBC05"
                      d="M56.281 156.37c-2.756-8.123-4.351-16.827-4.351-25.82 0-8.994 1.595-17.697 4.206-25.82l-.073-1.73L15.26 71.312l-1.335.635C5.077 89.644 0 109.517 0 130.55s5.077 40.905 13.925 58.602l42.356-32.782"
                    />
                    <path
                      fill="#EB4335"
                      d="M130.55 50.479c24.514 0 41.05 10.589 50.479 19.438l36.844-35.974C195.245 12.91 165.798 0 130.55 0 79.49 0 35.393 29.301 13.925 71.947l42.211 32.783c10.59-31.477 39.891-54.251 74.414-54.251"
                    />
                  </svg>
                  Register with Google
                </Button>
              </div>
            )}

            {/* Step Buttons */}
            {/* Choice buttons (radio-style options) */}
            {step.buttons.some((b) => b.type === "choice") && (
              <div
                class={`flex ${step.buttons.some((b) => b.type === "choice" && b.classes?.includes("w-full")) ? "flex-col" : "justify-center flex-wrap"} gap-3 mb-6`}
              >
                {step.buttons
                  .filter((button) => button.type === "choice")
                  .map((button) => {
                    const btnConfig = getButtonConfig(
                      button,
                      config.buttonDefaults?.[button.type as keyof typeof config.buttonDefaults]
                    );

                    return (
                      <Button
                        type="button"
                        variant={button.variant || "secondary"}
                        size={button.size || "lg"}
                        class={`${button.type}-step sms-choice ${button.classes || ""}`}
                        disabled={button.disabled}
                        dataAttributes={{
                          ...(button.dataNext !== undefined && {
                            "data-next": button.dataNext.toString(),
                          }),
                          ...(button.dataValue !== undefined && { "data-value": button.dataValue }),
                          ...(button.dataValue !== undefined && {
                            "data-sms-value": button.dataValue,
                          }), // Keep for backward compatibility with SMS
                        }}
                      >
                        <Fragment set:html={button.label} />
                      </Button>
                    );
                  })}
              </div>
            )}

            {/* Navigation buttons (prev, next, submit, skip) */}
            <div
              class:list={[
                "flex gap-3",
                step.buttons.filter((b) => b.type !== "choice").length === 1
                  ? "justify-end"
                  : "justify-between",
              ]}
            >
              {step.buttons
                .filter((button) => button.type !== "choice")
                .map((button) => {
                  const btnConfig = getButtonConfig(
                    button,
                    config.buttonDefaults?.[button.type as keyof typeof config.buttonDefaults]
                  );

                  return button.href ? (
                    <Button
                      variant={btnConfig.variant}
                      size={btnConfig.size}
                      icon={btnConfig.icon}
                      iconPosition={btnConfig.iconPosition}
                      href={button.href}
                      class={`${button.type}-step ${button.classes || ""}`}
                      disabled={button.disabled}
                    >
                      <Fragment set:html={button.label} />
                    </Button>
                  ) : (
                    <Button
                      variant={btnConfig.variant}
                      size={btnConfig.size}
                      icon={btnConfig.icon}
                      iconPosition={btnConfig.iconPosition}
                      type="button"
                      class={`${button.type}-step ${button.classes || ""}`}
                      disabled={button.disabled}
                      dataAttributes={{
                        ...(button.dataNext !== undefined && {
                          "data-next": button.dataNext.toString(),
                        }),
                        ...(button.dataPrev !== undefined && {
                          "data-prev": button.dataPrev.toString(),
                        }),
                      }}
                    >
                      {button.label === "back" ? (
                        <span class="hidden sm:inline">
                          <Fragment set:html={button.label} />
                        </span>
                      ) : (
                        <span
                          id={
                            button.classes?.includes("phone")
                              ? `${config.formId}-next-step-phone-text`
                              : undefined
                          }
                        >
                          <Fragment set:html={button.label} />
                        </span>
                      )}
                    </Button>
                  );
                })}
            </div>
          </div>
        </div>
      ))
    }

    {/* Hidden Fields */}
    {
      config.hiddenFields?.map((field) => (
        <input type="hidden" name={field.name} value={field.value} />
      ))
    }
  </form>
</div>

<style>
  .step-content {
    display: none;
  }

  .step-content.active {
    display: block;
  }

  /* Step indicator states */
  .step-indicator {
    background-color: rgb(209 213 219); /* gray-300 */
  }

  .dark .step-indicator {
    background-color: rgb(55 65 81); /* gray-700 */
  }

  .step-indicator.active {
    background-color: var(--color-danger-500);
  }

  .dark .step-indicator.active {
    background-color: var(--color-danger-600);
  }

  .step-indicator.completed {
    background-color: var(--color-danger-500);
  }

  .dark .step-indicator.completed {
    background-color: var(--color-danger-600);
  }

  #multi-step-contact-form {
    width: 80dvw;
    max-width: 680px;
  }
</style>

<script define:vars={{ formId: config.formId, formConfig: config, initialData }}>
  // Store config in window for the module script to access
  window[`${formId}_config`] = {
    formId,
    formConfig,
    initialData,
  };
</script>

<script type="module">
  import { initializeMultiStepForm } from "/src/lib/multi-step-form-handler.ts";

  document.addEventListener("DOMContentLoaded", () => {
    // Initialize rotating placeholders for first and last name inputs
    const firstNameInputs = document.querySelectorAll(
      'input[name="firstName"][data-has-animated-placeholder="true"]'
    );
    const lastNameInputs = document.querySelectorAll(
      'input[name="lastName"][data-has-animated-placeholder="true"]'
    );

    // Get corresponding placeholder spans
    const firstNamePlaceholderSpans = Array.from(firstNameInputs).map((input) =>
      document.querySelector(`.animated-placeholder[data-for="${input.id}"]`)
    );
    const lastNamePlaceholderSpans = Array.from(lastNameInputs).map((input) =>
      document.querySelector(`.animated-placeholder[data-for="${input.id}"]`)
    );

    // First name placeholders in different languages
    const firstNamePlaceholders = [
      "John", // English
      "Juan", // Spanish
      "Jean", // French
      "João", // Portuguese
      "Giovanni", // Italian
      "Hans", // German
      "Иван", // Russian (Ivan)
      "太郎", // Japanese (Taro)
      "伟", // Chinese (Wei)
    ];

    // Last name placeholders in different languages
    const lastNamePlaceholders = [
      "Doe", // English
      "García", // Spanish
      "Dupont", // French
      "Silva", // Portuguese
      "Rossi", // Italian
      "Müller", // German
      "Иванов", // Russian (Ivanov)
      "山田", // Japanese (Yamada)
      "李", // Chinese (Li)
    ];

    let placeholderIndex = 0;

    // Hide placeholder spans when input has value
    firstNameInputs.forEach((input, index) => {
      const span = firstNamePlaceholderSpans[index];
      if (span) {
        input.addEventListener("input", () => {
          if (input.value) {
            span.style.display = "none";
          } else {
            span.style.display = "flex";
          }
        });
        // Check initial value
        if (input.value) {
          span.style.display = "none";
        }
      }
    });

    lastNameInputs.forEach((input, index) => {
      const span = lastNamePlaceholderSpans[index];
      if (span) {
        input.addEventListener("input", () => {
          if (input.value) {
            span.style.display = "none";
          } else {
            span.style.display = "flex";
          }
        });
        // Check initial value
        if (input.value) {
          span.style.display = "none";
        }
      }
    });

    function rotatePlaceholders() {
      // Rotate first name placeholders
      firstNameInputs.forEach((input, index) => {
        const span = firstNamePlaceholderSpans[index];
        if (span && !input.value && span.style.display !== "none") {
          // Only rotate if visible
          span.style.animation = "slideOutDown 400ms ease-out forwards";

          setTimeout(() => {
            placeholderIndex = (placeholderIndex + 1) % firstNamePlaceholders.length;
            span.textContent = firstNamePlaceholders[placeholderIndex];
            span.style.animation = "slideInDown 400ms ease-out forwards";
          }, 400);
        }
      });

      // Rotate last name placeholders with same index - delayed by 200ms for staggered effect
      setTimeout(() => {
        lastNameInputs.forEach((input, index) => {
          const span = lastNamePlaceholderSpans[index];
          if (span && !input.value && span.style.display !== "none") {
            // Only rotate if visible
            span.style.animation = "slideOutDown 400ms ease-out forwards";

            setTimeout(() => {
              span.textContent = lastNamePlaceholders[placeholderIndex];
              span.style.animation = "slideInDown 400ms ease-out forwards";
            }, 400);
          }
        });
      }, 200); // Stagger the second input animation by 200ms
    }

    // Rotate placeholders every 3 seconds (synced with title rotation)
    if (firstNamePlaceholderSpans.some((s) => s) || lastNamePlaceholderSpans.some((s) => s)) {
      setInterval(rotatePlaceholders, 3000);
    }

    // Get all form configs from window
    Object.keys(window).forEach((key) => {
      if (key.endsWith("_config")) {
        const { formId, formConfig, initialData } = window[key];
        const form = document.getElementById(formId);

        if (!form) {
          console.error(`[MULTISTEP-FORM] Form not found: ${formId}`);
          return;
        }

        console.log("[MULTISTEP-FORM] Initializing with data:", initialData);

        // Pre-fill form fields with initial data
        Object.entries(initialData).forEach(([key, value]) => {
          const input = form.querySelector(`[name="${key}"]`);
          if (input && value) {
            input.value = value;
            console.log(`[MULTISTEP-FORM] Pre-filled ${key}:`, value);
          }
        });

        // Initialize the form with skip logic
        initializeMultiStepForm(form, {
          initialData,
          formConfig,
        });
      }
    });
  });
</script>
