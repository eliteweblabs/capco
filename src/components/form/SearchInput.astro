---
/**
 * SearchInput - Reusable search field with icon, clear button, and optional autosuggest
 * Based on InlineAddressSearch pattern.
 *
 * Filter mode (default): fires input events. Parent handles filtering (e.g. filterUserRows).
 * Autosuggest mode: set fetchApiEndpoint for API-backed dropdown (like address search).
 *
 * @example
 *   <SearchInput id="user-search" placeholder="Search by name, email..." />
 *   <SearchInput id="addr" fetchApiEndpoint="/api/google/places-autocomplete" />
 */
import SimpleIcon from "../common/SimpleIcon.astro";

interface Props {
  id: string;
  name?: string;
  placeholder?: string;
  globalInputClasses?: string;
  /** Extra classes for the outer wrapper div */
  wrapperClass?: string;
  /** API endpoint for autosuggest. If omitted, filter mode only. */
  fetchApiEndpoint?: string;
  apiParams?: Record<string, any>;
  valueField?: string;
  labelField?: string;
  noResultsText?: string;
  currentLocation?: boolean;
  type?: "address" | "search";
  /** Type of search input. If omitted, search mode only. */
}

const {
  id,
  name = id,
  placeholder = "Search...",
  globalInputClasses = "",
  wrapperClass = "",
  fetchApiEndpoint,
  apiParams = {},
  valueField = "description",
  labelField = "description",
  noResultsText = "Type to search...",
  currentLocation = false,
  type = "search",
} = Astro.props;

const hasAutosuggest = !!fetchApiEndpoint;
---

<div class={`search-input-wrapper relative ${wrapperClass}`.trim()}>
  {hasAutosuggest && <input type="hidden" id={`${id}-value`} name={name} value="" />}
  <div class="relative">
    {
      !hasAutosuggest && (
        <SimpleIcon
          name="search"
          class="pointer-events-none absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400 dark:text-gray-500"
        />
      )
    }
    <input
      type="text"
      id={hasAutosuggest ? `${id}-search-input` : id}
      name={!hasAutosuggest ? name : undefined}
      placeholder={placeholder}
      autocomplete="off"
      class={`${globalInputClasses} w-full ${hasAutosuggest ? " pr-10 pl-4" : "pl-10 pr-10"}`}
    />
    {
      hasAutosuggest && (
        <button
          type="button"
          id={currentLocation ? `${id}-use-location-btn` : `${id}-location-btn`}
          class="location-btn pointer-events-auto absolute right-2 top-1/2 -translate-y-1/2 p-1.5 text-primary-500 transition-colors duration-200 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300"
          title={
            currentLocation
              ? "Use my current location"
              : type === "address"
                ? "Search for address"
                : "Search for location"
          }
        >
          <SimpleIcon
            name={type === "address" ? "pin-location" : "search"}
            size="sm"
            backgroundColor="primary"
            style="fill: var(--color-primary-500);"
          />
        </button>
      )
    }
    <button
      type="button"
      id={`${id}-clear-btn`}
      class="search-input-clear absolute right-2 top-1/2 hidden -translate-y-1/2 p-1.5 text-primary-500 transition-colors duration-200 hover:text-primary-600 dark:text-primary-400 dark:hover:text-primary-300"
      title="Clear search"
      aria-label="Clear search"
    >
      <SimpleIcon
        name="x"
        size="sm"
        backgroundColor="primary"
        style="fill: var(--color-primary-500);"
      />
    </button>
  </div>

  {
    hasAutosuggest && (
      <div
        id={`${id}-dropdown`}
        class="inline-search-results-container search-input-dropdown dark:color-background-50 color-background-50 absolute left-0 right-0 top-full z-50 mt-2 hidden w-full divide-y divide-gray-100 overflow-y-auto rounded-lg bg-white shadow-lg backdrop-blur-md dark:divide-gray-700"
      >
        <ul
          id={`${id}-results-list`}
          class="search-results-list max-h-60 overflow-y-auto py-2 text-sm text-gray-700 dark:text-gray-200"
        />
        <div id={`${id}-empty-state`} class="hidden px-4 py-8">
          <p class="text-sm text-gray-500 dark:text-gray-400">{noResultsText}</p>
        </div>
      </div>
    )
  }
  <slot name="suggestions" />
</div>

<script
  define:vars={{
    id,
    hasAutosuggest,
    fetchApiEndpoint,
    apiParams,
    valueField,
    labelField,
    currentLocation,
  }}
>
  document.addEventListener("DOMContentLoaded", initSearchInput);
  document.addEventListener("astro:page-load", initSearchInput);

  function initSearchInput() {
    const inputId = hasAutosuggest ? `${id}-search-input` : id;
    const input = document.getElementById(inputId);
    const clearBtn = document.getElementById(`${id}-clear-btn`);
    if (!input || !clearBtn) return;

    function toggleClear() {
      clearBtn.classList.toggle("hidden", !input.value.trim());
    }

    input.addEventListener("input", toggleClear);

    clearBtn.addEventListener("click", () => {
      input.value = "";
      toggleClear();
      input.focus();
      input.dispatchEvent(new Event("input", { bubbles: true }));
      const dropdown = document.getElementById(`${id}-dropdown`);
      if (dropdown) dropdown.classList.add("hidden");
    });

    toggleClear();
  }

  if (hasAutosuggest && fetchApiEndpoint) {
    import("/js/inline-address-search.js")
      .then((mod) => {
        const input = document.getElementById(`${id}-search-input`);
        if (!input) return;
        mod.initializeAddressSearch({
          id,
          fetchApiEndpoint,
          apiParams: apiParams || {},
          valueField,
          labelField,
          currentLocation,
        });
      })
      .catch(() => {});
  }
</script>
