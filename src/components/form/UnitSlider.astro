---
export interface Props {
  projectId?: string | null;
  value?: number;
  name?: string;
  label?: string;
  required?: boolean;
  readOnly?: boolean;
  min?: number;
  max?: number;
  step?: number;
  id?: string;
}

const {
  projectId = "default",
  id = "units-slider",
  value = 1,
  name = "units",
  label = "Units",
  required = false,
  readOnly = false,
  min = 0,
  max = 100,
  step = 1,
} = Astro.props;

// Convert units value to slider position (only for units)
const unitsOptions = [
  "1",
  "2",
  "3",
  "4",
  "5",
  "6",
  "7",
  "8",
  "9",
  "10",
  "15",
  "20",
  "30",
  "40",
  "50",
];

// Only use custom units logic if name is "units"
const isUnitsSlider = name === "units";
const sliderValue = isUnitsSlider
  ? unitsOptions.indexOf(value.toString()) >= 0
    ? unitsOptions.indexOf(value.toString())
    : 0
  : value;

const sliderId = `${name}-slider-${projectId}`;
---

<div>
  <label
    for={sliderId}
    class={`block text-sm font-medium mb-2 text-right ${
      readOnly ? "text-gray-500 dark:text-gray-400" : "text-gray-700 dark:text-gray-300"
    }`}
  >
    {label}: <span
      id={`${name}-value-${projectId}`}
      class={`font-semibold ${
        readOnly ? "text-gray-500 dark:text-gray-400" : "text-primary-500 dark:text-primary-400"
      }`}>{value}</span
    >
  </label>
  <div class="relative pt-6">
    <div
      id={`${name}-tooltip-${projectId}`}
      class="slider-tooltip absolute top-0 -translate-x-1/2 -translate-y-1 px-2 py-1 text-xs font-medium rounded-md shadow-md bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900 pointer-events-none opacity-0 transition-opacity duration-150 z-10 whitespace-nowrap"
      role="tooltip"
      aria-hidden="true"
      style={`left: ${isUnitsSlider ? (sliderValue / 14) * 100 : min === max ? 50 : ((sliderValue - min) / (max - min)) * 100}%`}
    >{isUnitsSlider ? unitsOptions[sliderValue] || "1" : sliderValue}</div
    >
    <input
      type="range"
      id={sliderId}
      {name}
      min={isUnitsSlider ? "0" : min.toString()}
      max={isUnitsSlider ? "14" : max.toString()}
      step={isUnitsSlider ? "1" : step.toString()}
      value={sliderValue}
      class={`w-full h-2 bg-gray-200 rounded-full appearance-none dark:bg-gray-700 ${
        isUnitsSlider ? "units-range-slider" : "regular-range-slider"
      } ${readOnly ? "cursor-not-allowed opacity-60" : "cursor-pointer"}`}
      data-values={isUnitsSlider ? unitsOptions.join(",") : ""}
      aria-label={isUnitsSlider ? "Select number of units" : `Select ${label.toLowerCase()}`}
      aria-valuetext={isUnitsSlider ? (unitsOptions[sliderValue] || "1") : sliderValue.toString()}
      {required}
      disabled={readOnly}
    />
    <!-- Tick marks and labels positioned to match actual slider positions (only for units) -->
    {
      isUnitsSlider && (
        <div class="relative mx-4 mb-3 mt-1 h-6">
          {unitsOptions.map((unit, index) => {
            // Calculate position as percentage across the slider (accounting for padding)
            const position = (index / (unitsOptions.length - 1)) * 100;

            // Show labels for key values to avoid overcrowding
            const showLabel = [0, 4, 9, 12, 14].includes(index); // positions for 1, 5, 10, 30, 50

            return (
              <div class="absolute -translate-x-1/2 transform" style={`left: ${position}%`}>
                {/* Small tick mark */}
                <div
                  class={`w-px bg-gray-300 dark:bg-gray-600 ${showLabel ? "h-3" : "h-2"} mx-auto`}
                />

                {/* Label for key positions */}
                {showLabel && (
                  <span class="mt-1 block text-center text-xs text-gray-500 dark:text-gray-400">
                    {unit}
                  </span>
                )}
              </div>
            );
          })}
        </div>
      )
    }
  </div>
</div>

<style>
  /* Units slider styling - Override Flowbite */
  .regular-range-slider,
  .units-range-slider {
    -webkit-appearance: none;
    appearance: none;
    cursor: pointer;
    background: transparent;
  }

  .regular-range-slider::-webkit-slider-track,
  .units-range-slider::-webkit-slider-track {
    border-radius: 8px;
    background: #e5e7eb;
    height: 8px;
  }

  .dark .regular-range-slider::-webkit-slider-track,
  .dark .units-range-slider::-webkit-slider-track {
    background: var(--color-primary-dark-500);
  }

  .regular-range-slider::-webkit-slider-thumb,
  .units-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    margin-top: -11px; /* Centers the thumb vertically on the track */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 2px solid #ffffff;
    border-radius: 50%;
    background: var(--color-primary-500);
    width: 30px;
    height: 30px;
  }

  .regular-range-slider::-moz-range-track,
  .units-range-slider::-moz-range-track {
    border: none;
    border-radius: 8px;
    background: var(--color-primary-100);
    height: 8px;
  }

  .dark .regular-range-slider::-moz-range-track,
  .dark .units-range-slider::-moz-range-track {
    background: var(--color-primary-dark-500);
  }

  .regular-range-slider::-moz-range-thumb,
  .units-range-slider::-moz-range-thumb {
    -moz-appearance: none;
    cursor: pointer;
    margin-top: 0; /* Firefox handles centering differently */
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border: 2px solid #ffffff;
    border-radius: 50%;
    background: var(--color-primary-500);
    width: 30px;
    height: 30px;
  }

  .dark .regular-range-slider::-webkit-slider-thumb,
  .dark .units-range-slider::-webkit-slider-thumb {
    background: var(--color-primary-dark-500);
  }

  .dark .regular-range-slider::-moz-range-thumb,
  .dark .units-range-slider::-moz-range-thumb {
    background: var(--color-primary-dark-500);
  }

  .regular-range-slider:focus,
  .units-range-slider:focus {
    outline: none;
  }

  .regular-range-slider:focus::-webkit-slider-thumb,
  .units-range-slider:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px var(--color-primary-500);
  }

  /* Disabled state styling */
  .regular-range-slider:disabled,
  .units-range-slider:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .regular-range-slider:disabled::-webkit-slider-thumb,
  .units-range-slider:disabled::-webkit-slider-thumb {
    cursor: not-allowed;
    background: #9ca3af;
  }

  .regular-range-slider:disabled::-moz-range-thumb,
  .units-range-slider:disabled::-moz-range-thumb {
    cursor: not-allowed;
    background: #9ca3af;
  }

  input[type="range"].regular-range-slider,
  input[type="range"].units-range-slider {
    margin: 0;
    outline: none;
    border: none;
    background: transparent;
    padding: 0;
  }

  input[type="range"].regular-range-slider::-webkit-slider-runnable-track,
  input[type="range"].units-range-slider::-webkit-slider-runnable-track {
    border: none;
    border-radius: 8px;
    background: var(--color-primary-100);
    height: 8px;
  }

  .dark input[type="range"].regular-range-slider::-webkit-slider-runnable-track,
  .dark input[type="range"].units-range-slider::-webkit-slider-runnable-track {
    background: var(--color-primary-dark-500);
  }
</style>

<script
  define:vars={{ projectId, unitsOptions, readOnly, sliderFieldName: name, isUnitsSlider, minVal: min, maxVal: max }}
  is:inline
>
  // sliderFieldName avoids no-redeclare (global 'name' is built-in)
  const slider = document.getElementById(`${sliderFieldName}-slider-${projectId}`);
  const valueDisplay = document.getElementById(`${sliderFieldName}-value-${projectId}`);
  const tooltip = document.getElementById(`${sliderFieldName}-tooltip-${projectId}`);

  const THUMB_HALF = 15; // half of 30px thumb - thumb center doesn't reach 0% or 100%

  function updateTooltip(sliderEl) {
    if (!tooltip || !sliderEl) return;
    const rawVal = parseInt(sliderEl.value);
    const displayVal = isUnitsSlider ? (unitsOptions[rawVal] || "1") : rawVal;
    const pct =
      isUnitsSlider
        ? (rawVal / 14) * 100
        : minVal === maxVal
          ? 50
          : ((rawVal - minVal) / (maxVal - minVal)) * 100;
    const trackWidth = sliderEl.offsetWidth;
    const leftPx = THUMB_HALF + (pct / 100) * (trackWidth - 2 * THUMB_HALF);
    tooltip.style.left = trackWidth > 0 ? (leftPx / trackWidth) * 100 + "%" : pct + "%";
    tooltip.textContent = displayVal;
  }

  if (slider && valueDisplay) {
    if (!readOnly && tooltip) {
      const showTooltip = () => {
        updateTooltip(slider);
        tooltip.classList.remove("opacity-0");
        tooltip.setAttribute("aria-hidden", "false");
      };
      const hideTooltip = () => {
        tooltip.classList.add("opacity-0");
        tooltip.setAttribute("aria-hidden", "true");
      };

      slider.addEventListener("input", (e) => {
        const target = e.target;
        const sliderValue = parseInt(target.value);
        if (isUnitsSlider) {
          const unitsValue = unitsOptions[sliderValue] || "1";
          valueDisplay.textContent = unitsValue;
        } else {
          valueDisplay.textContent = sliderValue;
        }
        updateTooltip(target);
        showTooltip();
      });
      slider.addEventListener("pointerdown", () => showTooltip());
      slider.addEventListener("pointerup", () => setTimeout(hideTooltip, 300));
      slider.addEventListener("pointerleave", () => setTimeout(hideTooltip, 150));
      slider.addEventListener("focus", () => showTooltip());
      slider.addEventListener("blur", () => hideTooltip());
    }
  }
</script>
