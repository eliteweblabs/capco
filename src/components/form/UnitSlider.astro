---
export interface Props {
  projectId?: string | null;
  value?: number;
  name?: string;
  label?: string;
  required?: boolean;
  readOnly?: boolean;
}

const {
  projectId = "default",
  value = 1,
  name = "units",
  label = "Units",
  required = false,
  readOnly = false,
} = Astro.props;

// Convert units value to slider position
const unitsOptions = [
  "1",
  "2",
  "3",
  "4",
  "5",
  "6",
  "7",
  "8",
  "9",
  "10",
  "15",
  "20",
  "30",
  "40",
  "50",
];
const sliderValue =
  unitsOptions.indexOf(value.toString()) >= 0 ? unitsOptions.indexOf(value.toString()) : 0;

const fieldId = `units-slider-${projectId}`;
---

<div>
  <label
    for={fieldId}
    class={`block text-sm font-medium mb-2 ${
      readOnly ? "text-gray-500 dark:text-gray-400" : "text-gray-700 dark:text-gray-300"
    }`}
  >
    {label}: <span
      id={`units-value-${projectId}`}
      class={`font-semibold ${
        readOnly ? "text-gray-500 dark:text-gray-400" : "text-primary-500 dark:text-primary-400"
      }`}>{value}</span
    >
  </label>
  <div class="relative">
    <input
      type="range"
      id={fieldId}
      name={name}
      min="0"
      max="14"
      value={sliderValue}
      class={`w-full h-2 bg-gray-200 rounded-full appearance-none dark:bg-gray-700 units-range-slider ${
        readOnly ? "cursor-not-allowed opacity-60" : "cursor-pointer"
      }`}
      data-values={unitsOptions.join(",")}
      aria-label="Select number of units"
      {required}
      disabled={readOnly}
    />
    <!-- Tick marks and labels positioned to match actual slider positions -->
    <div class="relative mt-1 h-6 mb-3 mx-4">
      {unitsOptions.map((unit, index) => {
        // Calculate position as percentage across the slider (accounting for padding)
        const position = (index / (unitsOptions.length - 1)) * 100;
        
        // Show labels for key values to avoid overcrowding
        const showLabel = [0, 4, 9, 12, 14].includes(index); // positions for 1, 5, 10, 30, 50
        
        return (
          <div 
            class="absolute transform -translate-x-1/2"
            style={`left: ${position}%`}
          >
            <!-- Small tick mark -->
            <div class={`w-px bg-gray-300 dark:bg-gray-600 ${showLabel ? 'h-3' : 'h-2'} mx-auto`}></div>
            
            <!-- Label for key positions -->
            {showLabel && (
              <span class="block text-xs text-gray-500 dark:text-gray-400 text-center mt-1">
                {unit}
              </span>
            )}
          </div>
        );
      })}
    </div>
  </div>
</div>

<style>
  /* Units slider styling - Override Flowbite */
  .units-range-slider {
    -webkit-appearance: none;
    appearance: none;
    background: transparent;
    cursor: pointer;
  }

  .units-range-slider::-webkit-slider-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 8px;
  }

  .dark .units-range-slider::-webkit-slider-track {
    background: #374151;
  }

  .units-range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    background: var(--color-primary-500);
    height: 30px;
    width: 30px;
    border-radius: 50%;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-top: -11px; /* Centers the thumb vertically on the track */
  }

  .units-range-slider::-moz-range-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 8px;
    border: none;
  }

  .dark .units-range-slider::-moz-range-track {
    background: #374151;
  }

  .units-range-slider::-moz-range-thumb {
    background: var(--color-primary-500);
    height: 30px;
    width: 30px;
    border-radius: 50%;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    -moz-appearance: none;
    margin-top: 0; /* Firefox handles centering differently */
  }

  .dark .units-range-slider::-webkit-slider-thumb {
    border-color: #1f2937;
  }

  .dark .units-range-slider::-moz-range-thumb {
    border-color: #1f2937;
  }

  .units-range-slider:focus {
    outline: none;
  }

  .units-range-slider:focus::-webkit-slider-thumb {
    box-shadow: 0 0 0 3px var(--color-primary-500);
  }

  /* Disabled state styling */
  .units-range-slider:disabled {
    cursor: not-allowed;
    opacity: 0.6;
  }

  .units-range-slider:disabled::-webkit-slider-thumb {
    background: #9ca3af;
    cursor: not-allowed;
  }

  .units-range-slider:disabled::-moz-range-thumb {
    background: #9ca3af;
    cursor: not-allowed;
  }

  input[type="range"].units-range-slider {
    background: transparent;
    border: none;
    outline: none;
    padding: 0;
    margin: 0;
  }

  input[type="range"].units-range-slider::-webkit-slider-runnable-track {
    background: #e5e7eb;
    height: 8px;
    border-radius: 8px;
    border: none;
  }

  .dark input[type="range"].units-range-slider::-webkit-slider-runnable-track {
    background: #374151;
  }
</style>

<script define:vars={{ projectId, unitsOptions, readOnly }}>
  // Update the units value display when slider changes
  const slider = document.getElementById(`units-slider-${projectId}`);
  const valueDisplay = document.getElementById(`units-value-${projectId}`);

  if (slider && valueDisplay) {
    // Only add event listener if not read-only
    if (!readOnly) {
      slider.addEventListener("input", (e) => {
        const target = e.target;
        const index = parseInt(target.value);
        const unitsValue = unitsOptions[index] || "1";
        valueDisplay.textContent = unitsValue;
      });
    }
  }
</script>
