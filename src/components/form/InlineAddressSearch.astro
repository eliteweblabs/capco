---
import SimpleIcon from "../common/SimpleIcon.astro";

interface Props {
  id: string;
  name?: string;
  placeholder?: string;
  globalInputClasses?: string;
  fetchApiEndpoint?: string;
  apiParams?: Record<string, any>;
  valueField?: string;
  labelField?: string;
  noResultsText?: string;
  currentLocation?: boolean;
}

const {
  id,
  name = id,
  placeholder = "Search for an address...",
  globalInputClasses = "",
  fetchApiEndpoint = "/api/google/places-autocomplete",
  apiParams = {},
  valueField = "description",
  labelField = "description",
  noResultsText = "Type to search addresses...",
  currentLocation = false,
} = Astro.props;
---

<div class="inline-address-search-wrapper">
  <!-- Hidden input to store the selected value -->
  <input type="hidden" id={`${id}-value`} {name} value="" />

  <!-- Search Input -->
  <div class="relative">
    <input
      type="text"
      id={`${id}-search-input`}
      {placeholder}
      autocomplete="off"
      class={`${globalInputClasses} text-center`}
    />
    {
      currentLocation ? (
        <button
          type="button"
          id={`${id}-use-location-btn`}
          class="absolute right-2 top-1/2 -translate-y-1/2 transform p-1.5 text-gray-400 transition-colors duration-200 hover:text-gray-600 dark:hover:text-gray-300"
          title="Use my current location"
        >
          <SimpleIcon name="pin-location" size="sm" />
        </button>
      ) : (
        <button
          type="button"
          class="absolute right-2 top-1/2 -translate-y-1/2 transform p-1.5 text-gray-400 transition-colors duration-200 hover:text-gray-600 dark:hover:text-gray-300"
          title="Search for address"
        >
          <SimpleIcon name="pin-location" size="sm" />
        </button>
      )
    }

    <!-- Dropdown Results Container -->
    <div
      id={`${id}-dropdown`}
      class="inline-address-results-container hidden absolute z-10 mt-2 w-full bg-white divide-y divide-gray-100 rounded-lg shadow-lg dark:bg-gray-700 dark:divide-gray-600"
    >
      <ul
        id={`${id}-results-list`}
        class="max-h-60 overflow-y-auto py-2 text-sm text-gray-700 dark:text-gray-200"
      >
        <!-- Results will be populated dynamically -->
      </ul>

      <!-- Empty state when no results -->
      <div id={`${id}-empty-state`} class="hidden px-4 py-8 text-center">
        <SimpleIcon
          name="map-pin"
          class="mx-auto mb-2 h-8 w-8 opacity-50 text-gray-400 dark:text-gray-500"
        />
        <p class="text-sm text-gray-500 dark:text-gray-400">{noResultsText}</p>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ id, fetchApiEndpoint, apiParams, valueField, labelField, currentLocation }}>
  // Initialize address search inline
  import("/js/inline-address-search.js")
    .then((module) => {
      const initWhenReady = () => {
        const searchInput = document.getElementById(`${id}-search-input`);

        if (!searchInput) {
          console.log(`[INLINE-ADDRESS] Waiting for elements for ${id}...`);
          setTimeout(initWhenReady, 100);
          return;
        }

        console.log(`[INLINE-ADDRESS] Initializing address search for ${id}`);
        module.initializeAddressSearch({
          id: id,
          fetchApiEndpoint: fetchApiEndpoint,
          apiParams: apiParams,
          valueField: valueField,
          labelField: labelField,
          currentLocation: currentLocation,
        });
      };

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initWhenReady);
      } else {
        initWhenReady();
      }
    })
    .catch((err) => {
      console.error("[INLINE-ADDRESS] Failed to load module:", err);
    });
</script>

<style>
  .inline-address-results-container {
    max-width: 100%;
  }

  .inline-address-result-item {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }
</style>
