---
import SimpleIcon from "../common/SimpleIcon.astro";

interface Props {
  id: string;
  name?: string;
  placeholder?: string;
  globalInputClasses?: string;
  fetchApiEndpoint?: string;
  apiParams?: Record<string, any>;
  valueField?: string;
  labelField?: string;
  noResultsText?: string;
}

const {
  id,
  name = id,
  placeholder = "Search for an address...",
  globalInputClasses = "",
  fetchApiEndpoint = "/api/google/places-autocomplete",
  apiParams = {},
  valueField = "description",
  labelField = "description",
  noResultsText = "Type to search addresses...",
} = Astro.props;
---

<div class="inline-address-search-wrapper">
  <!-- Hidden input to store the selected value -->
  <input type="hidden" id={`${id}-value`} {name} value="" />

  <!-- Search Input -->
  <div class="relative">
    <input
      type="text"
      id={`${id}-search-input`}
      {placeholder}
      autocomplete="off"
      class={`${globalInputClasses} text-xl py-5 text-center`}
    />
    <button
      type="button"
      class="absolute right-2 top-1/2 -translate-y-1/2 transform p-1.5 text-gray-400 transition-colors duration-200 hover:text-gray-600 dark:hover:text-gray-300"
      title="Search for address"
    >
      <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
      </svg>
    </button>

    <!-- Dropdown Results Container -->
    <div
      id={`${id}-dropdown`}
      class="inline-address-results-container hidden absolute z-10 mt-2 w-full bg-white divide-y divide-gray-100 rounded-lg shadow-lg dark:bg-gray-700 dark:divide-gray-600"
    >
      <ul
        id={`${id}-results-list`}
        class="max-h-60 overflow-y-auto py-2 text-sm text-gray-700 dark:text-gray-200"
      >
        <!-- Results will be populated dynamically -->
      </ul>

      <!-- Empty state when no results -->
      <div
        id={`${id}-empty-state`}
        class="hidden px-4 py-8 text-center"
      >
        <SimpleIcon name="map-pin" class="mx-auto mb-2 h-8 w-8 opacity-50 text-gray-400 dark:text-gray-500" />
        <p class="text-sm text-gray-500 dark:text-gray-400">{noResultsText}</p>
      </div>
    </div>
  </div>
</div>

<script>
  import { initializeAddressSearch } from "../../scripts/inline-address-search";

  document.addEventListener("DOMContentLoaded", function () {
    const config = {
      id: document.currentScript?.getAttribute("data-id") || "",
      fetchApiEndpoint: document.currentScript?.getAttribute("data-endpoint") || "/api/google/places-autocomplete",
      apiParams: JSON.parse(document.currentScript?.getAttribute("data-params") || "{}"),
      valueField: document.currentScript?.getAttribute("data-value-field") || "description",
      labelField: document.currentScript?.getAttribute("data-label-field") || "description",
    };

    initializeAddressSearch(config);
  });
</script>

<script
  define:vars={{ id, fetchApiEndpoint, apiParams, valueField, labelField }}
  is:inline
>
  // Set data attributes for the module script to read
  const scripts = document.querySelectorAll("script");
  const lastScript = scripts[scripts.length - 1];
  if (lastScript && lastScript.previousElementSibling) {
    const moduleScript = lastScript.previousElementSibling;
    moduleScript.setAttribute("data-id", id);
    moduleScript.setAttribute("data-endpoint", fetchApiEndpoint);
    moduleScript.setAttribute("data-params", JSON.stringify(apiParams));
    moduleScript.setAttribute("data-value-field", valueField);
    moduleScript.setAttribute("data-label-field", labelField);
  }
</script>

<style>
  .inline-address-results-container {
    max-width: 100%;
  }

  .inline-address-result-item {
    user-select: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
  }
</style>
