---
export interface Props {
  id?: string;
  name: string;
  label?: string;
  required?: boolean;
  accept?: string;
  multiple?: boolean;
  maxFiles?: number;
  maxSize?: number; // in bytes
  class?: string;
}

const {
  id,
  name,
  label = "Upload Files",
  required = false,
  accept = "*",
  multiple = false,
  maxFiles = 10,
  maxSize = 10 * 1024 * 1024, // 10MB default
  class: className = "",
} = Astro.props;

const fieldId = id || `${name}-upload`;
---

<div class={`file-upload-wrapper ${className}`}>
  {
    label && (
      <label for={fieldId} class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        {label}
        {required && <span class="text-red-500">*</span>}
      </label>
    )
  }

  <div class="relative">
    <input
      type="file"
      id={fieldId}
      {name}
      {required}
      {accept}
      {multiple}
      data-max-files={maxFiles}
      data-max-size={maxSize}
      class="hidden"
    />

    <label
      for={fieldId}
      class="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg cursor-pointer bg-gray-50 dark:bg-gray-800 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors"
    >
      <div class="flex flex-col items-center justify-center pt-5 pb-6">
        <svg
          class="w-8 h-8 mb-3 text-gray-400"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
          ></path>
        </svg>
        <p class="mb-2 text-sm text-gray-500 dark:text-gray-400">
          <span class="font-semibold">Click to upload</span> or drag and drop
        </p>
        <p class="text-xs text-gray-500 dark:text-gray-400">
          {multiple ? `Up to ${maxFiles} files` : "Single file"}
          {maxSize && ` â€¢ Max ${(maxSize / 1024 / 1024).toFixed(0)}MB per file`}
        </p>
      </div>
    </label>

    <!-- File list preview -->
    <div id={`${fieldId}-preview`} class="mt-3 space-y-2 hidden">
      <!-- Files will be added here dynamically -->
    </div>
  </div>
</div>

<style>
  .file-upload-wrapper {
    width: 100%;
  }

  .file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid rgb(229 231 235);
    border-radius: 0.375rem;
    background-color: rgb(249 250 251);
    padding: 0.5rem;
  }

  .dark .file-item {
    border-color: rgb(75 85 99);
    background-color: rgb(31 41 55);
  }

  .file-item-name {
    color: rgb(55 65 81);
    font-size: 0.875rem;
  }

  .dark .file-item-name {
    color: rgb(209 213 219);
  }

  .file-item-remove {
    cursor: pointer;
    color: rgb(239 68 68);
  }

  .file-item-remove:hover {
    color: rgb(220 38 38);
  }
</style>

<script define:vars={{ fieldId, maxFiles, maxSize, multiple }}>
  const input = document.getElementById(fieldId);
  const preview = document.getElementById(`${fieldId}-preview`);
  const label = input?.nextElementSibling;

  if (input && preview) {
    let selectedFiles = [];

    // Handle file selection
    input.addEventListener("change", (e) => {
      const files = Array.from(e.target.files || []);
      handleFiles(files);
    });

    // Handle drag and drop
    if (label) {
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        label.addEventListener(eventName, preventDefaults, false);
      });

      ["dragenter", "dragover"].forEach((eventName) => {
        label.addEventListener(eventName, () => {
          label.classList.add("border-primary-500", "bg-primary-50", "dark:bg-primary-900/20");
        });
      });

      ["dragleave", "drop"].forEach((eventName) => {
        label.addEventListener(eventName, () => {
          label.classList.remove("border-primary-500", "bg-primary-50", "dark:bg-primary-900/20");
        });
      });

      label.addEventListener("drop", (e) => {
        const dt = e.dataTransfer;
        const files = Array.from(dt?.files || []);
        handleFiles(files);
      });
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    function handleFiles(files) {
      // Validate file count
      if (!multiple && files.length > 1) {
        alert("Only one file is allowed");
        return;
      }

      const totalFiles = selectedFiles.length + files.length;
      if (totalFiles > maxFiles) {
        alert(`Maximum ${maxFiles} files allowed`);
        return;
      }

      // Validate file sizes
      const oversizedFiles = files.filter((f) => f.size > maxSize);
      if (oversizedFiles.length > 0) {
        alert(`Some files exceed the maximum size of ${(maxSize / 1024 / 1024).toFixed(0)}MB`);
        return;
      }

      // Add files to selection
      selectedFiles = multiple ? [...selectedFiles, ...files] : files;
      updatePreview();

      // Update the actual input with DataTransfer
      const dt = new DataTransfer();
      selectedFiles.forEach((file) => dt.items.add(file));
      input.files = dt.files;
    }

    function updatePreview() {
      if (selectedFiles.length === 0) {
        preview.classList.add("hidden");
        return;
      }

      preview.classList.remove("hidden");
      preview.innerHTML = selectedFiles
        .map(
          (file, index) => `
        <div class="file-item">
          <span class="file-item-name">${file.name} (${formatFileSize(file.size)})</span>
          <button
            type="button"
            class="file-item-remove"
            data-index="${index}"
            aria-label="Remove file"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
      `
        )
        .join("");

      // Add remove handlers
      preview.querySelectorAll(".file-item-remove").forEach((btn) => {
        btn.addEventListener("click", (e) => {
          const index = parseInt(e.currentTarget.getAttribute("data-index"));
          removeFile(index);
        });
      });
    }

    function removeFile(index) {
      selectedFiles.splice(index, 1);
      updatePreview();

      // Update the actual input
      const dt = new DataTransfer();
      selectedFiles.forEach((file) => dt.items.add(file));
      input.files = dt.files;
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return "0 Bytes";
      const k = 1024;
      const sizes = ["Bytes", "KB", "MB", "GB"];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + " " + sizes[i];
    }
  }
</script>
