---
// OTP Authentication Form Component
import Button from "../common/Button.astro";
import {
  otpEmailConfig,
  otpCodeConfig,
  otpFormButtonConfig,
  otpApiConfig,
  otpNotificationConfig,
} from "../../lib/otp-email-config";

const { globalInputClasses } = Astro.props;
---

<div class="w-full max-w-lg px-4 py-8">
  <!-- OTP Request Form (shown first) -->
  <div id="otp-request-form">
    <form id="request-otp-form" class="grid w-full grid-cols-1 gap-3 space-y-8">
      <div>
        <label for={otpEmailConfig.id} class={otpEmailConfig.label.classes}>
          {otpEmailConfig.label.text}
        </label>
        <input
          type="email"
          name={otpEmailConfig.name}
          id={otpEmailConfig.id}
          placeholder={otpEmailConfig.placeholder}
          required={otpEmailConfig.required}
          autocomplete={otpEmailConfig.autocomplete}
          autofocus={otpEmailConfig.autofocus}
          class={`${globalInputClasses} text-center`}
        />
      </div>

      <div class="flex justify-between gap-3">
        <Button
          href="/auth/login"
          variant="outline"
          size="lg"
          icon={otpFormButtonConfig.back.icon}
          iconPosition="left"
        >
          {otpFormButtonConfig.back.label}
        </Button>
        <Button
          type="submit"
          variant="primary"
          size="lg"
          icon={otpFormButtonConfig.sendCode.icon}
          iconPosition="right"
        >
          {otpFormButtonConfig.sendCode.label}
        </Button>
      </div>
    </form>
  </div>

  <!-- OTP Verification Form (hidden initially) -->
  <div id="otp-verify-form" class="hidden">
    <form id="verify-otp-form" class="grid w-full grid-cols-1 gap-3 space-y-8">
      <div>
        <p class="mb-4 text-sm text-center text-gray-600 dark:text-gray-400">
          {otpCodeConfig.instructionText}
          <span id="otp-sent-email" class="font-semibold"></span>
        </p>
        <label for={otpCodeConfig.id} class={otpCodeConfig.label.classes}>
          {otpCodeConfig.label.text}
        </label>
        <input
          type="text"
          name={otpCodeConfig.name}
          id={otpCodeConfig.id}
          placeholder={otpCodeConfig.placeholder}
          required={otpCodeConfig.required}
          maxlength={otpCodeConfig.maxlength}
          pattern={otpCodeConfig.pattern}
          autocomplete={otpCodeConfig.autocomplete}
          class={`${globalInputClasses} text-center text-2xl tracking-widest font-mono`}
        />
      </div>

      <div class="flex justify-between gap-3">
        <Button
          type="button"
          id="back-to-email-button"
          variant="outline"
          size="lg"
          icon={otpFormButtonConfig.back.icon}
          iconPosition="left"
        >
          {otpFormButtonConfig.back.label}
        </Button>
        <Button
          type="submit"
          variant="primary"
          size="lg"
          icon={otpFormButtonConfig.verify.icon}
          iconPosition="right"
        >
          {otpFormButtonConfig.verify.label}
        </Button>
      </div>

      <div class="text-center">
        <button
          type="button"
          id="resend-otp-button"
          class={otpFormButtonConfig.resend.classes}
        >
          {otpFormButtonConfig.resend.label}
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  import {
    otpEmailConfig,
    otpCodeConfig,
    otpApiConfig,
    otpNotificationConfig,
  } from "../../lib/otp-email-config";

  let currentEmail = "";

  // Initialize OTP forms
  function initOTPForms() {
    const requestForm = document.getElementById("request-otp-form") as HTMLFormElement;
    const verifyForm = document.getElementById("verify-otp-form") as HTMLFormElement;
    const backToEmailButton = document.getElementById("back-to-email-button");
    const resendButton = document.getElementById("resend-otp-button");

    if (!requestForm || !verifyForm) {
      console.error("[OTP] Forms not found");
      return;
    }

    // Handle OTP request
    requestForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const emailInput = requestForm.querySelector(
        `#${otpEmailConfig.id}`
      ) as HTMLInputElement;
      const email = emailInput?.value?.trim();

      if (!email) {
        showNotification(
          otpNotificationConfig.error.type,
          otpNotificationConfig.error.title,
          otpEmailConfig.validation.errorMessage
        );
        return;
      }

      currentEmail = email;

      // Show loading
      showNotification(
        otpNotificationConfig.sending.type,
        otpNotificationConfig.sending.title,
        otpNotificationConfig.sending.message
      );

      try {
        const response = await fetch(otpApiConfig.endpoints.sendOtp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email,
            type: otpApiConfig.requestBody.sendOtp.type,
          }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.details || result.error || "Failed to send OTP");
        }

        // Success - show verification form
        document.getElementById("otp-request-form")?.classList.add("hidden");
        document.getElementById("otp-verify-form")?.classList.remove("hidden");

        const sentEmailSpan = document.getElementById("otp-sent-email");
        if (sentEmailSpan) {
          sentEmailSpan.textContent = email;
        }

        // Focus on code input
        const codeInput = document.getElementById(otpCodeConfig.id) as HTMLInputElement;
        if (codeInput) {
          setTimeout(() => codeInput.focus(), 100);
        }

        showNotification(
          otpNotificationConfig.sent.type,
          otpNotificationConfig.sent.title,
          otpNotificationConfig.sent.message
        );
      } catch (error) {
        console.error("[OTP] Error sending code:", error);
        showNotification(
          otpNotificationConfig.error.type,
          otpNotificationConfig.error.title,
          error instanceof Error ? error.message : "Failed to send verification code"
        );
      }
    });

    // Handle OTP verification
    verifyForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const codeInput = verifyForm.querySelector(
        `#${otpCodeConfig.id}`
      ) as HTMLInputElement;
      const token = codeInput?.value?.trim();

      if (!token || token.length !== otpCodeConfig.validation.length) {
        showNotification(
          otpNotificationConfig.error.type,
          otpNotificationConfig.error.title,
          otpCodeConfig.validation.errorMessage
        );
        return;
      }

      // Show loading
      showNotification(
        otpNotificationConfig.verifying.type,
        otpNotificationConfig.verifying.title,
        otpNotificationConfig.verifying.message
      );

      try {
        const response = await fetch(otpApiConfig.endpoints.verifyOtp, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            email: currentEmail,
            token,
            type: otpApiConfig.requestBody.verifyOtp.type,
          }),
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.details || result.error || "Invalid verification code");
        }

        // Success - redirect to dashboard
        showNotification(
          otpNotificationConfig.verified.type,
          otpNotificationConfig.verified.title,
          otpNotificationConfig.verified.message
        );

        setTimeout(() => {
          window.location.href = otpApiConfig.redirectUrl;
        }, 1000);
      } catch (error) {
        console.error("[OTP] Error verifying code:", error);
        showNotification(
          otpNotificationConfig.error.type,
          "Verification Failed",
          error instanceof Error ? error.message : "Invalid or expired code"
        );

        // Clear the code input
        if (codeInput) {
          codeInput.value = "";
          codeInput.focus();
        }
      }
    });

    // Handle back button
    if (backToEmailButton) {
      backToEmailButton.addEventListener("click", () => {
        document.getElementById("otp-verify-form")?.classList.add("hidden");
        document.getElementById("otp-request-form")?.classList.remove("hidden");

        // Clear the code input
        const codeInput = document.getElementById(otpCodeConfig.id) as HTMLInputElement;
        if (codeInput) {
          codeInput.value = "";
        }
      });
    }

    // Handle resend button
    if (resendButton) {
      resendButton.addEventListener("click", async () => {
        if (!currentEmail) {
          showNotification(
            otpNotificationConfig.error.type,
            otpNotificationConfig.error.title,
            "Email not found. Please start over."
          );
          return;
        }

        showNotification(
          otpNotificationConfig.resending.type,
          otpNotificationConfig.resending.title,
          otpNotificationConfig.resending.message
        );

        try {
          const response = await fetch(otpApiConfig.endpoints.sendOtp, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              email: currentEmail,
              type: otpApiConfig.requestBody.sendOtp.type,
            }),
          });

          const result = await response.json();

          if (!response.ok) {
            throw new Error(result.details || result.error || "Failed to resend OTP");
          }

          showNotification(
            otpNotificationConfig.resent.type,
            otpNotificationConfig.resent.title,
            otpNotificationConfig.resent.message
          );
        } catch (error) {
          console.error("[OTP] Error resending code:", error);
          showNotification(
            otpNotificationConfig.error.type,
            otpNotificationConfig.error.title,
            error instanceof Error ? error.message : "Failed to resend code"
          );
        }
      });
    }

    // Auto-format OTP input (only allow numbers)
    const codeInput = document.getElementById(otpCodeConfig.id) as HTMLInputElement;
    if (codeInput) {
      codeInput.addEventListener("input", (e) => {
        const target = e.target as HTMLInputElement;
        target.value = target.value.replace(/[^0-9]/g, "");
      });
    }
  }

  // Helper function to show notifications
  function showNotification(type: string, title: string, message: string) {
    if (window.showNotice) {
      window.showNotice(type, title, message);
    } else {
      console.log(`ðŸ”” [${type.toUpperCase()}] ${title}: ${message}`);
    }
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initOTPForms);
  } else {
    initOTPForms();
  }
</script>
