---
import Button from "../common/Button.astro";
const { id, message } = Astro.props;
---

<!-- Forgot Password Button -->
<div class="mt-4 text-center">
  <Button
    type="button"
    id="forgot-password-btn"
    variant="secondary"
    size="sm"
    fullWidth
    icon="lock"
    iconPosition="left"
  >
    {message}
  </Button>
</div>

<!-- Form is now loaded dynamically from /partials/forgot-password-form/ -->

<script>
  // Forgot Password Modal Functionality
  // Open modal
  // changePasswordBtn?.addEventListener("click", () => {
  //   forgotPasswordModal?.classList.remove("hidden");
  //   forgotPasswordModal?.classList.add("flex");
  //   resetEmailInput?.focus();
  // });

  // // Close modal functions
  // const closeModal = () => {
  //   forgotPasswordModal?.classList.add("hidden");
  //   forgotPasswordModal?.classList.remove("flex");
  //   (forgotPasswordForm as HTMLFormElement)?.reset();
  // };

  // closeForgotModal?.addEventListener("click", closeModal);
  // cancelForgot?.addEventListener("click", closeModal);

  // // Close modal when clicking outside
  // forgotPasswordModal?.addEventListener("click", (e) => {
  //   if (e.target === forgotPasswordModal) {
  //     closeModal();
  //   }
  // });

  // // Handle forgot password form submission
  // forgotPasswordForm?.addEventListener("submit", async (e) => {
  //   e.preventDefault();

  //   const email = (resetEmailInput as HTMLInputElement)?.value.trim();

  //   if (!email) {
  //     if (window.showModal) {
  //       window.showModal("error", "Validation Error", "Please enter your email address.");
  //     } else {
  //       console.error("ðŸ”” [Validation Error] Please enter your email address.");
  //     }
  //     return;
  //   }

  //   // Disable button and show loading state
  //   if (sendResetLinkBtn) {
  //     (sendResetLinkBtn as HTMLButtonElement).disabled = true;
  //     (sendResetLinkBtn as HTMLButtonElement).textContent = "Sending...";
  //   }

  //   try {
  //     const response = await fetch("/api/auth/forgot-password", {
  //       method: "POST",
  //       headers: {
  //         "Content-Type": "application/json",
  //       },
  //       body: JSON.stringify({ email }),
  //     });

  //     const result = await response.json();

  //     if (response.ok) {
  //       if (window.showModal) {
  //         window.showModal(
  //           "success",
  //           "Reset Link Sent",
  //           "If an account with that email exists, you will receive a password reset link shortly.",
  //           8000
  //         );
  //       } else {
  //         console.log(
  //           "ðŸ”” [Reset Link Sent] If an account with that email exists, you will receive a password reset link shortly."
  //         );
  //       }
  //       closeModal();
  //     } else {
  //       if (window.showModal) {
  //         window.showModal(
  //           "Error",
  //           result.error || "Failed to send reset link. Please try again.",
  //           "error"
  //         );
  //       } else {
  //         console.error(
  //           "ðŸ”” [Error]",
  //           result.error || "Failed to send reset link. Please try again."
  //         );
  //       }
  //     }
  //   } catch (error) {
  //     console.error("Forgot password error:", error);
  //     if (window.showModal) {
  //       window.showModal(
  //         "Network Error",
  //         "Failed to send reset link. Please check your connection and try again.",
  //         "error"
  //       );
  //     } else {
  //       console.error(
  //         "ðŸ”” [Network Error] Failed to send reset link. Please check your connection and try again."
  //       );
  //     }
  //   } finally {
  //     // Re-enable button
  //     if (sendResetLinkBtn) {
  //       (sendResetLinkBtn as HTMLButtonElement).disabled = false;
  //       (sendResetLinkBtn as HTMLButtonElement).textContent = "Send Reset Link";
  //     }
  //   }

  // // Forgot Password Modal Elements from profile.astro
  // const changePasswordBtn = document.getElementById("change-password-btn");
  // const forgotPasswordModal = document.getElementById("forgot-password-modal");
  // const closeForgotModal = document.getElementById("close-forgot-modal");
  // const cancelForgot = document.getElementById("cancel-forgot");
  // const forgotPasswordForm = document.getElementById("forgot-password-form");

  // Handle forgot password modal and form submission
  document.addEventListener("DOMContentLoaded", () => {
    const forgotPasswordBtn = document.getElementById("forgot-password-btn");

    // Modal open/close functionality
    async function openModal() {
      try {
        // Fetch the form HTML from the partial
        const response = await fetch("/partials/forgot-password-form/");
        const formHTML = await response.text();

        // Show modal with the form HTML
        window.showModal("info", "Forgot Password", formHTML);

        // Focus on email input when modal opens
        setTimeout(() => {
          const emailInput = document.querySelector(
            '#forgot-password-form input[name="email"]'
          ) as HTMLInputElement;
          emailInput?.focus();
        }, 100);
      } catch (error) {
        console.error("Failed to load forgot password form:", error);
        // Fallback to simple alert
        alert("Failed to load password reset form. Please try again.");
      }
    }

    // Event listeners for modal
    forgotPasswordBtn?.addEventListener("click", openModal);

    // Handle form submission using event delegation (since form will be in modal)
    document.addEventListener("submit", async (e) => {
      const target = e.target as HTMLFormElement;
      if (target.id === "forgot-password-form") {
        e.preventDefault();

        const emailInput = target.querySelector('input[name="email"]') as HTMLInputElement;
        const email = emailInput?.value.trim();

        if (!email) {
          if ((window as any).showModal) {
            (window as any).showModal(
              "error",
              "Validation Error",
              "Please enter your email address."
            );
          } else {
            console.error("ðŸ”” [Validation Error] Please enter your email address.");
          }
          return;
        }

        // Find the submit button in the modal
        const sendResetLinkBtn = target.querySelector('button[type="submit"]') as HTMLButtonElement;

        // Disable button and show loading state
        if (sendResetLinkBtn) {
          sendResetLinkBtn.disabled = true;
          sendResetLinkBtn.textContent = "Sending...";
        }

        try {
          const response = await fetch("/api/auth/forgot-password", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ email }),
          });

          const result = await response.json();

          if (response.ok) {
            if ((window as any).showModal) {
              (window as any).showModal(
                "success",
                "Reset Link Sent",
                "If an account with that email exists, you will receive a password reset link shortly.",
                8000
              );
            } else {
              console.log(
                "ðŸ”” [Reset Link Sent] If an account with that email exists, you will receive a password reset link shortly."
              );
            }

            // Close the modal by finding and clicking the close button
            const closeBtn = document.querySelector(
              '[data-modal-hide="forgot-password-modal"]'
            ) as HTMLElement;
            if (closeBtn) closeBtn.click();
          } else {
            if ((window as any).showModal) {
              (window as any).showModal(
                "error",
                "Error",
                result.error || "Failed to send reset link. Please try again."
              );
            } else {
              console.error(
                "ðŸ”” [Error]",
                result.error || "Failed to send reset link. Please try again."
              );
            }
          }
        } catch (error) {
          console.error("Forgot password error:", error);
          if ((window as any).showModal) {
            (window as any).showModal(
              "error",
              "Network Error",
              "Failed to send reset link. Please check your connection and try again."
            );
          } else {
            console.error(
              "ðŸ”” [Network Error] Failed to send reset link. Please check your connection and try again."
            );
          }
        } finally {
          // Re-enable button
          if (sendResetLinkBtn) {
            sendResetLinkBtn.disabled = false;
            sendResetLinkBtn.textContent = "Send Reset Link";
          }
        }
      }
    });
  });
</script>
