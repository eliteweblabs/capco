---
// AuthProviders component - displays various authentication provider icons
// Icons are desaturated by default, saturate on hover/focus

import Tooltip from "../common/TooltipFloating.astro";
import SimpleIcon from "../common/SimpleIcon.astro";

interface Props {
  mode?: "login" | "register";
}

const { mode = "login" } = Astro.props;
---

<div
  class="auth-providers mb-12 flex items-center justify-center gap-2 overflow-y-visible sm:gap-3 md:pt-12"
>
  <!-- Phone OTP -->
  <button
    type="button"
    class="provider-btn hidden w-10 object-contain dark:invert"
    data-provider="phone"
    title="Sign in with Phone OTP"
    aria-label="Sign in with Phone OTP"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="provider-icon"
    >
      <rect x="5" y="2" width="14" height="20" rx="2" ry="2"></rect>
      <line x1="12" y1="18" x2="12.01" y2="18"></line>
    </svg>
    <span class="provider-label hidden md:block">Phone</span>
  </button>

  <!-- Email OTP -->
  <button
    type="button"
    class="provider-btn hidden w-10 object-contain dark:invert"
    data-provider="email"
    title="Sign in with Email OTP"
    aria-label="Sign in with Email OTP"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
      class="provider-icon"
    >
      <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
      <polyline points="22,6 12,13 2,6"></polyline>
    </svg>
    <span class="provider-label hidden md:block">Email</span>
  </button>

  <!-- Google: OAuth via handleGoogleSignup (login/register) or redirect to login page (dropdown/popper) -->
  <Tooltip text="Sign in with Google" position="top" mobileClickable={false} touchable={false}>
    <button
      type="button"
      class="provider-btn w-10 object-contain"
      data-provider="google"
      title="Sign in with Google"
      aria-label="Sign in with Google"
    >
      <SimpleIcon name="google" size="xl" class="provider-icon provider-icon-color" />
      <span class="provider-label hidden md:block">Google</span>
    </button>
  </Tooltip>

  <!-- Apple -->
  <Tooltip text="soon" position="top" mobileClickable={true}>
    <button
      type="button"
      class="provider-btn w-10 object-contain opacity-60"
      data-provider="apple"
      title="Coming soon"
      aria-label="Apple sign in coming soon"
      disabled
    >
      <SimpleIcon name="apple" size="xl" class="provider-icon provider-icon-color" />
      <span class="provider-label hidden md:block">Apple</span>
    </button>
  </Tooltip>

  <!-- Facebook -->
  <Tooltip text="soon" position="top" mobileClickable={true}>
    <button
      type="button"
      class="provider-btn w-10 object-contain opacity-60 grayscale"
      data-provider="facebook"
      title="Coming soon"
      aria-label="Facebook sign in coming soon"
      disabled
    >
      <SimpleIcon name="facebook" size="xl" class="provider-icon provider-icon-color" />

      <span class="provider-label hidden md:block">Slack</span>
    </button>
  </Tooltip>

  <!-- Slack -->
  <Tooltip text="soon" position="top" mobileClickable={true}>
    <button
      type="button"
      class="provider-btn w-10 object-contain opacity-60 grayscale dark:invert"
      data-provider="slack"
      title="Coming soon"
      aria-label="Slack sign in coming soon"
      disabled
    >
      <SimpleIcon name="slack" size="xl" class="provider-icon provider-icon-color" />

      <span class="provider-label hidden md:block">Slack</span>
    </button>
  </Tooltip>

  <!-- GitHub -->
  <Tooltip text="soon" position="top" mobileClickable={true}>
    <button
      type="button"
      class="provider-btn w-10 object-contain opacity-60 dark:invert"
      data-provider="github"
      title="Coming soon"
      aria-label="GitHub sign in coming soon"
      disabled
    >
      <SimpleIcon name="github" size="xl" class="provider-icon provider-icon-color" />

      <span class="provider-label hidden md:block">GitHub</span>
    </button>
  </Tooltip>
</div>

<style>
  .auth-providers {
    width: 100%;
  }

  @media (max-width: 639px) {
    .auth-providers {
      gap: 0.375rem;
    }
  }

  .provider-btn {
    position: relative;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: pointer;
    border: 2px solid transparent;
    border-radius: 1rem;
    background: transparent;
    padding: 0.875rem;
    width: 4.5rem;
    min-width: 4.5rem;
    overflow: hidden;
  }

  .provider-btn::before {
    position: absolute;
    opacity: 0;
    -webkit-mask:
      linear-gradient(#fff 0 0) content-box,
      linear-gradient(#fff 0 0);
    -webkit-mask-composite: xor;
    mask-composite: exclude;
    transition: opacity 0.3s;
    inset: 0;
    border-radius: 1rem;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    padding: 2px;
    content: "";
  }

  .provider-btn:hover::before,
  .provider-btn:focus::before {
    opacity: 1;
  }

  .provider-btn:hover:not(:disabled),
  .provider-btn:focus:not(:disabled) {
    transform: translateY(-2px);
    border-color: rgba(59, 130, 246, 0.2);
    background: rgba(59, 130, 246, 0.05);
  }

  .provider-btn:disabled {
    opacity: 0.75;
    cursor: not-allowed;
  }

  .provider-icon {
    flex-shrink: 0;
    width: 1.75rem;
    height: 1.75rem;
    /* filter: grayscale(100%) opacity(0.6);
    transition: filter 0.3s cubic-bezier(0.4, 0, 0.2, 1); */
  }

  .provider-btn:hover:not(:disabled) .provider-icon,
  .provider-btn:focus:not(:disabled) .provider-icon {
    filter: grayscale(0%) opacity(1);
  }

  .provider-btn:disabled .provider-icon {
    filter: grayscale(100%) opacity(0.6);
  }

  /* For monochrome icons (phone, email) - show color by default like Google */
  .provider-btn[data-provider="phone"] .provider-icon,
  .provider-btn[data-provider="email"] .provider-icon {
    filter: grayscale(0%) opacity(0.6);
    color: #4b5563;
  }

  .provider-btn[data-provider="phone"]:hover:not(:disabled) .provider-icon,
  .provider-btn[data-provider="phone"]:focus:not(:disabled) .provider-icon {
    color: #3b82f6;
  }

  .provider-btn[data-provider="email"]:hover:not(:disabled) .provider-icon,
  .provider-btn[data-provider="email"]:focus:not(:disabled) .provider-icon {
    color: #8b5cf6;
  }

  /* Dark mode for GitHub icon */
  :global(.dark) .provider-btn[data-provider="github"] .provider-icon path {
    fill: #ffffff;
  }

  :global(.dark) .provider-btn[data-provider="github"]:hover .provider-icon path,
  :global(.dark) .provider-btn[data-provider="github"]:focus .provider-icon path {
    fill: #ffffff;
  }

  .provider-label {
    transition: color 0.3s;
    max-width: 100%;
    overflow: hidden;
    color: rgb(107, 114, 128);
    font-weight: 500;
    font-size: 0.7rem;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .provider-btn:hover:not(:disabled) .provider-label,
  .provider-btn:focus:not(:disabled) .provider-label {
    color: rgb(59, 130, 246);
  }

  .provider-btn:disabled .provider-label {
    opacity: 0.5;
  }

  :global(.dark) .provider-label {
    color: rgb(156, 163, 175);
  }

  :global(.dark) .provider-btn:hover:not(:disabled) .provider-label,
  :global(.dark) .provider-btn:focus:not(:disabled) .provider-label {
    color: rgb(147, 197, 253);
  }

  /* Size down icons and spacing for < sm */
  @media (max-width: 639px) {
    .provider-btn {
      gap: 0.25rem;
      padding: 0.5rem;
      width: 3rem;
      min-width: 3rem;
    }

    .provider-icon {
      width: 1.25rem;
      height: 1.25rem;
    }

    .provider-label {
      font-size: 0.625rem;
    }
  }
</style>

<script>
  // Handle provider button clicks
  document.addEventListener("DOMContentLoaded", () => {
    const providerButtons = document.querySelectorAll(".provider-btn");

    providerButtons.forEach((button) => {
      button.addEventListener("click", (e) => {
        const target = e.currentTarget;

        // Don't handle clicks on disabled buttons
        if (target.disabled) {
          return;
        }

        const provider = target.dataset.provider;
        console.log(`üîê Auth provider clicked: ${provider}`);

        // Handle specific providers
        switch (provider) {
          case "phone":
            window.location.href = "/auth/otp-login";
            break;
          case "email":
            window.location.href = "/auth/otp-login";
            break;
          case "google": {
            const handleGoogle = window.handleGoogleSignup;
            if (typeof handleGoogle === "function") {
              handleGoogle(e);
            } else {
              window.location.href = "/auth/login?provider=google";
            }
            break;
          }
          case "facebook":
          case "slack":
          case "github":
            // These are disabled, so this shouldn't be reached
            console.log(`${provider} auth coming soon`);
            break;
        }
      });
    });
  });
</script>
