---
interface Props {
  id?: string;
  name?: string;
  value?: string;
  placeholder?: string;
  required?: boolean;
  showSMS?: boolean;
  smsChecked?: boolean;
  selectedCarrier?: string;
  class?: string;
}

const {
  id = "phone",
  name = "phone",
  value = "",
  placeholder = "(555) 123-4567",
  required = false,
  showSMS = true,
  smsChecked = false,
  selectedCarrier = "",
  class: className = "",
} = Astro.props;

import SlotMachineModal from "../../components/form/SlotMachineModal.astro";

// Generate unique IDs for SMS components
const smsSectionId = `sms-section-${id}`;
const smsAlertsId = `sms-alerts-${id}`;
const carrierSelectionId = `carrier-selection-${id}`;
const mobileCarrierId = `mobile-carrier-${id}`;

const mobileCarrierOptions = [
  { value: "att", label: "AT&T" },
  { value: "verizon", label: "Verizon" },
  { value: "spectrum", label: "Spectrum" },
  { value: "tmobile", label: "T-Mobile" },
  { value: "sprint", label: "Sprint" },
];
---

<div class="space-y-4">
  <!-- Phone Number Input -->
  <div>
    <label for={id} class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300">
      Phone Number {required && <span class="text-red-500">*</span>}
    </label>
    <div class="relative">
      <input
        type="tel"
        id={id}
        name={name}
        value={value}
        placeholder={placeholder}
        required={required}
        class={`w-full rounded-lg border border-gray-300 px-3 py-2 pr-10 text-sm focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-60 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:focus:border-blue-400 ${className}`}
      />

      <!-- Phone validation indicator -->
      <div id={`phone-indicator-${id}`} class="absolute inset-y-0 right-0 items-center pr-3 hidden">
        <svg class="h-4 w-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
          <path
            fill-rule="evenodd"
            d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
            clip-rule="evenodd"></path>
        </svg>
      </div>
    </div>
  </div>

  <!-- SMS Alerts Section (only show if showSMS is true) -->
  {
    showSMS && (
      <div id={smsSectionId} style="display: none;">
        {/* <!-- SMS Alerts Toggle --> */}
        <label class="inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            id={smsAlertsId}
            name="sms_alerts"
            class="sr-only peer"
            checked={smsChecked}
          />
          <div class="relative w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600 dark:peer-checked:bg-blue-600" />
          <span class="ml-3 text-sm font-medium text-gray-900 dark:text-white">
            Get SMS Project Updates?
          </span>
        </label>

        {/* <!-- Carrier Selection (shown when SMS alerts is enabled) --> */}
        <div id={carrierSelectionId} class="hidden">
          {/* <label
            for={mobileCarrierId}
            class="mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"
          >
            Mobile Carrier
          </label> */}

          <SlotMachineModal
            title="Select your carrier"
            id={mobileCarrierId}
            name="mobile_carrier"
            options={mobileCarrierOptions}
            selectedValue={selectedCarrier}
            theme="blue"
          />

          {/* <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            Required for SMS delivery. We'll use your phone number with your carrier's email-to-SMS
            gateway.
          </p> */}
        </div>
      </div>
    )
  }
</div>

<script
  define:vars={{
    phoneId: id,
    smsSectionId,
    smsAlertsId,
    carrierSelectionId,
    showSMS,
  }}
>
  document.addEventListener("DOMContentLoaded", function () {
    if (!showSMS) return;

    const phoneInput = document.getElementById(phoneId);
    const smsAlertsCheckbox = document.getElementById(smsAlertsId);
    const carrierSelection = document.getElementById(carrierSelectionId);
    const smsSection = document.getElementById(smsSectionId);
    const phoneIndicator = document.getElementById(`phone-indicator-${phoneId}`);

    if (!phoneInput || !smsAlertsCheckbox || !carrierSelection || !smsSection) return;

    // Show/hide carrier selection based on SMS alerts toggle
    function toggleCarrierSelection() {
      if (smsAlertsCheckbox.checked) {
        carrierSelection.classList.remove("hidden");
        document.getElementById("mobile-carrier-phone").click();
      } else {
        carrierSelection.classList.add("hidden");
      }
    }

    // Validate phone number format
    function isValidPhoneNumber(phone) {
      // Remove all non-digit characters
      const digits = phone.replace(/\D/g, "");
      // Check if it's a valid US phone number (10 digits)
      return digits.length === 10;
    }

    // Show/hide SMS section based on valid phone number
    function toggleSmsSection() {
      const phoneValue = phoneInput.value.trim();
      const isValid = isValidPhoneNumber(phoneValue);

      if (isValid) {
        smsSection.style.display = "block";
        // Show validation indicator
        if (phoneIndicator) {
          phoneIndicator.classList.remove("hidden");
          phoneIndicator.classList.add("flex");
        }
      } else {
        smsSection.style.display = "none";
        // Hide validation indicator
        if (phoneIndicator) {
          phoneIndicator.classList.add("hidden");
          phoneIndicator.classList.remove("flex");
        }
        // Also uncheck SMS alerts if phone is invalid
        smsAlertsCheckbox.checked = false;
        toggleCarrierSelection();
      }
    }

    // Initial state
    toggleSmsSection();
    toggleCarrierSelection();

    // Event listeners
    smsAlertsCheckbox.addEventListener("change", toggleCarrierSelection);
    phoneInput.addEventListener("input", toggleSmsSection);
  });
</script>
