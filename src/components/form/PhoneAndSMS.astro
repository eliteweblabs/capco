---
interface Props {
  id?: string;
  name?: string;
  value?: string;
  placeholder?: string;
  required?: boolean;
  showSMS?: boolean;
  smsChecked?: boolean;
  selectedCarrier?: string;
  class?: string;
  globalInputClasses?: string;
  hideLabel?: boolean;
}

const {
  id = "phone",
  name = "phone",
  value = "",
  placeholder = "(555) 123-4567",
  required = false,
  showSMS = true,
  smsChecked = false,
  selectedCarrier = "",
  class: className = "",
  globalInputClasses = "",
  hideLabel = false,
} = Astro.props;

import SlotMachineModalStaff from "../../components/form/SlotMachineModalStaff.astro";
import SlideToggle from "../common/SlideToggle.astro";
import Alert from "../partials/Alert.astro";
import { SMS_UTILS } from "../../lib/sms-utils";
import { validatePhone, formatPhoneAsYouType } from "../../lib/phone-validation";

// Generate unique IDs for SMS components
const smsSectionId = `sms-section-${id}`;
const smsAlertsId = `sms-alerts-${id}`;
const carrierSelectionId = `carrier-selection-${id}`;
const mobileCarrierId = `mobile-carrier-${id}`;

// Use SMS utilities for carrier options
const mobileCarrierOptions = SMS_UTILS.CARRIERS.map((carrier: any) => ({
  value: carrier.id, // Use carrier ID for database storage
  label: carrier.name,
}));
---

<!-- Phone Number Input -->
<div>
  <label
    for={id}
    class={hideLabel
      ? "sr-only"
      : "mb-1 block text-sm font-medium text-gray-700 dark:text-gray-300"}
  >
    Phone Number {required && <span class="text-red-500">*</span>}
  </label>
  <div class="relative">
    <input
      type="tel"
      {id}
      {name}
      {value}
      {placeholder}
      {required}
      autocomplete="tel"
      class=`${globalInputClasses} ${className}`
    />

    <!-- Phone validation indicator -->
    <div id={`phone-indicator-${id}`} class="absolute inset-y-0 right-0 hidden items-center pr-3">
      <svg class="h-4 w-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
        <path
          fill-rule="evenodd"
          d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
          clip-rule="evenodd"></path>
      </svg>
    </div>
  </div>
</div>

<!-- SMS Alerts Section (only show if showSMS is true) -->
{
  showSMS && (
    <div id={smsSectionId} class={value ? "" : "hidden"}>
      {/* <!-- SMS Alerts Toggle --> */}
      <div class="flex items-center gap-3 pt-4">
        <div class="flex-1">
          <SlideToggle
            id={smsAlertsId}
            name="smsAlerts"
            checked={smsChecked}
            label="Get SMS Project Updates?"
          />
        </div>
      </div>
      {/* <!-- Carrier Selection (shown when SMS alerts is enabled) --> */}
      <div id={carrierSelectionId} class={smsChecked ? "" : "hidden"}>
        <div class="flex items-center gap-3 pt-4">
          <div class="flex-1">
            {/* <!-- Carrier Selection Modal --> */}

            <SlotMachineModalStaff
              title="Select your carrier"
              id={mobileCarrierId}
              name="mobileCarrier"
              options={mobileCarrierOptions}
              selectedValue={selectedCarrier}
              buttonClass="w-full"
              placeholder="Select your carrier..."
              icon="wifi"
              buttonVariant="outline"
              globalInputClasses={globalInputClasses}
            />
          </div>
        </div>
        <div class="flex items-center gap-3 pt-4">
          <div class="flex-1">
            <Alert
              title="Project updates only, not for marketing or promotional messages"
              description=""
            />
          </div>
        </div>
      </div>
    </div>
  )
}

<script
  is:inline
  data-phone-id={id}
  data-sms-section-id={smsSectionId}
  data-sms-alerts-id={smsAlertsId}
  data-carrier-selection-id={carrierSelectionId}
  data-show-sms={showSMS.toString()}
>
  (function () {
    var script = document.currentScript;
    var phoneId = script && script.getAttribute("data-phone-id");
    var smsSectionId = script && script.getAttribute("data-sms-section-id");
    var smsAlertsId = script && script.getAttribute("data-sms-alerts-id");
    var carrierSelectionId = script && script.getAttribute("data-carrier-selection-id");
    var showSMS = script && script.getAttribute("data-show-sms") === "true";

    document.addEventListener("DOMContentLoaded", function () {
      if (!showSMS || !phoneId) return;

      var phoneInput = document.getElementById(phoneId);
      var smsAlertsCheckbox = document.getElementById(smsAlertsId);
      var carrierSelection = document.getElementById(carrierSelectionId);
      var smsSection = document.getElementById(smsSectionId);
      var phoneIndicator = document.getElementById("phone-indicator-" + phoneId);

      if (!phoneInput || !smsAlertsCheckbox || !carrierSelection || !smsSection) return;

      var isUserInteraction = false;

      function toggleCarrierSelection() {
        if (smsAlertsCheckbox.checked) {
          carrierSelection.classList.remove("hidden");
          if (isUserInteraction) {
            var carrierButton = document.getElementById("mobile-carrier-" + phoneId);
            if (carrierButton) carrierButton.click();
          }
        } else {
          carrierSelection.classList.add("hidden");
        }
      }

      function validatePhoneNumber(phone) {
        if (!phone || phone.trim() === "") return false;
        var fn = window["validatePhone"];
        return typeof fn === "function" ? fn(phone) : false;
      }

      function formatPhone(value) {
        var fn = window["formatPhoneAsYouType"];
        return typeof fn === "function" ? fn(value) : value;
      }

      function toggleSmsSection() {
        var phoneValue = phoneInput.value.trim();
        var isValid = validatePhoneNumber(phoneValue);
        if (isValid || phoneValue) {
          smsSection.classList.remove("hidden");
          if (phoneIndicator && isValid) {
            phoneIndicator.classList.remove("hidden");
            phoneIndicator.classList.add("flex");
          } else if (phoneIndicator) {
            phoneIndicator.classList.add("hidden");
            phoneIndicator.classList.remove("flex");
          }
        } else {
          smsSection.classList.add("hidden");
          if (phoneIndicator) {
            phoneIndicator.classList.add("hidden");
            phoneIndicator.classList.remove("flex");
          }
          smsAlertsCheckbox.checked = false;
          toggleCarrierSelection();
        }
      }

      function handlePhoneInput() {
        var cursorPos = phoneInput.selectionStart || 0;
        var formattedValue = formatPhone(phoneInput.value);
        phoneInput.value = formattedValue;
        if (formattedValue.length >= cursorPos) {
          phoneInput.setSelectionRange(cursorPos, cursorPos);
        }
        toggleSmsSection();
      }

      if (phoneInput.value.trim()) {
        phoneInput.value = formatPhone(phoneInput.value);
      }
      if (phoneInput.value.trim() || smsAlertsCheckbox.checked) {
        smsSection.classList.remove("hidden");
        toggleSmsSection();
      }
      toggleCarrierSelection();
      isUserInteraction = true;
      smsAlertsCheckbox.addEventListener("change", toggleCarrierSelection);
      phoneInput.addEventListener("input", handlePhoneInput);
    });
  })();
</script>
