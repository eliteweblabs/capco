---
// Line Item Selector Component
// Allows users to search and select from catalog items or create new ones
interface Props {
  invoiceId?: string;
  onItemAdded?: string; // JavaScript callback function name
  showAddToInvoice?: boolean;
}

const { invoiceId, onItemAdded = "onLineItemAdded", showAddToInvoice = true } = Astro.props;
---

<div class="line-item-selector mb-4 rounded-lg border border-gray-200 bg-white p-4 shadow-sm">
  <!-- Header -->
  <div class="mb-4 flex items-center justify-between">
    <h3 class="text-lg font-semibold text-gray-900">Add Line Item</h3>
    <button
      type="button"
      id="toggle-create-new"
      class="text-sm font-medium text-blue-600 hover:text-blue-800"
    >
      + Create New Item
    </button>
  </div>

  <!-- Search Existing Items -->
  <div id="search-section" class="space-y-4">
    <!-- Search Input -->
    <div class="relative">
      <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
        <i class="bx bx-search text-gray-400"></i>
      </div>
      <input
        type="text"
        id="catalog-search"
        placeholder="Search line items..."
        class="w-full rounded-lg border border-gray-300 py-2 pl-10 pr-4 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
      />
    </div>

    <!-- Category Filter -->
    <div class="flex items-center space-x-4">
      <select
        id="category-filter"
        class="rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
      >
        <option value="">All Categories</option>
        <option value="Design Services">Design Services</option>
        <option value="Consulting">Consulting</option>
        <option value="Inspection">Inspection</option>
        <option value="Testing">Testing</option>
        <option value="Safety Equipment">Safety Equipment</option>
      </select>

      <button
        type="button"
        id="clear-filters"
        class="px-3 py-1 text-sm text-gray-600 hover:text-gray-800"
      >
        Clear Filters
      </button>
    </div>

    <!-- Search Results -->
    <div id="search-results" class="max-h-60 space-y-2 overflow-y-auto">
      <div id="search-loading" class="hidden py-4 text-center">
        <i class="bx bx-loader-alt animate-spin text-xl text-gray-400"></i>
        <p class="mt-2 text-sm text-gray-600">Searching...</p>
      </div>
      <div id="search-empty" class="hidden py-4 text-center">
        <i class="bx bx-search text-2xl text-gray-400"></i>
        <p class="mt-2 text-sm text-gray-600">No items found. Try a different search term.</p>
      </div>
    </div>
  </div>

  <!-- Create New Item Form -->
  <div id="create-section" class="hidden space-y-4">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <div>
        <label for="new-item-name" class="mb-1 block text-sm font-medium text-gray-700">
          Item Name *
        </label>
        <input
          type="text"
          id="new-item-name"
          required
          class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., Fire Alarm System Design"
        />
      </div>

      <div>
        <label for="new-item-price" class="mb-1 block text-sm font-medium text-gray-700">
          Unit Price *
        </label>
        <div class="relative">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <span class="text-gray-500 sm:text-sm">$</span>
          </div>
          <input
            type="number"
            id="new-item-price"
            required
            min="0"
            step="0.01"
            class="w-full rounded-lg border border-gray-300 py-2 pl-8 pr-3 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
            placeholder="0.00"
          />
        </div>
      </div>
    </div>

    <div>
      <label for="new-item-category" class="mb-1 block text-sm font-medium text-gray-700">
        Category
      </label>
      <select
        id="new-item-category"
        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
      >
        <option value="">Select Category</option>
        <option value="Design Services">Design Services</option>
        <option value="Consulting">Consulting</option>
        <option value="Inspection">Inspection</option>
        <option value="Testing">Testing</option>
        <option value="Safety Equipment">Safety Equipment</option>
      </select>
    </div>

    <div>
      <label for="new-item-description" class="mb-1 block text-sm font-medium text-gray-700">
        Description *
      </label>
      <textarea
        id="new-item-description"
        required
        rows="3"
        class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
        placeholder="Detailed description of the service or item..."></textarea>
    </div>

    <div class="flex items-center justify-between">
      <button
        type="button"
        id="cancel-create"
        class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200"
      >
        Cancel
      </button>
      <button
        type="button"
        id="save-new-item"
        class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-700"
      >
        <i class="bx bx-save mr-1"></i>
        Save to Catalog
      </button>
    </div>
  </div>
</div>

<!-- Add Item Modal (for quantity selection) -->
<div
  id="add-item-modal"
  class="fixed inset-0 z-50 hidden h-full w-full overflow-y-auto bg-gray-600 bg-opacity-50"
>
  <div class="relative top-20 mx-auto w-96 rounded-md border bg-white p-5 shadow-lg">
    <div class="mt-3">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-lg font-semibold text-gray-900">Add to Invoice</h3>
        <button type="button" id="close-modal" class="text-gray-400 hover:text-gray-600">
          <i class="bx bx-x text-xl"></i>
        </button>
      </div>

      <div id="modal-item-details" class="mb-4 rounded-lg bg-gray-50 p-3">
        <!-- Item details will be populated here -->
      </div>

      <div class="space-y-4">
        <div>
          <label for="item-quantity" class="mb-1 block text-sm font-medium text-gray-700">
            Quantity
          </label>
          <input
            type="number"
            id="item-quantity"
            value="1"
            min="1"
            step="1"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
          />
        </div>

        <div>
          <label for="custom-description" class="mb-1 block text-sm font-medium text-gray-700">
            Custom Description (optional)
          </label>
          <textarea
            id="custom-description"
            rows="3"
            class="w-full rounded-lg border border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-2 focus:ring-blue-500"
            placeholder="Leave blank to use default description..."></textarea>
        </div>
      </div>

      <div class="mt-6 flex items-center justify-between">
        <button
          type="button"
          id="modal-cancel"
          class="rounded-lg bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-200"
        >
          Cancel
        </button>
        <button
          type="button"
          id="modal-add-item"
          class="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white transition-colors hover:bg-blue-700"
        >
          <i class="bx bx-plus mr-1"></i>
          Add to Invoice
        </button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ invoiceId, onItemAdded, showAddToInvoice }}>
  class LineItemSelector {
    constructor() {
      console.log("üîç [LINE-ITEM-SELECTOR] Constructor called with:", {
        invoiceId,
        onItemAdded,
        showAddToInvoice,
      });

      this.invoiceId = invoiceId;
      this.onItemAdded = onItemAdded;
      this.showAddToInvoice = showAddToInvoice;
      this.selectedItem = null;
      this.searchTimeout = null;

      this.initializeEventListeners();
      this.loadInitialItems();
    }

    initializeEventListeners() {
      // Toggle between search and create sections
      document.getElementById("toggle-create-new")?.addEventListener("click", () => {
        this.toggleCreateSection();
      });

      document.getElementById("cancel-create")?.addEventListener("click", () => {
        this.showSearchSection();
      });

      // Search functionality
      document.getElementById("catalog-search")?.addEventListener("input", (e) => {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(() => {
          this.searchItems(e.target.value);
        }, 300);
      });

      document.getElementById("category-filter")?.addEventListener("change", (e) => {
        this.searchItems(document.getElementById("catalog-search")?.value || "", e.target.value);
      });

      document.getElementById("clear-filters")?.addEventListener("click", () => {
        document.getElementById("catalog-search").value = "";
        document.getElementById("category-filter").value = "";
        this.loadInitialItems();
      });

      // Create new item
      document.getElementById("save-new-item")?.addEventListener("click", () => {
        this.createNewItem();
      });

      // Modal functionality
      document.getElementById("close-modal")?.addEventListener("click", () => {
        this.closeModal();
      });

      document.getElementById("modal-cancel")?.addEventListener("click", () => {
        this.closeModal();
      });

      document.getElementById("modal-add-item")?.addEventListener("click", () => {
        this.addItemToInvoice();
      });

      // Close modal when clicking outside
      document.getElementById("add-item-modal")?.addEventListener("click", (e) => {
        if (e.target.id === "add-item-modal") {
          this.closeModal();
        }
      });
    }

    async loadInitialItems() {
      console.log("üîç [LINE-ITEM-SELECTOR] Loading initial items...");
      await this.searchItems("", "");
    }

    async searchItems(searchTerm = "", category = "") {
      const loadingEl = document.getElementById("search-loading");
      const emptyEl = document.getElementById("search-empty");
      const resultsEl = document.getElementById("search-results");

      // Show loading
      loadingEl?.classList.remove("hidden");
      emptyEl?.classList.add("hidden");

      try {
        const params = new URLSearchParams();
        if (searchTerm) params.append("search", searchTerm);
        if (category) params.append("category", category);
        params.append("limit", "15");

        // Search through existing line items in the current proposal
        const data = await this.searchExistingLineItems(searchTerm, category);

        loadingEl?.classList.add("hidden");

        if (!data.success) {
          console.error("Error loading catalog items:", data.error);
          return;
        }

        this.renderSearchResults(data.items || []);
      } catch (error) {
        console.error("Error searching catalog items:", error);
        loadingEl?.classList.add("hidden");
      }
    }

    renderSearchResults(items) {
      console.log("üîç [LINE-ITEM-SELECTOR] Rendering search results:", items);
      const resultsEl = document.getElementById("search-results");
      const emptyEl = document.getElementById("search-empty");

      console.log("üîç [LINE-ITEM-SELECTOR] Results element:", resultsEl);
      console.log("üîç [LINE-ITEM-SELECTOR] Empty element:", emptyEl);

      if (!resultsEl) {
        console.error("üîç [LINE-ITEM-SELECTOR] No search-results element found!");
        return;
      }

      if (items.length === 0) {
        console.log("üîç [LINE-ITEM-SELECTOR] No items to render, showing empty state");
        resultsEl.innerHTML = "";
        emptyEl?.classList.remove("hidden");
        return;
      }

      console.log("üîç [LINE-ITEM-SELECTOR] Rendering", items.length, "items");
      emptyEl?.classList.add("hidden");

      resultsEl.innerHTML = items
        .map(
          (item) => `
        <div class="catalog-item border border-gray-200 rounded-lg p-3 hover:border-blue-300 hover:shadow-sm transition-all cursor-pointer"
             data-item='${JSON.stringify(item)}'>
          <div class="flex items-start justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2 mb-1">
                <h4 class="font-medium text-gray-900">${this.escapeHtml(item.name)}</h4>
                ${item.category ? `<span class="px-2 py-1 text-xs bg-blue-100 text-blue-800 rounded-full">${this.escapeHtml(item.category)}</span>` : ""}
              </div>
              <p class="text-sm text-gray-600 mb-2">${this.escapeHtml(item.description)}</p>
              <div class="flex items-center justify-between">
                <span class="text-lg font-semibold text-green-600">$${parseFloat(item.unit_price).toFixed(2)}</span>
                ${item.usage_count ? `<span class="text-xs text-gray-500">Used ${item.usage_count} times</span>` : ""}
              </div>
            </div>
            ${
              this.showAddToInvoice && this.invoiceId
                ? `
              <button class="add-item-btn ml-3 px-3 py-1 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="bx bx-plus mr-1"></i>Add to Invoice
              </button>
            `
                : this.onItemAdded
                  ? `
              <button class="add-item-btn ml-3 px-3 py-1 text-sm bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
                <i class="bx bx-plus mr-1"></i>Add
              </button>
            `
                  : ""
            }
          </div>
        </div>
      `
        )
        .join("");

      // Add click listeners to items and buttons
      const catalogItems = resultsEl.querySelectorAll(".catalog-item");
      console.log(
        "üîç [LINE-ITEM-SELECTOR] Found",
        catalogItems.length,
        "catalog items to attach listeners to"
      );

      catalogItems.forEach((itemEl, index) => {
        const addBtn = itemEl.querySelector(".add-item-btn");
        console.log(`üîç [LINE-ITEM-SELECTOR] Item ${index}:`, {
          hasAddBtn: !!addBtn,
          itemData: itemEl.dataset.item,
        });

        if (addBtn) {
          addBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            const item = JSON.parse(itemEl.dataset.item);
            console.log("üîç [LINE-ITEM-SELECTOR] Add button clicked for item:", item);

            if (this.showAddToInvoice && this.invoiceId) {
              // Invoice mode - show modal for quantity/description
              this.showAddItemModal(item);
            } else if (this.onItemAdded) {
              // Proposal mode - directly call callback
              this.addItemToProposal(item);
            }
          });
        } else {
          console.warn(`üîç [LINE-ITEM-SELECTOR] No add button found for item ${index}`);
        }
      });
    }

    showAddItemModal(item) {
      console.log("üîç [LINE-ITEM-SELECTOR] Showing add item modal for:", item);
      this.selectedItem = item;
      const modal = document.getElementById("add-item-modal");
      const detailsEl = document.getElementById("modal-item-details");

      console.log("üîç [LINE-ITEM-SELECTOR] Modal element:", modal);
      console.log("üîç [LINE-ITEM-SELECTOR] Details element:", detailsEl);

      if (detailsEl) {
        detailsEl.innerHTML = `
          <div class="flex items-center justify-between mb-2">
            <h5 class="font-medium text-gray-900">${this.escapeHtml(item.name)}</h5>
            <span class="text-lg font-semibold text-green-600">$${parseFloat(item.unit_price).toFixed(2)}</span>
          </div>
          <p class="text-sm text-gray-600">${this.escapeHtml(item.description)}</p>
        `;
      }

      // Reset form
      document.getElementById("item-quantity").value = "1";
      document.getElementById("custom-description").value = "";

      modal?.classList.remove("hidden");
      console.log("üîç [LINE-ITEM-SELECTOR] Modal should now be visible");
    }

    closeModal() {
      document.getElementById("add-item-modal")?.classList.add("hidden");
      this.selectedItem = null;
    }

    addItemToProposal(item) {
      console.log("üîç [LINE-ITEM-SELECTOR] Adding item to proposal:", item);

      // Call the callback function if provided
      if (typeof window[this.onItemAdded] === "function") {
        console.log(
          "üîç [LINE-ITEM-SELECTOR] Calling proposal callback function:",
          this.onItemAdded
        );
        window[this.onItemAdded](item);
      } else {
        console.warn("üîç [LINE-ITEM-SELECTOR] Callback function not found:", this.onItemAdded);
      }
    }

    async addItemToInvoice() {
      console.log("üîç [LINE-ITEM-SELECTOR] addItemToInvoice called");
      console.log("üîç [LINE-ITEM-SELECTOR] selectedItem:", this.selectedItem);
      console.log("üîç [LINE-ITEM-SELECTOR] invoiceId:", this.invoiceId);

      if (!this.selectedItem || !this.invoiceId) {
        console.error("üîç [LINE-ITEM-SELECTOR] Missing selectedItem or invoiceId");
        return;
      }

      const quantity = document.getElementById("item-quantity")?.value || 1;
      const customDescription = document.getElementById("custom-description")?.value.trim();

      console.log("üîç [LINE-ITEM-SELECTOR] Request data:", {
        invoice_id: this.invoiceId,
        catalog_item_id: this.selectedItem.id,
        quantity: parseFloat(quantity),
        custom_description: customDescription || null,
      });

      try {
        const response = await fetch("/api/add-catalog-item-to-invoice", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            invoice_id: this.invoiceId,
            catalog_item_id: this.selectedItem.id,
            quantity: parseFloat(quantity),
            custom_description: customDescription || null,
          }),
        });

        console.log("üîç [LINE-ITEM-SELECTOR] API response status:", response.status);
        const data = await response.json();
        console.log("üîç [LINE-ITEM-SELECTOR] API response data:", data);

        if (data.success) {
          this.closeModal();

          // Call the callback function if provided
          if (typeof window[this.onItemAdded] === "function") {
            console.log("üîç [LINE-ITEM-SELECTOR] Calling callback function:", this.onItemAdded);
            window[this.onItemAdded](data.line_item);
          } else {
            console.log("üîç [LINE-ITEM-SELECTOR] No callback function found:", this.onItemAdded);
          }

          // Show success message
          this.showMessage("Line item added successfully!", "success");
        } else {
          console.error("üîç [LINE-ITEM-SELECTOR] API returned error:", data.error);
          this.showMessage(data.error || "Failed to add line item", "error");
        }
      } catch (error) {
        console.error("üîç [LINE-ITEM-SELECTOR] Error adding item to invoice:", error);
        this.showMessage("Failed to add line item", "error");
      }
    }

    async createNewItem() {
      const name = document.getElementById("new-item-name")?.value.trim();
      const price = document.getElementById("new-item-price")?.value;
      const category = document.getElementById("new-item-category")?.value.trim();
      const description = document.getElementById("new-item-description")?.value.trim();

      if (!name || !price || !description) {
        this.showMessage("Please fill in all required fields", "error");
        return;
      }

      try {
        // Call the catalog API to create the new item
        const response = await fetch("/api/line-items-catalog", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            name,
            description,
            unit_price: parseFloat(price),
            category: category || null,
          }),
        });

        const data = await response.json();

        if (data.success) {
          // Clear form
          document.getElementById("new-item-name").value = "";
          document.getElementById("new-item-price").value = "";
          document.getElementById("new-item-category").value = "";
          document.getElementById("new-item-description").value = "";

          this.showSearchSection();
          this.showMessage("New catalog item created successfully!", "success");

          // Refresh search results
          this.loadInitialItems();
        } else {
          this.showMessage(data.error || "Failed to create catalog item", "error");
        }
      } catch (error) {
        console.error("Error creating catalog item:", error);
        this.showMessage("Failed to create catalog item", "error");
      }
    }

    async searchExistingLineItems(searchTerm, category) {
      try {
        // Call the actual catalog API
        const params = new URLSearchParams();
        if (searchTerm) params.append("search", searchTerm);
        if (category && category !== "all") params.append("category", category);
        params.append("limit", "15");

        const response = await fetch(`/api/line-items-catalog?${params.toString()}`);
        const data = await response.json();

        if (!data.success) {
          console.error("Error fetching catalog items:", data.error);
          return { success: false, error: data.error, items: [] };
        }

        const items = data.items || [];

        // Get existing line items from the current proposal
        const tbody = document.getElementById("proposal-line-items");
        console.log("üîç [LINE-ITEM-SELECTOR] Searching for existing items in tbody:", tbody);

        if (tbody) {
          const rows = tbody.querySelectorAll("tr");
          console.log("üîç [LINE-ITEM-SELECTOR] Found rows:", rows.length);

          rows.forEach((row, index) => {
            const cells = row.querySelectorAll("td");
            console.log(`üîç [LINE-ITEM-SELECTOR] Row ${index} has ${cells.length} cells`);

            if (cells.length >= 3) {
              const description = cells[0]?.textContent?.trim() || "";
              const quantity = cells[1]?.textContent?.trim() || "1";
              const price = cells[2]?.textContent?.trim() || "0";

              console.log(
                `üîç [LINE-ITEM-SELECTOR] Row ${index}: "${description}", qty: ${quantity}, price: ${price}`
              );

              // Filter by search term if provided
              if (searchTerm && !description.toLowerCase().includes(searchTerm.toLowerCase())) {
                return;
              }

              if (description && description !== "-" && description !== "") {
                items.push({
                  id: `existing-${index}`,
                  name: description,
                  description: description,
                  unit_price: parseFloat(price.replace(/[$,]/g, "")) || 0,
                  quantity: parseFloat(quantity) || 1,
                  category: "existing",
                  is_existing: true,
                });
                console.log(`‚úÖ [LINE-ITEM-SELECTOR] Added existing item: "${description}"`);
              }
            }
          });
        } else {
          console.log("‚ùå [LINE-ITEM-SELECTOR] No tbody found with id 'proposal-line-items'");
        }

        console.log(`üéØ [LINE-ITEM-SELECTOR] Total catalog items found: ${items.length}`);
        return { success: true, items: items };
      } catch (error) {
        console.error("Error searching existing line items:", error);
        return { success: false, error: error.message, items: [] };
      }
    }

    toggleCreateSection() {
      const searchSection = document.getElementById("search-section");
      const createSection = document.getElementById("create-section");
      const toggleBtn = document.getElementById("toggle-create-new");

      if (createSection?.classList.contains("hidden")) {
        searchSection?.classList.add("hidden");
        createSection?.classList.remove("hidden");
        toggleBtn.textContent = "‚Üê Back to Search";
      } else {
        this.showSearchSection();
      }
    }

    showSearchSection() {
      const searchSection = document.getElementById("search-section");
      const createSection = document.getElementById("create-section");
      const toggleBtn = document.getElementById("toggle-create-new");

      searchSection?.classList.remove("hidden");
      createSection?.classList.add("hidden");
      toggleBtn.textContent = "+ Create New Item";
    }

    showMessage(message, type = "info") {
      // Create a simple toast notification
      const toast = document.createElement("div");
      toast.className = `fixed top-4 right-4 px-4 py-2 rounded-lg text-white z-50 transition-all duration-300 ${
        type === "success" ? "bg-green-600" : type === "error" ? "bg-red-600" : "bg-blue-600"
      }`;
      toast.textContent = message;

      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = "0";
        setTimeout(() => {
          document.body.removeChild(toast);
        }, 300);
      }, 3000);
    }

    escapeHtml(text) {
      if (!text || typeof text !== "string") {
        return "";
      }
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#039;",
      };
      return text.replace(/[&<>"']/g, function (m) {
        return map[m];
      });
    }
  }

  // Initialize when DOM is loaded
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", () => {
      console.log("üîç [LINE-ITEM-SELECTOR] Initializing LineItemSelector on DOMContentLoaded");
      new LineItemSelector();
    });
  } else {
    console.log("üîç [LINE-ITEM-SELECTOR] Initializing LineItemSelector immediately");
    new LineItemSelector();
  }
</script>

<style>
  .catalog-item:hover {
    transform: translateY(-1px);
  }
</style>
