---
/**
 * BannerAlertsLoader Component
 * Automatically loads and displays all active banner alerts from the database
 * Include this component in your layout to show site-wide banners
 */

import { supabaseAdmin } from "../../../lib/supabase-admin";
import BannerAlert from "./BannerAlert.astro";

interface Props {
  position?: "top" | "bottom" | "all";
}

const { position = "all" } = Astro.props;

// Fetch active banner alerts
let banners: any[] = [];

if (supabaseAdmin) {
  const now = new Date().toISOString();

  let query = supabaseAdmin
    .from("bannerAlerts")
    .select("*")
    .eq("isActive", true)
    .or(`startDate.is.null,startDate.lte.${now}`)
    .or(`endDate.is.null,endDate.gte.${now}`)
    .order("createdAt", { ascending: false });

  if (position !== "all") {
    query = query.eq("position", position);
  }

  const { data, error } = await query;

  if (error) {
    console.error("Error fetching banner alerts:", error);
  } else {
    banners = data || [];
  }
}

// Group banners by position
const topBanners = banners.filter((b) => b.position === "top");
const bottomBanners = banners.filter((b) => b.position === "bottom");

// Get all banner IDs for early dismiss check
const allBannerIds = banners.map((b) => String(b.id));
---

<!-- 
  CRITICAL: This script must run BEFORE banners render to prevent layout shift.
  It injects CSS to hide dismissed banners immediately, before they cause page hop.
-->
<script is:inline define:vars={{ allBannerIds }}>
  (function() {
    try {
      const stored = localStorage.getItem("dismissedBanners");
      if (stored) {
        const dismissed = JSON.parse(stored);
        // Create a style element to hide dismissed banners IMMEDIATELY
        const style = document.createElement("style");
        style.id = "banner-dismiss-styles";
        let css = "";
        allBannerIds.forEach(function(id) {
          if (dismissed.includes(id) || dismissed.includes(String(id))) {
            css += `.banner-alert[data-banner-id="${id}"] { display: none !important; }\n`;
          }
        });
        if (css) {
          style.textContent = css;
          // Insert at the start of head for highest priority
          document.head.insertBefore(style, document.head.firstChild);
        }
      }
    } catch (e) {
      // Ignore localStorage errors
    }
  })();
</script>

{
  topBanners.length > 0 && (position === "all" || position === "top") && (
    <div class="banner-alerts-top fixed top-0 left-0 right-0 z-[9999]" id="top-banner-container">
      {topBanners.map((banner) => (
        <BannerAlert
          id={banner.id}
          type={banner.type}
          title={banner.title}
          description={banner.description}
          position="top"
          expireMs={banner.expireMs}
          dismissible={banner.dismissible}
        />
      ))}
    </div>
  )
}

{
  topBanners.length > 0 && (position === "all" || position === "top") && (
    <script is:inline>
      // Adjust navbar position based on top banner height
      (function() {
        function adjustNavbarForBanners() {
          const topBannerContainer = document.getElementById("top-banner-container");
          // Try multiple selectors to find the navbar
          const navbar = document.querySelector("nav.fixed") || document.querySelector("nav[class*='fixed']");

          if (topBannerContainer && navbar) {
            const updateNavbarPosition = function() {
              const bannerHeight = topBannerContainer.offsetHeight;
              // Get actual navbar height dynamically
              const navbarHeight = navbar.offsetHeight || 64;

              if (bannerHeight > 0) {
                navbar.style.top = bannerHeight + "px";
                // Also adjust main content padding
                const mainContent = document.getElementById("main-content");
                if (mainContent) {
                  mainContent.style.paddingTop = (bannerHeight + navbarHeight) + "px";
                }
              } else {
                navbar.style.top = "0";
                const mainContent = document.getElementById("main-content");
                if (mainContent) {
                  mainContent.style.paddingTop = navbarHeight + "px";
                }
              }
            };

            // Initial adjustment
            updateNavbarPosition();

            // Update on resize for responsive changes
            window.addEventListener("resize", updateNavbarPosition);

            // Watch for banner dismissals
            const observer = new MutationObserver(function() {
              setTimeout(updateNavbarPosition, 350); // After animation
            });

            observer.observe(topBannerContainer, {
              childList: true,
              subtree: true,
              attributes: true,
              attributeFilter: ["style"]
            });
          }
        }

        // Run immediately if DOM is ready, otherwise wait
        if (document.readyState === "loading") {
          document.addEventListener("DOMContentLoaded", adjustNavbarForBanners);
        } else {
          // Small delay to ensure banner is rendered
          setTimeout(adjustNavbarForBanners, 10);
        }
        
        // Also run on Astro page transitions
        document.addEventListener("astro:page-load", adjustNavbarForBanners);
      })();
    </script>
  )
}

{
  bottomBanners.length > 0 && (position === "all" || position === "bottom") && (
    <div class="banner-alerts-bottom">
      {bottomBanners.map((banner) => (
        <BannerAlert
          id={banner.id}
          type={banner.type}
          title={banner.title}
          description={banner.description}
          position="bottom"
          expireMs={banner.expireMs}
          dismissible={banner.dismissible}
        />
      ))}
    </div>
  )
}
