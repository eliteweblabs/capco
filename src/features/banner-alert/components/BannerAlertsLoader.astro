---
/**
 * BannerAlertsLoader Component
 * Automatically loads and displays all active banner alerts from the database
 * Include this component in your layout to show site-wide banners
 */

import { supabaseAdmin } from "../../../lib/supabase-admin";
import BannerAlert from "./BannerAlert.astro";

interface Props {
  position?: "top" | "bottom" | "all";
  width?: "full" | "auto";
  /** Current pathname (e.g. from Astro.url.pathname). Used to filter banners by targetPages. */
  pathname?: string;
}

const { position = "all", width = "full", pathname } = Astro.props;

// Fetch active banner alerts
let banners: any[] = [];

if (supabaseAdmin) {
  const now = new Date().toISOString();

  let query = supabaseAdmin
    .from("bannerAlerts")
    .select("*")
    .eq("isActive", true)
    .or(`startDate.is.null,startDate.lte.${now}`)
    .or(`endDate.is.null,endDate.gte.${now}`)
    .order("createdAt", { ascending: false });

  if (position !== "all") {
    query = query.eq("position", position);
  }

  const { data, error } = await query;

  if (error) {
    console.error("Error fetching banner alerts:", error);
  } else {
    banners = data || [];
  }
}

// Filter by target pages when pathname is provided
const currentSlug = pathname ? pathname.replace(/^\//, "").split("/")[0] || "" : null;
const filteredBanners =
  pathname && currentSlug !== ""
    ? banners.filter((b) => {
        const target = (b.targetPages || "").trim();
        if (!target) return true; // no targeting = show on all pages
        const slugs = target.split(",").map((s: string) => s.trim().toLowerCase()).filter(Boolean);
        return slugs.includes(currentSlug.toLowerCase());
      })
    : banners;

// Group banners by position; only show banners that have content (avoid empty "space" from bad data)
const hasContent = (b: { content?: string | null }) => (b.content ?? "").trim().length > 0;
const topBanners = filteredBanners.filter((b) => b.position === "top" && hasContent(b));
const bottomBanners = filteredBanners.filter((b) => b.position === "bottom" && hasContent(b));

// Debug logging
// console.log("[BannerAlertsLoader] Total banners:", banners.length);
// console.log("[BannerAlertsLoader] Top banners:", topBanners.length);
// console.log("[BannerAlertsLoader] Bottom banners:", bottomBanners.length);
// console.log("[BannerAlertsLoader] Position filter:", position);

// Get all banner IDs for early dismiss check (use filtered so hidden banners stay hidden)
const allBannerIds = filteredBanners.map((b) => String(b.id));
---

<!-- 
  CRITICAL: This script must run BEFORE banners render to prevent layout shift.
  It injects CSS to hide dismissed banners immediately, before they cause page hop.
-->
<script is:inline define:vars={{ allBannerIds }}>
  (function() {
    try {
      const stored = localStorage.getItem("dismissedBanners");
      if (stored) {
        const dismissed = JSON.parse(stored);
        // Create a style element to hide dismissed banners IMMEDIATELY
        const style = document.createElement("style");
        style.id = "banner-dismiss-styles";
        let css = "";
        allBannerIds.forEach(function(id) {
          if (dismissed.includes(id) || dismissed.includes(String(id))) {
            css += `.banner-alert[data-banner-id="${id}"] { display: none !important; }\n`;
          }
        });
        if (css) {
          style.textContent = css;
          // Insert at the start of head for highest priority
          document.head.insertBefore(style, document.head.firstChild);
        }
      }
    } catch (e) {
      // Ignore localStorage errors
    }
  })();
</script>

{
  topBanners.length > 0 && (position === "all" || position === "top") && (
    <div class={`z-50 flex flex-col ${width === "full" ? "w-full" : ""}`} id="top-banner-container">
      {topBanners.map((banner) => (
        <BannerAlert
          id={banner.id}
          type={banner.type}
          title=""
          description={banner.content ?? ""}
          position="top"
          expireMs={banner.expireMs}
          dismissible={banner.dismissible}
          width={width}
        />
      ))}
    </div>
  )
}


{
  bottomBanners.length > 0 && (position === "all" || position === "bottom") && (
    <div class="banner-alerts-bottom fixed bottom-0 left-0 right-0 z-[60] flex flex-col" id="bottom-banner-container">
      {bottomBanners.map((banner) => (
        <BannerAlert
          id={banner.id}
          type={banner.type}
          title=""
          description={banner.content ?? ""}
          position="bottom"
          expireMs={banner.expireMs}
          dismissible={banner.dismissible}
        />
      ))}
    </div>
  )
}

<script>
  import { MOBILE_MEDIA_QUERY } from "../../../lib/ux-utils";
  (function () {
    const remPx = () => parseFloat(getComputedStyle(document.documentElement).fontSize) || 16;
    const isMobile = () => window.matchMedia(MOBILE_MEDIA_QUERY).matches;
    const THRESH = 8;

    /** Re-apply dismiss styles from localStorage after SPA swap (inline script only runs on first load). */
    function applyDismissStylesFromStorage() {
      try {
        const stored = localStorage.getItem("dismissedBanners");
        if (!stored) return;
        const dismissed = JSON.parse(stored);
        const dismissedSet = new Set(dismissed.map((id: unknown) => String(id)));
        const banners = document.querySelectorAll(".banner-alert[data-banner-id]");
        let css = "";
        banners.forEach((el) => {
          const id = el.getAttribute("data-banner-id");
          if (id && dismissedSet.has(id)) {
            css += `.banner-alert[data-banner-id="${id}"] { display: none !important; }\n`;
          }
        });
        if (!css) return;
        let styleEl = document.getElementById("banner-dismiss-styles");
        if (!styleEl) {
          styleEl = document.createElement("style");
          styleEl.id = "banner-dismiss-styles";
          document.head.insertBefore(styleEl, document.head.firstChild);
        }
        styleEl.textContent = css;
      } catch (_) {
        // ignore
      }
    }

    function getDismissedSet() {
      let dismissedSet = new Set<string>();
      try {
        const stored = localStorage.getItem("dismissedBanners");
        if (stored) {
          const dismissed = JSON.parse(stored);
          dismissedSet = new Set(dismissed.map((id: unknown) => String(id)));
        }
      } catch { /* ignore localStorage errors */ }
      return dismissedSet;
    }

    function updateBannerOffsets() {
      const scrollEl = document.getElementById("reveal-scroll");
      const sidebar = document.getElementById("sidebar");
      if (!scrollEl) return;

      const rem = remPx();
      const off = (window as any).__revealSidebarOffsets || { topPx: 4 * rem, topBannersOnlyPx: 0, bottomPx: 4 * rem };
      (window as any).__revealSidebarOffsets = off;

      const topBannerContainer = document.getElementById("top-banner-container");
      const bottomBannerContainer = document.getElementById("bottom-banner-container");
      const dismissedSet = getDismissedSet();
      // Use navbar-content only (the bar); top-banner-container is inside main-navbar so main-navbar height would include alerts
      const navbarContent = document.getElementById("navbar-content");
      const navbarBarHeight = navbarContent ? (navbarContent as HTMLElement).offsetHeight : 4 * rem;

      let topAlertsHeight = 0;
      if (topBannerContainer) {
        const topBanners = topBannerContainer.querySelectorAll(".banner-alert");
        let visibleCount = 0;
        topBanners.forEach((banner) => {
          const id = banner.getAttribute("data-banner-id");
          if (!id || !dismissedSet.has(id)) visibleCount++;
        });
        topBannerContainer.style.display = visibleCount > 0 ? "" : "none";
        topAlertsHeight = visibleCount > 0 ? topBannerContainer.offsetHeight : 0;

        const baseHeight = navbarBarHeight;
        const totalTopHeight = baseHeight + topAlertsHeight;
        off.topPx = totalTopHeight;
        off.topBannersOnlyPx = topAlertsHeight;
        scrollEl.style.marginTop = totalTopHeight + "px";
        scrollEl.style.height = "calc(100dvh - " + totalTopHeight + "px)";
        if (isMobile()) {
          const dynamicHeightEls = document.querySelectorAll('[data-dynamic-height="true"]');
          dynamicHeightEls.forEach((el) => {
            (el as HTMLElement).style.transition = (el as HTMLElement).style.transition || "margin-top 0.3s ease-in-out";
            (el as HTMLElement).style.marginTop = totalTopHeight + "px";
          });
          if (sidebar) {
            (sidebar as HTMLElement).style.height = "calc(100dvh - 4rem - " + topAlertsHeight + "px)";
          }
        } else {
          if (sidebar) (sidebar as HTMLElement).style.height = "";
        }
      } else {
        off.topBannersOnlyPx = 0;
        const baseHeight = navbarBarHeight;
        off.topPx = baseHeight;
        scrollEl.style.marginTop = baseHeight + "px";
        scrollEl.style.height = "calc(100dvh - " + baseHeight + "px)";
        if (isMobile()) {
          if (sidebar) (sidebar as HTMLElement).style.height = "calc(100dvh - 4rem)";
        } else {
          if (sidebar) (sidebar as HTMLElement).style.height = "";
        }
      }

      let bottomBannerHeight = 0;
      if (bottomBannerContainer) {
        const bottomBanners = bottomBannerContainer.querySelectorAll(".banner-alert");
        let visibleCount = 0;
        bottomBanners.forEach((banner) => {
          const id = banner.getAttribute("data-banner-id");
          if (!id || !dismissedSet.has(id)) visibleCount++;
        });
        bottomBannerContainer.style.display = visibleCount > 0 ? "" : "none";
        bottomBannerHeight = visibleCount > 0 ? bottomBannerContainer.offsetHeight : 0;
        const footerEl = document.querySelector("footer");
        if (bottomBannerHeight > 0) {
          document.body.style.paddingBottom = bottomBannerHeight + "px";
          if (footerEl) (footerEl as HTMLElement).style.marginBottom = bottomBannerHeight + "px";
        } else {
          document.body.style.paddingBottom = "";
          if (footerEl) (footerEl as HTMLElement).style.marginBottom = "";
        }
        off.bottomPx = 4 * rem + bottomBannerHeight;
      }
    }

    let prevScrollTop = 0;
    let translateY = 0;

    function run() {
      const scrollEl = document.getElementById("reveal-scroll");
      if (!scrollEl) return;

      const navbarContent = document.getElementById("navbar-content");
      const footer = document.getElementById("reveal-footer");
      const sidebar = document.getElementById("sidebar");
      const REM = Math.max((navbarContent as HTMLElement)?.offsetHeight ?? 4 * 16, (footer as HTMLElement)?.offsetHeight ?? 4 * 16) / 16;
      const maxPx = () => REM * remPx();

      function clampedScrollTop() {
        const maxScroll = Math.max(0, scrollEl.scrollHeight - scrollEl.clientHeight);
        return Math.max(0, Math.min(maxScroll, scrollEl.scrollTop));
      }

      function setSidebarPosition(translateYVal: number) {
        const side = document.getElementById("sidebar");
        if (!side) return;
        const off = (window as any).__revealSidebarOffsets;
        const topPx = off?.topPx ?? 4 * remPx();
        const topBannersOnlyPx = off?.topBannersOnlyPx ?? 0;
        (side as HTMLElement).style.bottom = "";
        (side as HTMLElement).style.top = (translateYVal <= THRESH ? topPx : topBannersOnlyPx) + "px";
      }

      function updateTranslate() {
        const scrollTop = clampedScrollTop();

        if (!isMobile()) {
          scrollEl.style.transform = "";
          prevScrollTop = 0;
          translateY = 0;
          setSidebarPosition(0);
          return;
        }
        const deltaY = scrollTop - prevScrollTop;
        prevScrollTop = scrollTop;
        translateY += deltaY;
        translateY = Math.max(0, Math.min(maxPx(), translateY));
        scrollEl.style.transform = `translateY(-${translateY}px)`;
        setSidebarPosition(translateY);
      }

      updateBannerOffsets();

      if (!isMobile()) {
        scrollEl.style.transform = "";
        translateY = 0;
        setSidebarPosition(0);
      }

      if (navbarContent) {
        const ro = new ResizeObserver(() => requestAnimationFrame(updateBannerOffsets));
        ro.observe(navbarContent);
      }
      function recalcAfterBannerDismissed() {
        setTimeout(() => {
          updateBannerOffsets();
          setSidebarPosition(translateY);
        }, 350);
      }

      const topContainer = document.getElementById("top-banner-container");
      const bottomContainer = document.getElementById("bottom-banner-container");
      const observe = (el: Element | null) => {
        if (!el) return;
        new MutationObserver(recalcAfterBannerDismissed).observe(el, {
          childList: true,
          subtree: true,
          attributes: true,
          attributeFilter: ["style", "class"],
        });
      };
      observe(topContainer);
      observe(bottomContainer);
      window.addEventListener("resize", updateBannerOffsets);
      document.addEventListener("astro:page-load", () => requestAnimationFrame(updateBannerOffsets));

      // SPA: re-apply dismiss styles after swap so expired/dismissed banners stay hidden
      document.addEventListener("astro:after-swap", () => {
        requestAnimationFrame(() => {
          applyDismissStylesFromStorage();
          updateBannerOffsets();
        });
      });
      document.addEventListener("astro:page-load", () => {
        requestAnimationFrame(applyDismissStylesFromStorage);
      });

      if (isMobile()) {
        prevScrollTop = clampedScrollTop();
        translateY = Math.min(prevScrollTop, maxPx());
        updateTranslate();
      }

      if (!(scrollEl as HTMLElement).dataset.revealInit) {
        (scrollEl as HTMLElement).dataset.revealInit = "true";
        window.addEventListener("resize", () => {
          prevScrollTop = clampedScrollTop();
          translateY = Math.max(0, Math.min(maxPx(), prevScrollTop));
          updateTranslate();
          if (isMobile() && !(scrollEl as HTMLElement).dataset.revealScrollAdded) {
            (scrollEl as HTMLElement).dataset.revealScrollAdded = "true";
            scrollEl.addEventListener("scroll", updateTranslate, { passive: true });
          }
        });
      }
      if (isMobile() && !(scrollEl as HTMLElement).dataset.revealScrollAdded) {
        (scrollEl as HTMLElement).dataset.revealScrollAdded = "true";
        scrollEl.addEventListener("scroll", updateTranslate, { passive: true });
      }
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", () => setTimeout(run, 10));
    } else {
      setTimeout(run, 10);
    }
    document.addEventListener("astro:page-load", () => requestAnimationFrame(run));
  })();
</script>
