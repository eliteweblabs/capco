---
/**
 * BannerAlert Component
 * Displays a site-wide banner alert with position and expiration settings
 * Top banners push header down, bottom banners push footer up
 */
export const partial = true;

import Alert from "../../../components/partials/Alert.astro";
import CloseButton from "../../../components/ui/CloseButton.astro";

interface Props {
  id?: number;
  type?: "info" | "success" | "warning" | "error";
  title?: string;
  description?: string;
  position?: "top" | "bottom";
  expireMs?: number | null; // null = never expires
  dismissible?: boolean;
  class?: string;
  width?: "full" | "auto";
}

const {
  id,
  type = "info",
  title,
  description,
  position = "top",
  expireMs = null,
  dismissible = true,
  class: className = "",
  width = "full",
} = Astro.props;
---

<div
  class={`banner-alert relative ${className} `}
  data-banner-id={id}
  data-expire-ms={expireMs}
  data-position={position}
>
  <div class="pointer-events-none -z-0 w-full opacity-40" aria-hidden="true"></div>
  <Alert {type} {title} {description} class="relative z-10" />
  {
    dismissible && (
      <div class="banner-dismiss absolute right-0 top-1/2 z-10 -translate-y-1/2">
        <CloseButton tooltipText="Dismiss" />
      </div>
    )
  }
</div>

<script>
  class BannerAlertManager {
    private static instance: BannerAlertManager;
    private dismissedBanners: Set<string>;

    constructor() {
      this.dismissedBanners = this.loadDismissedBanners();
      this.init();
    }

    static getInstance(): BannerAlertManager {
      if (!BannerAlertManager.instance) {
        BannerAlertManager.instance = new BannerAlertManager();
      }
      return BannerAlertManager.instance;
    }

    private loadDismissedBanners(): Set<string> {
      try {
        const stored = localStorage.getItem("dismissedBanners");
        return stored ? new Set(JSON.parse(stored)) : new Set();
      } catch {
        return new Set();
      }
    }

    private saveDismissedBanners(): void {
      try {
        localStorage.setItem("dismissedBanners", JSON.stringify([...this.dismissedBanners]));
      } catch {
        // Ignore storage errors
      }
    }

    private init(): void {
      document.querySelectorAll(".banner-alert").forEach((banner) => {
        const element = banner as HTMLElement;
        const bannerId = element.dataset.bannerId;
        const expireMs = element.dataset.expireMs;

        // Check if already dismissed
        if (bannerId && this.dismissedBanners.has(bannerId)) {
          element.style.display = "none";
          return;
        }

        // Setup auto-expire
        if (expireMs && expireMs !== "null" && parseInt(expireMs) > 0) {
          setTimeout(() => {
            this.dismissBanner(element);
          }, parseInt(expireMs));
        }

        // Setup dismiss button
        const dismissBtn = element.querySelector(".banner-dismiss");
        if (dismissBtn) {
          dismissBtn.addEventListener("click", () => {
            this.dismissBanner(element);
          });
        }
      });
    }

    private dismissBanner(element: HTMLElement): void {
      const bannerId = element.dataset.bannerId;
      const position = element.dataset.position;

      // Animate out
      element.style.transition =
        "max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out";
      element.style.opacity = "0";
      element.style.maxHeight = "0";
      element.style.overflow = "hidden";
      element.style.marginTop = "0";
      element.style.marginBottom = "0";

      setTimeout(() => {
        element.style.display = "none";
      }, 300);

      // Save dismissal
      if (bannerId) {
        this.dismissedBanners.add(bannerId);
        this.saveDismissedBanners();
      }
    }
  }

  // Initialize on page load
  document.addEventListener("DOMContentLoaded", () => {
    BannerAlertManager.getInstance();
  });

  // SPA disabled: Re-initialize on Astro page transitions
  // document.addEventListener("astro:page-load", () => {
  //   BannerAlertManager.getInstance();
  // });
</script>
