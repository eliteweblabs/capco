---
/**
 * VAPI Chat Widget - Simple Default Setup
 * Clean implementation with default Vapi button
 */

import { globalCompanyData } from "../../pages/api/global/global-company-data";

interface Props {
  assistantId?: string;
  publicKey?: string;
  basic?: boolean;
  primaryColor?: string;
  secondaryColor?: string;
  globalCompanyName?: string;
  theme?: "light" | "dark";
}

// Get company data from database
const companyData = await globalCompanyData();

const {
  assistantId = import.meta.env.PUBLIC_VAPI_ASSISTANT_ID || "",
  publicKey = import.meta.env.PUBLIC_VAPI_KEY || "",
  basic = false,
  primaryColor = Astro.props.primaryColor || companyData.primaryColor || "#000000",
  secondaryColor = Astro.props.secondaryColor || companyData.secondaryColor || "#000000",
  globalCompanyName = Astro.props.globalCompanyName || companyData.globalCompanyName || "",
} = Astro.props;

const themeCookie = Astro.cookies.get("theme");
const theme = themeCookie?.value || "light";
const baseBgColor = theme === "dark" ? "#ffffff" : "#000000";
const fgColor = theme === "dark" ? "#000000" : "#ffffff";
---

{
  basic && publicKey && assistantId && (
    <>
      <!-- Load VAPI script from local copy (CDN is blocked) -->
      <script
        src="/js/vapi-widget.umd.js"
        defer
        type="text/javascript"
        id="vapi-widget-script"
      />

      <vapi-widget
        id="vapi-widget-basic"
        public-key={publicKey}
        assistant-id={assistantId}
        mode="chat"
        base-bg-color=""
        theme={theme}
        accent-color={primaryColor}
        cta-button-color={baseBgColor}
        cta-button-text-color={fgColor}
        border-radius="large"
        size="compact"
        position="bottom-right"
        title="Live"
        start-button-text="Start"
        end-button-text="End Call"
        chat-first-message={`Hi, this is Leah with ${globalCompanyName}. How can I help you today?`}
        chat-placeholder="Type your message..."
        voice-show-transcript="true"
        consent-required="false"
        consent-title="Terms and conditions"
        consent-content="By clicking Agree, and each time I interact with this AI agent, I consent to the recording, storage, and sharing of my communications with third-party service providers, and as otherwise described in our Terms of Service."
        consent-storage-key="vapi_widget_consent"
      />

      <script>
        // VAPI Widget Error Handling and Request Monitoring
        (function() {
          const LOG_PREFIX = '[VAPI-WIDGET]';
          let requestFailureCount = 0;
          const MAX_FAILURES = 100; // Increased threshold - VAPI makes many polling requests
          let widgetDisabled = false;
          let lastErrorTime = 0;
          const ERROR_THROTTLE = 10000; // Only log errors every 10 seconds
          let successfulRequests = 0;
          
          console.log(LOG_PREFIX, 'üöÄ Initializing VAPI widget monitoring...');
          
          // Wait for script to load
          const scriptElement = document.getElementById('vapi-widget-script');
          if (scriptElement) {
            scriptElement.addEventListener('load', () => {
              console.log(LOG_PREFIX, '‚úÖ Widget script loaded successfully');
              checkWidgetInitialization();
            });
            
            scriptElement.addEventListener('error', (e) => {
              console.error(LOG_PREFIX, '‚ùå Widget script failed to load:', e);
              if (window.showNotice) {
                window.showNotice('error', 'Chat Unavailable', 'Failed to load chat widget script. Please check your internet connection.', 8000);
              }
            });
          }
          
          // Wait for widget element
          let initAttempts = 0;
          const MAX_INIT_ATTEMPTS = 30; // Increased attempts
          
          const initWidget = setInterval(() => {
            initAttempts++;
            const widget = document.getElementById('vapi-widget-basic');
            
            if (widget || initAttempts >= MAX_INIT_ATTEMPTS) {
              clearInterval(initWidget);
              
              if (widget) {
                console.log(LOG_PREFIX, '‚úÖ Widget element found');
                
                // Monitor widget errors
                widget.addEventListener('error', (e) => {
                  console.error(LOG_PREFIX, '‚ùå Widget error event:', e);
                });
                
                // Check if widget initialized
                setTimeout(() => checkWidgetInitialization(), 2000);
              } else {
                console.warn(LOG_PREFIX, '‚ö†Ô∏è Widget element not found after', MAX_INIT_ATTEMPTS, 'attempts');
                console.warn(LOG_PREFIX, '‚ö†Ô∏è This usually means environment variables are not set');
              }
            }
          }, 500);

          function checkWidgetInitialization() {
            const widget = document.getElementById('vapi-widget-basic');
            if (!widget) {
              console.error(LOG_PREFIX, '‚ùå Widget element not found');
              return;
            }
            
            if (typeof (window as any).Vapi !== 'undefined') {
              console.log(LOG_PREFIX, '‚úÖ window.Vapi is available');
            }
            
            if ((widget as any).shadowRoot) {
              console.log(LOG_PREFIX, '‚úÖ Widget initialized with shadow DOM');
            } else {
              console.warn(LOG_PREFIX, '‚ö†Ô∏è Widget has no shadow DOM yet, may still be initializing');
            }
          }

          // Monitor fetch requests with improved logic
          const originalFetch = window.fetch;
          window.fetch = async function(...args) {
            const url = args[0];
            const isVapiRequest = typeof url === 'string' && 
              (url.includes('vapi') || url.includes('api.vapi.ai'));
            
            if (widgetDisabled && isVapiRequest) {
              return Promise.reject(new Error('Widget disabled due to excessive failures'));
            }
            
            try {
              const response = await originalFetch.apply(this, args);
              
              // Track successful VAPI requests
              if (response.ok && isVapiRequest) {
                successfulRequests++;
                
                // Reset failure count after successful requests
                if (requestFailureCount > 0 && successfulRequests > 5) {
                  const prevCount = requestFailureCount;
                  requestFailureCount = 0;
                  console.log(LOG_PREFIX, `‚úÖ ${successfulRequests} successful requests, resetting failure count (was ${prevCount})`);
                }
              }
              
              // Log non-OK responses (but don't count as failures immediately)
              if (!response.ok && isVapiRequest) {
                const now = Date.now();
                if (now - lastErrorTime > ERROR_THROTTLE) {
                  console.warn(LOG_PREFIX, `‚ö†Ô∏è Request returned ${response.status}:`, url);
                  lastErrorTime = now;
                }
              }
              
              return response;
            } catch (error) {
              if (isVapiRequest) {
                requestFailureCount++;
                
                const now = Date.now();
                if (now - lastErrorTime > ERROR_THROTTLE) {
                  console.error(LOG_PREFIX, `‚ùå Request failed (${requestFailureCount}/${MAX_FAILURES}):`, (error as Error).message, url);
                  lastErrorTime = now;
                }
                
                // Only disable after many consecutive failures
                if (requestFailureCount >= MAX_FAILURES) {
                  widgetDisabled = true;
                  console.error(LOG_PREFIX, '‚ùå Too many consecutive failures, disabling widget');
                  
                  const widget = document.getElementById('vapi-widget-basic');
                  if (widget) {
                    (widget as HTMLElement).style.display = 'none';
                  }
                  
                  if (window.showNotice) {
                    window.showNotice('error', 'Chat Service Unavailable', 'The chat service is temporarily unavailable. Please try refreshing the page or contact us directly.', 10000);
                  }
                }
              }
              
              throw error;
            }
          };
          
          // Final check after page fully loads
          window.addEventListener('load', () => {
            setTimeout(() => {
              const widget = document.getElementById('vapi-widget-basic');
              if (widget) {
                if ((widget as any).shadowRoot || typeof (window as any).Vapi !== 'undefined') {
                  console.log(LOG_PREFIX, '‚úÖ Widget fully loaded and initialized');
                } else {
                  console.warn(LOG_PREFIX, '‚ö†Ô∏è Widget present but may not be initialized');
                  console.warn(LOG_PREFIX, '‚ö†Ô∏è Check VAPI account status and credentials');
                }
              } else {
                console.error(LOG_PREFIX, '‚ùå Widget not found - check environment variables');
              }
            }, 3000);
          });
        })();
      </script>
    </>
  )
}
