---
/**
 * VAPI Chat Widget - Simple Default Setup
 * Clean implementation with default Vapi button
 */

import { globalCompanyData } from "../../pages/api/global/global-company-data";

interface Props {
  assistantId?: string;
  publicKey?: string;
  basic?: boolean;
  primaryColor?: string;
  secondaryColor?: string;
  globalCompanyName?: string;
  theme?: "light" | "dark";
  currentUser?: any;
}

// Get company data from database
const companyData = await globalCompanyData();

const {
  assistantId = import.meta.env.PUBLIC_VAPI_ASSISTANT_ID || "",
  publicKey = import.meta.env.PUBLIC_VAPI_KEY || "",
  basic = false,
  primaryColor = Astro.props.primaryColor || companyData.primaryColor || "#000000",
  secondaryColor = Astro.props.secondaryColor || companyData.secondaryColor || "#000000",
  globalCompanyName = Astro.props.globalCompanyName || companyData.globalCompanyName || "",
  currentUser = null,
} = Astro.props;

const themeCookie = Astro.cookies.get("theme");
const theme = themeCookie?.value || "light";
const baseBgColor = theme === "dark" ? "#ffffff" : "#000000";
const fgColor = theme === "dark" ? "#000000" : "#ffffff";
---

{
  basic && publicKey && assistantId && (
    <>
      {/* Load VAPI script first with defer to ensure DOM is ready */}
      <script
        src="https://unpkg.com/@vapi-ai/client-sdk-react/dist/embed/widget.umd.js"
        defer
        type="text/javascript"
        id="vapi-widget-script"
      ></script>

      <vapi-widget
        id="vapi-widget-basic"
        public-key={publicKey}
        assistant-id={assistantId}
        assistant-overrides={currentUser ? JSON.stringify({
          variableValues: {
            userId: currentUser.id,
            userName: currentUser.user_metadata?.name || currentUser.email,
            userEmail: currentUser.email,
          },
          metadata: {
            userId: currentUser.id,
            userName: currentUser.user_metadata?.name || currentUser.email,
            userEmail: currentUser.email,
          }
        }) : undefined}
        mode="chat"
        base-bg-color=""
        theme={theme}
        accent-color={primaryColor}
        cta-button-color={baseBgColor}
        cta-button-text-color={fgColor}
        border-radius="large"
        size="compact"
        position="bottom-right"
        title="Live"
        start-button-text="Start"
        end-button-text="End Call"
        chat-first-message={`Hi, this is Leah with ${globalCompanyName}. How can I help you today?`}
        chat-placeholder="Type your message..."
        voice-show-transcript="true"
        consent-required="false"
        consent-title="Terms and conditions"
        consent-content="By clicking Agree, and each time I interact with this AI agent, I consent to the recording, storage, and sharing of my communications with third-party service providers, and as otherwise described in our Terms of Service."
        consent-storage-key="vapi_widget_consent"
      ></vapi-widget>

      <script is:inline>
        (function() {
          const LOG_PREFIX = '[VAPI-WIDGET]';
          let requestFailureCount = 0;
          const MAX_FAILURES = 50;
          let widgetDisabled = false;
          let lastErrorTime = 0;
          const ERROR_THROTTLE = 5000;
          
          let initAttempts = 0;
          const MAX_INIT_ATTEMPTS = 20;
          
          const initWidget = setInterval(() => {
            initAttempts++;
            const widget = document.getElementById('vapi-widget-basic');
            
            if (widget || initAttempts >= MAX_INIT_ATTEMPTS) {
              clearInterval(initWidget);
              
              if (widget) {
                console.log(LOG_PREFIX, '✅ Widget element found');
                widget.addEventListener('error', (e) => {
                  console.error(LOG_PREFIX, '❌ Widget error:', e);
                });
              } else {
                console.warn(LOG_PREFIX, '⚠️ Widget element not found after', MAX_INIT_ATTEMPTS, 'attempts');
              }
            }
          }, 500);

          const originalFetch = window.fetch;
          window.fetch = async function(...args) {
            const url = args[0];
            const isVapiRequest = typeof url === 'string' && 
              (url.includes('vapi') || url.includes('api.vapi.ai'));
            
            if (widgetDisabled && isVapiRequest) {
              return Promise.reject(new Error('Widget disabled due to excessive failures'));
            }
            
            try {
              const response = await originalFetch.apply(this, args);
              
              if (response.ok && isVapiRequest) {
                if (requestFailureCount > 0) {
                  console.log(LOG_PREFIX, '✅ Request succeeded, resetting failure count');
                  requestFailureCount = 0;
                }
              }
              
              if (!response.ok && isVapiRequest) {
                const now = Date.now();
                if (now - lastErrorTime > ERROR_THROTTLE) {
                  console.warn(LOG_PREFIX, `⚠️ Request returned ${response.status}:`, url);
                  lastErrorTime = now;
                }
              }
              
              return response;
            } catch (error) {
              if (isVapiRequest) {
                requestFailureCount++;
                
                const now = Date.now();
                if (now - lastErrorTime > ERROR_THROTTLE) {
                  console.error(LOG_PREFIX, `❌ Request failed (${requestFailureCount}/${MAX_FAILURES}):`, error.message);
                  lastErrorTime = now;
                }
                
                if (requestFailureCount >= MAX_FAILURES) {
                  widgetDisabled = true;
                  console.error(LOG_PREFIX, '❌ Too many failures, disabling widget');
                  
                  const widget = document.getElementById('vapi-widget-basic');
                  if (widget) {
                    widget.style.display = 'none';
                  }
                  
                  if (window.showNotice) {
                    window.showNotice('error', 'Chat Unavailable', 'The chat service is temporarily unavailable. Please try again later or contact us directly.', 8000);
                  }
                }
              }
              
              throw error;
            }
          };
          
          const scriptLoadTimeout = setTimeout(() => {
            const widget = document.getElementById('vapi-widget-basic');
            // Only show error if widget truly didn't load (no element at all)
            if (!widget) {
              console.error(LOG_PREFIX, '❌ Widget element not found after 30 seconds');
              if (window.showNotice) {
                window.showNotice('error', 'Chat Loading Failed', 'Unable to load chat widget. Please refresh the page.', 5000);
              }
            } else if (widget.shadowRoot || typeof window.Vapi !== 'undefined' || widget.getAttribute('public-key')) {
              // Widget loaded successfully, clear timeout
              console.log(LOG_PREFIX, '✅ Widget loaded and initialized');
              clearTimeout(scriptLoadTimeout);
            }
          }, 30000);
          
          window.addEventListener('load', () => {
            setTimeout(() => {
              const widget = document.getElementById('vapi-widget-basic');
              if (widget) {
                console.log(LOG_PREFIX, '✅ Widget loaded successfully');
                clearTimeout(scriptLoadTimeout);
              }
            }, 2000);
          });
        })();
      </script>
    </>
  )
}
