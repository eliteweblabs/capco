---
// Dynamic 3D Mapbox Component that reads from CMS and geocodes addresses
// Supports shortcode: <DynamicProjectsMap /> or <DynamicProjectsMap height="600px" />
// When used as shortcode with no projects prop, MarkdownPage injects featured projects (single query).
interface Props {
  projects?: any[] | string;
  height?: string;
  mapboxToken?: string;
}

const {
  projects: rawProjects,
  height = "500px",
  mapboxToken = import.meta.env.PUBLIC_MAPBOX_ACCESS_TOKEN ||
    import.meta.env.MAPBOX_PUBLIC_KEY ||
    "",
} = Astro.props;

// Normalize projects: support CMS shape (p.data), API shape (p.title/p.address), or JSON string from shortcode
const projects = (() => {
  let arr = rawProjects;
  if (typeof arr === "string") {
    try {
      arr = JSON.parse(arr);
    } catch {
      return [];
    }
  }
  if (!Array.isArray(arr)) return [];
  return arr.map((p: any) => ({
    title: p.data?.title ?? p.title ?? p.address ?? "Project",
    location: p.data?.location ?? p.address ?? p.title ?? "",
    excerpt: p.data?.excerpt ?? p.description ?? "",
    coordinates:
      p.data?.coordinates ??
      p.coordinates ??
      (p.lat != null && p.lng != null ? { lat: p.lat, lng: p.lng } : undefined),
  }));
})();

// Serialize projects data for client-side use
const projectsData = JSON.stringify(projects);
---

<!-- Mapbox GL JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v3.18.1/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.18.1/mapbox-gl.js"></script>

<div
  id="dynamic-projects-map"
  data-height={height}
  data-projects={projectsData}
  data-mapbox-token={mapboxToken}
>
</div>

<style>
  /* Prevent map pan/zoom from scrolling the page */
  #dynamic-projects-map {
    width: 100%;
    height: var(--map-height, 500px);
    border-radius: 0.5rem;
    overflow: hidden;
    overscroll-behavior: contain;
    touch-action: none; /* Map handles all touch; prevents page scroll during pan */
  }
  :global(#dynamic-projects-map .mapboxgl-map),
  :global(#dynamic-projects-map .mapboxgl-canvas-container),
  :global(#dynamic-projects-map .mapboxgl-canvas) {
    overscroll-behavior: contain;
  }
</style>

<script>
  // Geocoding function using Mapbox Geocoding API
  async function geocodeAddress(
    address: string,
    accessToken: string
  ): Promise<[number, number] | null> {
    if (!address?.trim()) return null;
    try {
      const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(address)}.json?access_token=${accessToken}&limit=1&country=US`;
      const response = await fetch(url);
      const data = await response.json();

      if (data.features && data.features.length > 0) {
        const [lng, lat] = data.features[0].center;
        return [lng, lat];
      }
      return null;
    } catch (error) {
      console.error("Geocoding error:", error);
      return null;
    }
  }

  // Initialize map
  async function initDynamicProjectsMap() {
    if (typeof (window as any).mapboxgl === "undefined") {
      setTimeout(initDynamicProjectsMap, 100);
      return;
    }

    const mapContainer = document.getElementById("dynamic-projects-map");
    if (!mapContainer) return;

    const height = mapContainer.getAttribute("data-height") || "500px";
    mapContainer.style.setProperty("--map-height", height);

    const projectsData = JSON.parse(mapContainer.getAttribute("data-projects") || "[]");
    const mapboxToken = mapContainer.getAttribute("data-mapbox-token") || "";

    if (!mapboxToken) {
      console.warn("üó∫Ô∏è [ROTHCO DYNAMIC MAP] No Mapbox token ‚Äì set PUBLIC_MAPBOX_ACCESS_TOKEN or MAPBOX_PUBLIC_KEY");
    }

    (window as any).mapboxgl.accessToken = mapboxToken;

    // Center on New England (Boston area)
    // Use streets-v11 (classic style) - avoids "Se[i.type] is not a constructor" from Standard style layer types
    const map = new (window as any).mapboxgl.Map({
      container: "dynamic-projects-map",
      style: "mapbox://styles/mapbox/streets-v11",
      center: [-71.0589, 42.3601],
      zoom: 9,
      pitch: 45,
      bearing: 0,
      antialias: true,
    });

    // Add navigation controls
    map.addControl(new (window as any).mapboxgl.NavigationControl(), "top-right");

    // Wait for map to load
    map.on("load", async () => {
      const bounds = new (window as any).mapboxgl.LngLatBounds();
      let markersAdded = 0;

      console.log(`üó∫Ô∏è [ROTHCO DYNAMIC MAP] Processing ${projectsData.length} projects`);

      // Process each project
      for (const project of projectsData) {
        const hasCoords = project.coordinates?.lng != null && project.coordinates?.lat != null;
        const hasLocation = project.location && String(project.location).trim();

        if (!hasCoords && !hasLocation) {
          console.warn(`üó∫Ô∏è [ROTHCO DYNAMIC MAP] Skipping "${project.title}" ‚Äì no location or coordinates`);
          continue;
        }

        let coordinates: [number, number] | null = null;

        // Use existing coordinates if available
        if (hasCoords) {
          coordinates = [project.coordinates.lng, project.coordinates.lat];
        }
        // Otherwise, geocode the location
        else if (hasLocation) {
          console.log(`üó∫Ô∏è Geocoding: ${project.location}`);
          coordinates = await geocodeAddress(project.location, mapboxToken);

          if (coordinates) {
            console.log(`‚úì Found coordinates for ${project.title}:`, coordinates);
          } else {
            console.warn(`‚úó Could not geocode: ${project.location}`);
          }
        }

        // Add marker if we have coordinates
        if (coordinates) {
          const marker = new (window as any).mapboxgl.Marker({
            color: "#D4A574", // Rothco Built primary color
          })
            .setLngLat(coordinates)
            .setPopup(
              new (window as any).mapboxgl.Popup({ offset: 25 }).setHTML(
                `<div style="padding: 8px;">
                  <h3 style="font-weight: bold; margin-bottom: 4px; font-size: 16px;">${project.title}</h3>
                  ${project.location ? `<p style="margin: 4px 0; font-size: 13px; color: #666;">${project.location}</p>` : ""}
                  ${project.excerpt ? `<p style="margin: 4px 0; font-size: 14px;">${project.excerpt}</p>` : ""}
                </div>`
              )
            )
            .addTo(map);

          bounds.extend(coordinates);
          markersAdded++;
        }
      }

      // Fit map to show all markers
      if (markersAdded > 0) {
        map.fitBounds(bounds, {
          padding: { top: 50, bottom: 50, left: 50, right: 50 },
          maxZoom: 12,
        });
      }

      console.log(`üó∫Ô∏è [ROTHCO DYNAMIC MAP] Loaded ${markersAdded} project locations`);
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initDynamicProjectsMap);
  } else {
    initDynamicProjectsMap();
  }
</script>
