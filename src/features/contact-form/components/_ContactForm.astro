---
// Multi-step contact form component with AOS animations
import Button from "../../../components/common/Button.astro";
import SimpleIcon from "../../../components/common/SimpleIcon.astro";
import InlineAddressSearch from "../../../components/form/InlineAddressSearch.astro";
import SlotMachineModalStaff from "../../../components/form/SlotMachineModalStaff.astro";
import { SMS_UTILS } from "../../../lib/sms-utils";

import { globalClasses } from "../../../pages/api/global/global-classes";
const { globalInputClasses } = globalClasses();
const appendedGlobalInputClasses = `${globalInputClasses} text-center`;

// Get carrier options for the modal
const mobileCarrierOptions = SMS_UTILS.CARRIERS.map((carrier: any) => ({
  value: carrier.id,
  label: carrier.name,
}));

// Button templates - change these props to customize all buttons at once
const nextButtonProps = {
  type: "button" as const,
  variant: "secondary" as const,
  size: "lg" as const,
  class: "next-step",
  icon: "arrow-right",
  iconPosition: "right" as const,
  iconClasses: "",
};

const prevButtonProps = {
  type: "button" as const,
  variant: "anchor" as const,
  size: "lg" as const,
  class: "prev-step",
  icon: "arrow-left",
  iconPosition: "left" as const,
  iconClasses: "m-0 md:ml-2",
};

const skipButtonProps = {
  type: "button" as const,
  variant: "secondary" as const,
  size: "lg" as const,
  class: "next-step",
};

const submitButtonProps = {
  type: "button" as const,
  variant: "primary" as const,
  size: "lg" as const,
  class: "submit-contact",
  icon: "send",
  iconPosition: "right" as const,
  iconClasses: "",
};
---

<div class="w-full max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
  <!-- Progress Bar -->
  <div class="mb-6 sm:mb-12">
    <div class="relative">
      <div class="h-2 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700">
        <div id="contact-progress-bar" class="h-full rounded-full bg-primary-500" style="width: 0%">
        </div>
      </div>
      <div class="mt-3 text-center">
        <span
          id="contact-progress-text"
          class="text-sm font-medium text-gray-600 dark:text-gray-400"
        >
          1 / 8
        </span>
      </div>
    </div>
  </div>

  <!-- Multi-step Form -->
  <form id="multi-step-contact-form" action="/api/contact/submit" method="post">
    <!-- Step 1: Name -->
    <div class="step-content active" data-step="1">
      <div class="space-y-8 sm:space-y-12 lg:space-y-16">
        <div class="text-center">
          <h2 class="text-5xl font-bold text-gray-900 dark:text-white">What's your name?</h2>
        </div>

        <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
          <div class="input-wrapper">
            <input
              type="text"
              name="firstName"
              id="contact-first-name"
              placeholder="John"
              required
              autocomplete="given-name"
              class={`${appendedGlobalInputClasses}`}
              data-error="Please enter your first name"
              autofocus={true}
            />
          </div>

          <div class="input-wrapper">
            <input
              type="text"
              name="lastName"
              id="contact-last-name"
              placeholder="Doe"
              required
              autocomplete="family-name"
              class={`${appendedGlobalInputClasses}`}
              data-error="Please enter your last name"
            />
          </div>
        </div>

        <div class="flex justify-end gap-3">
          <Button {...nextButtonProps} dataAttributes={{ "data-next": "2" }}> next </Button>
        </div>
      </div>
    </div>

    <!-- Step 2: Email -->
    <div class="step-content" data-step="2">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="text-5xl font-bold text-gray-900 dark:text-white">your email?</h2>
        </div>

        <div class="input-wrapper">
          <input
            type="email"
            name="email"
            id="contact-email"
            placeholder="your.email@example.com"
            required
            autocomplete="email"
            class={`${appendedGlobalInputClasses}`}
            data-error="Please enter a valid email address"
          />
        </div>

        <div class="flex justify-between gap-3">
          <Button {...prevButtonProps} dataAttributes={{ "data-prev": "1" }}>
            <span class="hidden md:block"> back </span>
          </Button>
          <Button {...nextButtonProps} dataAttributes={{ "data-next": "3" }}> next </Button>
        </div>
      </div>
    </div>

    <!-- Step 3: Phone -->
    <div class="step-content" data-step="3">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="text-5xl font-bold text-gray-900 dark:text-white">your phone?</h2>
        </div>

        <div class="input-wrapper">
          <input
            type="tel"
            id="contact-phone"
            name="phone"
            placeholder="(555) 123-4567"
            autocomplete="tel"
            class={`${appendedGlobalInputClasses}`}
          />
        </div>

        <div class="flex justify-between gap-3">
          <Button {...prevButtonProps} dataAttributes={{ "data-prev": "2" }}>
            <span class="hidden md:block"> back </span>
          </Button>
          <Button
            {...nextButtonProps}
            dataAttributes={{ "data-next": "4" }}
            class={`${nextButtonProps.class} next-step-phone`}
          >
            <span id="contact-next-step-phone-text">skip</span>
          </Button>
        </div>
      </div>
    </div>

    <!-- Step 4: SMS Consent -->
    <div class="step-content" data-step="4">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">contact via SMS?</h2>
          <p class="text-base text-gray-600 dark:text-gray-400 max-w-md mx-auto">
            Not for marketing. Communication and project updates only.
          </p>
        </div>

        <!-- Hidden input to store SMS alerts value -->
        <input type="hidden" name="smsAlerts" id="contact-sms-alerts" value="false" />

        <div class="flex justify-between gap-3">
          <Button {...prevButtonProps} dataAttributes={{ "data-prev": "3" }}>
            <span class="hidden md:block"> back </span>
          </Button>
          <div class="flex gap-3">
            <Button
              type="button"
              variant="primary"
              size="lg"
              class="sms-choice"
              dataAttributes={{ "data-next": "6", "data-sms-value": "false" }}
            >
              no
            </Button>
            <Button
              type="button"
              variant="secondary"
              size="lg"
              class="sms-choice"
              dataAttributes={{ "data-next": "5", "data-sms-value": "true" }}
            >
              yes
            </Button>
          </div>
        </div>
      </div>
    </div>

    <!-- Step 5: Mobile Carrier (only shown if SMS alerts = yes) -->
    <div class="step-content" data-step="5">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">
            your mobile carrier?
          </h2>
          <p class="text-base text-gray-600 dark:text-gray-400 max-w-md mx-auto">
            This helps us deliver SMS messages to your phone.
          </p>
        </div>

        <div class="input-wrapper">
          <SlotMachineModalStaff
            title="Select your carrier"
            id="contact-carrier"
            name="mobileCarrier"
            options={mobileCarrierOptions}
            selectedValue=""
            buttonClass="w-full"
            placeholder="Select your carrier..."
            icon="wifi"
            buttonVariant="outline"
            globalInputClasses={appendedGlobalInputClasses}
          />

          <!-- <SlotMachineModal
            id="contact-carrier"
            title="Select Your Carrier"
            icon="phone"
            options={mobileCarrierOptions}
            selectedValue=""
            placeholder="Select your carrier..."
            buttonText="Select Carrier *"
            buttonClass="w-full"
            buttonVariant="primary"
            showCloseButton={true}
            showCancelButton={true}
            {appendedGlobalInputClasses}
          /> -->
        </div>

        <div class="flex justify-between gap-3">
          <Button {...prevButtonProps} dataAttributes={{ "data-prev": "4" }}>
            <span class="hidden md:block"> back </span>
          </Button>
          <Button {...nextButtonProps} dataAttributes={{ "data-next": "6" }}> next </Button>
        </div>
      </div>
    </div>

    <!-- Step 6: Company -->
    <div class="step-content" data-step="6">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">your company?</h2>
        </div>

        <div class="input-wrapper">
          <input
            type="text"
            name="company"
            id="contact-company"
            placeholder="Acme Corporation"
            required
            autocomplete="organization"
            class={`${appendedGlobalInputClasses}`}
            data-error="Please enter your company name"
          />
        </div>

        <div class="flex justify-between gap-3">
          <Button
            {...prevButtonProps}
            dataAttributes={{ "data-prev": "5" }}
            class="prev-step-company"
          >
            <span class="hidden md:block"> back </span>
          </Button>
          <Button {...nextButtonProps} dataAttributes={{ "data-next": "7" }}> next </Button>
        </div>
      </div>
    </div>

    <!-- Step 7: Address -->
    <div class="step-content" data-step="7">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">project address?</h2>
        </div>

        <div class="input-wrapper">
          <InlineAddressSearch
            id="contact-address"
            name="address"
            placeholder="Start typing your address..."
            fetchApiEndpoint="/api/google/places-autocomplete"
            apiParams={{
              types: "address",
              components: "country:us",
              locationBias: "circle:100@42.3601,-71.0589",
            }}
            valueField="description"
            labelField="description"
            noResultsText="Type to search addresses..."
            globalInputClasses={appendedGlobalInputClasses}
          />
        </div>

        <div class="flex justify-between gap-3">
          <Button {...prevButtonProps} dataAttributes={{ "data-prev": "6" }}>
            <span class="hidden md:block"> back </span>
          </Button>
          <Button {...skipButtonProps} dataAttributes={{ "data-next": "8" }}> next / skip</Button>
        </div>
      </div>
    </div>

    <!-- Step 8: Message -->
    <div class="step-content" data-step="8">
      <div class="space-y-8">
        <div class="text-center">
          <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">your message?</h2>
        </div>

        <div class="input-wrapper">
          <textarea
            name="message"
            id="contact-message"
            placeholder="Tell us how we can help you..."
            required
            rows="6"
            class={`${appendedGlobalInputClasses}`}
            data-error="Please enter your message"></textarea>
        </div>

        <div class="flex justify-between gap-3">
          <Button {...prevButtonProps} dataAttributes={{ "data-prev": "7" }}>
            <span class="hidden md:block"> back </span>
          </Button>
          <Button {...submitButtonProps}> send message </Button>
        </div>
      </div>
    </div>
  </form>

  <style>
    .step-content {
      display: none;
      margin-left: auto;
      margin-right: auto;
    }

    #multi-step-contact-form {
      width: 80dvw;
      max-width: 680px;
    }

    .step-content.active {
      display: block;
    }
  </style>

  <script>
    import { validatePhone, formatPhoneAsYouType } from "../../../lib/phone-validation";

    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("multi-step-contact-form") as HTMLFormElement;
      if (!form) return;

      const sidebarToggleButton = document.getElementById("sidebar-toggle-button") as HTMLElement;
      if (sidebarToggleButton) {
        sidebarToggleButton.style.display = "none";
      }
      const progressBar = document.getElementById("contact-progress-bar") as HTMLElement;
      const progressText = document.getElementById("contact-progress-text") as HTMLElement;
      let currentStep = 1;
      const totalSteps = 8;

      // Phone input formatting
      const phoneInput = document.getElementById("contact-phone") as HTMLInputElement;
      const phoneButtonText = document.getElementById(
        "contact-next-step-phone-text"
      ) as HTMLElement;

      if (phoneInput) {
        let lastValue = "";

        phoneInput.addEventListener("input", (e) => {
          const input = e.target as HTMLInputElement;
          const cursorPosition = input.selectionStart || 0;

          // Format as user types
          const formatted = formatPhoneAsYouType(input.value);

          // Detect if user is deleting (value got shorter)
          const wasDeleting = input.value.length < lastValue.length;

          // Update the value
          input.value = formatted;
          lastValue = formatted;

          // Improve cursor position handling
          if (wasDeleting) {
            // On delete, keep cursor where it was
            input.setSelectionRange(cursorPosition, cursorPosition);
          } else {
            // On input, move cursor to end
            input.setSelectionRange(formatted.length, formatted.length);
          }

          // Update button text based on phone validation
          if (phoneButtonText) {
            if (!formatted || formatted.trim() === "") {
              // Empty: show "skip"
              phoneButtonText.textContent = "skip";
            } else if (validatePhone(formatted)) {
              // Valid: show "next"
              phoneButtonText.textContent = "next";
            } else {
              // Has content but invalid: show "skip"
              phoneButtonText.textContent = "skip";
            }
          }
        });
      }

      // Update progress bar
      function updateProgress() {
        const progress = (currentStep / totalSteps) * 100;
        if (progressBar) progressBar.style.width = `${progress}%`;
        if (progressText) progressText.textContent = `${currentStep} / ${totalSteps}`;
      }

      // Show specific step (simple show/hide, no animations)
      function showStep(stepNumber: number) {
        const steps = document.querySelectorAll(".step-content");

        // Hide all steps and remove focus classes from buttons
        steps.forEach((step) => {
          step.classList.remove("active");
          // Remove focus classes from any buttons in the step
          const buttons = step.querySelectorAll("button");
          buttons.forEach((btn) => {
            btn.classList.remove(
              "!outline",
              "!outline-2",
              "!outline-dashed",
              "!outline-primary-500",
              "!outline-offset-2",
              "dark:!outline-primary-400"
            );
          });
        });

        // Show target step
        const targetStep = document.querySelector(
          `.step-content[data-step="${stepNumber}"]`
        ) as HTMLElement;
        if (targetStep) {
          targetStep.classList.add("active");
          currentStep = stepNumber;
          updateProgress();

          // Special handling for step 4 (SMS consent) - focus the "yes" button
          if (stepNumber === 4) {
            setTimeout(() => {
              // Find the "yes" button (has data-sms-value="true")
              const yesButton = targetStep.querySelector(
                'button[data-sms-value="true"]'
              ) as HTMLElement;
              if (yesButton) {
                // Add focus outline classes
                // yesButton.classList.add(
                //   "!outline",
                //   "!outline-2",
                //   "!outline-dashed",
                //   "!outline-primary-500",
                //   "!outline-offset-2",
                //   "dark:!outline-primary-400"
                // );
                // Also focus for accessibility
                yesButton.focus();
              }
            }, 100);
          } else {
            // Auto-focus first input for other steps
            setTimeout(() => {
              // Try multiple selectors to find the first focusable input
              let firstInput = targetStep.querySelector(
                "input:not([type=hidden]):not([readonly])"
              ) as HTMLElement;

              // If no regular input, try textarea
              if (!firstInput) {
                firstInput = targetStep.querySelector("textarea") as HTMLElement;
              }

              // If still no input, try the address search input specifically (step 6)
              if (!firstInput && stepNumber === 6) {
                firstInput = document.getElementById("contact-address-search-input") as HTMLElement;
              }

              if (firstInput) {
                firstInput.focus();
                // Scroll into view if needed
                firstInput.scrollIntoView({ behavior: "smooth", block: "center" });
              }
            }, 150);
          }
        }
      }

      // Validate current step
      function validateStep(stepNumber: number): boolean {
        const stepEl = document.querySelector(`.step-content[data-step="${stepNumber}"]`);
        if (!stepEl) return false;

        const inputs = stepEl.querySelectorAll("input[required], textarea[required]");
        let isValid = true;

        for (const input of inputs) {
          const inputEl = input as HTMLInputElement | HTMLTextAreaElement;
          if (!inputEl.checkValidity()) {
            isValid = false;
            inputEl.classList.add("touched");

            // Show error using modal if available
            if (window.showNotice) {
              const errorMsg =
                inputEl.getAttribute("data-error") || "Please fill in this field correctly";
              window.showNotice("error", "Validation Error", errorMsg, 3000);
            }
            return false;
          }
        }

        // Special validation for phone field (Step 3)
        if (stepNumber === 3) {
          const phoneInput = document.getElementById("contact-phone") as HTMLInputElement;
          const phoneValue = phoneInput?.value?.trim() || "";

          // Only validate if phone is provided (it's optional)
          if (phoneValue && !validatePhone(phoneValue)) {
            if (window.showNotice) {
              window.showNotice(
                "error",
                "Invalid Phone Number",
                "Please enter a valid US phone number",
                3000
              );
            }
            phoneInput?.classList.add("touched");
            return false;
          }
        }

        // Special validation for carrier field (Step 5) - only if SMS alerts is enabled
        if (stepNumber === 5) {
          const smsAlertsInput = document.getElementById("contact-sms-alerts") as HTMLInputElement;
          const smsEnabled = smsAlertsInput && smsAlertsInput.value === "true";

          if (smsEnabled) {
            const carrierInput = document.getElementById(
              "contact-carrier-value"
            ) as HTMLInputElement;
            if (carrierInput && !carrierInput.value) {
              if (window.showNotice) {
                window.showNotice(
                  "error",
                  "Validation Error",
                  "Please select your mobile carrier",
                  3000
                );
              }
              return false;
            }
          }
        }

        // Special validation for address field (Step 7)
        if (stepNumber === 7) {
          const addressInput = document.getElementById("contact-address-value") as HTMLInputElement;
          if (addressInput && !addressInput.value) {
            if (window.showNotice) {
              window.showNotice("error", "Validation Error", "Please select an address", 3000);
            }
            return false;
          }
        }

        return isValid;
      }

      // Handle next step buttons
      form.addEventListener("click", (e) => {
        const target = e.target as HTMLElement;
        // Use closest to find button/link from any nested element (span, svg, etc.)
        const nextBtn = target.closest("button.next-step, a.next-step");
        const prevBtn = target.closest("button.prev-step, a.prev-step");
        const smsChoiceBtn = target.closest("button.sms-choice, a.sms-choice");

        console.log("[CONTACT-FORM] Click detected on:", target);
        console.log("[CONTACT-FORM] Current step:", currentStep);
        console.log("[CONTACT-FORM] nextBtn:", nextBtn);
        console.log("[CONTACT-FORM] prevBtn:", prevBtn);
        console.log("[CONTACT-FORM] smsChoiceBtn:", smsChoiceBtn);

        // Handle SMS consent choice buttons
        if (smsChoiceBtn) {
          console.log("[CONTACT-FORM] SMS choice button clicked");
          e.preventDefault();
          const smsValue = smsChoiceBtn.getAttribute("data-sms-value");
          const nextStep = parseInt(smsChoiceBtn.getAttribute("data-next") || "6");

          console.log("[CONTACT-FORM] SMS value:", smsValue, "Next step:", nextStep);

          // Store SMS alerts value
          const smsAlertsInput = document.getElementById("contact-sms-alerts") as HTMLInputElement;
          if (smsAlertsInput) {
            smsAlertsInput.value = smsValue || "false";
          }

          showStep(nextStep);
          return;
        }

        if (nextBtn) {
          console.log("[CONTACT-FORM] Next button clicked");
          console.log("[CONTACT-FORM] Next button classes:", nextBtn.className);
          console.log(
            "[CONTACT-FORM] Has next-step-phone class:",
            nextBtn.classList.contains("next-step-phone")
          );

          e.preventDefault();
          let nextStep = parseInt(nextBtn.getAttribute("data-next") || "1");

          console.log("[CONTACT-FORM] Default next step:", nextStep);

          // Check if this is the submit button (step 6)
          if (nextBtn.classList.contains("submit-contact")) {
            console.log("[CONTACT-FORM] Submit button - validating");
            // Validate before submitting
            if (validateStep(currentStep)) {
              form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
            }
            return;
          }

          // Special handling for phone step (step 3)
          if (currentStep === 3 && nextBtn.classList.contains("next-step-phone")) {
            console.log("[CONTACT-FORM] Phone step next button clicked");
            const phoneInput = document.getElementById("contact-phone") as HTMLInputElement;
            const phoneValue = phoneInput?.value?.trim() || "";

            console.log("[CONTACT-FORM] Phone input found:", !!phoneInput);
            console.log("[CONTACT-FORM] Phone value:", phoneValue);

            // If no phone number entered, skip to step 6 (company)
            if (!phoneValue) {
              console.log("[CONTACT-FORM] No phone entered - skipping to step 6");
              nextStep = 6;
              // Clear SMS alerts since no phone was provided
              const smsAlertsInput = document.getElementById(
                "contact-sms-alerts"
              ) as HTMLInputElement;
              if (smsAlertsInput) {
                smsAlertsInput.value = "false";
              }
              showStep(nextStep);
              return;
            }

            console.log("[CONTACT-FORM] Phone entered - validating before proceeding to step 4");
            // If phone entered, validate it before proceeding
            if (!validateStep(currentStep)) {
              console.log("[CONTACT-FORM] Phone validation failed");
              return; // Stop if validation fails
            }

            console.log("[CONTACT-FORM] Phone validation passed - proceeding to step 4");
            // Validation passed, proceed to step 4 (SMS consent)
            showStep(nextStep);
            return;
          }

          console.log("[CONTACT-FORM] Regular next button - validating step", currentStep);
          // Validate current step before moving forward
          if (validateStep(currentStep)) {
            console.log("[CONTACT-FORM] Validation passed - showing step", nextStep);
            showStep(nextStep);
          } else {
            console.log("[CONTACT-FORM] Validation failed for step", currentStep);
          }
        }

        if (prevBtn) {
          console.log("[CONTACT-FORM] Previous button clicked");
          // Check if this is a link - if so, allow normal navigation
          const isLink =
            prevBtn.tagName === "A" || prevBtn.hasAttribute("href") || prevBtn.closest("a");
          if (isLink) {
            console.log("[CONTACT-FORM] Previous button is a link - allowing default");
            return;
          }
          e.preventDefault();
          let prevStep = parseInt(prevBtn.getAttribute("data-prev") || "1");

          console.log("[CONTACT-FORM] Default previous step:", prevStep);

          // Special handling for company step (step 6) going back
          if (currentStep === 6 && prevBtn.classList.contains("prev-step-company")) {
            console.log("[CONTACT-FORM] Company step back button clicked");
            const phoneInput = document.getElementById("contact-phone") as HTMLInputElement;
            const phoneValue = phoneInput?.value?.trim() || "";

            console.log("[CONTACT-FORM] Phone value for back navigation:", phoneValue);

            // If no phone number, skip back to step 3 (phone)
            if (!phoneValue) {
              console.log("[CONTACT-FORM] No phone - going back to step 3");
              prevStep = 3;
            } else {
              console.log("[CONTACT-FORM] Phone exists - going back to step 5");
            }
            // If phone exists, go back to step 5 (carrier) as normal
          }

          console.log("[CONTACT-FORM] Showing previous step:", prevStep);
          showStep(prevStep);
        }
      });

      // Add touched class to inputs after user interaction
      const inputs = form.querySelectorAll("input[required], textarea[required]");
      inputs.forEach((input) => {
        input.addEventListener("blur", () => {
          input.classList.add("touched");
        });
        input.addEventListener("input", () => {
          input.classList.add("touched");
        });
      });

      // Handle submit button click
      const submitBtn = form.querySelector(".submit-contact");
      if (submitBtn) {
        submitBtn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();

          // Validate before submitting
          if (validateStep(currentStep)) {
            form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
          }
        });
      }

      // Handle form submission
      let isSubmitting = false;
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        e.stopImmediatePropagation();

        // Prevent double submission
        if (isSubmitting) {
          console.log("[CONTACT] Already submitting, ignoring duplicate submission");
          return;
        }

        // Validate final step before submission
        const isValid = validateStep(currentStep);
        if (!isValid) {
          console.error("[CONTACT] Final step validation failed");
          return;
        }

        isSubmitting = true;
        const submitButton = form.querySelector("button.submit-contact") as HTMLButtonElement;
        const originalButtonText = submitButton?.textContent || "Send Message";

        // Disable submit button and show loading state
        if (submitButton) {
          submitButton.disabled = true;
        }

        const formData = new FormData(form);

        // Show loading notification
        if (window.showNotice) {
          window.showNotice(
            "info",
            "Sending Message...",
            "Please wait while we process your request.",
            10000
          );
        }

        try {
          console.log("[CONTACT] Submitting contact form...");
          const response = await fetch("/api/contact/submit", {
            method: "POST",
            body: formData,
          });

          console.log("[CONTACT] Response status:", response.status, response.statusText);

          // Check if response is OK before parsing
          if (!response.ok) {
            const contentType = response.headers.get("content-type");
            let errorData: any = { error: "Submission failed" };

            if (contentType && contentType.includes("application/json")) {
              try {
                errorData = await response.json();
              } catch (parseError) {
                console.error("[CONTACT] Failed to parse error response:", parseError);
              }
            } else {
              const text = await response.text();
              console.error("[CONTACT] Non-JSON error response:", text);
              errorData = { error: `Server error: ${response.status} ${response.statusText}` };
            }

            if (window.showNotice) {
              window.showNotice(
                "error",
                "Submission Failed",
                errorData.error || `Server error (${response.status}). Please try again.`,
                8000
              );
            }

            isSubmitting = false;
            if (submitButton) {
              submitButton.disabled = false;
            }
            return;
          }

          // Parse successful response
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            throw new Error("Server returned non-JSON response. Please try again.");
          }

          const result = await response.json();
          console.log("[CONTACT] Contact result:", result);

          // Check for success
          if (result.success === false || result.error) {
            // Check if this is a setup required error
            if (result.setupRequired) {
              if (window.showNotice) {
                window.showNotice(
                  "warning",
                  "Database Setup Required",
                  `The contact form database table needs to be set up. <br><br>
                <strong>Quick Setup:</strong><br>
                1. Go to Supabase SQL Editor<br>
                2. Run the SQL from: <code>sql-queriers/create-contact-submissions-table.sql</code><br>
                3. Try submitting again<br><br>
                Check server logs for the SQL commands.`,
                  15000
                );
              }
            } else {
              if (window.showNotice) {
                window.showNotice(
                  "error",
                  "Submission Failed",
                  result.error || result.details || "Failed to send message. Please try again.",
                  8000
                );
              }
            }
            isSubmitting = false;
            if (submitButton) {
              submitButton.disabled = false;
            }
            return;
          }

          // Success!
          if (result.success !== false && !result.error) {
            // Store success message in sessionStorage to show after redirect
            sessionStorage.setItem(
              "contactFormSuccess",
              JSON.stringify({
                type: "success",
                title: "Message Sent!",
                message: "Thank you for contacting us. We'll get back to you soon!",
                duration: 5000,
              })
            );

            // Redirect to homepage
            window.location.href = "/";
          }
        } catch (error) {
          console.error("[CONTACT] Submission error:", error);

          let errorMessage = "An unexpected error occurred. Please try again.";

          if (error instanceof Error) {
            console.error("[CONTACT] Error details:", error.message, error.stack);
            if (error.message.includes("non-JSON response")) {
              errorMessage = "Server error occurred. Please try again in a moment.";
            } else if (error.message.includes("Failed to fetch") || error.name === "TypeError") {
              errorMessage = "Network error. Please check your connection and try again.";
            } else {
              errorMessage = error.message || errorMessage;
            }
          }

          if (window.showNotice) {
            window.showNotice("error", "Submission Failed", errorMessage, 8000);
          }
        } finally {
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
          }
        }
      });

      // Handle Enter key to move to next step
      form.addEventListener("keypress", (e) => {
        if (e.key === "Enter" && (e.target as HTMLElement).tagName !== "TEXTAREA") {
          e.preventDefault();

          // Find next button in current step
          const currentStepEl = document.querySelector(`.step-content[data-step="${currentStep}"]`);
          const nextBtn = currentStepEl?.querySelector(".next-step") as HTMLElement;

          if (nextBtn && currentStep < totalSteps) {
            nextBtn.click();
          } else if (currentStep === totalSteps) {
            // Submit form on last step
            const submitBtn = form.querySelector(".submit-contact") as HTMLElement;
            if (submitBtn) {
              submitBtn.click();
            }
          }
        }
      });

      // Initialize
      updateProgress();

      // Focus first input on initial load
      setTimeout(() => {
        const firstStep = document.querySelector('.step-content[data-step="1"]') as HTMLElement;
        if (firstStep) {
          const firstInput = firstStep.querySelector(
            "input:not([type=hidden]):not([readonly])"
          ) as HTMLElement;
          if (firstInput) {
            firstInput.focus();
          }
        }
      }, 150);
    });
  </script>
</div>
