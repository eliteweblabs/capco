---
// Multi-step contact form component with AOS animations
import Button from "../../../components/common/Button.astro";
import PhoneAndSMS from "../../../components/form/PhoneAndSMS.astro";
import SimpleIcon from "../../../components/common/SimpleIcon.astro";
import InlineAddressSearch from "../../../components/form/InlineAddressSearch.astro";

import { globalClasses } from "../../../pages/api/global/global-classes";
const { globalInputClasses } = globalClasses();

// Button templates - change these props to customize all buttons at once
const nextButtonProps = {
  type: "button" as const,
  variant: "primary" as const,
  size: "xl" as const,
  class: "next-step",
  icon: "arrow-right",
  iconPosition: "right" as const,
  iconClasses: "m-0 md:mr-2",
};

const prevButtonProps = {
  type: "button" as const,
  variant: "outline" as const,
  size: "xl" as const,
  class: "prev-step",
  icon: "arrow-left",
  iconPosition: "left" as const,
  iconClasses: "m-0 md:ml-2",
};

const submitButtonProps = {
  type: "button" as const,
  variant: "primary" as const,
  size: "xl" as const,
  class: "submit-contact",
  icon: "send",
  iconPosition: "right" as const,
  iconClasses: "m-0 md:mr-2",
};
---

<!-- Progress Bar -->
<div class="mb-6 sm:mb-12 px-4">
  <div class="relative">
    <div class="h-2 w-full overflow-hidden rounded-full bg-gray-200 dark:bg-gray-700">
      <div
        id="contact-progress-bar"
        class="h-full rounded-full bg-primary-500"
        style="width: 0%"
      >
      </div>
    </div>
    <div class="mt-3 text-center">
      <span id="contact-progress-text" class="text-sm font-medium text-gray-600 dark:text-gray-400">
        1 / 7
      </span>
    </div>
  </div>
</div>

<!-- Multi-step Form -->
<form id="multi-step-contact-form" action="/api/contact/submit" method="post" class="px-4">
  <!-- Step 1: Name -->
  <div class="step-content active" data-step="1">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="text-5xl font-bold text-gray-900 dark:text-white">your name?</h2>
      </div>

      <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
        <div class="input-wrapper">
          <input
            type="text"
            name="firstName"
            id="contact-first-name"
            placeholder="John"
            required
            autocomplete="given-name"
            class={`${globalInputClasses} text-xl py-5 text-center`}
            data-error="Please enter your first name"
            autofocus={true}
          />
        </div>

        <div class="input-wrapper">
          <input
            type="text"
            name="lastName"
            id="contact-last-name"
            placeholder="Doe"
            required
            autocomplete="family-name"
            class={`${globalInputClasses} text-xl py-5 text-center`}
            data-error="Please enter your last name"
          />
        </div>
      </div>

      <div class="flex justify-end gap-3">
        <Button {...nextButtonProps} dataAttributes={{ "data-next": "2" }}> next </Button>
      </div>
    </div>
  </div>

  <!-- Step 2: Email -->
  <div class="step-content" data-step="2">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="text-5xl font-bold text-gray-900 dark:text-white">your email?</h2>
      </div>

      <div class="input-wrapper">
        <input
          type="email"
          name="email"
          id="contact-email"
          placeholder="your.email@example.com"
          required
          autocomplete="email"
          class={`${globalInputClasses} text-xl py-5 text-center`}
          data-error="Please enter a valid email address"
        />
      </div>

      <div class="flex justify-between gap-3">
        <Button {...prevButtonProps} dataAttributes={{ "data-prev": "1" }}> back </Button>
        <Button {...nextButtonProps} dataAttributes={{ "data-next": "3" }}> next </Button>
      </div>
    </div>
  </div>

  <!-- Step 3: Phone -->
  <div class="step-content" data-step="3">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="text-5xl font-bold text-gray-900 dark:text-white">your phone?</h2>
      </div>

      <div class="input-wrapper">
        <PhoneAndSMS
          id="contact-phone"
          name="phone"
          placeholder="(555) 123-4567"
          showSMS={false}
          hideLabel={true}
          class="text-xl py-5 text-center"
          {globalInputClasses}
        />
      </div>

      <div class="flex justify-between gap-3">
        <Button {...prevButtonProps} dataAttributes={{ "data-prev": "2" }}> back </Button>
        <Button {...nextButtonProps} dataAttributes={{ "data-next": "4" }}> next </Button>
      </div>
    </div>
  </div>

  <!-- Step 4: SMS Consent -->
  <div class="step-content" data-step="4">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">contact via SMS?</h2>
        <p class="text-base text-gray-600 dark:text-gray-400 max-w-md mx-auto">
          Not for marketing. Communication and project updates only.
        </p>
      </div>

      <!-- Hidden input to store SMS consent value -->
      <input type="hidden" name="smsConsent" id="contact-sms-consent" value="" />

      <div class="flex justify-between gap-3">
        <Button {...prevButtonProps} dataAttributes={{ "data-prev": "3" }}> back </Button>
        <div class="flex gap-3">
          <Button
            type="button"
            variant="secondary"
            size="xl"
            class="sms-choice"
            dataAttributes={{ "data-next": "5", "data-sms-value": "false" }}
          >
            no
          </Button>
          <Button
            type="button"
            variant="primary"
            size="xl"
            class="sms-choice"
            dataAttributes={{ "data-next": "5", "data-sms-value": "true" }}
          >
            yes
          </Button>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 5: Company -->
  <div class="step-content" data-step="5">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">your company?</h2>
      </div>

      <div class="input-wrapper">
        <input
          type="text"
          name="company"
          id="contact-company"
          placeholder="Acme Corporation"
          required
          autocomplete="organization"
          class={`${globalInputClasses} text-xl py-5 text-center`}
          data-error="Please enter your company name"
        />
      </div>

      <div class="flex justify-between gap-3">
        <Button {...prevButtonProps} dataAttributes={{ "data-prev": "4" }}> back </Button>
        <Button {...nextButtonProps} dataAttributes={{ "data-next": "6" }}> next </Button>
      </div>
    </div>
  </div>

  <!-- Step 6: Address -->
  <div class="step-content" data-step="6">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">your address?</h2>
      </div>

      <div class="input-wrapper">
        <InlineAddressSearch
          id="contact-address"
          name="address"
          placeholder="Start typing your address..."
          fetchApiEndpoint="/api/google/places-autocomplete"
          apiParams={{
            types: "address",
            components: "country:us",
            locationBias: "circle:100@42.3601,-71.0589",
          }}
          valueField="description"
          labelField="description"
          noResultsText="Type to search addresses..."
          {globalInputClasses}
        />
      </div>

      <div class="flex justify-between gap-3">
        <Button {...prevButtonProps} dataAttributes={{ "data-prev": "5" }}> back </Button>
        <Button {...nextButtonProps} dataAttributes={{ "data-next": "7" }}> next </Button>
      </div>
    </div>
  </div>

  <!-- Step 7: Message -->
  <div class="step-content" data-step="7">
    <div class="space-y-8">
      <div class="text-center">
        <h2 class="mb-3 text-5xl font-bold text-gray-900 dark:text-white">your message?</h2>
      </div>

      <div class="input-wrapper">
        <textarea
          name="message"
          id="contact-message"
          placeholder="Tell us how we can help you..."
          required
          rows="6"
          class={`${globalInputClasses} text-xl py-5`}
          data-error="Please enter your message"></textarea>
      </div>

      <div class="flex justify-between gap-3">
        <Button {...prevButtonProps} dataAttributes={{ "data-prev": "6" }}> back </Button>
        <Button {...submitButtonProps}> send message </Button>
      </div>
    </div>
  </div>
</form>

<style>
  .step-content {
    display: none;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
  }

  #multi-step-contact-form {
    width: 100dvw;
    max-width: 680px;
  }

  .step-content.active {
    display: block;
  }

  :global(#sidebar-toggle-button) {
    display: none;
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById("multi-step-contact-form") as HTMLFormElement;
    if (!form) return;

    const progressBar = document.getElementById("contact-progress-bar") as HTMLElement;
    const progressText = document.getElementById("contact-progress-text") as HTMLElement;
    let currentStep = 1;
    const totalSteps = 7;

    // Update progress bar
    function updateProgress() {
      const progress = (currentStep / totalSteps) * 100;
      if (progressBar) progressBar.style.width = `${progress}%`;
      if (progressText) progressText.textContent = `${currentStep} / ${totalSteps}`;
    }

    // Show specific step (simple show/hide, no animations)
    function showStep(stepNumber: number) {
      const steps = document.querySelectorAll(".step-content");

      // Hide all steps and remove focus classes from buttons
      steps.forEach((step) => {
        step.classList.remove("active");
        // Remove focus classes from any buttons in the step
        const buttons = step.querySelectorAll("button");
        buttons.forEach((btn) => {
          btn.classList.remove(
            "!outline",
            "!outline-2",
            "!outline-dashed",
            "!outline-primary-500",
            "!outline-offset-2",
            "dark:!outline-primary-400"
          );
        });
      });

      // Show target step
      const targetStep = document.querySelector(
        `.step-content[data-step="${stepNumber}"]`
      ) as HTMLElement;
      if (targetStep) {
        targetStep.classList.add("active");
        currentStep = stepNumber;
        updateProgress();

        // Special handling for step 4 (SMS consent) - focus the "yes" button
        if (stepNumber === 4) {
          setTimeout(() => {
            // Find the "yes" button (has data-sms-value="true")
            const yesButton = targetStep.querySelector(
              'button[data-sms-value="true"]'
            ) as HTMLElement;
            if (yesButton) {
              // Add focus outline classes
              yesButton.classList.add(
                "!outline",
                "!outline-2",
                "!outline-dashed",
                "!outline-primary-500",
                "!outline-offset-2",
                "dark:!outline-primary-400"
              );
              // Also focus for accessibility
              yesButton.focus();
            }
          }, 100);
        } else {
          // Auto-focus first input for other steps
          setTimeout(() => {
            // Try multiple selectors to find the first focusable input
            let firstInput = targetStep.querySelector(
              "input:not([type=hidden]):not([readonly])"
            ) as HTMLElement;

            // If no regular input, try textarea
            if (!firstInput) {
              firstInput = targetStep.querySelector("textarea") as HTMLElement;
            }

            // If still no input, try the address search input specifically (step 6)
            if (!firstInput && stepNumber === 6) {
              firstInput = document.getElementById("contact-address-search-input") as HTMLElement;
            }

            if (firstInput) {
              firstInput.focus();
              // Scroll into view if needed
              firstInput.scrollIntoView({ behavior: "smooth", block: "center" });
            }
          }, 150);
        }
      }
    }

    // Validate current step
    function validateStep(stepNumber: number): boolean {
      const stepEl = document.querySelector(`.step-content[data-step="${stepNumber}"]`);
      if (!stepEl) return false;

      const inputs = stepEl.querySelectorAll("input[required], textarea[required]");
      let isValid = true;

      for (const input of inputs) {
        const inputEl = input as HTMLInputElement | HTMLTextAreaElement;
        if (!inputEl.checkValidity()) {
          isValid = false;
          inputEl.classList.add("touched");

          // Show error using modal if available
          if (window.showModal) {
            const errorMsg =
              inputEl.getAttribute("data-error") || "Please fill in this field correctly";
            window.showModal("error", "Validation Error", errorMsg, 3000);
          }
          return false;
        }
      }

      // Special validation for address field (Step 6)
      if (stepNumber === 6) {
        const addressInput = document.getElementById("contact-address-value") as HTMLInputElement;
        if (addressInput && !addressInput.value) {
          if (window.showModal) {
            window.showModal("error", "Validation Error", "Please select an address", 3000);
          }
          return false;
        }
      }

      return isValid;
    }

    // Handle next step buttons
    form.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const nextBtn = target.closest(".next-step");
      const prevBtn = target.closest(".prev-step");
      const smsChoiceBtn = target.closest(".sms-choice");

      // Handle SMS consent choice buttons
      if (smsChoiceBtn) {
        e.preventDefault();
        const smsValue = smsChoiceBtn.getAttribute("data-sms-value");
        const nextStep = parseInt(smsChoiceBtn.getAttribute("data-next") || "5");

        // Store SMS consent value
        const smsConsentInput = document.getElementById("contact-sms-consent") as HTMLInputElement;
        if (smsConsentInput) {
          smsConsentInput.value = smsValue || "false";
        }

        showStep(nextStep);
        return;
      }

      if (nextBtn) {
        e.preventDefault();
        const nextStep = parseInt(nextBtn.getAttribute("data-next") || "1");

        // Check if this is the submit button (step 6)
        if (nextBtn.classList.contains("submit-contact")) {
          // Validate before submitting
          if (validateStep(currentStep)) {
            form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
          }
          return;
        }

        // Validate current step before moving forward
        if (validateStep(currentStep)) {
          showStep(nextStep);
        }
      }

      if (prevBtn) {
        // Check if this is a link - if so, allow normal navigation
        const isLink =
          prevBtn.tagName === "A" || prevBtn.hasAttribute("href") || prevBtn.closest("a");
        if (isLink) {
          return;
        }
        e.preventDefault();
        const prevStep = parseInt(prevBtn.getAttribute("data-prev") || "1");
        showStep(prevStep);
      }
    });

    // Add touched class to inputs after user interaction
    const inputs = form.querySelectorAll("input[required], textarea[required]");
    inputs.forEach((input) => {
      input.addEventListener("blur", () => {
        input.classList.add("touched");
      });
      input.addEventListener("input", () => {
        input.classList.add("touched");
      });
    });

    // Handle submit button click
    const submitBtn = form.querySelector(".submit-contact");
    if (submitBtn) {
      submitBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        // Validate before submitting
        if (validateStep(currentStep)) {
          form.dispatchEvent(new Event("submit", { bubbles: true, cancelable: true }));
        }
      });
    }

    // Handle form submission
    let isSubmitting = false;
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();

      // Prevent double submission
      if (isSubmitting) {
        console.log("[CONTACT] Already submitting, ignoring duplicate submission");
        return;
      }

      // Validate final step before submission
      const isValid = validateStep(currentStep);
      if (!isValid) {
        console.error("[CONTACT] Final step validation failed");
        return;
      }

      isSubmitting = true;
      const submitButton = form.querySelector("button.submit-contact") as HTMLButtonElement;
      const originalButtonText = submitButton?.textContent || "Send Message";

      // Disable submit button and show loading state
      if (submitButton) {
        submitButton.disabled = true;
      }

      const formData = new FormData(form);

      // Show loading notification
      if (window.showModal) {
        window.showModal(
          "info",
          "Sending Message...",
          "Please wait while we process your request.",
          10000
        );
      }

      try {
        console.log("[CONTACT] Submitting contact form...");
        const response = await fetch("/api/contact/submit", {
          method: "POST",
          body: formData,
        });

        console.log("[CONTACT] Response status:", response.status, response.statusText);

        // Check if response is OK before parsing
        if (!response.ok) {
          const contentType = response.headers.get("content-type");
          let errorData: any = { error: "Submission failed" };

          if (contentType && contentType.includes("application/json")) {
            try {
              errorData = await response.json();
            } catch (parseError) {
              console.error("[CONTACT] Failed to parse error response:", parseError);
            }
          } else {
            const text = await response.text();
            console.error("[CONTACT] Non-JSON error response:", text);
            errorData = { error: `Server error: ${response.status} ${response.statusText}` };
          }

          if (window.showModal) {
            window.showModal(
              "error",
              "Submission Failed",
              errorData.error || `Server error (${response.status}). Please try again.`,
              8000
            );
          }

          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
          }
          return;
        }

        // Parse successful response
        const contentType = response.headers.get("content-type");
        if (!contentType || !contentType.includes("application/json")) {
          throw new Error("Server returned non-JSON response. Please try again.");
        }

        const result = await response.json();
        console.log("[CONTACT] Contact result:", result);

        // Check for success
        if (result.success === false || result.error) {
          // Check if this is a setup required error
          if (result.setupRequired) {
            if (window.showModal) {
              window.showModal(
                "warning",
                "Database Setup Required",
                `The contact form database table needs to be set up. <br><br>
                <strong>Quick Setup:</strong><br>
                1. Go to Supabase SQL Editor<br>
                2. Run the SQL from: <code>sql-queriers/create-contact-submissions-table.sql</code><br>
                3. Try submitting again<br><br>
                Check server logs for the SQL commands.`,
                15000
              );
            }
          } else {
            if (window.showModal) {
              window.showModal(
                "error",
                "Submission Failed",
                result.error || result.details || "Failed to send message. Please try again.",
                8000
              );
            }
          }
          isSubmitting = false;
          if (submitButton) {
            submitButton.disabled = false;
          }
          return;
        }

        // Success!
        if (result.success !== false && !result.error) {
          if (window.showModal) {
            window.showModal(
              "success",
              "Message Sent!",
              "Thank you for contacting us. We'll get back to you soon!",
              5000
            );
          }

          // Reset form after success
          form.reset();

          // Go back to first step
          showStep(1);

          // Clear address value
          const addressInput = document.getElementById("contact-address-value") as HTMLInputElement;
          if (addressInput) {
            addressInput.value = "";
          }

          // Reset address search input
          const addressSearchInput = document.getElementById(
            "contact-address-search-input"
          ) as HTMLInputElement;
          if (addressSearchInput) {
            addressSearchInput.value = "";
          }
        }
      } catch (error) {
        console.error("[CONTACT] Submission error:", error);

        let errorMessage = "An unexpected error occurred. Please try again.";

        if (error instanceof Error) {
          console.error("[CONTACT] Error details:", error.message, error.stack);
          if (error.message.includes("non-JSON response")) {
            errorMessage = "Server error occurred. Please try again in a moment.";
          } else if (error.message.includes("Failed to fetch") || error.name === "TypeError") {
            errorMessage = "Network error. Please check your connection and try again.";
          } else {
            errorMessage = error.message || errorMessage;
          }
        }

        if (window.showModal) {
          window.showModal("error", "Submission Failed", errorMessage, 8000);
        }
      } finally {
        isSubmitting = false;
        if (submitButton) {
          submitButton.disabled = false;
        }
      }
    });

    // Handle Enter key to move to next step
    form.addEventListener("keypress", (e) => {
      if (e.key === "Enter" && (e.target as HTMLElement).tagName !== "TEXTAREA") {
        e.preventDefault();

        // Find next button in current step
        const currentStepEl = document.querySelector(`.step-content[data-step="${currentStep}"]`);
        const nextBtn = currentStepEl?.querySelector(".next-step") as HTMLElement;

        if (nextBtn && currentStep < totalSteps) {
          nextBtn.click();
        } else if (currentStep === totalSteps) {
          // Submit form on last step
          const submitBtn = form.querySelector(".submit-contact") as HTMLElement;
          if (submitBtn) {
            submitBtn.click();
          }
        }
      }
    });

    // Initialize
    updateProgress();

    // Focus first input on initial load
    setTimeout(() => {
      const firstStep = document.querySelector('.step-content[data-step="1"]') as HTMLElement;
      if (firstStep) {
        const firstInput = firstStep.querySelector(
          "input:not([type=hidden]):not([readonly])"
        ) as HTMLElement;
        if (firstInput) {
          firstInput.focus();
        }
      }
    }, 150);
  });
</script>
