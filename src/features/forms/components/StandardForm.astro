---
/**
 * StandardForm - Single-page form renderer for MultiStepFormConfig
 * Accepts the same config as MultiStepForm; flattens all steps into one form.
 * Use when you want a traditional single-page form instead of step-by-step.
 *
 * Example: <StandardForm config={loginFormConfig} initialData={{ redirect: "/dashboard" }} />
 */
import type {
  MultiStepFormConfig,
  FormFieldConfig,
  FormStepConfig,
} from "../../../lib/multi-step-form-config";
import { getButtonConfig, normalizeFormConfig } from "../../../lib/multi-step-form-config";
import Button from "../../../components/common/Button.astro";
import AuthProviders from "../../../components/form/AuthProviders.astro";
import FormFieldRenderer from "./FormFieldRenderer.astro";
import { SMS_UTILS } from "../../../lib/sms-utils";
import { globalClasses } from "../../../pages/api/global/global-classes";

interface Props {
  config: MultiStepFormConfig;
  containerClass?: string;
  initialData?: Record<string, any>;
  /** When true, render fields without form tag (embed in parent form). Skips StandardForm init. */
  wrapInForm?: boolean;
  /** Prefix for field ids (e.g. "admin-" for admin form) */
  fieldIdPrefix?: string;
}

const {
  config: rawConfig,
  containerClass = "min-w-md max-w-md sm:max-w-lg md:max-w-xl lg:max-w-2xl mx-auto w-full",
  initialData = {},
  wrapInForm = false,
  fieldIdPrefix = "",
} = Astro.props;

const fid = (id: string) => (fieldIdPrefix ? `${fieldIdPrefix}${id}` : id);

const config = normalizeFormConfig(rawConfig);
const FormOrDiv = wrapInForm ? "div" : "form";

const { globalInputClasses } = globalClasses();
const appendedGlobalInputClasses = `${globalInputClasses}`;

const mobileCarrierOptions = SMS_UTILS.CARRIERS.map((carrier: any) => ({
  value: carrier.id,
  label: carrier.name,
}));

/** Flatten all fields from all steps (skip review steps) */
function flattenFields(steps: FormStepConfig[]): FormFieldConfig[] {
  return steps.filter((s) => !s.isReview).flatMap((s) => s.fields || []);
}

/** First step that has auth providers */
function getAuthProviderStep(steps: FormStepConfig[]): FormStepConfig | undefined {
  return steps.find(
    (s) => s.additionalContent === "google-oauth" || s.additionalContent === "auth-providers"
  );
}

/** Submit button from last step, or config default */
function getSubmitButton(config: MultiStepFormConfig) {
  const steps = config.steps.filter((s) => !s.isReview);
  const lastStep = steps[steps.length - 1];
  const submitBtn = lastStep?.buttons?.find((b) => b.type === "submit");
  const defaults = config.buttonDefaults?.submit || {};
  return getButtonConfig(submitBtn || { type: "submit", ...defaults }, defaults);
}

const allFields = flattenFields(config.steps);
const authStep = getAuthProviderStep(config.steps);
const submitConfig = getSubmitButton(config);

/** Resolve hidden field value: initialData overrides config */
function getHiddenValue(name: string): string {
  if (initialData[name] !== undefined && initialData[name] !== null) {
    return String(initialData[name]);
  }
  const fromConfig = config.hiddenFields?.find((f) => f.name === name);
  return fromConfig?.value ?? "";
}

const iconLeftPadding = "pl-10 sm:pl-12";
const iconRightPadding = "pr-10 sm:pr-12";
---

<div data-standard-form class={containerClass} data-skip-init={wrapInForm}>
  {
    !wrapInForm && config.responseType === "inline" && (
      <div id={`${config.formId}-response-alert`} class="mb-4 hidden w-full p-2" role="alert" />
    )
  }
  <FormOrDiv
    id={!wrapInForm ? config.formId : undefined}
    action={!wrapInForm ? config.formAction : undefined}
    method={!wrapInForm ? config.formMethod || "post" : undefined}
    class="space-y-6"
    data-form-config={!wrapInForm
      ? JSON.stringify({ formId: config.formId, formConfig: config, initialData })
      : undefined}
  >
    {
      authStep && (
        <div>
          <AuthProviders
            mode={authStep.additionalContent === "auth-providers" ? "login" : "register"}
            redirectUrl={initialData?.redirect ?? "/project/dashboard"}
          />
          <div class="flex items-center gap-4 pb-4">
            <div class="h-px flex-1 bg-zinc-300 dark:bg-zinc-600" />
            <span class="text-sm uppercase text-zinc-500 dark:text-zinc-400">
              {authStep.additionalContent === "auth-providers"
                ? "or login with email"
                : "or register with email"}
            </span>
            <div class="h-px flex-1 bg-zinc-300 dark:bg-zinc-600" />
          </div>
        </div>
      )
    }

    {/* Fields */}
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2 md:gap-6">
      {allFields.map((field) => (
        <FormFieldRenderer
          field={field}
          context="standard"
          inputClasses={appendedGlobalInputClasses}
          initialData={initialData}
          fid={fid}
          buttonDefaults={config.buttonDefaults}
          mobileCarrierOptions={mobileCarrierOptions}
          iconLeftPadding={iconLeftPadding}
          iconRightPadding={iconRightPadding}
          wrapperClass={
            field.type === "hidden"
              ? ""
              : `input-wrapper w-full ${field.columns === 1 ? "md:col-span-2" : ""}`
          }
        />
      ))}
    </div>

    {/* Submit button - prev/back buttons are ignored */}
    <div class="flex gap-3 pt-4">
      <Button
        type="submit"
        variant={submitConfig.variant}
        size={submitConfig.size}
        icon={submitConfig.icon}
        iconPosition={submitConfig.iconPosition}
        class={`submit-step save-profile-btn ${(submitConfig as any).classes || ""}`}
      >
        {submitConfig.label && <span set:html={submitConfig.label} />}
      </Button>
    </div>

    {/* Hidden fields from config (initialData overrides) */}
    {
      config.hiddenFields?.map((field) => (
        <input type="hidden" name={field.name} value={getHiddenValue(field.name) || field.value} />
      ))
    }
  </FormOrDiv>
</div>

<script>
  import { initializeStandardForm } from "../../../lib/multi-step-form-handler";

  function runStandardFormInit() {
    const wrapper = document.querySelector("[data-standard-form]");
    if (wrapper?.hasAttribute("data-skip-init")) return;
    const form = wrapper?.querySelector("form[data-form-config]") as HTMLFormElement | null;
    if (!form) return;

    let formId: string;
    let formConfig: any;
    let initialData: Record<string, any> = {};
    try {
      const parsed = JSON.parse(form.getAttribute("data-form-config") ?? "{}");
      formId = parsed.formId;
      formConfig = parsed.formConfig;
      initialData = parsed.initialData ?? {};
    } catch {
      return;
    }
    if (!formId || !formConfig) return;

    initializeStandardForm(form, { initialData, formConfig });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", runStandardFormInit);
  } else {
    runStandardFormInit();
  }
</script>
