# AI Document Generation System - Architecture

## Overview

AI-powered document generation system integrated into the Astro-based fire protection management application. Uses Anthropic Claude API to generate compliant fire protection documents.

## System Architecture

### Tech Stack

- **Frontend/Backend**: Astro framework
- **API Routes**: Astro API routes (`src/pages/api/`)
- **Database**: Supabase (PostgreSQL)
- **AI Provider**: Anthropic Claude API
- **Storage**: Supabase Storage (for generated PDFs)
- **Authentication**: Supabase Auth (existing system)

### System Components

```
┌─────────────────┐
│   Astro Pages   │  (Frontend components)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│   API Routes    │  (src/pages/api/documents/generate.ts)
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌────────┐ ┌──────────────┐
│Supabase│ │  AI Agent    │  (Claude API)
│Database│ │  Service     │
└────────┘ └──────────────┘
    │
    ▼
┌──────────────┐
│Supabase      │  (Generated PDFs/Documents)
│Storage       │
└──────────────┘
```

## Database Schema

### New Tables

#### `document_templates`
Stores templates for different types of fire protection documents:
- `id` (UUID) - Primary key
- `name` (TEXT) - Template name
- `category` (TEXT) - Template category (inspection, compliance, report, certification)
- `description` (TEXT) - Template description
- `prompt_template` (TEXT) - AI prompt template with placeholders
- `fields` (JSONB) - Required fields schema
- `is_active` (BOOLEAN) - Whether template is active
- `created_at`, `updated_at` (TIMESTAMPTZ)

#### `ai_generated_documents`
Stores documents generated by the AI agent:
- `id` (UUID) - Primary key
- `project_id` (INTEGER) - References `projects.id` (existing table)
- `template_id` (UUID) - References `document_templates.id`
- `content` (TEXT) - Generated document content
- `file_url` (TEXT) - Supabase Storage URL for PDF/export
- `version` (INTEGER) - Document version
- `metadata` (JSONB) - Additional metadata
- `author_id` (UUID) - References `auth.users.id`
- `created_at`, `updated_at` (TIMESTAMPTZ)

#### `ai_generations`
Tracks all AI generations for cost analysis and auditing:
- `id` (UUID) - Primary key
- `document_id` (UUID) - References `ai_generated_documents.id`
- `prompt` (TEXT) - Prompt sent to AI
- `response` (TEXT) - AI response
- `model` (TEXT) - AI model used (e.g., 'claude-3-opus')
- `tokens_used` (INTEGER) - Tokens consumed
- `cost_estimate` (DECIMAL) - Estimated cost in USD
- `created_at` (TIMESTAMPTZ)

### Integration with Existing Schema

- Uses existing `projects` table (serial ID, `author_id`)
- References existing `profiles` table for role-based access
- Follows existing RLS policy patterns

## AI Agent Implementation

### Core Agent Service

Located in `src/lib/ai/agent.ts`:

#### `FireProtectionAgent` Class

**Methods:**
- `generateDocument(request)` - Generate a document based on template and project data
- `generateWithRefinement(request, steps)` - Generate with multi-step refinement

**Features:**
- Prompt engineering for fire protection documents
- Context management from Supabase
- Document generation with compliance checking
- Token usage tracking
- Multi-step refinement support

### Prompt Engineering

The agent uses structured prompts that include:
- Project data (facility name, address, dates, etc.)
- Specific requirements (optional)
- NFPA compliance guidelines
- Professional formatting requirements

## API Endpoints

### POST `/api/documents/generate`

Generates a document via AI agent.

**Request Body:**
```typescript
{
  projectId: number;        // Existing project ID
  templateId: string;       // UUID of document template
  projectData: {            // Data to populate template
    facility_name: string;
    address: string;
    // ... other fields
  };
  requirements?: string[];  // Optional specific requirements
}
```

**Response:**
```typescript
{
  success: boolean;
  document: {
    id: string;
    content: string;
    metadata: {
      tokensUsed: number;
      model: string;
      generatedAt: string;
    };
  };
}
```

**Authentication:**
- Requires authenticated user
- Client users can only generate for their own projects
- Admin users can generate for any project

## Row-Level Security (RLS)

### Document Templates
- **Admins**: Full access (create, read, update, delete)
- **Authenticated Users**: Read access to active templates only

### AI Generated Documents
- **Users**: Can view/create/update documents for their own projects
- **Admins**: Can view/create/update documents for any project
- Access is determined by `projects.author_id` matching `auth.uid()`

### AI Generations
- **Users**: Can view generations for documents they can access
- **Admins**: Can view all generations

## Authentication & Authorization

Uses existing authentication system:
- `checkAuth` helper from `src/lib/auth.ts`
- Session cookies (`sb-access-token`, `sb-refresh-token`)
- Role-based access (Admin/Client from `profiles.role`)

## Error Handling

The API route handles:
- Authentication errors (401)
- Authorization errors (403)
- Validation errors (400)
- Database errors (500)
- AI generation errors (500)

All errors are logged with context for debugging.

## Cost Tracking

The system tracks:
- Tokens used per generation
- Model used
- Cost estimates (can be calculated from token usage)
- Generation history for auditing

## Future Enhancements

Potential improvements:
1. **PDF Export** - Generate PDFs from AI-generated content
2. **Document Editor** - Allow manual editing of generated documents
3. **Version Control** - Track document versions and revisions
4. **Batch Generation** - Generate multiple documents at once
5. **Template Management UI** - Admin interface for managing templates
6. **Cost Dashboard** - Visualize AI usage and costs
7. **Document Preview** - Preview generated documents before saving
8. **Custom Prompts** - Allow users to customize prompts per template

## Deployment Considerations

### Environment Variables
- `ANTHROPIC_API_KEY` - Required for AI generation
- `PUBLIC_SUPABASE_URL` - Already configured
- `SUPABASE_SECRET` - Already configured

### Monitoring
- Monitor Anthropic API usage and costs
- Track generation success/failure rates
- Monitor token usage trends

### Scaling
- Consider rate limiting for AI API calls
- Implement caching for frequently used templates
- Queue system for batch operations

---

This architecture provides a solid foundation for AI-powered document generation integrated into your existing fire protection management system.

