# Fixed FeaturedProjects API Mapping

## Date
January 22, 2026

## Issue
The `FeaturedProjects.astro` component was using outdated field mappings that didn't match what the API actually returns from the database. Additionally, there were concerns about `featuredImageData` not being populated properly.

## Changes Made

### 1. Fixed Field Mapping in FeaturedProjects.astro
**File**: `src/components/common/FeaturedProjects.astro`

- Confirmed `squareFootage` correctly maps to `project.sqFt` (camelCase as per database schema)
- Added filter for featured projects: `.filter((project: any) => project.featured === true || project.featured === "yes")`
- Changed `completedAt` to use `project.completedAt` if available, falling back to `project.updatedAt`
- Removed commented-out filters
- Added clearer comment explaining the featured filter

**Before:**
```javascript
featuredProjects = (projects || [])
  // .filter((project: any) => project.featuredImageData?.publicUrl)
  // .filter((project: any) => project.featured === "yes")
  .map((project: any) => ({
    squareFootage: project.sqFt,
    completedAt: project.updatedAt,
    ...
  }));
```

**After:**
```javascript
featuredProjects = (projects || [])
  .filter((project: any) => project.featured === true || project.featured === "yes")
  .map((project: any) => ({
    squareFootage: project.sqFt, // Database field is sqFt
    completedAt: project.completedAt || project.updatedAt,
    ...
  }));
```

### 2. Added Featured Filter to API
**File**: `src/pages/api/projects/get.ts`

- Added `featured` parameter extraction from query string
- Added filter logic: `if (featured === "true") { query = query.eq("featured", true); }`

This ensures the API can filter projects by `featured=true` when requested.

### 3. Removed Unnecessary URL Generation Logic
**File**: `src/pages/api/projects/get.ts`

**IMPORTANT FINDING:** The `featuredImageData` field is **already populated by a database trigger** with all necessary data including `publicUrl`. The API was unnecessarily generating signed URLs.

**Removed:**
```typescript
// This was unnecessary - featuredImageData already has publicUrl from DB trigger
let enrichedFeaturedImageData = null;
if (project.featuredImageData) {
  const { data: urlData } = await supabaseAdmin.storage
    .from(featuredData.bucketName)
    .createSignedUrl(featuredData.filePath, 3600);
  enrichedFeaturedImageData = { ...featuredData, publicUrl: urlData?.signedUrl };
}
```

The database trigger automatically populates `featuredImageData` with:
- All file metadata (id, fileName, filePath, fileType, fileSize, bucketName, uploadedAt, title, comments)
- **publicUrl** - Generated directly in the trigger from bucketName + filePath

### 4. Created SQL to Ensure Complete Trigger
**File**: `sql-queriers/ensure-complete-featured-image-trigger.sql`

Created a comprehensive SQL migration to:
- Replace any incomplete triggers (some old migrations only stored 4 fields)
- Ensure the trigger includes ALL fields especially `bucketName` and `publicUrl`
- Backfill existing projects with incomplete `featuredImageData`
- Add indexes for performance

**Benefits:**
- No additional API overhead - publicUrl is pre-computed in database
- No storage API calls needed when fetching projects
- Better performance - especially for featured project lists
- Data consistency - publicUrl format is standardized

## Database Schema Reference

### Projects Table - Featured Image Fields
- `featuredImageId` (text) - References the file ID from the files table
- `featuredImageData` (jsonb) - **Auto-populated by trigger** containing:
  - `id` (integer)
  - `fileName` (string)
  - `filePath` (string)
  - `fileType` (string)
  - `fileSize` (number)
  - `bucketName` (string)
  - `uploadedAt` (timestamp)
  - `title` (string)
  - `comments` (string)
  - `publicUrl` (string) - **Generated by trigger**, format: `https://[project-id].supabase.co/storage/v1/object/public/[bucket]/[path]`

### Database Trigger
The `sync_featured_image_data()` function runs BEFORE UPDATE/INSERT on projects table when `featuredImageId` changes, automatically populating `featuredImageData` from the files table.

### Other Projects Table Fields
- `id` (int)
- `authorId` (uuid)
- `address` (string)
- `title` (string)
- `description` (text)
- `status` (int)
- `sqFt` (int)
- `newConstruction` (boolean)
- `featured` (boolean)
- `completedAt` (timestamp)
- `createdAt` (timestamp)
- `updatedAt` (timestamp)

## Testing
To test featured projects:
1. Run the SQL migration: `sql-queriers/ensure-complete-featured-image-trigger.sql`
2. Ensure projects in database have `featured = true`
3. Ensure projects have `featuredImageId` set (trigger auto-populates `featuredImageData`)
4. Visit the page that uses `<FeaturedProjects />`
5. Check console logs for "üêõ [FEATURED-PROJECTS] Projects:"
6. Verify only featured projects are displayed
7. Verify featured images render with public URLs from `featuredImageData.publicUrl`

## Related Files
- `/src/components/common/FeaturedProjects.astro` - Component that displays featured projects
- `/src/pages/api/projects/get.ts` - API endpoint that fetches projects (no URL generation needed)
- `/sql-queriers/ensure-complete-featured-image-trigger.sql` - Ensures complete database trigger
- `/sql-queriers/create-featured-image-sync-function.sql` - Original complete trigger definition
- `/src/lib/types/index.ts` - Type definitions (uses `sqFt`)
- `/src/lib/media.ts` - Media handling utilities (reference for featured image structure)
