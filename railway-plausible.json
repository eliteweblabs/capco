{
  "name": "capco-plausible-analytics",
  "services": [
    {
      "name": "plausible-db",
      "image": "postgres:15-alpine",
      "environment": {
        "POSTGRES_PASSWORD": "${{PLAUSIBLE_DB_PASSWORD}}",
        "POSTGRES_USER": "plausible",
        "POSTGRES_DB": "plausible"
      },
      "volumes": [
        {
          "name": "plausible_db_data",
          "mountPath": "/var/lib/postgresql/data"
        }
      ]
    },
    {
      "name": "plausible-events-db",
      "image": "clickhouse/clickhouse-server:23.8-alpine",
      "volumes": [
        {
          "name": "plausible_events_data",
          "mountPath": "/var/lib/clickhouse"
        }
      ]
    },
    {
      "name": "plausible-mail",
      "image": "bytemark/smtp"
    },
    {
      "name": "plausible",
      "image": "plausible/analytics:latest",
      "ports": ["8000"],
      "environment": {
        "BASE_URL": "${{PLAUSIBLE_BASE_URL}}",
        "SECRET_KEY_BASE": "${{PLAUSIBLE_SECRET_KEY}}",
        "DATABASE_URL": "postgres://plausible:${{PLAUSIBLE_DB_PASSWORD}}@plausible-db:5432/plausible",
        "CLICKHOUSE_DATABASE_URL": "http://plausible-events-db:8123/plausible_events_db",
        "MAILER_EMAIL": "${{PLAUSIBLE_MAILER_EMAIL}}",
        "SMTP_HOST_ADDR": "plausible-mail",
        "SMTP_HOST_PORT": "25",
        "SMTP_USER_NAME": "",
        "SMTP_USER_PASSWORD": "",
        "SMTP_MX_LOOKUPS": "false",
        "SMTP_RETRIES": "2",
        "SMTP_VERIFY": "false",
        "DISABLE_REGISTRATION": "true",
        "ADMIN_USER_EMAIL": "${{PLAUSIBLE_ADMIN_EMAIL}}",
        "ADMIN_USER_NAME": "CAPCo Admin",
        "ADMIN_USER_PWD": "${{PLAUSIBLE_ADMIN_PASSWORD}}"
      },
      "dependsOn": ["plausible-db", "plausible-events-db", "plausible-mail"]
    }
  ],
  "volumes": [
    {
      "name": "plausible_db_data"
    },
    {
      "name": "plausible_events_data"
    }
  ]
}
